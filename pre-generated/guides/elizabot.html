<!DOCTYPE html>
<html lang="en-US" class="js">
  <head>
    <title>Using Matrix to make Chatbot software from the 1960s available in 2018 | Matrix.org</title>
  <meta name="description" content="Using Matrix to make Chatbot software from the 1960s available in 2018">



    <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script type='text/javascript' src='/blog/wp-includes/js/jquery/jquery.js?ver=1.11.3'></script>

  <link rel="stylesheet" href="/site.css">
  <link rel="stylesheet" href="/docs/css/main.css">

  <link rel="stylesheet" href="/docs/css/site_overrides.css">
  <link rel="stylesheet" href="/docs/css/basic.css">
  <link rel="stylesheet" href="/docs/css/nature.css">
  <link rel="stylesheet" href="/docs/css/ratings.css">

  <link rel='stylesheet' id='divi-fonts-css'  href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,800italic,400,300,700,800&#038;subset=latin,latin-ext' type='text/css' media='all'>
  <!--link rel='stylesheet' id='divi-style-css'  href='/blog/wp-content/themes/Divi-child/style.css?ver=2.2' type='text/css' media='all'-->
  <link rel="stylesheet" href="/docs/css/newstyle.css">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

<script type="text/javascript">
  var _paq = _paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.riot.im/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();

  function toggleRatings() {
    if (jQuery("#rating-container").css("bottom") === "18px") {
      jQuery("#rating-container").animate({bottom:"-32px"});
    } else {
      jQuery("#rating-container").animate({bottom:"18px"});
    }
  }

  function ratePage(rating) {
    _paq.push(['trackEvent', 'Rating', 'Rating', window.location.pathname, rating]);
    jQuery("#rating-container").empty();
    jQuery("#rating-container").append(jQuery("<div>").text("Thank you. Your rating (" + rating + ") has been recorded."));
  }
</script>

  </head>
  <body class="blog et_fixed_nav et_cover_background et_right_sidebar">
   <div id="page-wrapper">
    <div class="page-content" id="page-container">
      <header id="main-header" class="et_nav_text_color_dark" style="top: 0px;">
  <div class="container clearfix" >
    <a href="/">
      <img src="//matrix.org/blog/wp-content/uploads/2015/01/logo1.png" alt="Matrix.org" id="logo" />
    </a>
    <div id="et-top-navigation">
      <nav id="top-menu-nav">
        <ul id="top-menu" class="nav"><li id="menu-item-17" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-17"><a href="/">Home</a></li>
          <li id="menu-item-794" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-794"><a href="/docs/projects/try-matrix-now.html">Try Matrix Now!</a></li>
          <li id="menu-item-3677" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-3677"><a href="http://matrix.org/twim">TWIM</a></li>
          <li id="menu-item-3532" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-3532"><a href="/docs/projects/clients-matrix">Clients</a></li>
          <li id="menu-item-348" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-348"><a href="/docs/guides">Guides</a></li>
          <li id="menu-item-349" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-349"><a href="/docs/spec">Spec</a></li>
          <li id="menu-item-351" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-351"><a href="/code">Code</a></li>
          <li id="menu-item-3655" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-3655"><a href="/docs/projects/hosting">Hosting</a></li>
          <li id="menu-item-1323" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-1323"><a href="/docs/guides/faq">FAQ</a></li>
          <li id="menu-item-353" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-353"><a href="/blog/posts">Blog</a></li>
          <li id="menu-item-3612" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-3612"><a href="https://status.matrix.org/">Status</a></li>
        </ul>
      </nav>
      <div id="et_top_search">
        <span id="et_search_icon"></span>
        <form role="search" method="get" class="et-search-form et-hidden" action="https://matrix.org/blog/">
          <input type="search" class="et-search-field" placeholder="Search &hellip;" value="" name="s" title="Search for:" />
        </form>
      </div>
      <div id="et_mobile_nav_menu">
        <a href="#" class="mobile_nav closed">
          <span class="select_page">Select Page</span>
          <span class="mobile_menu_bar"></span>
        </a>
      </div>
    </div> <!-- #et-top-navigation -->
  </div> <!-- .container -->
</header> <!-- #main-header -->

      <div id="main-content">

      <div class="wrapper" id="wrapper">
        <div class="document_foo" id="document">
          <h1 id="using-matrix-to-make-chatbot-software-from-the-1960s-available-in-2018">Using Matrix to make Chatbot software from the 1960s available in 2018</h1>

<p>In this article, we’ll use Matrix, a Raspberry Pi and JavaScript to bring back
chatbot software from the 1960s: ELIZA.</p>

<h2 id="what-is-eliza">What is ELIZA?</h2>

<p>ELIZA is a computer program written between 1964 and 1966, which imitates the
conversation style of a psychotherapist of the era. It behaves like what we
would now call a <em>chatbot</em>, but there was no such concept at the time - in fact
there were only the first glimpses of text chat as we would recognise it today.</p>

<p>The original program was designed and at the MIT Artificial Intelligence
Laboratory by Joseph Weizenbaum. ELIZA was first implemented on the IBM 7094
and written in MAD-SLIP, where
<a href="https://en.wikipedia.org/wiki/MAD_(programming_language)">MAD</a> was a popular
programming system for IBM mainframes of the time, and
<a href="https://en.wikipedia.org/wiki/SLIP_(programming_language)">SLIP</a> was a
list-processing extension of Weizenbaum’s own creation.</p>

<p>Seeing the results, in which users were highly willing to interact with ELIZA,
Weizenbaum was disturbed by just how effective the apparently simple bot was. He
was motivated to write a book explaining the way people tend to anthropomorphise
technology by applying their own experiences to their usage.</p>

<h2 id="2005-online-javascript-version-appeared">2005, online JavaScript version appeared</h2>

<p>In 2005, <a href="https://twitter.com/mass_werk">Norbert Landsteiner</a> created a
JavaScript program which he made available as <em>elizabot.js</em>, and made ELIZA
available online through a web interface: <a href="https://www.masswerk.at/elizabot/">https://www.masswerk.at/elizabot/</a>.</p>

<p>Now we’ll make this available on Matrix.</p>

<h2 id="making-the-bot">Making the bot</h2>

<h3 id="using-the-library">Using the library</h3>

<p>For this project I have chosen to use an adaptation of the elizabot.js library:
<a href="https://github.com/natelewis/eliza-as-promised">eliza-as-promised</a>, which
exposes the bot as a promise-based node.js module. This module makes working
with ELIZA very simple. First we create an instance of the bot object:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Eliza</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'eliza-as-promised'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">eliza</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Eliza</span><span class="p">();</span>
</code></pre></div></div>

<p>We can get an initial greeting as follows:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">eliza</span><span class="p">.</span><span class="nx">getInitial</span><span class="p">());</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">getResponse()</code> function takes a string from the user, and returns a
<code class="highlighter-rouge">Promise</code> with a response, with either a <code class="highlighter-rouge">reply</code> or <code class="highlighter-rouge">final</code> field. If the
response is a reply, we can give another string to get a response, if the
response is final, the session is over. For example:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">eliza</span><span class="p">.</span><span class="nx">getResponse</span><span class="p">(</span><span class="s2">"Help me Eliza!"</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">reply</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="kr">final</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="kr">final</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="using-matrix-to-make-a-modern-chatbot">Using Matrix to make a modern Chatbot</h3>

<p>Matrix is an open standard for real-time communication over IP. It is often used
to enable Instant Messaging. Matrix is not just  Open Source, it is also designed to
be interoperable, which makes it easy to take existing projects and integrate
them.</p>

<p>Matrix provides a decentralised architecture, in which servers connect to one
another, but as a user your client connects to a single homeserver, as described
in the diagram below.</p>

<p><img src="/docs/projects/images/matrix-diagram.png" alt="Matrix Design" /></p>

<p>However, for this project we only need to look at the Client-Server API, which
is the way in which clients and servers communicate with one another. To make it
easier to connect the ELIZA library to Matrix, I chose to use a JavaScript
library designed to access the Matrix Client-Server API: <a href="https://github.com/turt2live/matrix-bot-sdk">matrix-bot-sdk</a>
from <a href="https://github.com/turt2live">TravisR</a>.</p>

<h3 id="code-walkthrough">Code Walkthrough</h3>

<p>First, we’ll need a new instance of the Bot SDK, which we can obtain from NPM as
follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install matrix-bot-sdk
</code></pre></div></div>

<p>Then, in our application code, we will instantiate and start a new client. Note
that you can obtain an access token for the bot <a href="https://t2bot.io/docs/access_tokens/">using
Riot</a>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">MatrixClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"matrix-bot-sdk"</span><span class="p">).</span><span class="nx">MatrixClient</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">AutojoinRoomsMixin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"matrix-bot-sdk"</span><span class="p">).</span><span class="nx">AutojoinRoomsMixin</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MatrixClient</span><span class="p">(</span><span class="s2">"https://matrix.org"</span><span class="p">,</span> <span class="nx">access_token</span><span class="p">);</span>
<span class="nx">AutojoinRoomsMixin</span><span class="p">.</span><span class="nx">setupOnClient</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">start</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Client started!"</span><span class="p">));</span>
</code></pre></div></div>

<p>I also added the AutojoinRoomsMixin at this point, which instructs the bot to
accept any room invitation it recieves.</p>

<p>Knowing that we can use
<a href="https://github.com/natelewis/eliza-as-promised"><code class="highlighter-rouge">eliza-as-promised</code></a> to create
new instances of Eliza, let’s start by doing so whenever the bot joins a new
room.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">elizas</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"room.join"</span><span class="p">,</span> <span class="p">(</span><span class="nx">roomId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">elizas</span><span class="p">[</span><span class="nx">roomId</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">eliza</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Eliza</span><span class="p">(),</span>
        <span class="na">last</span><span class="p">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">roomId</span><span class="p">,</span> <span class="p">{</span>
        <span class="s2">"msgtype"</span><span class="p">:</span> <span class="s2">"m.notice"</span><span class="p">,</span>
        <span class="s2">"body"</span><span class="p">:</span> <span class="nx">elizas</span><span class="p">[</span><span class="nx">roomId</span><span class="p">].</span><span class="nx">eliza</span><span class="p">.</span><span class="nx">getInitial</span><span class="p">()</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>What’s happening here? First we make a new object to contain a mapping of room
IDs to <code class="highlighter-rouge">Eliza</code> objects. When we get a room join event, we assign a new <code class="highlighter-rouge">Eliza</code>
object and the current time to the room ID. Next, we use the newly created
object to send the initial greeting to the room, using the same call to
<code class="highlighter-rouge">getInitial()</code> we used earlier.</p>

<p>Next, we’ll accept messages from the user and provide a response:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"room.message"</span><span class="p">,</span> <span class="p">(</span><span class="nx">roomId</span><span class="p">,</span> <span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">[</span><span class="s2">"sender"</span><span class="p">]</span> <span class="o">===</span> <span class="kr">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">getUserId</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">event</span><span class="p">.</span><span class="nx">content</span> <span class="o">||</span> <span class="o">!</span> <span class="nx">event</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">elizas</span><span class="p">[</span><span class="nx">roomId</span><span class="p">].</span><span class="nx">eliza</span><span class="p">.</span><span class="nx">getResponse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">responseText</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">reply</span><span class="p">)</span> <span class="p">{</span> <span class="nx">responseText</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">reply</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="kr">final</span><span class="p">)</span> <span class="p">{</span> <span class="nx">responseText</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="kr">final</span><span class="p">;</span> <span class="p">}</span>

            <span class="nx">client</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">roomId</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">"msgtype"</span><span class="p">:</span> <span class="s2">"m.notice"</span><span class="p">,</span>
                <span class="s2">"body"</span><span class="p">:</span> <span class="nx">responseText</span><span class="p">,</span>
                <span class="s2">"responds"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">"sender"</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span>
                    <span class="s2">"message"</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">body</span>
                <span class="p">}</span>
            <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">eventId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="kr">final</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">client</span><span class="p">.</span><span class="nx">leaveRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>It looks like a lot of code, but in fact we can break down what is happening here quite simply.</p>

<ol>
  <li>When an event is received in a room, we react to the event with a function
that takes the <code class="highlighter-rouge">roomId</code> and <code class="highlighter-rouge">event</code> received as parameters.</li>
  <li>If the user is our own, or the event does not contain a body, we must
return.</li>
  <li>We use the <code class="highlighter-rouge">roomId</code> to access the specific <code class="highlighter-rouge">Eliza</code> instance, as previously
created.</li>
  <li>As above, we call <code class="highlighter-rouge">getResponse()</code> on the Eliza object, and we pass the
message string we just received.</li>
  <li>We handle the promise returned by <code class="highlighter-rouge">getResponse()</code> by extracting the response
string into <code class="highlighter-rouge">responseText</code>, and use that string as a message to send back
into the room as a response.</li>
  <li>Finally, if the response text we took from our Eliza is “final”, we have
Eliza leave the room. (The bot can always be re-invited!)</li>
</ol>

<p>That all the code needed to get a working version of the bot running. If you look at <a href="https://github.com/benparsons/elizabot">https://github.com/benparsons/elizabot</a>, you can find a simple implementation as described here in <code class="highlighter-rouge">simple.js</code>, and a more robust implementation in <code class="highlighter-rouge">index.js</code>.</p>

<h2 id="deploying-on-a-raspberry-pi">Deploying on a Raspberry Pi</h2>

<p>To run the bot, we simply run <code class="highlighter-rouge">node index.js</code>. However, part of this project is
to get the bot running on a Raspberry Pi - and for convenience the way to do
this is to have it run as soon as the device boots. Luckily, there are standard
ways of achieving this, one of which is to use <code class="highlighter-rouge">systemd</code>. <a href="https://www.raspberrypi.org/documentation/usage/terminal/">Open a shell on your
Pi</a> (possibly using a
graphical desktop if one is installed, or using ssh) and enter this command to
access the correct directory:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /etc/systemd/system
</code></pre></div></div>

<p>Now, we’ll use vim to create a file describing the service we want to create:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim elizabot.service
</code></pre></div></div>

<p>Finally, enter the following text (you may need to change paths depending on
where your script is located):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=Elizabot
After=multi-user.target

[Service]
Type=idle
ExecStart=/usr/bin/node /home/pi/elizabot/index.js &gt; /home/pi/elizabot/log.log 2&gt;&amp;1

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<p>… and run the following to enable the service:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl enable elizabot.service
</code></pre></div></div>

<p>Now, whenever you plug in your Pi, your bot will be launched and ready to go. Of
course, it is quite possible to run this software on a server, but having a
separate box makes it more fun. The physicality of a Raspberry Pi means it gets
more attention and understanding from people who see it.</p>

<p><img src="/docs/projects/images/elizabot-pi.png" alt="Physical Pi" /></p>

<p>To learn more about Matrix development, take a look at the <a href="/docs/guides">Matrix Guides</a>
page, and join us in the <a href="https://matrix.to/#/#matrix-dev:matrix.org">#matrix-dev:matrix.org</a> room!</p>




        </div>
                <div id="rating-container">
          <div onclick="toggleRatings()" id="rating-container-header"><span>
            How helpful was this page? Click to give a rating
          </span></div>
          <div class="rating">
            <span onclick="ratePage(5)">☆</span>
            <span onclick="ratePage(4)">☆</span>
            <span onclick="ratePage(3)">☆</span>
            <span onclick="ratePage(2)">☆</span>
            <span onclick="ratePage(1)">☆</span>
          </div>
        </div>
      </div>
      <div class="push"></div>
    </div>
  </div>
      <script type='text/javascript' src='//matrix.org/blog/wp-content/themes/Divi-child/js/waypoints.min.js?ver=2.2'></script>
  <script type='text/javascript' src='/docs/css/custom.js'></script>

  <div id="footer"><div id="footerContent">&copy 2014-2018 Matrix.org | Hosted by <a href="https://upcloud.com/matrix">UpCloud</a> | <a href="/docs/guides/matrix_org_legal.html">Legal</a></div></div>


  </div>
  </div>
  </body>

</html>
