<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.16: http://docutils.sourceforge.net/" />
<title>Federation API</title>
<style type="text/css">

/*
 * basic.css
 * ~~~~~~~~~
 *
 * Sphinx stylesheet -- basic theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- main layout ----------------------------------------------------------- */

div.clearer {
    clear: both;
}

/* -- relbar ---------------------------------------------------------------- */

div.related {
    width: 100%;
    font-size: 90%;
}

div.related h3 {
    display: none;
}

div.related ul {
    margin: 0;
    padding: 0 0 0 10px;
    list-style: none;
}

div.related li {
    display: inline;
}

div.related li.right {
    float: right;
    margin-right: 5px;
}

/* -- sidebar --------------------------------------------------------------- */

div.sphinxsidebarwrapper {
    padding: 10px 5px 0 10px;
}

div.sphinxsidebar {
    float: left;
    width: 230px;
    margin-left: -100%;
    font-size: 90%;
}

div.sphinxsidebar ul {
    list-style: none;
}

div.sphinxsidebar ul ul,
div.sphinxsidebar ul.want-points {
    margin-left: 20px;
    list-style: square;
}

div.sphinxsidebar ul ul {
    margin-top: 0;
    margin-bottom: 0;
}

div.sphinxsidebar form {
    margin-top: 10px;
}

div.sphinxsidebar input {
    border: 1px solid #98dbcc;
    font-family: sans-serif;
    font-size: 1em;
}

img {
    border: 0;
}

/* -- search page ----------------------------------------------------------- */

ul.search {
    margin: 10px 0 0 20px;
    padding: 0;
}

ul.search li {
    padding: 5px 0 5px 20px;
    background-image: url(file.png);
    background-repeat: no-repeat;
    background-position: 0 7px;
}

ul.search li a {
    font-weight: bold;
}

ul.search li div.context {
    color: #888;
    margin: 2px 0 0 30px;
    text-align: left;
}

ul.keywordmatches li.goodmatch a {
    font-weight: bold;
}

/* -- index page ------------------------------------------------------------ */

table.contentstable {
    width: 90%;
}

table.contentstable p.biglink {
    line-height: 150%;
}

a.biglink {
    font-size: 1.3em;
}

span.linkdescr {
    font-style: italic;
    padding-top: 5px;
    font-size: 90%;
}

/* -- general index --------------------------------------------------------- */

table.indextable {
    width: 100%;
}

table.indextable td {
    text-align: left;
    vertical-align: top;
}

table.indextable dl, table.indextable dd {
    margin-top: 0;
    margin-bottom: 0;
}

table.indextable tr.pcap {
    height: 10px;
}

table.indextable tr.cap {
    margin-top: 10px;
    background-color: #f2f2f2;
}

img.toggler {
    margin-right: 3px;
    margin-top: 3px;
    cursor: pointer;
}

div.modindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

div.genindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

/* -- general body styles --------------------------------------------------- */

a.headerlink {
    visibility: hidden;
}

h1:hover > a.headerlink,
h2:hover > a.headerlink,
h3:hover > a.headerlink,
h4:hover > a.headerlink,
h5:hover > a.headerlink,
h6:hover > a.headerlink,
dt:hover > a.headerlink {
    visibility: visible;
}

div.document p.caption {
    text-align: inherit;
}

div.document td {
    text-align: left;
}

.field-list ul {
    padding-left: 1em;
}

.first {
    margin-top: 0 !important;
}

p.rubric {
    margin-top: 30px;
    font-weight: bold;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* -- sidebars -------------------------------------------------------------- */

div.sidebar {
    margin: 0 0 0.5em 1em;
    border: 1px solid #ddb;
    padding: 7px 7px 0 7px;
    background-color: #ffe;
    width: 40%;
    float: right;
}

p.sidebar-title {
    font-weight: bold;
}

/* -- topics ---------------------------------------------------------------- */

div.topic {
    border: 1px solid #ccc;
    padding: 7px 7px 0 7px;
    margin: 10px 0 10px 0;
}

p.topic-title {
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 10px;
}

/* -- admonitions ----------------------------------------------------------- */

div.admonition {
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 7px;
}

div.admonition dt {
    font-weight: bold;
}

div.admonition dl {
    margin-bottom: 0;
}

p.admonition-title {
    margin: 0px 10px 5px 0px;
    font-weight: bold;
}

div.document p.centered {
    text-align: center;
    margin-top: 25px;
}

/* -- tables ---------------------------------------------------------------- */

table.docutils {
    border: 0;
    border-collapse: collapse;
}

table.docutils td, table.docutils th {
    padding: 1px 8px 1px 5px;
    border-top: 0;
    border-left: 0;
    border-right: 0;
    border-bottom: 1px solid #aaa;
}

table.field-list td, table.field-list th {
    border: 0 !important;
}

table.footnote td, table.footnote th {
    border: 0 !important;
}

th {
    text-align: left;
    padding-right: 5px;
}

table.citation {
    border-left: solid 1px gray;
    margin-left: 1px;
}

table.citation td {
    border-bottom: none;
}

table.colwidths-auto caption {
    font-family: 'Inconsolata', monospace;
    font-weight: 800;
    font-size: 120%;
    padding: 5px;
    text-align: left;
    margin-bottom: 2px;
}

.section ol, .section li {
    margin: 0px 0px 0px 30px !important;
}

p.httpheaders {
    font-weight: 800;
    font-size: 120%;
    padding: 5px;
    text-align: left;
    margin-bottom: 2px;
}

table.colwidths-auto {
    width:100%;
    margin-top: 20px;
}

table.colwidths-auto tr td:nth-child(1) {
    width: 15%;
}

table.colwidths-auto tr td:nth-child(2) {
    width: 15%;
    font-family: 'Inconsolata', monospace;
}

table.colwidths-auto tr td:nth-child(3) {
    width: 70%;
}


/* -- other body styles ----------------------------------------------------- */

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl {
    margin-bottom: 15px;
}

dd p {
    margin-top: 0px;
}

dd ul, dd table {
    margin-bottom: 10px;
}

dd {
    margin-top: 3px;
    margin-bottom: 10px;
    margin-left: 30px;
}

dt:target, .highlighted {
    background-color: #fbe54e;
}

dl.glossary dt {
    font-weight: bold;
    font-size: 1.1em;
}

.field-list ul {
    margin: 0;
    padding-left: 1em;
}

.field-list p {
    margin: 0;
}

.refcount {
    color: #060;
}

.optional {
    font-size: 1.3em;
}

.versionmodified {
    font-style: italic;
}

.system-message {
    background-color: #fda;
    padding: 5px;
    border: 3px solid red;
}

.footnote:target  {
    background-color: #ffa
}

.line-block {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
}

.line-block .line-block {
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 1.5em;
}

.guilabel, .menuselection {
    font-family: sans-serif;
}

.accelerator {
    text-decoration: underline;
}

.classifier {
    font-style: oblique;
}

/* -- proposals page -------------------------------------------------------- */

#tables-of-tracked-proposals h2 {
    padding-left: 10px;
    position: -webkit-sticky;
    position: sticky;
}

/* Move sticky headers below header bar on desktop */
@media all and (min-width:980px) {
    #tables-of-tracked-proposals h2 {
        top: 52px;
    }
}

/* Sticky headers stick to the top on mobile */
@media all and (min-width:0px) and (max-width: 980px) {
    #tables-of-tracked-proposals h2 {
        top: 0px;
    }
}

/* -- code displays --------------------------------------------------------- */

pre {
    overflow: auto;
}

td.linenos pre {
    padding: 5px 0px;
    border: 0;
    background-color: transparent;
    color: #aaa;
}

table.highlighttable {
    margin-left: 0.5em;
}

table.highlighttable td {
    padding: 0 0.5em 0 0.5em;
}

tt.descname {
    background-color: transparent;
    font-weight: bold;
    font-size: 1.2em;
}

tt.descclassname {
    background-color: transparent;
}

tt.xref, a tt {
    background-color: transparent;
    font-weight: bold;
}

h1 tt, h2 tt, h3 tt, h4 tt, h5 tt, h6 tt {
    background-color: transparent;
}

.viewcode-link {
    float: right;
}

.viewcode-back {
    float: right;
    font-family: sans-serif;
}

div.viewcode-block:target {
    margin: -1px -10px;
    padding: 0 10px;
}

/* -- math display ---------------------------------------------------------- */

img.math {
    vertical-align: middle;
}

div.document div.math p {
    text-align: center;
}

span.eqno {
    float: right;
}

/* -- printout stylesheet --------------------------------------------------- */

@media print {
    div.document,
    div.documentwrapper,
    div.bodywrapper {
        margin: 0 !important;
        width: 100%;
    }

    div.sphinxsidebar,
    div.related,
    div.footer,
    #top-link {
        display: none;
    }
}


</style>
<style type="text/css">

blockquote {
    margin: 20px 0 30px;
    padding-left: 20px;
}

</style>
<style type="text/css">

pre.code .comment, code .comment { color: green }
pre.code .keyword, code .keyword { color: darkred; font-weight: bold }
pre.code .name.builtin, code .name.builtin { color: darkred; font-weight: bold }
pre.code .name.tag, code .name.tag { color: darkgreen }
pre.code .literal, code .literal { color: darkblue }
pre.code .literal.number, code .literal.number { color: blue }


/* HTTP Methods have class "name function" */
pre.code.http .name.function,  code.http .name.function { color: black; font-weight: bold }
/* HTTP Paths have class "name namespace" */
pre.code.http .name.namespace, code.http .name.namespace { color: darkgreen }
/* HTTP "HTTP" strings have class "keyword reserved" */
pre.code.http .keyword.reserved, code.http .keyword.reserved { color: black; font-weight: bold }
/* HTTP Header names have class "name attribute" */
pre.code.http .name.attribute, code.http .name.attribute { color: black; font-weight: bold }

</style>
<style type="text/css">

/*
 * nature.css_t
 * ~~~~~~~~~~~~
 *
 * Sphinx stylesheet -- nature theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- page layout ----------------------------------------------------------- */

body {
    font-family: Arial, sans-serif;
    font-size: 100%;
    /*background-color: #111;*/
    color: #555;
    margin: 0;
    padding: 0;
}

div.documentwrapper {
    float: left;
    width: 100%;
}

div.bodywrapper {
    margin: 0 0 0 230px;
}

hr {
    border: 1px solid #B1B4B6;
}

/*
div.document {
    background-color: #eee;
}
*/

div.document {
    background-color: #ffffff;
    color: #3E4349;
    padding: 0 30px 30px 30px;
    font-size: 0.9em;
}

div.footer {
    color: #555;
    width: 100%;
    padding: 13px 0;
    text-align: center;
    font-size: 75%;
}

div.footer a {
    color: #444;
    text-decoration: underline;
}

div.related {
    background-color: #6BA81E;
    line-height: 32px;
    color: #fff;
    text-shadow: 0px 1px 0 #444;
    font-size: 0.9em;
}

div.related a {
    color: #E2F3CC;
}

div.sphinxsidebar {
    font-size: 0.75em;
    line-height: 1.5em;
}

div.sphinxsidebarwrapper{
    padding: 20px 0;
}

div.sphinxsidebar h3,
div.sphinxsidebar h4 {
    font-family: Arial, sans-serif;
    color: #222;
    font-size: 1.2em;
    font-weight: normal;
    margin: 0;
    padding: 5px 10px;
    background-color: #ddd;
    text-shadow: 1px 1px 0 white
}

div.sphinxsidebar h4{
    font-size: 1.1em;
}

div.sphinxsidebar h3 a {
    color: #444;
}


div.sphinxsidebar p {
    color: #888;
    padding: 5px 20px;
}

div.sphinxsidebar p.topless {
}

div.sphinxsidebar ul {
    margin: 10px 20px;
    padding: 0;
    color: #000;
}

div.sphinxsidebar a {
    color: #444;
}

div.sphinxsidebar input {
    border: 1px solid #ccc;
    font-family: sans-serif;
    font-size: 1em;
}

div.sphinxsidebar input[type=text]{
    margin-left: 20px;
}

/* -- body styles ----------------------------------------------------------- */

a {
    color: #005B81;
    text-decoration: none;
}

a:hover {
    color: #E32E00;
    text-decoration: underline;
}

div.document h1,
div.document h2,
div.document h3,
div.document h4,
div.document h5,
div.document h6 {
    font-family: Arial, sans-serif;
    background-color: #BED4EB;
    font-weight: normal;
    color: #212224;
    margin: 30px 0px 10px 0px;
    padding: 5px 0 5px 10px;
    text-shadow: 0px 1px 0 white
}

div.document h1 { border-top: 20px solid white; margin-top: 0; font-size: 200%; }
div.document h2 { font-size: 150%; background-color: #C8D5E3; }
div.document h3 { font-size: 120%; background-color: #D8DEE3; }
div.document h4 { font-size: 110%; background-color: #D8DEE3; }
div.document h5 { font-size: 100%; background-color: #D8DEE3; }
div.document h6 { font-size: 100%; background-color: #D8DEE3; }

a.headerlink {
    color: #c60f0f;
    font-size: 0.8em;
    padding: 0 4px 0 4px;
    text-decoration: none;
}

a.headerlink:hover {
    background-color: #c60f0f;
    color: white;
}

div.document p, div.document dd, div.document li {
    line-height: 1.5em;
}

div.admonition p.admonition-title + p {
    display: inline;
}

div.highlight{
    background-color: white;
}

div.note {
    background-color: #eee;
    border: 1px solid #ccc;
}

div.seealso {
    background-color: #ffc;
    border: 1px solid #ff6;
}

div.topic {
    background-color: #eee;
}

div.warning {
    background-color: #ffe4e4;
    border: 1px solid #f66;
}

p.admonition-title {
    display: inline;
}

p.admonition-title:after {
    content: ":";
}

pre {
    padding: 10px;
    background-color: White;
    color: #222;
    line-height: 1.2em;
    border: 1px solid #C6C9CB;
    font-size: 1.1em;
    margin: 1.5em 0 1.5em 0;
    -webkit-box-shadow: 1px 1px 1px #d8d8d8;
    -moz-box-shadow: 1px 1px 1px #d8d8d8;
}

tt {
    background-color: #ecf0f3;
    color: #222;
    /* padding: 1px 2px; */
    font-size: 1.1em;
    font-family: monospace;
}

.viewcode-back {
    font-family: Arial, sans-serif;
}

div.viewcode-block:target {
    background-color: #f4debf;
    border-top: 1px solid #ac9;
    border-bottom: 1px solid #ac9;
}

ul li dd {
	margin-top: 0;
}

ul li dl {
	margin-bottom: 0;
}

li dl dd {
	margin-bottom: 0;
}

dd ul {
	padding-left: 0;
}

li dd ul {
	margin-bottom: 0;
}

table {
    margin-top: 10px;
    margin-bottom: 10px;
    border: 0;
    border-collapse: collapse;
}

td[colspan]:not([colspan="1"]) {
    background: #eeeeee;
    text-transform: capitalize;
}

thead {
    background: #eeeeee;
}

div.admonition-rationale {
    background-color: #efe;
    border: 1px solid #ccc;
}

div.admonition-example {
    background-color: #eef;
    border: 1px solid #ccc;
}


</style>
<style type="text/css">

/*
Original styles generated from:
    pygmentize -f html -S colorful -a pre.code > ./scripts/css/pygments.css

Rules for which we don't want the syntax highlighter to kick in are commented
out at the bottom.

Windows users: if you regenerate this file, you'll need to re-save it as utf-8
to make docutils happy.
*/

/* DIFFS */
pre.code .gd { color: #A00000 } /* Generic.Deleted */
pre.code .gi { color: #00A000 } /* Generic.Inserted */

/* UNUSED */
/*pre.code .hll { background-color: #ffffcc }*/
/*pre.code  { background: #ffffff; }*/
/*pre.code .c { color: #888888 } !* Comment *!*/
/*pre.code .err { color: #FF0000; background-color: #FFAAAA } !* Error *!*/
/*pre.code .k { color: #008800; font-weight: bold } !* Keyword *!*/
/*pre.code .o { color: #333333 } !* Operator *!*/
/*pre.code .ch { color: #888888 } !* Comment.Hashbang *!*/
/*pre.code .cm { color: #888888 } !* Comment.Multiline *!*/
/*pre.code .cp { color: #557799 } !* Comment.Preproc *!*/
/*pre.code .cpf { color: #888888 } !* Comment.PreprocFile *!*/
/*pre.code .c1 { color: #888888 } !* Comment.Single *!*/
/*pre.code .cs { color: #cc0000; font-weight: bold } !* Comment.Special *!*/
/*pre.code .ge { font-style: italic } !* Generic.Emph *!*/
/*pre.code .gr { color: #FF0000 } !* Generic.Error *!*/
/*pre.code .gh { color: #000080; font-weight: bold } !* Generic.Heading *!*/
/*pre.code .go { color: #888888 } !* Generic.Output *!*/
/*pre.code .gp { color: #c65d09; font-weight: bold } !* Generic.Prompt *!*/
/*pre.code .gs { font-weight: bold } !* Generic.Strong *!*/
/*pre.code .gu { color: #800080; font-weight: bold } !* Generic.Subheading *!*/
/*pre.code .gt { color: #0044DD } !* Generic.Traceback *!*/
/*pre.code .kc { color: #008800; font-weight: bold } !* Keyword.Constant *!*/
/*pre.code .kd { color: #008800; font-weight: bold } !* Keyword.Declaration *!*/
/*pre.code .kn { color: #008800; font-weight: bold } !* Keyword.Namespace *!*/
/*pre.code .kp { color: #003388; font-weight: bold } !* Keyword.Pseudo *!*/
/*pre.code .kr { color: #008800; font-weight: bold } !* Keyword.Reserved *!*/
/*pre.code .kt { color: #333399; font-weight: bold } !* Keyword.Type *!*/
/*pre.code .m { color: #6600EE; font-weight: bold } !* Literal.Number *!*/
/*pre.code .s { background-color: #fff0f0 } !* Literal.String *!*/
/*pre.code .na { color: #0000CC } !* Name.Attribute *!*/
/*pre.code .nb { color: #007020 } !* Name.Builtin *!*/
/*pre.code .nc { color: #BB0066; font-weight: bold } !* Name.Class *!*/
/*pre.code .no { color: #003366; font-weight: bold } !* Name.Constant *!*/
/*pre.code .nd { color: #555555; font-weight: bold } !* Name.Decorator *!*/
/*pre.code .ni { color: #880000; font-weight: bold } !* Name.Entity *!*/
/*pre.code .ne { color: #FF0000; font-weight: bold } !* Name.Exception *!*/
/*pre.code .nf { color: #0066BB; font-weight: bold } !* Name.Function *!*/
/*pre.code .nl { color: #997700; font-weight: bold } !* Name.Label *!*/
/*pre.code .nn { color: #0e84b5; font-weight: bold } !* Name.Namespace *!*/
/*pre.code .nt { color: #007700 } !* Name.Tag *!*/
/*pre.code .nv { color: #996633 } !* Name.Variable *!*/
/*pre.code .ow { color: #000000; font-weight: bold } !* Operator.Word *!*/
/*pre.code .w { color: #bbbbbb } !* Text.Whitespace *!*/
/*pre.code .mb { color: #6600EE; font-weight: bold } !* Literal.Number.Bin *!*/
/*pre.code .mf { color: #6600EE; font-weight: bold } !* Literal.Number.Float *!*/
/*pre.code .mh { color: #005588; font-weight: bold } !* Literal.Number.Hex *!*/
/*pre.code .mi { color: #0000DD; font-weight: bold } !* Literal.Number.Integer *!*/
/*pre.code .mo { color: #4400EE; font-weight: bold } !* Literal.Number.Oct *!*/
/*pre.code .sa { background-color: #fff0f0 } !* Literal.String.Affix *!*/
/*pre.code .sb { background-color: #fff0f0 } !* Literal.String.Backtick *!*/
/*pre.code .sc { color: #0044DD } !* Literal.String.Char *!*/
/*pre.code .dl { background-color: #fff0f0 } !* Literal.String.Delimiter *!*/
/*pre.code .sd { color: #DD4422 } !* Literal.String.Doc *!*/
/*pre.code .s2 { background-color: #fff0f0 } !* Literal.String.Double *!*/
/*pre.code .se { color: #666666; font-weight: bold; background-color: #fff0f0 } !* Literal.String.Escape *!*/
/*pre.code .sh { background-color: #fff0f0 } !* Literal.String.Heredoc *!*/
/*pre.code .si { background-color: #eeeeee } !* Literal.String.Interpol *!*/
/*pre.code .sx { color: #DD2200; background-color: #fff0f0 } !* Literal.String.Other *!*/
/*pre.code .sr { color: #000000; background-color: #fff0ff } !* Literal.String.Regex *!*/
/*pre.code .s1 { background-color: #fff0f0 } !* Literal.String.Single *!*/
/*pre.code .ss { color: #AA6600 } !* Literal.String.Symbol *!*/
/*pre.code .bp { color: #007020 } !* Name.Builtin.Pseudo *!*/
/*pre.code .fm { color: #0066BB; font-weight: bold } !* Name.Function.Magic *!*/
/*pre.code .vc { color: #336699 } !* Name.Variable.Class *!*/
/*pre.code .vg { color: #dd7700; font-weight: bold } !* Name.Variable.Global *!*/
/*pre.code .vi { color: #3333BB } !* Name.Variable.Instance *!*/
/*pre.code .vm { color: #996633 } !* Name.Variable.Magic *!*/
/*pre.code .il { color: #0000DD; font-weight: bold } !* Literal.Number.Integer.Long *!*/

</style>
<style type="text/css">

/* Column with header cells */
table.docutils tbody th.stub {
    background: #eeeeee;
}

</style>
</head>
<body>
<div class="document" id="federation-api">
<h1 class="title">Federation API</h1>

<!-- Copyright 2016 OpenMarket Ltd -->
<!-- Copyright 2017-2019 New Vector Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
<p>Matrix homeservers use the Federation APIs (also known as server-server APIs)
to communicate with each other. Homeservers use these APIs to push messages to
each other in real-time, to retrieve historic messages from each other, and to
query profile and presence information about users on each other's servers.</p>
<p>The APIs are implemented using HTTPS requests between each of the servers.
These HTTPS requests are strongly authenticated using public key signatures
at the TLS transport layer and using public key signatures in HTTP
Authorization headers at the HTTP layer.</p>
<p>There are three main kinds of communication that occur between homeservers:</p>
<dl class="docutils">
<dt>Persisted Data Units (PDUs):</dt>
<dd><p class="first">These events are broadcast from one homeserver to any others that have
joined the same room (identified by Room ID). They are persisted in
long-term storage and record the history of messages and state for a
room.</p>
<p class="last">Like email, it is the responsibility of the originating server of a PDU
to deliver that event to its recipient servers. However PDUs are signed
using the originating server's private key so that it is possible to
deliver them through third-party servers.</p>
</dd>
<dt>Ephemeral Data Units (EDUs):</dt>
<dd>These events are pushed between pairs of homeservers. They are not
persisted and are not part of the history of a room, nor does the
receiving homeserver have to reply to them.</dd>
<dt>Queries:</dt>
<dd>These are single request/response interactions between a given pair of
servers, initiated by one side sending an HTTPS GET request to obtain some
information, and responded by the other. They are not persisted and contain
no long-term significant history. They simply request a snapshot state at
the instant the query is made.</dd>
</dl>
<p>EDUs and PDUs are further wrapped in an envelope called a Transaction, which is
transferred from the origin to the destination homeserver using an HTTPS PUT
request.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#changelog" id="id16">1&nbsp;&nbsp;&nbsp;Changelog</a><ul class="auto-toc">
<li><a class="reference internal" href="#other-versions-of-this-specification" id="id17">1.1&nbsp;&nbsp;&nbsp;Other versions of this specification</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api-standards" id="id18">2&nbsp;&nbsp;&nbsp;API standards</a></li>
<li><a class="reference internal" href="#server-discovery" id="id19">3&nbsp;&nbsp;&nbsp;Server discovery</a><ul class="auto-toc">
<li><a class="reference internal" href="#resolving-server-names" id="id20">3.1&nbsp;&nbsp;&nbsp;Resolving server names</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-well-known-matrix-server" id="id21">3.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/.well-known/matrix/server</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#server-implementation" id="id22">3.2&nbsp;&nbsp;&nbsp;Server implementation</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-version" id="id23">3.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/version</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#retrieving-server-keys" id="id24">3.3&nbsp;&nbsp;&nbsp;Retrieving server keys</a><ul class="auto-toc">
<li><a class="reference internal" href="#publishing-keys" id="id25">3.3.1&nbsp;&nbsp;&nbsp;Publishing Keys</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-key-v2-server-keyid" id="id26">3.3.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/key/v2/server/{keyId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#querying-keys-through-another-server" id="id27">3.3.2&nbsp;&nbsp;&nbsp;Querying Keys Through Another Server</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-key-v2-query-servername-keyid" id="id28">3.3.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/key/v2/query/{serverName}/{keyId}</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-key-v2-query" id="id29">3.3.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/key/v2/query</tt></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#authentication" id="id30">4&nbsp;&nbsp;&nbsp;Authentication</a><ul class="auto-toc">
<li><a class="reference internal" href="#request-authentication" id="id31">4.1&nbsp;&nbsp;&nbsp;Request Authentication</a></li>
<li><a class="reference internal" href="#response-authentication" id="id32">4.2&nbsp;&nbsp;&nbsp;Response Authentication</a></li>
<li><a class="reference internal" href="#client-tls-certificates" id="id33">4.3&nbsp;&nbsp;&nbsp;Client TLS Certificates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#transactions" id="id34">5&nbsp;&nbsp;&nbsp;Transactions</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-federation-v1-send-txnid" id="id35">5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v1/send/{txnId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#pdus" id="id36">6&nbsp;&nbsp;&nbsp;PDUs</a><ul class="auto-toc">
<li><a class="reference internal" href="#checks-performed-on-receipt-of-a-pdu" id="id37">6.1&nbsp;&nbsp;&nbsp;Checks performed on receipt of a PDU</a><ul class="auto-toc">
<li><a class="reference internal" href="#definitions" id="id38">6.1.1&nbsp;&nbsp;&nbsp;Definitions</a></li>
<li><a class="reference internal" href="#id13" id="id39">6.1.2&nbsp;&nbsp;&nbsp;Authorization rules</a><ul class="auto-toc">
<li><a class="reference internal" href="#auth-events-selection" id="id40">6.1.2.1&nbsp;&nbsp;&nbsp;Auth events selection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rejection" id="id41">6.1.3&nbsp;&nbsp;&nbsp;Rejection</a></li>
<li><a class="reference internal" href="#soft-failure" id="id42">6.1.4&nbsp;&nbsp;&nbsp;Soft failure</a></li>
<li><a class="reference internal" href="#retrieving-event-authorization-information" id="id43">6.1.5&nbsp;&nbsp;&nbsp;Retrieving event authorization information</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-event-auth-roomid-eventid" id="id44">6.1.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/event_auth/{roomId}/{eventId}</span></tt></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#edus" id="id45">7&nbsp;&nbsp;&nbsp;EDUs</a><ul class="auto-toc">
<li><a class="reference internal" href="#ephemeral-data-unit-schema" id="id46">7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">Ephemeral Data Unit</tt> schema</a></li>
</ul>
</li>
<li><a class="reference internal" href="#room-state-resolution" id="id47">8&nbsp;&nbsp;&nbsp;Room State Resolution</a></li>
<li><a class="reference internal" href="#backfilling-and-retrieving-missing-events" id="id48">9&nbsp;&nbsp;&nbsp;Backfilling and retrieving missing events</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-backfill-roomid" id="id49">9.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/backfill/{roomId}</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-federation-v1-get-missing-events-roomid" id="id50">9.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/federation/v1/get_missing_events/{roomId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#retrieving-events" id="id51">10&nbsp;&nbsp;&nbsp;Retrieving events</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-state-roomid" id="id52">10.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/state/{roomId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-federation-v1-state-ids-roomid" id="id53">10.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/state_ids/{roomId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-federation-v1-event-eventid" id="id54">10.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/event/{eventId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#joining-rooms" id="id55">11&nbsp;&nbsp;&nbsp;Joining Rooms</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-make-join-roomid-userid" id="id56">11.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/make_join/{roomId}/{userId}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-federation-v1-send-join-roomid-eventid" id="id57">11.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v1/send_join/{roomId}/{eventId}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-federation-v2-send-join-roomid-eventid" id="id58">11.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v2/send_join/{roomId}/{eventId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#inviting-to-a-room" id="id59">12&nbsp;&nbsp;&nbsp;Inviting to a room</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-federation-v1-invite-roomid-eventid" id="id60">12.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v1/invite/{roomId}/{eventId}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-federation-v2-invite-roomid-eventid" id="id61">12.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v2/invite/{roomId}/{eventId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#leaving-rooms-rejecting-invites" id="id62">13&nbsp;&nbsp;&nbsp;Leaving Rooms (Rejecting Invites)</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-make-leave-roomid-userid" id="id63">13.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/make_leave/{roomId}/{userId}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-federation-v1-send-leave-roomid-eventid" id="id64">13.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v1/send_leave/{roomId}/{eventId}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-federation-v2-send-leave-roomid-eventid" id="id65">13.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v2/send_leave/{roomId}/{eventId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#third-party-invites" id="id66">14&nbsp;&nbsp;&nbsp;Third-party invites</a><ul class="auto-toc">
<li><a class="reference internal" href="#cases-where-an-association-exists-for-a-third-party-identifier" id="id67">14.1&nbsp;&nbsp;&nbsp;Cases where an association exists for a third-party identifier</a></li>
<li><a class="reference internal" href="#cases-where-an-association-doesn-t-exist-for-a-third-party-identifier" id="id68">14.2&nbsp;&nbsp;&nbsp;Cases where an association doesn't exist for a third-party identifier</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-federation-v1-exchange-third-party-invite-roomid" id="id69">14.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v1/exchange_third_party_invite/{roomId}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-federation-v1-3pid-onbind" id="id70">14.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT /_matrix/federation/v1/3pid/onbind</tt></a></li>
<li><a class="reference internal" href="#verifying-the-invite" id="id71">14.2.3&nbsp;&nbsp;&nbsp;Verifying the invite</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#public-room-directory" id="id72">15&nbsp;&nbsp;&nbsp;Public Room Directory</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-publicrooms" id="id73">15.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/publicRooms</tt></a></li>
<li><a class="reference internal" href="#post-matrix-federation-v1-publicrooms" id="id74">15.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/federation/v1/publicRooms</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#typing-notifications" id="id75">16&nbsp;&nbsp;&nbsp;Typing Notifications</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-typing-schema" id="id76">16.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.typing</tt> schema</a></li>
</ul>
</li>
<li><a class="reference internal" href="#presence" id="id77">17&nbsp;&nbsp;&nbsp;Presence</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-presence-schema" id="id78">17.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.presence</tt> schema</a></li>
</ul>
</li>
<li><a class="reference internal" href="#receipts" id="id79">18&nbsp;&nbsp;&nbsp;Receipts</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-receipt-schema" id="id80">18.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.receipt</tt> schema</a></li>
</ul>
</li>
<li><a class="reference internal" href="#querying-for-information" id="id81">19&nbsp;&nbsp;&nbsp;Querying for information</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-query-querytype" id="id82">19.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/query/{queryType}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-federation-v1-query-directory" id="id83">19.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/query/directory</tt></a></li>
<li><a class="reference internal" href="#get-matrix-federation-v1-query-profile" id="id84">19.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/query/profile</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#openid" id="id85">20&nbsp;&nbsp;&nbsp;OpenID</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-openid-userinfo" id="id86">20.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/openid/userinfo</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#device-management" id="id87">21&nbsp;&nbsp;&nbsp;Device Management</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-user-devices-userid" id="id88">21.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/user/devices/{userId}</span></tt></a></li>
<li><a class="reference internal" href="#m-device-list-update-schema" id="id89">21.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.device_list_update</tt> schema</a></li>
</ul>
</li>
<li><a class="reference internal" href="#end-to-end-encryption" id="id90">22&nbsp;&nbsp;&nbsp;End-to-End Encryption</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-federation-v1-user-keys-claim" id="id91">22.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/federation/v1/user/keys/claim</tt></a></li>
<li><a class="reference internal" href="#post-matrix-federation-v1-user-keys-query" id="id92">22.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/federation/v1/user/keys/query</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#send-to-device-messaging" id="id93">23&nbsp;&nbsp;&nbsp;Send-to-device messaging</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-direct-to-device-schema" id="id94">23.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.direct_to_device</tt> schema</a></li>
</ul>
</li>
<li><a class="reference internal" href="#content-repository" id="id95">24&nbsp;&nbsp;&nbsp;Content Repository</a></li>
<li><a class="reference internal" href="#server-access-control-lists-acls" id="id96">25&nbsp;&nbsp;&nbsp;Server Access Control Lists (ACLs)</a></li>
<li><a class="reference internal" href="#id14" id="id97">26&nbsp;&nbsp;&nbsp;Signing Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#adding-hashes-and-signatures-to-outgoing-events" id="id98">26.1&nbsp;&nbsp;&nbsp;Adding hashes and signatures to outgoing events</a></li>
<li><a class="reference internal" href="#validating-hashes-and-signatures-on-received-events" id="id99">26.2&nbsp;&nbsp;&nbsp;Validating hashes and signatures on received events</a></li>
<li><a class="reference internal" href="#calculating-the-reference-hash-for-an-event" id="id100">26.3&nbsp;&nbsp;&nbsp;Calculating the reference hash for an event</a></li>
<li><a class="reference internal" href="#calculating-the-content-hash-for-an-event" id="id101">26.4&nbsp;&nbsp;&nbsp;Calculating the content hash for an event</a></li>
<li><a class="reference internal" href="#example-code" id="id102">26.5&nbsp;&nbsp;&nbsp;Example code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#security-considerations" id="id103">27&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</div>
<p><a class="anchor" id="changelog"></a></p>
<div class="section" id="changelog">
<h1><a class="toc-backref" href="#id16">1&nbsp;&nbsp;&nbsp;Changelog</a></h1>
<div class="topic">
<p class="topic-title">Version: r0.1.4</p>
<p>New Endpoints</p>
<ul class="simple">
<li>Add new <tt class="docutils literal">POST /publicRooms</tt> endpoint for filtering the room directory. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2305">#2305</a>)</li>
<li>Add new v2 <tt class="docutils literal">/send_join</tt> and <tt class="docutils literal">/send_leave</tt> endpoints per <a class="reference external" href="https://github.com/matrix-org/matrix-doc/pull/1802">MSC1802</a>. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2547">#2547</a>)</li>
</ul>
<p>Removed Endpoints</p>
<ul class="simple">
<li>Remove the unused <tt class="docutils literal">query_auth</tt> API per <a class="reference external" href="https://github.com/matrix-org/matrix-doc/pull/2451">MSC2451</a>. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2470">#2470</a>)</li>
</ul>
<p>Spec Clarifications</p>
<ul class="simple">
<li>Move auth event selection to a more obvious location. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2392">#2392</a>)</li>
<li>Fix typo in Request Authentication python example. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2510">#2510</a>)</li>
<li>Clarify which fields are required on the key server endpoints. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2527">#2527</a>)</li>
<li>Clarify the limits of <tt class="docutils literal">prev_events</tt> and <tt class="docutils literal">auth_events</tt> for PDUs. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2538">#2538</a>)</li>
<li>Clarify which events are targeted by backfill. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2559">#2559</a>)</li>
<li>Fix the response format of the <tt class="docutils literal">/send</tt> endpoint. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2560">#2560</a>)</li>
<li>Clarify signature object structures for encryption. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2566">#2566</a>)</li>
<li>Clarify the server names to use when signing requests. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2570">#2570</a>)</li>
<li>Clarify the state/auth chain requirements for <tt class="docutils literal">/send_join</tt>. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2575">#2575</a>)</li>
</ul>
</div>
<p>This version of the specification is generated from
<a class="reference external" href="https://github.com/matrix-org/matrix-doc">matrix-doc</a> as of Git commit
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/tree/07d460635">master,07d460635</a>.</p>
<p>For the full historical changelog, see
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/blob/main/changelogs/legacy/server_server.rst">https://github.com/matrix-org/matrix-doc/blob/main/changelogs/legacy/server_server.rst</a></p>
<p><a class="anchor" id="other-versions-of-this-specification"></a></p>
<div class="section" id="other-versions-of-this-specification">
<h2><a class="toc-backref" href="#id17">1.1&nbsp;&nbsp;&nbsp;Other versions of this specification</a></h2>
<p>The following other versions are also available, in reverse chronological order:</p>
<ul class="simple">
<li><a class="reference external" href="https://matrix.org/docs/spec/server_server/unstable.html">HEAD</a>: Includes all changes since the latest versioned release.</li>
<li><a class="reference external" href="https://matrix.org/docs/spec/server_server/r0.1.4.html">r0.1.4</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/server_server/r0.1.3.html">r0.1.3</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/server_server/r0.1.2.html">r0.1.2</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/server_server/r0.1.1.html">r0.1.1</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/server_server/r0.1.0.html">r0.1.0</a></li>
</ul>
</div>
</div>
<p><a class="anchor" id="api-standards"></a></p>
<div class="section" id="api-standards">
<h1><a class="toc-backref" href="#id18">2&nbsp;&nbsp;&nbsp;API standards</a></h1>
<p>The mandatory baseline for client-server communication in Matrix is exchanging
JSON objects over HTTP APIs. More efficient optional transports will in future
be supported as optional extensions - e.g. a packed binary encoding over
stream-cipher encrypted TCP socket for low-bandwidth/low-roundtrip mobile usage.
For the default HTTP transport, all API calls use a Content-Type of
<tt class="docutils literal">application/json</tt>.  In addition, all strings MUST be encoded as UTF-8.</p>
</div>
<p><a class="anchor" id="server-discovery"></a></p>
<div class="section" id="server-discovery">
<h1><a class="toc-backref" href="#id19">3&nbsp;&nbsp;&nbsp;Server discovery</a></h1>
<p><a class="anchor" id="resolving-server-names"></a></p>
<div class="section" id="resolving-server-names">
<h2><a class="toc-backref" href="#id20">3.1&nbsp;&nbsp;&nbsp;Resolving server names</a></h2>
<p>Each Matrix homeserver is identified by a server name consisting of a hostname
and an optional port, as described by the <a class="reference external" href="../appendices.html#server-name">grammar</a>. Where applicable, a delegated server name
uses the same grammar.</p>
<p>Server names are resolved to an IP address and port to connect to, and have
various conditions affecting which certificates and <tt class="docutils literal">Host</tt> headers to send.
The process overall is as follows:</p>
<!-- Note from the author: The repetitive "use this Host header and this cert"
comments are intentional. The process is overall quite complicated, and
explaining explicitly what requests look like at each step helps ease the
understanding and ensure everyone is on the same page. Implementations
are of course welcome to realize where the process can be optimized, and
do so - just ensure that the result is the same! -->
<ol class="arabic simple">
<li>If the hostname is an IP literal, then that IP address should be used,
together with the given port number, or 8448 if no port is given. The
target server must present a valid certificate for the IP address.
The <tt class="docutils literal">Host</tt> header in the request should be set to the server name,
including the port if the server name included one.</li>
<li>If the hostname is not an IP literal, and the server name includes an
explicit port, resolve the IP address using AAAA or A records. Requests
are made to the resolved IP address and given port with a <tt class="docutils literal">Host</tt> header
of the original server name (with port). The target server must present a
valid certificate for the hostname.</li>
<li>If the hostname is not an IP literal, a regular HTTPS request is made
to <tt class="docutils literal"><span class="pre">https://&lt;hostname&gt;/.well-known/matrix/server</span></tt>, expecting the
schema defined later in this section. 30x redirects should be followed,
however redirection loops should be avoided. Responses (successful or
otherwise) to the <tt class="docutils literal"><span class="pre">/.well-known</span></tt> endpoint should be cached by the
requesting server. Servers should respect the cache control headers
present on the response, or use a sensible default when headers are not
present. The recommended sensible default is 24 hours. Servers should
additionally impose a maximum cache time for responses: 48 hours is
recommended. Errors are recommended to be cached for up to an hour,
and servers are encouraged to exponentially back off for repeated
failures. The schema of the <tt class="docutils literal"><span class="pre">/.well-known</span></tt> request is later in this
section. If the response is invalid (bad JSON, missing properties, non-200
response, etc), skip to step 4. If the response is valid, the <tt class="docutils literal">m.server</tt>
property is parsed as <tt class="docutils literal"><span class="pre">&lt;delegated_hostname&gt;[:&lt;delegated_port&gt;]</span></tt> and
processed as follows:<ul>
<li>If <tt class="docutils literal">&lt;delegated_hostname&gt;</tt> is an IP literal, then that IP address
should be used together with the <tt class="docutils literal">&lt;delegated_port&gt;</tt> or 8448 if no
port is provided. The target server must present a valid TLS certificate
for the IP address. Requests must be made with a <tt class="docutils literal">Host</tt> header containing
the IP address, including the port if one was provided.</li>
<li>If <tt class="docutils literal">&lt;delegated_hostname&gt;</tt> is not an IP literal, and <tt class="docutils literal">&lt;delegated_port&gt;</tt>
is present, an IP address is discovered by looking up an AAAA or A
record for <tt class="docutils literal">&lt;delegated_hostname&gt;</tt>. The resulting IP address is
used, alongside the <tt class="docutils literal">&lt;delegated_port&gt;</tt>. Requests must be made with a
<tt class="docutils literal">Host</tt> header of <tt class="docutils literal"><span class="pre">&lt;delegated_hostname&gt;:&lt;delegated_port&gt;</span></tt>. The
target server must present a valid certificate for <tt class="docutils literal">&lt;delegated_hostname&gt;</tt>.</li>
<li>If <tt class="docutils literal">&lt;delegated_hostname&gt;</tt> is not an IP literal and no
<tt class="docutils literal">&lt;delegated_port&gt;</tt> is present, an SRV record is looked up for
<tt class="docutils literal"><span class="pre">_matrix._tcp.&lt;delegated_hostname&gt;</span></tt>. This may result in another
hostname (to be resolved using AAAA or A records) and port. Requests
should be made to the resolved IP address and port with a <tt class="docutils literal">Host</tt>
header containing the <tt class="docutils literal">&lt;delegated_hostname&gt;</tt>. The target server
must present a valid certificate for <tt class="docutils literal">&lt;delegated_hostname&gt;</tt>.</li>
<li>If no SRV record is found, an IP address is resolved using AAAA
or A records. Requests are then made to the resolve IP address
and a port of 8448, using a <tt class="docutils literal">Host</tt> header of <tt class="docutils literal">&lt;delegated_hostname&gt;</tt>.
The target server must present a valid certificate for <tt class="docutils literal">&lt;delegated_hostname&gt;</tt>.</li>
</ul>
</li>
<li>If the <tt class="docutils literal"><span class="pre">/.well-known</span></tt> request resulted in an error response, a server
is found by resolving an SRV record for <tt class="docutils literal"><span class="pre">_matrix._tcp.&lt;hostname&gt;</span></tt>. This
may result in a hostname (to be resolved using AAAA or A records) and
port. Requests are made to the resolved IP address and port, using 8448
as a default port, with a <tt class="docutils literal">Host</tt> header of <tt class="docutils literal">&lt;hostname&gt;</tt>. The target
server must present a valid certificate for <tt class="docutils literal">&lt;hostname&gt;</tt>.</li>
<li>If the <tt class="docutils literal"><span class="pre">/.well-known</span></tt> request returned an error response, and the SRV
record was not found, an IP address is resolved using AAAA and A records.
Requests are made to the resolved IP address using port 8448 and a <tt class="docutils literal">Host</tt>
header containing the <tt class="docutils literal">&lt;hostname&gt;</tt>. The target server must present a
valid certificate for <tt class="docutils literal">&lt;hostname&gt;</tt>.</li>
</ol>
<p>The TLS certificate provided by the target server must be signed by a known
Certificate Authority. Servers are ultimately responsible for determining
the trusted Certificate Authorities, however are strongly encouraged to
rely on the operating system's judgement. Servers can offer administrators
a means to override the trusted authorities list. Servers can additionally
skip the certificate validation for a given whitelist of domains or netmasks
for the purposes of testing or in networks where verification is done
elsewhere, such as with <tt class="docutils literal">.onion</tt> addresses. Servers should respect SNI
when making requests where possible: a SNI should be sent for the certificate
which is expected, unless that certificate is expected to be an IP address in
which case SNI is not supported and should not be sent.</p>
<p>Servers are encouraged to make use of the
<a class="reference external" href="https://www.certificate-transparency.org/">Certificate Transparency</a> project.</p>
<p><a class="anchor" id="get-well-known-matrix-server"></a></p>
<div class="section" id="get-well-known-matrix-server">
<h3><a class="toc-backref" href="#id21">3.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/.well-known/matrix/server</span></tt></a></h3>
<p>Gets information about the delegated server for server-server communication
between Matrix homeservers. Servers should follow 30x redirects, carefully
avoiding redirect loops, and use normal X.509 certificate validation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>m.server</td>
<td>string</td>
<td>The server name to delegate server-server
communciations to, with optional port. The
delegated server name uses the same grammar as
<a class="reference external" href="../appendices.html#server-name">server names in the appendices</a>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/.well-known/matrix/server</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The delegated server information. The <tt class="docutils literal"><span class="pre">Content-Type</span></tt> for this response SHOULD be <tt class="docutils literal">application/json</tt>, however servers parsing the response should assume that the body is JSON regardless of type. Failures parsing the JSON or invalid data provided in the resulting parsed JSON should not result in discovery failure - consult the server discovery process for information on how to continue.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;m.server&quot;</span><span class="p">:</span> <span class="s2">&quot;delegated.example.com:1234&quot;</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="server-implementation"></a></p>
<div class="section" id="server-implementation">
<h2><a class="toc-backref" href="#id22">3.2&nbsp;&nbsp;&nbsp;Server implementation</a></h2>
<p><a class="anchor" id="get-matrix-federation-v1-version"></a></p>
<div class="section" id="get-matrix-federation-v1-version">
<h3><a class="toc-backref" href="#id23">3.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/version</tt></a></h3>
<p>Get the implementation name and version of this homeserver.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>server</td>
<td>Server</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Server</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>name</td>
<td>string</td>
<td>Arbitrary name that identify this implementation.</td>
</tr>
<tr><td>version</td>
<td>string</td>
<td>Version of this implementation. The version format
depends on the implementation.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/version</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The implementation name and version of this homeserver.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;server&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;My_Homeserver_Implementation&quot;</span><span class="p">,</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;ArbitraryVersionNumber&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="retrieving-server-keys"></a></p>
<div class="section" id="retrieving-server-keys">
<h2><a class="toc-backref" href="#id24">3.3&nbsp;&nbsp;&nbsp;Retrieving server keys</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There was once a &quot;version 1&quot; of the key exchange. It has been removed from the
specification due to lack of significance. It may be reviewed <a class="reference external" href="https://github.com/matrix-org/matrix-doc/blob/51faf8ed2e4a63d4cfd6d23183698ed169956cc0/specification/server_server_api.rst#232version-1">from the historical draft</a>.</p>
</div>
<p>Each homeserver publishes its public keys under <tt class="docutils literal"><span class="pre">/_matrix/key/v2/server/{keyId}</span></tt>.
Homeservers query for keys by either getting <tt class="docutils literal"><span class="pre">/_matrix/key/v2/server/{keyId}</span></tt>
directly or by querying an intermediate notary server using a
<tt class="docutils literal"><span class="pre">/_matrix/key/v2/query/{serverName}/{keyId}</span></tt> API. Intermediate notary servers
query the <tt class="docutils literal"><span class="pre">/_matrix/key/v2/server/{keyId}</span></tt> API on behalf of another server and
sign the response with their own key. A server may query multiple notary servers to
ensure that they all report the same public keys.</p>
<p>This approach is borrowed from the <a class="reference external" href="https://web.archive.org/web/20170702024706/https://perspectives-project.org/">Perspectives Project</a>, but modified to
include the NACL keys and to use JSON instead of XML. It has the advantage of
avoiding a single trust-root since each server is free to pick which notary
servers they trust and can corroborate the keys returned by a given notary
server by querying other servers.</p>
<p><a class="anchor" id="publishing-keys"></a></p>
<div class="section" id="publishing-keys">
<h3><a class="toc-backref" href="#id25">3.3.1&nbsp;&nbsp;&nbsp;Publishing Keys</a></h3>
<p>Homeservers publish their signing keys in a JSON
object at <tt class="docutils literal"><span class="pre">/_matrix/key/v2/server/{key_id}</span></tt>. The response contains a list of
<tt class="docutils literal">verify_keys</tt> that are valid for signing federation requests made by the
homeserver and for signing events. It contains a list of <tt class="docutils literal">old_verify_keys</tt> which
are only valid for signing events.</p>
<p><a class="anchor" id="get-matrix-key-v2-server-keyid"></a></p>
<div class="section" id="get-matrix-key-v2-server-keyid">
<h4><a class="toc-backref" href="#id26">3.3.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/key/v2/server/{keyId}</span></tt></a></h4>
<p>Gets the homeserver's published signing keys.
The homeserver may have any number of active keys and may have a
number of old keys.</p>
<p>Intermediate notary servers should cache a response for half of its
lifetime to avoid serving a stale response. Originating servers should
avoid returning responses that expire in less than an hour to avoid
repeated requests for a certificate that is about to expire. Requesting
servers should limit how frequently they query for certificates to
avoid flooding a server with requests.</p>
<p>If the server fails to respond to this request, intermediate notary
servers should continue to return the last response they received
from the server so that the signatures of old events can still be
checked.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>keyId</td>
<td>string</td>
<td><p class="first"><strong>Deprecated</strong>. Servers should not use this
parameter and instead opt to return all keys, not
just the requested one. The key ID to look up.</p>
<p class="last">When excluded, the trailing slash on this endpoint
is optional.</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Server Keys</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>server_name</td>
<td>string</td>
<td><strong>Required.</strong> DNS name of the homeserver.</td>
</tr>
<tr><td>verify_keys</td>
<td>{string: Verify Key}</td>
<td><p class="first"><strong>Required.</strong> Public keys of the homeserver for
verifying digital signatures.</p>
<p class="last">The object's key is the algorithm and version
combined (<tt class="docutils literal">ed25519</tt> being the algorithm and
<tt class="docutils literal">abc123</tt> being the version in the example
below). Together, this forms the Key ID. The
version must have characters matching the regular
expression <tt class="docutils literal"><span class="pre">[a-zA-Z0-9_]</span></tt>.</p>
</td>
</tr>
<tr><td>old_verify_keys</td>
<td>{string: Old Verify Key}</td>
<td><p class="first">The public keys that the server used to use and
when it stopped using them.</p>
<p class="last">The object's key is the algorithm and version
combined (<tt class="docutils literal">ed25519</tt> being the algorithm and
<tt class="docutils literal">0ldK3y</tt> being the version in the example
below). Together, this forms the Key ID. The
version must have characters matching the regular
expression <tt class="docutils literal"><span class="pre">[a-zA-Z0-9_]</span></tt>.</p>
</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><p class="first">Digital signatures for this object signed using
the <tt class="docutils literal">verify_keys</tt>.</p>
<p class="last">The signature is calculated using the process
described at <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
</td>
</tr>
<tr><td>valid_until_ts</td>
<td>integer</td>
<td><p class="first">POSIX timestamp when the list of valid keys should
be refreshed. This field MUST be ignored in room
versions 1, 2, 3, and 4. Keys used beyond this
timestamp MUST be considered invalid, depending on
the <a class="reference external" href="../index.html#room-versions">room version specification</a>.</p>
<p class="last">Servers MUST use the lesser of this field and 7
days into the future when determining if a key is
valid. This is to avoid a situation where an
attacker publishes a key which is valid for a
significant amount of time without a way for the
homeserver owner to revoke it.</p>
</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Verify Key</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>key</td>
<td>string</td>
<td><strong>Required.</strong> The <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a> encoded key.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Old Verify Key</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>expired_ts</td>
<td>integer</td>
<td><strong>Required.</strong> POSIX timestamp in milliseconds for
when this key expired.</td>
</tr>
<tr><td>key</td>
<td>string</td>
<td><strong>Required.</strong> The <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a> encoded key.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/key/v2/server/ed25519%3Aabc123</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The homeserver's keys</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;server_name&quot;</span><span class="p">:</span> <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;verify_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;ed25519:abc123&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBzaG91bGQgYmUgYSByZWFsIGVkMjU1MTkgcGF5bG9hZA&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&quot;old_verify_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;ed25519:0ldk3y&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;expired_ts&quot;</span><span class="p">:</span> <span class="mi">1532645052628</span><span class="p">,</span>
      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBzaG91bGQgYmUgeW91ciBvbGQga2V5J3MgZWQyNTUxOSBwYXlsb2FkLg&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;example.org&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;ed25519:auto2&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBzaG91bGQgYWN0dWFsbHkgYmUgYSBzaWduYXR1cmU&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&quot;valid_until_ts&quot;</span><span class="p">:</span> <span class="mi">1652262000000</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="querying-keys-through-another-server"></a></p>
<div class="section" id="querying-keys-through-another-server">
<h3><a class="toc-backref" href="#id27">3.3.2&nbsp;&nbsp;&nbsp;Querying Keys Through Another Server</a></h3>
<p>Servers may query another server's keys through a notary server. The notary
server may be another homeserver. The notary server will retrieve keys from
the queried servers through use of the <tt class="docutils literal"><span class="pre">/_matrix/key/v2/server/{keyId}</span></tt>
API. The notary server will additionally sign the response from the queried
server before returning the results.</p>
<p>Notary servers can return keys for servers that are offline or having issues
serving their own keys by using cached responses. Keys can be queried from
multiple servers to mitigate against DNS spoofing.</p>
<p><a class="anchor" id="get-matrix-key-v2-query-servername-keyid"></a></p>
<div class="section" id="get-matrix-key-v2-query-servername-keyid">
<h4><a class="toc-backref" href="#id28">3.3.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/key/v2/query/{serverName}/{keyId}</span></tt></a></h4>
<p>Query for another server's keys. The receiving (notary) server must
sign the keys returned by the queried server.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>serverName</td>
<td>string</td>
<td><strong>Required.</strong> The server's DNS name to query</td>
</tr>
<tr><td>keyId</td>
<td>string</td>
<td><p class="first"><strong>Deprecated</strong>. Servers should not use this
parameter and instead opt to return all keys, not
just the requested one. The key ID to look up.</p>
<p class="last">When excluded, the trailing slash on this endpoint
is optional.</p>
</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>minimum_valid_until_ts</td>
<td>integer</td>
<td><p class="first">A millisecond POSIX timestamp in milliseconds
indicating when the returned certificates will
need to be valid until to be useful to the
requesting server.</p>
<p class="last">If not supplied, the current time as determined by
the notary server is used.</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>server_keys</td>
<td>[Server Keys]</td>
<td>The queried server's keys, signed by the notary
server.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Server Keys</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>server_name</td>
<td>string</td>
<td><strong>Required.</strong> DNS name of the homeserver.</td>
</tr>
<tr><td>verify_keys</td>
<td>{string: Verify Key}</td>
<td><p class="first"><strong>Required.</strong> Public keys of the homeserver for
verifying digital signatures.</p>
<p class="last">The object's key is the algorithm and version
combined (<tt class="docutils literal">ed25519</tt> being the algorithm and
<tt class="docutils literal">abc123</tt> being the version in the example
below). Together, this forms the Key ID. The
version must have characters matching the regular
expression <tt class="docutils literal"><span class="pre">[a-zA-Z0-9_]</span></tt>.</p>
</td>
</tr>
<tr><td>old_verify_keys</td>
<td>{string: Old Verify Key}</td>
<td><p class="first">The public keys that the server used to use and
when it stopped using them.</p>
<p class="last">The object's key is the algorithm and version
combined (<tt class="docutils literal">ed25519</tt> being the algorithm and
<tt class="docutils literal">0ldK3y</tt> being the version in the example
below). Together, this forms the Key ID. The
version must have characters matching the regular
expression <tt class="docutils literal"><span class="pre">[a-zA-Z0-9_]</span></tt>.</p>
</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><p class="first">Digital signatures for this object signed using
the <tt class="docutils literal">verify_keys</tt>.</p>
<p class="last">The signature is calculated using the process
described at <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
</td>
</tr>
<tr><td>valid_until_ts</td>
<td>integer</td>
<td><p class="first">POSIX timestamp when the list of valid keys should
be refreshed. This field MUST be ignored in room
versions 1, 2, 3, and 4. Keys used beyond this
timestamp MUST be considered invalid, depending on
the <a class="reference external" href="../index.html#room-versions">room version specification</a>.</p>
<p class="last">Servers MUST use the lesser of this field and 7
days into the future when determining if a key is
valid. This is to avoid a situation where an
attacker publishes a key which is valid for a
significant amount of time without a way for the
homeserver owner to revoke it.</p>
</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Verify Key</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>key</td>
<td>string</td>
<td><strong>Required.</strong> The <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a> encoded key.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Old Verify Key</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>expired_ts</td>
<td>integer</td>
<td><strong>Required.</strong> POSIX timestamp in milliseconds for
when this key expired.</td>
</tr>
<tr><td>key</td>
<td>string</td>
<td><strong>Required.</strong> The <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a> encoded key.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/key/v2/query/matrix.org/ed25519%3Aabc123?minimum_valid_until_ts=1234567890</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The keys for the server, or an empty array if the server could not be reached
and no cached keys were available.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;server_keys&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;server_name&quot;</span><span class="p">:</span> <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;verify_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;ed25519:abc123&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBzaG91bGQgYmUgYSByZWFsIGVkMjU1MTkgcGF5bG9hZA&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;old_verify_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;ed25519:0ldk3y&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;expired_ts&quot;</span><span class="p">:</span> <span class="mi">1532645052628</span><span class="p">,</span>
          <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBzaG91bGQgYmUgeW91ciBvbGQga2V5J3MgZWQyNTUxOSBwYXlsb2FkLg&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;example.org&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;ed25519:abc123&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBzaG91bGQgYWN0dWFsbHkgYmUgYSBzaWduYXR1cmU&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;notary.server.com&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;ed25519:010203&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBpcyBhbm90aGVyIHNpZ25hdHVyZQ&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;valid_until_ts&quot;</span><span class="p">:</span> <span class="mi">1652262000000</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-key-v2-query"></a></p>
<div class="section" id="post-matrix-key-v2-query">
<h4><a class="toc-backref" href="#id29">3.3.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/key/v2/query</tt></a></h4>
<p>Query for keys from multiple servers in a batch format. The receiving (notary)
server must sign the keys returned by the queried servers.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>server_keys</td>
<td>{string: {string: Query Criteria}}</td>
<td><p class="first"><strong>Required.</strong> The query criteria. The outer
<tt class="docutils literal">string</tt> key on the object is the server name
(eg: <tt class="docutils literal">matrix.org</tt>). The inner <tt class="docutils literal">string</tt> key is
the Key ID to query for the particular server. If
no key IDs are given to be queried, the notary
server should query for all keys. If no servers
are given, the notary server must return an empty
<tt class="docutils literal">server_keys</tt> array in the response.</p>
<p class="last">The notary server may return multiple keys
regardless of the Key IDs given.</p>
</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Query Criteria</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>minimum_valid_until_ts</td>
<td>integer</td>
<td><p class="first">A millisecond POSIX timestamp in milliseconds
indicating when the returned certificates will
need to be valid until to be useful to the
requesting server.</p>
<p class="last">If not supplied, the current time as determined by
the notary server is used.</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>server_keys</td>
<td>[Server Keys]</td>
<td>The queried server's keys, signed by the notary
server.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Server Keys</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>server_name</td>
<td>string</td>
<td><strong>Required.</strong> DNS name of the homeserver.</td>
</tr>
<tr><td>verify_keys</td>
<td>{string: Verify Key}</td>
<td><p class="first"><strong>Required.</strong> Public keys of the homeserver for
verifying digital signatures.</p>
<p class="last">The object's key is the algorithm and version
combined (<tt class="docutils literal">ed25519</tt> being the algorithm and
<tt class="docutils literal">abc123</tt> being the version in the example
below). Together, this forms the Key ID. The
version must have characters matching the regular
expression <tt class="docutils literal"><span class="pre">[a-zA-Z0-9_]</span></tt>.</p>
</td>
</tr>
<tr><td>old_verify_keys</td>
<td>{string: Old Verify Key}</td>
<td><p class="first">The public keys that the server used to use and
when it stopped using them.</p>
<p class="last">The object's key is the algorithm and version
combined (<tt class="docutils literal">ed25519</tt> being the algorithm and
<tt class="docutils literal">0ldK3y</tt> being the version in the example
below). Together, this forms the Key ID. The
version must have characters matching the regular
expression <tt class="docutils literal"><span class="pre">[a-zA-Z0-9_]</span></tt>.</p>
</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><p class="first">Digital signatures for this object signed using
the <tt class="docutils literal">verify_keys</tt>.</p>
<p class="last">The signature is calculated using the process
described at <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
</td>
</tr>
<tr><td>valid_until_ts</td>
<td>integer</td>
<td><p class="first">POSIX timestamp when the list of valid keys should
be refreshed. This field MUST be ignored in room
versions 1, 2, 3, and 4. Keys used beyond this
timestamp MUST be considered invalid, depending on
the <a class="reference external" href="../index.html#room-versions">room version specification</a>.</p>
<p class="last">Servers MUST use the lesser of this field and 7
days into the future when determining if a key is
valid. This is to avoid a situation where an
attacker publishes a key which is valid for a
significant amount of time without a way for the
homeserver owner to revoke it.</p>
</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Verify Key</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>key</td>
<td>string</td>
<td><strong>Required.</strong> The <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a> encoded key.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Old Verify Key</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>expired_ts</td>
<td>integer</td>
<td><strong>Required.</strong> POSIX timestamp in milliseconds for
when this key expired.</td>
</tr>
<tr><td>key</td>
<td>string</td>
<td><strong>Required.</strong> The <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a> encoded key.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">POST</span> <span class="nn">/_matrix/key/v2/query</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;server_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;example.org&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;ed25519:abc123&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;minimum_valid_until_ts&quot;</span><span class="p">:</span> <span class="mi">1234567890</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The keys for the queried servers, signed by the notary server. Servers which
are offline and have no cached keys will not be included in the result. This
may result in an empty array.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;server_keys&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;server_name&quot;</span><span class="p">:</span> <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;verify_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;ed25519:abc123&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBzaG91bGQgYmUgYSByZWFsIGVkMjU1MTkgcGF5bG9hZA&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;old_verify_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;ed25519:0ldk3y&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;expired_ts&quot;</span><span class="p">:</span> <span class="mi">1532645052628</span><span class="p">,</span>
          <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBzaG91bGQgYmUgeW91ciBvbGQga2V5J3MgZWQyNTUxOSBwYXlsb2FkLg&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;example.org&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;ed25519:abc123&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBzaG91bGQgYWN0dWFsbHkgYmUgYSBzaWduYXR1cmU&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;notary.server.com&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;ed25519:010203&quot;</span><span class="p">:</span> <span class="s2">&quot;VGhpcyBpcyBhbm90aGVyIHNpZ25hdHVyZQ&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;valid_until_ts&quot;</span><span class="p">:</span> <span class="mi">1652262000000</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
</div>
</div>
</div>
</div>
<p><a class="anchor" id="authentication"></a></p>
<div class="section" id="authentication">
<h1><a class="toc-backref" href="#id30">4&nbsp;&nbsp;&nbsp;Authentication</a></h1>
<p><a class="anchor" id="request-authentication"></a></p>
<div class="section" id="request-authentication">
<h2><a class="toc-backref" href="#id31">4.1&nbsp;&nbsp;&nbsp;Request Authentication</a></h2>
<p>Every HTTP request made by a homeserver is authenticated using public key
digital signatures. The request method, target and body are signed by wrapping
them in a JSON object and signing it using the JSON signing algorithm. The
resulting signatures are added as an Authorization header with an auth scheme
of <tt class="docutils literal"><span class="pre">X-Matrix</span></tt>. Note that the target field should include the full path
starting with <tt class="docutils literal"><span class="pre">/_matrix/...</span></tt>, including the <tt class="docutils literal">?</tt> and any query parameters if
present, but should not include the leading <tt class="docutils literal">https:</tt>, nor the destination
server's hostname.</p>
<p>Step 1 sign JSON:</p>
<pre class="code literal-block">
 {
     &quot;method&quot;: &quot;GET&quot;,
     &quot;uri&quot;: &quot;/target&quot;,
     &quot;origin&quot;: &quot;origin.hs.example.com&quot;,
     &quot;destination&quot;: &quot;destination.hs.example.com&quot;,
     &quot;content&quot;: &lt;request body&gt;,
     &quot;signatures&quot;: {
         &quot;origin.hs.example.com&quot;: {
             &quot;ed25519:key1&quot;: &quot;ABCDEF...&quot;
         }
     }
}
</pre>
<p>The server names in the JSON above are the server names for each homeserver involved. Delegation from
the <a class="reference external" href="#resolving-server-names">server name resolution section</a> above do not affect
these - the server names from before delegation would take place are used. This
same condition applies throughout the request signing process.</p>
<p>Step 2 add Authorization header:</p>
<pre class="code literal-block">
GET /target HTTP/1.1
Authorization: X-Matrix origin=origin.example.com,key=&quot;ed25519:key1&quot;,sig=&quot;ABCDEF...&quot;
Content-Type: application/json

&lt;JSON-encoded request body&gt;
</pre>
<p>Example python code:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">authorization_headers</span><span class="p">(</span><span class="n">origin_name</span><span class="p">,</span> <span class="n">origin_signing_key</span><span class="p">,</span>
                          <span class="n">destination_name</span><span class="p">,</span> <span class="n">request_method</span><span class="p">,</span> <span class="n">request_target</span><span class="p">,</span>
                          <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="p">{</span>
         <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request_method</span><span class="p">,</span>
         <span class="s2">&quot;uri&quot;</span><span class="p">:</span> <span class="n">request_target</span><span class="p">,</span>
         <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">origin_name</span><span class="p">,</span>
         <span class="s2">&quot;destination&quot;</span><span class="p">:</span> <span class="n">destination_name</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">request_json</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>

    <span class="n">signed_json</span> <span class="o">=</span> <span class="n">sign_json</span><span class="p">(</span><span class="n">request_json</span><span class="p">,</span> <span class="n">origin_name</span><span class="p">,</span> <span class="n">origin_signing_key</span><span class="p">)</span>

    <span class="n">authorization_headers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">signed_json</span><span class="p">[</span><span class="s2">&quot;signatures&quot;</span><span class="p">][</span><span class="n">origin_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">authorization_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span>
            <span class="s2">&quot;X-Matrix origin=</span><span class="si">%s</span><span class="s2">,key=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,sig=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">origin_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span> <span class="n">authorization_headers</span><span class="p">)</span>
</pre>
</div>
<p><a class="anchor" id="response-authentication"></a></p>
<div class="section" id="response-authentication">
<h2><a class="toc-backref" href="#id32">4.2&nbsp;&nbsp;&nbsp;Response Authentication</a></h2>
<p>Responses are authenticated by the TLS server certificate. A homeserver should
not send a request until it has authenticated the connected server to avoid
leaking messages to eavesdroppers.</p>
</div>
<p><a class="anchor" id="client-tls-certificates"></a></p>
<div class="section" id="client-tls-certificates">
<h2><a class="toc-backref" href="#id33">4.3&nbsp;&nbsp;&nbsp;Client TLS Certificates</a></h2>
<p>Requests are authenticated at the HTTP layer rather than at the TLS layer
because HTTP services like Matrix are often deployed behind load balancers that
handle the TLS and these load balancers make it difficult to check TLS client
certificates.</p>
<p>A homeserver may provide a TLS client certificate and the receiving homeserver
may check that the client certificate matches the certificate of the origin
homeserver.</p>
</div>
</div>
<p><a class="anchor" id="transactions"></a></p>
<div class="section" id="transactions">
<h1><a class="toc-backref" href="#id34">5&nbsp;&nbsp;&nbsp;Transactions</a></h1>
<p>The transfer of EDUs and PDUs between homeservers is performed by an exchange
of Transaction messages, which are encoded as JSON objects, passed over an HTTP
PUT request. A Transaction is meaningful only to the pair of homeservers that
exchanged it; they are not globally-meaningful.</p>
<p>Transactions are limited in size; they can have at most 50 PDUs and 100 EDUs.</p>
<p><a class="anchor" id="put-matrix-federation-v1-send-txnid"></a></p>
<div class="section" id="put-matrix-federation-v1-send-txnid">
<h2><a class="toc-backref" href="#id35">5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v1/send/{txnId}</span></tt></a></h2>
<p>Push messages representing live activity to another server. The destination name
will be set to that of the receiving server itself. Each embedded PDU in the
transaction body will be processed.</p>
<p>The sending server must wait and retry for a 200 OK response before sending a
transaction with a different <tt class="docutils literal">txnId</tt> to the receiving server.</p>
<p>Note that events have a different format depending on the room version - check
the <a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>txnId</td>
<td>string</td>
<td><strong>Required.</strong> The transaction ID.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">server_name</tt> of the
homeserver sending this transaction.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> POSIX timestamp in milliseconds on
originating homeserver when this transaction
started.</td>
</tr>
<tr><td>pdus</td>
<td>[PDU]</td>
<td><strong>Required.</strong> List of persistent updates to rooms.
Must not include more than 50 PDUs. Note that
events have a different format depending on the
room version - check the <a class="reference external" href="../index.html#room-versions">room version
specification</a> for precise event formats.</td>
</tr>
<tr><td>edus</td>
<td>[Ephemeral Data Unit]</td>
<td>List of ephemeral messages. May be omitted if
there are no ephemeral messages to be sent. Must
not include more than 100 EDUs.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Ephemeral Data Unit</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>edu_type</td>
<td>string</td>
<td><strong>Required.</strong> The type of ephemeral message.</td>
</tr>
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The content of the ephemeral
message.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>PDU Processing Results</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>pdus</td>
<td>{string: PDU Processing Result}</td>
<td><strong>Required.</strong> The PDUs from the original
transaction. The string key represents the ID of
the PDU (event) that was processed.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PDU Processing Result</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>error</td>
<td>string</td>
<td>A human readable description about what went wrong
in processing this PDU. If no error is present,
the PDU can be considered successfully handled.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">PUT</span> <span class="nn">/_matrix/federation/v1/send/S0meTransacti0nId</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1532991320875</span><span class="p">,</span>
  <span class="nt">&quot;pdus&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;edus&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;edu_type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.presence&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The result of processing the transaction. The server is to use this response even in
the event of one or more PDUs failing to be processed.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;pdus&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;$successful_event:example.org&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;$failed_event:example.org&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;You are not allowed to send a message to this room.&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="pdus"></a></p>
<div class="section" id="pdus">
<span id="persistent-data-unit-schema"></span><h1><a class="toc-backref" href="#id36">6&nbsp;&nbsp;&nbsp;PDUs</a></h1>
<p>Each PDU contains a single Room Event which the origin server wants to send to
the destination.</p>
<p>The <tt class="docutils literal">prev_events</tt> field of a PDU identifies the &quot;parents&quot; of the event, and
thus establishes a partial ordering on events within the room by linking them
into a Directed Acyclic Graph (DAG). The sending server should populate this
field with all of the events in the room for which it has not yet seen a
child - thus demonstrating that the event comes after all other known events.</p>
<p>For example, consider a room whose events form the DAG shown below. A server
creating a new event in this room should populate the new event's
<tt class="docutils literal">prev_events</tt> field with <tt class="docutils literal">E4</tt> and <tt class="docutils literal">E5</tt>, since neither event yet has a child:</p>
<pre class="literal-block">
    E1
    ^
    |
+-&gt; E2 &lt;-+
|        |
E3       E5
^
|
E4
</pre>
<p>For a full schema of what a PDU looks like, see the <a class="reference external" href="../index.html#room-versions">room version specification</a>.</p>
<p><a class="anchor" id="checks-performed-on-receipt-of-a-pdu"></a></p>
<div class="section" id="checks-performed-on-receipt-of-a-pdu">
<h2><a class="toc-backref" href="#id37">6.1&nbsp;&nbsp;&nbsp;Checks performed on receipt of a PDU</a></h2>
<p>Whenever a server receives an event from a remote server, the receiving server
must ensure that the event:</p>
<ol class="arabic simple">
<li>Is a valid event, otherwise it is dropped.</li>
<li>Passes signature checks, otherwise it is dropped.</li>
<li>Passes hash checks, otherwise it is redacted before being processed
further.</li>
<li>Passes authorization rules based on the event's auth events, otherwise it
is rejected.</li>
<li>Passes authorization rules based on the state at the event, otherwise it
is rejected.</li>
<li>Passes authorization rules based on the current state of the room, otherwise it
is &quot;soft failed&quot;.</li>
</ol>
<p>Further details of these checks, and how to handle failures, are described
below.</p>
<p>The <a class="reference external" href="#signing-events">Signing Events</a> section has more information on which hashes
and signatures are expected on events, and how to calculate them.</p>
<p><a class="anchor" id="definitions"></a></p>
<div class="section" id="definitions">
<h3><a class="toc-backref" href="#id38">6.1.1&nbsp;&nbsp;&nbsp;Definitions</a></h3>
<dl class="docutils">
<dt>Required Power Level</dt>
<dd>A given event type has an associated <em>required power level</em>. This is given by
the current <tt class="docutils literal">m.room.power_levels</tt> event. The event type is either listed
explicitly in the <tt class="docutils literal">events</tt> section or given by either <tt class="docutils literal">state_default</tt> or
<tt class="docutils literal">events_default</tt> depending on if the event is a state event or not.</dd>
<dt>Invite Level, Kick Level, Ban Level, Redact Level</dt>
<dd>The levels given by the <tt class="docutils literal">invite</tt>, <tt class="docutils literal">kick</tt>, <tt class="docutils literal">ban</tt>, and <tt class="docutils literal">redact</tt>
properties in the current <tt class="docutils literal">m.room.power_levels</tt> state. Each defaults to 50
if unspecified.</dd>
<dt>Target User</dt>
<dd>For an <tt class="docutils literal">m.room.member</tt> state event, the user given by the <tt class="docutils literal">state_key</tt> of
the event.</dd>
</dl>
</div>
<p><a class="anchor" id="id13"></a></p>
<div class="section" id="id13">
<span id="authorization-rules"></span><h3><a class="toc-backref" href="#id39">6.1.2&nbsp;&nbsp;&nbsp;Authorization rules</a></h3>
<p>The rules governing whether an event is authorized depends on a set of state. A
given event is checked multiple times against different sets of state, as
specified above. Each room version can have a different algorithm for how the
rules work, and which rules are applied. For more detailed information, please
see the <a class="reference external" href="../index.html#room-versions">room version specification</a>.</p>
<p><a class="anchor" id="auth-events-selection"></a></p>
<div class="section" id="auth-events-selection">
<h4><a class="toc-backref" href="#id40">6.1.2.1&nbsp;&nbsp;&nbsp;Auth events selection</a></h4>
<p>The <tt class="docutils literal">auth_events</tt> field of a PDU identifies the set of events which give the
sender permission to send the event. The <tt class="docutils literal">auth_events</tt> for the
<tt class="docutils literal">m.room.create</tt> event in a room is empty; for other events, it should be the
following subset of the room state:</p>
<ul>
<li><p class="first">The <tt class="docutils literal">m.room.create</tt> event.</p>
</li>
<li><p class="first">The current <tt class="docutils literal">m.room.power_levels</tt> event, if any.</p>
</li>
<li><p class="first">The sender's current <tt class="docutils literal">m.room.member</tt> event, if any.</p>
</li>
<li><p class="first">If type is <tt class="docutils literal">m.room.member</tt>:</p>
<blockquote>
<ul class="simple">
<li>The target's current <tt class="docutils literal">m.room.member</tt> event, if any.</li>
<li>If <tt class="docutils literal">membership</tt> is <tt class="docutils literal">join</tt> or <tt class="docutils literal">invite</tt>, the current
<tt class="docutils literal">m.room.join_rules</tt> event, if any.</li>
<li>If membership is <tt class="docutils literal">invite</tt> and <tt class="docutils literal">content</tt> contains a
<tt class="docutils literal">third_party_invite</tt> property, the current
<tt class="docutils literal">m.room.third_party_invite</tt> event with <tt class="docutils literal">state_key</tt> matching
<tt class="docutils literal">content.third_party_invite.signed.token</tt>, if any.</li>
</ul>
</blockquote>
</li>
</ul>
</div>
</div>
<p><a class="anchor" id="rejection"></a></p>
<div class="section" id="rejection">
<h3><a class="toc-backref" href="#id41">6.1.3&nbsp;&nbsp;&nbsp;Rejection</a></h3>
<p>If an event is rejected it should neither be relayed to clients nor be included
as a prev event in any new events generated by the server. Subsequent events
from other servers that reference rejected events should be allowed if they
still pass the auth rules. The state used in the checks should be calculated as
normal, except not updating with the rejected event where it is a state event.</p>
<p>If an event in an incoming transaction is rejected, this should not cause the
transaction request to be responded to with an error response.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This means that events may be included in the room DAG even though they
should be rejected.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is in contrast to redacted events which can still affect the
state of the room. For example, a redacted <tt class="docutils literal">join</tt> event will still
result in the user being considered joined.</p>
</div>
</div>
<p><a class="anchor" id="soft-failure"></a></p>
<div class="section" id="soft-failure">
<h3><a class="toc-backref" href="#id42">6.1.4&nbsp;&nbsp;&nbsp;Soft failure</a></h3>
<div class="admonition admonition-rationale">
<p class="first admonition-title">Rationale</p>
<p>It is important that we prevent users from evading bans (or other power
restrictions) by creating events which reference old parts of the DAG. For
example, a banned user could continue to send messages to a room by having
their server send events which reference the event before they were banned.
Note that such events are entirely valid, and we cannot simply reject them, as
it is impossible to distinguish such an event from a legitimate one which has
been delayed. We must therefore accept such events and let them participate in
state resolution and the federation protocol as normal. However, servers may
choose not to send such events on to their clients, so that end users won't
actually see the events.</p>
<p>When this happens it is often fairly obvious to servers, as they can see that
the new event doesn't actually pass auth based on the &quot;current state&quot; (i.e.
the resolved state across all forward extremities). While the event is
technically valid, the server can choose to not notify clients about the new
event.</p>
<p class="last">This discourages servers from sending events that evade bans etc. in this way,
as end users won't actually see the events.</p>
</div>
<p>When the homeserver receives a new event over federation it should also check
whether the event passes auth checks based on the current state of the room (as
well as based on the state at the event). If the event does not pass the auth
checks based on the <em>current state</em> of the room (but does pass the auth checks
based on the state at that event) it should be &quot;soft failed&quot;.</p>
<p>When an event is &quot;soft failed&quot; it should not be relayed to the client nor be
referenced by new events created by the homeserver (i.e. they should not be
added to the server's list of forward extremities of the room). Soft failed
events are otherwise handled as usual.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Soft failed events participate in state resolution as normal if further events
are received which reference it. It is the job of the state resolution
algorithm to ensure that malicious events cannot be injected into the room
state via this mechanism.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Because soft failed state events participate in state resolution as normal, it
is possible for such events to appear in the current state of the room. In
that case the client should be told about the soft failed event in the usual
way (e.g. by sending it down in the <tt class="docutils literal">state</tt> section of a sync response).</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A soft failed event should be returned in response to federation requests
where appropriate (e.g. in <tt class="docutils literal"><span class="pre">/event/&lt;event_id&gt;</span></tt>). Note that soft failed
events are returned in <tt class="docutils literal">/backfill</tt> and <tt class="docutils literal">/get_missing_events</tt> responses
only if the requests include events referencing the soft failed events.</p>
</div>
<div class="admonition admonition-example">
<p class="first admonition-title">Example</p>
<p>As an example consider the event graph:</p>
<pre class="literal-block">
  A
 /
B
</pre>
<p>where <tt class="docutils literal">B</tt> is a ban of a user <tt class="docutils literal">X</tt>. If the user <tt class="docutils literal">X</tt> tries to set the topic
by sending an event <tt class="docutils literal">C</tt> while evading the ban:</p>
<pre class="literal-block">
  A
 / \
B   C
</pre>
<p>servers that receive <tt class="docutils literal">C</tt> after <tt class="docutils literal">B</tt> should soft fail event <tt class="docutils literal">C</tt>, and so
will neither relay <tt class="docutils literal">C</tt> to its clients nor send any events referencing <tt class="docutils literal">C</tt>.</p>
<p>If later another server sends an event <tt class="docutils literal">D</tt> that references both <tt class="docutils literal">B</tt> and
<tt class="docutils literal">C</tt> (this can happen if it received <tt class="docutils literal">C</tt> before <tt class="docutils literal">B</tt>):</p>
<pre class="literal-block">
  A
 / \
B   C
 \ /
  D
</pre>
<p>then servers will handle <tt class="docutils literal">D</tt> as normal. <tt class="docutils literal">D</tt> is sent to the servers'
clients (assuming <tt class="docutils literal">D</tt> passes auth checks). The state at <tt class="docutils literal">D</tt> may resolve to
a state that includes <tt class="docutils literal">C</tt>, in which case clients should also to be told that
the state has changed to include <tt class="docutils literal">C</tt>. (<em>Note</em>: This depends on the exact
state resolution algorithm used. In the original version of the algorithm
<tt class="docutils literal">C</tt> would be in the resolved state, whereas in latter versions the algorithm
tries to prioritise the ban over the topic change.)</p>
<p>Note that this is essentially equivalent to the situation where one server
doesn't receive <tt class="docutils literal">C</tt> at all, and so asks another server for the state of the
<tt class="docutils literal">C</tt> branch.</p>
<p>Let's go back to the graph before <tt class="docutils literal">D</tt> was sent:</p>
<pre class="literal-block">
  A
 / \
B   C
</pre>
<p>If all the servers in the room saw <tt class="docutils literal">B</tt> before <tt class="docutils literal">C</tt> and so soft fail <tt class="docutils literal">C</tt>,
then any new event <tt class="docutils literal">D'</tt> will not reference <tt class="docutils literal">C</tt>:</p>
<pre class="last literal-block">
  A
 / \
B   C
|
D
</pre>
</div>
</div>
<p><a class="anchor" id="retrieving-event-authorization-information"></a></p>
<div class="section" id="retrieving-event-authorization-information">
<h3><a class="toc-backref" href="#id43">6.1.5&nbsp;&nbsp;&nbsp;Retrieving event authorization information</a></h3>
<p>The homeserver may be missing event authorization information, or wish to check
with other servers to ensure it is receiving the correct auth chain. These APIs
give the homeserver an avenue for getting the information it needs.</p>
<p><a class="anchor" id="get-matrix-federation-v1-event-auth-roomid-eventid"></a></p>
<div class="section" id="get-matrix-federation-v1-event-auth-roomid-eventid">
<h4><a class="toc-backref" href="#id44">6.1.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/event_auth/{roomId}/{eventId}</span></tt></a></h4>
<p>Retrieves the complete auth chain for a given event.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID to get the auth chain
for.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID to get the auth chain
of.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>auth_chain</td>
<td>[PDU]</td>
<td><strong>Required.</strong> The full set of authorization events
that make up the state of the room, and their
authorization events, recursively. Note that
events have a different format depending on the
room version - check the <a class="reference external" href="../index.html#room-versions">room version
specification</a> for precise event formats.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/event_auth/%21abc123%3Amatrix.org/%24helloworld%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The auth chain for the event.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;auth_chain&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
</div>
</div>
</div>
</div>
<p><a class="anchor" id="edus"></a></p>
<div class="section" id="edus">
<h1><a class="toc-backref" href="#id45">7&nbsp;&nbsp;&nbsp;EDUs</a></h1>
<p>EDUs, by comparison to PDUs, do not have an ID, a room ID, or a list of
&quot;previous&quot; IDs. They are intended to be non-persistent data such as user
presence, typing notifications, etc.</p>
<p><a class="anchor" id="ephemeral-data-unit-schema"></a></p>
<div class="section" id="ephemeral-data-unit-schema">
<h2><a class="toc-backref" href="#id46">7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">Ephemeral Data Unit</tt> schema</a></h2>
<p>An ephemeral data unit.</p>
<p><tt class="docutils literal">Ephemeral Data Unit</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>edu_type</td>
<td>string</td>
<td><strong>Required.</strong> The type of ephemeral message.</td>
</tr>
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The content of the ephemeral
message.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="p">{</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;edu_type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.presence&quot;</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="room-state-resolution"></a></p>
<div class="section" id="room-state-resolution">
<h1><a class="toc-backref" href="#id47">8&nbsp;&nbsp;&nbsp;Room State Resolution</a></h1>
<p>The <em>state</em> of a room is a map of <tt class="docutils literal">(event_type, state_key)</tt> to
<tt class="docutils literal">event_id</tt>. Each room starts with an empty state, and each state event which
is accepted into the room updates the state of that room.</p>
<p>Where each event has a single <tt class="docutils literal">prev_event</tt>, it is clear what the state of the
room after each event should be. However, when two branches in the event graph
merge, the state of those branches might differ, so a <em>state resolution</em>
algorithm must be used to determine the resultant state.</p>
<p>For example, consider the following event graph (where the oldest event, E0,
is at the top):</p>
<pre class="literal-block">
  E0
  |
  E1
 /  \
E2  E4
|    |
E3   |
 \  /
  E5
</pre>
<p>Suppose E3 and E4 are both <tt class="docutils literal">m.room.name</tt> events which set the name of the
room. What should the name of the room be at E5?</p>
<p>The algorithm to be used for state resolution depends on the room version. For
a description of each room version's algorithm, please see the <a class="reference external" href="../index.html#room-versions">room version specification</a>.</p>
</div>
<p><a class="anchor" id="backfilling-and-retrieving-missing-events"></a></p>
<div class="section" id="backfilling-and-retrieving-missing-events">
<h1><a class="toc-backref" href="#id48">9&nbsp;&nbsp;&nbsp;Backfilling and retrieving missing events</a></h1>
<p>Once a homeserver has joined a room, it receives all the events emitted by
other homeservers in that room, and is thus aware of the entire history of the
room from that moment onwards. Since users in that room are able to request the
history by the <tt class="docutils literal">/messages</tt> client API endpoint, it's possible that they might
step backwards far enough into history before the homeserver itself was a
member of that room.</p>
<p>To cover this case, the federation API provides a server-to-server analog of
the <tt class="docutils literal">/messages</tt> client API, allowing one homeserver to fetch history from
another. This is the <tt class="docutils literal">/backfill</tt> API.</p>
<p>To request more history, the requesting homeserver picks another homeserver
that it thinks may have more (most likely this should be a homeserver for
some of the existing users in the room at the earliest point in history it
has currently), and makes a <tt class="docutils literal">/backfill</tt> request.</p>
<p>Similar to backfilling a room's history, a server may not have all the events
in the graph. That server may use the <tt class="docutils literal">/get_missing_events</tt> API to acquire
the events it is missing.</p>
<!-- TODO-spec
Specify (or remark that it is unspecified) how the server handles divergent
history. DFS? BFS? Anything weirder? -->
<p><a class="anchor" id="get-matrix-federation-v1-backfill-roomid"></a></p>
<div class="section" id="get-matrix-federation-v1-backfill-roomid">
<h2><a class="toc-backref" href="#id49">9.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/backfill/{roomId}</span></tt></a></h2>
<p>Retrieves a sliding-window history of previous PDUs that occurred in the given room.
Starting from the PDU ID(s) given in the <tt class="docutils literal">v</tt> argument, the PDUs given in <tt class="docutils literal">v</tt> and
the PDUs that preceded them are retrieved, up to the total number given by the <tt class="docutils literal">limit</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID to backfill.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>v</td>
<td>[string]</td>
<td><strong>Required.</strong> The event IDs to backfill from.</td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td><strong>Required.</strong> The maximum number of PDUs to
retrieve, including the given events.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Transaction</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">server_name</tt> of the
homeserver sending this transaction.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> POSIX timestamp in milliseconds on
originating homeserver when this transaction
started.</td>
</tr>
<tr><td>pdus</td>
<td>[PDU]</td>
<td><strong>Required.</strong> List of persistent updates to rooms.
Note that events have a different format depending
on the room version - check the <a class="reference external" href="../index.html#room-versions">room version
specification</a> for precise event formats.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/backfill/%21SomeRoom%3Amatrix.org?v=%24abc123%3Amatrix.org&amp;limit=2</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A transaction containing the PDUs that preceded the given event(s), including the given
event(s), up to the given limit.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Though the PDU definitions require that <tt class="docutils literal">prev_events</tt> and <tt class="docutils literal">auth_events</tt> be limited
in number, the response of backfill MUST NOT be validated on these specific restrictions.</p>
<p class="last">Due to historical reasons, it is possible that events which were previously accepted
would now be rejected by these limitations. The events should be rejected per usual by
the <tt class="docutils literal">/send</tt>, <tt class="docutils literal">/get_missing_events</tt>, and remaining endpoints.</p>
</div>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1532991320875</span><span class="p">,</span>
  <span class="nt">&quot;pdus&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-federation-v1-get-missing-events-roomid"></a></p>
<div class="section" id="post-matrix-federation-v1-get-missing-events-roomid">
<h2><a class="toc-backref" href="#id50">9.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/federation/v1/get_missing_events/{roomId}</span></tt></a></h2>
<p>Retrieves previous events that the sender is missing. This is done by doing a breadth-first
walk of the <tt class="docutils literal">prev_events</tt> for the <tt class="docutils literal">latest_events</tt>, ignoring any events in <tt class="docutils literal">earliest_events</tt>
and stopping at the <tt class="docutils literal">limit</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID to search in.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to retrieve. Defaults
to 10.</td>
</tr>
<tr><td>min_depth</td>
<td>integer</td>
<td>The minimum depth of events to retrieve. Defaults
to 0.</td>
</tr>
<tr><td>earliest_events</td>
<td>[string]</td>
<td><strong>Required.</strong> The latest event IDs that the sender
already has. These are skipped when retrieving the
previous events of <tt class="docutils literal">latest_events</tt>.</td>
</tr>
<tr><td>latest_events</td>
<td>[string]</td>
<td><strong>Required.</strong> The event IDs to retrieve the
previous events for.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[PDU]</td>
<td><strong>Required.</strong> The missing events. The event format
varies depending on the room version - check the
<a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event
formats.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">POST</span> <span class="nn">/_matrix/federation/v1/get_missing_events/%21SomeRoom%3Amatrix.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="nt">&quot;min_depth&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&quot;earliest_events&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;$missing_event:example.org&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;latest_events&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;$event_that_has_the_missing_event_as_a_previous_event:example.org&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The previous events for <tt class="docutils literal">latest_events</tt>, excluding any <tt class="docutils literal">earliest_events</tt>, up to the
provided <tt class="docutils literal">limit</tt>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;events&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="retrieving-events"></a></p>
<div class="section" id="retrieving-events">
<h1><a class="toc-backref" href="#id51">10&nbsp;&nbsp;&nbsp;Retrieving events</a></h1>
<p>In some circumstances, a homeserver may be missing a particular event or information
about the room which cannot be easily determined from backfilling. These APIs provide
homeservers with the option of getting events and the state of the room at a given
point in the timeline.</p>
<p><a class="anchor" id="get-matrix-federation-v1-state-roomid"></a></p>
<div class="section" id="get-matrix-federation-v1-state-roomid">
<h2><a class="toc-backref" href="#id52">10.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/state/{roomId}</span></tt></a></h2>
<p>Retrieves a snapshot of a room's state at a given event.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID to get state for.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> An event ID in the room to retrieve
the state at.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>auth_chain</td>
<td>[PDU]</td>
<td><strong>Required.</strong> The full set of authorization events
that make up the state of the room, and their
authorization events, recursively. Note that
events have a different format depending on the
room version - check the <a class="reference external" href="../index.html#room-versions">room version
specification</a> for precise event formats.</td>
</tr>
<tr><td>pdus</td>
<td>[PDU]</td>
<td><strong>Required.</strong> The fully resolved state of the room
at the given event. Note that events have a
different format depending on the room version -
check the <a class="reference external" href="../index.html#room-versions">room version specification</a> for
precise event formats.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/state/%21abc123%3Amatrix.org?event_id=%24helloworld%3Amatrix.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The fully resolved state for the room, prior to considering any state
changes induced by the requested event. Includes the authorization
chain for the events.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;auth_chain&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;pdus&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-federation-v1-state-ids-roomid"></a></p>
<div class="section" id="get-matrix-federation-v1-state-ids-roomid">
<h2><a class="toc-backref" href="#id53">10.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/state_ids/{roomId}</span></tt></a></h2>
<p>Retrieves a snapshot of a room's state at a given event, in the form of
event IDs. This performs the same function as calling <tt class="docutils literal"><span class="pre">/state/{roomId}</span></tt>,
however this returns just the event IDs rather than the full events.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID to get state for.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> An event ID in the room to retrieve
the state at.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>auth_chain_ids</td>
<td>[string]</td>
<td><strong>Required.</strong> The full set of authorization events
that make up the state of the room, and their
authorization events, recursively.</td>
</tr>
<tr><td>pdu_ids</td>
<td>[string]</td>
<td><strong>Required.</strong> The fully resolved state of the room
at the given event.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/state_ids/%21abc123%3Amatrix.org?event_id=%24helloworld%3Amatrix.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The fully resolved state for the room, prior to considering any state
changes induced by the requested event. Includes the authorization
chain for the events.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;auth_chain_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;$an_event:example.org&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;pdu_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;$an_event:example.org&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-federation-v1-event-eventid"></a></p>
<div class="section" id="get-matrix-federation-v1-event-eventid">
<h2><a class="toc-backref" href="#id54">10.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/event/{eventId}</span></tt></a></h2>
<p>Retrieves a single event.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID to get.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Transaction</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">server_name</tt> of the
homeserver sending this transaction.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> POSIX timestamp in milliseconds on
originating homeserver when this transaction
started.</td>
</tr>
<tr><td>pdus</td>
<td>[PDU]</td>
<td><strong>Required.</strong> A single PDU. Note that events have
a different format depending on the room version -
check the <a class="reference external" href="../index.html#room-versions">room version specification</a> for
precise event formats.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/event/%24abc123%3Amatrix.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A transaction containing a single PDU which is the event requested.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1532991320875</span><span class="p">,</span>
  <span class="nt">&quot;pdus&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="joining-rooms"></a></p>
<div class="section" id="joining-rooms">
<h1><a class="toc-backref" href="#id55">11&nbsp;&nbsp;&nbsp;Joining Rooms</a></h1>
<p>When a new user wishes to join a room that the user's homeserver already knows
about, the homeserver can immediately determine if this is allowable by
inspecting the state of the room. If it is acceptable, it can generate, sign,
and emit a new <tt class="docutils literal">m.room.member</tt> state event adding the user into that room.
When the homeserver does not yet know about the room it cannot do this
directly. Instead, it must take a longer multi-stage handshaking process by
which it first selects a remote homeserver which is already participating in
that room, and use it to assist in the joining process. This is the remote
join handshake.</p>
<p>This handshake involves the homeserver of the new member wishing to join
(referred to here as the &quot;joining&quot; server), the directory server hosting the
room alias the user is requesting to join with, and a homeserver where existing
room members are already present (referred to as the &quot;resident&quot; server).</p>
<p>In summary, the remote join handshake consists of the joining server querying
the directory server for information about the room alias; receiving a room ID
and a list of join candidates. The joining server then requests information
about the room from one of the residents. It uses this information to construct
a <tt class="docutils literal">m.room.member</tt> event which it finally sends to a resident server.</p>
<p>Conceptually these are three different roles of homeserver. In practice the
directory server is likely to be resident in the room, and so may be selected
by the joining server to be the assisting resident. Likewise, it is likely that
the joining server picks the same candidate resident for both phases of event
construction, though in principle any valid candidate may be used at each time.
Thus, any join handshake can potentially involve anywhere from two to four
homeservers, though most in practice will use just two.</p>
<pre class="literal-block">
Client         Joining                Directory       Resident
               Server                 Server          Server

join request --&gt;
               |
               directory request -------&gt;
               &lt;---------- directory response
               |
               make_join request -----------------------&gt;
               &lt;------------------------------- make_join response
               |
               send_join request -----------------------&gt;
               &lt;------------------------------- send_join response
               |
&lt;---------- join response
</pre>
<p>The first part of the handshake usually involves using the directory server to
request the room ID and join candidates through the <a class="reference external" href="#get-matrix-federation-v1-query-directory"><tt class="docutils literal">/query/directory</tt></a>
API endpoint. In the case of a new user joining a room as a result of a received
invite, the joining user's homeserver could optimise this step away by picking
the origin server of that invite message as the join candidate. However, the
joining server should be aware that the origin server of the invite might since
have left the room, so should be prepared to fall back on the regular join flow
if this optimisation fails.</p>
<p>Once the joining server has the room ID and the join candidates, it then needs
to obtain enough information about the room to fill in the required fields of
the <tt class="docutils literal">m.room.member</tt> event. It obtains this by selecting a resident from the
candidate list, and using the <tt class="docutils literal">GET /make_join</tt> endpoint. The resident server
will then reply with enough information for the joining server to fill in the
event.</p>
<p>The joining server is expected to add or replace the <tt class="docutils literal">origin</tt>, <tt class="docutils literal">origin_server_ts</tt>,
and <tt class="docutils literal">event_id</tt> on the templated event received by the resident server. This
event is then signed by the joining server.</p>
<p>To complete the join handshake, the joining server must now submit this new
event to a resident homeserver, by using the <tt class="docutils literal">PUT /send_join</tt> endpoint.</p>
<p>The resident homeserver then accepts this event into the room's event graph,
and responds to the joining server with the full set of state for the
newly-joined room. The resident server must also send the event to other servers
participating in the room.</p>
<p><a class="anchor" id="get-matrix-federation-v1-make-join-roomid-userid"></a></p>
<div class="section" id="get-matrix-federation-v1-make-join-roomid-userid">
<h2><a class="toc-backref" href="#id56">11.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/make_join/{roomId}/{userId}</span></tt></a></h2>
<p>Asks the receiving server to return information that the sending
server will need to prepare a join event to get into the room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID that is about to be
joined.</td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user ID the join event will be
for.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>ver</td>
<td>[string]</td>
<td>The room versions the sending server has support
for. Defaults to <tt class="docutils literal">[1]</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_version</td>
<td>string</td>
<td>The version of the room where the server is trying
to join. If not provided, the room version is
assumed to be either &quot;1&quot; or &quot;2&quot;.</td>
</tr>
<tr><td>event</td>
<td>Event Template</td>
<td>An unsigned template event. Note that events have
a different format depending on the room version -
check the <a class="reference external" href="../index.html#room-versions">room version specification</a> for
precise event formats.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event Template</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the joining member.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The name of the resident homeserver.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> A timestamp added by the resident
homeserver.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the joining member.</td>
</tr>
<tr><td>content</td>
<td>Membership Event Content</td>
<td><strong>Required.</strong> The content of the event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Membership Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">join</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/make_join/%21abc123%3Amatrix.org/%40someone%3Aexample.org?ver=1&amp;ver=2</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>A template to be used for the rest of the <a class="reference internal" href="#joining-rooms">Joining Rooms</a> handshake. Note that
events have a different format depending on the room version - check the
<a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats. <strong>The response body
here describes the common event fields in more detail and may be missing other
required fields for a PDU.</strong></p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;room_version&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
  <span class="nt">&quot;event&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
    <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;join&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1549041175876</span><span class="p">,</span>
    <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The request is invalid or the room the server is attempting
to join has a version that is not listed in the <tt class="docutils literal">ver</tt>
parameters.</p>
<p>The error should be passed through to clients so that they
may give better feedback to users.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;errcode&quot;</span><span class="p">:</span> <span class="s2">&quot;M_INCOMPATIBLE_ROOM_VERSION&quot;</span><span class="p">,</span>
  <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Your homeserver does not support the features required to join this room&quot;</span><span class="p">,</span>
  <span class="nt">&quot;room_version&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-federation-v1-send-join-roomid-eventid"></a></p>
<div class="section" id="put-matrix-federation-v1-send-join-roomid-eventid">
<h2><a class="toc-backref" href="#id57">11.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v1/send_join/{roomId}/{eventId}</span></tt></a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Servers should instead prefer to use the v2 <tt class="docutils literal">/send_join</tt>
endpoint.</p>
</div>
<p>Submits a signed join event to the resident server for it
to accept it into the room's graph. Note that events have
a different format depending on the room version - check
the <a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats.
<strong>The request and response body here describe the common
event fields in more detail and may be missing other required
fields for a PDU.</strong></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID that is about to be
joined.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID for the join event.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the joining member.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The name of the joining homeserver.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> A timestamp added by the joining
homeserver.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the joining member.</td>
</tr>
<tr><td>content</td>
<td>Membership Event Content</td>
<td><strong>Required.</strong> The content of the event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Membership Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">join</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>[integer, Room State]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Room State</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The resident server's DNS name.</td>
</tr>
<tr><td>auth_chain</td>
<td>[PDU]</td>
<td><p class="first"><strong>Required.</strong> The auth chain for the entire
current room state prior to the join event.</p>
<p class="last">Note that events have a different format depending
on the room version - check the <a class="reference external" href="../index.html#room-versions">room version
specification</a> for precise event formats.</p>
</td>
</tr>
<tr><td>state</td>
<td>[PDU]</td>
<td><p class="first"><strong>Required.</strong> The resolved current room state
prior to the join event.</p>
<p class="last">The event format varies depending on the room
version - check the <a class="reference external" href="../index.html#room-versions">room version specification</a>
for precise event formats.</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">PUT</span> <span class="nn">/_matrix/federation/v1/send_join/%21abc123%3Amatrix.org/%24abc123%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;matrix.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
  <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;join&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The full state for the room, having accepted the join event.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">[</span>
  <span class="mi">200</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;matrix.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;auth_chain&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
        <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
        <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;state&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
        <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
        <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-federation-v2-send-join-roomid-eventid"></a></p>
<div class="section" id="put-matrix-federation-v2-send-join-roomid-eventid">
<h2><a class="toc-backref" href="#id58">11.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v2/send_join/{roomId}/{eventId}</span></tt></a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This API is nearly identical to the v1 API with the
exception of the response format being fixed.</p>
</div>
<p>This endpoint is preferred over the v1 API as it provides
a more standarised response format. Senders which receive
a 400, 404, or other status code which indicates this endpoint
is not available should retry using the v1 API instead.</p>
<p>Submits a signed join event to the resident server for it
to accept it into the room's graph. Note that events have
a different format depending on the room version - check
the <a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats.
<strong>The request and response body here describe the common
event fields in more detail and may be missing other required
fields for a PDU.</strong></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID that is about to be
joined.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID for the join event.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the joining member.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The name of the joining homeserver.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> A timestamp added by the joining
homeserver.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the joining member.</td>
</tr>
<tr><td>content</td>
<td>Membership Event Content</td>
<td><strong>Required.</strong> The content of the event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Membership Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">join</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Room State</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The resident server's DNS name.</td>
</tr>
<tr><td>auth_chain</td>
<td>[PDU]</td>
<td><p class="first"><strong>Required.</strong> The auth chain for the entire
current room state prior to the join event.</p>
<p class="last">Note that events have a different format depending
on the room version - check the <a class="reference external" href="../index.html#room-versions">room version
specification</a> for precise event formats.</p>
</td>
</tr>
<tr><td>state</td>
<td>[PDU]</td>
<td><p class="first"><strong>Required.</strong> The resolved current room state
prior to the join event.</p>
<p class="last">The event format varies depending on the room
version - check the <a class="reference external" href="../index.html#room-versions">room version specification</a>
for precise event formats.</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">PUT</span> <span class="nn">/_matrix/federation/v2/send_join/%21abc123%3Amatrix.org/%24abc123%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;matrix.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
  <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;join&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The full state for the room, having accepted the join event.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;matrix.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;auth_chain&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;state&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.minimal_pdu&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;see_room_version_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;The event format changes depending on the room version.&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
<!-- TODO-spec
- (paul) I don't really understand why the full auth_chain events are given
  here. What purpose does it serve expanding them out in full, when surely
  they'll appear in the state anyway? -->
</div>
</div>
<p><a class="anchor" id="inviting-to-a-room"></a></p>
<div class="section" id="inviting-to-a-room">
<h1><a class="toc-backref" href="#id59">12&nbsp;&nbsp;&nbsp;Inviting to a room</a></h1>
<p>When a user on a given homeserver invites another user on the same homeserver,
the homeserver may sign the membership event itself and skip the process defined
here. However, when a user invites another user on a different homeserver, a request
to that homeserver to have the event signed and verified must be made.</p>
<p><a class="anchor" id="put-matrix-federation-v1-invite-roomid-eventid"></a></p>
<div class="section" id="put-matrix-federation-v1-invite-roomid-eventid">
<h2><a class="toc-backref" href="#id60">12.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v1/invite/{roomId}/{eventId}</span></tt></a></h2>
<p>Invites a remote user to a room. Once the event has been  signed by both the inviting
homeserver and the invited homeserver, it can be sent to all of the servers in the
room by the inviting homeserver.</p>
<p>Servers should prefer to use the v2 API for invites instead of the v1 API. Servers
which receive a v1 invite request must assume that the room version is either <tt class="docutils literal">&quot;1&quot;</tt>
or <tt class="docutils literal">&quot;2&quot;</tt>.</p>
<p>Note that events have a different format depending on the room version - check the
<a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats. <strong>The request and response
bodies here describe the common event fields in more detail and may be missing other
required fields for a PDU.</strong></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID that the user is being
invited to.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID for the invite event,
generated by the inviting server.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The matrix ID of the user who sent
the original <tt class="docutils literal">m.room.third_party_invite</tt>.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The name of the inviting homeserver.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> A timestamp added by the inviting
homeserver.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the invited member.</td>
</tr>
<tr><td>content</td>
<td>Membership Event Content</td>
<td><strong>Required.</strong> The content of the event, matching
what is available in the <a class="reference external" href="../client_server/r0.6.1.html">Client-Server API</a>.
Must include a <tt class="docutils literal">membership</tt> of <tt class="docutils literal">invite</tt>.</td>
</tr>
<tr><td>unsigned</td>
<td>Unsigned Event Content</td>
<td>Information included alongside the event that is
not signed. May include more than what is listed
here.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Membership Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">invite</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Unsigned Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>invite_room_state</td>
<td>[StrippedState]</td>
<td>An optional list of simplified events to help the
receiver of the invite identify the room. The
recommended events to include are the join rules,
canonical alias, avatar, and name of the room.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StrippedState</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>EventContent</td>
<td><strong>Required.</strong> The <tt class="docutils literal">content</tt> for the event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">state_key</tt> for the event.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">type</tt> for the event.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">sender</tt> for the event.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>[integer, Event Container]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event Container</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event</td>
<td>Invite Event</td>
<td><strong>Required.</strong> An invite event. Note that events
have a different format depending on the room
version - check the <a class="reference external" href="../index.html#room-versions">room version specification</a>
for precise event formats.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Invite Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The matrix ID of the user who sent
the original <tt class="docutils literal">m.room.third_party_invite</tt>.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The name of the inviting homeserver.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> A timestamp added by the inviting
homeserver.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the invited member.</td>
</tr>
<tr><td>content</td>
<td>Membership Event Content</td>
<td><strong>Required.</strong> The content of the event, matching
what is available in the <a class="reference external" href="../client_server/r0.6.1.html">Client-Server API</a>.
Must include a <tt class="docutils literal">membership</tt> of <tt class="docutils literal">invite</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Membership Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">invite</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">PUT</span> <span class="nn">/_matrix/federation/v1/invite/%21abc123%3Amatrix.org/%24abc123%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;matrix.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
  <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;joe:elsewhere.com&quot;</span><span class="p">,</span>
  <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;invite&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;unsigned&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;invite_room_state&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.name&quot;</span><span class="p">,</span>
        <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;bob:example.org&quot;</span><span class="p">,</span>
        <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Example Room&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.join_rules&quot;</span><span class="p">,</span>
        <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;bob:example.org&quot;</span><span class="p">,</span>
        <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;join_rule&quot;</span><span class="p">:</span> <span class="s2">&quot;invite&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The event with the invited server's signature added. All other fields of the events
should remain untouched. Note that events have a different format depending on the
room version - check the <a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">[</span>
  <span class="mi">200</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nt">&quot;event&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;invite&quot;</span>
      <span class="p">},</span>
      <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1549041175876</span><span class="p">,</span>
      <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;unsigned&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;invite_room_state&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.name&quot;</span><span class="p">,</span>
            <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;bob:example.org&quot;</span><span class="p">,</span>
            <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Example Room&quot;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.join_rules&quot;</span><span class="p">,</span>
            <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;bob:example.org&quot;</span><span class="p">,</span>
            <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;join_rule&quot;</span><span class="p">:</span> <span class="s2">&quot;invite&quot;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">},</span>
      <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;example.com&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;ed25519:key_version&quot;</span><span class="p">:</span> <span class="s2">&quot;SomeSignatureHere&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;elsewhere.com&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;ed25519:k3y_versi0n&quot;</span><span class="p">:</span> <span class="s2">&quot;SomeOtherSignatureHere&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The invite is not allowed. This could be for a number of reasons, including:</p>
<ul class="simple">
<li>The sender is not allowed to send invites to the target user/homeserver.</li>
<li>The homeserver does not permit anyone to invite its users.</li>
<li>The homeserver refuses to participate in the room.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;errcode&quot;</span><span class="p">:</span> <span class="s2">&quot;M_FORBIDDEN&quot;</span><span class="p">,</span>
  <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User cannot invite the target user.&quot;</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-federation-v2-invite-roomid-eventid"></a></p>
<div class="section" id="put-matrix-federation-v2-invite-roomid-eventid">
<h2><a class="toc-backref" href="#id61">12.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v2/invite/{roomId}/{eventId}</span></tt></a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This API is nearly identical to the v1 API with the exception of the request
body being different, and the response format fixed.</p>
</div>
<p>Invites a remote user to a room. Once the event has been  signed by both the inviting
homeserver and the invited homeserver, it can be sent to all of the servers in the
room by the inviting homeserver.</p>
<p>This endpoint is preferred over the v1 API as it is more useful for servers. Senders
which receive a 400 or 404 response to this endpoint should retry using the v1
API as the server may be older, if the room version is &quot;1&quot; or &quot;2&quot;.</p>
<p>Note that events have a different format depending on the room version - check the
<a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats. <strong>The request and response
bodies here describe the common event fields in more detail and may be missing other
required fields for a PDU.</strong></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID that the user is being
invited to.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID for the invite event,
generated by the inviting server.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>room_version</td>
<td>string</td>
<td><strong>Required.</strong> The version of the room where the
user is being invited to.</td>
</tr>
<tr><td>event</td>
<td>Invite Event</td>
<td><strong>Required.</strong> An invite event. Note that events
have a different format depending on the room
version - check the <a class="reference external" href="../index.html#room-versions">room version specification</a>
for precise event formats.</td>
</tr>
<tr><td>invite_room_state</td>
<td>[StrippedState]</td>
<td>An optional list of simplified events to help the
receiver of the invite identify the room. The
recommended events to include are the join rules,
canonical alias, avatar, and name of the room.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Invite Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The matrix ID of the user who sent
the original <tt class="docutils literal">m.room.third_party_invite</tt>.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The name of the inviting homeserver.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> A timestamp added by the inviting
homeserver.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the invited member.</td>
</tr>
<tr><td>content</td>
<td>Membership Event Content</td>
<td><strong>Required.</strong> The content of the event, matching
what is available in the <a class="reference external" href="../client_server/r0.6.1.html">Client-Server API</a>.
Must include a <tt class="docutils literal">membership</tt> of <tt class="docutils literal">invite</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Membership Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">invite</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StrippedState</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>EventContent</td>
<td><strong>Required.</strong> The <tt class="docutils literal">content</tt> for the event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">state_key</tt> for the event.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">type</tt> for the event.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">sender</tt> for the event.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Event Container</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event</td>
<td>Invite Event</td>
<td><strong>Required.</strong> An invite event. Note that events
have a different format depending on the room
version - check the <a class="reference external" href="../index.html#room-versions">room version specification</a>
for precise event formats.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Invite Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The matrix ID of the user who sent
the original <tt class="docutils literal">m.room.third_party_invite</tt>.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The name of the inviting homeserver.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> A timestamp added by the inviting
homeserver.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the invited member.</td>
</tr>
<tr><td>content</td>
<td>Membership Event Content</td>
<td><strong>Required.</strong> The content of the event, matching
what is available in the <a class="reference external" href="../client_server/r0.6.1.html">Client-Server API</a>.
Must include a <tt class="docutils literal">membership</tt> of <tt class="docutils literal">invite</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Membership Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">invite</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">PUT</span> <span class="nn">/_matrix/federation/v2/invite/%21abc123%3Amatrix.org/%24abc123%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;room_version&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
  <span class="nt">&quot;event&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;matrix.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
    <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;joe:elsewhere.com&quot;</span><span class="p">,</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;invite&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&quot;invite_room_state&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.name&quot;</span><span class="p">,</span>
      <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;bob:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Example Room&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.join_rules&quot;</span><span class="p">,</span>
      <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;bob:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;join_rule&quot;</span><span class="p">:</span> <span class="s2">&quot;invite&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The event with the invited server's signature added. All other fields of the events
should remain untouched. Note that events have a different format depending on the
room version - check the <a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;event&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
    <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;invite&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1549041175876</span><span class="p">,</span>
    <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;unsigned&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;invite_room_state&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.name&quot;</span><span class="p">,</span>
          <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;bob:example.org&quot;</span><span class="p">,</span>
          <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
          <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Example Room&quot;</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.join_rules&quot;</span><span class="p">,</span>
          <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;bob:example.org&quot;</span><span class="p">,</span>
          <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
          <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;join_rule&quot;</span><span class="p">:</span> <span class="s2">&quot;invite&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;example.com&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;ed25519:key_version&quot;</span><span class="p">:</span> <span class="s2">&quot;SomeSignatureHere&quot;</span>
      <span class="p">},</span>
      <span class="nt">&quot;elsewhere.com&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;ed25519:k3y_versi0n&quot;</span><span class="p">:</span> <span class="s2">&quot;SomeOtherSignatureHere&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The request is invalid or the room the server is attempting
to join has a version that is not listed in the <tt class="docutils literal">ver</tt>
parameters.</p>
<p>The error should be passed through to clients so that they
may give better feedback to users.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;errcode&quot;</span><span class="p">:</span> <span class="s2">&quot;M_INCOMPATIBLE_ROOM_VERSION&quot;</span><span class="p">,</span>
  <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Your homeserver does not support the features required to join this room&quot;</span><span class="p">,</span>
  <span class="nt">&quot;room_version&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span>
<span class="p">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The invite is not allowed. This could be for a number of reasons, including:</p>
<ul class="simple">
<li>The sender is not allowed to send invites to the target user/homeserver.</li>
<li>The homeserver does not permit anyone to invite its users.</li>
<li>The homeserver refuses to participate in the room.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;errcode&quot;</span><span class="p">:</span> <span class="s2">&quot;M_FORBIDDEN&quot;</span><span class="p">,</span>
  <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User cannot invite the target user.&quot;</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="leaving-rooms-rejecting-invites"></a></p>
<div class="section" id="leaving-rooms-rejecting-invites">
<h1><a class="toc-backref" href="#id62">13&nbsp;&nbsp;&nbsp;Leaving Rooms (Rejecting Invites)</a></h1>
<p>Normally homeservers can send appropriate <tt class="docutils literal">m.room.member</tt> events to have users
leave the room, or to reject local invites. Remote invites from other homeservers
do not involve the server in the graph and therefore need another approach to
reject the invite. Joining the room and promptly leaving is not recommended as
clients and servers will interpret that as accepting the invite, then leaving the
room rather than rejecting the invite.</p>
<p>Similar to the <a class="reference internal" href="#joining-rooms">Joining Rooms</a> handshake, the server which wishes to leave the
room starts with sending a <tt class="docutils literal">/make_leave</tt> request to a resident server. In the
case of rejecting invites, the resident server may be the server which sent the
invite. After receiving a template event from <tt class="docutils literal">/make_leave</tt>, the leaving server
signs the event and replaces the <tt class="docutils literal">event_id</tt> with it's own. This is then sent to
the resident server via <tt class="docutils literal">/send_leave</tt>. The resident server will then send the
event to other servers in the room.</p>
<p><a class="anchor" id="get-matrix-federation-v1-make-leave-roomid-userid"></a></p>
<div class="section" id="get-matrix-federation-v1-make-leave-roomid-userid">
<h2><a class="toc-backref" href="#id63">13.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/make_leave/{roomId}/{userId}</span></tt></a></h2>
<p>Asks the receiving server to return information that the sending
server will need to prepare a leave event to get out of the room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID that is about to be
left.</td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user ID the leave event will be
for.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_version</td>
<td>string</td>
<td>The version of the room where the server is trying
to leave. If not provided, the room version is
assumed to be either &quot;1&quot; or &quot;2&quot;.</td>
</tr>
<tr><td>event</td>
<td>Event Template</td>
<td>An unsigned template event. Note that events have
a different format depending on the room version -
check the <a class="reference external" href="../index.html#room-versions">room version specification</a> for
precise event formats.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event Template</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the leaving member.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The name of the resident homeserver.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> A timestamp added by the resident
homeserver.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the leaving member.</td>
</tr>
<tr><td>content</td>
<td>Membership Event Content</td>
<td><strong>Required.</strong> The content of the event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Membership Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">leave</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/make_leave/%21abc123%3Amatrix.org/%40someone%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>A template to be used to call <tt class="docutils literal">/send_leave</tt>. Note that
events have a different format depending on the room version - check the
<a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats. <strong>The response body
here describes the common event fields in more detail and may be missing other
required fields for a PDU.</strong></p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;room_version&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
  <span class="nt">&quot;event&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
    <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;leave&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
    <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1549041175876</span><span class="p">,</span>
    <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The request is not authorized. This could mean that the user is not in the room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;errcode&quot;</span><span class="p">:</span> <span class="s2">&quot;M_FORBIDDEN&quot;</span><span class="p">,</span>
  <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User is not in the room.&quot;</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-federation-v1-send-leave-roomid-eventid"></a></p>
<div class="section" id="put-matrix-federation-v1-send-leave-roomid-eventid">
<h2><a class="toc-backref" href="#id64">13.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v1/send_leave/{roomId}/{eventId}</span></tt></a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Servers should instead prefer to use the v2 <tt class="docutils literal">/send_leave</tt>
endpoint.</p>
</div>
<p>Submits a signed leave event to the resident server for it
to accept it into the room's graph. Note that events have
a different format depending on the room version - check
the <a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats.
<strong>The request and response body here describe the common
event fields in more detail and may be missing other required
fields for a PDU.</strong></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID that is about to be
left.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID for the leave event.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the leaving member.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The name of the leaving homeserver.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> A timestamp added by the leaving
homeserver.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the leaving member.</td>
</tr>
<tr><td>content</td>
<td>Membership Event Content</td>
<td><strong>Required.</strong> The content of the event.</td>
</tr>
<tr><td>depth</td>
<td>integer</td>
<td><strong>Required.</strong> This field must be present but is
ignored; it may be 0.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Membership Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">leave</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>[integer, Empty Object]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">PUT</span> <span class="nn">/_matrix/federation/v1/send_leave/%21abc123%3Amatrix.org/%24abc123%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;matrix.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
  <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;leave&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;depth&quot;</span><span class="p">:</span> <span class="mi">12</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>An empty response to indicate the event was accepted into the graph by
the receiving homeserver.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">[</span>
  <span class="mi">200</span><span class="p">,</span>
  <span class="p">{}</span>
<span class="p">]</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-federation-v2-send-leave-roomid-eventid"></a></p>
<div class="section" id="put-matrix-federation-v2-send-leave-roomid-eventid">
<h2><a class="toc-backref" href="#id65">13.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v2/send_leave/{roomId}/{eventId}</span></tt></a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This API is nearly identical to the v1 API with the
exception of the response format being fixed.</p>
</div>
<p>This endpoint is preferred over the v1 API as it provides
a more standarised response format. Senders which receive
a 400, 404, or other status code which indicates this endpoint
is not available should retry using the v1 API instead.</p>
<p>Submits a signed leave event to the resident server for it
to accept it into the room's graph. Note that events have
a different format depending on the room version - check
the <a class="reference external" href="../index.html#room-versions">room version specification</a> for precise event formats.
<strong>The request and response body here describe the common
event fields in more detail and may be missing other required
fields for a PDU.</strong></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID that is about to be
left.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID for the leave event.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the leaving member.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The name of the leaving homeserver.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> A timestamp added by the leaving
homeserver.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the leaving member.</td>
</tr>
<tr><td>content</td>
<td>Membership Event Content</td>
<td><strong>Required.</strong> The content of the event.</td>
</tr>
<tr><td>depth</td>
<td>integer</td>
<td><strong>Required.</strong> This field must be present but is
ignored; it may be 0.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Membership Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The value <tt class="docutils literal">leave</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">PUT</span> <span class="nn">/_matrix/federation/v2/send_leave/%21abc123%3Amatrix.org/%24abc123%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;matrix.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;origin_server_ts&quot;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
  <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;leave&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;depth&quot;</span><span class="p">:</span> <span class="mi">12</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>An empty response to indicate the event was accepted into the graph by
the receiving homeserver.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="third-party-invites"></a></p>
<div class="section" id="third-party-invites">
<h1><a class="toc-backref" href="#id66">14&nbsp;&nbsp;&nbsp;Third-party invites</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">More information about third party invites is available in the <a class="reference external" href="../client_server/r0.6.1.html">Client-Server API</a>
under the Third Party Invites module.</p>
</div>
<p>When an user wants to invite another user in a room but doesn't know the Matrix
ID to invite, they can do so using a third-party identifier (e.g. an e-mail or a
phone number).</p>
<p>This identifier and its bindings to Matrix IDs are verified by an identity server
implementing the <a class="reference external" href="../identity_service/r0.3.0.html">Identity Service API</a>.</p>
<p><a class="anchor" id="cases-where-an-association-exists-for-a-third-party-identifier"></a></p>
<div class="section" id="cases-where-an-association-exists-for-a-third-party-identifier">
<h2><a class="toc-backref" href="#id67">14.1&nbsp;&nbsp;&nbsp;Cases where an association exists for a third-party identifier</a></h2>
<p>If the third-party identifier is already bound to a Matrix ID, a lookup request
on the identity server will return it. The invite is then processed by the inviting
homeserver as a standard <tt class="docutils literal">m.room.member</tt> invite event. This is the simplest case.</p>
</div>
<p><a class="anchor" id="cases-where-an-association-doesn-t-exist-for-a-third-party-identifier"></a></p>
<div class="section" id="cases-where-an-association-doesn-t-exist-for-a-third-party-identifier">
<h2><a class="toc-backref" href="#id68">14.2&nbsp;&nbsp;&nbsp;Cases where an association doesn't exist for a third-party identifier</a></h2>
<p>If the third-party identifier isn't bound to any Matrix ID, the inviting
homeserver will request the identity server to store an invite for this identifier
and to deliver it to whoever binds it to its Matrix ID. It will also send a
<tt class="docutils literal">m.room.third_party_invite</tt> event in the room to specify a display name, a token
and public keys the identity server provided as a response to the invite storage
request.</p>
<p>When a third-party identifier with pending invites gets bound to a Matrix ID,
the identity server will send a POST request to the ID's homeserver as described
in the <a class="reference external" href="../identity_service/r0.3.0.html#invitation-storage">Invitation Storage</a> section of the Identity Service API.</p>
<p>The following process applies for each invite sent by the identity server:</p>
<p>The invited homeserver will create a <tt class="docutils literal">m.room.member</tt> invite event containing
a special <tt class="docutils literal">third_party_invite</tt> section containing the token and a signed object,
both provided by the identity server.</p>
<p>If the invited homeserver is in the room the invite came from, it can auth the
event and send it.</p>
<p>However, if the invited homeserver isn't in the room the invite came from, it
will need to request the room's homeserver to auth the event.</p>
<p><a class="anchor" id="put-matrix-federation-v1-exchange-third-party-invite-roomid"></a></p>
<div class="section" id="put-matrix-federation-v1-exchange-third-party-invite-roomid">
<h3><a class="toc-backref" href="#id69">14.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/federation/v1/exchange_third_party_invite/{roomId}</span></tt></a></h3>
<p>The receiving server will verify the partial <tt class="docutils literal">m.room.member</tt> event
given in the request body. If valid, the receiving server will issue
an invite as per the <a class="reference external" href="#inviting-to-a-room">Inviting to a room</a> section before returning a
response to this request.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID to exchange a third
party invite in</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The event type. Must be
<tt class="docutils literal">m.room.member</tt></td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The room ID the event is for. Must
match the ID given in the path.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the user who sent the
original <tt class="docutils literal">m.room.third_party_invite</tt> event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The user ID of the invited user</td>
</tr>
<tr><td>content</td>
<td>Event Content</td>
<td><strong>Required.</strong> The event content</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event Content</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>string</td>
<td><strong>Required.</strong> The membership state. Must be
<tt class="docutils literal">invite</tt></td>
</tr>
<tr><td>third_party_invite</td>
<td>Third Party Invite</td>
<td><strong>Required.</strong> The third party invite</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Third Party Invite</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>display_name</td>
<td>string</td>
<td><strong>Required.</strong> A name which can be displayed to
represent the user instead of their third party
identifier.</td>
</tr>
<tr><td>signed</td>
<td>Invite Signatures</td>
<td><strong>Required.</strong> A block of content which has been
signed, which servers can use to verify the event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Invite Signatures</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>signatures</td>
<td>Signatures</td>
<td><p class="first"><strong>Required.</strong> The server signatures for this
event.</p>
<p class="last">The signature is calculated using the process
described at <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The invited matrix user ID</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token used to verify the event</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">PUT</span> <span class="nn">/_matrix/federation/v1/exchange_third_party_invite/%21abc123%3Amatrix.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room.member&quot;</span><span class="p">,</span>
  <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!abc123:matrix.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;joe:matrix.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;state_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;someone:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;membership&quot;</span><span class="p">:</span> <span class="s2">&quot;invite&quot;</span><span class="p">,</span>
    <span class="nt">&quot;third_party_invite&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
      <span class="nt">&quot;signed&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;mxid&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;alice:localhost&quot;</span><span class="p">,</span>
        <span class="nt">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;abc123&quot;</span><span class="p">,</span>
        <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;magic.forest&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;ed25519:3&quot;</span><span class="p">:</span> <span class="s2">&quot;fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The invite has been issued successfully.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-federation-v1-3pid-onbind"></a></p>
<div class="section" id="put-matrix-federation-v1-3pid-onbind">
<h3><a class="toc-backref" href="#id70">14.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT /_matrix/federation/v1/3pid/onbind</tt></a></h3>
<p>Used by identity servers to notify the homeserver that one of its users
has bound a third party identifier successfully, including any pending
room invites the identity server has been made aware of.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The type of third party identifier.
Currently only &quot;email&quot; is a possible value.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The third party identifier itself.
For example, an email address.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The user that is now bound to the
third party identifier.</td>
</tr>
<tr><td>invites</td>
<td>[Third Party Invite]</td>
<td><strong>Required.</strong> A list of pending invites that the
third party identifier has received.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Third Party Invite</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The type of third party invite
issues. Currently only &quot;email&quot; is used.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The third party identifier that
received the invite.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The now-bound user ID that received
the invite.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The room ID the invite is valid for.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The user ID that sent the invite.</td>
</tr>
<tr><td>signed</td>
<td>Identity Server Signatures</td>
<td><strong>Required.</strong> Signature from the identity server
using a long-term private key.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Identity Server Signatures</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The user ID that has been bound to
the third party identifier.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> A token.</td>
</tr>
<tr><td>signatures</td>
<td>Identity Server Signature</td>
<td><strong>Required.</strong> The signature from the identity
server. The <tt class="docutils literal">string</tt> key is the identity
server's domain name, such as vector.im</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Identity Server Domain Signature</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>ed25519:0</td>
<td>string</td>
<td><strong>Required.</strong> The signature.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">PUT</span> <span class="nn">/_matrix/federation/v1/3pid/onbind</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;medium&quot;</span><span class="p">:</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span>
  <span class="nt">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&#64;example.com&quot;</span><span class="p">,</span>
  <span class="nt">&quot;mxid&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;alice:matrix.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;invites&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;medium&quot;</span><span class="p">:</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span>
      <span class="nt">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&#64;example.com&quot;</span><span class="p">,</span>
      <span class="nt">&quot;mxid&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;alice:matrix.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:example.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;bob:matrix.org&quot;</span><span class="p">,</span>
      <span class="nt">&quot;signed&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;mxid&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;alice:matrix.org&quot;</span><span class="p">,</span>
        <span class="nt">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span><span class="p">,</span>
        <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;vector.im&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;ed25519:0&quot;</span><span class="p">:</span> <span class="s2">&quot;SomeSignatureGoesHere&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The homeserver has processed the notification.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{}</span>
</pre>
</div>
<p><a class="anchor" id="verifying-the-invite"></a></p>
<div class="section" id="verifying-the-invite">
<h3><a class="toc-backref" href="#id71">14.2.3&nbsp;&nbsp;&nbsp;Verifying the invite</a></h3>
<p>When a homeserver receives a <tt class="docutils literal">m.room.member</tt> invite event for a room it's in
with a <tt class="docutils literal">third_party_invite</tt> object, it must verify that the association between
the third-party identifier initially invited to the room and the Matrix ID that
claims to be bound to it has been verified without having to rely on a third-party
server.</p>
<p>To do so, it will fetch from the room's state events the <tt class="docutils literal">m.room.third_party_invite</tt>
event for which the state key matches with the value for the <tt class="docutils literal">token</tt> key in the
<tt class="docutils literal">third_party_invite</tt> object from the <tt class="docutils literal">m.room.member</tt> event's content to fetch the
public keys initially delivered by the identity server that stored the invite.</p>
<p>It will then use these keys to verify that the <tt class="docutils literal">signed</tt> object (in the
<tt class="docutils literal">third_party_invite</tt> object from the <tt class="docutils literal">m.room.member</tt> event's content) was
signed by the same identity server.</p>
<p>Since this <tt class="docutils literal">signed</tt> object can only be delivered once in the POST request
emitted by the identity server upon binding between the third-party identifier
and the Matrix ID, and contains the invited user's Matrix ID and the token
delivered when the invite was stored, this verification will prove that the
<tt class="docutils literal">m.room.member</tt> invite event comes from the user owning the invited third-party
identifier.</p>
</div>
</div>
</div>
<p><a class="anchor" id="public-room-directory"></a></p>
<div class="section" id="public-room-directory">
<h1><a class="toc-backref" href="#id72">15&nbsp;&nbsp;&nbsp;Public Room Directory</a></h1>
<p>To complement the <a class="reference external" href="../client_server/r0.6.1.html">Client-Server API</a>'s room directory, homeservers need a
way to query the public rooms for another server. This can be done by making
a request to the <tt class="docutils literal">/publicRooms</tt> endpoint for the server the room directory
should be retrieved for.</p>
<p><a class="anchor" id="get-matrix-federation-v1-publicrooms"></a></p>
<div class="section" id="get-matrix-federation-v1-publicrooms">
<h2><a class="toc-backref" href="#id73">15.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/publicRooms</tt></a></h2>
<p>Gets all the public rooms for the homeserver. This should not return
rooms that are listed on another homeserver's directory, just those
listed on the receiving homeserver's directory.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of rooms to return. Defaults to
0 (no limit).</td>
</tr>
<tr><td>since</td>
<td>string</td>
<td>A pagination token from a previous call to this
endpoint to fetch more rooms.</td>
</tr>
<tr><td>include_all_networks</td>
<td>boolean</td>
<td>Whether or not to include all networks/protocols
defined by application services on the homeserver.
Defaults to false.</td>
</tr>
<tr><td>third_party_instance_id</td>
<td>string</td>
<td>The specific third party network/protocol to
request from the homeserver. Can only be used if
<tt class="docutils literal">include_all_networks</tt> is false.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[PublicRoomsChunk]</td>
<td><strong>Required.</strong> A paginated chunk of public rooms.</td>
</tr>
<tr><td>next_batch</td>
<td>string</td>
<td>A pagination token for the response. The absence
of this token means there are no more results to
fetch and the client should stop paginating.</td>
</tr>
<tr><td>prev_batch</td>
<td>string</td>
<td>A pagination token that allows fetching previous
results. The absence of this token means there are
no results before this batch, i.e. this is the
first batch.</td>
</tr>
<tr><td>total_room_count_estimate</td>
<td>integer</td>
<td>An estimate on the total number of public rooms,
if the server has an estimate.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PublicRoomsChunk</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>aliases</td>
<td>[string]</td>
<td>Aliases of the room. May be empty.</td>
</tr>
<tr><td>canonical_alias</td>
<td>string</td>
<td>The canonical alias of the room, if any.</td>
</tr>
<tr><td>name</td>
<td>string</td>
<td>The name of the room, if any.</td>
</tr>
<tr><td>num_joined_members</td>
<td>integer</td>
<td><strong>Required.</strong> The number of members joined to the
room.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room.</td>
</tr>
<tr><td>topic</td>
<td>string</td>
<td>The topic of the room, if any.</td>
</tr>
<tr><td>world_readable</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the room may be viewed by
guest users without joining.</td>
</tr>
<tr><td>guest_can_join</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether guest users may join the
room and participate in it. If they can, they will
be subject to ordinary power level rules like any
other user.</td>
</tr>
<tr><td>avatar_url</td>
<td>string</td>
<td>The URL for the room's avatar, if one is set.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/publicRooms?limit=10&amp;since=GetMoreRoomsTokenHere&amp;include_all_networks=False&amp;third_party_instance_id=irc</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The public room list for the homeserver.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;chunk&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;aliases&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;#murrays:cheese.bar&quot;</span>
      <span class="p">],</span>
      <span class="nt">&quot;avatar_url&quot;</span><span class="p">:</span> <span class="s2">&quot;mxc://bleeker.street/CHEDDARandBRIE&quot;</span><span class="p">,</span>
      <span class="nt">&quot;guest_can_join&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;CHEESE&quot;</span><span class="p">,</span>
      <span class="nt">&quot;num_joined_members&quot;</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!ol19s:bleecker.street&quot;</span><span class="p">,</span>
      <span class="nt">&quot;topic&quot;</span><span class="p">:</span> <span class="s2">&quot;Tasty tasty cheese&quot;</span><span class="p">,</span>
      <span class="nt">&quot;world_readable&quot;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;next_batch&quot;</span><span class="p">:</span> <span class="s2">&quot;p190q&quot;</span><span class="p">,</span>
  <span class="nt">&quot;prev_batch&quot;</span><span class="p">:</span> <span class="s2">&quot;p1902&quot;</span><span class="p">,</span>
  <span class="nt">&quot;total_room_count_estimate&quot;</span><span class="p">:</span> <span class="mi">115</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-federation-v1-publicrooms"></a></p>
<div class="section" id="post-matrix-federation-v1-publicrooms">
<h2><a class="toc-backref" href="#id74">15.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/federation/v1/publicRooms</tt></a></h2>
<p>Lists the public rooms on the server, with optional filter.</p>
<p>This API returns paginated responses. The rooms are ordered by the number
of joined members, with the largest rooms first.</p>
<p>Note that this endpoint receives and returns the same format that is seen
in the Client-Server API's <tt class="docutils literal">POST /publicRooms</tt> endpoint.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>Limit the number of results returned.</td>
</tr>
<tr><td>since</td>
<td>string</td>
<td>A pagination token from a previous request,
allowing servers to get the next (or previous)
batch of rooms.  The direction of pagination is
specified solely by which token is supplied,
rather than via an explicit flag.</td>
</tr>
<tr><td>filter</td>
<td>Filter</td>
<td>Filter to apply to the results.</td>
</tr>
<tr><td>include_all_networks</td>
<td>boolean</td>
<td>Whether or not to include all known
networks/protocols from application services on
the homeserver. Defaults to false.</td>
</tr>
<tr><td>third_party_instance_id</td>
<td>string</td>
<td>The specific third party network/protocol to
request from the homeserver. Can only be used if
<tt class="docutils literal">include_all_networks</tt> is false.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Filter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>generic_search_term</td>
<td>string</td>
<td>A string to search for in the room metadata, e.g.
name, topic, canonical alias etc. (Optional).</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[PublicRoomsChunk]</td>
<td><strong>Required.</strong> A paginated chunk of public rooms.</td>
</tr>
<tr><td>next_batch</td>
<td>string</td>
<td>A pagination token for the response. The absence
of this token means there are no more results to
fetch and the client should stop paginating.</td>
</tr>
<tr><td>prev_batch</td>
<td>string</td>
<td>A pagination token that allows fetching previous
results. The absence of this token means there are
no results before this batch, i.e. this is the
first batch.</td>
</tr>
<tr><td>total_room_count_estimate</td>
<td>integer</td>
<td>An estimate on the total number of public rooms,
if the server has an estimate.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PublicRoomsChunk</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>aliases</td>
<td>[string]</td>
<td>Aliases of the room. May be empty.</td>
</tr>
<tr><td>canonical_alias</td>
<td>string</td>
<td>The canonical alias of the room, if any.</td>
</tr>
<tr><td>name</td>
<td>string</td>
<td>The name of the room, if any.</td>
</tr>
<tr><td>num_joined_members</td>
<td>integer</td>
<td><strong>Required.</strong> The number of members joined to the
room.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room.</td>
</tr>
<tr><td>topic</td>
<td>string</td>
<td>The topic of the room, if any.</td>
</tr>
<tr><td>world_readable</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the room may be viewed by
guest users without joining.</td>
</tr>
<tr><td>guest_can_join</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether guest users may join the
room and participate in it. If they can, they will
be subject to ordinary power level rules like any
other user.</td>
</tr>
<tr><td>avatar_url</td>
<td>string</td>
<td>The URL for the room's avatar, if one is set.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">POST</span> <span class="nn">/_matrix/federation/v1/publicRooms</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="nt">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;generic_search_term&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;include_all_networks&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&quot;third_party_instance_id&quot;</span><span class="p">:</span> <span class="s2">&quot;irc&quot;</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of the rooms on the server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;chunk&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;aliases&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;#murrays:cheese.bar&quot;</span>
      <span class="p">],</span>
      <span class="nt">&quot;avatar_url&quot;</span><span class="p">:</span> <span class="s2">&quot;mxc://bleeker.street/CHEDDARandBRIE&quot;</span><span class="p">,</span>
      <span class="nt">&quot;guest_can_join&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;CHEESE&quot;</span><span class="p">,</span>
      <span class="nt">&quot;num_joined_members&quot;</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span>
      <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!ol19s:bleecker.street&quot;</span><span class="p">,</span>
      <span class="nt">&quot;topic&quot;</span><span class="p">:</span> <span class="s2">&quot;Tasty tasty cheese&quot;</span><span class="p">,</span>
      <span class="nt">&quot;world_readable&quot;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;next_batch&quot;</span><span class="p">:</span> <span class="s2">&quot;p190q&quot;</span><span class="p">,</span>
  <span class="nt">&quot;prev_batch&quot;</span><span class="p">:</span> <span class="s2">&quot;p1902&quot;</span><span class="p">,</span>
  <span class="nt">&quot;total_room_count_estimate&quot;</span><span class="p">:</span> <span class="mi">115</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="typing-notifications"></a></p>
<div class="section" id="typing-notifications">
<h1><a class="toc-backref" href="#id75">16&nbsp;&nbsp;&nbsp;Typing Notifications</a></h1>
<p>When a server's users send typing notifications, those notifications need to
be sent to other servers in the room so their users are aware of the same
state. Receiving servers should verify that the user is in the room, and is
a user belonging to the sending server.</p>
<p><a class="anchor" id="m-typing-schema"></a></p>
<div class="section" id="m-typing-schema">
<h2><a class="toc-backref" href="#id76">16.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.typing</tt> schema</a></h2>
<p>A typing notification EDU for a user in a room.</p>
<p><tt class="docutils literal">m.typing</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>edu_type</td>
<td>enum</td>
<td><strong>Required.</strong> The string <tt class="docutils literal">m.typing</tt> Must be
'm.typing'.</td>
</tr>
<tr><td>content</td>
<td>Typing Notification</td>
<td><strong>Required.</strong> The typing notification.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Typing Notification</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The room where the user's typing
status has been updated.</td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The user ID that has had their
typing status changed.</td>
</tr>
<tr><td>typing</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the user is typing in the
room or not.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="p">{</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!somewhere:matrix.org&quot;</span><span class="p">,</span>
        <span class="nt">&quot;typing&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;john:matrix.org&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;edu_type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.typing&quot;</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="presence"></a></p>
<div class="section" id="presence">
<h1><a class="toc-backref" href="#id77">17&nbsp;&nbsp;&nbsp;Presence</a></h1>
<p>The server API for presence is based entirely on exchange of the following
EDUs. There are no PDUs or Federation Queries involved.</p>
<p>Servers should only send presence updates for users that the receiving server
would be interested in. Such as the receiving server sharing a room
with a given user.</p>
<!-- TODO-doc
- Explain the timing-based round-trip reduction mechanism for presence
  messages
- Explain the zero-byte presence inference logic
See also: docs/client-server/model/presence -->
<p><a class="anchor" id="m-presence-schema"></a></p>
<div class="section" id="m-presence-schema">
<h2><a class="toc-backref" href="#id78">17.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.presence</tt> schema</a></h2>
<p>An EDU representing presence updates for users of the sending homeserver.</p>
<p><tt class="docutils literal">m.presence</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>edu_type</td>
<td>enum</td>
<td><strong>Required.</strong> The string <tt class="docutils literal">m.presence</tt> Must be
'm.presence'.</td>
</tr>
<tr><td>content</td>
<td>Presence Update</td>
<td><strong>Required.</strong> The presence updates and requests.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Presence Update</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>push</td>
<td>[User Presence Update]</td>
<td><strong>Required.</strong> A list of presence updates that the
receiving server is likely to be interested in.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">User Presence Update</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The user ID this presence EDU is
for.</td>
</tr>
<tr><td>presence</td>
<td>enum</td>
<td><strong>Required.</strong> The presence of the user. One of:
[&quot;offline&quot;, &quot;unavailable&quot;, &quot;online&quot;]</td>
</tr>
<tr><td>status_msg</td>
<td>string</td>
<td>An optional description to accompany the presence.</td>
</tr>
<tr><td>last_active_ago</td>
<td>integer</td>
<td><strong>Required.</strong> The number of milliseconds that have
elapsed since the user last did something.</td>
</tr>
<tr><td>currently_active</td>
<td>boolean</td>
<td>True if the user is likely to be interacting with
their client. This may be indicated by the user
having a  <tt class="docutils literal">last_active_ago</tt> within the last few
minutes. Defaults to false.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="p">{</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;push&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;currently_active&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nt">&quot;last_active_ago&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
                <span class="nt">&quot;presence&quot;</span><span class="p">:</span> <span class="s2">&quot;online&quot;</span><span class="p">,</span>
                <span class="nt">&quot;status_msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Making cupcakes&quot;</span><span class="p">,</span>
                <span class="nt">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;john:matrix.org&quot;</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;edu_type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.presence&quot;</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="receipts"></a></p>
<div class="section" id="receipts">
<h1><a class="toc-backref" href="#id79">18&nbsp;&nbsp;&nbsp;Receipts</a></h1>
<p>Receipts are EDUs used to communicate a marker for a given event. Currently the
only kind of receipt supported is a &quot;read receipt&quot;, or where in the event graph
the user has read up to.</p>
<p>Read receipts for events events that a user sent do not need to be sent. It is
implied that by sending the event the user has read up to the event.</p>
<p><a class="anchor" id="m-receipt-schema"></a></p>
<div class="section" id="m-receipt-schema">
<h2><a class="toc-backref" href="#id80">18.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.receipt</tt> schema</a></h2>
<p>An EDU representing receipt updates for users of the sending homeserver.
When receiving receipts, the server should only update entries that are
listed in the EDU. Receipts previously received that do not appear in the
EDU should not be removed or otherwise manipulated.</p>
<p><tt class="docutils literal">m.receipt</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>edu_type</td>
<td>enum</td>
<td><strong>Required.</strong> The string <tt class="docutils literal">m.receipt</tt> Must be
'm.receipt'.</td>
</tr>
<tr><td>content</td>
<td>{string: Room Receipts}</td>
<td><strong>Required.</strong> Receipts for a particular room. The
string key is the room ID for which the receipts
under it belong.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Room Receipts</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>m.read</td>
<td>User Read Receipt</td>
<td><strong>Required.</strong> Read receipts for users in the room.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">User Read Receipt</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_ids</td>
<td>[string]</td>
<td><strong>Required.</strong> The extremity event IDs that the
user has read up to.</td>
</tr>
<tr><td>data</td>
<td>Read Receipt Metadata</td>
<td><strong>Required.</strong> Metadata for the read receipt.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Read Receipt Metadata</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>ts</td>
<td>integer</td>
<td><strong>Required.</strong> A POSIX timestamp in milliseconds
for when the user read the event specified in the
read receipt.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="p">{</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;!some_room:example.org&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;m.read&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;&#64;john:matrix.org&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="nt">&quot;ts&quot;</span><span class="p">:</span> <span class="mi">1533358089009</span>
                    <span class="p">},</span>
                    <span class="nt">&quot;event_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;$read_this_event:matrix.org&quot;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;edu_type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.receipt&quot;</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="querying-for-information"></a></p>
<div class="section" id="querying-for-information">
<h1><a class="toc-backref" href="#id81">19&nbsp;&nbsp;&nbsp;Querying for information</a></h1>
<p>Queries are a way to retrieve information from a homeserver about a resource,
such as a user or room. The endpoints here are often called in conjunction with
a request from a client on the client-server API in order to complete the call.</p>
<p>There are several types of queries that can be made. The generic endpoint to
represent all queries is described first, followed by the more specific queries
that can be made.</p>
<p><a class="anchor" id="get-matrix-federation-v1-query-querytype"></a></p>
<div class="section" id="get-matrix-federation-v1-query-querytype">
<h2><a class="toc-backref" href="#id82">19.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/query/{queryType}</span></tt></a></h2>
<p>Performs a single query request on the receiving homeserver. The query string
arguments are dependent on which type of query is being made. Known query types
are specified as their own endpoints as an extension to this definition.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>queryType</td>
<td>string</td>
<td><strong>Required.</strong> The type of query to make</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/query/profile</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The query response. The schema varies depending on the query being made.</p>
</div>
<p><a class="anchor" id="get-matrix-federation-v1-query-directory"></a></p>
<div class="section" id="get-matrix-federation-v1-query-directory">
<h2><a class="toc-backref" href="#id83">19.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/query/directory</tt></a></h2>
<p>Performs a query to get the mapped room ID and list of resident homeservers in
the room for a given room alias. Homeservers should only query room aliases
that belong to the target server (identified by the DNS Name in the alias).</p>
<p>Servers may wish to cache the response to this query to avoid requesting the
information too often.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>room_alias</td>
<td>string</td>
<td><strong>Required.</strong> The room alias to query.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The room ID mapped to the queried
room alias.</td>
</tr>
<tr><td>servers</td>
<td>[string]</td>
<td><strong>Required.</strong> An array of server names that are
likely to hold the given room. This list may or
may not include the server answering the query.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/query/directory?room_alias=%23room_alias%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The corresponding room ID and list of known resident homeservers for the room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!roomid1234:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;servers&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;example.org&quot;</span><span class="p">,</span>
    <span class="s2">&quot;example.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;another.example.com:8449&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The room alias was not found.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;errcode&quot;</span><span class="p">:</span> <span class="s2">&quot;M_NOT_FOUND&quot;</span><span class="p">,</span>
  <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Room alias not found.&quot;</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-federation-v1-query-profile"></a></p>
<div class="section" id="get-matrix-federation-v1-query-profile">
<h2><a class="toc-backref" href="#id84">19.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/query/profile</tt></a></h2>
<p>Performs a query to get profile information, such as a display name or avatar,
for a given user. Homeservers should only query profiles for users that belong
to the target server (identified by the DNS Name in the user ID).</p>
<p>Servers may wish to cache the response to this query to avoid requesting the
information too often.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The user ID to query.</td>
</tr>
<tr><td>field</td>
<td>enum</td>
<td>The field to query. If specified, the server will
only return the given field in the response. If
not specified, the server will return the full
profile for the user. One of: [&quot;displayname&quot;,
&quot;avatar_url&quot;]</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>displayname</td>
<td>string</td>
<td>The display name of the user. May be omitted if
the user does not have a display name set.</td>
</tr>
<tr><td>avatar_url</td>
<td>string</td>
<td>The avatar URL for the user's avatar. May be
omitted if the user does not have an avatar set.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/query/profile?user_id=%40someone%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The profile for the user. If a <tt class="docutils literal">field</tt> is specified in the request, only the
matching field should be included in the response. If no <tt class="docutils literal">field</tt> was specified,
the response should include the fields of the user's profile that can be made
public, such as the display name and avatar.</p>
<p>If the user does not have a particular field set on their profile, the server
should exclude it from the response body or give it the value <tt class="docutils literal">null</tt>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;displayname&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
  <span class="nt">&quot;avatar_url&quot;</span><span class="p">:</span> <span class="s2">&quot;mxc://matrix.org/MyC00lAvatar&quot;</span>
<span class="p">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The user does not exist or does not have a profile.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;errcode&quot;</span><span class="p">:</span> <span class="s2">&quot;M_NOT_FOUND&quot;</span><span class="p">,</span>
  <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User does not exist.&quot;</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="openid"></a></p>
<div class="section" id="openid">
<h1><a class="toc-backref" href="#id85">20&nbsp;&nbsp;&nbsp;OpenID</a></h1>
<p>Third party services can exchange an access token previously generated by the
<cite>Client-Server API</cite> for information about a user. This can help verify that a
user is who they say they are without granting full access to the user's account.</p>
<p>Access tokens generated by the OpenID API are only good for the OpenID API and
nothing else.</p>
<p><a class="anchor" id="get-matrix-federation-v1-openid-userinfo"></a></p>
<div class="section" id="get-matrix-federation-v1-openid-userinfo">
<h2><a class="toc-backref" href="#id86">20.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/openid/userinfo</tt></a></h2>
<p>Exchanges an OpenID access token for information about the user
who generated the token. Currently this only exposes the Matrix
User ID of the owner.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>access_token</td>
<td>string</td>
<td><strong>Required.</strong> The OpenID access token to get
information about the owner for.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sub</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix User ID who generated the
token.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/openid/userinfo?access_token=SomeT0kenHere</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Information about the user who generated the OpenID access token.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;sub&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;alice:example.com&quot;</span>
<span class="p">}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The token was not recognized or has expired.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;errcode&quot;</span><span class="p">:</span> <span class="s2">&quot;M_UNKNOWN_TOKEN&quot;</span><span class="p">,</span>
  <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Access token unknown or expired&quot;</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="device-management"></a></p>
<div class="section" id="device-management">
<h1><a class="toc-backref" href="#id87">21&nbsp;&nbsp;&nbsp;Device Management</a></h1>
<p>Details of a user's devices must be efficiently published to other users and kept
up-to-date.  This is critical for reliable end-to-end encryption, in order for users
to know which devices are participating in a room.  It's also required for to-device
messaging to work. This section is intended to complement the <a class="reference external" href="../client_server/r0.6.1.html#device-management">Device Management module</a>
of the Client-Server API.</p>
<p>Matrix currently uses a custom pubsub system for synchronising information
about the list of devices for a given user over federation.  When a server
wishes to determine a remote user's device list for the first time,
it should populate a local cache from the result of a <tt class="docutils literal">/user/keys/query</tt> API
on the remote server.  However, subsequent updates to the cache should be applied
by consuming <tt class="docutils literal">m.device_list_update</tt> EDUs.  Each new <tt class="docutils literal">m.device_list_update</tt> EDU
describes an incremental change to one device for a given user which should replace
any existing entry in the local server's cache of that device list. Servers must send
<tt class="docutils literal">m.device_list_update</tt> EDUs to all the servers who share a room with a given
local user, and must be sent whenever that user's device list changes (i.e. for new or
deleted devices, when that user joins a room which contains servers which are not
already receiving updates for that user's device list, or changes in device information
such as the device's human-readable name).</p>
<p>Servers send <tt class="docutils literal">m.device_list_update</tt> EDUs in a sequence per origin user, each with
a unique <tt class="docutils literal">stream_id</tt>.  They also include a pointer to the most recent previous EDU(s)
that this update is relative to in the <tt class="docutils literal">prev_id</tt> field.  To simplify implementation
for clustered servers which could send multiple EDUs at the same time, the <tt class="docutils literal">prev_id</tt>
field should include all <tt class="docutils literal">m.device_list_update</tt> EDUs which have not been yet been
referenced in a EDU. If EDUs are emitted in series by a server, there should only ever
be one <tt class="docutils literal">prev_id</tt> in the EDU.</p>
<p>This forms a simple directed acyclic graph of <tt class="docutils literal">m.device_list_update</tt> EDUs, showing
which EDUs a server needs to have received in order to apply an update to its local
copy of the remote user's device list.  If a server receives an EDU which refers to
a <tt class="docutils literal">prev_id</tt> it does not recognise, it must resynchronise its list by calling the
<tt class="docutils literal">/user/keys/query API</tt> and resume the process.  The response contains a <tt class="docutils literal">stream_id</tt>
which should be used to correlate with subsequent <tt class="docutils literal">m.device_list_update</tt> EDUs.</p>
<!-- TODO: this whole thing desperately feels like it should just be state in a room,
rather than inventing a whole different DAG.  The same room could be used for
profiles etc. -->
<p><a class="anchor" id="get-matrix-federation-v1-user-devices-userid"></a></p>
<div class="section" id="get-matrix-federation-v1-user-devices-userid">
<h2><a class="toc-backref" href="#id88">21.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/federation/v1/user/devices/{userId}</span></tt></a></h2>
<p>Gets information on all of the user's devices</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user ID to retrieve devices for.
Must be a user local to the receiving homeserver.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The user ID devices were requested
for.</td>
</tr>
<tr><td>stream_id</td>
<td>integer</td>
<td><strong>Required.</strong> A unique ID for a given user_id
which describes the version of the returned device
list.  This is matched with the <tt class="docutils literal">stream_id</tt>
field in <tt class="docutils literal">m.device_list_update</tt> EDUs in order to
incrementally update the returned device_list.</td>
</tr>
<tr><td>devices</td>
<td>[User Device]</td>
<td><strong>Required.</strong> The user's devices. May be empty.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>User Device</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>device_id</td>
<td>string</td>
<td><strong>Required.</strong> The device ID.</td>
</tr>
<tr><td>keys</td>
<td>DeviceKeys</td>
<td><strong>Required.</strong> Identity keys for the device.</td>
</tr>
<tr><td>device_display_name</td>
<td>string</td>
<td>Optional display name for the device.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>DeviceKeys</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the user the device
belongs to. Must match the user ID used when
logging in.</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the device these keys
belong to. Must match the device ID used when
logging in.</td>
</tr>
<tr><td>algorithms</td>
<td>[string]</td>
<td><strong>Required.</strong> The encryption algorithms supported
by this device.</td>
</tr>
<tr><td>keys</td>
<td>{string: string}</td>
<td><strong>Required.</strong> Public identity keys. The names of
the properties should be in the format
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;device_id&gt;</span></tt>. The keys themselves
should be encoded as specified by the key
algorithm.</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><p class="first"><strong>Required.</strong> Signatures for the device key
object. A map from user ID, to a map from
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;device_id&gt;</span></tt> to the signature.</p>
<p class="last">The signature is calculated using the process
described at <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">GET</span> <span class="nn">/_matrix/federation/v1/user/devices/%40alice%3Aexample.org</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The user's devices.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;alice:example.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;stream_id&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="nt">&quot;devices&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;JLAFKJWSCS&quot;</span><span class="p">,</span>
      <span class="nt">&quot;keys&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;alice:example.com&quot;</span><span class="p">,</span>
        <span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;JLAFKJWSCS&quot;</span><span class="p">,</span>
        <span class="nt">&quot;algorithms&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="s2">&quot;m.olm.v1.curve25519-aes-sha2&quot;</span><span class="p">,</span>
          <span class="s2">&quot;m.megolm.v1.aes-sha2&quot;</span>
        <span class="p">],</span>
        <span class="nt">&quot;keys&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;curve25519:JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;3C5BFWi2Y8MaVvjM8M22DBmh24PmgR0nPvJOIArzgyI&quot;</span><span class="p">,</span>
          <span class="nt">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;lEuiRJBit0IG6nUf5pUzWTUEsRVVe/HJkoKuEww9ULI&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;&#64;alice:example.com&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;dSO80A01XiigH3uBiDVx/EjzaoycHcjq9lfQX0uWsqxl2giMIiSPR8a4d291W1ihKJL/a+myXS367WT6NAIcBA&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;device_display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice's Mobile Phone&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="m-device-list-update-schema"></a></p>
<div class="section" id="m-device-list-update-schema">
<h2><a class="toc-backref" href="#id89">21.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.device_list_update</tt> schema</a></h2>
<p>An EDU that lets servers push details to each other when one of their users
adds a new device to their account, required for E2E encryption to correctly
target the current set of devices for a given user.</p>
<p><tt class="docutils literal">m.device_list_update</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>edu_type</td>
<td>enum</td>
<td><strong>Required.</strong> The string <tt class="docutils literal">m.device_list_update</tt>.
Must be 'm.device_list_update'.</td>
</tr>
<tr><td>content</td>
<td>Device List Update</td>
<td><strong>Required.</strong> The description of the device whose
details has changed.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Device List Update</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The user ID who owns this device.</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the device whose details
are changing.</td>
</tr>
<tr><td>device_display_name</td>
<td>string</td>
<td>The public human-readable name of this device.
Will be absent if the device has no name.</td>
</tr>
<tr><td>stream_id</td>
<td>integer</td>
<td><strong>Required.</strong> An ID sent by the server for this
update, unique for a given user_id.  Used to
identify any gaps in the sequence of
<tt class="docutils literal">m.device_list_update</tt> EDUs broadcast by a
server.</td>
</tr>
<tr><td>prev_id</td>
<td>[integer]</td>
<td>The stream_ids of any prior m.device_list_update
EDUs sent for this user which have not been
referred to already in an EDU's prev_id field.  If
the receiving server does not recognise any of the
prev_ids, it means an EDU has been lost and the
server should query a snapshot of the device list
via <tt class="docutils literal">/user/keys/query</tt> in order to correctly
interpret future <tt class="docutils literal">m.device_list_update</tt> EDUs.
May be missing or empty for the first EDU in a
sequence.</td>
</tr>
<tr><td>deleted</td>
<td>boolean</td>
<td>True if the server is announcing that this device
has been deleted.</td>
</tr>
<tr><td>keys</td>
<td>DeviceKeys</td>
<td>The updated identity keys (if any) for this
device.  May be absent if the device has no E2E
keys defined.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">DeviceKeys</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the user the device
belongs to. Must match the user ID used when
logging in.</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the device these keys
belong to. Must match the device ID used when
logging in.</td>
</tr>
<tr><td>algorithms</td>
<td>[string]</td>
<td><strong>Required.</strong> The encryption algorithms supported
by this device.</td>
</tr>
<tr><td>keys</td>
<td>{string: string}</td>
<td><strong>Required.</strong> Public identity keys. The names of
the properties should be in the format
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;device_id&gt;</span></tt>. The keys themselves
should be encoded as specified by the key
algorithm.</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><p class="first"><strong>Required.</strong> Signatures for the device key
object. A map from user ID, to a map from
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;device_id&gt;</span></tt> to the signature.</p>
<p class="last">The signature is calculated using the process
described at <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="p">{</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;deleted&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;device_display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mobile&quot;</span><span class="p">,</span>
        <span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;QBUAZIFURK&quot;</span><span class="p">,</span>
        <span class="nt">&quot;keys&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;algorithms&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;m.olm.v1.curve25519-aes-sha2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;m.megolm.v1.aes-sha2&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;JLAFKJWSCS&quot;</span><span class="p">,</span>
            <span class="nt">&quot;keys&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;curve25519:JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;3C5BFWi2Y8MaVvjM8M22DBmh24PmgR0nPvJOIArzgyI&quot;</span><span class="p">,</span>
                <span class="nt">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;lEuiRJBit0IG6nUf5pUzWTUEsRVVe/HJkoKuEww9ULI&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;&#64;alice:example.com&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;dSO80A01XiigH3uBiDVx/EjzaoycHcjq9lfQX0uWsqxl2giMIiSPR8a4d291W1ihKJL/a+myXS367WT6NAIcBA&quot;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;alice:example.com&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;prev_id&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="mi">5</span>
        <span class="p">],</span>
        <span class="nt">&quot;stream_id&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="nt">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;john:example.com&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;edu_type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.device_list_update&quot;</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="end-to-end-encryption"></a></p>
<div class="section" id="end-to-end-encryption">
<h1><a class="toc-backref" href="#id90">22&nbsp;&nbsp;&nbsp;End-to-End Encryption</a></h1>
<p>This section complements the <a class="reference external" href="../client_server/r0.6.1.html#end-to-end-encryption">End-to-End Encryption module</a> of the Client-Server
API. For detailed information about end-to-end encryption, please see that module.</p>
<p>The APIs defined here are designed to be able to proxy much of the client's request
through to federation, and have the response also be proxied through to the client.</p>
<p><a class="anchor" id="post-matrix-federation-v1-user-keys-claim"></a></p>
<div class="section" id="post-matrix-federation-v1-user-keys-claim">
<h2><a class="toc-backref" href="#id91">22.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/federation/v1/user/keys/claim</tt></a></h2>
<p>Claims one-time keys for use in pre-key messages.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>one_time_keys</td>
<td>{string: {string: string}}</td>
<td><strong>Required.</strong> The keys to be claimed. A map from
user ID, to a map from device ID to algorithm
name.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>one_time_keys</td>
<td>{string: {string: string or KeyObject}}</td>
<td><p class="first"><strong>Required.</strong> One-time keys for the queried
devices. A map from user ID, to a map from devices
to a map from <tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;key_id&gt;</span></tt> to the key
object.</p>
<p class="last">See the <a class="reference external" href="../client_server/r0.6.1.html#key-algorithms">Client-Server Key Algorithms</a> section
for more information on the Key Object format.</p>
</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>KeyObject</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>key</td>
<td>string</td>
<td><strong>Required.</strong> The key, encoded using unpadded
base64.</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><p class="first"><strong>Required.</strong> Signature of the key object.</p>
<p class="last">The signature is calculated using the process
described at <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">POST</span> <span class="nn">/_matrix/federation/v1/user/keys/claim</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;one_time_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;&#64;alice:example.com&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;signed_curve25519&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The claimed keys.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;one_time_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;&#64;alice:example.com&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;signed_curve25519:AAAAHg&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;zKbLg+NrIjpnagy+pIY6uPL4ZwEG2v+8F9lmgsnlZzs&quot;</span><span class="p">,</span>
          <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;&#64;alice:example.com&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;FLWxXqGbwrb8SM3Y795eB6OA8bwBcoMZFXBqnTn58AYWZSqiD45tlBVcDa2L7RwdKXebW/VzDlnfVJ+9jok1Bw&quot;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-federation-v1-user-keys-query"></a></p>
<div class="section" id="post-matrix-federation-v1-user-keys-query">
<h2><a class="toc-backref" href="#id92">22.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/federation/v1/user/keys/query</tt></a></h2>
<p>Returns the current devices and identity keys for the given users.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>device_keys</td>
<td>{string: [string]}</td>
<td><strong>Required.</strong> The keys to be downloaded. A map
from user ID, to a list of device IDs, or to an
empty list to indicate all devices for the
corresponding user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>device_keys</td>
<td>{string: {string: DeviceKeys}}</td>
<td><strong>Required.</strong> Information on the queried devices.
A map from user ID, to a map from device ID to
device information.  For each device, the
information returned will be the same as uploaded
via <tt class="docutils literal">/keys/upload</tt>, with the addition of an
<tt class="docutils literal">unsigned</tt> property.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>DeviceKeys</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the user the device
belongs to. Must match the user ID used when
logging in.</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the device these keys
belong to. Must match the device ID used when
logging in.</td>
</tr>
<tr><td>algorithms</td>
<td>[string]</td>
<td><strong>Required.</strong> The encryption algorithms supported
by this device.</td>
</tr>
<tr><td>keys</td>
<td>{string: string}</td>
<td><strong>Required.</strong> Public identity keys. The names of
the properties should be in the format
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;device_id&gt;</span></tt>. The keys themselves
should be encoded as specified by the key
algorithm.</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><p class="first"><strong>Required.</strong> Signatures for the device key
object. A map from user ID, to a map from
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;device_id&gt;</span></tt> to the signature.</p>
<p class="last">The signature is calculated using the process
described at <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedDeviceInfo</td>
<td>Additional data added to the device key
information by intermediate servers, and not
covered by the signatures.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedDeviceInfo</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>device_display_name</td>
<td>string</td>
<td>The display name which the user set on the device.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="nf">POST</span> <span class="nn">/_matrix/federation/v1/user/keys/query</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;device_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;&#64;alice:example.com&quot;</span><span class="p">:</span> <span class="p">[]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The device information.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="p">{</span>
  <span class="nt">&quot;device_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;&#64;alice:example.com&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&#64;alice:example.com&quot;</span><span class="p">,</span>
        <span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;JLAFKJWSCS&quot;</span><span class="p">,</span>
        <span class="nt">&quot;algorithms&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="s2">&quot;m.olm.v1.curve25519-aes-sha2&quot;</span><span class="p">,</span>
          <span class="s2">&quot;m.megolm.v1.aes-sha2&quot;</span>
        <span class="p">],</span>
        <span class="nt">&quot;keys&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;curve25519:JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;3C5BFWi2Y8MaVvjM8M22DBmh24PmgR0nPvJOIArzgyI&quot;</span><span class="p">,</span>
          <span class="nt">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;lEuiRJBit0IG6nUf5pUzWTUEsRVVe/HJkoKuEww9ULI&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;signatures&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;&#64;alice:example.com&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="p">:</span> <span class="s2">&quot;dSO80A01XiigH3uBiDVx/EjzaoycHcjq9lfQX0uWsqxl2giMIiSPR8a4d291W1ihKJL/a+myXS367WT6NAIcBA&quot;</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;unsigned&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;device_display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice's mobile phone&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="send-to-device-messaging"></a></p>
<div class="section" id="send-to-device-messaging">
<h1><a class="toc-backref" href="#id93">23&nbsp;&nbsp;&nbsp;Send-to-device messaging</a></h1>
<!-- TODO: add modules to the federation spec and make this a module -->
<p>The server API for send-to-device messaging is based on the
<tt class="docutils literal">m.direct_to_device</tt> EDU. There are no PDUs or Federation Queries involved.</p>
<p>Each send-to-device message should be sent to the destination server using
the following EDU:</p>
<p><a class="anchor" id="m-direct-to-device-schema"></a></p>
<div class="section" id="m-direct-to-device-schema">
<h2><a class="toc-backref" href="#id94">23.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.direct_to_device</tt> schema</a></h2>
<p>An EDU that lets servers push send events directly to a specific device on
a remote server - for instance, to maintain an Olm E2E encrypted message channel
between a local and remote device.</p>
<p><tt class="docutils literal">m.direct_to_device</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>edu_type</td>
<td>enum</td>
<td><strong>Required.</strong> The string <tt class="docutils literal">m.direct_to_device</tt>.
Must be 'm.direct_to_device'.</td>
</tr>
<tr><td>content</td>
<td>To Device Message</td>
<td><strong>Required.</strong> The description of the direct-to-
device message.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">To Device Message</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> User ID of the sender.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> Event type for the message.</td>
</tr>
<tr><td>message_id</td>
<td>string</td>
<td><strong>Required.</strong> Unique ID for the message, used for
idempotence.  Arbitrary utf8 string, of maximum
length 32 codepoints.</td>
</tr>
<tr><td>messages</td>
<td>{string: User Devices}</td>
<td><strong>Required.</strong> The contents of the messages to be
sent.  These are arranged in a map of user IDs to
a map of device IDs to message bodies. The device
ID may also be <tt class="docutils literal">*</tt>, meaning all known devices
for the user.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="p">{</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;message_id&quot;</span><span class="p">:</span> <span class="s2">&quot;hiezohf6Hoo7kaev&quot;</span><span class="p">,</span>
        <span class="nt">&quot;messages&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;alice&#64;example.org&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;IWHQUZUIAH&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;m.megolm.v1.aes-sha2&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;room_id&quot;</span><span class="p">:</span> <span class="s2">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;session_key&quot;</span><span class="p">:</span> <span class="s2">&quot;AgAAAADxKHa9uFxcXzwYoNueL5Xqi69IkD4sni8LlfJL7qNBEY...&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;john&#64;example.com&quot;</span><span class="p">,</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.room_key_request&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;edu_type&quot;</span><span class="p">:</span> <span class="s2">&quot;m.direct_to_device&quot;</span>
<span class="p">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="content-repository"></a></p>
<div class="section" id="content-repository">
<h1><a class="toc-backref" href="#id95">24&nbsp;&nbsp;&nbsp;Content Repository</a></h1>
<p>Attachments to events (images, files, etc) are uploaded to a homeserver via the
Content Repository described in the <a class="reference external" href="../client_server/r0.6.1.html">Client-Server API</a>. When a server wishes
to serve content originating from a remote server, it needs to ask the remote
server for the media.</p>
<p>Servers should use the server described in the Matrix Content URI, which has the
format <tt class="docutils literal"><span class="pre">mxc://{ServerName}/{MediaID}</span></tt>. Servers should use the download endpoint
described in the <a class="reference external" href="../client_server/r0.6.1.html">Client-Server API</a>, being sure to use the <tt class="docutils literal">allow_remote</tt>
parameter (set to <tt class="docutils literal">false</tt>).</p>
</div>
<p><a class="anchor" id="server-access-control-lists-acls"></a></p>
<div class="section" id="server-access-control-lists-acls">
<h1><a class="toc-backref" href="#id96">25&nbsp;&nbsp;&nbsp;Server Access Control Lists (ACLs)</a></h1>
<p>Server ACLs and their purpose are described in the <a class="reference external" href="../client_server/r0.6.1.html#module-server-acls">Server ACLs</a> section of the
Client-Server API.</p>
<p>When a remote server makes a request, it MUST be verified to be allowed by the
server ACLs. If the server is denied access to a room, the receiving server
MUST reply with a 403 HTTP status code and an <tt class="docutils literal">errcode</tt> of <tt class="docutils literal">M_FORBIDDEN</tt>.</p>
<p>The following endpoint prefixes MUST be protected:</p>
<ul class="simple">
<li><tt class="docutils literal">/_matrix/federation/v1/send</tt> (on a per-PDU basis)</li>
<li><tt class="docutils literal">/_matrix/federation/v1/make_join</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v1/make_leave</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v1/send_join</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v2/send_join</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v1/send_leave</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v2/send_leave</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v1/invite</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v2/invite</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v1/state</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v1/state_ids</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v1/backfill</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v1/event_auth</tt></li>
<li><tt class="docutils literal">/_matrix/federation/v1/get_missing_events</tt></li>
</ul>
</div>
<p><a class="anchor" id="id14"></a></p>
<div class="section" id="id14">
<h1><a class="toc-backref" href="#id97">26&nbsp;&nbsp;&nbsp;Signing Events</a></h1>
<p>Signing events is complicated by the fact that servers can choose to redact
non-essential parts of an event.</p>
<p><a class="anchor" id="adding-hashes-and-signatures-to-outgoing-events"></a></p>
<div class="section" id="adding-hashes-and-signatures-to-outgoing-events">
<h2><a class="toc-backref" href="#id98">26.1&nbsp;&nbsp;&nbsp;Adding hashes and signatures to outgoing events</a></h2>
<p>Before signing the event, the <em>content hash</em> of the event is calculated as
described below. The hash is encoded using <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a> and stored in the
event object, in a <tt class="docutils literal">hashes</tt> object, under a <tt class="docutils literal">sha256</tt> key.</p>
<p>The event object is then <em>redacted</em>, following the <a class="reference external" href="../client_server/r0.6.1.html#redactions">redaction
algorithm</a>. Finally it is signed as described in <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>, using the
server's signing key (see also <a class="reference internal" href="#retrieving-server-keys">Retrieving server keys</a>).</p>
<p>The signature is then copied back to the original event object.</p>
<p>See <a class="reference internal" href="#persistent-data-unit-schema">Persistent Data Unit schema</a> for an example of a signed event.</p>
</div>
<p><a class="anchor" id="validating-hashes-and-signatures-on-received-events"></a></p>
<div class="section" id="validating-hashes-and-signatures-on-received-events">
<h2><a class="toc-backref" href="#id99">26.2&nbsp;&nbsp;&nbsp;Validating hashes and signatures on received events</a></h2>
<p>When a server receives an event over federation from another server, the
receiving server should check the hashes and signatures on that event.</p>
<p>First the signature is checked. The event is redacted following the <a class="reference external" href="../client_server/r0.6.1.html#redactions">redaction
algorithm</a>, and the resultant object is checked for a signature from the
originating server, following the algorithm described in <a class="reference external" href="../appendices.html#checking-for-a-signature">Checking for a signature</a>.
Note that this step should succeed whether we have been sent the full event or
a redacted copy.</p>
<p>The signatures expected on an event are:</p>
<ul class="simple">
<li>The <tt class="docutils literal">sender</tt>'s server, unless the invite was created as a result of 3rd party invite.
The sender must already match the 3rd party invite, and the server which actually
sends the event may be a different server.</li>
<li>For room versions 1 and 2, the server which created the <tt class="docutils literal">event_id</tt>. Other room
versions do not track the <tt class="docutils literal">event_id</tt> over federation and therefore do not need
a signature from those servers.</li>
</ul>
<p>If the signature is found to be valid, the expected content hash is calculated
as described below. The content hash in the <tt class="docutils literal">hashes</tt> property of the received
event is base64-decoded, and the two are compared for equality.</p>
<p>If the hash check fails, then it is assumed that this is because we have only
been given a redacted version of the event. To enforce this, the receiving
server should use the redacted copy it calculated rather than the full copy it
received.</p>
</div>
<p><a class="anchor" id="calculating-the-reference-hash-for-an-event"></a></p>
<div class="section" id="calculating-the-reference-hash-for-an-event">
<span id="reference-hashes"></span><h2><a class="toc-backref" href="#id100">26.3&nbsp;&nbsp;&nbsp;Calculating the reference hash for an event</a></h2>
<p>The <em>reference hash</em> of an event covers the essential fields of an event,
including content hashes. It is used for event identifiers in some room versions.
See the <a class="reference external" href="../index.html#room-versions">room version specification</a> for more information. It is calculated as
follows.</p>
<ol class="arabic simple">
<li>The event is put through the redaction algorithm.</li>
<li>The <tt class="docutils literal">signatures</tt>, <tt class="docutils literal">age_ts</tt>, and <tt class="docutils literal">unsigned</tt> properties are removed
from the event, if present.</li>
<li>The event is converted into <a class="reference external" href="../appendices.html#canonical-json">Canonical JSON</a>.</li>
<li>A sha256 hash is calculated on the resulting JSON object.</li>
</ol>
</div>
<p><a class="anchor" id="calculating-the-content-hash-for-an-event"></a></p>
<div class="section" id="calculating-the-content-hash-for-an-event">
<h2><a class="toc-backref" href="#id101">26.4&nbsp;&nbsp;&nbsp;Calculating the content hash for an event</a></h2>
<p>The <em>content hash</em> of an event covers the complete event including the
<em>unredacted</em> contents. It is calculated as follows.</p>
<p>First, any existing <tt class="docutils literal">unsigned</tt>, <tt class="docutils literal">signature</tt>, and <tt class="docutils literal">hashes</tt> members are
removed. The resulting object is then encoded as <a class="reference external" href="../appendices.html#canonical-json">Canonical JSON</a>, and the
JSON is hashed using SHA-256.</p>
</div>
<p><a class="anchor" id="example-code"></a></p>
<div class="section" id="example-code">
<h2><a class="toc-backref" href="#id102">26.5&nbsp;&nbsp;&nbsp;Example code</a></h2>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">hash_and_sign_event</span><span class="p">(</span><span class="n">event_object</span><span class="p">,</span> <span class="n">signing_key</span><span class="p">,</span> <span class="n">signing_name</span><span class="p">):</span>
    <span class="c1"># First we need to hash the event object.</span>
    <span class="n">content_hash</span> <span class="o">=</span> <span class="n">compute_content_hash</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span>
    <span class="n">event_object</span><span class="p">[</span><span class="s2">&quot;hashes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sha256&quot;</span><span class="p">:</span> <span class="n">encode_unpadded_base64</span><span class="p">(</span><span class="n">content_hash</span><span class="p">)}</span>

    <span class="c1"># Strip all the keys that would be removed if the event was redacted.</span>
    <span class="c1"># The hashes are not stripped and cover all the keys in the event.</span>
    <span class="c1"># This means that we can tell if any of the non-essential keys are</span>
    <span class="c1"># modified or removed.</span>
    <span class="n">stripped_object</span> <span class="o">=</span> <span class="n">strip_non_essential_keys</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span>

    <span class="c1"># Sign the stripped JSON object. The signature only covers the</span>
    <span class="c1"># essential keys and the hashes. This means that we can check the</span>
    <span class="c1"># signature even if the event is redacted.</span>
    <span class="n">signed_object</span> <span class="o">=</span> <span class="n">sign_json</span><span class="p">(</span><span class="n">stripped_object</span><span class="p">,</span> <span class="n">signing_key</span><span class="p">,</span> <span class="n">signing_name</span><span class="p">)</span>

    <span class="c1"># Copy the signatures from the stripped event to the original event.</span>
    <span class="n">event_object</span><span class="p">[</span><span class="s2">&quot;signatures&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signed_object</span><span class="p">[</span><span class="s2">&quot;signatures&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">compute_content_hash</span><span class="p">(</span><span class="n">event_object</span><span class="p">):</span>
    <span class="c1"># take a copy of the event before we remove any keys.</span>
    <span class="n">event_object</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span>

    <span class="c1"># Keys under &quot;unsigned&quot; can be modified by other servers.</span>
    <span class="c1"># They are useful for conveying information like the age of an</span>
    <span class="c1"># event that will change in transit.</span>
    <span class="c1"># Since they can be modified we need to exclude them from the hash.</span>
    <span class="n">event_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;unsigned&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Signatures will depend on the current value of the &quot;hashes&quot; key.</span>
    <span class="c1"># We cannot add new hashes without invalidating existing signatures.</span>
    <span class="n">event_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;signatures&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># The &quot;hashes&quot; key might contain multiple algorithms if we decide to</span>
    <span class="c1"># migrate away from SHA-2. We don't want to include an existing hash</span>
    <span class="c1"># output in our hash so we exclude the &quot;hashes&quot; dict from the hash.</span>
    <span class="n">event_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;hashes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Encode the JSON using a canonical encoding so that we get the same</span>
    <span class="c1"># bytes on every server for the same JSON object.</span>
    <span class="n">event_json_bytes</span> <span class="o">=</span> <span class="n">encode_canonical_json</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">event_json_bytes</span><span class="p">)</span>
</pre>
<!-- TODO

[[TODO(markjh): Since the ``hash`` object cannot be redacted a server
shouldn't allow too many hashes to be listed, otherwise a server might embed
illicit data within the ``hash`` object.

We might want to specify a maximum number of keys for the
``hash`` and we might want to specify the maximum output size of a hash]]

[[TODO(markjh) We might want to allow the server to omit the output of well
known hash functions like SHA-256 when none of the keys have been redacted]] -->
</div>
</div>
<p><a class="anchor" id="security-considerations"></a></p>
<div class="section" id="security-considerations">
<h1><a class="toc-backref" href="#id103">27&nbsp;&nbsp;&nbsp;Security considerations</a></h1>
<p>When a domain's ownership changes, the new controller of the domain can masquerade
as the previous owner, receiving messages (similarly to email) and request past
messages from other servers. In the future, proposals like
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1228">MSC1228</a> will address this
issue.</p>
</div>
</div>
</body>
</html>
