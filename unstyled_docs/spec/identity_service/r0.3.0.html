<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>Identity Service API</title>
<style type="text/css">

/*
 * basic.css
 * ~~~~~~~~~
 *
 * Sphinx stylesheet -- basic theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- main layout ----------------------------------------------------------- */

div.clearer {
    clear: both;
}

/* -- relbar ---------------------------------------------------------------- */

div.related {
    width: 100%;
    font-size: 90%;
}

div.related h3 {
    display: none;
}

div.related ul {
    margin: 0;
    padding: 0 0 0 10px;
    list-style: none;
}

div.related li {
    display: inline;
}

div.related li.right {
    float: right;
    margin-right: 5px;
}

/* -- sidebar --------------------------------------------------------------- */

div.sphinxsidebarwrapper {
    padding: 10px 5px 0 10px;
}

div.sphinxsidebar {
    float: left;
    width: 230px;
    margin-left: -100%;
    font-size: 90%;
}

div.sphinxsidebar ul {
    list-style: none;
}

div.sphinxsidebar ul ul,
div.sphinxsidebar ul.want-points {
    margin-left: 20px;
    list-style: square;
}

div.sphinxsidebar ul ul {
    margin-top: 0;
    margin-bottom: 0;
}

div.sphinxsidebar form {
    margin-top: 10px;
}

div.sphinxsidebar input {
    border: 1px solid #98dbcc;
    font-family: sans-serif;
    font-size: 1em;
}

img {
    border: 0;
}

/* -- search page ----------------------------------------------------------- */

ul.search {
    margin: 10px 0 0 20px;
    padding: 0;
}

ul.search li {
    padding: 5px 0 5px 20px;
    background-image: url(file.png);
    background-repeat: no-repeat;
    background-position: 0 7px;
}

ul.search li a {
    font-weight: bold;
}

ul.search li div.context {
    color: #888;
    margin: 2px 0 0 30px;
    text-align: left;
}

ul.keywordmatches li.goodmatch a {
    font-weight: bold;
}

/* -- index page ------------------------------------------------------------ */

table.contentstable {
    width: 90%;
}

table.contentstable p.biglink {
    line-height: 150%;
}

a.biglink {
    font-size: 1.3em;
}

span.linkdescr {
    font-style: italic;
    padding-top: 5px;
    font-size: 90%;
}

/* -- general index --------------------------------------------------------- */

table.indextable {
    width: 100%;
}

table.indextable td {
    text-align: left;
    vertical-align: top;
}

table.indextable dl, table.indextable dd {
    margin-top: 0;
    margin-bottom: 0;
}

table.indextable tr.pcap {
    height: 10px;
}

table.indextable tr.cap {
    margin-top: 10px;
    background-color: #f2f2f2;
}

img.toggler {
    margin-right: 3px;
    margin-top: 3px;
    cursor: pointer;
}

div.modindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

div.genindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

/* -- general body styles --------------------------------------------------- */

a.headerlink {
    visibility: hidden;
}

h1:hover > a.headerlink,
h2:hover > a.headerlink,
h3:hover > a.headerlink,
h4:hover > a.headerlink,
h5:hover > a.headerlink,
h6:hover > a.headerlink,
dt:hover > a.headerlink {
    visibility: visible;
}

div.document p.caption {
    text-align: inherit;
}

div.document td {
    text-align: left;
}

.field-list ul {
    padding-left: 1em;
}

.first {
    margin-top: 0 !important;
}

p.rubric {
    margin-top: 30px;
    font-weight: bold;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* -- sidebars -------------------------------------------------------------- */

div.sidebar {
    margin: 0 0 0.5em 1em;
    border: 1px solid #ddb;
    padding: 7px 7px 0 7px;
    background-color: #ffe;
    width: 40%;
    float: right;
}

p.sidebar-title {
    font-weight: bold;
}

/* -- topics ---------------------------------------------------------------- */

div.topic {
    border: 1px solid #ccc;
    padding: 7px 7px 0 7px;
    margin: 10px 0 10px 0;
}

p.topic-title {
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 10px;
}

/* -- admonitions ----------------------------------------------------------- */

div.admonition {
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 7px;
}

div.admonition dt {
    font-weight: bold;
}

div.admonition dl {
    margin-bottom: 0;
}

p.admonition-title {
    margin: 0px 10px 5px 0px;
    font-weight: bold;
}

div.document p.centered {
    text-align: center;
    margin-top: 25px;
}

/* -- tables ---------------------------------------------------------------- */

table.docutils {
    border: 0;
    border-collapse: collapse;
}

table.docutils td, table.docutils th {
    padding: 1px 8px 1px 5px;
    border-top: 0;
    border-left: 0;
    border-right: 0;
    border-bottom: 1px solid #aaa;
}

table.field-list td, table.field-list th {
    border: 0 !important;
}

table.footnote td, table.footnote th {
    border: 0 !important;
}

th {
    text-align: left;
    padding-right: 5px;
}

table.citation {
    border-left: solid 1px gray;
    margin-left: 1px;
}

table.citation td {
    border-bottom: none;
}

table.colwidths-auto caption {
    font-family: 'Inconsolata', monospace;
    font-weight: 800;
    font-size: 120%;
    padding: 5px;
    text-align: left;
    margin-bottom: 2px;
}

.section ol, .section li {
    margin: 0px 0px 0px 30px !important;
}

p.httpheaders {
    font-weight: 800;
    font-size: 120%;
    padding: 5px;
    text-align: left;
    margin-bottom: 2px;
}

table.colwidths-auto {
    width:100%;
    margin-top: 20px;
}

table.colwidths-auto tr td:nth-child(1) {
    width: 15%;
}

table.colwidths-auto tr td:nth-child(2) {
    width: 15%;
    font-family: 'Inconsolata', monospace;
}

table.colwidths-auto tr td:nth-child(3) {
    width: 70%;
}


/* -- other body styles ----------------------------------------------------- */

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl {
    margin-bottom: 15px;
}

dd p {
    margin-top: 0px;
}

dd ul, dd table {
    margin-bottom: 10px;
}

dd {
    margin-top: 3px;
    margin-bottom: 10px;
    margin-left: 30px;
}

dt:target, .highlighted {
    background-color: #fbe54e;
}

dl.glossary dt {
    font-weight: bold;
    font-size: 1.1em;
}

.field-list ul {
    margin: 0;
    padding-left: 1em;
}

.field-list p {
    margin: 0;
}

.refcount {
    color: #060;
}

.optional {
    font-size: 1.3em;
}

.versionmodified {
    font-style: italic;
}

.system-message {
    background-color: #fda;
    padding: 5px;
    border: 3px solid red;
}

.footnote:target  {
    background-color: #ffa
}

.line-block {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
}

.line-block .line-block {
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 1.5em;
}

.guilabel, .menuselection {
    font-family: sans-serif;
}

.accelerator {
    text-decoration: underline;
}

.classifier {
    font-style: oblique;
}

/* -- proposals page -------------------------------------------------------- */

#tables-of-tracked-proposals h2 {
    padding-left: 10px;
    position: -webkit-sticky;
    position: sticky;
}

/* Move sticky headers below header bar on desktop */
@media all and (min-width:980px) {
    #tables-of-tracked-proposals h2 {
        top: 52px;
    }
}

/* Sticky headers stick to the top on mobile */
@media all and (min-width:0px) and (max-width: 980px) {
    #tables-of-tracked-proposals h2 {
        top: 0px;
    }
}

/* -- code displays --------------------------------------------------------- */

pre {
    overflow: auto;
}

td.linenos pre {
    padding: 5px 0px;
    border: 0;
    background-color: transparent;
    color: #aaa;
}

table.highlighttable {
    margin-left: 0.5em;
}

table.highlighttable td {
    padding: 0 0.5em 0 0.5em;
}

tt.descname {
    background-color: transparent;
    font-weight: bold;
    font-size: 1.2em;
}

tt.descclassname {
    background-color: transparent;
}

tt.xref, a tt {
    background-color: transparent;
    font-weight: bold;
}

h1 tt, h2 tt, h3 tt, h4 tt, h5 tt, h6 tt {
    background-color: transparent;
}

.viewcode-link {
    float: right;
}

.viewcode-back {
    float: right;
    font-family: sans-serif;
}

div.viewcode-block:target {
    margin: -1px -10px;
    padding: 0 10px;
}

/* -- math display ---------------------------------------------------------- */

img.math {
    vertical-align: middle;
}

div.document div.math p {
    text-align: center;
}

span.eqno {
    float: right;
}

/* -- printout stylesheet --------------------------------------------------- */

@media print {
    div.document,
    div.documentwrapper,
    div.bodywrapper {
        margin: 0 !important;
        width: 100%;
    }

    div.sphinxsidebar,
    div.related,
    div.footer,
    #top-link {
        display: none;
    }
}


</style>
<style type="text/css">

blockquote {
    margin: 20px 0 30px;
    padding-left: 20px;
}

</style>
<style type="text/css">

pre.code .comment, code .comment { color: green }
pre.code .keyword, code .keyword { color: darkred; font-weight: bold }
pre.code .name.builtin, code .name.builtin { color: darkred; font-weight: bold }
pre.code .name.tag, code .name.tag { color: darkgreen }
pre.code .literal, code .literal { color: darkblue }
pre.code .literal.number, code .literal.number { color: blue }


/* HTTP Methods have class "name function" */
pre.code.http .name.function,  code.http .name.function { color: black; font-weight: bold }
/* HTTP Paths have class "name namespace" */
pre.code.http .name.namespace, code.http .name.namespace { color: darkgreen }
/* HTTP "HTTP" strings have class "keyword reserved" */
pre.code.http .keyword.reserved, code.http .keyword.reserved { color: black; font-weight: bold }
/* HTTP Header names have class "name attribute" */
pre.code.http .name.attribute, code.http .name.attribute { color: black; font-weight: bold }

</style>
<style type="text/css">

/*
 * nature.css_t
 * ~~~~~~~~~~~~
 *
 * Sphinx stylesheet -- nature theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- page layout ----------------------------------------------------------- */

body {
    font-family: Arial, sans-serif;
    font-size: 100%;
    /*background-color: #111;*/
    color: #555;
    margin: 0;
    padding: 0;
}

div.documentwrapper {
    float: left;
    width: 100%;
}

div.bodywrapper {
    margin: 0 0 0 230px;
}

hr {
    border: 1px solid #B1B4B6;
}

/*
div.document {
    background-color: #eee;
}
*/

div.document {
    background-color: #ffffff;
    color: #3E4349;
    padding: 0 30px 30px 30px;
    font-size: 0.9em;
}

div.footer {
    color: #555;
    width: 100%;
    padding: 13px 0;
    text-align: center;
    font-size: 75%;
}

div.footer a {
    color: #444;
    text-decoration: underline;
}

div.related {
    background-color: #6BA81E;
    line-height: 32px;
    color: #fff;
    text-shadow: 0px 1px 0 #444;
    font-size: 0.9em;
}

div.related a {
    color: #E2F3CC;
}

div.sphinxsidebar {
    font-size: 0.75em;
    line-height: 1.5em;
}

div.sphinxsidebarwrapper{
    padding: 20px 0;
}

div.sphinxsidebar h3,
div.sphinxsidebar h4 {
    font-family: Arial, sans-serif;
    color: #222;
    font-size: 1.2em;
    font-weight: normal;
    margin: 0;
    padding: 5px 10px;
    background-color: #ddd;
    text-shadow: 1px 1px 0 white
}

div.sphinxsidebar h4{
    font-size: 1.1em;
}

div.sphinxsidebar h3 a {
    color: #444;
}


div.sphinxsidebar p {
    color: #888;
    padding: 5px 20px;
}

div.sphinxsidebar p.topless {
}

div.sphinxsidebar ul {
    margin: 10px 20px;
    padding: 0;
    color: #000;
}

div.sphinxsidebar a {
    color: #444;
}

div.sphinxsidebar input {
    border: 1px solid #ccc;
    font-family: sans-serif;
    font-size: 1em;
}

div.sphinxsidebar input[type=text]{
    margin-left: 20px;
}

/* -- body styles ----------------------------------------------------------- */

a {
    color: #005B81;
    text-decoration: none;
}

a:hover {
    color: #E32E00;
    text-decoration: underline;
}

div.document h1,
div.document h2,
div.document h3,
div.document h4,
div.document h5,
div.document h6 {
    font-family: Arial, sans-serif;
    background-color: #BED4EB;
    font-weight: normal;
    color: #212224;
    margin: 30px 0px 10px 0px;
    padding: 5px 0 5px 10px;
    text-shadow: 0px 1px 0 white
}

div.document h1 { border-top: 20px solid white; margin-top: 0; font-size: 200%; }
div.document h2 { font-size: 150%; background-color: #C8D5E3; }
div.document h3 { font-size: 120%; background-color: #D8DEE3; }
div.document h4 { font-size: 110%; background-color: #D8DEE3; }
div.document h5 { font-size: 100%; background-color: #D8DEE3; }
div.document h6 { font-size: 100%; background-color: #D8DEE3; }

a.headerlink {
    color: #c60f0f;
    font-size: 0.8em;
    padding: 0 4px 0 4px;
    text-decoration: none;
}

a.headerlink:hover {
    background-color: #c60f0f;
    color: white;
}

div.document p, div.document dd, div.document li {
    line-height: 1.5em;
}

div.admonition p.admonition-title + p {
    display: inline;
}

div.highlight{
    background-color: white;
}

div.note {
    background-color: #eee;
    border: 1px solid #ccc;
}

div.seealso {
    background-color: #ffc;
    border: 1px solid #ff6;
}

div.topic {
    background-color: #eee;
}

div.warning {
    background-color: #ffe4e4;
    border: 1px solid #f66;
}

p.admonition-title {
    display: inline;
}

p.admonition-title:after {
    content: ":";
}

pre {
    padding: 10px;
    background-color: White;
    color: #222;
    line-height: 1.2em;
    border: 1px solid #C6C9CB;
    font-size: 1.1em;
    margin: 1.5em 0 1.5em 0;
    -webkit-box-shadow: 1px 1px 1px #d8d8d8;
    -moz-box-shadow: 1px 1px 1px #d8d8d8;
}

tt {
    background-color: #ecf0f3;
    color: #222;
    /* padding: 1px 2px; */
    font-size: 1.1em;
    font-family: monospace;
}

.viewcode-back {
    font-family: Arial, sans-serif;
}

div.viewcode-block:target {
    background-color: #f4debf;
    border-top: 1px solid #ac9;
    border-bottom: 1px solid #ac9;
}

ul li dd {
	margin-top: 0;
}

ul li dl {
	margin-bottom: 0;
}

li dl dd {
	margin-bottom: 0;
}

dd ul {
	padding-left: 0;
}

li dd ul {
	margin-bottom: 0;
}

table {
    margin-top: 10px;
    margin-bottom: 10px;
    border: 0;
    border-collapse: collapse;
}

td[colspan]:not([colspan="1"]) {
    background: #eeeeee;
    text-transform: capitalize;
}

thead {
    background: #eeeeee;
}

div.admonition-rationale {
    background-color: #efe;
    border: 1px solid #ccc;
}

div.admonition-example {
    background-color: #eef;
    border: 1px solid #ccc;
}


</style>
<style type="text/css">

/* Column with header cells */
table.docutils tbody th.stub {
    background: #eeeeee;
}

</style>
</head>
<body>
<div class="document" id="identity-service-api">
<h1 class="title">Identity Service API</h1>

<!-- Copyright 2016 OpenMarket Ltd -->
<!-- Copyright 2017 Kamax.io -->
<!-- Copyright 2017 New Vector Ltd -->
<!-- Copyright 2018 New Vector Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
<p>The Matrix client-server and server-server APIs are largely expressed in Matrix
user identifiers. From time to time, it is useful to refer to users by other
(&quot;third-party&quot;) identifiers, or &quot;3PID&quot;s, e.g. their email address or phone
number. This Identity Service Specification describes how mappings between
third-party identifiers and Matrix user identifiers can be established,
validated, and used. This description technically may apply to any 3PID, but in
practice has only been applied specifically to email addresses and phone numbers.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#changelog" id="id5">1&nbsp;&nbsp;&nbsp;Changelog</a><ul class="auto-toc">
<li><a class="reference internal" href="#other-versions-of-this-specification" id="id6">1.1&nbsp;&nbsp;&nbsp;Other versions of this specification</a></li>
</ul>
</li>
<li><a class="reference internal" href="#general-principles" id="id7">2&nbsp;&nbsp;&nbsp;General principles</a></li>
<li><a class="reference internal" href="#api-standards" id="id8">3&nbsp;&nbsp;&nbsp;API standards</a></li>
<li><a class="reference internal" href="#privacy" id="id9">4&nbsp;&nbsp;&nbsp;Privacy</a></li>
<li><a class="reference internal" href="#version-1-api-deprecation" id="id10">5&nbsp;&nbsp;&nbsp;Version 1 API deprecation</a></li>
<li><a class="reference internal" href="#web-browser-clients" id="id11">6&nbsp;&nbsp;&nbsp;Web browser clients</a></li>
<li><a class="reference internal" href="#authentication" id="id12">7&nbsp;&nbsp;&nbsp;Authentication</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-identity-v2-account-register" id="id13">7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/account/register</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v2-account" id="id14">7.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/account</tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-account-logout" id="id15">7.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/account/logout</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#terms-of-service" id="id16">8&nbsp;&nbsp;&nbsp;Terms of service</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-accepted-terms" id="id17">8.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.accepted_terms</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v2-terms" id="id18">8.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/terms</tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-terms" id="id19">8.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/terms</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#status-check" id="id20">9&nbsp;&nbsp;&nbsp;Status check</a><ul class="auto-toc">
<li><a class="reference internal" href="#deprecated-get-matrix-identity-api-v1" id="id21">9.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v2" id="id22">9.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#key-management" id="id23">10&nbsp;&nbsp;&nbsp;Key management</a><ul class="auto-toc">
<li><a class="reference internal" href="#deprecated-get-matrix-identity-api-v1-pubkey-keyid" id="id24">10.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET <span class="pre">/_matrix/identity/api/v1/pubkey/{keyId}</span></tt></a></li>
<li><a class="reference internal" href="#deprecated-get-matrix-identity-api-v1-pubkey-isvalid" id="id25">10.2&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/pubkey/isvalid</tt></a></li>
<li><a class="reference internal" href="#deprecated-get-matrix-identity-api-v1-pubkey-ephemeral-isvalid" id="id26">10.3&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/pubkey/ephemeral/isvalid</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v2-pubkey-keyid" id="id27">10.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/identity/v2/pubkey/{keyId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v2-pubkey-isvalid" id="id28">10.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/pubkey/isvalid</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v2-pubkey-ephemeral-isvalid" id="id29">10.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/pubkey/ephemeral/isvalid</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#association-lookup" id="id30">11&nbsp;&nbsp;&nbsp;Association lookup</a><ul class="auto-toc">
<li><a class="reference internal" href="#deprecated-get-matrix-identity-api-v1-lookup" id="id31">11.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/lookup</tt></a></li>
<li><a class="reference internal" href="#deprecated-post-matrix-identity-api-v1-bulk-lookup" id="id32">11.2&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/bulk_lookup</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v2-hash-details" id="id33">11.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/hash_details</tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-lookup" id="id34">11.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/lookup</tt></a></li>
<li><a class="reference internal" href="#client-behaviour" id="id35">11.5&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
<li><a class="reference internal" href="#server-behaviour" id="id36">11.6&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#algorithms" id="id37">11.7&nbsp;&nbsp;&nbsp;Algorithms</a><ul class="auto-toc">
<li><a class="reference internal" href="#sha256" id="id38">11.7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">sha256</tt></a></li>
<li><a class="reference internal" href="#none" id="id39">11.7.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">none</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#security-considerations" id="id40">11.8&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#establishing-associations" id="id41">12&nbsp;&nbsp;&nbsp;Establishing associations</a><ul class="auto-toc">
<li><a class="reference internal" href="#format-of-a-validation-token" id="id42">12.1&nbsp;&nbsp;&nbsp;Format of a validation token</a></li>
<li><a class="reference internal" href="#email-associations" id="id43">12.2&nbsp;&nbsp;&nbsp;Email associations</a><ul class="auto-toc">
<li><a class="reference internal" href="#deprecated-post-matrix-identity-api-v1-validate-email-requesttoken" id="id44">12.2.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/validate/email/requestToken</tt></a></li>
<li><a class="reference internal" href="#deprecated-post-matrix-identity-api-v1-validate-email-submittoken" id="id45">12.2.2&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/validate/email/submitToken</tt></a></li>
<li><a class="reference internal" href="#deprecated-get-matrix-identity-api-v1-validate-email-submittoken" id="id46">12.2.3&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/validate/email/submitToken</tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-validate-email-requesttoken" id="id47">12.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/validate/email/requestToken</tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-validate-email-submittoken" id="id48">12.2.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/validate/email/submitToken</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v2-validate-email-submittoken" id="id49">12.2.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/validate/email/submitToken</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#phone-number-associations" id="id50">12.3&nbsp;&nbsp;&nbsp;Phone number associations</a><ul class="auto-toc">
<li><a class="reference internal" href="#deprecated-post-matrix-identity-api-v1-validate-msisdn-requesttoken" id="id51">12.3.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/validate/msisdn/requestToken</tt></a></li>
<li><a class="reference internal" href="#deprecated-post-matrix-identity-api-v1-validate-msisdn-submittoken" id="id52">12.3.2&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/validate/msisdn/submitToken</tt></a></li>
<li><a class="reference internal" href="#deprecated-get-matrix-identity-api-v1-validate-msisdn-submittoken" id="id53">12.3.3&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/validate/msisdn/submitToken</tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-validate-msisdn-requesttoken" id="id54">12.3.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/validate/msisdn/requestToken</tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-validate-msisdn-submittoken" id="id55">12.3.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/validate/msisdn/submitToken</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v2-validate-msisdn-submittoken" id="id56">12.3.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/validate/msisdn/submitToken</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#general" id="id57">12.4&nbsp;&nbsp;&nbsp;General</a><ul class="auto-toc">
<li><a class="reference internal" href="#deprecated-get-matrix-identity-api-v1-3pid-getvalidated3pid" id="id58">12.4.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/3pid/getValidated3pid</tt></a></li>
<li><a class="reference internal" href="#deprecated-post-matrix-identity-api-v1-3pid-bind" id="id59">12.4.2&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/3pid/bind</tt></a></li>
<li><a class="reference internal" href="#deprecated-post-matrix-identity-api-v1-3pid-unbind" id="id60">12.4.3&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/3pid/unbind</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v2-3pid-getvalidated3pid" id="id61">12.4.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/3pid/getValidated3pid</tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-3pid-bind" id="id62">12.4.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/3pid/bind</tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-3pid-unbind" id="id63">12.4.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/3pid/unbind</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#invitation-storage" id="id64">13&nbsp;&nbsp;&nbsp;Invitation storage</a><ul class="auto-toc">
<li><a class="reference internal" href="#deprecated-post-matrix-identity-api-v1-store-invite" id="id65">13.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST <span class="pre">/_matrix/identity/api/v1/store-invite</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-store-invite" id="id66">13.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/identity/v2/store-invite</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#ephemeral-invitation-signing" id="id67">14&nbsp;&nbsp;&nbsp;Ephemeral invitation signing</a><ul class="auto-toc">
<li><a class="reference internal" href="#deprecated-post-matrix-identity-api-v1-sign-ed25519" id="id68">14.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST <span class="pre">/_matrix/identity/api/v1/sign-ed25519</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-identity-v2-sign-ed25519" id="id69">14.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/identity/v2/sign-ed25519</span></tt></a></li>
</ul>
</li>
</ul>
</div>
<p><a class="anchor" id="changelog"></a></p>
<div class="section" id="changelog">
<h1><a class="toc-backref" href="#id5">1&nbsp;&nbsp;&nbsp;Changelog</a></h1>
<div class="topic">
<p class="topic-title first">Version: r0.3.0</p>
<p>New Endpoints</p>
<ul class="simple">
<li>Add <tt class="docutils literal">/account</tt>, <tt class="docutils literal">/account/register</tt>, and <tt class="docutils literal">/account/logout</tt> to authenticate with the identity server. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2255">#2255</a>)</li>
<li>Add endpoints for accepting and handling terms of service. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2258">#2258</a>)</li>
<li>Add <tt class="docutils literal">/hash_details</tt> and a new <tt class="docutils literal">/lookup</tt> endpoint for performing hashed association lookups. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2287">#2287</a>)</li>
</ul>
<p>Backwards Compatible Changes</p>
<ul class="simple">
<li>Deprecate the v1 API in favour of an authenticated v2 API. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2254">#2254</a>)</li>
</ul>
</div>
<p>This version of the specification is generated from
<a class="reference external" href="https://github.com/matrix-org/matrix-doc">matrix-doc</a> as of Git commit
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/tree/7351c0cd">identity_service/release-r0.3.0,7351c0cd</a>.</p>
<p>For the full historical changelog, see
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/blob/main/changelogs/legacy/identity_service.rst">https://github.com/matrix-org/matrix-doc/blob/main/changelogs/legacy/identity_service.rst</a></p>
<p><a class="anchor" id="other-versions-of-this-specification"></a></p>
<div class="section" id="other-versions-of-this-specification">
<h2><a class="toc-backref" href="#id6">1.1&nbsp;&nbsp;&nbsp;Other versions of this specification</a></h2>
<p>The following other versions are also available, in reverse chronological order:</p>
<ul class="simple">
<li><a class="reference external" href="https://matrix.org/docs/spec/identity_service/unstable.html">HEAD</a>: Includes all changes since the latest versioned release.</li>
<li><a class="reference external" href="https://matrix.org/docs/spec/identity_service/r0.3.0.html">r0.3.0</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/identity_service/r0.2.1.html">r0.2.1</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/identity_service/r0.2.0.html">r0.2.0</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/identity_service/r0.1.0.html">r0.1.0</a></li>
</ul>
</div>
</div>
<p><a class="anchor" id="general-principles"></a></p>
<div class="section" id="general-principles">
<h1><a class="toc-backref" href="#id7">2&nbsp;&nbsp;&nbsp;General principles</a></h1>
<p>The purpose of an identity server is to validate, store, and answer questions
about the identities of users. In particular, it stores associations of the form
&quot;identifier X represents the same user as identifier Y&quot;, where identities may
exist on different systems (such as email addresses, phone numbers,
Matrix user IDs, etc).</p>
<p>The identity server has some private-public keypairs. When asked about an
association, it will sign details of the association with its private key.
Clients may validate the assertions about associations by verifying the signature
with the public key of the identity server.</p>
<p>In general, identity servers are treated as reliable oracles. They do not
necessarily provide evidence that they have validated associations, but claim to
have done so. Establishing the trustworthiness of an individual identity server
is left as an exercise for the client.</p>
<p>3PID types are described in <a class="reference external" href="../appendices.html#pid-types">3PID Types</a> Appendix.</p>
</div>
<p><a class="anchor" id="api-standards"></a></p>
<div class="section" id="api-standards">
<h1><a class="toc-backref" href="#id8">3&nbsp;&nbsp;&nbsp;API standards</a></h1>
<p>The mandatory baseline for identity server communication in Matrix is exchanging
JSON objects over HTTP APIs. HTTPS is required for communication, and all API calls
use a Content-Type of <tt class="docutils literal">application/json</tt>. In addition, strings MUST be encoded as
UTF-8.</p>
<p>Any errors which occur at the Matrix API level MUST return a &quot;standard error response&quot;.
This is a JSON object which looks like:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;error code&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;error message&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>The <tt class="docutils literal">error</tt> string will be a human-readable error message, usually a sentence
explaining what went wrong. The <tt class="docutils literal">errcode</tt> string will be a unique string
which can be used to handle an error message e.g. <tt class="docutils literal">M_FORBIDDEN</tt>. There may be
additional keys depending on the error, but the keys <tt class="docutils literal">error</tt> and <tt class="docutils literal">errcode</tt>
MUST always be present.</p>
<p>Some standard error codes are below:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name"><tt class="docutils literal">M_NOT_FOUND</tt>:</th><td class="field-body">The resource requested could not be located.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_MISSING_PARAMS</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The request was missing one or more parameters.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_INVALID_PARAM</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The request contained one or more invalid parameters.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_SESSION_NOT_VALIDATED</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The session has not been validated.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_NO_VALID_SESSION</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">A session could not be located for the given parameters.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_SESSION_EXPIRED</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The session has expired and must be renewed.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_INVALID_EMAIL</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The email address provided was not valid.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_EMAIL_SEND_ERROR</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">There was an error sending an email. Typically seen when attempting to verify
ownership of a given email address.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_INVALID_ADDRESS</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The provided third party address was not valid.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_SEND_ERROR</tt>:</th><td class="field-body">There was an error sending a notification. Typically seen when attempting to
verify ownership of a given third party address.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_UNRECOGNIZED</tt>:</th><td class="field-body">The request contained an unrecognised value, such as an unknown token or medium.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_THREEPID_IN_USE</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The third party identifier is already in use by another user. Typically this
error will have an additional <tt class="docutils literal">mxid</tt> property to indicate who owns the
third party identifier.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_UNKNOWN</tt>:</th><td class="field-body">An unknown error has occurred.</td>
</tr>
</tbody>
</table>
</div>
<p><a class="anchor" id="privacy"></a></p>
<div class="section" id="privacy">
<h1><a class="toc-backref" href="#id9">4&nbsp;&nbsp;&nbsp;Privacy</a></h1>
<p>Identity is a privacy-sensitive issue. While the identity server exists to
provide identity information, access should be restricted to avoid leaking
potentially sensitive data. In particular, being able to construct large-scale
connections between identities should be avoided. To this end, in general APIs
should allow a 3PID to be mapped to a Matrix user identity, but not in the other
direction (i.e. one should not be able to get all 3PIDs associated with a Matrix
user ID, or get all 3PIDs associated with a 3PID).</p>
</div>
<p><a class="anchor" id="version-1-api-deprecation"></a></p>
<div class="section" id="version-1-api-deprecation">
<h1><a class="toc-backref" href="#id10">5&nbsp;&nbsp;&nbsp;Version 1 API deprecation</a></h1>
<!-- TODO: Remove this section when the v1 API is removed. -->
<p>As described on each of the version 1 endpoints, the v1 API is deprecated in
favour of the v2 API described here. The major difference, with the exception
of a few isolated cases, is that the v2 API requires authentication to ensure
the user has given permission for the identity server to operate on their data.</p>
<p>The v1 API is planned to be removed from the specification in a future version.</p>
<p>Clients SHOULD attempt the v2 endpoints first, and if they receive a <tt class="docutils literal">404</tt>,
<tt class="docutils literal">400</tt>, or similar error they should try the v1 endpoint or fail the operation.
Clients are strongly encouraged to warn the user of the risks in using the v1 API,
if they are planning on using it.</p>
</div>
<p><a class="anchor" id="web-browser-clients"></a></p>
<div class="section" id="web-browser-clients">
<h1><a class="toc-backref" href="#id11">6&nbsp;&nbsp;&nbsp;Web browser clients</a></h1>
<p>It is realistic to expect that some clients will be written to be run within a web
browser or similar environment. In these cases, the identity server should respond to
pre-flight requests and supply Cross-Origin Resource Sharing (CORS) headers on all
requests.</p>
<p>When a client approaches the server with a pre-flight (OPTIONS) request, the server
should respond with the CORS headers for that route. The recommended CORS headers
to be returned by servers on all requests are:</p>
<pre class="literal-block">
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept, Authorization
</pre>
</div>
<p><a class="anchor" id="authentication"></a></p>
<div class="section" id="authentication">
<h1><a class="toc-backref" href="#id12">7&nbsp;&nbsp;&nbsp;Authentication</a></h1>
<p>Most <tt class="docutils literal">v2</tt> endpoints in the Identity Service API require authentication in order
to ensure that the requesting user has accepted all relevant policies and is otherwise
permitted to make the request. The <tt class="docutils literal">v1</tt> API (currently deprecated) does not require
this authentication, however using <tt class="docutils literal">v1</tt> is strongly discouraged as it will be removed
in a future release.</p>
<p>Identity Servers use a scheme similar to the Client-Server API's concept of access
tokens to authenticate users. The access tokens provided by an Identity Server cannot
be used to authenticate Client-Server API requests.</p>
<p>An access token is provided to an endpoint in one of two ways:</p>
<ol class="arabic simple">
<li>Via a query string parameter, <tt class="docutils literal">access_token=TheTokenHere</tt>.</li>
<li>Via a request header, <tt class="docutils literal">Authorization: Bearer TheTokenHere</tt>.</li>
</ol>
<p>Clients are encouraged to the use the <tt class="docutils literal">Authorization</tt> header where possible to prevent
the access token being leaked in access/HTTP logs. The query string should only be used
in cases where the <tt class="docutils literal">Authorization</tt> header is inaccessible for the client.</p>
<p>When credentials are required but missing or invalid, the HTTP call will return with a
status of 401 and the error code <tt class="docutils literal">M_UNAUTHORIZED</tt>.</p>
<p><a class="anchor" id="post-matrix-identity-v2-account-register"></a></p>
<div class="section" id="post-matrix-identity-v2-account-register">
<h2><a class="toc-backref" href="#id13">7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/account/register</tt></a></h2>
<p>Exchanges an OpenID token from the homeserver for an access token to
access the identity server. The request body is the same as the values
returned by <tt class="docutils literal">/openid/request_token</tt> in the Client-Server API.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>access_token</td>
<td>string</td>
<td><strong>Required.</strong> An access token the consumer may use
to verify the identity of the person who generated
the token. This is given to the federation API
<tt class="docutils literal">GET /openid/userinfo</tt> to verify the user's
identity.</td>
</tr>
<tr><td>token_type</td>
<td>string</td>
<td><strong>Required.</strong> The string <tt class="docutils literal">Bearer</tt>.</td>
</tr>
<tr><td>matrix_server_name</td>
<td>string</td>
<td><strong>Required.</strong> The homeserver domain the consumer
should use when attempting to verify the user's
identity.</td>
</tr>
<tr><td>expires_in</td>
<td>integer</td>
<td><strong>Required.</strong> The number of seconds before this
token expires and a new one must be generated.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> An opaque string representing the
token to authenticate future requests to the
identity server with.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/account/register</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;string&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;token_type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;string&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;matrix_server_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;string&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;expires_in&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A token which can be used to authenticate future requests to the
identity server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123_OpaqueString&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v2-account"></a></p>
<div class="section" id="get-matrix-identity-v2-account">
<h2><a class="toc-backref" href="#id14">7.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/account</tt></a></h2>
<p>Gets information about what user owns the access token used in the request.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The user ID which registered the
token.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v2/account</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The token holder's information.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-account-logout"></a></p>
<div class="section" id="post-matrix-identity-v2-account-logout">
<h2><a class="toc-backref" href="#id15">7.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/account/logout</tt></a></h2>
<p>Logs out the access token, preventing it from being used to authenticate
future requests to the server.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/account/logout</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The token was successfully logged out.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The token is not registered or is otherwise unknown to the server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN_TOKEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Unrecognised access token&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="terms-of-service"></a></p>
<div class="section" id="terms-of-service">
<span id="agree-to-more-terms"></span><h1><a class="toc-backref" href="#id16">8&nbsp;&nbsp;&nbsp;Terms of service</a></h1>
<p>Identity Servers are encouraged to have terms of service (or similar policies) to
ensure that users have agreed to their data being processed by the server. To facilitate
this, an identity server can respond to almost any authenticated API endpoint with a
HTTP 403 and the error code <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt>. The error code is used to indicate
that the user must accept new terms of service before being able to continue.</p>
<p>All endpoints which support authentication can return the <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error.
When clients receive the error, they are expected to make a call to <tt class="docutils literal">GET /terms</tt> to
find out what terms the server offers. The client compares this to the <tt class="docutils literal">m.accepted_terms</tt>
account data for the user (described later) and presents the user with option to accept
the still-missing terms of service. After the user has made their selection, if applicable,
the client sends a request to <tt class="docutils literal">POST /terms</tt> to indicate the user's acceptance. The
server cannot expect that the client will send acceptance for all pending terms, and the
client should not expect that the server will not respond with another <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt>
on their next request. The terms the user has just accepted are appended to <tt class="docutils literal">m.accepted_terms</tt>.</p>
<p><a class="anchor" id="m-accepted-terms"></a></p>
<div class="section" id="m-accepted-terms">
<h2><a class="toc-backref" href="#id17">8.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.accepted_terms</tt></a></h2>
<p>A list of terms URLs the user has previously accepted. Clients SHOULD use this
to avoid presenting the user with terms they have already agreed to.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>accepted</td>
<td>[string]</td>
<td>The list of URLs the user has previously accepted.
Should be appended to when the user agrees to new
terms.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;accepted&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;https://example.org/somewhere/terms-1.2-en.html&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;https://example.org/somewhere/privacy-1.2-en.html&quot;</span>
        <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.accepted_terms&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v2-terms"></a></p>
<div class="section" id="get-matrix-identity-v2-terms">
<h2><a class="toc-backref" href="#id18">8.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/terms</tt></a></h2>
<p>Gets all the terms of service offered by the server. The client is expected
to filter through the terms to determine which terms need acceptance from the
user. Note that this endpoint does not require authentication.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>policies</td>
<td>{string: Policy Object}</td>
<td><strong>Required.</strong> The policies the server offers.
Mapped from arbitrary ID (unused in this version
of the specification) to a Policy Object.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Policy Object</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>version</td>
<td>string</td>
<td><strong>Required.</strong> The version for the policy. There
are no requirements on what this might be and
could be &quot;alpha&quot;, semantically versioned, or
arbitrary.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v2/terms</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The terms of service offered by the server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;policies&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;terms_of_service&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;2.0&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;en&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Terms of Service&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/somewhere/terms-2.0-en.html&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;fr&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Conditions d'utilisation&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/somewhere/terms-2.0-fr.html&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;privacy_policy&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1.2&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;en&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Privacy Policy&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/somewhere/privacy-1.2-en.html&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;fr&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Politique de confidentialit\u00e9&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/somewhere/privacy-1.2-fr.html&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-terms"></a></p>
<div class="section" id="post-matrix-identity-v2-terms">
<h2><a class="toc-backref" href="#id19">8.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/terms</tt></a></h2>
<p>Called by a client to indicate that the user has accepted/agreed to the included
set of URLs. Servers MUST NOT assume that the client will be sending all previously
accepted URLs and should therefore append the provided URLs to what the server
already knows has been accepted.</p>
<p>Clients MUST provide the URL of the policy in the language that was presented
to the user. Servers SHOULD consider acceptance of any one language's URL as
acceptance for all other languages of that policy.</p>
<p>The server should avoid returning <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> because the client
may not be accepting all terms at once.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>user_accepts</td>
<td>[string]</td>
<td><strong>Required.</strong> The URLs the user is accepting in
this request.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/terms</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;user_accepts&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/somewhere/terms-2.0-en.html&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The server has considered the user as having accepted the provided URLs.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="status-check"></a></p>
<div class="section" id="status-check">
<h1><a class="toc-backref" href="#id20">9&nbsp;&nbsp;&nbsp;Status check</a></h1>
<p><a class="anchor" id="deprecated-get-matrix-identity-api-v1"></a></p>
<div class="section" id="deprecated-get-matrix-identity-api-v1">
<h2><a class="toc-backref" href="#id21">9.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1</tt></a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Checks that an identity server is available at this API endpoint.</p>
<p>To discover that an identity server is available at a specific URL,
this endpoint can be queried and will return an empty object.</p>
<p>This is primarly used for auto-discovery and health check purposes
by entities acting as a client for the identity server.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/api/v1</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>An identity server is ready to serve requests.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v2"></a></p>
<div class="section" id="get-matrix-identity-v2">
<h2><a class="toc-backref" href="#id22">9.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2</tt></a></h2>
<p>Checks that an identity server is available at this API endpoint.</p>
<p>To discover that an identity server is available at a specific URL,
this endpoint can be queried and will return an empty object.</p>
<p>This is primarly used for auto-discovery and health check purposes
by entities acting as a client for the identity server.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v2</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>An identity server is ready to serve requests.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="key-management"></a></p>
<div class="section" id="key-management">
<h1><a class="toc-backref" href="#id23">10&nbsp;&nbsp;&nbsp;Key management</a></h1>
<p>An identity server has some long-term public-private keypairs. These are named
in a scheme <tt class="docutils literal">algorithm:identifier</tt>, e.g. <tt class="docutils literal">ed25519:0</tt>. When signing an
association, the standard <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a> algorithm applies.</p>
<!-- TODO: Actually allow identity servers to revoke all keys
See: https://github.com/matrix-org/matrix-doc/issues/1633 -->
<!-- In the event of key compromise, the identity server may revoke any of its keys.
An HTTP API is offered to get public keys, and check whether a particular key is
valid. -->
<p>The identity server may also keep track of some short-term public-private
keypairs, which may have different usage and lifetime characteristics than the
service's long-term keys.</p>
<p><a class="anchor" id="deprecated-get-matrix-identity-api-v1-pubkey-keyid"></a></p>
<div class="section" id="deprecated-get-matrix-identity-api-v1-pubkey-keyid">
<h2><a class="toc-backref" href="#id24">10.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET <span class="pre">/_matrix/identity/api/v1/pubkey/{keyId}</span></tt></a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Get the public key for the passed key ID.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>keyId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the key. This should take
the form algorithm:identifier where algorithm
identifies the signing algorithm, and the
identifier is an opaque string.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>public_key</td>
<td>string</td>
<td><strong>Required.</strong> Unpadded Base64 encoded public key.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/api/v1/pubkey/ed25519%3A0</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The public key exists.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;public_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;VXuGitF39UH5iRfvbIknlvlAVKgD1BsLDMvBf0pmp7c&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The public key was not found.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The public key was not found&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="deprecated-get-matrix-identity-api-v1-pubkey-isvalid"></a></p>
<div class="section" id="deprecated-get-matrix-identity-api-v1-pubkey-isvalid">
<h2><a class="toc-backref" href="#id25">10.2&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/pubkey/isvalid</tt></a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Check whether a long-term public key is valid. The response should always
be the same, provided the key exists.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>public_key</td>
<td>string</td>
<td><strong>Required.</strong> The unpadded base64-encoded public
key to check.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>valid</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the public key is recognised
and is currently valid.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/api/v1/pubkey/isvalid?public_key=VXuGitF39UH5iRfvbIknlvlAVKgD1BsLDMvBf0pmp7c</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The validity of the public key.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;valid&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="deprecated-get-matrix-identity-api-v1-pubkey-ephemeral-isvalid"></a></p>
<div class="section" id="deprecated-get-matrix-identity-api-v1-pubkey-ephemeral-isvalid">
<h2><a class="toc-backref" href="#id26">10.3&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/pubkey/ephemeral/isvalid</tt></a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Check whether a short-term public key is valid.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>public_key</td>
<td>string</td>
<td><strong>Required.</strong> The unpadded base64-encoded public
key to check.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>valid</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the public key is recognised
and is currently valid.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/api/v1/pubkey/ephemeral/isvalid?public_key=VXuGitF39UH5iRfvbIknlvlAVKgD1BsLDMvBf0pmp7c</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The validity of the public key.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;valid&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v2-pubkey-keyid"></a></p>
<div class="section" id="get-matrix-identity-v2-pubkey-keyid">
<h2><a class="toc-backref" href="#id27">10.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/identity/v2/pubkey/{keyId}</span></tt></a></h2>
<p>Get the public key for the passed key ID.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>keyId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the key. This should take
the form algorithm:identifier where algorithm
identifies the signing algorithm, and the
identifier is an opaque string.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>public_key</td>
<td>string</td>
<td><strong>Required.</strong> Unpadded Base64 encoded public key.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v2/pubkey/ed25519%3A0</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The public key exists.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;public_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;VXuGitF39UH5iRfvbIknlvlAVKgD1BsLDMvBf0pmp7c&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The public key was not found.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The public key was not found&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v2-pubkey-isvalid"></a></p>
<div class="section" id="get-matrix-identity-v2-pubkey-isvalid">
<h2><a class="toc-backref" href="#id28">10.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/pubkey/isvalid</tt></a></h2>
<p>Check whether a long-term public key is valid. The response should always
be the same, provided the key exists.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>public_key</td>
<td>string</td>
<td><strong>Required.</strong> The unpadded base64-encoded public
key to check.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>valid</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the public key is recognised
and is currently valid.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v2/pubkey/isvalid?public_key=VXuGitF39UH5iRfvbIknlvlAVKgD1BsLDMvBf0pmp7c</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The validity of the public key.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;valid&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v2-pubkey-ephemeral-isvalid"></a></p>
<div class="section" id="get-matrix-identity-v2-pubkey-ephemeral-isvalid">
<h2><a class="toc-backref" href="#id29">10.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/pubkey/ephemeral/isvalid</tt></a></h2>
<p>Check whether a short-term public key is valid.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>public_key</td>
<td>string</td>
<td><strong>Required.</strong> The unpadded base64-encoded public
key to check.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>valid</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the public key is recognised
and is currently valid.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v2/pubkey/ephemeral/isvalid?public_key=VXuGitF39UH5iRfvbIknlvlAVKgD1BsLDMvBf0pmp7c</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The validity of the public key.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;valid&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="association-lookup"></a></p>
<div class="section" id="association-lookup">
<h1><a class="toc-backref" href="#id30">11&nbsp;&nbsp;&nbsp;Association lookup</a></h1>
<p><a class="anchor" id="deprecated-get-matrix-identity-api-v1-lookup"></a></p>
<div class="section" id="deprecated-get-matrix-identity-api-v1-lookup">
<h2><a class="toc-backref" href="#id31">11.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/lookup</tt></a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Look up the Matrix user ID for a 3pid.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The medium type of the 3pid. See the
<a class="reference external" href="../appendices.html#pid-types">3PID Types</a> Appendix.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The address of the 3pid being looked
up. See the <a class="reference external" href="../appendices.html#pid-types">3PID Types</a> Appendix.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The 3pid address of the user being
looked up, matching the address requested.</td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> A medium from the <a class="reference external" href="../appendices.html#pid-types">3PID Types</a>
Appendix, matching the medium requested.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID associated with
the 3pid.</td>
</tr>
<tr><td>not_before</td>
<td>integer</td>
<td><strong>Required.</strong> A unix timestamp before which the
association is not known to be valid.</td>
</tr>
<tr><td>not_after</td>
<td>integer</td>
<td><strong>Required.</strong> A unix timestamp after which the
association is not known to be valid.</td>
</tr>
<tr><td>ts</td>
<td>integer</td>
<td><strong>Required.</strong> The unix timestamp at which the
association was verified.</td>
</tr>
<tr><td>signatures</td>
<td>{string: {string: string}}</td>
<td><strong>Required.</strong> The signatures of the verifying
identity servers which show that the association
should be trusted, if you trust the verifying
identity servers.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/api/v1/lookup?medium=email&amp;address=louise%40bobs.burgers</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The association for that 3pid, or an empty object if no association is known.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;louise&#64;bobs.burgers&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;ears:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;not_before&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1428825849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;not_after&quot;</span><span class="punctuation">:</span> <span class="literal number integer">4582425849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1428825849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;matrix.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;ed25519:0&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ENiU2YORYUJgE6WBMitU0mppbQjidDLanAusj8XS2nVRHPu+0t42OKA/r6zV6i2MzUbNQ3c3MiLScJuSsOiVDQ&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="deprecated-post-matrix-identity-api-v1-bulk-lookup"></a></p>
<div class="section" id="deprecated-post-matrix-identity-api-v1-bulk-lookup">
<h2><a class="toc-backref" href="#id32">11.2&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/bulk_lookup</tt></a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Lookup Matrix user IDs for a list of 3pids.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>threepids</td>
<td>[[string, string]]</td>
<td><strong>Required.</strong> An array of arrays containing the
<a class="reference external" href="../appendices.html#pid-types">3PID Types</a> with the <tt class="docutils literal">medium</tt> in first
position and the <tt class="docutils literal">address</tt> in second position.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>threepids</td>
<td>[[string, string, string]]</td>
<td><strong>Required.</strong> An array of array containing the
<a class="reference external" href="../appendices.html#pid-types">3PID Types</a> with the <tt class="docutils literal">medium</tt> in first
position, the <tt class="docutils literal">address</tt> in second position and
Matrix user ID in third position.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/api/v1/bulk_lookup</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;threepids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">[</span>
      <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;user&#64;example.org&quot;</span>
    <span class="punctuation">],</span>
    <span class="punctuation">[</span>
      <span class="literal string double">&quot;msisdn&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;123456789&quot;</span>
    <span class="punctuation">],</span>
    <span class="punctuation">[</span>
      <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;user2&#64;example.org&quot;</span>
    <span class="punctuation">]</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of known 3PID mappings for the supplied 3PIDs.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;threepids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">[</span>
      <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;user&#64;example.org&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;&#64;bla:example.org&quot;</span>
    <span class="punctuation">],</span>
    <span class="punctuation">[</span>
      <span class="literal string double">&quot;msisdn&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;123456789&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;&#64;blah2:example.com&quot;</span>
    <span class="punctuation">]</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v2-hash-details"></a></p>
<div class="section" id="get-matrix-identity-v2-hash-details">
<h2><a class="toc-backref" href="#id33">11.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/hash_details</tt></a></h2>
<p>Gets parameters for hashing identifiers from the server. This can include
any of the algorithms defined in this specification.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>lookup_pepper</td>
<td>string</td>
<td><p class="first"><strong>Required.</strong> The pepper the client MUST use in
hashing identifiers, and MUST supply to the
<tt class="docutils literal">/lookup</tt> endpoint when performing lookups.</p>
<p class="last">Servers SHOULD rotate this string often.</p>
</td>
</tr>
<tr><td>algorithms</td>
<td>[string]</td>
<td><strong>Required.</strong> The algorithms the server supports.
Must contain at least <tt class="docutils literal">sha256</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v2/hash_details</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The hash function information.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;lookup_pepper&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;matrixrocks&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;algorithms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;none&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;sha256&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-lookup"></a></p>
<div class="section" id="post-matrix-identity-v2-lookup">
<h2><a class="toc-backref" href="#id34">11.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/lookup</tt></a></h2>
<p>Looks up the set of Matrix User IDs which have bound the 3PIDs given, if
bindings are available. Note that the format of the addresses is defined
later in this specification.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>algorithm</td>
<td>string</td>
<td><strong>Required.</strong> The algorithm the client is using to
encode the <tt class="docutils literal">addresses</tt>. This should be one of
the available options from <tt class="docutils literal">/hash_details</tt>.</td>
</tr>
<tr><td>pepper</td>
<td>string</td>
<td><strong>Required.</strong> The pepper from <tt class="docutils literal">/hash_details</tt>.
This is required even when the <tt class="docutils literal">algorithm</tt> does
not make use of it.</td>
</tr>
<tr><td>addresses</td>
<td>[string]</td>
<td><strong>Required.</strong> The addresses to look up. The format
of the entries here depend on the <tt class="docutils literal">algorithm</tt>
used. Note that queries which have been
incorrectly hashed or formatted will lead to no
matches.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mappings</td>
<td>{string: string}</td>
<td><strong>Required.</strong> Any applicable mappings of
<tt class="docutils literal">addresses</tt> to Matrix User IDs. Addresses which
do not have associations will not be included,
which can make this property be an empty object.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/lookup</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sha256&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;pepper&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;matrixrocks&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;addresses&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;4kenr7N9drpCJ4AfalmlGQVsOn3o2RHjkADUpXJWZUc&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;nlo35_T5fzSGZzJApqu8lgIudJvmOQtDaHtr-I4rU7I&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The associations for any matched <tt class="docutils literal">addresses</tt>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;4kenr7N9drpCJ4AfalmlGQVsOn3o2RHjkADUpXJWZUc&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The client's request was invalid in some way. One possible problem could be the <tt class="docutils literal">pepper</tt> being invalid after the server has rotated it - this is presented with the <tt class="docutils literal">M_INVALID_PEPPER</tt> error code. Clients SHOULD make a call to <tt class="docutils literal">/hash_details</tt> to get a new pepper in this scenario, being careful to avoid retry loops.
<tt class="docutils literal">M_INVALID_PARAM</tt> can also be returned to indicate the client supplied an <tt class="docutils literal">algorithm</tt> that is unknown to the server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_INVALID_PEPPER&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Unknown or invalid pepper - has it been rotated?&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="client-behaviour"></a></p>
<div class="section" id="client-behaviour">
<h2><a class="toc-backref" href="#id35">11.5&nbsp;&nbsp;&nbsp;Client behaviour</a></h2>
<!-- TODO: Remove this note when v1 is removed completely -->
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section only covers the v2 lookup endpoint. The v1 endpoint is described
in isolation above.</p>
</div>
<p>Prior to performing a lookup clients SHOULD make a request to the <tt class="docutils literal">/hash_details</tt>
endpoint to determine what algorithms the server supports (described in more detail
below). The client then uses this information to form a <tt class="docutils literal">/lookup</tt> request and
receive known bindings from the server.</p>
<p>Clients MUST support at least the <tt class="docutils literal">sha256</tt> algorithm.</p>
</div>
<p><a class="anchor" id="server-behaviour"></a></p>
<div class="section" id="server-behaviour">
<h2><a class="toc-backref" href="#id36">11.6&nbsp;&nbsp;&nbsp;Server behaviour</a></h2>
<!-- TODO: Remove this note when v1 is removed completely -->
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section only covers the v2 lookup endpoint. The v1 endpoint is described
in isolation above.</p>
</div>
<p>Servers, upon receipt of a <tt class="docutils literal">/lookup</tt> request, will compare the query against
known bindings it has, hashing the identifiers it knows about as needed to
verify exact matches to the request.</p>
<p>Servers MUST support at least the <tt class="docutils literal">sha256</tt> algorithm.</p>
</div>
<p><a class="anchor" id="algorithms"></a></p>
<div class="section" id="algorithms">
<h2><a class="toc-backref" href="#id37">11.7&nbsp;&nbsp;&nbsp;Algorithms</a></h2>
<p>Some algorithms are defined as part of the specification, however other formats
can be negotiated between the client and server using <tt class="docutils literal">/hash_details</tt>.</p>
<p><a class="anchor" id="sha256"></a></p>
<div class="section" id="sha256">
<h3><a class="toc-backref" href="#id38">11.7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">sha256</tt></a></h3>
<p>This algorithm MUST be supported by clients and servers at a minimum. It is
additionally the preferred algorithm for lookups.</p>
<p>When using this algorithm, the client converts the query first into strings
separated by spaces in the format <tt class="docutils literal">&lt;address&gt; &lt;medium&gt; &lt;pepper&gt;</tt>. The <tt class="docutils literal">&lt;pepper&gt;</tt>
is retrieved from <tt class="docutils literal">/hash_details</tt>, the <tt class="docutils literal">&lt;medium&gt;</tt> is typically <tt class="docutils literal">email</tt> or
<tt class="docutils literal">msisdn</tt> (both lowercase), and the <tt class="docutils literal">&lt;address&gt;</tt> is the 3PID to search for.
For example, if the client wanted to know about <tt class="docutils literal">alice&#64;example.org</tt>'s bindings,
it would first format the query as <tt class="docutils literal">alice&#64;example.org email ThePepperGoesHere</tt>.</p>
<div class="admonition admonition-rationale">
<p class="first admonition-title">Rationale</p>
<p class="last">Mediums and peppers are appended to the address to prevent a common prefix
for each 3PID, helping prevent attackers from pre-computing the internal state
of the hash function.</p>
</div>
<p>After formatting each query, the string is run through SHA-256 as defined by
<a class="reference external" href="https://tools.ietf.org/html/rfc4634">RFC 4634</a>. The resulting bytes are then
encoded using URL-Safe <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a> (similar to <a class="reference external" href="../../rooms/v4.html#event-ids">room version 4's
event ID format</a>).</p>
<p>An example set of queries when using the pepper <tt class="docutils literal">matrixrocks</tt> would be:</p>
<pre class="literal-block">
&quot;alice&#64;example.com email matrixrocks&quot; -&gt; &quot;4kenr7N9drpCJ4AfalmlGQVsOn3o2RHjkADUpXJWZUc&quot;
&quot;bob&#64;example.com email matrixrocks&quot;   -&gt; &quot;LJwSazmv46n0hlMlsb_iYxI0_HXEqy_yj6Jm636cdT8&quot;
&quot;18005552067 msisdn matrixrocks&quot;      -&gt; &quot;nlo35_T5fzSGZzJApqu8lgIudJvmOQtDaHtr-I4rU7I&quot;
</pre>
<p>The set of hashes is then given as the <tt class="docutils literal">addresses</tt> array in <tt class="docutils literal">/lookup</tt>. Note
that the pepper used MUST be supplied as <tt class="docutils literal">pepper</tt> in the <tt class="docutils literal">/lookup</tt> request.</p>
</div>
<p><a class="anchor" id="none"></a></p>
<div class="section" id="none">
<h3><a class="toc-backref" href="#id39">11.7.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">none</tt></a></h3>
<p>This algorithm performs plaintext lookups on the identity server. Typically this
algorithm should not be used due to the security concerns of unhashed identifiers,
however some scenarios (such as LDAP-backed identity servers) prevent the use of
hashed identifiers. Identity servers (and optionally clients) can use this algorithm
to perform those kinds of lookups.</p>
<p>Similar to the <tt class="docutils literal">sha256</tt> algorithm, the client converts the queries into strings
separated by spaces in the format <tt class="docutils literal">&lt;address&gt; &lt;medium&gt;</tt> - note the lack of <tt class="docutils literal">&lt;pepper&gt;</tt>.
For example, if the client wanted to know about <tt class="docutils literal">alice&#64;example.org</tt>'s bindings,
it would format the query as <tt class="docutils literal">alice&#64;example.org email</tt>.</p>
<p>The formatted strings are then given as the <tt class="docutils literal">addresses</tt> in <tt class="docutils literal">/lookup</tt>. Note that
the <tt class="docutils literal">pepper</tt> is still required, and must be provided to ensure the client has made
an appropriate request to <tt class="docutils literal">/hash_details</tt> first.</p>
</div>
</div>
<p><a class="anchor" id="security-considerations"></a></p>
<div class="section" id="security-considerations">
<h2><a class="toc-backref" href="#id40">11.8&nbsp;&nbsp;&nbsp;Security considerations</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="https://github.com/matrix-org/matrix-doc/pull/2134">MSC2134</a> has much more
information about the security considerations made for this section of the
specification. This section covers the high-level details for why the specification
is the way it is.</p>
</div>
<p>Typically the lookup endpoint is used when a client has an unknown 3PID it wants to
find a Matrix User ID for. Clients normally do this kind of lookup when inviting new
users to a room or searching a user's address book to find any Matrix users they may
not have discovered yet. Rogue or malicious identity servers could harvest this
unknown information and do nefarious things with it if it were sent in plain text.
In order to protect the privacy of users who might not have a Matrix identifier bound
to their 3PID addresses, the specification attempts to make it difficult to harvest
3PIDs.</p>
<div class="admonition admonition-rationale">
<p class="first admonition-title">Rationale</p>
<p>Hashing identifiers, while not perfect, helps make the effort required to harvest
identifiers significantly higher. Phone numbers in particular are still difficult
to protect with hashing, however hashing is objectively better than not.</p>
<p class="last">An alternative to hashing would be using bcrypt or similar with many rounds, however
by nature of needing to serve mobile clients and clients on limited hardware the
solution needs be kept relatively lightweight.</p>
</div>
<p>Clients should be cautious of servers not rotating their pepper very often, and
potentially of servers which use a weak pepper - these servers may be attempting to
brute force the identifiers or use rainbow tables to mine the addresses. Similarly,
clients which support the <tt class="docutils literal">none</tt> algorithm should consider at least warning the user
of the risks in sending identifiers in plain text to the identity server.</p>
<p>Addresses are still potentially reversable using a calculated rainbow table given
some identifiers, such as phone numbers, common email address domains, and leaked
addresses are easily calculated. For example, phone numbers can have roughly 12
digits to them, making them an easier target for attack than email addresses.</p>
</div>
</div>
<p><a class="anchor" id="establishing-associations"></a></p>
<div class="section" id="establishing-associations">
<h1><a class="toc-backref" href="#id41">12&nbsp;&nbsp;&nbsp;Establishing associations</a></h1>
<p>The flow for creating an association is session-based.</p>
<p>Within a session, one may prove that one has ownership of a 3PID.
Once this has been established, the user can form an association between that
3PID and a Matrix user ID. Note that this association is only proved one way;
a user can associate <em>any</em> Matrix user ID with a validated 3PID,
i.e. I can claim that any email address I own is associated with
&#64;billg:microsoft.com.</p>
<p>Sessions are time-limited; a session is considered to have been modified when
it was created, and then when a validation is performed within it. A session can
only be checked for validation, and validation can only be performed within a
session, within a 24 hour period since its most recent modification. Any
attempts to perform these actions after the expiry will be rejected, and a new
session should be created and used instead.</p>
<p>To start a session, the client makes a request to the appropriate
<tt class="docutils literal">/requestToken</tt> endpoint. The identity server then sends a validation token
to the user, and the user provides the token to the client. The client then
provides the token to the appropriate <tt class="docutils literal">/submitToken</tt> endpoint, completing the
session. At this point, the client should <tt class="docutils literal">/bind</tt> the third party identifier
or leave it for another entity to bind.</p>
<p><a class="anchor" id="format-of-a-validation-token"></a></p>
<div class="section" id="format-of-a-validation-token">
<h2><a class="toc-backref" href="#id42">12.1&nbsp;&nbsp;&nbsp;Format of a validation token</a></h2>
<p>The format of the validation token is left up to the identity server: it
should choose one appropriate to the 3PID type. (For example, it would be
inappropriate to expect a user to copy a long passphrase including punctuation
from an SMS message into a client.)</p>
<p>Whatever format the identity server uses, the validation token must consist of
at most 255 Unicode codepoints. Clients must pass the token through without
modification.</p>
</div>
<p><a class="anchor" id="email-associations"></a></p>
<div class="section" id="email-associations">
<h2><a class="toc-backref" href="#id43">12.2&nbsp;&nbsp;&nbsp;Email associations</a></h2>
<p><a class="anchor" id="deprecated-post-matrix-identity-api-v1-validate-email-requesttoken"></a></p>
<div class="section" id="deprecated-post-matrix-identity-api-v1-validate-email-requesttoken">
<h3><a class="toc-backref" href="#id44">12.2.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/validate/email/requestToken</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Create a session for validating an email address.</p>
<p>The identity server will send an email containing a token. If that
token is presented to the identity server in the future, it indicates
that that user was able to read the email for that email address, and
so we validate ownership of the email address.</p>
<p>Note that homeservers offer APIs that proxy this API, adding
additional behaviour on top, for example,
<tt class="docutils literal">/register/email/requestToken</tt> is designed specifically for use when
registering an account and therefore will inform the user if the email
address given is already registered on the server.</p>
<p>Note: for backwards compatibility with previous drafts of this
specification, the parameters may also be specified as
<tt class="docutils literal"><span class="pre">application/x-form-www-urlencoded</span></tt> data.  However, this usage is
deprecated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> A unique string generated by the
client, and used to identify the validation
attempt. It must be a string consisting of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must
not exceed 255 characters and it must not be
empty.</td>
</tr>
<tr><td>email</td>
<td>string</td>
<td><strong>Required.</strong> The email address to validate.</td>
</tr>
<tr><td>send_attempt</td>
<td>integer</td>
<td><strong>Required.</strong> The server will only send an email
if the <tt class="docutils literal">send_attempt</tt> is a number greater than
the most recent one which it has seen, scoped to
that <tt class="docutils literal">email</tt> + <tt class="docutils literal">client_secret</tt> pair. This is
to avoid repeatedly sending the same email in the
case of request retries between the POSTing user
and the identity server. The client should
increment this value if they desire a new email
(e.g. a reminder) to be sent. If they do not, the
server should respond with success but not resend
the email.</td>
</tr>
<tr><td>next_link</td>
<td>string</td>
<td>Optional. When the validation is completed, the
identity server will redirect the user to this
URL. This option is ignored when submitting 3PID
validation information through a POST request.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID. Session IDs are
opaque strings generated by the identity server.
They must consist entirely of the characters
<tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Their length must not exceed
255 characters and they must not be empty.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/api/v1/validate/email/requestToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;email&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&#64;example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;send_attempt&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Session created.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;123abc&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>An error ocurred.  Some possible errors are:</p>
<ul class="simple">
<li><tt class="docutils literal">M_INVALID_EMAIL</tt>: The email address provided was invalid.</li>
<li><tt class="docutils literal">M_EMAIL_SEND_ERROR</tt>: The validation email could not be sent.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_INVALID_EMAIL&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The email address is not valid&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="deprecated-post-matrix-identity-api-v1-validate-email-submittoken"></a></p>
<div class="section" id="deprecated-post-matrix-identity-api-v1-validate-email-submittoken">
<h3><a class="toc-backref" href="#id45">12.2.2&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/validate/email/submitToken</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Validate ownership of an email address.</p>
<p>If the three parameters are consistent with a set generated by a
<tt class="docutils literal">requestToken</tt> call, ownership of the email address is considered to
have been validated. This does not publish any information publicly, or
associate the email address with any Matrix user ID. Specifically,
calls to <tt class="docutils literal">/lookup</tt> will not show a binding.</p>
<p>The identity server is free to match the token case-insensitively, or
carry out other mapping operations such as unicode
normalisation. Whether to do so is an implementation detail for the
identity server. Clients must always pass on the token without
modification.</p>
<p>Note: for backwards compatibility with previous drafts of this
specification, the parameters may also be specified as
<tt class="docutils literal"><span class="pre">application/x-form-www-urlencoded</span></tt> data.  However, this usage is
deprecated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID, generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret that was supplied
to the <tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token generated by the
<tt class="docutils literal">requestToken</tt> call and emailed to the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>success</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the validation was
successful or not.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/api/v1/validate/email/submitToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1234&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;atoken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The success of the validation.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;success&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="deprecated-get-matrix-identity-api-v1-validate-email-submittoken"></a></p>
<div class="section" id="deprecated-get-matrix-identity-api-v1-validate-email-submittoken">
<h3><a class="toc-backref" href="#id46">12.2.3&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/validate/email/submitToken</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Validate ownership of an email address.</p>
<p>If the three parameters are consistent with a set generated by a
<tt class="docutils literal">requestToken</tt> call, ownership of the email address is considered to
have been validated. This does not publish any information publicly, or
associate the email address with any Matrix user ID. Specifically,
calls to <tt class="docutils literal">/lookup</tt> will not show a binding.</p>
<p>Note that, in contrast with the POST version, this endpoint will be
used by end-users, and so the response should be human-readable.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID, generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret that was supplied
to the <tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token generated by the
<tt class="docutils literal">requestToken</tt> call and emailed to the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/api/v1/validate/email/submitToken?sid=1234&amp;client_secret=monkeys_are_GREAT&amp;token=atoken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Email address is validated.</p>
<p><strong>Status code 3xx:</strong></p>
<p>Email address is validated, and the <tt class="docutils literal">next_link</tt> parameter was
provided to the <tt class="docutils literal">requestToken</tt> call.  The user must be redirected
to the URL provided by the <tt class="docutils literal">next_link</tt> parameter.</p>
<p><strong>Status code 4xx:</strong></p>
<p>Validation failed.</p>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-validate-email-requesttoken"></a></p>
<div class="section" id="post-matrix-identity-v2-validate-email-requesttoken">
<h3><a class="toc-backref" href="#id47">12.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/validate/email/requestToken</tt></a></h3>
<p>Create a session for validating an email address.</p>
<p>The identity server will send an email containing a token. If that
token is presented to the identity server in the future, it indicates
that that user was able to read the email for that email address, and
so we validate ownership of the email address.</p>
<p>Note that homeservers offer APIs that proxy this API, adding
additional behaviour on top, for example,
<tt class="docutils literal">/register/email/requestToken</tt> is designed specifically for use when
registering an account and therefore will inform the user if the email
address given is already registered on the server.</p>
<p>Note: for backwards compatibility with previous drafts of this
specification, the parameters may also be specified as
<tt class="docutils literal"><span class="pre">application/x-form-www-urlencoded</span></tt> data.  However, this usage is
deprecated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> A unique string generated by the
client, and used to identify the validation
attempt. It must be a string consisting of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must
not exceed 255 characters and it must not be
empty.</td>
</tr>
<tr><td>email</td>
<td>string</td>
<td><strong>Required.</strong> The email address to validate.</td>
</tr>
<tr><td>send_attempt</td>
<td>integer</td>
<td><strong>Required.</strong> The server will only send an email
if the <tt class="docutils literal">send_attempt</tt> is a number greater than
the most recent one which it has seen, scoped to
that <tt class="docutils literal">email</tt> + <tt class="docutils literal">client_secret</tt> pair. This is
to avoid repeatedly sending the same email in the
case of request retries between the POSTing user
and the identity server. The client should
increment this value if they desire a new email
(e.g. a reminder) to be sent. If they do not, the
server should respond with success but not resend
the email.</td>
</tr>
<tr><td>next_link</td>
<td>string</td>
<td>Optional. When the validation is completed, the
identity server will redirect the user to this
URL. This option is ignored when submitting 3PID
validation information through a POST request.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID. Session IDs are
opaque strings generated by the identity server.
They must consist entirely of the characters
<tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Their length must not exceed
255 characters and they must not be empty.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/validate/email/requestToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;email&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&#64;example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;send_attempt&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Session created.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;123abc&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>An error ocurred.  Some possible errors are:</p>
<ul class="simple">
<li><tt class="docutils literal">M_INVALID_EMAIL</tt>: The email address provided was invalid.</li>
<li><tt class="docutils literal">M_EMAIL_SEND_ERROR</tt>: The validation email could not be sent.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_INVALID_EMAIL&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The email address is not valid&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-validate-email-submittoken"></a></p>
<div class="section" id="post-matrix-identity-v2-validate-email-submittoken">
<h3><a class="toc-backref" href="#id48">12.2.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/validate/email/submitToken</tt></a></h3>
<p>Validate ownership of an email address.</p>
<p>If the three parameters are consistent with a set generated by a
<tt class="docutils literal">requestToken</tt> call, ownership of the email address is considered to
have been validated. This does not publish any information publicly, or
associate the email address with any Matrix user ID. Specifically,
calls to <tt class="docutils literal">/lookup</tt> will not show a binding.</p>
<p>The identity server is free to match the token case-insensitively, or
carry out other mapping operations such as unicode
normalisation. Whether to do so is an implementation detail for the
identity server. Clients must always pass on the token without
modification.</p>
<p>Note: for backwards compatibility with previous drafts of this
specification, the parameters may also be specified as
<tt class="docutils literal"><span class="pre">application/x-form-www-urlencoded</span></tt> data.  However, this usage is
deprecated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID, generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret that was supplied
to the <tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token generated by the
<tt class="docutils literal">requestToken</tt> call and emailed to the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>success</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the validation was
successful or not.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/validate/email/submitToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1234&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;atoken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The success of the validation.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;success&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v2-validate-email-submittoken"></a></p>
<div class="section" id="get-matrix-identity-v2-validate-email-submittoken">
<h3><a class="toc-backref" href="#id49">12.2.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/validate/email/submitToken</tt></a></h3>
<p>Validate ownership of an email address.</p>
<p>If the three parameters are consistent with a set generated by a
<tt class="docutils literal">requestToken</tt> call, ownership of the email address is considered to
have been validated. This does not publish any information publicly, or
associate the email address with any Matrix user ID. Specifically,
calls to <tt class="docutils literal">/lookup</tt> will not show a binding.</p>
<p>Note that, in contrast with the POST version, this endpoint will be
used by end-users, and so the response should be human-readable.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID, generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret that was supplied
to the <tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token generated by the
<tt class="docutils literal">requestToken</tt> call and emailed to the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v2/validate/email/submitToken?sid=1234&amp;client_secret=monkeys_are_GREAT&amp;token=atoken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Email address is validated.</p>
<p><strong>Status code 3xx:</strong></p>
<p>Email address is validated, and the <tt class="docutils literal">next_link</tt> parameter was
provided to the <tt class="docutils literal">requestToken</tt> call.  The user must be redirected
to the URL provided by the <tt class="docutils literal">next_link</tt> parameter.</p>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 4xx:</strong></p>
<p>Validation failed.</p>
</div>
</div>
<p><a class="anchor" id="phone-number-associations"></a></p>
<div class="section" id="phone-number-associations">
<h2><a class="toc-backref" href="#id50">12.3&nbsp;&nbsp;&nbsp;Phone number associations</a></h2>
<p><a class="anchor" id="deprecated-post-matrix-identity-api-v1-validate-msisdn-requesttoken"></a></p>
<div class="section" id="deprecated-post-matrix-identity-api-v1-validate-msisdn-requesttoken">
<h3><a class="toc-backref" href="#id51">12.3.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/validate/msisdn/requestToken</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Create a session for validating a phone number.</p>
<p>The identity server will send an SMS message containing a token. If
that token is presented to the identity server in the future, it
indicates that that user was able to read the SMS for that phone
number, and so we validate ownership of the phone number.</p>
<p>Note that homeservers offer APIs that proxy this API, adding
additional behaviour on top, for example,
<tt class="docutils literal">/register/msisdn/requestToken</tt> is designed specifically for use when
registering an account and therefore will inform the user if the phone
number given is already registered on the server.</p>
<p>Note: for backwards compatibility with previous drafts of this
specification, the parameters may also be specified as
<tt class="docutils literal"><span class="pre">application/x-form-www-urlencoded</span></tt> data. However, this usage is
deprecated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> A unique string generated by the
client, and used to identify the validation
attempt. It must be a string consisting of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must
not exceed 255 characters and it must not be
empty.</td>
</tr>
<tr><td>country</td>
<td>string</td>
<td><strong>Required.</strong> The two-letter uppercase ISO-3166-1
alpha-2 country code that the number in
<tt class="docutils literal">phone_number</tt> should be parsed as if it were
dialled from.</td>
</tr>
<tr><td>phone_number</td>
<td>string</td>
<td><strong>Required.</strong> The phone number to validate.</td>
</tr>
<tr><td>send_attempt</td>
<td>integer</td>
<td><strong>Required.</strong> The server will only send an SMS if
the <tt class="docutils literal">send_attempt</tt> is a number greater than the
most recent one which it has seen, scoped to that
<tt class="docutils literal">country</tt> + <tt class="docutils literal">phone_number</tt> + <tt class="docutils literal">client_secret</tt>
triple. This is to avoid repeatedly sending the
same SMS in the case of request retries between
the POSTing user and the identity server. The
client should increment this value if they desire
a new SMS (e.g. a reminder) to be sent.</td>
</tr>
<tr><td>next_link</td>
<td>string</td>
<td>Optional. When the validation is completed, the
identity server will redirect the user to this
URL. This option is ignored when submitting 3PID
validation information through a POST request.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID. Session IDs are
opaque strings generated by the identity server.
They must consist entirely of the characters
<tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Their length must not exceed
255 characters and they must not be empty.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/api/v1/validate/msisdn/requestToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;country&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;GB&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;phone_number&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;07700900001&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;send_attempt&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Session created.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;123abc&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>An error ocurred. Some possible errors are:</p>
<ul class="simple">
<li><tt class="docutils literal">M_INVALID_ADDRESS</tt>: The phone number provided was invalid.</li>
<li><tt class="docutils literal">M_SEND_ERROR</tt>: The validation SMS could not be sent.</li>
<li><tt class="docutils literal">M_DESTINATION_REJECTED</tt>: The identity server cannot deliver an
SMS to the provided country or region.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_INVALID_ADDRESS&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The phone number is not valid&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="deprecated-post-matrix-identity-api-v1-validate-msisdn-submittoken"></a></p>
<div class="section" id="deprecated-post-matrix-identity-api-v1-validate-msisdn-submittoken">
<h3><a class="toc-backref" href="#id52">12.3.2&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/validate/msisdn/submitToken</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Validate ownership of a phone number.</p>
<p>If the three parameters are consistent with a set generated by a
<tt class="docutils literal">requestToken</tt> call, ownership of the phone number is considered to
have been validated. This does not publish any information publicly, or
associate the phone number address with any Matrix user
ID. Specifically, calls to <tt class="docutils literal">/lookup</tt> will not show a binding.</p>
<p>The identity server is free to match the token case-insensitively, or
carry out other mapping operations such as unicode
normalisation. Whether to do so is an implementation detail for the
identity server. Clients must always pass on the token without
modification.</p>
<p>Note: for backwards compatibility with previous drafts of this
specification, the parameters may also be specified as
<tt class="docutils literal"><span class="pre">application/x-form-www-urlencoded</span></tt> data. However, this usage is
deprecated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID, generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret that was supplied
to the <tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token generated by the
<tt class="docutils literal">requestToken</tt> call and sent to the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>success</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the validation was
successful or not.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/api/v1/validate/msisdn/submitToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1234&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;atoken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The success of the validation.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;success&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="deprecated-get-matrix-identity-api-v1-validate-msisdn-submittoken"></a></p>
<div class="section" id="deprecated-get-matrix-identity-api-v1-validate-msisdn-submittoken">
<h3><a class="toc-backref" href="#id53">12.3.3&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/validate/msisdn/submitToken</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Validate ownership of a phone number.</p>
<p>If the three parameters are consistent with a set generated by a
<tt class="docutils literal">requestToken</tt> call, ownership of the phone number address is
considered to have been validated. This does not publish any
information publicly, or associate the phone number with any Matrix
user ID. Specifically, calls to <tt class="docutils literal">/lookup</tt> will not show a binding.</p>
<p>Note that, in contrast with the POST version, this endpoint will be
used by end-users, and so the response should be human-readable.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID, generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret that was supplied
to the <tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token generated by the
<tt class="docutils literal">requestToken</tt> call and sent to the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/api/v1/validate/msisdn/submitToken?sid=1234&amp;client_secret=monkeys_are_GREAT&amp;token=atoken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Phone number is validated.</p>
<p><strong>Status code 3xx:</strong></p>
<p>Phone number address is validated, and the <tt class="docutils literal">next_link</tt> parameter
was provided to the <tt class="docutils literal">requestToken</tt> call. The user must be
redirected to the URL provided by the <tt class="docutils literal">next_link</tt> parameter.</p>
<p><strong>Status code 4xx:</strong></p>
<p>Validation failed.</p>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-validate-msisdn-requesttoken"></a></p>
<div class="section" id="post-matrix-identity-v2-validate-msisdn-requesttoken">
<h3><a class="toc-backref" href="#id54">12.3.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/validate/msisdn/requestToken</tt></a></h3>
<p>Create a session for validating a phone number.</p>
<p>The identity server will send an SMS message containing a token. If
that token is presented to the identity server in the future, it
indicates that that user was able to read the SMS for that phone
number, and so we validate ownership of the phone number.</p>
<p>Note that homeservers offer APIs that proxy this API, adding
additional behaviour on top, for example,
<tt class="docutils literal">/register/msisdn/requestToken</tt> is designed specifically for use when
registering an account and therefore will inform the user if the phone
number given is already registered on the server.</p>
<p>Note: for backwards compatibility with previous drafts of this
specification, the parameters may also be specified as
<tt class="docutils literal"><span class="pre">application/x-form-www-urlencoded</span></tt> data. However, this usage is
deprecated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> A unique string generated by the
client, and used to identify the validation
attempt. It must be a string consisting of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must
not exceed 255 characters and it must not be
empty.</td>
</tr>
<tr><td>country</td>
<td>string</td>
<td><strong>Required.</strong> The two-letter uppercase ISO-3166-1
alpha-2 country code that the number in
<tt class="docutils literal">phone_number</tt> should be parsed as if it were
dialled from.</td>
</tr>
<tr><td>phone_number</td>
<td>string</td>
<td><strong>Required.</strong> The phone number to validate.</td>
</tr>
<tr><td>send_attempt</td>
<td>integer</td>
<td><strong>Required.</strong> The server will only send an SMS if
the <tt class="docutils literal">send_attempt</tt> is a number greater than the
most recent one which it has seen, scoped to that
<tt class="docutils literal">country</tt> + <tt class="docutils literal">phone_number</tt> + <tt class="docutils literal">client_secret</tt>
triple. This is to avoid repeatedly sending the
same SMS in the case of request retries between
the POSTing user and the identity server. The
client should increment this value if they desire
a new SMS (e.g. a reminder) to be sent.</td>
</tr>
<tr><td>next_link</td>
<td>string</td>
<td>Optional. When the validation is completed, the
identity server will redirect the user to this
URL. This option is ignored when submitting 3PID
validation information through a POST request.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID. Session IDs are
opaque strings generated by the identity server.
They must consist entirely of the characters
<tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Their length must not exceed
255 characters and they must not be empty.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/validate/msisdn/requestToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;country&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;GB&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;phone_number&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;07700900001&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;send_attempt&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Session created.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;123abc&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>An error ocurred. Some possible errors are:</p>
<ul class="simple">
<li><tt class="docutils literal">M_INVALID_ADDRESS</tt>: The phone number provided was invalid.</li>
<li><tt class="docutils literal">M_SEND_ERROR</tt>: The validation SMS could not be sent.</li>
<li><tt class="docutils literal">M_DESTINATION_REJECTED</tt>: The identity server cannot deliver an
SMS to the provided country or region.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_INVALID_ADDRESS&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The phone number is not valid&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-validate-msisdn-submittoken"></a></p>
<div class="section" id="post-matrix-identity-v2-validate-msisdn-submittoken">
<h3><a class="toc-backref" href="#id55">12.3.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/validate/msisdn/submitToken</tt></a></h3>
<p>Validate ownership of a phone number.</p>
<p>If the three parameters are consistent with a set generated by a
<tt class="docutils literal">requestToken</tt> call, ownership of the phone number is considered to
have been validated. This does not publish any information publicly, or
associate the phone number address with any Matrix user
ID. Specifically, calls to <tt class="docutils literal">/lookup</tt> will not show a binding.</p>
<p>The identity server is free to match the token case-insensitively, or
carry out other mapping operations such as unicode
normalisation. Whether to do so is an implementation detail for the
identity server. Clients must always pass on the token without
modification.</p>
<p>Note: for backwards compatibility with previous drafts of this
specification, the parameters may also be specified as
<tt class="docutils literal"><span class="pre">application/x-form-www-urlencoded</span></tt> data. However, this usage is
deprecated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID, generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret that was supplied
to the <tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token generated by the
<tt class="docutils literal">requestToken</tt> call and sent to the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>success</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the validation was
successful or not.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/validate/msisdn/submitToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1234&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;atoken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The success of the validation.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;success&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v2-validate-msisdn-submittoken"></a></p>
<div class="section" id="get-matrix-identity-v2-validate-msisdn-submittoken">
<h3><a class="toc-backref" href="#id56">12.3.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/validate/msisdn/submitToken</tt></a></h3>
<p>Validate ownership of a phone number.</p>
<p>If the three parameters are consistent with a set generated by a
<tt class="docutils literal">requestToken</tt> call, ownership of the phone number address is
considered to have been validated. This does not publish any
information publicly, or associate the phone number with any Matrix
user ID. Specifically, calls to <tt class="docutils literal">/lookup</tt> will not show a binding.</p>
<p>Note that, in contrast with the POST version, this endpoint will be
used by end-users, and so the response should be human-readable.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID, generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret that was supplied
to the <tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token generated by the
<tt class="docutils literal">requestToken</tt> call and sent to the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v2/validate/msisdn/submitToken?sid=1234&amp;client_secret=monkeys_are_GREAT&amp;token=atoken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Phone number is validated.</p>
<p><strong>Status code 3xx:</strong></p>
<p>Phone number address is validated, and the <tt class="docutils literal">next_link</tt> parameter
was provided to the <tt class="docutils literal">requestToken</tt> call. The user must be
redirected to the URL provided by the <tt class="docutils literal">next_link</tt> parameter.</p>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 4xx:</strong></p>
<p>Validation failed.</p>
</div>
</div>
<p><a class="anchor" id="general"></a></p>
<div class="section" id="general">
<h2><a class="toc-backref" href="#id57">12.4&nbsp;&nbsp;&nbsp;General</a></h2>
<p><a class="anchor" id="deprecated-get-matrix-identity-api-v1-3pid-getvalidated3pid"></a></p>
<div class="section" id="deprecated-get-matrix-identity-api-v1-3pid-getvalidated3pid">
<h3><a class="toc-backref" href="#id58">12.4.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">GET /_matrix/identity/api/v1/3pid/getValidated3pid</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Determines if a given 3pid has been validated by a user.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The Session ID generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret passed to the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The medium type of the 3pid.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The address of the 3pid being looked
up.</td>
</tr>
<tr><td>validated_at</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp, in milliseconds,
indicating the time that the 3pid was validated.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/api/v1/3pid/getValidated3pid?sid=1234&amp;client_secret=monkeys_are_GREAT</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Validation information for the session.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;validated_at&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1457622739026</span><span class="punctuation">,</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;louise&#64;bobs.burgers&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The session has not been validated.</p>
<p>If the session has not been validated, then <tt class="docutils literal">errcode</tt> will be
<tt class="docutils literal">M_SESSION_NOT_VALIDATED</tt>.  If the session has timed out, then
<tt class="docutils literal">errcode</tt> will be <tt class="docutils literal">M_SESSION_EXPIRED</tt>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_SESSION_NOT_VALIDATED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This validation session has not yet been completed&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The Session ID or client secret were not found.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NO_VALID_SESSION&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;No valid session was found matching that sid and client secret&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="deprecated-post-matrix-identity-api-v1-3pid-bind"></a></p>
<div class="section" id="deprecated-post-matrix-identity-api-v1-3pid-bind">
<h3><a class="toc-backref" href="#id59">12.4.2&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/3pid/bind</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Publish an association between a session and a Matrix user ID.</p>
<p>Future calls to <tt class="docutils literal">/lookup</tt> for any of the session's 3pids will return
this association.</p>
<p>Note: for backwards compatibility with previous drafts of this
specification, the parameters may also be specified as
<tt class="docutils literal"><span class="pre">application/x-form-www-urlencoded</span></tt> data.  However, this usage is
deprecated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The Session ID generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret passed to the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID to associate with
the 3pids.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The 3pid address of the user being
looked up.</td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The medium type of the 3pid.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID associated with
the 3pid.</td>
</tr>
<tr><td>not_before</td>
<td>integer</td>
<td><strong>Required.</strong> A unix timestamp before which the
association is not known to be valid.</td>
</tr>
<tr><td>not_after</td>
<td>integer</td>
<td><strong>Required.</strong> A unix timestamp after which the
association is not known to be valid.</td>
</tr>
<tr><td>ts</td>
<td>integer</td>
<td><strong>Required.</strong> The unix timestamp at which the
association was verified.</td>
</tr>
<tr><td>signatures</td>
<td>{string: {string: string}}</td>
<td><strong>Required.</strong> The signatures of the verifying
identity servers which show that the association
should be trusted, if you trust the verifying
identity services.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/api/v1/3pid/bind</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1234&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;ears:matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The association was published.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;louise&#64;bobs.burgers&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;ears:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;not_before&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1428825849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;not_after&quot;</span><span class="punctuation">:</span> <span class="literal number integer">4582425849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1428825849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;matrix.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;ed25519:0&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ENiU2YORYUJgE6WBMitU0mppbQjidDLanAusj8XS2nVRHPu+0t42OKA/r6zV6i2MzUbNQ3c3MiLScJuSsOiVDQ&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The association was not published.</p>
<p>If the session has not been validated, then <tt class="docutils literal">errcode</tt> will be
<tt class="docutils literal">M_SESSION_NOT_VALIDATED</tt>.  If the session has timed out, then
<tt class="docutils literal">errcode</tt> will be <tt class="docutils literal">M_SESSION_EXPIRED</tt>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_SESSION_NOT_VALIDATED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This validation session has not yet been completed&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The Session ID or client secret were not found</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NO_VALID_SESSION&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;No valid session was found matching that sid and client secret&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="deprecated-post-matrix-identity-api-v1-3pid-unbind"></a></p>
<div class="section" id="deprecated-post-matrix-identity-api-v1-3pid-unbind">
<h3><a class="toc-backref" href="#id60">12.4.3&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST /_matrix/identity/api/v1/3pid/unbind</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Remove an association between a session and a Matrix user ID.</p>
<p>Future calls to <tt class="docutils literal">/lookup</tt> for any of the session's 3pids will not
return the removed association.</p>
<p>The identity server should authenticate the request in one of two
ways:</p>
<ol class="arabic simple">
<li>The request is signed by the homeserver which controls the <tt class="docutils literal">user_id</tt>.</li>
<li>The request includes the <tt class="docutils literal">sid</tt> and <tt class="docutils literal">client_secret</tt> parameters,
as per <tt class="docutils literal">/3pid/bind</tt>, which proves ownership of the 3PID.</li>
</ol>
<p>If this endpoint returns a JSON Matrix error, that error should be passed
through to the client requesting an unbind through a homeserver, if the
homeserver is acting on behalf of a client.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td>The Session ID generated by the <tt class="docutils literal">requestToken</tt>
call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td>The client secret passed to the <tt class="docutils literal">requestToken</tt>
call.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID to remove from
the 3pids.</td>
</tr>
<tr><td>threepid</td>
<td>3PID</td>
<td><strong>Required.</strong> The 3PID to remove. Must match the
3PID used to generate the session if using <tt class="docutils literal">sid</tt>
and <tt class="docutils literal">client_secret</tt> to authenticate this
request.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>3PID</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> A medium from the <a class="reference external" href="../appendices.html#pid-types">3PID Types</a>
Appendix, matching the medium of the identifier to
unbind.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The 3PID address to remove.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/api/v1/3pid/unbind</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1234&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;ears:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;threepid&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_have_ears&#64;example.org&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The association was successfully removed.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>If the response body is not a JSON Matrix error, the identity server
does not support unbinds. If a JSON Matrix error is in the response
body, the requesting party should respect the error.</p>
<p><strong>Status code 403:</strong></p>
<p>The credentials supplied to authenticate the request were invalid.
This may also be returned if the identity server does not support
the chosen authentication method (such as blocking homeservers from
unbinding identifiers).</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Invalid homeserver signature&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>If the response body is not a JSON Matrix error, the identity server
does not support unbinds. If a JSON Matrix error is in the response
body, the requesting party should respect the error.</p>
<p><strong>Status code 501:</strong></p>
<p>If the response body is not a JSON Matrix error, the identity server
does not support unbinds. If a JSON Matrix error is in the response
body, the requesting party should respect the error.</p>
</div>
<p><a class="anchor" id="get-matrix-identity-v2-3pid-getvalidated3pid"></a></p>
<div class="section" id="get-matrix-identity-v2-3pid-getvalidated3pid">
<h3><a class="toc-backref" href="#id61">12.4.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v2/3pid/getValidated3pid</tt></a></h3>
<p>Determines if a given 3pid has been validated by a user.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The Session ID generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret passed to the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The medium type of the 3pid.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The address of the 3pid being looked
up.</td>
</tr>
<tr><td>validated_at</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp, in milliseconds,
indicating the time that the 3pid was validated.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v2/3pid/getValidated3pid?sid=1234&amp;client_secret=monkeys_are_GREAT</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Validation information for the session.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;validated_at&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1457622739026</span><span class="punctuation">,</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;louise&#64;bobs.burgers&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The session has not been validated.</p>
<p>If the session has not been validated, then <tt class="docutils literal">errcode</tt> will be
<tt class="docutils literal">M_SESSION_NOT_VALIDATED</tt>.  If the session has timed out, then
<tt class="docutils literal">errcode</tt> will be <tt class="docutils literal">M_SESSION_EXPIRED</tt>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_SESSION_NOT_VALIDATED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This validation session has not yet been completed&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The Session ID or client secret were not found.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NO_VALID_SESSION&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;No valid session was found matching that sid and client secret&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-3pid-bind"></a></p>
<div class="section" id="post-matrix-identity-v2-3pid-bind">
<h3><a class="toc-backref" href="#id62">12.4.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/3pid/bind</tt></a></h3>
<p>Publish an association between a session and a Matrix user ID.</p>
<p>Future calls to <tt class="docutils literal">/lookup</tt> for any of the session's 3pids will return
this association.</p>
<p>Note: for backwards compatibility with previous drafts of this
specification, the parameters may also be specified as
<tt class="docutils literal"><span class="pre">application/x-form-www-urlencoded</span></tt> data.  However, this usage is
deprecated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The Session ID generated by the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret passed to the
<tt class="docutils literal">requestToken</tt> call.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID to associate with
the 3pids.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The 3pid address of the user being
looked up.</td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The medium type of the 3pid.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID associated with
the 3pid.</td>
</tr>
<tr><td>not_before</td>
<td>integer</td>
<td><strong>Required.</strong> A unix timestamp before which the
association is not known to be valid.</td>
</tr>
<tr><td>not_after</td>
<td>integer</td>
<td><strong>Required.</strong> A unix timestamp after which the
association is not known to be valid.</td>
</tr>
<tr><td>ts</td>
<td>integer</td>
<td><strong>Required.</strong> The unix timestamp at which the
association was verified.</td>
</tr>
<tr><td>signatures</td>
<td>{string: {string: string}}</td>
<td><strong>Required.</strong> The signatures of the verifying
identity servers which show that the association
should be trusted, if you trust the verifying
identity services.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/3pid/bind</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1234&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;ears:matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The association was published.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;louise&#64;bobs.burgers&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;ears:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;not_before&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1428825849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;not_after&quot;</span><span class="punctuation">:</span> <span class="literal number integer">4582425849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1428825849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;matrix.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;ed25519:0&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ENiU2YORYUJgE6WBMitU0mppbQjidDLanAusj8XS2nVRHPu+0t42OKA/r6zV6i2MzUbNQ3c3MiLScJuSsOiVDQ&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The association was not published.</p>
<p>If the session has not been validated, then <tt class="docutils literal">errcode</tt> will be
<tt class="docutils literal">M_SESSION_NOT_VALIDATED</tt>.  If the session has timed out, then
<tt class="docutils literal">errcode</tt> will be <tt class="docutils literal">M_SESSION_EXPIRED</tt>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_SESSION_NOT_VALIDATED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This validation session has not yet been completed&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The Session ID or client secret were not found</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NO_VALID_SESSION&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;No valid session was found matching that sid and client secret&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-3pid-unbind"></a></p>
<div class="section" id="post-matrix-identity-v2-3pid-unbind">
<h3><a class="toc-backref" href="#id63">12.4.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/identity/v2/3pid/unbind</tt></a></h3>
<p>Remove an association between a session and a Matrix user ID.</p>
<p>Future calls to <tt class="docutils literal">/lookup</tt> for any of the session's 3pids will not
return the removed association.</p>
<p>The identity server should authenticate the request in one of two
ways:</p>
<ol class="arabic simple">
<li>The request is signed by the homeserver which controls the <tt class="docutils literal">user_id</tt>.</li>
<li>The request includes the <tt class="docutils literal">sid</tt> and <tt class="docutils literal">client_secret</tt> parameters,
as per <tt class="docutils literal">/3pid/bind</tt>, which proves ownership of the 3PID.</li>
</ol>
<p>If this endpoint returns a JSON Matrix error, that error should be passed
through to the client requesting an unbind through a homeserver, if the
homeserver is acting on behalf of a client.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td>The Session ID generated by the <tt class="docutils literal">requestToken</tt>
call.</td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td>The client secret passed to the <tt class="docutils literal">requestToken</tt>
call.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID to remove from
the 3pids.</td>
</tr>
<tr><td>threepid</td>
<td>3PID</td>
<td><strong>Required.</strong> The 3PID to remove. Must match the
3PID used to generate the session if using <tt class="docutils literal">sid</tt>
and <tt class="docutils literal">client_secret</tt> to authenticate this
request.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>3PID</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> A medium from the <a class="reference external" href="../appendices.html#pid-types">3PID Types</a>
Appendix, matching the medium of the identifier to
unbind.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The 3PID address to remove.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/3pid/unbind</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1234&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;ears:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;threepid&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_have_ears&#64;example.org&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The association was successfully removed.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>If the response body is not a JSON Matrix error, the identity server
does not support unbinds. If a JSON Matrix error is in the response
body, the requesting party should respect the error.</p>
<p><strong>Status code 403:</strong></p>
<p>The credentials supplied to authenticate the request were invalid.
This may also be returned if the identity server does not support
the chosen authentication method (such as blocking homeservers from
unbinding identifiers).</p>
<p>Another common error code is <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> where the user
needs to <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a> in order to continue.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Invalid homeserver signature&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>If the response body is not a JSON Matrix error, the identity server
does not support unbinds. If a JSON Matrix error is in the response
body, the requesting party should respect the error.</p>
<p><strong>Status code 501:</strong></p>
<p>If the response body is not a JSON Matrix error, the identity server
does not support unbinds. If a JSON Matrix error is in the response
body, the requesting party should respect the error.</p>
</div>
</div>
</div>
<p><a class="anchor" id="invitation-storage"></a></p>
<div class="section" id="invitation-storage">
<h1><a class="toc-backref" href="#id64">13&nbsp;&nbsp;&nbsp;Invitation storage</a></h1>
<p>An identity server can store pending invitations to a user's 3PID, which will
be retrieved and can be either notified on or look up when the 3PID is
associated with a Matrix user ID.</p>
<p>At a later point, if the owner of that particular 3PID binds it with a Matrix user
ID, the identity server will attempt to make an HTTP POST to the Matrix user's
homeserver via the <a class="reference external" href="../server_server/r0.1.3.html#put-matrix-federation-v1-3pid-onbind">/3pid/onbind</a> endpoint. The request MUST be signed with a
long-term private key for the identity server.</p>
<p><a class="anchor" id="deprecated-post-matrix-identity-api-v1-store-invite"></a></p>
<div class="section" id="deprecated-post-matrix-identity-api-v1-store-invite">
<h2><a class="toc-backref" href="#id65">13.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST <span class="pre">/_matrix/identity/api/v1/store-invite</span></tt></a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Store pending invitations to a user's 3pid.</p>
<p>In addition to the request parameters specified below, an arbitrary
number of other parameters may also be specified. These may be used in
the invite message generation described below.</p>
<p>The service will generate a random token and an ephemeral key used for
accepting the invite.</p>
<p>The service also generates a <tt class="docutils literal">display_name</tt> for the inviter, which is
a redacted version of <tt class="docutils literal">address</tt> which does not leak the full contents
of the <tt class="docutils literal">address</tt>.</p>
<p>The service records persistently all of the above information.</p>
<p>It also generates an email containing all of this data, sent to the
<tt class="docutils literal">address</tt> parameter, notifying them of the invitation.</p>
<p>Also, the generated ephemeral public key will be listed as valid on
requests to <tt class="docutils literal">/_matrix/identity/api/v1/pubkey/ephemeral/isvalid</tt>.</p>
<p>Currently, invites may only be issued for 3pids of the <tt class="docutils literal">email</tt> medium.</p>
<p>Optional fields in the request should be populated to the best of the
server's ability. Identity servers may use these variables when notifying
the <tt class="docutils literal">address</tt> of the pending invite for display purposes.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The literal string <tt class="docutils literal">email</tt>.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The email address of the invited
user.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix room ID to which the user
is invited</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID of the inviting
user</td>
</tr>
<tr><td>room_alias</td>
<td>string</td>
<td>The Matrix room alias for the room to which the
user is invited. This should be retrieved from the
<tt class="docutils literal">m.room.canonical_alias</tt> state event.</td>
</tr>
<tr><td>room_avatar_url</td>
<td>string</td>
<td>The Content URI for the room to which the user is
invited. This should be retrieved from the
<tt class="docutils literal">m.room.avatar</tt> state event.</td>
</tr>
<tr><td>room_join_rules</td>
<td>string</td>
<td>The <tt class="docutils literal">join_rule</tt> for the room to which the user
is invited. This should be retrieved from the
<tt class="docutils literal">m.room.join_rules</tt> state event.</td>
</tr>
<tr><td>room_name</td>
<td>string</td>
<td>The name of the room to which the user is invited.
This should be retrieved from the <tt class="docutils literal">m.room.name</tt>
state event.</td>
</tr>
<tr><td>sender_display_name</td>
<td>string</td>
<td>The display name of the user ID initiating the
invite.</td>
</tr>
<tr><td>sender_avatar_url</td>
<td>string</td>
<td>The Content URI for the avatar of the user ID
initiating the invite.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The generated token. Must be a
string consisting of the characters
<tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must not exceed
255 characters and it must not be empty.</td>
</tr>
<tr><td>public_keys</td>
<td>[string]</td>
<td><strong>Required.</strong> A list of [server's long-term public
key, generated ephemeral public key].</td>
</tr>
<tr><td>display_name</td>
<td>string</td>
<td><strong>Required.</strong> The generated (redacted)
display_name.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/api/v1/store-invite</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&#64;example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!something:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_alias&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#somewhere:exmaple.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/s0meM3dia&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_join_rules&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bob's Emporium of Messages&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bob Smith&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender_avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/an0th3rM3dia&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The invitation was stored.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;application/json&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sometoken&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;public_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;serverpublickey&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;ephemeralpublickey&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;f...&#64;b...&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>An error has occured.</p>
<p>If the 3pid is already bound to a Matrix user ID, the error code
will be <tt class="docutils literal">M_THREEPID_IN_USE</tt>.  If the medium is unsupported, the
error code will be <tt class="docutils literal">M_UNRECOGNIZED</tt>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_IN_USE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Binding already known&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-store-invite"></a></p>
<div class="section" id="post-matrix-identity-v2-store-invite">
<h2><a class="toc-backref" href="#id66">13.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/identity/v2/store-invite</span></tt></a></h2>
<p>Store pending invitations to a user's 3pid.</p>
<p>In addition to the request parameters specified below, an arbitrary
number of other parameters may also be specified. These may be used in
the invite message generation described below.</p>
<p>The service will generate a random token and an ephemeral key used for
accepting the invite.</p>
<p>The service also generates a <tt class="docutils literal">display_name</tt> for the inviter, which is
a redacted version of <tt class="docutils literal">address</tt> which does not leak the full contents
of the <tt class="docutils literal">address</tt>.</p>
<p>The service records persistently all of the above information.</p>
<p>It also generates an email containing all of this data, sent to the
<tt class="docutils literal">address</tt> parameter, notifying them of the invitation.</p>
<p>Also, the generated ephemeral public key will be listed as valid on
requests to <tt class="docutils literal">/_matrix/identity/v2/pubkey/ephemeral/isvalid</tt>.</p>
<p>Currently, invites may only be issued for 3pids of the <tt class="docutils literal">email</tt> medium.</p>
<p>Optional fields in the request should be populated to the best of the
server's ability. Identity servers may use these variables when notifying
the <tt class="docutils literal">address</tt> of the pending invite for display purposes.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The literal string <tt class="docutils literal">email</tt>.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The email address of the invited
user.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix room ID to which the user
is invited</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID of the inviting
user</td>
</tr>
<tr><td>room_alias</td>
<td>string</td>
<td>The Matrix room alias for the room to which the
user is invited. This should be retrieved from the
<tt class="docutils literal">m.room.canonical_alias</tt> state event.</td>
</tr>
<tr><td>room_avatar_url</td>
<td>string</td>
<td>The Content URI for the room to which the user is
invited. This should be retrieved from the
<tt class="docutils literal">m.room.avatar</tt> state event.</td>
</tr>
<tr><td>room_join_rules</td>
<td>string</td>
<td>The <tt class="docutils literal">join_rule</tt> for the room to which the user
is invited. This should be retrieved from the
<tt class="docutils literal">m.room.join_rules</tt> state event.</td>
</tr>
<tr><td>room_name</td>
<td>string</td>
<td>The name of the room to which the user is invited.
This should be retrieved from the <tt class="docutils literal">m.room.name</tt>
state event.</td>
</tr>
<tr><td>sender_display_name</td>
<td>string</td>
<td>The display name of the user ID initiating the
invite.</td>
</tr>
<tr><td>sender_avatar_url</td>
<td>string</td>
<td>The Content URI for the avatar of the user ID
initiating the invite.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The generated token. Must be a
string consisting of the characters
<tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must not exceed
255 characters and it must not be empty.</td>
</tr>
<tr><td>public_keys</td>
<td>[string]</td>
<td><strong>Required.</strong> A list of [server's long-term public
key, generated ephemeral public key].</td>
</tr>
<tr><td>display_name</td>
<td>string</td>
<td><strong>Required.</strong> The generated (redacted)
display_name.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/store-invite</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&#64;example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!something:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_alias&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#somewhere:exmaple.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/s0meM3dia&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_join_rules&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bob's Emporium of Messages&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bob Smith&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender_avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/an0th3rM3dia&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The invitation was stored.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;application/json&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sometoken&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;public_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;serverpublickey&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;ephemeralpublickey&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;f...&#64;b...&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>An error has occured.</p>
<p>If the 3pid is already bound to a Matrix user ID, the error code
will be <tt class="docutils literal">M_THREEPID_IN_USE</tt>.  If the medium is unsupported, the
error code will be <tt class="docutils literal">M_UNRECOGNIZED</tt>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_IN_USE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Binding already known&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="ephemeral-invitation-signing"></a></p>
<div class="section" id="ephemeral-invitation-signing">
<h1><a class="toc-backref" href="#id67">14&nbsp;&nbsp;&nbsp;Ephemeral invitation signing</a></h1>
<p>To aid clients who may not be able to perform crypto themselves, the identity
server offers some crypto functionality to help in accepting invitations.
This is less secure than the client doing it itself, but may be useful where
this isn't possible.</p>
<p><a class="anchor" id="deprecated-post-matrix-identity-api-v1-sign-ed25519"></a></p>
<div class="section" id="deprecated-post-matrix-identity-api-v1-sign-ed25519">
<h2><a class="toc-backref" href="#id68">14.1&nbsp;&nbsp;&nbsp;Deprecated: <tt class="docutils literal">POST <span class="pre">/_matrix/identity/api/v1/sign-ed25519</span></tt></a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Sign invitation details.</p>
<p>The identity server will look up <tt class="docutils literal">token</tt> which was stored in a call
to <tt class="docutils literal"><span class="pre">store-invite</span></tt>, and fetch the sender of the invite.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID of the user
accepting the invitation.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token from the call to <tt class="docutils literal">store-
invite</tt>.</td>
</tr>
<tr><td>private_key</td>
<td>string</td>
<td><strong>Required.</strong> The private key, encoded as
<a class="reference external" href="../appendices.html#unpadded-base64">Unpadded base64</a>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID of the user
accepting the invitation.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID of the user who
sent the invitation.</td>
</tr>
<tr><td>signatures</td>
<td>{string: {string: string}}</td>
<td><strong>Required.</strong> The signature of the mxid, sender,
and token.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token for the invitation.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/api/v1/sign-ed25519</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;foo:bar.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sometoken&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;private_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;base64encodedkey&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The signed JSON of the mxid, sender, and token.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;foo:bar.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;baz:bar.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;my.id.server&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;ed25519:0&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;def987&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The token was not found.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNRECOGNIZED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Didn't recognize token&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-identity-v2-sign-ed25519"></a></p>
<div class="section" id="post-matrix-identity-v2-sign-ed25519">
<h2><a class="toc-backref" href="#id69">14.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/identity/v2/sign-ed25519</span></tt></a></h2>
<p>Sign invitation details.</p>
<p>The identity server will look up <tt class="docutils literal">token</tt> which was stored in a call
to <tt class="docutils literal"><span class="pre">store-invite</span></tt>, and fetch the sender of the invite.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID of the user
accepting the invitation.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token from the call to <tt class="docutils literal">store-
invite</tt>.</td>
</tr>
<tr><td>private_key</td>
<td>string</td>
<td><strong>Required.</strong> The private key, encoded as
<a class="reference external" href="../appendices.html#unpadded-base64">Unpadded base64</a>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID of the user
accepting the invitation.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix user ID of the user who
sent the invitation.</td>
</tr>
<tr><td>signatures</td>
<td>{string: {string: string}}</td>
<td><strong>Required.</strong> The signature of the mxid, sender,
and token.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token for the invitation.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/identity/v2/sign-ed25519</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;foo:bar.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sometoken&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;private_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;base64encodedkey&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The signed JSON of the mxid, sender, and token.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;foo:bar.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;baz:bar.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;my.id.server&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;ed25519:0&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;def987&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user must do something in order to use this endpoint. One example
is an <tt class="docutils literal">M_TERMS_NOT_SIGNED</tt> error where the user must <a class="reference internal" href="#agree-to-more-terms">agree to more terms</a>.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TERMS_NOT_SIGNED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Please accept our updated terms of service before continuing&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The token was not found.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNRECOGNIZED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Didn't recognize token&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
</body>
</html>
