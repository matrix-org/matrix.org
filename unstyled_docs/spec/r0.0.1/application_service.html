<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<meta name="description" content="Application Server HTML" />
<title>Application Service API</title>
<style type="text/css">

/*
 * basic.css
 * ~~~~~~~~~
 *
 * Sphinx stylesheet -- basic theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- main layout ----------------------------------------------------------- */

div.clearer {
    clear: both;
}

/* -- relbar ---------------------------------------------------------------- */

div.related {
    width: 100%;
    font-size: 90%;
}

div.related h3 {
    display: none;
}

div.related ul {
    margin: 0;
    padding: 0 0 0 10px;
    list-style: none;
}

div.related li {
    display: inline;
}

div.related li.right {
    float: right;
    margin-right: 5px;
}

/* -- sidebar --------------------------------------------------------------- */

div.sphinxsidebarwrapper {
    padding: 10px 5px 0 10px;
}

div.sphinxsidebar {
    float: left;
    width: 230px;
    margin-left: -100%;
    font-size: 90%;
}

div.sphinxsidebar ul {
    list-style: none;
}

div.sphinxsidebar ul ul,
div.sphinxsidebar ul.want-points {
    margin-left: 20px;
    list-style: square;
}

div.sphinxsidebar ul ul {
    margin-top: 0;
    margin-bottom: 0;
}

div.sphinxsidebar form {
    margin-top: 10px;
}

div.sphinxsidebar input {
    border: 1px solid #98dbcc;
    font-family: sans-serif;
    font-size: 1em;
}

img {
    border: 0;
}

/* -- search page ----------------------------------------------------------- */

ul.search {
    margin: 10px 0 0 20px;
    padding: 0;
}

ul.search li {
    padding: 5px 0 5px 20px;
    background-image: url(file.png);
    background-repeat: no-repeat;
    background-position: 0 7px;
}

ul.search li a {
    font-weight: bold;
}

ul.search li div.context {
    color: #888;
    margin: 2px 0 0 30px;
    text-align: left;
}

ul.keywordmatches li.goodmatch a {
    font-weight: bold;
}

/* -- index page ------------------------------------------------------------ */

table.contentstable {
    width: 90%;
}

table.contentstable p.biglink {
    line-height: 150%;
}

a.biglink {
    font-size: 1.3em;
}

span.linkdescr {
    font-style: italic;
    padding-top: 5px;
    font-size: 90%;
}

/* -- general index --------------------------------------------------------- */

table.indextable {
    width: 100%;
}

table.indextable td {
    text-align: left;
    vertical-align: top;
}

table.indextable dl, table.indextable dd {
    margin-top: 0;
    margin-bottom: 0;
}

table.indextable tr.pcap {
    height: 10px;
}

table.indextable tr.cap {
    margin-top: 10px;
    background-color: #f2f2f2;
}

img.toggler {
    margin-right: 3px;
    margin-top: 3px;
    cursor: pointer;
}

div.modindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

div.genindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

/* -- general body styles --------------------------------------------------- */

a.headerlink {
    visibility: hidden;
}

h1:hover > a.headerlink,
h2:hover > a.headerlink,
h3:hover > a.headerlink,
h4:hover > a.headerlink,
h5:hover > a.headerlink,
h6:hover > a.headerlink,
dt:hover > a.headerlink {
    visibility: visible;
}

div.document p.caption {
    text-align: inherit;
}

div.document td {
    text-align: left;
}

.field-list ul {
    padding-left: 1em;
}

.first {
    margin-top: 0 !important;
}

p.rubric {
    margin-top: 30px;
    font-weight: bold;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* -- sidebars -------------------------------------------------------------- */

div.sidebar {
    margin: 0 0 0.5em 1em;
    border: 1px solid #ddb;
    padding: 7px 7px 0 7px;
    background-color: #ffe;
    width: 40%;
    float: right;
}

p.sidebar-title {
    font-weight: bold;
}

/* -- topics ---------------------------------------------------------------- */

div.topic {
    border: 1px solid #ccc;
    padding: 7px 7px 0 7px;
    margin: 10px 0 10px 0;
}

p.topic-title {
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 10px;
}

/* -- admonitions ----------------------------------------------------------- */

div.admonition {
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 7px;
}

div.admonition dt {
    font-weight: bold;
}

div.admonition dl {
    margin-bottom: 0;
}

p.admonition-title {
    margin: 0px 10px 5px 0px;
    font-weight: bold;
}

div.document p.centered {
    text-align: center;
    margin-top: 25px;
}

/* -- tables ---------------------------------------------------------------- */

table.docutils {
    border: 0;
    border-collapse: collapse;
}

table.docutils td, table.docutils th {
    padding: 1px 8px 1px 5px;
    border-top: 0;
    border-left: 0;
    border-right: 0;
    border-bottom: 1px solid #aaa;
}

table.field-list td, table.field-list th {
    border: 0 !important;
}

table.footnote td, table.footnote th {
    border: 0 !important;
}

th {
    text-align: left;
    padding-right: 5px;
}

table.citation {
    border-left: solid 1px gray;
    margin-left: 1px;
}

table.citation td {
    border-bottom: none;
}

/* -- other body styles ----------------------------------------------------- */

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl {
    margin-bottom: 15px;
}

dd p {
    margin-top: 0px;
}

dd ul, dd table {
    margin-bottom: 10px;
}

dd {
    margin-top: 3px;
    margin-bottom: 10px;
    margin-left: 30px;
}

dt:target, .highlighted {
    background-color: #fbe54e;
}

dl.glossary dt {
    font-weight: bold;
    font-size: 1.1em;
}

.field-list ul {
    margin: 0;
    padding-left: 1em;
}

.field-list p {
    margin: 0;
}

.refcount {
    color: #060;
}

.optional {
    font-size: 1.3em;
}

.versionmodified {
    font-style: italic;
}

.system-message {
    background-color: #fda;
    padding: 5px;
    border: 3px solid red;
}

.footnote:target  {
    background-color: #ffa
}

.line-block {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
}

.line-block .line-block {
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 1.5em;
}

.guilabel, .menuselection {
    font-family: sans-serif;
}

.accelerator {
    text-decoration: underline;
}

.classifier {
    font-style: oblique;
}

/* -- code displays --------------------------------------------------------- */

pre {
    overflow: auto;
}

td.linenos pre {
    padding: 5px 0px;
    border: 0;
    background-color: transparent;
    color: #aaa;
}

table.highlighttable {
    margin-left: 0.5em;
}

table.highlighttable td {
    padding: 0 0.5em 0 0.5em;
}

tt.descname {
    background-color: transparent;
    font-weight: bold;
    font-size: 1.2em;
}

tt.descclassname {
    background-color: transparent;
}

tt.xref, a tt {
    background-color: transparent;
    font-weight: bold;
}

h1 tt, h2 tt, h3 tt, h4 tt, h5 tt, h6 tt {
    background-color: transparent;
}

.viewcode-link {
    float: right;
}

.viewcode-back {
    float: right;
    font-family: sans-serif;
}

div.viewcode-block:target {
    margin: -1px -10px;
    padding: 0 10px;
}

/* -- math display ---------------------------------------------------------- */

img.math {
    vertical-align: middle;
}

div.document div.math p {
    text-align: center;
}

span.eqno {
    float: right;
}

/* -- printout stylesheet --------------------------------------------------- */

@media print {
    div.document,
    div.documentwrapper,
    div.bodywrapper {
        margin: 0 !important;
        width: 100%;
    }

    div.sphinxsidebar,
    div.related,
    div.footer,
    #top-link {
        display: none;
    }
}


</style>
<style type="text/css">

pre.code .comment, code .comment { color: green }
pre.code .keyword, code .keyword { color: darkred; font-weight: bold }
pre.code .name.builtin, code .name.builtin { color: darkred; font-weight: bold }
pre.code .name.tag, code .name.tag { color: darkgreen }
pre.code .literal, code .literal { color: darkblue }
pre.code .literal.number, code .literal.number { color: blue }


/* HTTP Methods have class "name function" */
pre.code.http .name.function,  code.http .name.function { color: black; font-weight: bold }
/* HTTP Paths have class "name namespace" */
pre.code.http .name.namespace, code.http .name.namespace { color: darkgreen }
/* HTTP "HTTP" strings have class "keyword reserved" */
pre.code.http .keyword.reserved, code.http .keyword.reserved { color: black; font-weight: bold }
/* HTTP Header names have class "name attribute" */
pre.code.http .name.attribute, code.http .name.attribute { color: black; font-weight: bold }

</style>
<style type="text/css">

/*
 * nature.css_t
 * ~~~~~~~~~~~~
 *
 * Sphinx stylesheet -- nature theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- page layout ----------------------------------------------------------- */

body {
    font-family: Arial, sans-serif;
    font-size: 100%;
    /*background-color: #111;*/
    color: #555;
    margin: 0;
    padding: 0;
}

div.documentwrapper {
    float: left;
    width: 100%;
}

div.bodywrapper {
    margin: 0 0 0 230px;
}

hr {
    border: 1px solid #B1B4B6;
}

/*
div.document {
    background-color: #eee;
}
*/

div.document {
    background-color: #ffffff;
    color: #3E4349;
    padding: 0 30px 30px 30px;
    font-size: 0.9em;
}

div.footer {
    color: #555;
    width: 100%;
    padding: 13px 0;
    text-align: center;
    font-size: 75%;
}

div.footer a {
    color: #444;
    text-decoration: underline;
}

div.related {
    background-color: #6BA81E;
    line-height: 32px;
    color: #fff;
    text-shadow: 0px 1px 0 #444;
    font-size: 0.9em;
}

div.related a {
    color: #E2F3CC;
}

div.sphinxsidebar {
    font-size: 0.75em;
    line-height: 1.5em;
}

div.sphinxsidebarwrapper{
    padding: 20px 0;
}

div.sphinxsidebar h3,
div.sphinxsidebar h4 {
    font-family: Arial, sans-serif;
    color: #222;
    font-size: 1.2em;
    font-weight: normal;
    margin: 0;
    padding: 5px 10px;
    background-color: #ddd;
    text-shadow: 1px 1px 0 white
}

div.sphinxsidebar h4{
    font-size: 1.1em;
}

div.sphinxsidebar h3 a {
    color: #444;
}


div.sphinxsidebar p {
    color: #888;
    padding: 5px 20px;
}

div.sphinxsidebar p.topless {
}

div.sphinxsidebar ul {
    margin: 10px 20px;
    padding: 0;
    color: #000;
}

div.sphinxsidebar a {
    color: #444;
}

div.sphinxsidebar input {
    border: 1px solid #ccc;
    font-family: sans-serif;
    font-size: 1em;
}

div.sphinxsidebar input[type=text]{
    margin-left: 20px;
}

/* -- body styles ----------------------------------------------------------- */

a {
    color: #005B81;
    text-decoration: none;
}

a:hover {
    color: #E32E00;
    text-decoration: underline;
}

div.document h1,
div.document h2,
div.document h3,
div.document h4,
div.document h5,
div.document h6 {
    font-family: Arial, sans-serif;
    background-color: #BED4EB;
    font-weight: normal;
    color: #212224;
    margin: 30px 0px 10px 0px;
    padding: 5px 0 5px 10px;
    text-shadow: 0px 1px 0 white
}

div.document h1 { border-top: 20px solid white; margin-top: 0; font-size: 200%; }
div.document h2 { font-size: 150%; background-color: #C8D5E3; }
div.document h3 { font-size: 120%; background-color: #D8DEE3; }
div.document h4 { font-size: 110%; background-color: #D8DEE3; }
div.document h5 { font-size: 100%; background-color: #D8DEE3; }
div.document h6 { font-size: 100%; background-color: #D8DEE3; }

a.headerlink {
    color: #c60f0f;
    font-size: 0.8em;
    padding: 0 4px 0 4px;
    text-decoration: none;
}

a.headerlink:hover {
    background-color: #c60f0f;
    color: white;
}

div.document p, div.document dd, div.document li {
    line-height: 1.5em;
}

div.admonition p.admonition-title + p {
    display: inline;
}

div.highlight{
    background-color: white;
}

div.note {
    background-color: #eee;
    border: 1px solid #ccc;
}

div.seealso {
    background-color: #ffc;
    border: 1px solid #ff6;
}

div.topic {
    background-color: #eee;
}

div.warning {
    background-color: #ffe4e4;
    border: 1px solid #f66;
}

p.admonition-title {
    display: inline;
}

p.admonition-title:after {
    content: ":";
}

pre {
    padding: 10px;
    background-color: White;
    color: #222;
    line-height: 1.2em;
    border: 1px solid #C6C9CB;
    font-size: 1.1em;
    margin: 1.5em 0 1.5em 0;
    -webkit-box-shadow: 1px 1px 1px #d8d8d8;
    -moz-box-shadow: 1px 1px 1px #d8d8d8;
}

tt {
    background-color: #ecf0f3;
    color: #222;
    /* padding: 1px 2px; */
    font-size: 1.1em;
    font-family: monospace;
}

.viewcode-back {
    font-family: Arial, sans-serif;
}

div.viewcode-block:target {
    background-color: #f4debf;
    border-top: 1px solid #ac9;
    border-bottom: 1px solid #ac9;
}

ul li dd {
	margin-top: 0;
}

ul li dl {
	margin-bottom: 0;
}

li dl dd {
	margin-bottom: 0;
}

dd ul {
	padding-left: 0;
}

li dd ul {
	margin-bottom: 0;
}

table {
    margin-top: 10px;
    margin-bottom: 10px;
    border: 0;
    border-collapse: collapse;
}

td[colspan]:not([colspan="1"]) {
    background: #eeeeee;
}

thead {
    background: #eeeeee;
}

div.admonition-rationale {
    background-color: #efe;
    border: 1px solid #ccc;
}


</style>
<style type="text/css">

blockquote {
    margin: 20px 0 30px;
    border-left: 5px solid;
    padding-left: 20px;
}

</style>
</head>
<body>

<div class="document" id="application-service-api">
<h1 class="title">Application Service API</h1>
%outdatedspecwarning%

<p>The Matrix client-server API and server-server APIs provide the means to
implement a consistent self-contained federated messaging fabric. However, they
provide limited means of implementing custom server-side behaviour in Matrix
(e.g. gateways, filters, extensible hooks etc). The Application Service API (AS API)
defines a standard API to allow such extensible functionality to be implemented
irrespective of the underlying homeserver implementation.</p>
<!-- TODO-spec
Add in Client-Server services? Overview of bots? Seems weird to be in the spec
given it is VERY implementation specific. -->
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#application-services" id="id1">1&nbsp;&nbsp;&nbsp;Application Services</a><ul class="auto-toc">
<li><a class="reference internal" href="#registration" id="id2">1.1&nbsp;&nbsp;&nbsp;Registration</a></li>
<li><a class="reference internal" href="#homeserver-application-service-api" id="id3">1.2&nbsp;&nbsp;&nbsp;Homeserver -&gt; Application Service API</a><ul class="auto-toc">
<li><a class="reference internal" href="#pushing-events" id="id4">1.2.1&nbsp;&nbsp;&nbsp;Pushing events</a></li>
<li><a class="reference internal" href="#querying" id="id5">1.2.2&nbsp;&nbsp;&nbsp;Querying</a></li>
<li><a class="reference internal" href="#http-apis" id="id6">1.2.3&nbsp;&nbsp;&nbsp;HTTP APIs</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-rooms-roomalias" id="id7">1.2.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/rooms/{roomAlias}</span></tt></a></li>
<li><a class="reference internal" href="#put-transactions-txnid" id="id8">1.2.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/transactions/{txnId}</span></tt></a></li>
<li><a class="reference internal" href="#get-users-userid" id="id9">1.2.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/users/{userId}</span></tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#client-server-api-extensions" id="id10">1.3&nbsp;&nbsp;&nbsp;Client-Server API Extensions</a><ul class="auto-toc">
<li><a class="reference internal" href="#identity-assertion" id="id11">1.3.1&nbsp;&nbsp;&nbsp;Identity assertion</a></li>
<li><a class="reference internal" href="#timestamp-massaging" id="id12">1.3.2&nbsp;&nbsp;&nbsp;Timestamp massaging</a></li>
<li><a class="reference internal" href="#server-admin-style-permissions" id="id13">1.3.3&nbsp;&nbsp;&nbsp;Server admin style permissions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id-conventions" id="id14">1.4&nbsp;&nbsp;&nbsp;ID conventions</a><ul class="auto-toc">
<li><a class="reference internal" href="#user-ids" id="id15">1.4.1&nbsp;&nbsp;&nbsp;User IDs</a></li>
<li><a class="reference internal" href="#room-aliases" id="id16">1.4.2&nbsp;&nbsp;&nbsp;Room Aliases</a></li>
<li><a class="reference internal" href="#event-fields" id="id17">1.4.3&nbsp;&nbsp;&nbsp;Event fields</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p><a class="anchor" id="application-services"></a></p>
<div class="section" id="application-services">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;Application Services</a></h1>
<p>Application services are passive and can only observe events from a given
homeserver. They can inject events into rooms they are participating in.
They cannot prevent events from being sent, nor can they modify the content of
the event being sent. In order to observe events from a homeserver, the
homeserver needs to be configured to pass certain types of traffic to the
application service.  This is achieved by manually configuring the homeserver
with information about the application service (AS).</p>
<p><a class="anchor" id="registration"></a></p>
<div class="section" id="registration">
<h2><a class="toc-backref" href="#id2">1.1&nbsp;&nbsp;&nbsp;Registration</a></h2>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Previously, application services could register with a homeserver via HTTP
APIs. This was removed as it was seen as a security risk. A compromised
application service could re-register for a global <tt class="docutils literal">*</tt> regex and sniff
<em>all</em> traffic on the homeserver. To protect against this, application
services now have to register via configuration files which are linked to
the homeserver configuration file. The addition of configuration files
allows homeserver admins to sanity check the registration for suspicious
regex strings.</p>
</div>
<!-- TODO
Removing the API entirely is probably a mistake - having a standard cross-HS
way of doing this stops ASes being coupled to particular HS implementations.
A better solution would be to somehow mandate that the API done to avoid
abuse. -->
<p>Application services register &quot;namespaces&quot; of user IDs, room aliases and room IDs.
These namespaces are represented as regular expressions. An application service
is said to be &quot;interested&quot; in a given event if one of the IDs in the event match
the regular expression provided by the application service. An application
service can also state whether they should be the only ones who
can manage a specified namespace. This is referred to as an &quot;exclusive&quot;
namespace. An exclusive namespace prevents humans and other application
services from creating/deleting entities in that namespace. Typically,
exclusive namespaces are used when the rooms represent real rooms on
another service (e.g. IRC). Non-exclusive namespaces are used when the
application service is merely augmenting the room itself (e.g. providing
logging or searching facilities). Namespaces are represented by POSIX extended
regular expressions and look like:</p>
<pre class="code yaml literal-block">
<span class="literal scalar plain">users</span><span class="punctuation indicator">:</span>
  <span class="punctuation indicator">-</span> <span class="literal scalar plain">exclusive</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">true</span>
    <span class="literal scalar plain">regex</span><span class="punctuation indicator">:</span> <span class="error">&#64;</span><span class="literal scalar plain">irc.freenode.net_.*</span>
</pre>
<p>The registration is represented by a series of key-value pairs, which this
specification will present as YAML. An example HS configuration required to pass
traffic to the AS is:</p>
<pre class="code yaml literal-block">
<span class="literal scalar plain">url</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;base url of AS&gt;</span>
<span class="literal scalar plain">as_token</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;token AS will add to requests to HS&gt;</span>
<span class="literal scalar plain">hs_token</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;token HS will add to requests to AS&gt;</span>
<span class="literal scalar plain">sender_localpart</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;localpart of AS user&gt;</span>
<span class="literal scalar plain">namespaces</span><span class="punctuation indicator">:</span>
  <span class="literal scalar plain">users</span><span class="punctuation indicator">:</span>  <span class="comment single"># Namespaces of users which should be delegated to the AS</span>
    <span class="punctuation indicator">-</span> <span class="literal scalar plain">exclusive</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;bool&gt;</span>
      <span class="literal scalar plain">regex</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;regex&gt;</span>
    <span class="punctuation indicator">-</span> <span class="literal scalar plain">...</span>
  <span class="literal scalar plain">aliases</span><span class="punctuation indicator">:</span> <span class="punctuation indicator">[]</span>  <span class="comment single"># Namespaces of room aliases which should be delegated to the AS</span>
  <span class="literal scalar plain">rooms</span><span class="punctuation indicator">:</span> <span class="punctuation indicator">[]</span> <span class="comment single"># Namespaces of room ids which should be delegated to the AS</span>
</pre>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">If the homeserver in question has multiple application services, each
<tt class="docutils literal">as_token</tt> MUST be unique per application service as this token is used to
identify the application service. The homeserver MUST enforce this.</p>
</div>
</div>
<p><a class="anchor" id="homeserver-application-service-api"></a></p>
<div class="section" id="homeserver-application-service-api">
<h2><a class="toc-backref" href="#id3">1.2&nbsp;&nbsp;&nbsp;Homeserver -&gt; Application Service API</a></h2>
<p><a class="anchor" id="pushing-events"></a></p>
<div class="section" id="pushing-events">
<h3><a class="toc-backref" href="#id4">1.2.1&nbsp;&nbsp;&nbsp;Pushing events</a></h3>
<p>The application service API provides a transaction API for sending a list of
events. Each list of events includes a transaction ID, which works as follows:</p>
<pre class="literal-block">
Typical
HS ---&gt; AS : Homeserver sends events with transaction ID T.
   &lt;---    : AS sends back 200 OK.

AS ACK Lost
HS ---&gt; AS : Homeserver sends events with transaction ID T.
   &lt;-/-    : AS 200 OK is lost.
HS ---&gt; AS : Homeserver retries with the same transaction ID of T.
   &lt;---    : AS sends back 200 OK. If the AS had processed these events
             already, it can NO-OP this request (and it knows if it is the same
             events based on the transaction ID).
</pre>
<p>The events sent to the application service should be linearised, as if they were
from the event stream. The homeserver MUST maintain a queue of transactions to
send to the AS. If the application service cannot be reached, the homeserver
SHOULD backoff exponentially until the application service is reachable again.
As application services cannot <em>modify</em> the events in any way, these requests can
be made without blocking other aspects of the homeserver. Homeservers MUST NOT
alter (e.g. add more) events they were going to send within that transaction ID
on retries, as the AS may have already processed the events.</p>
</div>
<p><a class="anchor" id="querying"></a></p>
<div class="section" id="querying">
<h3><a class="toc-backref" href="#id5">1.2.2&nbsp;&nbsp;&nbsp;Querying</a></h3>
<p>The application service API includes two querying APIs: for room aliases and for
user IDs. The application service SHOULD create the queried entity if it desires.
During this process, the application service is blocking the homeserver until the
entity is created and configured. If the homeserver does not receive a response
to this request, the homeserver should retry several times before timing out. This
should result in an HTTP status 408 &quot;Request Timeout&quot; on the client which initiated
this request (e.g. to join a room alias).</p>
<div class="admonition-rationale admonition">
<p class="first admonition-title">Rationale</p>
<p class="last">Blocking the homeserver and expecting the application service to create the entity
using the client-server API is simpler and more flexible than alternative methods
such as returning an initial sync style JSON blob and get the HS to provision
the room/user. This also meant that there didn't need to be a &quot;backchannel&quot; to inform
the application service about information about the entity such as room ID to
room alias mappings.</p>
</div>
</div>
<p><a class="anchor" id="http-apis"></a></p>
<div class="section" id="http-apis">
<h3><a class="toc-backref" href="#id6">1.2.3&nbsp;&nbsp;&nbsp;HTTP APIs</a></h3>
<p>This contains application service APIs which are used by the homeserver. All
application services MUST implement these APIs. These APIs are defined below.</p>
<p><a class="anchor" id="get-rooms-roomalias"></a></p>
<div class="section" id="get-rooms-roomalias">
<h4><a class="toc-backref" href="#id7">1.2.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/rooms/{roomAlias}</span></tt></a></h4>
<p>This endpoint is invoked by the homeserver on an application service to query
the existence of a given room alias. The homeserver will only query room aliases
inside the application service's <tt class="docutils literal">aliases</tt> namespace. The homeserver will send
this request when it receives a request to join a room alias within the
application service's namespace.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomAlias</td>
<td>string</td>
<td><strong>Required.</strong> The room alias being queried.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/rooms/%23magicforest%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The application service indicates that this room alias exists. The
application service MUST have created a room and associated it with
the queried room alias using the client-server API. Additional
information about the room such as its name and topic can be set
before responding.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The homeserver has not supplied credentials to the application service.
Optional error information can be included in the body of this response.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;COM.EXAMPLE.MYAPPSERVICE_UNAUTHORIZED&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The credentials supplied by the homeserver were rejected.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The application service indicates that this room alias does not exist.
Optional error information can be included in the body of this response.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;COM.EXAMPLE.MYAPPSERVICE_NOT_FOUND&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="put-transactions-txnid"></a></p>
<div class="section" id="put-transactions-txnid">
<h4><a class="toc-backref" href="#id8">1.2.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/transactions/{txnId}</span></tt></a></h4>
<p>This API is called by the HS when the HS wants to push an event (or batch of
events) to the AS.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>txnId</td>
<td>string</td>
<td><strong>Required.</strong> The transaction ID for this set of
events. Homeservers generate these IDs and they
are used to ensure idempotency of requests.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>events</td>
<td>[Event]</td>
<td><strong>Required.</strong> A list of events</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/transactions/35</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">32</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;incoming message&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14328055551tzaee:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432804485886</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:localhost&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1984</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;another incoming message&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1228055551ffsef:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432804485886</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:localhost&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The transaction was processed successfully.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="get-users-userid"></a></p>
<div class="section" id="get-users-userid">
<h4><a class="toc-backref" href="#id9">1.2.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/users/{userId}</span></tt></a></h4>
<p>This endpoint is invoked by the homeserver on an application service to query
the existence of a given user ID. The homeserver will only query user IDs inside
the application service's <tt class="docutils literal">users</tt> namespace. The homeserver will send this
request when it receives an event for an unknown user ID in the application
service's namespace.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user ID being queried.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/users/%40alice%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The application service indicates that this user exists. The application
service MUST create the user using the client-server API.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The homeserver has not supplied credentials to the application service.
Optional error information can be included in the body of this response.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;COM.EXAMPLE.MYAPPSERVICE_UNAUTHORIZED&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The credentials supplied by the homeserver were rejected.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The application service indicates that this user does not exist.
Optional error information can be included in the body of this response.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;COM.EXAMPLE.MYAPPSERVICE_NOT_FOUND&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="client-server-api-extensions"></a></p>
<div class="section" id="client-server-api-extensions">
<h2><a class="toc-backref" href="#id10">1.3&nbsp;&nbsp;&nbsp;Client-Server API Extensions</a></h2>
<p>Application services can use a more powerful version of the
client-server API by identifying itself as an application service to the
homeserver.</p>
<p><a class="anchor" id="identity-assertion"></a></p>
<div class="section" id="identity-assertion">
<h3><a class="toc-backref" href="#id11">1.3.1&nbsp;&nbsp;&nbsp;Identity assertion</a></h3>
<p>The client-server API infers the user ID from the <tt class="docutils literal">access_token</tt> provided in
every request. It would be an annoying amount of book-keeping to maintain tokens
for every virtual user. It would be preferable if the application service could
use the CS API with its own <tt class="docutils literal">as_token</tt> instead, and specify the virtual user
they wish to be acting on behalf of. For real users, this would require
additional permissions granting the AS permission to masquerade as a matrix user.</p>
<dl class="docutils">
<dt>Inputs:</dt>
<dd><ul class="first last simple">
<li>Application service token (<tt class="docutils literal">access_token</tt>)</li>
<li>User ID in the AS namespace to act as.</li>
</ul>
</dd>
<dt>Notes:</dt>
<dd><ul class="first last simple">
<li>This will apply on all aspects of the CS API, except for Account Management.</li>
<li>The <tt class="docutils literal">as_token</tt> is inserted into <tt class="docutils literal">access_token</tt> which is usually where the
client token is. This is done on purpose to allow application services to
reuse client SDKs.</li>
</ul>
</dd>
</dl>
<pre class="literal-block">
/path?access_token=$token&amp;user_id=$userid

Query Parameters:
  access_token: The application service token
  user_id: The desired user ID to act as.
</pre>
</div>
<p><a class="anchor" id="timestamp-massaging"></a></p>
<div class="section" id="timestamp-massaging">
<h3><a class="toc-backref" href="#id12">1.3.2&nbsp;&nbsp;&nbsp;Timestamp massaging</a></h3>
<p>The application service may want to inject events at a certain time (reflecting
the time on the network they are tracking e.g. irc, xmpp). Application services
need to be able to adjust the <tt class="docutils literal">origin_server_ts</tt> value to do this.</p>
<dl class="docutils">
<dt>Inputs:</dt>
<dd><ul class="first last simple">
<li>Application service token (<tt class="docutils literal">as_token</tt>)</li>
<li>Desired timestamp</li>
</ul>
</dd>
<dt>Notes:</dt>
<dd><ul class="first last simple">
<li>This will only apply when sending events.</li>
</ul>
</dd>
</dl>
<pre class="literal-block">
/path?access_token=$token&amp;ts=$timestamp

Query Parameters added to the send event APIs only:
  access_token: The application service token
  ts: The desired timestamp
</pre>
</div>
<p><a class="anchor" id="server-admin-style-permissions"></a></p>
<div class="section" id="server-admin-style-permissions">
<h3><a class="toc-backref" href="#id13">1.3.3&nbsp;&nbsp;&nbsp;Server admin style permissions</a></h3>
<p id="sect-asapi-permissions">The homeserver needs to give the application service <em>full control</em> over its
namespace, both for users and for room aliases. This means that the AS should
be able to create/edit/delete any room alias in its namespace, as well as
create/delete any user in its namespace. No additional API changes need to be
made in order for control of room aliases to be granted to the AS. Creation of
users needs API changes in order to:</p>
<ul class="simple">
<li>Work around captchas.</li>
<li>Have a 'passwordless' user.</li>
</ul>
<p>This involves bypassing the registration flows entirely. This is achieved by
including the AS token on a <tt class="docutils literal">/register</tt> request, along with a login type of
<tt class="docutils literal">m.login.application_service</tt> to set the desired user ID without a password.</p>
<pre class="literal-block">
/register?access_token=$as_token

Content:
{
  type: &quot;m.login.application_service&quot;,
  user: &quot;&lt;desired user localpart in AS namespace&gt;&quot;
}
</pre>
<p>Application services which attempt to create users or aliases <em>outside</em> of
their defined namespaces will receive an error code <tt class="docutils literal">M_EXCLUSIVE</tt>. Similarly,
normal users who attempt to create users or aliases <em>inside</em> an application
service-defined namespace will receive the same <tt class="docutils literal">M_EXCLUSIVE</tt> error code,
but only if the application service has defined the namespace as <tt class="docutils literal">exclusive</tt>.</p>
</div>
</div>
<p><a class="anchor" id="id-conventions"></a></p>
<div class="section" id="id-conventions">
<h2><a class="toc-backref" href="#id14">1.4&nbsp;&nbsp;&nbsp;ID conventions</a></h2>
<!-- TODO-spec
- Giving HSes the freedom to namespace still feels like the Right Thing here.
- Exposing a public API provides the consistency which was the main complaint
  against namespacing.
- This may have knock-on effects for the AS registration API. E.g. why don't
  we let ASes specify the *URI* regex they want? -->
<p>This concerns the well-defined conventions for mapping 3P network IDs to matrix
IDs, which we expect clients to be able to do by themselves.</p>
<p><a class="anchor" id="user-ids"></a></p>
<div class="section" id="user-ids">
<h3><a class="toc-backref" href="#id15">1.4.1&nbsp;&nbsp;&nbsp;User IDs</a></h3>
<p>Matrix users may wish to directly contact a virtual user, e.g. to send an email.
The URI format is a well-structured way to represent a number of different ID
types, including:</p>
<ul class="simple">
<li>MSISDNs (<tt class="docutils literal">tel</tt>)</li>
<li>Email addresses (<tt class="docutils literal">mailto</tt>)</li>
<li>IRC nicks (<tt class="docutils literal">irc</tt> - <a class="reference external" href="https://tools.ietf.org/html/draft-butcher-irc-url-04">https://tools.ietf.org/html/draft-butcher-irc-url-04</a>)</li>
<li>XMPP (XEP-0032)</li>
<li>SIP URIs (RFC 3261)</li>
</ul>
<p>As a result, virtual user IDs SHOULD relate to their URI counterpart. This
mapping from URI to user ID can be expressed in a number of ways:</p>
<ul class="simple">
<li>Expose a C-S API on the HS which takes URIs and responds with user IDs.</li>
<li>Munge the URI with the user ID.</li>
</ul>
<p>Exposing an API would allow HSes to internally map user IDs however they like,
at the cost of an extra round trip (of which the response can be cached).
Munging the URI would allow clients to apply the mapping locally, but would force
user X on service Y to always map to the same munged user ID. Considering the
exposed API could just be applying this munging, there is more flexibility if
an API is exposed.</p>
<pre class="literal-block">
GET /_matrix/app/r0/user?uri=$url_encoded_uri

Returns 200 OK:
{
  user_id: &lt;complete user ID on local HS&gt;
}
</pre>
</div>
<p><a class="anchor" id="room-aliases"></a></p>
<div class="section" id="room-aliases">
<h3><a class="toc-backref" href="#id16">1.4.2&nbsp;&nbsp;&nbsp;Room Aliases</a></h3>
<p>We may want to expose some 3P network rooms so Matrix users can join them directly,
e.g. IRC rooms. We don't want to expose every 3P network room though, e.g.
<tt class="docutils literal">mailto</tt>, <tt class="docutils literal">tel</tt>. Rooms which are publicly accessible (e.g. IRC rooms) can be
exposed as an alias by the application service. Private rooms
(e.g. sending an email to someone) should not
be exposed in this way, but should instead operate using normal invite/join semantics.
Therefore, the ID conventions discussed below are only valid for public rooms which
expose room aliases.</p>
<p>Matrix users may wish to join XMPP rooms (e.g. using XEP-0045) or IRC rooms. In both
cases, these rooms can be expressed as URIs. For consistency, these &quot;room&quot; URIs
SHOULD be mapped in the same way as &quot;user&quot; URIs.</p>
<pre class="literal-block">
GET /_matrix/app/r0/alias?uri=$url_encoded_uri

Returns 200 OK:
{
  alias: &lt;complete room alias on local HS&gt;
}
</pre>
</div>
<p><a class="anchor" id="event-fields"></a></p>
<div class="section" id="event-fields">
<h3><a class="toc-backref" href="#id17">1.4.3&nbsp;&nbsp;&nbsp;Event fields</a></h3>
<p>We recommend that any events that originated from a remote network should
include an <tt class="docutils literal">external_url</tt> field in their content to provide a way for Matrix
clients to link into the 'native' client from which the event originated.
For instance, this could contain the message-ID for emails/nntp posts, or a link
to a blog comment when bridging blog comment traffic in &amp; out of Matrix.</p>
</div>
</div>
</div>
</div>

</body>
</html>
