<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>Client-Server API</title>
<style type="text/css">

/*
 * basic.css
 * ~~~~~~~~~
 *
 * Sphinx stylesheet -- basic theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- main layout ----------------------------------------------------------- */

div.clearer {
    clear: both;
}

/* -- relbar ---------------------------------------------------------------- */

div.related {
    width: 100%;
    font-size: 90%;
}

div.related h3 {
    display: none;
}

div.related ul {
    margin: 0;
    padding: 0 0 0 10px;
    list-style: none;
}

div.related li {
    display: inline;
}

div.related li.right {
    float: right;
    margin-right: 5px;
}

/* -- sidebar --------------------------------------------------------------- */

div.sphinxsidebarwrapper {
    padding: 10px 5px 0 10px;
}

div.sphinxsidebar {
    float: left;
    width: 230px;
    margin-left: -100%;
    font-size: 90%;
}

div.sphinxsidebar ul {
    list-style: none;
}

div.sphinxsidebar ul ul,
div.sphinxsidebar ul.want-points {
    margin-left: 20px;
    list-style: square;
}

div.sphinxsidebar ul ul {
    margin-top: 0;
    margin-bottom: 0;
}

div.sphinxsidebar form {
    margin-top: 10px;
}

div.sphinxsidebar input {
    border: 1px solid #98dbcc;
    font-family: sans-serif;
    font-size: 1em;
}

img {
    border: 0;
}

/* -- search page ----------------------------------------------------------- */

ul.search {
    margin: 10px 0 0 20px;
    padding: 0;
}

ul.search li {
    padding: 5px 0 5px 20px;
    background-image: url(file.png);
    background-repeat: no-repeat;
    background-position: 0 7px;
}

ul.search li a {
    font-weight: bold;
}

ul.search li div.context {
    color: #888;
    margin: 2px 0 0 30px;
    text-align: left;
}

ul.keywordmatches li.goodmatch a {
    font-weight: bold;
}

/* -- index page ------------------------------------------------------------ */

table.contentstable {
    width: 90%;
}

table.contentstable p.biglink {
    line-height: 150%;
}

a.biglink {
    font-size: 1.3em;
}

span.linkdescr {
    font-style: italic;
    padding-top: 5px;
    font-size: 90%;
}

/* -- general index --------------------------------------------------------- */

table.indextable {
    width: 100%;
}

table.indextable td {
    text-align: left;
    vertical-align: top;
}

table.indextable dl, table.indextable dd {
    margin-top: 0;
    margin-bottom: 0;
}

table.indextable tr.pcap {
    height: 10px;
}

table.indextable tr.cap {
    margin-top: 10px;
    background-color: #f2f2f2;
}

img.toggler {
    margin-right: 3px;
    margin-top: 3px;
    cursor: pointer;
}

div.modindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

div.genindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

/* -- general body styles --------------------------------------------------- */

a.headerlink {
    visibility: hidden;
}

h1:hover > a.headerlink,
h2:hover > a.headerlink,
h3:hover > a.headerlink,
h4:hover > a.headerlink,
h5:hover > a.headerlink,
h6:hover > a.headerlink,
dt:hover > a.headerlink {
    visibility: visible;
}

div.document p.caption {
    text-align: inherit;
}

div.document td {
    text-align: left;
}

.field-list ul {
    padding-left: 1em;
}

.first {
    margin-top: 0 !important;
}

p.rubric {
    margin-top: 30px;
    font-weight: bold;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* -- sidebars -------------------------------------------------------------- */

div.sidebar {
    margin: 0 0 0.5em 1em;
    border: 1px solid #ddb;
    padding: 7px 7px 0 7px;
    background-color: #ffe;
    width: 40%;
    float: right;
}

p.sidebar-title {
    font-weight: bold;
}

/* -- topics ---------------------------------------------------------------- */

div.topic {
    border: 1px solid #ccc;
    padding: 7px 7px 0 7px;
    margin: 10px 0 10px 0;
}

p.topic-title {
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 10px;
}

/* -- admonitions ----------------------------------------------------------- */

div.admonition {
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 7px;
}

div.admonition dt {
    font-weight: bold;
}

div.admonition dl {
    margin-bottom: 0;
}

p.admonition-title {
    margin: 0px 10px 5px 0px;
    font-weight: bold;
}

div.document p.centered {
    text-align: center;
    margin-top: 25px;
}

/* -- tables ---------------------------------------------------------------- */

table.docutils {
    border: 0;
    border-collapse: collapse;
}

table.docutils td, table.docutils th {
    padding: 1px 8px 1px 5px;
    border-top: 0;
    border-left: 0;
    border-right: 0;
    border-bottom: 1px solid #aaa;
}

table.field-list td, table.field-list th {
    border: 0 !important;
}

table.footnote td, table.footnote th {
    border: 0 !important;
}

th {
    text-align: left;
    padding-right: 5px;
}

table.citation {
    border-left: solid 1px gray;
    margin-left: 1px;
}

table.citation td {
    border-bottom: none;
}

table.colwidths-auto caption {
    font-family: 'Inconsolata', monospace;
    font-weight: 800;
    font-size: 120%;
    padding: 5px;
    text-align: left;
    margin-bottom: 2px;
}

.section ol, .section li {
    margin: 0px 0px 0px 30px !important;
}

p.httpheaders {
    font-weight: 800;
    font-size: 120%;
    padding: 5px;
    text-align: left;
    margin-bottom: 2px;
}

table.colwidths-auto {
    width:100%;
    margin-top: 20px;
}

table.colwidths-auto tr td:nth-child(1) {
    width: 15%;
}

table.colwidths-auto tr td:nth-child(2) {
    width: 15%;
    font-family: 'Inconsolata', monospace;
}

table.colwidths-auto tr td:nth-child(3) {
    width: 70%;
}


/* -- other body styles ----------------------------------------------------- */

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl {
    margin-bottom: 15px;
}

dd p {
    margin-top: 0px;
}

dd ul, dd table {
    margin-bottom: 10px;
}

dd {
    margin-top: 3px;
    margin-bottom: 10px;
    margin-left: 30px;
}

dt:target, .highlighted {
    background-color: #fbe54e;
}

dl.glossary dt {
    font-weight: bold;
    font-size: 1.1em;
}

.field-list ul {
    margin: 0;
    padding-left: 1em;
}

.field-list p {
    margin: 0;
}

.refcount {
    color: #060;
}

.optional {
    font-size: 1.3em;
}

.versionmodified {
    font-style: italic;
}

.system-message {
    background-color: #fda;
    padding: 5px;
    border: 3px solid red;
}

.footnote:target  {
    background-color: #ffa
}

.line-block {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
}

.line-block .line-block {
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 1.5em;
}

.guilabel, .menuselection {
    font-family: sans-serif;
}

.accelerator {
    text-decoration: underline;
}

.classifier {
    font-style: oblique;
}

/* -- proposals page -------------------------------------------------------- */

#tables-of-tracked-proposals h2 {
    padding-left: 10px;
    position: -webkit-sticky;
    position: sticky;
}

/* Move sticky headers below header bar on desktop */
@media all and (min-width:980px) {
    #tables-of-tracked-proposals h2 {
        top: 52px;
    }
}

/* Sticky headers stick to the top on mobile */
@media all and (min-width:0px) and (max-width: 980px) {
    #tables-of-tracked-proposals h2 {
        top: 0px;
    }
}

/* -- code displays --------------------------------------------------------- */

pre {
    overflow: auto;
}

td.linenos pre {
    padding: 5px 0px;
    border: 0;
    background-color: transparent;
    color: #aaa;
}

table.highlighttable {
    margin-left: 0.5em;
}

table.highlighttable td {
    padding: 0 0.5em 0 0.5em;
}

tt.descname {
    background-color: transparent;
    font-weight: bold;
    font-size: 1.2em;
}

tt.descclassname {
    background-color: transparent;
}

tt.xref, a tt {
    background-color: transparent;
    font-weight: bold;
}

h1 tt, h2 tt, h3 tt, h4 tt, h5 tt, h6 tt {
    background-color: transparent;
}

.viewcode-link {
    float: right;
}

.viewcode-back {
    float: right;
    font-family: sans-serif;
}

div.viewcode-block:target {
    margin: -1px -10px;
    padding: 0 10px;
}

/* -- math display ---------------------------------------------------------- */

img.math {
    vertical-align: middle;
}

div.document div.math p {
    text-align: center;
}

span.eqno {
    float: right;
}

/* -- printout stylesheet --------------------------------------------------- */

@media print {
    div.document,
    div.documentwrapper,
    div.bodywrapper {
        margin: 0 !important;
        width: 100%;
    }

    div.sphinxsidebar,
    div.related,
    div.footer,
    #top-link {
        display: none;
    }
}


</style>
<style type="text/css">

blockquote {
    margin: 20px 0 30px;
    padding-left: 20px;
}

</style>
<style type="text/css">

pre.code .comment, code .comment { color: green }
pre.code .keyword, code .keyword { color: darkred; font-weight: bold }
pre.code .name.builtin, code .name.builtin { color: darkred; font-weight: bold }
pre.code .name.tag, code .name.tag { color: darkgreen }
pre.code .literal, code .literal { color: darkblue }
pre.code .literal.number, code .literal.number { color: blue }


/* HTTP Methods have class "name function" */
pre.code.http .name.function,  code.http .name.function { color: black; font-weight: bold }
/* HTTP Paths have class "name namespace" */
pre.code.http .name.namespace, code.http .name.namespace { color: darkgreen }
/* HTTP "HTTP" strings have class "keyword reserved" */
pre.code.http .keyword.reserved, code.http .keyword.reserved { color: black; font-weight: bold }
/* HTTP Header names have class "name attribute" */
pre.code.http .name.attribute, code.http .name.attribute { color: black; font-weight: bold }

</style>
<style type="text/css">

/*
 * nature.css_t
 * ~~~~~~~~~~~~
 *
 * Sphinx stylesheet -- nature theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- page layout ----------------------------------------------------------- */

body {
    font-family: Arial, sans-serif;
    font-size: 100%;
    /*background-color: #111;*/
    color: #555;
    margin: 0;
    padding: 0;
}

div.documentwrapper {
    float: left;
    width: 100%;
}

div.bodywrapper {
    margin: 0 0 0 230px;
}

hr {
    border: 1px solid #B1B4B6;
}

/*
div.document {
    background-color: #eee;
}
*/

div.document {
    background-color: #ffffff;
    color: #3E4349;
    padding: 0 30px 30px 30px;
    font-size: 0.9em;
}

div.footer {
    color: #555;
    width: 100%;
    padding: 13px 0;
    text-align: center;
    font-size: 75%;
}

div.footer a {
    color: #444;
    text-decoration: underline;
}

div.related {
    background-color: #6BA81E;
    line-height: 32px;
    color: #fff;
    text-shadow: 0px 1px 0 #444;
    font-size: 0.9em;
}

div.related a {
    color: #E2F3CC;
}

div.sphinxsidebar {
    font-size: 0.75em;
    line-height: 1.5em;
}

div.sphinxsidebarwrapper{
    padding: 20px 0;
}

div.sphinxsidebar h3,
div.sphinxsidebar h4 {
    font-family: Arial, sans-serif;
    color: #222;
    font-size: 1.2em;
    font-weight: normal;
    margin: 0;
    padding: 5px 10px;
    background-color: #ddd;
    text-shadow: 1px 1px 0 white
}

div.sphinxsidebar h4{
    font-size: 1.1em;
}

div.sphinxsidebar h3 a {
    color: #444;
}


div.sphinxsidebar p {
    color: #888;
    padding: 5px 20px;
}

div.sphinxsidebar p.topless {
}

div.sphinxsidebar ul {
    margin: 10px 20px;
    padding: 0;
    color: #000;
}

div.sphinxsidebar a {
    color: #444;
}

div.sphinxsidebar input {
    border: 1px solid #ccc;
    font-family: sans-serif;
    font-size: 1em;
}

div.sphinxsidebar input[type=text]{
    margin-left: 20px;
}

/* -- body styles ----------------------------------------------------------- */

a {
    color: #005B81;
    text-decoration: none;
}

a:hover {
    color: #E32E00;
    text-decoration: underline;
}

div.document h1,
div.document h2,
div.document h3,
div.document h4,
div.document h5,
div.document h6 {
    font-family: Arial, sans-serif;
    background-color: #BED4EB;
    font-weight: normal;
    color: #212224;
    margin: 30px 0px 10px 0px;
    padding: 5px 0 5px 10px;
    text-shadow: 0px 1px 0 white
}

div.document h1 { border-top: 20px solid white; margin-top: 0; font-size: 200%; }
div.document h2 { font-size: 150%; background-color: #C8D5E3; }
div.document h3 { font-size: 120%; background-color: #D8DEE3; }
div.document h4 { font-size: 110%; background-color: #D8DEE3; }
div.document h5 { font-size: 100%; background-color: #D8DEE3; }
div.document h6 { font-size: 100%; background-color: #D8DEE3; }

a.headerlink {
    color: #c60f0f;
    font-size: 0.8em;
    padding: 0 4px 0 4px;
    text-decoration: none;
}

a.headerlink:hover {
    background-color: #c60f0f;
    color: white;
}

div.document p, div.document dd, div.document li {
    line-height: 1.5em;
}

div.admonition p.admonition-title + p {
    display: inline;
}

div.highlight{
    background-color: white;
}

div.note {
    background-color: #eee;
    border: 1px solid #ccc;
}

div.seealso {
    background-color: #ffc;
    border: 1px solid #ff6;
}

div.topic {
    background-color: #eee;
}

div.warning {
    background-color: #ffe4e4;
    border: 1px solid #f66;
}

p.admonition-title {
    display: inline;
}

p.admonition-title:after {
    content: ":";
}

pre {
    padding: 10px;
    background-color: White;
    color: #222;
    line-height: 1.2em;
    border: 1px solid #C6C9CB;
    font-size: 1.1em;
    margin: 1.5em 0 1.5em 0;
    -webkit-box-shadow: 1px 1px 1px #d8d8d8;
    -moz-box-shadow: 1px 1px 1px #d8d8d8;
}

tt {
    background-color: #ecf0f3;
    color: #222;
    /* padding: 1px 2px; */
    font-size: 1.1em;
    font-family: monospace;
}

.viewcode-back {
    font-family: Arial, sans-serif;
}

div.viewcode-block:target {
    background-color: #f4debf;
    border-top: 1px solid #ac9;
    border-bottom: 1px solid #ac9;
}

ul li dd {
	margin-top: 0;
}

ul li dl {
	margin-bottom: 0;
}

li dl dd {
	margin-bottom: 0;
}

dd ul {
	padding-left: 0;
}

li dd ul {
	margin-bottom: 0;
}

table {
    margin-top: 10px;
    margin-bottom: 10px;
    border: 0;
    border-collapse: collapse;
}

td[colspan]:not([colspan="1"]) {
    background: #eeeeee;
    text-transform: capitalize;
}

thead {
    background: #eeeeee;
}

div.admonition-rationale {
    background-color: #efe;
    border: 1px solid #ccc;
}

div.admonition-example {
    background-color: #eef;
    border: 1px solid #ccc;
}


</style>
<style type="text/css">

/* Column with header cells */
table.docutils tbody th.stub {
    background: #eeeeee;
}

</style>
<style type="text/css">

/*
*   math2html: convert LaTeX equations to HTML output.
*
*   Copyright (C) 2009,2010 Alex Fernández
*
*   Released under the terms of the `2-Clause BSD license'_, in short:
*   Copying and distribution of this file, with or without modification,
*   are permitted in any medium without royalty provided the copyright
*   notice and this notice are preserved.
*   This file is offered as-is, without any warranty.
*
* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause
*
*   Based on eLyXer: convert LyX source files to HTML output.
*   http://elyxer.nongnu.org/
*/
/* --end--
* CSS file for LaTeX formulas.
*/

/* Formulas */
.formula {
	text-align: center;
	font-family: "Droid Serif", "DejaVu Serif", "STIX", serif;
	margin: 1.2em 0;
}
span.formula {
	white-space: nowrap;
}
div.formula {
	padding: 0.5ex;
	margin-left: auto;
	margin-right: auto;
}

/* Basic features */
a.eqnumber {
	display: inline-block;
	float: right;
	clear: right;
	font-weight: bold;
}
span.unknown {
	color: #800000;
}
span.ignored, span.arraydef {
	display: none;
}
.formula i {
	letter-spacing: 0.1ex;
}

/* Alignment */
.align-left, .align-l {
	text-align: left;
}
.align-right, .align-r {
	text-align: right;
}
.align-center, .align-c {
	text-align: center;
}

/* Structures */
span.overline, span.bar {
	text-decoration: overline;
}
.fraction, .fullfraction {
	display: inline-block;
	vertical-align: middle;
	text-align: center;
}
.fraction .fraction {
	font-size: 80%;
	line-height: 100%;
}
span.numerator {
	display: block;
}
span.denominator {
	display: block;
	padding: 0ex;
	border-top: thin solid;
}
sup.numerator, sup.unit {
	font-size: 70%;
	vertical-align: 80%;
}
sub.denominator, sub.unit {
	font-size: 70%;
	vertical-align: -20%;
}
span.sqrt {
	display: inline-block;
	vertical-align: middle;
	padding: 0.1ex;
}
sup.root {
	font-size: 70%;
	position: relative;
	left: 1.4ex;
}
span.radical {
	display: inline-block;
	padding: 0ex;
	font-size: 150%;
	vertical-align: top;
}
span.root {
	display: inline-block;
	border-top: thin solid;
	padding: 0ex;
	vertical-align: middle;
}
span.symbol {
	line-height: 125%;
	font-size: 125%;
}
span.bigsymbol {
	line-height: 150%;
	font-size: 150%;
}
span.largesymbol {
	font-size: 175%;
}
span.hugesymbol {
	font-size: 200%;
}
span.scripts {
	display: inline-table;
	vertical-align: middle;
}
.script {
	display: table-row;
	text-align: left;
	line-height: 150%;
}
span.limits {
	display: inline-table;
	vertical-align: middle;
}
.limit {
	display: table-row;
	line-height: 99%;
}
sup.limit, sub.limit {
	line-height: 100%;
}
span.symbolover {
	display: inline-block;
	text-align: center;
	position: relative;
	float: right;
	right: 100%;
	bottom: 0.5em;
	width: 0px;
}
span.withsymbol {
	display: inline-block;
}
span.symbolunder {
	display: inline-block;
	text-align: center;
	position: relative;
	float: right;
	right: 80%;
	top: 0.3em;
	width: 0px;
}

/* Environments */
span.array, span.bracketcases, span.binomial, span.environment {
	display: inline-table;
	text-align: center;
	border-collapse: collapse;
	margin: 0em;
	vertical-align: middle;
}
span.arrayrow, span.binomrow {
	display: table-row;
	padding: 0ex;
	border: 0ex;
}
span.arraycell, span.bracket, span.case, span.binomcell, span.environmentcell {
	display: table-cell;
	padding: 0ex 0.2ex;
	line-height: 99%;
	border: 0ex;
}
/*
* CSS file for LaTeX formulas, extra stuff:
* binomials, vertical braces, stackrel, fonts and colors.
*/

/* Inline binomials */
span.binom {
	display: inline-block;
	vertical-align: middle;
	text-align: center;
	font-size: 80%;
}
span.binomstack {
	display: block;
	padding: 0em;
}

/* Over- and underbraces */
span.overbrace {
	border-top: 2pt solid;
}
span.underbrace {
	border-bottom: 2pt solid;
}

/* Stackrel */
span.stackrel {
	display: inline-block;
	text-align: center;
}
span.upstackrel {
	display: block;
	padding: 0em;
	font-size: 80%;
	line-height: 64%;
	position: relative;
	top: 0.15em;

}
span.downstackrel {
	display: block;
	vertical-align: bottom;
	padding: 0em;
}

/* Fonts */
span.mathsf, span.textsf {
	font-style: normal;
	font-family: sans-serif;
}
span.mathrm, span.textrm {
	font-style: normal;
	font-family: serif;
}
span.text, span.textnormal {
	font-style: normal;
}
span.textipa {
	color: #008080;
}
span.fraktur {
	font-family: "Lucida Blackletter", eufm10, blackletter;
}
span.blackboard {
	font-family: Blackboard, msbm10, serif;
}
span.scriptfont {
	font-family: "Monotype Corsiva", "Apple Chancery", "URW Chancery L", cursive;
	font-style: italic;
}

/* Colors */
span.colorbox {
	display: inline-block;
	padding: 5px;
}
span.fbox {
	display: inline-block;
	border: thin solid black;
	padding: 2px;
}
span.boxed, span.framebox {
	display: inline-block;
	border: thin solid black;
	padding: 5px;
}


</style>
</head>
<body>
<div class="document" id="client-server-api">
<h1 class="title">Client-Server API</h1>
%outdatedspecwarning%

<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
<p>The client-server API provides a simple lightweight API to let clients send
messages, control rooms and synchronise conversation history. It is designed to
support both lightweight clients which store no state and lazy-load data from
the server as required - as well as heavyweight clients which maintain a full
local persistent copy of server state.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#changelog" id="id213">1&nbsp;&nbsp;&nbsp;Changelog</a><ul class="auto-toc">
<li><a class="reference internal" href="#other-versions-of-this-specification" id="id214">1.1&nbsp;&nbsp;&nbsp;Other versions of this specification</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api-standards" id="id215">2&nbsp;&nbsp;&nbsp;API Standards</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-versions" id="id216">2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/versions</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#web-browser-clients" id="id217">3&nbsp;&nbsp;&nbsp;Web Browser Clients</a></li>
<li><a class="reference internal" href="#server-discovery" id="id218">4&nbsp;&nbsp;&nbsp;Server Discovery</a><ul class="auto-toc">
<li><a class="reference internal" href="#well-known-uri" id="id219">4.1&nbsp;&nbsp;&nbsp;Well-known URI</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-well-known-matrix-client" id="id220">4.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/.well-known/matrix/client</span></tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#client-authentication" id="id221">5&nbsp;&nbsp;&nbsp;Client Authentication</a><ul class="auto-toc">
<li><a class="reference internal" href="#using-access-tokens" id="id222">5.1&nbsp;&nbsp;&nbsp;Using access tokens</a></li>
<li><a class="reference internal" href="#relationship-between-access-tokens-and-devices" id="id223">5.2&nbsp;&nbsp;&nbsp;Relationship between access tokens and devices</a></li>
<li><a class="reference internal" href="#user-interactive-authentication-api" id="id224">5.3&nbsp;&nbsp;&nbsp;User-Interactive Authentication API</a><ul class="auto-toc">
<li><a class="reference internal" href="#overview" id="id225">5.3.1&nbsp;&nbsp;&nbsp;Overview</a></li>
<li><a class="reference internal" href="#user-interactive-api-in-the-rest-api" id="id226">5.3.2&nbsp;&nbsp;&nbsp;User-interactive API in the REST API</a></li>
<li><a class="reference internal" href="#example" id="id227">5.3.3&nbsp;&nbsp;&nbsp;Example</a></li>
<li><a class="reference internal" href="#authentication-types" id="id228">5.3.4&nbsp;&nbsp;&nbsp;Authentication types</a><ul class="auto-toc">
<li><a class="reference internal" href="#password-based" id="id229">5.3.4.1&nbsp;&nbsp;&nbsp;Password-based</a></li>
<li><a class="reference internal" href="#google-recaptcha" id="id230">5.3.4.2&nbsp;&nbsp;&nbsp;Google ReCaptcha</a></li>
<li><a class="reference internal" href="#token-based" id="id231">5.3.4.3&nbsp;&nbsp;&nbsp;Token-based</a></li>
<li><a class="reference internal" href="#oauth2-based" id="id232">5.3.4.4&nbsp;&nbsp;&nbsp;OAuth2-based</a></li>
<li><a class="reference internal" href="#email-based-identity-homeserver" id="id233">5.3.4.5&nbsp;&nbsp;&nbsp;Email-based (identity / homeserver)</a></li>
<li><a class="reference internal" href="#phone-number-msisdn-based-identity-homeserver" id="id234">5.3.4.6&nbsp;&nbsp;&nbsp;Phone number/MSISDN-based (identity / homeserver)</a></li>
<li><a class="reference internal" href="#dummy-auth" id="id235">5.3.4.7&nbsp;&nbsp;&nbsp;Dummy Auth</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fallback" id="id236">5.3.5&nbsp;&nbsp;&nbsp;Fallback</a><ul class="auto-toc">
<li><a class="reference internal" href="#id67" id="id237">5.3.5.1&nbsp;&nbsp;&nbsp;Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#identifier-types" id="id238">5.3.6&nbsp;&nbsp;&nbsp;Identifier types</a><ul class="auto-toc">
<li><a class="reference internal" href="#matrix-user-id" id="id239">5.3.6.1&nbsp;&nbsp;&nbsp;Matrix User ID</a></li>
<li><a class="reference internal" href="#third-party-id" id="id240">5.3.6.2&nbsp;&nbsp;&nbsp;Third-party ID</a></li>
<li><a class="reference internal" href="#phone-number" id="id241">5.3.6.3&nbsp;&nbsp;&nbsp;Phone number</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#login" id="id242">5.4&nbsp;&nbsp;&nbsp;Login</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-login" id="id243">5.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/login</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-login" id="id244">5.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/login</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-logout" id="id245">5.4.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/logout</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-logout-all" id="id246">5.4.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/logout/all</tt></a></li>
<li><a class="reference internal" href="#login-fallback" id="id247">5.4.5&nbsp;&nbsp;&nbsp;Login Fallback</a></li>
</ul>
</li>
<li><a class="reference internal" href="#account-registration-and-management" id="id248">5.5&nbsp;&nbsp;&nbsp;Account registration and management</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-register" id="id249">5.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/register</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-register-email-requesttoken" id="id250">5.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/register/email/requestToken</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-register-msisdn-requesttoken" id="id251">5.5.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/register/msisdn/requestToken</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-account-password" id="id252">5.5.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/password</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-account-password-email-requesttoken" id="id253">5.5.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/password/email/requestToken</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-account-password-msisdn-requesttoken" id="id254">5.5.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/password/msisdn/requestToken</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-account-deactivate" id="id255">5.5.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/deactivate</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-register-available" id="id256">5.5.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/register/available</tt></a></li>
<li><a class="reference internal" href="#notes-on-password-management" id="id257">5.5.9&nbsp;&nbsp;&nbsp;Notes on password management</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-account-administrative-contact-information" id="id258">5.6&nbsp;&nbsp;&nbsp;Adding Account Administrative Contact Information</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-account-3pid" id="id259">5.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/account/3pid</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-account-3pid" id="id260">5.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/3pid</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-account-3pid-delete" id="id261">5.6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/3pid/delete</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-account-3pid-email-requesttoken" id="id262">5.6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/3pid/email/requestToken</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-account-3pid-msisdn-requesttoken" id="id263">5.6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/3pid/msisdn/requestToken</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#current-account-information" id="id264">5.7&nbsp;&nbsp;&nbsp;Current account information</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-account-whoami" id="id265">5.7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/account/whoami</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#capabilities-negotiation" id="id266">6&nbsp;&nbsp;&nbsp;Capabilities negotiation</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-capabilities" id="id267">6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/capabilities</tt></a></li>
<li><a class="reference internal" href="#m-change-password-capability" id="id268">6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.change_password</tt> capability</a></li>
<li><a class="reference internal" href="#m-room-versions-capability" id="id269">6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room_versions</tt> capability</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pagination" id="id270">7&nbsp;&nbsp;&nbsp;Pagination</a></li>
<li><a class="reference internal" href="#filtering" id="id271">8&nbsp;&nbsp;&nbsp;Filtering</a><ul class="auto-toc">
<li><a class="reference internal" href="#lazy-loading-room-members" id="id272">8.1&nbsp;&nbsp;&nbsp;Lazy-loading room members</a></li>
<li><a class="reference internal" href="#api-endpoints" id="id273">8.2&nbsp;&nbsp;&nbsp;API endpoints</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-user-userid-filter" id="id274">8.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/user/{userId}/filter</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-user-userid-filter-filterid" id="id275">8.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/user/{userId}/filter/{filterId}</span></tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#events" id="id276">9&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#types-of-room-events" id="id277">9.1&nbsp;&nbsp;&nbsp;Types of room events</a><ul class="auto-toc">
<li><a class="reference internal" href="#event-fields" id="id278">9.1.1&nbsp;&nbsp;&nbsp;Event Fields</a></li>
<li><a class="reference internal" href="#room-event-fields" id="id279">9.1.2&nbsp;&nbsp;&nbsp;Room Event Fields</a></li>
<li><a class="reference internal" href="#state-event-fields" id="id280">9.1.3&nbsp;&nbsp;&nbsp;State Event Fields</a></li>
</ul>
</li>
<li><a class="reference internal" href="#size-limits" id="id281">9.2&nbsp;&nbsp;&nbsp;Size limits</a></li>
<li><a class="reference internal" href="#room-events" id="id282">9.3&nbsp;&nbsp;&nbsp;Room Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-aliases" id="id283">9.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.aliases</tt></a></li>
<li><a class="reference internal" href="#m-room-canonical-alias" id="id284">9.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.canonical_alias</tt></a></li>
<li><a class="reference internal" href="#m-room-create" id="id285">9.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.create</tt></a></li>
<li><a class="reference internal" href="#m-room-join-rules" id="id286">9.3.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.join_rules</tt></a></li>
<li><a class="reference internal" href="#m-room-member" id="id287">9.3.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.member</tt></a></li>
<li><a class="reference internal" href="#m-room-power-levels" id="id288">9.3.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.power_levels</tt></a></li>
<li><a class="reference internal" href="#m-room-redaction" id="id289">9.3.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.redaction</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#syncing" id="id290">9.4&nbsp;&nbsp;&nbsp;Syncing</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-sync" id="id291">9.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/sync</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-events" id="id292">9.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/events</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-initialsync" id="id293">9.4.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/initialSync</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-events-eventid" id="id294">9.4.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/events/{eventId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#getting-events-for-a-room" id="id295">9.5&nbsp;&nbsp;&nbsp;Getting events for a room</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-rooms-roomid-event-eventid" id="id296">9.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/event/{eventId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-rooms-roomid-state-eventtype-statekey" id="id297">9.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/state/{eventType}/{stateKey}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-rooms-roomid-state" id="id298">9.5.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/state</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-rooms-roomid-members" id="id299">9.5.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/members</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-rooms-roomid-joined-members" id="id300">9.5.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/joined_members</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-rooms-roomid-messages" id="id301">9.5.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/messages</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-rooms-roomid-initialsync" id="id302">9.5.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/initialSync</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sending-events-to-a-room" id="id303">9.6&nbsp;&nbsp;&nbsp;Sending events to a room</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-r0-rooms-roomid-state-eventtype-statekey" id="id304">9.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/rooms/{roomId}/state/{eventType}/{stateKey}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-r0-rooms-roomid-send-eventtype-txnid" id="id305">9.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/rooms/{roomId}/send/{eventType}/{txnId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#redactions" id="id306">9.7&nbsp;&nbsp;&nbsp;Redactions</a><ul class="auto-toc">
<li><a class="reference internal" href="#id83" id="id307">9.7.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#id84" id="id308">9.7.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.redaction</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#client-behaviour" id="id309">9.7.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-r0-rooms-roomid-redact-eventid-txnid" id="id310">9.7.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/rooms/{roomId}/redact/{eventId}/{txnId}</span></tt></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#rooms" id="id311">10&nbsp;&nbsp;&nbsp;Rooms</a><ul class="auto-toc">
<li><a class="reference internal" href="#creation" id="id312">10.1&nbsp;&nbsp;&nbsp;Creation</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-createroom" id="id313">10.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/createRoom</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#room-aliases" id="id314">10.2&nbsp;&nbsp;&nbsp;Room aliases</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-r0-directory-room-roomalias" id="id315">10.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/directory/room/{roomAlias}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-directory-room-roomalias" id="id316">10.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/directory/room/{roomAlias}</span></tt></a></li>
<li><a class="reference internal" href="#delete-matrix-client-r0-directory-room-roomalias" id="id317">10.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">DELETE <span class="pre">/_matrix/client/r0/directory/room/{roomAlias}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#permissions" id="id318">10.3&nbsp;&nbsp;&nbsp;Permissions</a></li>
<li><a class="reference internal" href="#room-membership" id="id319">10.4&nbsp;&nbsp;&nbsp;Room membership</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-joined-rooms" id="id320">10.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/joined_rooms</tt></a></li>
<li><a class="reference internal" href="#joining-rooms" id="id321">10.4.2&nbsp;&nbsp;&nbsp;Joining rooms</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-invite" id="id322">10.4.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/invite</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-join" id="id323">10.4.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/join</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-join-roomidoralias" id="id324">10.4.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/join/{roomIdOrAlias}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#leaving-rooms" id="id325">10.4.3&nbsp;&nbsp;&nbsp;Leaving rooms</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-leave" id="id326">10.4.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/leave</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-forget" id="id327">10.4.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/forget</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-kick" id="id328">10.4.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/kick</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#banning-users-in-a-room" id="id329">10.4.4&nbsp;&nbsp;&nbsp;Banning users in a room</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-ban" id="id330">10.4.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/ban</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-unban" id="id331">10.4.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/unban</span></tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#listing-rooms" id="id332">10.5&nbsp;&nbsp;&nbsp;Listing rooms</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-directory-list-room-roomid" id="id333">10.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/directory/list/room/{roomId}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-r0-directory-list-room-roomid" id="id334">10.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/directory/list/room/{roomId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-publicrooms" id="id335">10.5.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/publicRooms</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-publicrooms" id="id336">10.5.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/publicRooms</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#user-data" id="id337">11&nbsp;&nbsp;&nbsp;User Data</a><ul class="auto-toc">
<li><a class="reference internal" href="#user-directory" id="id338">11.1&nbsp;&nbsp;&nbsp;User Directory</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-user-directory-search" id="id339">11.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/user_directory/search</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#profiles" id="id340">11.2&nbsp;&nbsp;&nbsp;Profiles</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-r0-profile-userid-displayname" id="id341">11.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/profile/{userId}/displayname</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-profile-userid-displayname" id="id342">11.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/profile/{userId}/displayname</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-r0-profile-userid-avatar-url" id="id343">11.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/profile/{userId}/avatar_url</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-profile-userid-avatar-url" id="id344">11.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/profile/{userId}/avatar_url</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-profile-userid" id="id345">11.2.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/profile/{userId}</span></tt></a></li>
<li><a class="reference internal" href="#events-on-change-of-profile-information" id="id346">11.2.6&nbsp;&nbsp;&nbsp;Events on Change of Profile Information</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#security" id="id347">12&nbsp;&nbsp;&nbsp;Security</a><ul class="auto-toc">
<li><a class="reference internal" href="#rate-limiting" id="id348">12.1&nbsp;&nbsp;&nbsp;Rate limiting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#modules" id="id349">13&nbsp;&nbsp;&nbsp;Modules</a><ul class="auto-toc">
<li><a class="reference internal" href="#feature-profiles" id="id350">13.1&nbsp;&nbsp;&nbsp;Feature Profiles</a><ul class="auto-toc">
<li><a class="reference internal" href="#summary" id="id351">13.1.1&nbsp;&nbsp;&nbsp;Summary</a></li>
<li><a class="reference internal" href="#clients" id="id352">13.1.2&nbsp;&nbsp;&nbsp;Clients</a><ul class="auto-toc">
<li><a class="reference internal" href="#stand-alone-web-web" id="id353">13.1.2.1&nbsp;&nbsp;&nbsp;Stand-alone web (<tt class="docutils literal">Web</tt>)</a></li>
<li><a class="reference internal" href="#mobile-mobile" id="id354">13.1.2.2&nbsp;&nbsp;&nbsp;Mobile (<tt class="docutils literal">Mobile</tt>)</a></li>
<li><a class="reference internal" href="#desktop-desktop" id="id355">13.1.2.3&nbsp;&nbsp;&nbsp;Desktop (<tt class="docutils literal">Desktop</tt>)</a></li>
<li><a class="reference internal" href="#command-line-interface-cli" id="id356">13.1.2.4&nbsp;&nbsp;&nbsp;Command Line Interface (<tt class="docutils literal">CLI</tt>)</a></li>
<li><a class="reference internal" href="#embedded-embedded" id="id357">13.1.2.5&nbsp;&nbsp;&nbsp;Embedded (<tt class="docutils literal">Embedded</tt>)</a><ul class="auto-toc">
<li><a class="reference internal" href="#application" id="id358">13.1.2.5.1&nbsp;&nbsp;&nbsp;Application</a></li>
<li><a class="reference internal" href="#device" id="id359">13.1.2.5.2&nbsp;&nbsp;&nbsp;Device</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id86" id="id360">13.2&nbsp;&nbsp;&nbsp;Instant Messaging</a><ul class="auto-toc">
<li><a class="reference internal" href="#id87" id="id361">13.2.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-message" id="id362">13.2.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.message</tt></a></li>
<li><a class="reference internal" href="#m-room-message-feedback" id="id363">13.2.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.message.feedback</tt></a></li>
<li><a class="reference internal" href="#m-room-name" id="id364">13.2.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.name</tt></a></li>
<li><a class="reference internal" href="#m-room-topic" id="id365">13.2.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.topic</tt></a></li>
<li><a class="reference internal" href="#m-room-avatar" id="id366">13.2.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.avatar</tt></a></li>
<li><a class="reference internal" href="#m-room-pinned-events" id="id367">13.2.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.pinned_events</tt></a></li>
<li><a class="reference internal" href="#m-room-message-msgtypes" id="id368">13.2.1.7&nbsp;&nbsp;&nbsp;m.room.message msgtypes</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-text" id="id369">13.2.1.7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.text</tt></a></li>
<li><a class="reference internal" href="#m-emote" id="id370">13.2.1.7.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.emote</tt></a></li>
<li><a class="reference internal" href="#m-notice" id="id371">13.2.1.7.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.notice</tt></a></li>
<li><a class="reference internal" href="#m-image" id="id372">13.2.1.7.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.image</tt></a></li>
<li><a class="reference internal" href="#m-file" id="id373">13.2.1.7.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.file</tt></a></li>
<li><a class="reference internal" href="#m-audio" id="id374">13.2.1.7.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.audio</tt></a></li>
<li><a class="reference internal" href="#m-location" id="id375">13.2.1.7.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.location</tt></a></li>
<li><a class="reference internal" href="#m-video" id="id376">13.2.1.7.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.video</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id88" id="id377">13.2.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#recommendations-when-sending-messages" id="id378">13.2.2.1&nbsp;&nbsp;&nbsp;Recommendations when sending messages</a></li>
<li><a class="reference internal" href="#local-echo" id="id379">13.2.2.2&nbsp;&nbsp;&nbsp;Local echo</a></li>
<li><a class="reference internal" href="#calculating-the-display-name-for-a-user" id="id380">13.2.2.3&nbsp;&nbsp;&nbsp;Calculating the display name for a user</a></li>
<li><a class="reference internal" href="#displaying-membership-information-with-messages" id="id381">13.2.2.4&nbsp;&nbsp;&nbsp;Displaying membership information with messages</a></li>
<li><a class="reference internal" href="#calculating-the-display-name-for-a-room" id="id382">13.2.2.5&nbsp;&nbsp;&nbsp;Calculating the display name for a room</a></li>
<li><a class="reference internal" href="#forming-relationships-between-events" id="id383">13.2.2.6&nbsp;&nbsp;&nbsp;Forming relationships between events</a><ul class="auto-toc">
<li><a class="reference internal" href="#rich-replies" id="id384">13.2.2.6.1&nbsp;&nbsp;&nbsp;Rich replies</a><ul class="auto-toc">
<li><a class="reference internal" href="#fallbacks-and-event-representation" id="id385">13.2.2.6.1.1&nbsp;&nbsp;&nbsp;Fallbacks and event representation</a><ul class="auto-toc">
<li><a class="reference internal" href="#stripping-the-fallback" id="id386">13.2.2.6.1.1.1&nbsp;&nbsp;&nbsp;Stripping the fallback</a></li>
<li><a class="reference internal" href="#fallback-for-m-text-m-notice-and-unrecognised-message-types" id="id387">13.2.2.6.1.1.2&nbsp;&nbsp;&nbsp;Fallback for <tt class="docutils literal">m.text</tt>, <tt class="docutils literal">m.notice</tt>, and unrecognised message types</a></li>
<li><a class="reference internal" href="#fallback-for-m-emote" id="id388">13.2.2.6.1.1.3&nbsp;&nbsp;&nbsp;Fallback for <tt class="docutils literal">m.emote</tt></a></li>
<li><a class="reference internal" href="#fallback-for-m-image-m-video-m-audio-and-m-file" id="id389">13.2.2.6.1.1.4&nbsp;&nbsp;&nbsp;Fallback for <tt class="docutils literal">m.image</tt>, <tt class="docutils literal">m.video</tt>, <tt class="docutils literal">m.audio</tt>, and <tt class="docutils literal">m.file</tt></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#server-behaviour" id="id390">13.2.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#security-considerations" id="id391">13.2.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#voice-over-ip" id="id392">13.3&nbsp;&nbsp;&nbsp;Voice over IP</a><ul class="auto-toc">
<li><a class="reference internal" href="#id89" id="id393">13.3.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-call-invite" id="id394">13.3.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.invite</tt></a></li>
<li><a class="reference internal" href="#m-call-candidates" id="id395">13.3.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.candidates</tt></a></li>
<li><a class="reference internal" href="#m-call-answer" id="id396">13.3.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.answer</tt></a></li>
<li><a class="reference internal" href="#m-call-hangup" id="id397">13.3.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.hangup</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id90" id="id398">13.3.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#glare" id="id399">13.3.2.1&nbsp;&nbsp;&nbsp;Glare</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id91" id="id400">13.3.3&nbsp;&nbsp;&nbsp;Server behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-voip-turnserver" id="id401">13.3.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/voip/turnServer</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id92" id="id402">13.3.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id93" id="id403">13.4&nbsp;&nbsp;&nbsp;Typing Notifications</a><ul class="auto-toc">
<li><a class="reference internal" href="#id94" id="id404">13.4.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-typing" id="id405">13.4.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.typing</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id95" id="id406">13.4.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-r0-rooms-roomid-typing-userid" id="id407">13.4.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/rooms/{roomId}/typing/{userId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id96" id="id408">13.4.3&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id97" id="id409">13.5&nbsp;&nbsp;&nbsp;Receipts</a><ul class="auto-toc">
<li><a class="reference internal" href="#id98" id="id410">13.5.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-receipt" id="id411">13.5.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.receipt</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id99" id="id412">13.5.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-receipt-receipttype-eventid" id="id413">13.5.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/receipt/{receiptType}/{eventId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id100" id="id414">13.5.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id101" id="id415">13.5.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id102" id="id416">13.6&nbsp;&nbsp;&nbsp;Fully read markers</a><ul class="auto-toc">
<li><a class="reference internal" href="#id103" id="id417">13.6.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-fully-read" id="id418">13.6.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.fully_read</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id104" id="id419">13.6.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-read-markers" id="id420">13.6.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/read_markers</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id105" id="id421">13.6.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id106" id="id422">13.7&nbsp;&nbsp;&nbsp;Presence</a><ul class="auto-toc">
<li><a class="reference internal" href="#id107" id="id423">13.7.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-presence" id="id424">13.7.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.presence</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id108" id="id425">13.7.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-r0-presence-userid-status" id="id426">13.7.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/presence/{userId}/status</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-presence-userid-status" id="id427">13.7.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/presence/{userId}/status</span></tt></a></li>
<li><a class="reference internal" href="#last-active-ago" id="id428">13.7.2.3&nbsp;&nbsp;&nbsp;Last active ago</a></li>
<li><a class="reference internal" href="#idle-timeout" id="id429">13.7.2.4&nbsp;&nbsp;&nbsp;Idle timeout</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id109" id="id430">13.7.3&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id110" id="id431">13.8&nbsp;&nbsp;&nbsp;Content repository</a><ul class="auto-toc">
<li><a class="reference internal" href="#matrix-content-mxc-uris" id="id432">13.8.1&nbsp;&nbsp;&nbsp;Matrix Content (MXC) URIs</a></li>
<li><a class="reference internal" href="#id111" id="id433">13.8.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-media-r0-upload" id="id434">13.8.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/media/r0/upload</tt></a></li>
<li><a class="reference internal" href="#get-matrix-media-r0-download-servername-mediaid" id="id435">13.8.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/media/r0/download/{serverName}/{mediaId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-media-r0-download-servername-mediaid-filename" id="id436">13.8.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/media/r0/download/{serverName}/{mediaId}/{fileName}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-media-r0-thumbnail-servername-mediaid" id="id437">13.8.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/media/r0/thumbnail/{serverName}/{mediaId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-media-r0-preview-url" id="id438">13.8.2.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/media/r0/preview_url</tt></a></li>
<li><a class="reference internal" href="#get-matrix-media-r0-config" id="id439">13.8.2.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/media/r0/config</tt></a></li>
<li><a class="reference internal" href="#thumbnails" id="id440">13.8.2.7&nbsp;&nbsp;&nbsp;Thumbnails</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id113" id="id441">13.8.3&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id114" id="id442">13.9&nbsp;&nbsp;&nbsp;Send-to-Device messaging</a><ul class="auto-toc">
<li><a class="reference internal" href="#id115" id="id443">13.9.1&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
<li><a class="reference internal" href="#id116" id="id444">13.9.2&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#protocol-definitions" id="id445">13.9.3&nbsp;&nbsp;&nbsp;Protocol definitions</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-r0-sendtodevice-eventtype-txnid" id="id446">13.9.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/sendToDevice/{eventType}/{txnId}</span></tt></a></li>
<li><a class="reference internal" href="#extensions-to-sync" id="id447">13.9.3.2&nbsp;&nbsp;&nbsp;Extensions to /sync</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id117" id="id448">13.10&nbsp;&nbsp;&nbsp;Device Management</a><ul class="auto-toc">
<li><a class="reference internal" href="#id118" id="id449">13.10.1&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-devices" id="id450">13.10.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/devices</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-devices-deviceid" id="id451">13.10.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/devices/{deviceId}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-r0-devices-deviceid" id="id452">13.10.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/devices/{deviceId}</span></tt></a></li>
<li><a class="reference internal" href="#delete-matrix-client-r0-devices-deviceid" id="id453">13.10.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">DELETE <span class="pre">/_matrix/client/r0/devices/{deviceId}</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-delete-devices" id="id454">13.10.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/delete_devices</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id119" id="id455">13.10.2&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id120" id="id456">13.11&nbsp;&nbsp;&nbsp;End-to-End Encryption</a><ul class="auto-toc">
<li><a class="reference internal" href="#key-distribution" id="id457">13.11.1&nbsp;&nbsp;&nbsp;Key Distribution</a><ul class="auto-toc">
<li><a class="reference internal" href="#id121" id="id458">13.11.1.1&nbsp;&nbsp;&nbsp;Overview</a></li>
<li><a class="reference internal" href="#key-algorithms" id="id459">13.11.1.2&nbsp;&nbsp;&nbsp;Key algorithms</a></li>
<li><a class="reference internal" href="#id122" id="id460">13.11.1.3&nbsp;&nbsp;&nbsp;Device keys</a></li>
<li><a class="reference internal" href="#uploading-keys" id="id461">13.11.1.4&nbsp;&nbsp;&nbsp;Uploading keys</a></li>
<li><a class="reference internal" href="#tracking-the-device-list-for-a-user" id="id462">13.11.1.5&nbsp;&nbsp;&nbsp;Tracking the device list for a user</a></li>
<li><a class="reference internal" href="#sending-encrypted-attachments" id="id463">13.11.1.6&nbsp;&nbsp;&nbsp;Sending encrypted attachments</a><ul class="auto-toc">
<li><a class="reference internal" href="#extensions-to-m-message-msgtypes" id="id464">13.11.1.6.1&nbsp;&nbsp;&nbsp;Extensions to <tt class="docutils literal">m.message</tt> msgtypes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#claiming-one-time-keys" id="id465">13.11.1.7&nbsp;&nbsp;&nbsp;Claiming one-time keys</a></li>
</ul>
</li>
<li><a class="reference internal" href="#device-verification" id="id466">13.11.2&nbsp;&nbsp;&nbsp;Device verification</a><ul class="auto-toc">
<li><a class="reference internal" href="#key-verification-framework" id="id467">13.11.2.1&nbsp;&nbsp;&nbsp;Key verification framework</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-key-verification-request" id="id468">13.11.2.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.request</tt></a></li>
<li><a class="reference internal" href="#m-key-verification-start" id="id469">13.11.2.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.start</tt></a></li>
<li><a class="reference internal" href="#m-key-verification-cancel" id="id470">13.11.2.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.cancel</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#short-authentication-string-sas-verification" id="id471">13.11.2.2&nbsp;&nbsp;&nbsp;Short Authentication String (SAS) verification</a><ul class="auto-toc">
<li><a class="reference internal" href="#error-and-exception-handling" id="id472">13.11.2.2.1&nbsp;&nbsp;&nbsp;Error and exception handling</a></li>
<li><a class="reference internal" href="#verification-messages-specific-to-sas" id="id473">13.11.2.2.2&nbsp;&nbsp;&nbsp;Verification messages specific to SAS</a></li>
<li><a class="reference internal" href="#id123" id="id474">13.11.2.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.start</tt></a></li>
<li><a class="reference internal" href="#m-key-verification-accept" id="id475">13.11.2.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.accept</tt></a></li>
<li><a class="reference internal" href="#m-key-verification-key" id="id476">13.11.2.2.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.key</tt></a></li>
<li><a class="reference internal" href="#m-key-verification-mac" id="id477">13.11.2.2.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.mac</tt></a></li>
<li><a class="reference internal" href="#hkdf-calculation" id="id478">13.11.2.2.7&nbsp;&nbsp;&nbsp;HKDF calculation</a></li>
<li><a class="reference internal" href="#sas-method-decimal" id="id479">13.11.2.2.8&nbsp;&nbsp;&nbsp;SAS method: <tt class="docutils literal">decimal</tt></a></li>
<li><a class="reference internal" href="#sas-method-emoji" id="id480">13.11.2.2.9&nbsp;&nbsp;&nbsp;SAS method: <tt class="docutils literal">emoji</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#sharing-keys-between-devices" id="id481">13.11.3&nbsp;&nbsp;&nbsp;Sharing keys between devices</a><ul class="auto-toc">
<li><a class="reference internal" href="#key-requests" id="id482">13.11.3.1&nbsp;&nbsp;&nbsp;Key requests</a></li>
<li><a class="reference internal" href="#key-exports" id="id483">13.11.3.2&nbsp;&nbsp;&nbsp;Key exports</a><ul class="auto-toc">
<li><a class="reference internal" href="#key-export-format" id="id484">13.11.3.2.1&nbsp;&nbsp;&nbsp;Key export format</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#messaging-algorithms" id="id485">13.11.4&nbsp;&nbsp;&nbsp;Messaging Algorithms</a><ul class="auto-toc">
<li><a class="reference internal" href="#messaging-algorithm-names" id="id486">13.11.4.1&nbsp;&nbsp;&nbsp;Messaging Algorithm Names</a></li>
<li><a class="reference internal" href="#m-olm-v1-curve25519-aes-sha2" id="id487">13.11.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">m.olm.v1.curve25519-aes-sha2</span></tt></a><ul class="auto-toc">
<li><a class="reference internal" href="#recovering-from-undecryptable-messages" id="id488">13.11.4.2.1&nbsp;&nbsp;&nbsp;Recovering from undecryptable messages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#m-megolm-v1-aes-sha2" id="id489">13.11.4.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">m.megolm.v1.aes-sha2</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id125" id="id490">13.11.5&nbsp;&nbsp;&nbsp;Protocol definitions</a><ul class="auto-toc">
<li><a class="reference internal" href="#id126" id="id491">13.11.5.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-encryption" id="id492">13.11.5.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.encryption</tt></a></li>
<li><a class="reference internal" href="#m-room-encrypted" id="id493">13.11.5.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.encrypted</tt></a></li>
<li><a class="reference internal" href="#m-room-key" id="id494">13.11.5.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room_key</tt></a></li>
<li><a class="reference internal" href="#m-room-key-request" id="id495">13.11.5.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room_key_request</tt></a></li>
<li><a class="reference internal" href="#m-forwarded-room-key" id="id496">13.11.5.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.forwarded_room_key</tt></a></li>
<li><a class="reference internal" href="#id127" id="id497">13.11.5.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.dummy</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#key-management-api" id="id498">13.11.5.2&nbsp;&nbsp;&nbsp;Key management API</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-keys-upload" id="id499">13.11.5.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/keys/upload</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-keys-query" id="id500">13.11.5.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/keys/query</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-keys-claim" id="id501">13.11.5.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/keys/claim</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-keys-changes" id="id502">13.11.5.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/keys/changes</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id129" id="id503">13.11.5.3&nbsp;&nbsp;&nbsp;Extensions to /sync</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#room-history-visibility" id="id504">13.12&nbsp;&nbsp;&nbsp;Room History Visibility</a><ul class="auto-toc">
<li><a class="reference internal" href="#id130" id="id505">13.12.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-history-visibility" id="id506">13.12.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.history_visibility</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id131" id="id507">13.12.2&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
<li><a class="reference internal" href="#id132" id="id508">13.12.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id133" id="id509">13.12.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id134" id="id510">13.13&nbsp;&nbsp;&nbsp;Push Notifications</a><ul class="auto-toc">
<li><a class="reference internal" href="#id135" id="id511">13.13.1&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-pushers" id="id512">13.13.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/pushers</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-r0-pushers-set" id="id513">13.13.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/pushers/set</tt></a></li>
<li><a class="reference internal" href="#listing-notifications" id="id514">13.13.1.3&nbsp;&nbsp;&nbsp;Listing Notifications</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-notifications" id="id515">13.13.1.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/notifications</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id136" id="id516">13.13.1.4&nbsp;&nbsp;&nbsp;Receiving notifications</a></li>
<li><a class="reference internal" href="#push-rules" id="id517">13.13.1.5&nbsp;&nbsp;&nbsp;Push Rules</a><ul class="auto-toc">
<li><a class="reference internal" href="#actions" id="id518">13.13.1.5.1&nbsp;&nbsp;&nbsp;Actions</a><ul class="auto-toc">
<li><a class="reference internal" href="#tweaks" id="id519">13.13.1.5.1.1&nbsp;&nbsp;&nbsp;Tweaks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#predefined-rules" id="id520">13.13.1.5.2&nbsp;&nbsp;&nbsp;Predefined Rules</a><ul class="auto-toc">
<li><a class="reference internal" href="#default-override-rules" id="id521">13.13.1.5.2.1&nbsp;&nbsp;&nbsp;Default Override Rules</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-rule-master" id="id522">13.13.1.5.2.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.master</tt></a></li>
<li><a class="reference internal" href="#m-rule-suppress-notices" id="id523">13.13.1.5.2.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.suppress_notices</tt></a></li>
<li><a class="reference internal" href="#m-rule-invite-for-me" id="id524">13.13.1.5.2.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.invite_for_me</tt></a></li>
<li><a class="reference internal" href="#m-rule-member-event" id="id525">13.13.1.5.2.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.member_event</tt></a></li>
<li><a class="reference internal" href="#m-rule-contains-display-name" id="id526">13.13.1.5.2.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.contains_display_name</tt></a></li>
<li><a class="reference internal" href="#m-rule-tombstone" id="id527">13.13.1.5.2.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.tombstone</tt></a></li>
<li><a class="reference internal" href="#m-rule-roomnotif" id="id528">13.13.1.5.2.1.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.roomnotif</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#default-content-rules" id="id529">13.13.1.5.2.2&nbsp;&nbsp;&nbsp;Default Content Rules</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-rule-contains-user-name" id="id530">13.13.1.5.2.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.contains_user_name</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#default-underride-rules" id="id531">13.13.1.5.2.3&nbsp;&nbsp;&nbsp;Default Underride Rules</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-rule-call" id="id532">13.13.1.5.2.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.call</tt></a></li>
<li><a class="reference internal" href="#m-rule-encrypted-room-one-to-one" id="id533">13.13.1.5.2.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.encrypted_room_one_to_one</tt></a></li>
<li><a class="reference internal" href="#m-rule-room-one-to-one" id="id534">13.13.1.5.2.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.room_one_to_one</tt></a></li>
<li><a class="reference internal" href="#m-rule-message" id="id535">13.13.1.5.2.3.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.message</tt></a></li>
<li><a class="reference internal" href="#m-rule-encrypted" id="id536">13.13.1.5.2.3.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.encrypted</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#conditions" id="id537">13.13.1.5.3&nbsp;&nbsp;&nbsp;Conditions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#push-rules-api" id="id538">13.13.1.6&nbsp;&nbsp;&nbsp;Push Rules: API</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-pushrules" id="id539">13.13.1.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/pushrules/</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-pushrules-scope-kind-ruleid" id="id540">13.13.1.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></li>
<li><a class="reference internal" href="#delete-matrix-client-r0-pushrules-scope-kind-ruleid" id="id541">13.13.1.6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">DELETE <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-r0-pushrules-scope-kind-ruleid" id="id542">13.13.1.6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-pushrules-scope-kind-ruleid-enabled" id="id543">13.13.1.6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}/enabled</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-r0-pushrules-scope-kind-ruleid-enabled" id="id544">13.13.1.6.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}/enabled</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-pushrules-scope-kind-ruleid-actions" id="id545">13.13.1.6.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}/actions</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-r0-pushrules-scope-kind-ruleid-actions" id="id546">13.13.1.6.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}/actions</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#push-rules-events" id="id547">13.13.1.7&nbsp;&nbsp;&nbsp;Push Rules: Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-push-rules" id="id548">13.13.1.7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.push_rules</tt></a></li>
<li><a class="reference internal" href="#examples" id="id549">13.13.1.7.2&nbsp;&nbsp;&nbsp;Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id141" id="id550">13.13.2&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#push-gateway-behaviour" id="id551">13.13.3&nbsp;&nbsp;&nbsp;Push Gateway behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#recommendations-for-apns" id="id552">13.13.3.1&nbsp;&nbsp;&nbsp;Recommendations for APNS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id142" id="id553">13.13.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#third-party-invites" id="id554">13.14&nbsp;&nbsp;&nbsp;Third party invites</a><ul class="auto-toc">
<li><a class="reference internal" href="#id144" id="id555">13.14.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-third-party-invite" id="id556">13.14.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.third_party_invite</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id145" id="id557">13.14.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#id146" id="id558">13.14.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/invite</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id147" id="id559">13.14.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id148" id="id560">13.14.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id149" id="id561">13.15&nbsp;&nbsp;&nbsp;Server Side Search</a><ul class="auto-toc">
<li><a class="reference internal" href="#id150" id="id562">13.15.1&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-search" id="id563">13.15.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/search</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#search-categories" id="id564">13.15.2&nbsp;&nbsp;&nbsp;Search Categories</a><ul class="auto-toc">
<li><a class="reference internal" href="#id153" id="id565">13.15.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">room_events</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#ordering" id="id566">13.15.3&nbsp;&nbsp;&nbsp;Ordering</a></li>
<li><a class="reference internal" href="#groups" id="id567">13.15.4&nbsp;&nbsp;&nbsp;Groups</a></li>
<li><a class="reference internal" href="#id154" id="id568">13.15.5&nbsp;&nbsp;&nbsp;Pagination</a></li>
<li><a class="reference internal" href="#id155" id="id569">13.15.6&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#guest-access" id="id570">13.16&nbsp;&nbsp;&nbsp;Guest Access</a><ul class="auto-toc">
<li><a class="reference internal" href="#id156" id="id571">13.16.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-guest-access" id="id572">13.16.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.guest_access</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id157" id="id573">13.16.2&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
<li><a class="reference internal" href="#id159" id="id574">13.16.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id160" id="id575">13.16.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id161" id="id576">13.17&nbsp;&nbsp;&nbsp;Room Previews</a><ul class="auto-toc">
<li><a class="reference internal" href="#id162" id="id577">13.17.1&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#id166" id="id578">13.17.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/events</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id167" id="id579">13.17.2&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id168" id="id580">13.17.3&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#room-tagging" id="id581">13.18&nbsp;&nbsp;&nbsp;Room Tagging</a><ul class="auto-toc">
<li><a class="reference internal" href="#id169" id="id582">13.18.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-tag" id="id583">13.18.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.tag</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id170" id="id584">13.18.2&nbsp;&nbsp;&nbsp;Client Behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-user-userid-rooms-roomid-tags" id="id585">13.18.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/user/{userId}/rooms/{roomId}/tags</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-r0-user-userid-rooms-roomid-tags-tag" id="id586">13.18.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/user/{userId}/rooms/{roomId}/tags/{tag}</span></tt></a></li>
<li><a class="reference internal" href="#delete-matrix-client-r0-user-userid-rooms-roomid-tags-tag" id="id587">13.18.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">DELETE <span class="pre">/_matrix/client/r0/user/{userId}/rooms/{roomId}/tags/{tag}</span></tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id171" id="id588">13.19&nbsp;&nbsp;&nbsp;Client Config</a><ul class="auto-toc">
<li><a class="reference internal" href="#id172" id="id589">13.19.1&nbsp;&nbsp;&nbsp;Events</a></li>
<li><a class="reference internal" href="#id173" id="id590">13.19.2&nbsp;&nbsp;&nbsp;Client Behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-r0-user-userid-account-data-type" id="id591">13.19.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/user/{userId}/account_data/{type}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-user-userid-account-data-type" id="id592">13.19.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/user/{userId}/account_data/{type}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-r0-user-userid-rooms-roomid-account-data-type" id="id593">13.19.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/user/{userId}/rooms/{roomId}/account_data/{type}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-user-userid-rooms-roomid-account-data-type" id="id594">13.19.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/user/{userId}/rooms/{roomId}/account_data/{type}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id174" id="id595">13.19.3&nbsp;&nbsp;&nbsp;Server Behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id175" id="id596">13.20&nbsp;&nbsp;&nbsp;Server Administration</a><ul class="auto-toc">
<li><a class="reference internal" href="#id176" id="id597">13.20.1&nbsp;&nbsp;&nbsp;Client Behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-admin-whois-userid" id="id598">13.20.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/admin/whois/{userId}</span></tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id177" id="id599">13.21&nbsp;&nbsp;&nbsp;Event Context</a><ul class="auto-toc">
<li><a class="reference internal" href="#id178" id="id600">13.21.1&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-rooms-roomid-context-eventid" id="id601">13.21.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/context/{eventId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id180" id="id602">13.21.2&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sso-client-login" id="id603">13.22&nbsp;&nbsp;&nbsp;SSO client login</a><ul class="auto-toc">
<li><a class="reference internal" href="#id181" id="id604">13.22.1&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-login-sso-redirect" id="id605">13.22.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/login/sso/redirect</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id182" id="id606">13.22.2&nbsp;&nbsp;&nbsp;Server behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#handling-the-redirect-endpoint" id="id607">13.22.2.1&nbsp;&nbsp;&nbsp;Handling the redirect endpoint</a></li>
<li><a class="reference internal" href="#handling-the-authentication-endpoint" id="id608">13.22.2.2&nbsp;&nbsp;&nbsp;Handling the authentication endpoint</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id185" id="id609">13.23&nbsp;&nbsp;&nbsp;Direct Messaging</a><ul class="auto-toc">
<li><a class="reference internal" href="#id186" id="id610">13.23.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-direct" id="id611">13.23.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.direct</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id187" id="id612">13.23.2&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
<li><a class="reference internal" href="#id188" id="id613">13.23.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id189" id="id614">13.24&nbsp;&nbsp;&nbsp;Ignoring Users</a><ul class="auto-toc">
<li><a class="reference internal" href="#id190" id="id615">13.24.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-ignored-user-list" id="id616">13.24.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.ignored_user_list</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id191" id="id617">13.24.2&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
<li><a class="reference internal" href="#id192" id="id618">13.24.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sticker-messages" id="id619">13.25&nbsp;&nbsp;&nbsp;Sticker Messages</a><ul class="auto-toc">
<li><a class="reference internal" href="#id193" id="id620">13.25.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-sticker" id="id621">13.25.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.sticker</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id194" id="id622">13.25.2&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id195" id="id623">13.26&nbsp;&nbsp;&nbsp;Reporting Content</a><ul class="auto-toc">
<li><a class="reference internal" href="#id196" id="id624">13.26.1&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-report-eventid" id="id625">13.26.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/report/{eventId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id197" id="id626">13.26.2&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id198" id="id627">13.27&nbsp;&nbsp;&nbsp;Third Party Networks</a><ul class="auto-toc">
<li><a class="reference internal" href="#third-party-lookups" id="id628">13.27.1&nbsp;&nbsp;&nbsp;Third Party Lookups</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-r0-thirdparty-protocols" id="id629">13.27.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/thirdparty/protocols</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-thirdparty-protocol-protocol" id="id630">13.27.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/thirdparty/protocol/{protocol}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-thirdparty-location-protocol" id="id631">13.27.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/thirdparty/location/{protocol}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-thirdparty-user-protocol" id="id632">13.27.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/thirdparty/user/{protocol}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-thirdparty-location" id="id633">13.27.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/thirdparty/location</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-r0-thirdparty-user" id="id634">13.27.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/thirdparty/user</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id199" id="id635">13.28&nbsp;&nbsp;&nbsp;OpenID</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-user-userid-openid-request-token" id="id636">13.28.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/user/{userId}/openid/request_token</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#server-access-control-lists-acls-for-rooms" id="id637">13.29&nbsp;&nbsp;&nbsp;Server Access Control Lists (ACLs) for rooms</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-server-acl" id="id638">13.29.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.server_acl</tt></a></li>
<li><a class="reference internal" href="#id200" id="id639">13.29.2&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
<li><a class="reference internal" href="#id201" id="id640">13.29.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id202" id="id641">13.29.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-room-and-group-mentions" id="id642">13.30&nbsp;&nbsp;&nbsp;User, room, and group mentions</a><ul class="auto-toc">
<li><a class="reference internal" href="#id203" id="id643">13.30.1&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id205" id="id644">13.31&nbsp;&nbsp;&nbsp;Room Upgrades</a><ul class="auto-toc">
<li><a class="reference internal" href="#id206" id="id645">13.31.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-tombstone" id="id646">13.31.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.tombstone</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id207" id="id647">13.31.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-r0-rooms-roomid-upgrade" id="id648">13.31.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/upgrade</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id208" id="id649">13.31.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id209" id="id650">13.32&nbsp;&nbsp;&nbsp;Server Notices</a><ul class="auto-toc">
<li><a class="reference internal" href="#id210" id="id651">13.32.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-message-m-server-notice" id="id652">13.32.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.message (m.server_notice)</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id211" id="id653">13.32.2&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
<li><a class="reference internal" href="#id212" id="id654">13.32.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p><a class="anchor" id="changelog"></a></p>
<div class="section" id="changelog">
<h1><a class="toc-backref" href="#id213">1&nbsp;&nbsp;&nbsp;Changelog</a></h1>
<div class="topic">
<p class="topic-title first">Version: r0.5.0</p>
<p>Breaking Changes</p>
<ul class="simple">
<li>Add a new <tt class="docutils literal">submit_url</tt> field to the responses of <tt class="docutils literal">/requestToken</tt> which older clients will not be able to handle correctly. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2101">#2101</a>)</li>
</ul>
<p>Deprecations</p>
<ul class="simple">
<li>Remove references to presence lists. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1817">#1817</a>)</li>
</ul>
<p>New Endpoints</p>
<ul class="simple">
<li><tt class="docutils literal">GET /account_data</tt> routes. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1873">#1873</a>)</li>
</ul>
<p>Backwards Compatible Changes</p>
<ul class="simple">
<li>Add megolm session export format. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1701">#1701</a>)</li>
<li>Add support for advertising experimental features to clients. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1786">#1786</a>)</li>
<li>Add a generic SSO login API. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1789">#1789</a>)</li>
<li>Add a mechanism for servers to redirect clients to an alternative homeserver after logging in. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1790">#1790</a>)</li>
<li>Add room version upgrades. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1791">#1791</a>, <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1875">#1875</a>)</li>
<li>Support optional features by having clients query for capabilities. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1829">#1829</a>, <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1879">#1879</a>)</li>
<li>Add <tt class="docutils literal">M_RESOURCE_LIMIT_EXCEEDED</tt> as an error code for when homeservers exceed limits imposed on them. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1874">#1874</a>)</li>
<li>Emit <tt class="docutils literal">M_UNSUPPORTED_ROOM_VERSION</tt> error codes where applicable on <tt class="docutils literal">/createRoom</tt> and <tt class="docutils literal">/invite</tt> APIs. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1908">#1908</a>)</li>
<li>Add a <tt class="docutils literal">.m.rule.tombstone</tt> default push rule for room ugprade notifications. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2020">#2020</a>)</li>
<li>Add support for sending server notices to clients. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2026">#2026</a>)</li>
<li>Add MSISDN (phone number) support to User-Interactive Authentication. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2030">#2030</a>)</li>
<li>Add the option to lazy-load room members for increased client performance. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2035">#2035</a>)</li>
<li>Add <tt class="docutils literal">id_server</tt> to <tt class="docutils literal">/deactivate</tt> and <tt class="docutils literal">/3pid/delete</tt> endpoints to unbind from a specific identity server. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2046">#2046</a>)</li>
<li>Add support for Olm sessions becoming un-stuck. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2059">#2059</a>)</li>
<li>Add interactive device verification, including a common framework for device verification. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2072">#2072</a>)</li>
</ul>
<p>Spec Clarifications</p>
<ul class="simple">
<li>Change examples to use example.org instead of a real domain. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1650">#1650</a>)</li>
<li>Clarify that <tt class="docutils literal">state_default</tt> in <tt class="docutils literal">m.room.power_levels</tt> always defaults to 50. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1656">#1656</a>)</li>
<li>Add missing <tt class="docutils literal">status_msg</tt> to <tt class="docutils literal">m.presence</tt> schema. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1744">#1744</a>)</li>
<li>Fix various spelling mistakes throughout the specification. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1838">#1838</a>, <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1853">#1853</a>, <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1860">#1860</a>, <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1933">#1933</a>, <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1969">#1969</a>, <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1988">#1988</a>, <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1989">#1989</a>, <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1991">#1991</a>, <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1992">#1992</a>)</li>
<li>Add the missing <tt class="docutils literal">m.push_rules</tt> event schema. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1889">#1889</a>)</li>
<li>Clarify how modern day local echo is meant to be solved by clients. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1891">#1891</a>)</li>
<li>Clarify that <tt class="docutils literal">width</tt> and <tt class="docutils literal">height</tt> are required parameters on <tt class="docutils literal"><span class="pre">/_matrix/media/r0/thumbnail/{serverName}/{mediaId}</span></tt>. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1975">#1975</a>)</li>
<li>Clarify how <tt class="docutils literal">m.login.dummy</tt> can be used to disambiguate login flows. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1999">#1999</a>)</li>
<li>Remove <tt class="docutils literal">prev_content</tt> from the redaction algorithm's essential keys list. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2016">#2016</a>)</li>
<li>Fix the <tt class="docutils literal">third_party_signed</tt> definitions for the join APIs. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2025">#2025</a>)</li>
<li>Clarify why User Interactive Auth is used on password changes and how access tokens are handled. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2027">#2027</a>)</li>
<li>Clarify that devices are deleted upon logout. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2028">#2028</a>)</li>
<li>Add <tt class="docutils literal">M_NOT_FOUND</tt> error definition for deleting room aliases. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2029">#2029</a>)</li>
<li>Add missing <tt class="docutils literal">reason</tt> to <tt class="docutils literal">m.call.hangup</tt>. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2031">#2031</a>)</li>
<li>Clarify how redactions affect room state. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2032">#2032</a>)</li>
<li>Clarify that <tt class="docutils literal">FAIL_ERROR</tt> in autodiscovery is not limited to just homeservers. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2036">#2036</a>)</li>
<li>Fix example <tt class="docutils literal"><span class="pre">Content-Type</span></tt> for <tt class="docutils literal">/media/upload</tt> request. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2041">#2041</a>)</li>
<li>Clarify that login flows are meant to be completed in order. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2042">#2042</a>)</li>
<li>Clarify that clients should not send read receipts for their own messages. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2043">#2043</a>)</li>
<li>Use consistent examples of events throughout the specification. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2051">#2051</a>)</li>
<li>Clarify which push rule condition kinds exist. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2052">#2052</a>)</li>
<li>Clarify the required fields on <tt class="docutils literal">m.file</tt> (and similar) messages. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2053">#2053</a>)</li>
<li>Clarify that User-Interactive Authentication stages cannot be attempted more than once. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2054">#2054</a>)</li>
<li>Clarify which parameters apply in what scenarios on <tt class="docutils literal">/register</tt>. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2055">#2055</a>)</li>
<li>Clarify how to interpret changes of <tt class="docutils literal">membership</tt> over time. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2056">#2056</a>)</li>
<li>Clarify exactly what invite_room_state consists of. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2067">#2067</a>)</li>
<li>Clarify how the content repository works, and what it is used for. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2068">#2068</a>)</li>
<li>Clarify the order events in chunk are returned in for <tt class="docutils literal">/messages</tt>. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2069">#2069</a>)</li>
<li>Clarify the key object definition for the key management API. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2083">#2083</a>)</li>
<li>Reorganize information about events into a common section. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2087">#2087</a>)</li>
<li>De-duplicate <tt class="docutils literal"><span class="pre">/state/&lt;event_type&gt;</span></tt> endpoints, clarifying that the <tt class="docutils literal">&lt;state_key&gt;</tt> is optional. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2088">#2088</a>)</li>
<li>Clarify when and where CORS headers should be returned. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2089">#2089</a>)</li>
<li>Clarify when authorization and rate-limiting are not applicable. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2090">#2090</a>)</li>
<li>Clarify that <tt class="docutils literal">/register</tt> must produce valid Matrix User IDs. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2091">#2091</a>)</li>
<li>Clarify how <tt class="docutils literal">unread_notifications</tt> is calculated. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2097">#2097</a>)</li>
<li>Clarify what a &quot;module&quot; is and update feature profiles for clients. (<a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/2098">#2098</a>)</li>
</ul>
</div>
<p>This version of the specification is generated from
<a class="reference external" href="https://github.com/matrix-org/matrix-doc">matrix-doc</a> as of Git commit
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/tree/19a3d574">master,19a3d574</a>.</p>
<p>For the full historical changelog, see
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/blob/main/changelogs/legacy/client_server.rst">https://github.com/matrix-org/matrix-doc/blob/main/changelogs/legacy/client_server.rst</a></p>
<p><a class="anchor" id="other-versions-of-this-specification"></a></p>
<div class="section" id="other-versions-of-this-specification">
<h2><a class="toc-backref" href="#id214">1.1&nbsp;&nbsp;&nbsp;Other versions of this specification</a></h2>
<p>The following other versions are also available, in reverse chronological order:</p>
<ul class="simple">
<li><a class="reference external" href="https://matrix.org/docs/spec/client_server/unstable.html">HEAD</a>: Includes all changes since the latest versioned release.</li>
<li><a class="reference external" href="https://matrix.org/docs/spec/client_server/r0.5.0.html">r0.5.0</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/client_server/r0.4.0.html">r0.4.0</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/client_server/r0.3.0.html">r0.3.0</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/client_server/r0.2.0.html">r0.2.0</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/client_server/r0.1.0.html">r0.1.0</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/r0.0.1/client_server.html">r0.0.1</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/r0.0.0/client_server.html">r0.0.0</a></li>
<li><a class="reference external" href="https://matrix.org/docs/spec/legacy/#client-server-api">Legacy</a>: The last draft before the spec was formally released in version r0.0.0.</li>
</ul>
</div>
</div>
<p><a class="anchor" id="api-standards"></a></p>
<div class="section" id="api-standards">
<h1><a class="toc-backref" href="#id215">2&nbsp;&nbsp;&nbsp;API Standards</a></h1>
<!-- TODO: Move a lot of this to a common area for all specs. -->
<!-- TODO
Need to specify any HMAC or access_token lifetime/ratcheting tricks
We need to specify capability negotiation for extensible transports -->
<p>The mandatory baseline for client-server communication in Matrix is exchanging
JSON objects over HTTP APIs. HTTPS is recommended for communication, although
HTTP may be supported as a fallback to support basic
HTTP clients. More efficient optional transports
will in future be supported as optional extensions - e.g. a
packed binary encoding over stream-cipher encrypted TCP socket for
low-bandwidth/low-roundtrip mobile usage. For the default HTTP transport, all
API calls use a Content-Type of <tt class="docutils literal">application/json</tt>.  In addition, all strings
MUST be encoded as UTF-8. Clients are authenticated using opaque
<tt class="docutils literal">access_token</tt> strings (see <a class="reference internal" href="#client-authentication">Client Authentication</a> for details), passed as a
query string parameter on all requests.</p>
<p>The names of the API endpoints for the HTTP transport follow a convention of
using underscores to separate words (for example <tt class="docutils literal">/delete_devices</tt>). The key
names in JSON objects passed over the API also follow this convention.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are a few historical exceptions to this rule, such as
<tt class="docutils literal">/createRoom</tt>. A future version of this specification will address the
inconsistency.</p>
</div>
<p>Any errors which occur at the Matrix API level MUST return a &quot;standard error
response&quot;. This is a JSON object which looks like:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;error code&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;error message&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>The <tt class="docutils literal">error</tt> string will be a human-readable error message, usually a sentence
explaining what went wrong. The <tt class="docutils literal">errcode</tt> string will be a unique string
which can be used to handle an error message e.g. <tt class="docutils literal">M_FORBIDDEN</tt>. These error
codes should have their namespace first in ALL CAPS, followed by a single _ to
ease separating the namespace from the error code. For example, if there was a
custom namespace <tt class="docutils literal">com.mydomain.here</tt>, and a
<tt class="docutils literal">FORBIDDEN</tt> code, the error code should look like
<tt class="docutils literal">COM.MYDOMAIN.HERE_FORBIDDEN</tt>. There may be additional keys depending on the
error, but the keys <tt class="docutils literal">error</tt> and <tt class="docutils literal">errcode</tt> MUST always be present.</p>
<p>Errors are generally best expressed by their error code rather than the HTTP
status code returned. When encountering the error code <tt class="docutils literal">M_UNKNOWN</tt>, clients
should prefer the HTTP status code as a more reliable reference for what the
issue was. For example, if the client receives an error code of <tt class="docutils literal">M_NOT_FOUND</tt>
but the request gave a 400 Bad Request status code, the client should treat
the error as if the resource was not found. However, if the client were to
receive an error code of <tt class="docutils literal">M_UNKNOWN</tt> with a 400 Bad Request, the client
should assume that the request being made was invalid.</p>
<p>The common error codes are:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name"><tt class="docutils literal">M_FORBIDDEN</tt>:</th><td class="field-body">Forbidden access, e.g. joining a room without permission, failed login.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_UNKNOWN_TOKEN</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The access token specified was not recognised.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_MISSING_TOKEN</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">No access token was specified for the request.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_BAD_JSON</tt>:</th><td class="field-body">Request contained valid JSON, but it was malformed in some way, e.g. missing
required keys, invalid values for keys.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_NOT_JSON</tt>:</th><td class="field-body">Request did not contain valid JSON.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_NOT_FOUND</tt>:</th><td class="field-body">No resource was found for this request.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_LIMIT_EXCEEDED</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">Too many requests have been sent in a short period of time. Wait a while then
try again.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_UNKNOWN</tt>:</th><td class="field-body">An unknown error has occurred.</td>
</tr>
</tbody>
</table>
<p>Other error codes the client might encounter are:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name"><tt class="docutils literal">M_UNRECOGNIZED</tt>:</th><td class="field-body">The server did not understand the request.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_UNAUTHORIZED</tt>:</th><td class="field-body">The request was not correctly authorized. Usually due to login failures.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_USER_IN_USE</tt>:</th><td class="field-body">Encountered when trying to register a user ID which has been taken.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_INVALID_USERNAME</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">Encountered when trying to register a user ID which is not valid.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_ROOM_IN_USE</tt>:</th><td class="field-body">Sent when the room alias given to the <tt class="docutils literal">createRoom</tt> API is already in use.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_INVALID_ROOM_STATE</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">Sent when the initial state given to the <tt class="docutils literal">createRoom</tt> API is invalid.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_THREEPID_IN_USE</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">Sent when a threepid given to an API cannot be used because the same threepid is already in use.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_THREEPID_NOT_FOUND</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">Sent when a threepid given to an API cannot be used because no record matching the threepid was found.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_THREEPID_AUTH_FAILED</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">Authentication could not be performed on the third party identifier.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_THREEPID_DENIED</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The server does not permit this third party identifier. This may happen if the server only
permits, for example, email addresses from a particular domain.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_SERVER_NOT_TRUSTED</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The client's request used a third party server, eg. identity server, that this server does not trust.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_UNSUPPORTED_ROOM_VERSION</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The client's request to create a room used a room version that the server does not support.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_INCOMPATIBLE_ROOM_VERSION</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The client attempted to join a room that has a version the server does not support. Inspect the
<tt class="docutils literal">room_version</tt> property of the error response for the room's version.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_BAD_STATE</tt>:</th><td class="field-body">The state change requested cannot be performed, such as attempting to unban
a user who is not banned.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_GUEST_ACCESS_FORBIDDEN</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The room or resource does not permit guests to access it.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_CAPTCHA_NEEDED</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">A Captcha is required to complete the request.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_CAPTCHA_INVALID</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The Captcha provided did not match what was expected.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_MISSING_PARAM</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">A required parameter was missing from the request.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_INVALID_PARAM</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">A parameter that was specified has the wrong value. For example, the server
expected an integer and instead received a string.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_TOO_LARGE</tt>:</th><td class="field-body">The request or entity was too large.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_EXCLUSIVE</tt>:</th><td class="field-body">The resource being requested is reserved by an application service, or the
application service making the request has not created the resource.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_RESOURCE_LIMIT_EXCEEDED</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The request cannot be completed because the homeserver has reached a resource
limit imposed on it. For example, a homeserver held in a shared hosting environment
may reach a resource limit if it starts using too much memory or disk space. The
error MUST have an <tt class="docutils literal">admin_contact</tt> field to provide the user receiving the error
a place to reach out to. Typically, this error will appear on routes which attempt
to modify state (eg: sending messages, account data, etc) and not routes which only
read state (eg: <tt class="docutils literal">/sync</tt>, get account data, etc).</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_CANNOT_LEAVE_SERVER_NOTICE_ROOM</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The user is unable to reject an invite to join the server notices room. See the
<a class="reference external" href="#server-notices">Server Notices</a> module for more information.</td>
</tr>
</tbody>
</table>
<!-- TODO: More error codes (covered by other issues) -->
<!-- * M_CONSENT_NOT_GIVEN                - GDPR: https://github.com/matrix-org/matrix-doc/issues/1512 -->
<p id="sect-txn-ids">The client-server API typically uses <tt class="docutils literal">HTTP PUT</tt> to submit requests with a
client-generated transaction identifier. This means that these requests are
idempotent. The scope of a transaction identifier is a particular access token.
It <strong>only</strong> serves to identify new
requests from retransmits. After the request has finished, the <tt class="docutils literal">{txnId}</tt>
value should be changed (how is not specified; a monotonically increasing
integer is recommended).</p>
<p>Some API endpoints may allow or require the use of <tt class="docutils literal">POST</tt> requests without a
transaction ID. Where this is optional, the use of a <tt class="docutils literal">PUT</tt> request is strongly
recommended.</p>
<p><a class="anchor" id="get-matrix-client-versions"></a></p>
<div class="section" id="get-matrix-client-versions">
<h2><a class="toc-backref" href="#id216">2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/versions</tt></a></h2>
<p>Gets the versions of the specification supported by the server.</p>
<p>Values will take the form <tt class="docutils literal">rX.Y.Z</tt>.</p>
<p>Only the latest <tt class="docutils literal">Z</tt> value will be reported for each supported <tt class="docutils literal">X.Y</tt> value.
i.e. if the server implements <tt class="docutils literal">r0.0.0</tt>, <tt class="docutils literal">r0.0.1</tt>, and <tt class="docutils literal">r1.2.0</tt>, it will report <tt class="docutils literal">r0.0.1</tt> and <tt class="docutils literal">r1.2.0</tt>.</p>
<p>The server may additionally advertise experimental features it supports
through <tt class="docutils literal">unstable_features</tt>. These features should be namespaced and
may optionally include version information within their name if desired.
Features listed here are not for optionally toggling parts of the Matrix
specification and should only be used to advertise support for a feature
which has not yet landed in the spec. For example, a feature currently
undergoing the proposal process may appear here and eventually be taken
off this list once the feature lands in the spec and the server deems it
reasonable to do so. Servers may wish to keep advertising features here
after they've been released into the spec to give clients a chance to
upgrade appropriately. Additionally, clients should avoid using unstable
features in their stable releases.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>versions</td>
<td>[string]</td>
<td><strong>Required.</strong> The supported versions.</td>
</tr>
<tr><td>unstable_features</td>
<td>{string: boolean}</td>
<td>Experimental features the server supports.
Features not listed here, or the lack of this
property all together, indicate that a feature is
not supported.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/versions</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The versions supported by the server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;versions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;r0.0.1&quot;</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;unstable_features&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;org.example.my_feature&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="web-browser-clients"></a></p>
<div class="section" id="web-browser-clients">
<span id="cors"></span><h1><a class="toc-backref" href="#id217">3&nbsp;&nbsp;&nbsp;Web Browser Clients</a></h1>
<p>It is realistic to expect that some clients will be written to be run within a
web browser or similar environment. In these cases, the homeserver should respond
to pre-flight requests and supply Cross-Origin Resource Sharing (CORS) headers on
all requests.</p>
<p>Servers MUST expect that clients will approach them with <tt class="docutils literal">OPTIONS</tt> requests,
allowing clients to discover the CORS headers. All endpoints in this specification s
upport the <tt class="docutils literal">OPTIONS</tt> method, however the server MUST NOT perform any logic defined
for the endpoints when approached with an <tt class="docutils literal">OPTIONS</tt> request.</p>
<p>When a client approaches the server with a request, the server should respond with
the CORS headers for that route. The recommended CORS headers to be returned by
servers on all requests are:</p>
<pre class="code literal-block">
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept, Authorization
</pre>
</div>
<p><a class="anchor" id="server-discovery"></a></p>
<div class="section" id="server-discovery">
<h1><a class="toc-backref" href="#id218">4&nbsp;&nbsp;&nbsp;Server Discovery</a></h1>
<p>In order to allow users to connect to a Matrix server without needing to
explicitly specify the homeserver's URL or other parameters, clients SHOULD use
an auto-discovery mechanism to determine the server's URL based on a user's
Matrix ID. Auto-discovery should only be done at login time.</p>
<p>In this section, the following terms are used with specific meanings:</p>
<dl class="docutils">
<dt><tt class="docutils literal">PROMPT</tt></dt>
<dd>Retrieve the specific piece of information from the user in a way which
fits within the existing client user experience, if the client is inclined to
do so. Failure can take place instead if no good user experience for this is
possible at this point.</dd>
<dt><tt class="docutils literal">IGNORE</tt></dt>
<dd>Stop the current auto-discovery mechanism. If no more auto-discovery
mechanisms are available, then the client may use other methods of
determining the required parameters, such as prompting the user, or using
default values.</dd>
<dt><tt class="docutils literal">FAIL_PROMPT</tt></dt>
<dd>Inform the user that auto-discovery failed due to invalid/empty data and
<tt class="docutils literal">PROMPT</tt> for the parameter.</dd>
<dt><tt class="docutils literal">FAIL_ERROR</tt></dt>
<dd>Inform the user that auto-discovery did not return any usable URLs. Do not
continue further with the current login process. At this point, valid data
was obtained, but no server is available to serve the client. No further
guess should be attempted and the user should make a conscientious decision
what to do next.</dd>
</dl>
<p><a class="anchor" id="well-known-uri"></a></p>
<div class="section" id="well-known-uri">
<h2><a class="toc-backref" href="#id219">4.1&nbsp;&nbsp;&nbsp;Well-known URI</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Servers hosting the <tt class="docutils literal"><span class="pre">.well-known</span></tt> JSON file SHOULD offer CORS headers, as
per the <a class="reference internal" href="#cors">CORS</a> section in this specification.</p>
</div>
<p>The <tt class="docutils literal"><span class="pre">.well-known</span></tt> method uses a JSON file at a predetermined location to
specify parameter values. The flow for this method is as follows:</p>
<ol class="arabic simple">
<li>Extract the server name from the user's Matrix ID by splitting the Matrix ID
at the first colon.</li>
<li>Extract the hostname from the server name.</li>
<li>Make a GET request to <tt class="docutils literal"><span class="pre">https://hostname/.well-known/matrix/client</span></tt>.<ol class="loweralpha">
<li>If the returned status code is 404, then <tt class="docutils literal">IGNORE</tt>.</li>
<li>If the returned status code is not 200, or the response body is empty,
then <tt class="docutils literal">FAIL_PROMPT</tt>.</li>
<li>Parse the response body as a JSON object<ol class="lowerroman">
<li>If the content cannot be parsed, then <tt class="docutils literal">FAIL_PROMPT</tt>.</li>
</ol>
</li>
<li>Extract the <tt class="docutils literal">base_url</tt> value from the <tt class="docutils literal">m.homeserver</tt> property. This
value is to be used as the base URL of the homeserver.<ol class="lowerroman">
<li>If this value is not provided, then <tt class="docutils literal">FAIL_PROMPT</tt>.</li>
</ol>
</li>
<li>Validate the homeserver base URL:<ol class="lowerroman">
<li>Parse it as a URL. If it is not a URL, then <tt class="docutils literal">FAIL_ERROR</tt>.</li>
<li>Clients SHOULD validate that the URL points to a valid homeserver
before accepting it by connecting to the <a class="reference external" href="#get-matrix-client-versions"><tt class="docutils literal">/_matrix/client/versions</tt></a>
endpoint, ensuring that it does not return an error, and parsing and
validating that the data conforms with the expected response
format. If any step in the validation fails, then
<tt class="docutils literal">FAIL_ERROR</tt>. Validation is done as a simple check against
configuration errors, in order to ensure that the discovered address
points to a valid homeserver.</li>
</ol>
</li>
<li>If the <tt class="docutils literal">m.identity_server</tt> property is present, extract the
<tt class="docutils literal">base_url</tt> value for use as the base URL of the identity server.
Validation for this URL is done as in the step above, but using
<tt class="docutils literal">/_matrix/identity/api/v1</tt> as the endpoint to connect to. If the
<tt class="docutils literal">m.identity_server</tt> property is present, but does not have a
<tt class="docutils literal">base_url</tt> value, then <tt class="docutils literal">FAIL_ERROR</tt>.</li>
</ol>
</li>
</ol>
<p><a class="anchor" id="get-well-known-matrix-client"></a></p>
<div class="section" id="get-well-known-matrix-client">
<h3><a class="toc-backref" href="#id220">4.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/.well-known/matrix/client</span></tt></a></h3>
<p>Gets discovery information about the domain. The file may include
additional keys, which MUST follow the Java package naming convention,
e.g. <tt class="docutils literal">com.example.myapp.property</tt>. This ensures property names are
suitably namespaced for each application and reduces the risk of
clashes.</p>
<p>Note that this endpoint is not necessarily handled by the homeserver,
but by another webserver, to be used for discovering the homeserver URL.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Discovery Information</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>m.homeserver</td>
<td>Homeserver Information</td>
<td><strong>Required.</strong> Used by clients to discover
homeserver information.</td>
</tr>
<tr><td>m.identity_server</td>
<td>Identity Server Information</td>
<td>Used by clients to discover identity server
information.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Homeserver Information</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>base_url</td>
<td>string</td>
<td><strong>Required.</strong> The base URL for the homeserver for
client-server connections.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Identity Server Information</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>base_url</td>
<td>string</td>
<td><strong>Required.</strong> The base URL for the identity server
for client-server connections.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/.well-known/matrix/client</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Server discovery information.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;m.homeserver&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;base_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://matrix.example.com&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;m.identity_server&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;base_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://identity.example.com&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;org.example.custom.property&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;app_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://custom.app.example.org&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>No server discovery information available.</p>
</div>
</div>
</div>
<p><a class="anchor" id="client-authentication"></a></p>
<div class="section" id="client-authentication">
<h1><a class="toc-backref" href="#id221">5&nbsp;&nbsp;&nbsp;Client Authentication</a></h1>
<p>Most API endpoints require the user to identify themselves by presenting
previously obtained credentials in the form of an <tt class="docutils literal">access_token</tt> query
parameter or through an Authorization Header of <tt class="docutils literal">Bearer $access_token</tt>.
An access token is typically obtained via the <a class="reference internal" href="#login">Login</a> or <a class="reference internal" href="#registration">Registration</a> processes.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This specification does not mandate a particular format for the access
token. Clients should treat it as an opaque byte sequence. Servers are free
to choose an appropriate format. Server implementors may like to investigate
<a class="reference external" href="http://research.google.com/pubs/pub41892.html">macaroons</a>.</p>
</div>
<p><a class="anchor" id="using-access-tokens"></a></p>
<div class="section" id="using-access-tokens">
<h2><a class="toc-backref" href="#id222">5.1&nbsp;&nbsp;&nbsp;Using access tokens</a></h2>
<p>Access tokens may be provided in two ways, both of which the homeserver MUST
support:</p>
<ol class="arabic simple">
<li>Via a query string parameter, <tt class="docutils literal">access_token=TheTokenHere</tt>.</li>
<li>Via a request header, <tt class="docutils literal">Authorization: Bearer TheTokenHere</tt>.</li>
</ol>
<p>Clients are encouraged to use the <tt class="docutils literal">Authorization</tt> header where possible
to prevent the access token being leaked in access/HTTP logs. The query
string should only be used in cases where the <tt class="docutils literal">Authorization</tt> header is
inaccessible for the client.</p>
<p>When credentials are required but missing or invalid, the HTTP call will
return with a status of 401 and the error code, <tt class="docutils literal">M_MISSING_TOKEN</tt> or
<tt class="docutils literal">M_UNKNOWN_TOKEN</tt> respectively.</p>
</div>
<p><a class="anchor" id="relationship-between-access-tokens-and-devices"></a></p>
<div class="section" id="relationship-between-access-tokens-and-devices">
<h2><a class="toc-backref" href="#id223">5.2&nbsp;&nbsp;&nbsp;Relationship between access tokens and devices</a></h2>
<p>Client <a class="reference external" href="../index.html#devices">devices</a> are closely related to access tokens.  Matrix servers should
record which device each access token is assigned to, so that subsequent
requests can be handled correctly.</p>
<p>By default, the <a class="reference internal" href="#login">Login</a> and <a class="reference internal" href="#registration">Registration</a> processes auto-generate a new
<tt class="docutils literal">device_id</tt>. A client is also free to generate its own <tt class="docutils literal">device_id</tt> or,
provided the user remains the same, reuse a device: in either case the client
should pass the <tt class="docutils literal">device_id</tt> in the request body. If the client sets the
<tt class="docutils literal">device_id</tt>, the server will invalidate any access token previously assigned
to that device. There is therefore at most one active access token assigned to
each device at any one time.</p>
</div>
<p><a class="anchor" id="user-interactive-authentication-api"></a></p>
<div class="section" id="user-interactive-authentication-api">
<h2><a class="toc-backref" href="#id224">5.3&nbsp;&nbsp;&nbsp;User-Interactive Authentication API</a></h2>
<p><a class="anchor" id="overview"></a></p>
<div class="section" id="overview">
<h3><a class="toc-backref" href="#id225">5.3.1&nbsp;&nbsp;&nbsp;Overview</a></h3>
<p>Some API endpoints require authentication that
interacts with the user. The homeserver may provide many different ways of
authenticating, such as user/password auth, login via a social network (OAuth2),
login by confirming a token sent to their email address, etc. This specification
does not define how homeservers should authorise their users but instead
defines the standard interface which implementations should follow so that ANY
client can login to ANY homeserver.</p>
<p>The process takes the form of one or more 'stages'. At each stage the client
submits a set of data for a given authentication type and awaits a response
from the server, which will either be a final success or a request to perform
an additional stage. This exchange continues until the final success.</p>
<p>For each endpoint, a server offers one or more 'flows' that the client can use
to authenticate itself. Each flow comprises a series of stages, as described
above. The client is free to choose which flow it follows, however the flow's
stages must be completed in order. Failing to follow the flows in order must
result in an HTTP 401 response, as defined below. When all stages in a flow
are complete, authentication is complete and the API call succeeds.</p>
</div>
<p><a class="anchor" id="user-interactive-api-in-the-rest-api"></a></p>
<div class="section" id="user-interactive-api-in-the-rest-api">
<h3><a class="toc-backref" href="#id226">5.3.2&nbsp;&nbsp;&nbsp;User-interactive API in the REST API</a></h3>
<p>In the REST API described in this specification, authentication works by the
client and server exchanging JSON dictionaries. The server indicates what
authentication data it requires via the body of an HTTP 401 response, and the
client submits that authentication data via the <tt class="docutils literal">auth</tt> request parameter.</p>
<p>A client should first make a request with no <tt class="docutils literal">auth</tt> parameter <a class="footnote-reference" href="#id66" id="id65">[1]</a>. The
homeserver returns an HTTP 401 response, with a JSON body, as follows:</p>
<pre class="code literal-block">
HTTP/1.1 401 Unauthorized
Content-Type: application/json

{
  &quot;flows&quot;: [
    {
      &quot;stages&quot;: [ &quot;example.type.foo&quot;, &quot;example.type.bar&quot; ]
    },
    {
      &quot;stages&quot;: [ &quot;example.type.foo&quot;, &quot;example.type.baz&quot; ]
    }
  ],
  &quot;params&quot;: {
      &quot;example.type.baz&quot;: {
          &quot;example_key&quot;: &quot;foobar&quot;
      }
  },
  &quot;session&quot;: &quot;xxxxxx&quot;
}
</pre>
<p>In addition to the <tt class="docutils literal">flows</tt>, this object contains some extra
information:</p>
<dl class="docutils">
<dt>params</dt>
<dd>This section contains any information that the client will need to know in
order to use a given type of authentication. For each authentication type
presented, that type may be present as a key in this dictionary. For example,
the public part of an OAuth client ID could be given here.</dd>
<dt>session</dt>
<dd>This is a session identifier that the client must pass back to the homeserver,
if one is provided, in subsequent attempts to authenticate in the same API call.</dd>
</dl>
<p>The client then chooses a flow and attempts to complete the first stage. It
does this by resubmitting the same request with the addition of an <tt class="docutils literal">auth</tt>
key in the object that it submits. This dictionary contains a <tt class="docutils literal">type</tt> key whose
value is the name of the authentication type that the client is attempting to complete.
It must also contain a <tt class="docutils literal">session</tt> key with the value of the session key given
by the homeserver, if one was given. It also contains other keys dependent on
the auth type being attempted. For example, if the client is attempting to
complete auth type <tt class="docutils literal">example.type.foo</tt>, it might submit something like this:</p>
<pre class="code literal-block">
POST /_matrix/client/r0/endpoint HTTP/1.1
Content-Type: application/json

{
  &quot;a_request_parameter&quot;: &quot;something&quot;,
  &quot;another_request_parameter&quot;: &quot;something else&quot;,
  &quot;auth&quot;: {
      &quot;type&quot;: &quot;example.type.foo&quot;,
      &quot;session&quot;: &quot;xxxxxx&quot;,
      &quot;example_credential&quot;: &quot;verypoorsharedsecret&quot;
  }
}
</pre>
<p>If the homeserver deems the authentication attempt to be successful but still
requires more stages to be completed, it returns HTTP status 401 along with the
same object as when no authentication was attempted, with the addition of the
<tt class="docutils literal">completed</tt> key which is an array of auth types the client has completed
successfully:</p>
<pre class="code literal-block">
HTTP/1.1 401 Unauthorized
Content-Type: application/json

{
  &quot;completed&quot;: [ &quot;example.type.foo&quot; ],
  &quot;flows&quot;: [
    {
      &quot;stages&quot;: [ &quot;example.type.foo&quot;, &quot;example.type.bar&quot; ]
    },
    {
      &quot;stages&quot;: [ &quot;example.type.foo&quot;, &quot;example.type.baz&quot; ]
    }
  ],
  &quot;params&quot;: {
      &quot;example.type.baz&quot;: {
          &quot;example_key&quot;: &quot;foobar&quot;
      }
  },
  &quot;session&quot;: &quot;xxxxxx&quot;
}
</pre>
<p>Individual stages may require more than one request to complete, in which case
the response will be as if the request was unauthenticated with the addition of
any other keys as defined by the auth type.</p>
<p>If the homeserver decides that an attempt on a stage was unsuccessful, but the
client may make a second attempt, it returns the same HTTP status 401 response
as above, with the addition of the standard <tt class="docutils literal">errcode</tt> and <tt class="docutils literal">error</tt> fields
describing the error. For example:</p>
<pre class="code literal-block">
HTTP/1.1 401 Unauthorized
Content-Type: application/json

{
  &quot;errcode&quot;: &quot;M_FORBIDDEN&quot;,
  &quot;error&quot;: &quot;Invalid password&quot;,
  &quot;completed&quot;: [ &quot;example.type.foo&quot; ],
  &quot;flows&quot;: [
    {
      &quot;stages&quot;: [ &quot;example.type.foo&quot;, &quot;example.type.bar&quot; ]
    },
    {
      &quot;stages&quot;: [ &quot;example.type.foo&quot;, &quot;example.type.baz&quot; ]
    }
  ],
  &quot;params&quot;: {
      &quot;example.type.baz&quot;: {
          &quot;example_key&quot;: &quot;foobar&quot;
      }
  },
  &quot;session&quot;: &quot;xxxxxx&quot;
}
</pre>
<p>If the request fails for a reason other than authentication, the server returns an error
message in the standard format. For example:</p>
<pre class="code literal-block">
HTTP/1.1 400 Bad request
Content-Type: application/json

{
  &quot;errcode&quot;: &quot;M_EXAMPLE_ERROR&quot;,
  &quot;error&quot;: &quot;Something was wrong&quot;
}
</pre>
<p>If the client has completed all stages of a flow, the homeserver performs the
API call and returns the result as normal. Completed stages cannot be retried
by clients, therefore servers must return either a 401 response with the completed
stages, or the result of the API call if all stages were completed when a client
retries a stage.</p>
<p>Some authentication types may be completed by means other than through the
Matrix client, for example, an email confirmation may be completed when the user
clicks on the link in the email. In this case, the client retries the request
with an auth dict containing only the session key. The response to this will be
the same as if the client were attempting to complete an auth state normally,
i.e. the request will either complete or request auth, with the presence or
absence of that auth type in the 'completed' array indicating whether
that stage is complete.</p>
<table class="docutils footnote" frame="void" id="id66" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id65">[1]</a></td><td>A request to an endpoint that uses User-Interactive Authentication never
succeeds without auth. Homeservers may allow requests that don't require
auth by offering a stage with only the <tt class="docutils literal">m.login.dummy</tt> auth type, but
they must still give a 401 response to requests with no auth data.</td></tr>
</tbody>
</table>
</div>
<p><a class="anchor" id="example"></a></p>
<div class="section" id="example">
<h3><a class="toc-backref" href="#id227">5.3.3&nbsp;&nbsp;&nbsp;Example</a></h3>
<p>At a high level, the requests made for an API call completing an auth flow with
three stages will resemble the following diagram:</p>
<pre class="literal-block">
 _______________________
|       Stage 0         |
| No auth               |
|  ___________________  |
| |_Request_1_________| | &lt;-- Returns &quot;session&quot; key which is used throughout.
|_______________________|
          |
          |
 _________V_____________
|       Stage 1         |
| type: &quot;&lt;auth type1&gt;&quot;  |
|  ___________________  |
| |_Request_1_________| |
|_______________________|
          |
          |
 _________V_____________
|       Stage 2         |
| type: &quot;&lt;auth type2&gt;&quot;  |
|  ___________________  |
| |_Request_1_________| |
|  ___________________  |
| |_Request_2_________| |
|  ___________________  |
| |_Request_3_________| |
|_______________________|
          |
          |
 _________V_____________
|       Stage 3         |
| type: &quot;&lt;auth type3&gt;&quot;  |
|  ___________________  |
| |_Request_1_________| | &lt;-- Returns API response
|_______________________|
</pre>
</div>
<p><a class="anchor" id="authentication-types"></a></p>
<div class="section" id="authentication-types">
<h3><a class="toc-backref" href="#id228">5.3.4&nbsp;&nbsp;&nbsp;Authentication types</a></h3>
<dl class="docutils">
<dt>This specification defines the following auth types:</dt>
<dd><ul class="first last simple">
<li><tt class="docutils literal">m.login.password</tt></li>
<li><tt class="docutils literal">m.login.recaptcha</tt></li>
<li><tt class="docutils literal">m.login.oauth2</tt></li>
<li><tt class="docutils literal">m.login.email.identity</tt></li>
<li><tt class="docutils literal">m.login.msisdn</tt></li>
<li><tt class="docutils literal">m.login.token</tt></li>
<li><tt class="docutils literal">m.login.dummy</tt></li>
</ul>
</dd>
</dl>
<p><a class="anchor" id="password-based"></a></p>
<div class="section" id="password-based">
<h4><a class="toc-backref" href="#id229">5.3.4.1&nbsp;&nbsp;&nbsp;Password-based</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.password</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">The client submits an identifier and secret password, both sent in plain-text.</td>
</tr>
</tbody>
</table>
<p>To use this authentication type, clients should submit an auth dict as follows:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.password&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;identifier&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="error">...</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;password&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;session ID&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>where the <tt class="docutils literal">identifier</tt> property is a user identifier object, as described in
<a class="reference internal" href="#identifier-types">Identifier types</a>.</p>
<p>For example, to authenticate using the user's Matrix ID, clients would submit:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.password&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;identifier&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.id.user&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;user_id or user localpart&gt;&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;password&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;session ID&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Alternatively reply using a 3PID bound to the user's account on the homeserver
using the <a class="reference external" href="#post-matrix-client-r0-account-3pid"><tt class="docutils literal">/account/3pid</tt></a> API rather then giving the <tt class="docutils literal">user</tt> explicitly as
follows:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.password&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;identifier&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.id.thirdparty&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;The medium of the third party identifier.&gt;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;The third party address of the user&gt;&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;password&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;session ID&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>In the case that the homeserver does not know about the supplied 3PID, the
homeserver must respond with 403 Forbidden.</p>
</div>
<p><a class="anchor" id="google-recaptcha"></a></p>
<div class="section" id="google-recaptcha">
<h4><a class="toc-backref" href="#id230">5.3.4.2&nbsp;&nbsp;&nbsp;Google ReCaptcha</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.recaptcha</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">The user completes a Google ReCaptcha 2.0 challenge</td>
</tr>
</tbody>
</table>
<p>To use this authentication type, clients should submit an auth dict as follows:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.recaptcha&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;response&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;captcha response&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;session ID&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="token-based"></a></p>
<div class="section" id="token-based">
<h4><a class="toc-backref" href="#id231">5.3.4.3&nbsp;&nbsp;&nbsp;Token-based</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.token</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">The client submits a login token.</td>
</tr>
</tbody>
</table>
<p>To use this authentication type, clients should submit an auth dict as follows:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.token&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;token&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;txn_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;client generated nonce&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;session ID&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>The <tt class="docutils literal">nonce</tt> should be a random string generated by the client for the
request. The same <tt class="docutils literal">nonce</tt> should be used if retrying the request.</p>
<p>A client may receive a login <tt class="docutils literal">token</tt> via some external service, such as email
or SMS. Note that a login token is separate from an access token, the latter
providing general authentication to various API endpoints.</p>
<p>The <tt class="docutils literal">txn_id</tt> may be used by the server to disallow other devices from using
the token, thus providing &quot;single use&quot; tokens while still allowing the device
to retry the request. This would be done by tying the token to the <tt class="docutils literal">txn_id</tt>
server side, as well as potentially invalidating the token completely once the
device has successfully logged in (e.g. when we receive a request from the
newly provisioned access_token).</p>
<p>The server must encode the user id in the <tt class="docutils literal">token</tt>. There is therefore no need
for the client to submit a separate username.</p>
</div>
<p><a class="anchor" id="oauth2-based"></a></p>
<div class="section" id="oauth2-based">
<h4><a class="toc-backref" href="#id232">5.3.4.4&nbsp;&nbsp;&nbsp;OAuth2-based</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.oauth2</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">Authentication is supported via OAuth2 URLs. This login consists of multiple
requests.</td>
</tr>
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><tt class="docutils literal">uri</tt>: Authorization Request URI OR service selection URI. Both contain an
encoded <tt class="docutils literal">redirect URI</tt>.</td>
</tr>
</tbody>
</table>
<p>The homeserver acts as a 'confidential' client for the purposes of OAuth2.  If
the uri is a <tt class="docutils literal">service selection URI</tt>, it MUST point to a webpage which prompts
the user to choose which service to authorize with. On selection of a service,
this MUST link through to an <tt class="docutils literal">Authorization Request URI</tt>. If there is only one
service which the homeserver accepts when logging in, this indirection can be
skipped and the &quot;uri&quot; key can be the <tt class="docutils literal">Authorization Request URI</tt>.</p>
<p>The client then visits the <tt class="docutils literal">Authorization Request URI</tt>, which then shows the
OAuth2 Allow/Deny prompt. Hitting 'Allow' redirects to the <tt class="docutils literal">redirect URI</tt> with
the auth code. Homeservers can choose any path for the <tt class="docutils literal">redirect URI</tt>. Once
the OAuth flow has completed, the client retries the request with the session
only, as above.</p>
</div>
<p><a class="anchor" id="email-based-identity-homeserver"></a></p>
<div class="section" id="email-based-identity-homeserver">
<h4><a class="toc-backref" href="#id233">5.3.4.5&nbsp;&nbsp;&nbsp;Email-based (identity / homeserver)</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.email.identity</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">Authentication is supported by authorising an email address with an identity
server, or homeserver if supported.</td>
</tr>
</tbody>
</table>
<p>Prior to submitting this, the client should authenticate with an identity
server (or homeserver). After authenticating, the session information should
be submitted to the homeserver.</p>
<p>To use this authentication type, clients should submit an auth dict as follows:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.email.identity&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;threepidCreds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;identity server session id&gt;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;identity server client secret&gt;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;id_server&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;url of identity server authed with, e.g. 'matrix.org:8090'&gt;&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;session ID&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="phone-number-msisdn-based-identity-homeserver"></a></p>
<div class="section" id="phone-number-msisdn-based-identity-homeserver">
<h4><a class="toc-backref" href="#id234">5.3.4.6&nbsp;&nbsp;&nbsp;Phone number/MSISDN-based (identity / homeserver)</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.msisdn</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">Authentication is supported by authorising a phone number with an identity
server, or homeserver if supported.</td>
</tr>
</tbody>
</table>
<p>Prior to submitting this, the client should authenticate with an identity
server (or homeserver). After authenticating, the session information should
be submitted to the homeserver.</p>
<p>To use this authentication type, clients should submit an auth dict as follows:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.msisdn&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;threepidCreds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;identity server session id&gt;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;identity server client secret&gt;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;id_server&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;url of identity server authed with, e.g. 'matrix.org:8090'&gt;&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;session ID&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="dummy-auth"></a></p>
<div class="section" id="dummy-auth">
<h4><a class="toc-backref" href="#id235">5.3.4.7&nbsp;&nbsp;&nbsp;Dummy Auth</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.dummy</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">Dummy authentication always succeeds and requires no extra parameters. Its
purpose is to allow servers to not require any form of User-Interactive
Authentication to perform a request. It can also be used to differentiate
flows where otherwise one flow would be a subset of another flow. eg. if
a server offers flows <tt class="docutils literal">m.login.recaptcha</tt> and <tt class="docutils literal">m.login.recaptcha,
m.login.email.identity</tt> and the client completes the recaptcha stage first,
the auth would succeed with the former flow, even if the client was intending
to then complete the email auth stage. A server can instead send flows
<tt class="docutils literal">m.login.recaptcha, m.login.dummy</tt> and <tt class="docutils literal">m.login.recaptcha,
m.login.email.identity</tt> to fix the ambiguity.</td>
</tr>
</tbody>
</table>
<p>To use this authentication type, clients should submit an auth dict with just
the type and session, if provided:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.dummy&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;session ID&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="fallback"></a></p>
<div class="section" id="fallback">
<h3><a class="toc-backref" href="#id236">5.3.5&nbsp;&nbsp;&nbsp;Fallback</a></h3>
<p>Clients cannot be expected to be able to know how to process every single login
type. If a client does not know how to handle a given login type, it can direct
the user to a web browser with the URL of a fallback page which will allow the
user to complete that login step out-of-band in their web browser. The URL it
should open is:</p>
<pre class="literal-block">
/_matrix/client/r0/auth/&lt;auth type&gt;/fallback/web?session=&lt;session ID&gt;
</pre>
<p>Where <tt class="docutils literal">auth type</tt> is the type name of the stage it is attempting and
<tt class="docutils literal">session ID</tt> is the ID of the session given by the homeserver.</p>
<p>This MUST return an HTML page which can perform this authentication stage. This
page must use the following JavaScript when the authentication has been
completed:</p>
<pre class="code javascript literal-block">
<span class="keyword">if</span> <span class="punctuation">(</span><span class="name builtin">window</span><span class="punctuation">.</span><span class="name other">onAuthDone</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="name builtin">window</span><span class="punctuation">.</span><span class="name other">onAuthDone</span><span class="punctuation">();</span>
<span class="punctuation">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name builtin">window</span><span class="punctuation">.</span><span class="name other">opener</span> <span class="operator">&amp;&amp;</span> <span class="name builtin">window</span><span class="punctuation">.</span><span class="name other">opener</span><span class="punctuation">.</span><span class="name other">postMessage</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="name builtin">window</span><span class="punctuation">.</span><span class="name other">opener</span><span class="punctuation">.</span><span class="name other">postMessage</span><span class="punctuation">(</span><span class="literal string double">&quot;authDone&quot;</span><span class="punctuation">,</span> <span class="literal string double">&quot;*&quot;</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<p>This allows the client to either arrange for the global function <tt class="docutils literal">onAuthDone</tt>
to be defined in an embedded browser, or to use the HTML5 <a class="reference external" href="https://www.w3.org/TR/webmessaging/#web-messaging">cross-document
messaging</a> API, to receive
a notification that the authentication stage has been completed.</p>
<p>Once a client receives the notificaton that the authentication stage has been
completed, it should resubmit the request with an auth dict with just the
session ID:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;session ID&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><a class="anchor" id="id67"></a></p>
<div class="section" id="id67">
<h4><a class="toc-backref" href="#id237">5.3.5.1&nbsp;&nbsp;&nbsp;Example</a></h4>
<p>A client webapp might use the following javascript to open a popup window which will
handle unknown login types:</p>
<pre class="code javascript literal-block">
<span class="comment multiline">/**
 * Arguments:
 *     homeserverUrl: the base url of the homeserver (eg &quot;https://matrix.org&quot;)
 *
 *     apiEndpoint: the API endpoint being used (eg
 *        &quot;/_matrix/client/r0/account/password&quot;)
 *
 *     loginType: the loginType being attempted (eg &quot;m.login.recaptcha&quot;)
 *
 *     sessionID: the session ID given by the homeserver in earlier requests
 *
 *     onComplete: a callback which will be called with the results of the request
 */</span>
<span class="keyword declaration">function</span> <span class="name other">unknownLoginType</span><span class="punctuation">(</span><span class="name other">homeserverUrl</span><span class="punctuation">,</span> <span class="name other">apiEndpoint</span><span class="punctuation">,</span> <span class="name other">loginType</span><span class="punctuation">,</span> <span class="name other">sessionID</span><span class="punctuation">,</span> <span class="name other">onComplete</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword declaration">var</span> <span class="name other">popupWindow</span><span class="punctuation">;</span>

    <span class="keyword declaration">var</span> <span class="name other">eventListener</span> <span class="operator">=</span> <span class="keyword declaration">function</span><span class="punctuation">(</span><span class="name other">ev</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="comment single">// check it's the right message from the right place.
</span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="name other">ev</span><span class="punctuation">.</span><span class="name other">data</span> <span class="operator">!==</span> <span class="literal string double">&quot;authDone&quot;</span> <span class="operator">||</span> <span class="name other">ev</span><span class="punctuation">.</span><span class="name other">origin</span> <span class="operator">!==</span> <span class="name other">homeserverUrl</span><span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="keyword">return</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>

        <span class="comment single">// close the popup
</span>        <span class="name other">popupWindow</span><span class="punctuation">.</span><span class="name other">close</span><span class="punctuation">();</span>
        <span class="name builtin">window</span><span class="punctuation">.</span><span class="name other">removeEventListener</span><span class="punctuation">(</span><span class="literal string double">&quot;message&quot;</span><span class="punctuation">,</span> <span class="name other">eventListener</span><span class="punctuation">);</span>

        <span class="comment single">// repeat the request
</span>        <span class="keyword declaration">var</span> <span class="name other">requestBody</span> <span class="operator">=</span> <span class="punctuation">{</span>
            <span class="name other">auth</span><span class="operator">:</span> <span class="punctuation">{</span>
                <span class="name other">session</span><span class="operator">:</span> <span class="name other">sessionID</span><span class="punctuation">,</span>
            <span class="punctuation">},</span>
        <span class="punctuation">};</span>

        <span class="name other">request</span><span class="punctuation">({</span>
            <span class="name other">method</span><span class="operator">:</span><span class="literal string single">'POST'</span><span class="punctuation">,</span> <span class="name other">url</span><span class="operator">:</span><span class="name other">apiEndpint</span><span class="punctuation">,</span> <span class="name other">json</span><span class="operator">:</span><span class="name other">requestBody</span><span class="punctuation">,</span>
        <span class="punctuation">},</span> <span class="name other">onComplete</span><span class="punctuation">);</span>
    <span class="punctuation">};</span>

    <span class="name builtin">window</span><span class="punctuation">.</span><span class="name other">addEventListener</span><span class="punctuation">(</span><span class="literal string double">&quot;message&quot;</span><span class="punctuation">,</span> <span class="name other">eventListener</span><span class="punctuation">);</span>

    <span class="keyword declaration">var</span> <span class="name other">url</span> <span class="operator">=</span> <span class="name other">homeserverUrl</span> <span class="operator">+</span>
        <span class="literal string double">&quot;/_matrix/client/r0/auth/&quot;</span> <span class="operator">+</span>
        <span class="name builtin">encodeURIComponent</span><span class="punctuation">(</span><span class="name other">loginType</span><span class="punctuation">)</span> <span class="operator">+</span>
        <span class="literal string double">&quot;/fallback/web?session=&quot;</span> <span class="operator">+</span>
        <span class="name builtin">encodeURIComponent</span><span class="punctuation">(</span><span class="name other">sessionID</span><span class="punctuation">);</span>


   <span class="name other">popupWindow</span> <span class="operator">=</span> <span class="name builtin">window</span><span class="punctuation">.</span><span class="name other">open</span><span class="punctuation">(</span><span class="name other">url</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="identifier-types"></a></p>
<div class="section" id="identifier-types">
<h3><a class="toc-backref" href="#id238">5.3.6&nbsp;&nbsp;&nbsp;Identifier types</a></h3>
<p>Some authentication mechanisms use a user identifier object to identify a
user.  The user identifier object has a <tt class="docutils literal">type</tt> field to indicate the type of
identifier being used, and depending on the type, has other fields giving the
information required to identify the user as described below.</p>
<dl class="docutils">
<dt>This specification defines the following identifier types:</dt>
<dd><ul class="first last simple">
<li><tt class="docutils literal">m.id.user</tt></li>
<li><tt class="docutils literal">m.id.thirdparty</tt></li>
<li><tt class="docutils literal">m.id.phone</tt></li>
</ul>
</dd>
</dl>
<p><a class="anchor" id="matrix-user-id"></a></p>
<div class="section" id="matrix-user-id">
<h4><a class="toc-backref" href="#id239">5.3.6.1&nbsp;&nbsp;&nbsp;Matrix User ID</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.id.user</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">The user is identified by their Matrix ID.</td>
</tr>
</tbody>
</table>
<p>A client can identify a user using their Matrix ID.  This can either be the
fully qualified Matrix user ID, or just the localpart of the user ID.</p>
<pre class="code json literal-block">
<span class="literal string double">&quot;identifier&quot;</span><span class="error">:</span> <span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.id.user&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;user&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;user_id or user localpart&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="third-party-id"></a></p>
<div class="section" id="third-party-id">
<h4><a class="toc-backref" href="#id240">5.3.6.2&nbsp;&nbsp;&nbsp;Third-party ID</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.id.thirdparty</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">The user is identified by a third-party identifier in canonicalised form.</td>
</tr>
</tbody>
</table>
<p>A client can identify a user using a 3PID associated with the user's account on
the homeserver, where the 3PID was previously associated using the
<a class="reference external" href="#post-matrix-client-r0-account-3pid"><tt class="docutils literal">/account/3pid</tt></a> API.  See the <a class="reference external" href="../appendices.html#pid-types">3PID Types</a> Appendix for a list of Third-party
ID media.</p>
<pre class="code json literal-block">
<span class="literal string double">&quot;identifier&quot;</span><span class="error">:</span> <span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.id.thirdparty&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;The medium of the third party identifier&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;The canonicalised third party address of the user&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="phone-number"></a></p>
<div class="section" id="phone-number">
<h4><a class="toc-backref" href="#id241">5.3.6.3&nbsp;&nbsp;&nbsp;Phone number</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.id.phone</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">The user is identified by a phone number.</td>
</tr>
</tbody>
</table>
<p>A client can identify a user using a phone number associated with the user's
account, where the phone number was previously associated using the
<a class="reference external" href="#post-matrix-client-r0-account-3pid"><tt class="docutils literal">/account/3pid</tt></a> API.  The phone number can be passed in as entered by the
user; the homeserver will be responsible for canonicalising it.  If the client
wishes to canonicalise the phone number, then it can use the
<tt class="docutils literal">m.id.thirdparty</tt> identifier type with a <tt class="docutils literal">medium</tt> of <tt class="docutils literal">msisdn</tt> instead.</p>
<pre class="code json literal-block">
<span class="literal string double">&quot;identifier&quot;</span><span class="error">:</span> <span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.id.phone&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;country&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;The country that the phone number is from&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;The phone number&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="login"></a></p>
<div class="section" id="login">
<h2><a class="toc-backref" href="#id242">5.4&nbsp;&nbsp;&nbsp;Login</a></h2>
<p>A client can obtain access tokens using the <tt class="docutils literal">/login</tt> API.</p>
<p>Note that this endpoint does <cite>not</cite> currently use the user-interactive
authentication API.</p>
<p>For a simple username/password login, clients should submit a <tt class="docutils literal">/login</tt>
request as follows:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.password&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;identifier&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.id.user&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;user_id or user localpart&gt;&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;password&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Alternatively, a client can use a 3PID bound to the user's account on the
homeserver using the <a class="reference external" href="#post-matrix-client-r0-account-3pid"><tt class="docutils literal">/account/3pid</tt></a> API rather then giving the <tt class="docutils literal">user</tt>
explicitly, as follows:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.password&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;identifier&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;The medium of the third party identifier&gt;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;The canonicalised third party address of the user&gt;&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;password&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>In the case that the homeserver does not know about the supplied 3PID, the
homeserver must respond with <tt class="docutils literal">403 Forbidden</tt>.</p>
<p>To log in using a login token, clients should submit a <tt class="docutils literal">/login</tt> request as
follows:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.token&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;login token&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>As with <a class="reference internal" href="#token-based">token-based</a> interactive login, the <tt class="docutils literal">token</tt> must encode the
user ID. In the case that the token is not valid, the homeserver must respond
with <tt class="docutils literal">403 Forbidden</tt> and an error code of <tt class="docutils literal">M_FORBIDDEN</tt>.</p>
<p>If the homeserver advertises <tt class="docutils literal">m.login.sso</tt> as a viable flow, and the client
supports it, the client should redirect the user to the <tt class="docutils literal">/redirect</tt> endpoint
for <a class="reference external" href="#sso-client-login">Single Sign-On</a>. After authentication is complete, the
client will need to submit a <tt class="docutils literal">/login</tt> request matching <tt class="docutils literal">m.login.token</tt>.</p>
<p><a class="anchor" id="get-matrix-client-r0-login"></a></p>
<div class="section" id="get-matrix-client-r0-login">
<h3><a class="toc-backref" href="#id243">5.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/login</tt></a></h3>
<p>Gets the homeserver's supported login types to authenticate users. Clients
should pick one of these and supply it as the <tt class="docutils literal">type</tt> when logging in.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>flows</td>
<td>[LoginFlow]</td>
<td>The homeserver's supported login types</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>LoginFlow</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>type</td>
<td>string</td>
<td>The login type. This is supplied as the <tt class="docutils literal">type</tt>
when logging in.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/login</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The login types the homeserver supports</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;flows&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.password&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-login"></a></p>
<div class="section" id="post-matrix-client-r0-login">
<h3><a class="toc-backref" href="#id244">5.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/login</tt></a></h3>
<p>Authenticates the user, and issues an access token they can
use to authorize themself in subsequent requests.</p>
<p>If the client does not supply a <tt class="docutils literal">device_id</tt>, the server must
auto-generate one.</p>
<p>The returned access token must be associated with the <tt class="docutils literal">device_id</tt>
supplied by the client or generated by the server. The server may
invalidate any access token previously associated with that device. See
<a class="reference internal" href="#relationship-between-access-tokens-and-devices">Relationship between access tokens and devices</a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>type</td>
<td>enum</td>
<td><strong>Required.</strong> The login type being used. One of:
[&quot;m.login.password&quot;, &quot;m.login.token&quot;]</td>
</tr>
<tr><td>identifier</td>
<td>User identifier</td>
<td>Identification information for the user.</td>
</tr>
<tr><td>user</td>
<td>string</td>
<td>The fully qualified user ID or just local part of
the user ID, to log in.  Deprecated in favour of
<tt class="docutils literal">identifier</tt>.</td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td>When logging in using a third party identifier,
the medium of the identifier. Must be 'email'.
Deprecated in favour of <tt class="docutils literal">identifier</tt>.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td>Third party identifier for the user.  Deprecated
in favour of <tt class="docutils literal">identifier</tt>.</td>
</tr>
<tr><td>password</td>
<td>string</td>
<td>Required when <tt class="docutils literal">type</tt> is <tt class="docutils literal">m.login.password</tt>.
The user's password.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td>Required when <tt class="docutils literal">type</tt> is <tt class="docutils literal">m.login.token</tt>. Part
of <a class="reference internal" href="#token-based">Token-based</a> login.</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td>ID of the client device. If this does not
correspond to a known client device, a new device
will be created. The server will auto-generate a
device_id if this is not specified.</td>
</tr>
<tr><td>initial_device_display_name</td>
<td>string</td>
<td>A display name to assign to the newly-created
device. Ignored if <tt class="docutils literal">device_id</tt> corresponds to a
known device.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>User identifier</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of identification.  See
<a class="reference internal" href="#identifier-types">Identifier types</a> for supported values and
additional property descriptions.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td>The fully-qualified Matrix ID that has been
registered.</td>
</tr>
<tr><td>access_token</td>
<td>string</td>
<td>An access token for the account. This access token
can then be used to authorize other requests.</td>
</tr>
<tr><td>home_server</td>
<td>string</td>
<td><p class="first">The server_name of the homeserver on which the
account has been registered.</p>
<p class="last"><strong>Deprecated</strong>. Clients should extract the
server_name from <tt class="docutils literal">user_id</tt> (by splitting at the
first colon) if they require it. Note also that
<tt class="docutils literal">homeserver</tt> is not spelt this way.</p>
</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td>ID of the logged-in device. Will be the same as
the corresponding parameter in the request, if one
was specified.</td>
</tr>
<tr><td>well_known</td>
<td>Discovery Information</td>
<td>Optional client configuration provided by the
server. If present, clients SHOULD use the
provided object to reconfigure themselves,
optionally validating the URLs within. This object
takes the same form as the one returned from
.well-known autodiscovery.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Discovery Information</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>m.homeserver</td>
<td>Homeserver Information</td>
<td><strong>Required.</strong> Used by clients to discover
homeserver information.</td>
</tr>
<tr><td>m.identity_server</td>
<td>Identity Server Information</td>
<td>Used by clients to discover identity server
information.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Homeserver Information</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>base_url</td>
<td>string</td>
<td><strong>Required.</strong> The base URL for the homeserver for
client-server connections.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Identity Server Information</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>base_url</td>
<td>string</td>
<td><strong>Required.</strong> The base URL for the identity server
for client-server connections.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/login</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.password&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;identifier&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.id.user&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;cheeky_monkey&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ilovebananas&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;initial_device_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Jungle Phone&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The user has been authenticated.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;GHTYAJCE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;well_known&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;m.homeserver&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;base_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;m.identity_server&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;base_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://id.example.org&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>Part of the request was invalid. For example, the login type may not be recognised.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bad login type.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The login attempt failed. For example, the password may have been incorrect.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-logout"></a></p>
<div class="section" id="post-matrix-client-r0-logout">
<h3><a class="toc-backref" href="#id245">5.4.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/logout</tt></a></h3>
<p>Invalidates an existing access token, so that it can no longer be used for
authorization. The device associated with the access token is also deleted.
<a class="reference external" href="#device-keys">Device keys</a> for the device are deleted alongside the device.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/logout</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The access token used in the request was succesfully invalidated.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-logout-all"></a></p>
<div class="section" id="post-matrix-client-r0-logout-all">
<h3><a class="toc-backref" href="#id246">5.4.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/logout/all</tt></a></h3>
<p>Invalidates all access tokens for a user, so that they can no longer be used for
authorization. This includes the access token that made this request. All devices
for the user are also deleted. <a class="reference external" href="#device-keys">Device keys</a> for the device are
deleted alongside the device.</p>
<p>This endpoint does not require UI authorization because UI authorization is
designed to protect against attacks where the someone gets hold of a single access
token then takes over the account. This endpoint invalidates all access tokens for
the user, including the token used in the request, and therefore the attacker is
unable to take over the account in this way.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/logout/all</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The user's access tokens were succesfully invalidated.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="login-fallback"></a></p>
<div class="section" id="login-fallback">
<h3><a class="toc-backref" href="#id247">5.4.5&nbsp;&nbsp;&nbsp;Login Fallback</a></h3>
<p>If a client does not recognize any or all login flows it can use the fallback
login API:</p>
<pre class="literal-block">
GET /_matrix/static/client/login/
</pre>
<p>This returns an HTML and JavaScript page which can perform the entire login
process. The page will attempt to call the JavaScript function
<tt class="docutils literal">window.onLogin</tt> when login has been successfully completed.</p>
</div>
</div>
<p><a class="anchor" id="account-registration-and-management"></a></p>
<div class="section" id="account-registration-and-management">
<span id="registration"></span><h2><a class="toc-backref" href="#id248">5.5&nbsp;&nbsp;&nbsp;Account registration and management</a></h2>
<p><a class="anchor" id="post-matrix-client-r0-register"></a></p>
<div class="section" id="post-matrix-client-r0-register">
<h3><a class="toc-backref" href="#id249">5.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/register</tt></a></h3>
<p>This API endpoint uses the <a class="reference internal" href="#user-interactive-authentication-api">User-Interactive Authentication API</a>, except in
the cases where a guest account is being registered.</p>
<p>Register for an account on this homeserver.</p>
<p>There are two kinds of user account:</p>
<ul class="simple">
<li><cite>user</cite> accounts. These accounts may use the full API described in this specification.</li>
<li><cite>guest</cite> accounts. These accounts may have limited permissions and may not be supported by all servers.</li>
</ul>
<p>If registration is successful, this endpoint will issue an access token
the client can use to authorize itself in subsequent requests.</p>
<p>If the client does not supply a <tt class="docutils literal">device_id</tt>, the server must
auto-generate one.</p>
<p>The server SHOULD register an account with a User ID based on the
<tt class="docutils literal">username</tt> provided, if any. Note that the grammar of Matrix User ID
localparts is restricted, so the server MUST either map the provided
<tt class="docutils literal">username</tt> onto a <tt class="docutils literal">user_id</tt> in a logical manner, or reject
<tt class="docutils literal">username</tt>s which do not comply to the grammar, with
<tt class="docutils literal">M_INVALID_USERNAME</tt>.</p>
<p>Matrix clients MUST NOT assume that localpart of the registered
<tt class="docutils literal">user_id</tt> matches the provided <tt class="docutils literal">username</tt>.</p>
<p>The returned access token must be associated with the <tt class="docutils literal">device_id</tt>
supplied by the client or generated by the server. The server may
invalidate any access token previously associated with that device. See
<a class="reference internal" href="#relationship-between-access-tokens-and-devices">Relationship between access tokens and devices</a>.</p>
<p>When registering a guest account, all parameters in the request body
with the exception of <tt class="docutils literal">initial_device_display_name</tt> MUST BE ignored
by the server. The server MUST pick a <tt class="docutils literal">device_id</tt> for the account
regardless of input.</p>
<p>Any user ID returned by this API must conform to the grammar given in the
<a class="reference external" href="../appendices.html#user-identifiers">Matrix specification</a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td>The kind of account to register. Defaults to
<tt class="docutils literal">user</tt>. One of: [&quot;guest&quot;, &quot;user&quot;]</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>auth</td>
<td>Authentication Data</td>
<td>Additional authentication information for the
user-interactive authentication API. Note that
this information is <em>not</em> used to define how the
registered user should be authenticated, but is
instead used to authenticate the <tt class="docutils literal">register</tt> call
itself.</td>
</tr>
<tr><td>bind_email</td>
<td>boolean</td>
<td>If true, the server binds the email used for
authentication to the Matrix ID with the identity
server.</td>
</tr>
<tr><td>bind_msisdn</td>
<td>boolean</td>
<td>If true, the server binds the phone number used
for authentication to the Matrix ID with the
identity server.</td>
</tr>
<tr><td>username</td>
<td>string</td>
<td>The basis for the localpart of the desired Matrix
ID. If omitted, the homeserver MUST generate a
Matrix ID local part.</td>
</tr>
<tr><td>password</td>
<td>string</td>
<td>The desired password for the account.</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td>ID of the client device. If this does not
correspond to a known client device, a new device
will be created. The server will auto-generate a
device_id if this is not specified.</td>
</tr>
<tr><td>initial_device_display_name</td>
<td>string</td>
<td>A display name to assign to the newly-created
device. Ignored if <tt class="docutils literal">device_id</tt> corresponds to a
known device.</td>
</tr>
<tr><td>inhibit_login</td>
<td>boolean</td>
<td>If true, an <tt class="docutils literal">access_token</tt> and <tt class="docutils literal">device_id</tt>
should not be returned from this call, therefore
preventing an automatic login. Defaults to false.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Authentication Data</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The login type that the client is
attempting to complete.</td>
</tr>
<tr><td>session</td>
<td>string</td>
<td>The value of the session key given by the
homeserver.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><p class="first"><strong>Required.</strong> The fully-qualified Matrix user ID
(MXID) that has been registered.</p>
<p class="last">Any user ID returned by this API must conform to
the grammar given in the <a class="reference external" href="../appendices.html#user-identifiers">Matrix specification</a>.</p>
</td>
</tr>
<tr><td>access_token</td>
<td>string</td>
<td>An access token for the account. This access token
can then be used to authorize other requests.
Required if the <tt class="docutils literal">inhibit_login</tt> option is false.</td>
</tr>
<tr><td>home_server</td>
<td>string</td>
<td><p class="first">The server_name of the homeserver on which the
account has been registered.</p>
<p class="last"><strong>Deprecated</strong>. Clients should extract the
server_name from <tt class="docutils literal">user_id</tt> (by splitting at the
first colon) if they require it. Note also that
<tt class="docutils literal">homeserver</tt> is not spelt this way.</p>
</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td>ID of the registered device. Will be the same as
the corresponding parameter in the request, if one
was specified. Required if the <tt class="docutils literal">inhibit_login</tt>
option is false.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/register?kind=user</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.type.foo&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxxxx&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;example_credential&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;verypoorsharedsecret&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;bind_email&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
  <span class="name tag">&quot;bind_msisdn&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
  <span class="name tag">&quot;username&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;cheeky_monkey&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ilovebananas&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;GHTYAJCE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;initial_device_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Jungle Phone&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;inhibit_login&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The account has been registered.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;GHTYAJCE&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>Part of the request was invalid. This may include one of the following error codes:</p>
<ul class="simple">
<li><tt class="docutils literal">M_USER_IN_USE</tt> : The desired user ID is already taken.</li>
<li><tt class="docutils literal">M_INVALID_USERNAME</tt> : The desired user ID is not a valid user name.</li>
<li><tt class="docutils literal">M_EXCLUSIVE</tt> : The desired user ID is in the exclusive namespace
claimed by an application service.</li>
</ul>
<p>These errors may be returned at any stage of the registration process,
including after authentication if the requested user ID was registered
whilst the client was performing authentication.</p>
<p>Homeservers MUST perform the relevant checks and return these codes before
performing User-Interactive Authentication, although they may also return
them after authentication is completed if, for example, the requested user ID
was registered whilst the client was performing authentication.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_USER_IN_USE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Desired user ID is already taken.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The homeserver requires additional authentication information.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;flows&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;stages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;example.type.foo&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;example.type.baz&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;example_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foobar&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxxxxxyz&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;completed&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;example.type.foo&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The homeserver does not permit registering the account. This response
can be used to identify that a particular <tt class="docutils literal">kind</tt> of account is not
allowed, or that registration is generally not supported by the homeserver.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Registration is disabled&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-register-email-requesttoken"></a></p>
<div class="section" id="post-matrix-client-r0-register-email-requesttoken">
<h3><a class="toc-backref" href="#id250">5.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/register/email/requestToken</tt></a></h3>
<p>The homeserver must check that the given email address is <strong>not</strong>
already associated with an account on this homeserver. The homeserver
has the choice of validating the email address itself, or proxying the
request to the <tt class="docutils literal">/validate/email/requestToken</tt> Identity Service API. The
request should be proxied to the domain that is sent by the client in
the <tt class="docutils literal">id_server</tt>. It is imperative that the homeserver keep a list of
trusted Identity Servers and only proxies to those it trusts.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> A unique string generated by the
client, and used to identify the validation
attempt. It must be a string consisting of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must
not exceed 255 characters and it must not be
empty.</td>
</tr>
<tr><td>email</td>
<td>string</td>
<td><strong>Required.</strong> The email address to validate.</td>
</tr>
<tr><td>send_attempt</td>
<td>integer</td>
<td><strong>Required.</strong> The server will only send an email
if the <tt class="docutils literal">send_attempt</tt> is a number greater than
the most recent one which it has seen, scoped to
that <tt class="docutils literal">email</tt> + <tt class="docutils literal">client_secret</tt> pair. This is
to avoid repeatedly sending the same email in the
case of request retries between the POSTing user
and the identity server. The client should
increment this value if they desire a new email
(e.g. a reminder) to be sent. If they do not, the
server should respond with success but not resend
the email.</td>
</tr>
<tr><td>next_link</td>
<td>string</td>
<td>Optional. When the validation is completed, the
identity server will redirect the user to this
URL. This option is ignored when submitting 3PID
validation information through a POST request.</td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td><strong>Required.</strong> The hostname of the identity server
to communicate with. May optionally include a
port. This parameter is ignored when the
homeserver handles 3PID verification.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID. Session IDs are
opaque strings that must consist entirely of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Their length must
not exceed 255 characters and they must not be
empty.</td>
</tr>
<tr><td>submit_url</td>
<td>string</td>
<td><p class="first">An optional field containing a URL where the
client must submit the validation token to, with
identical parameters to the Identity Service API's
<tt class="docutils literal">POST /validate/email/submitToken</tt> endpoint. The
homeserver must send this token to the user (if
applicable), who should then be prompted to
provide it to the client.</p>
<p class="last">If this field is not present, the client can
assume that verification will happen without the
client's involvement provided the homeserver
advertises this specification version in the
<tt class="docutils literal">/versions</tt> response (ie: r0.5.0).</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/register/email/requestToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;email&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&#64;example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;send_attempt&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>An email has been sent to the specified address. Note that this
may be an email containing the validation token or it may be
informing the user of an error.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;123abc&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;submit_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/path/to/submitToken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>Part of the request was invalid. This may include one of the following error codes:</p>
<ul class="simple">
<li><tt class="docutils literal">M_THREEPID_IN_USE</tt> : The email address is already registered to an account on this server.
However, if the homeserver has the ability to send email, it is recommended that the server
instead send an email to the user with instructions on how to reset their password.
This prevents malicious parties from being able to determine if a given email address
has an account on the homeserver in question.</li>
<li><tt class="docutils literal">M_SERVER_NOT_TRUSTED</tt> : The <tt class="docutils literal">id_server</tt> parameter refers to an identity server
that is not trusted by this homeserver.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_IN_USE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The specified address is already in use&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The homeserver does not permit the address to be bound.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_DENIED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Third party identifier is not allowed&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-register-msisdn-requesttoken"></a></p>
<div class="section" id="post-matrix-client-r0-register-msisdn-requesttoken">
<h3><a class="toc-backref" href="#id251">5.5.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/register/msisdn/requestToken</tt></a></h3>
<p>The homeserver must check that the given phone number is <strong>not</strong>
already associated with an account on this homeserver. The homeserver
has the choice of validating the phone number itself, or proxying the
request to the <tt class="docutils literal">/validate/msisdn/requestToken</tt> Identity Service API. The
request should be proxied to the domain that is sent by the client in
the <tt class="docutils literal">id_server</tt>. It is imperative that the homeserver keep a list of
trusted Identity Servers and only proxies to those it trusts.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> A unique string generated by the
client, and used to identify the validation
attempt. It must be a string consisting of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must
not exceed 255 characters and it must not be
empty.</td>
</tr>
<tr><td>country</td>
<td>string</td>
<td><strong>Required.</strong> The two-letter uppercase ISO country
code that the number in <tt class="docutils literal">phone_number</tt> should be
parsed as if it were dialled from.</td>
</tr>
<tr><td>phone_number</td>
<td>string</td>
<td><strong>Required.</strong> The phone number to validate.</td>
</tr>
<tr><td>send_attempt</td>
<td>integer</td>
<td><strong>Required.</strong> The server will only send an SMS if
the <tt class="docutils literal">send_attempt</tt> is a number greater than the
most recent one which it has seen, scoped to that
<tt class="docutils literal">country</tt> + <tt class="docutils literal">phone_number</tt> + <tt class="docutils literal">client_secret</tt>
triple. This is to avoid repeatedly sending the
same SMS in the case of request retries between
the POSTing user and the identity server. The
client should increment this value if they desire
a new SMS (e.g. a reminder) to be sent.</td>
</tr>
<tr><td>next_link</td>
<td>string</td>
<td>Optional. When the validation is completed, the
identity server will redirect the user to this
URL. This option is ignored when submitting 3PID
validation information through a POST request.</td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td><strong>Required.</strong> The hostname of the identity server
to communicate with. May optionally include a
port. This parameter is ignored when the
homeserver handles 3PID verification.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID. Session IDs are
opaque strings that must consist entirely of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Their length must
not exceed 255 characters and they must not be
empty.</td>
</tr>
<tr><td>submit_url</td>
<td>string</td>
<td><p class="first">An optional field containing a URL where the
client must submit the validation token to, with
identical parameters to the Identity Service API's
<tt class="docutils literal">POST /validate/email/submitToken</tt> endpoint. The
homeserver must send this token to the user (if
applicable), who should then be prompted to
provide it to the client.</p>
<p class="last">If this field is not present, the client can
assume that verification will happen without the
client's involvement provided the homeserver
advertises this specification version in the
<tt class="docutils literal">/versions</tt> response (ie: r0.5.0).</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/register/msisdn/requestToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;country&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;GB&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;phone_number&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;07700900001&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;send_attempt&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>An SMS message has been sent to the specified phone number. Note
that this may be an SMS message containing the validation token or
it may be informing the user of an error.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;123abc&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;submit_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/path/to/submitToken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>Part of the request was invalid. This may include one of the following error codes:</p>
<ul class="simple">
<li><tt class="docutils literal">M_THREEPID_IN_USE</tt> : The phone number is already registered to an account on this server.
However, if the homeserver has the ability to send SMS message, it is recommended that the server
instead send an SMS message to the user with instructions on how to reset their password.
This prevents malicious parties from being able to determine if a given phone number
has an account on the homeserver in question.</li>
<li><tt class="docutils literal">M_SERVER_NOT_TRUSTED</tt> : The <tt class="docutils literal">id_server</tt> parameter refers to an identity server
that is not trusted by this homeserver.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_IN_USE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The specified address is already in use&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The homeserver does not permit the address to be bound.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_DENIED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Third party identifier is not allowed&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-account-password"></a></p>
<div class="section" id="post-matrix-client-r0-account-password">
<h3><a class="toc-backref" href="#id252">5.5.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/password</tt></a></h3>
<p>Changes the password for an account on this homeserver.</p>
<p>This API endpoint uses the <a class="reference internal" href="#user-interactive-authentication-api">User-Interactive Authentication API</a> to
ensure the user changing the password is actually the owner of the
account.</p>
<p>An access token should be submitted to this endpoint if the client has
an active session.</p>
<p>The homeserver may change the flows available depending on whether a
valid access token is provided. The homeserver SHOULD NOT revoke the
access token provided in the request, however all other access tokens
for the user should be revoked if the request succeeds.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>new_password</td>
<td>string</td>
<td><strong>Required.</strong> The new password for the account.</td>
</tr>
<tr><td>auth</td>
<td>Authentication Data</td>
<td>Additional authentication information for the
user-interactive authentication API.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Authentication Data</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The login type that the client is
attempting to complete.</td>
</tr>
<tr><td>session</td>
<td>string</td>
<td>The value of the session key given by the
homeserver.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/account/password</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;new_password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ihatebananas&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.type.foo&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxxxx&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;example_credential&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;verypoorsharedsecret&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The password has been changed.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The homeserver requires additional authentication information.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;flows&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;stages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;example.type.foo&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;example.type.baz&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;example_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foobar&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxxxxxyz&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;completed&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;example.type.foo&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-account-password-email-requesttoken"></a></p>
<div class="section" id="post-matrix-client-r0-account-password-email-requesttoken">
<h3><a class="toc-backref" href="#id253">5.5.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/password/email/requestToken</tt></a></h3>
<p>The homeserver must check that the given email address <strong>is
associated</strong> with an account on this homeserver. This API should be
used to request validation tokens when authenticating for the
<tt class="docutils literal">/account/password</tt> endpoint.</p>
<p>This API's parameters and response are identical to that of the
<a class="reference external" href="#post-matrix-client-r0-register-email-requesttoken"><tt class="docutils literal">/register/email/requestToken</tt></a> endpoint, except that
<tt class="docutils literal">M_THREEPID_NOT_FOUND</tt> may be returned if no account matching the
given email address could be found. The server may instead send an
email to the given address prompting the user to create an account.
<tt class="docutils literal">M_THREEPID_IN_USE</tt> may not be returned.</p>
<p>The homeserver has the choice of validating the email address itself,
or proxying the request to the <tt class="docutils literal">/validate/email/requestToken</tt>
Identity Service API. The request should be proxied to the domain that
is sent by the client in the <tt class="docutils literal">id_server</tt>. It is imperative that the
homeserver keep a list of trusted Identity Servers and only proxies to
those that it trusts.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> A unique string generated by the
client, and used to identify the validation
attempt. It must be a string consisting of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must
not exceed 255 characters and it must not be
empty.</td>
</tr>
<tr><td>email</td>
<td>string</td>
<td><strong>Required.</strong> The email address to validate.</td>
</tr>
<tr><td>send_attempt</td>
<td>integer</td>
<td><strong>Required.</strong> The server will only send an email
if the <tt class="docutils literal">send_attempt</tt> is a number greater than
the most recent one which it has seen, scoped to
that <tt class="docutils literal">email</tt> + <tt class="docutils literal">client_secret</tt> pair. This is
to avoid repeatedly sending the same email in the
case of request retries between the POSTing user
and the identity server. The client should
increment this value if they desire a new email
(e.g. a reminder) to be sent. If they do not, the
server should respond with success but not resend
the email.</td>
</tr>
<tr><td>next_link</td>
<td>string</td>
<td>Optional. When the validation is completed, the
identity server will redirect the user to this
URL. This option is ignored when submitting 3PID
validation information through a POST request.</td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td><strong>Required.</strong> The hostname of the identity server
to communicate with. May optionally include a
port. This parameter is ignored when the
homeserver handles 3PID verification.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID. Session IDs are
opaque strings that must consist entirely of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Their length must
not exceed 255 characters and they must not be
empty.</td>
</tr>
<tr><td>submit_url</td>
<td>string</td>
<td><p class="first">An optional field containing a URL where the
client must submit the validation token to, with
identical parameters to the Identity Service API's
<tt class="docutils literal">POST /validate/email/submitToken</tt> endpoint. The
homeserver must send this token to the user (if
applicable), who should then be prompted to
provide it to the client.</p>
<p class="last">If this field is not present, the client can
assume that verification will happen without the
client's involvement provided the homeserver
advertises this specification version in the
<tt class="docutils literal">/versions</tt> response (ie: r0.5.0).</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/account/password/email/requestToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;email&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&#64;example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;send_attempt&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>An email was sent to the given address.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;123abc&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;submit_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/path/to/submitToken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The referenced third party identifier is not recognised by the
homeserver, or the request was invalid</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_NOT_FOUND&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Email not found&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The homeserver does not allow the third party identifier as a
contact option.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_DENIED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Third party identifier is not allowed&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-account-password-msisdn-requesttoken"></a></p>
<div class="section" id="post-matrix-client-r0-account-password-msisdn-requesttoken">
<h3><a class="toc-backref" href="#id254">5.5.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/password/msisdn/requestToken</tt></a></h3>
<p>The homeserver must check that the given phone number <strong>is
associated</strong> with an account on this homeserver. This API should be
used to request validation tokens when authenticating for the
<tt class="docutils literal">/account/password</tt> endpoint.</p>
<p>This API's parameters and response are identical to that of the
<a class="reference external" href="#post-matrix-client-r0-register-email-requesttoken"><tt class="docutils literal">/register/msisdn/requestToken</tt></a> endpoint, except that
<tt class="docutils literal">M_THREEPID_NOT_FOUND</tt> may be returned if no account matching the
given phone number could be found. The server may instead send the SMS
to the given phone number prompting the user to create an account.
<tt class="docutils literal">M_THREEPID_IN_USE</tt> may not be returned.</p>
<p>The homeserver has the choice of validating the phone number itself, or
proxying the request to the <tt class="docutils literal">/validate/msisdn/requestToken</tt> Identity
Service API. The request should be proxied to the domain that is sent
by the client in the <tt class="docutils literal">id_server</tt>. It is imperative that the
homeserver keep a list of trusted Identity Servers and only proxies to
those that it trusts.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> A unique string generated by the
client, and used to identify the validation
attempt. It must be a string consisting of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must
not exceed 255 characters and it must not be
empty.</td>
</tr>
<tr><td>country</td>
<td>string</td>
<td><strong>Required.</strong> The two-letter uppercase ISO country
code that the number in <tt class="docutils literal">phone_number</tt> should be
parsed as if it were dialled from.</td>
</tr>
<tr><td>phone_number</td>
<td>string</td>
<td><strong>Required.</strong> The phone number to validate.</td>
</tr>
<tr><td>send_attempt</td>
<td>integer</td>
<td><strong>Required.</strong> The server will only send an SMS if
the <tt class="docutils literal">send_attempt</tt> is a number greater than the
most recent one which it has seen, scoped to that
<tt class="docutils literal">country</tt> + <tt class="docutils literal">phone_number</tt> + <tt class="docutils literal">client_secret</tt>
triple. This is to avoid repeatedly sending the
same SMS in the case of request retries between
the POSTing user and the identity server. The
client should increment this value if they desire
a new SMS (e.g. a reminder) to be sent.</td>
</tr>
<tr><td>next_link</td>
<td>string</td>
<td>Optional. When the validation is completed, the
identity server will redirect the user to this
URL. This option is ignored when submitting 3PID
validation information through a POST request.</td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td><strong>Required.</strong> The hostname of the identity server
to communicate with. May optionally include a
port. This parameter is ignored when the
homeserver handles 3PID verification.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID. Session IDs are
opaque strings that must consist entirely of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Their length must
not exceed 255 characters and they must not be
empty.</td>
</tr>
<tr><td>submit_url</td>
<td>string</td>
<td><p class="first">An optional field containing a URL where the
client must submit the validation token to, with
identical parameters to the Identity Service API's
<tt class="docutils literal">POST /validate/email/submitToken</tt> endpoint. The
homeserver must send this token to the user (if
applicable), who should then be prompted to
provide it to the client.</p>
<p class="last">If this field is not present, the client can
assume that verification will happen without the
client's involvement provided the homeserver
advertises this specification version in the
<tt class="docutils literal">/versions</tt> response (ie: r0.5.0).</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/account/password/msisdn/requestToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;country&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;GB&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;phone_number&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;07700900001&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;send_attempt&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>An SMS message was sent to the given phone number.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;123abc&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;submit_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/path/to/submitToken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The referenced third party identifier is not recognised by the
homeserver, or the request was invalid</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_NOT_FOUND&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Phone number not found&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The homeserver does not allow the third party identifier as a
contact option.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_DENIED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Third party identifier is not allowed&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-account-deactivate"></a></p>
<div class="section" id="post-matrix-client-r0-account-deactivate">
<h3><a class="toc-backref" href="#id255">5.5.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/deactivate</tt></a></h3>
<p>Deactivate the user's account, removing all ability for the user to
login again.</p>
<p>This API endpoint uses the <a class="reference internal" href="#user-interactive-authentication-api">User-Interactive Authentication API</a>.</p>
<p>An access token should be submitted to this endpoint if the client has
an active session.</p>
<p>The homeserver may change the flows available depending on whether a
valid access token is provided.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>auth</td>
<td>Authentication Data</td>
<td>Additional authentication information for the
user-interactive authentication API.</td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td>The identity server to unbind all of the user's
3PIDs from. If not provided, the homeserver MUST
use the <tt class="docutils literal">id_server</tt> that was originally use to
bind each identifier. If the homeserver does not
know which <tt class="docutils literal">id_server</tt> that was, it must return
an <tt class="docutils literal">id_server_unbind_result</tt> of <tt class="docutils literal"><span class="pre">no-support</span></tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Authentication Data</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The login type that the client is
attempting to complete.</td>
</tr>
<tr><td>session</td>
<td>string</td>
<td>The value of the session key given by the
homeserver.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>id_server_unbind_result</td>
<td>enum</td>
<td><strong>Required.</strong> An indicator as to whether or not
the homeserver was able to unbind the user's 3PIDs
from the identity server(s). <tt class="docutils literal">success</tt> indicates
that all identifiers have been unbound from the
identity server while <tt class="docutils literal"><span class="pre">no-support</span></tt> indicates
that one or more identifiers failed to unbind due
to the identity server refusing the request or the
homeserver being unable to determine an identity
server to unbind from. This must be <tt class="docutils literal">success</tt> if
the homeserver has no identifiers to unbind for
the user. One of: [&quot;success&quot;, &quot;no-support&quot;]</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/account/deactivate</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.type.foo&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxxxx&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;example_credential&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;verypoorsharedsecret&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;id_server&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The account has been deactivated.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;id_server_unbind_result&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;success&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The homeserver requires additional authentication information.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;flows&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;stages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;example.type.foo&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;example.type.baz&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;example_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foobar&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxxxxxyz&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;completed&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;example.type.foo&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-register-available"></a></p>
<div class="section" id="get-matrix-client-r0-register-available">
<h3><a class="toc-backref" href="#id256">5.5.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/register/available</tt></a></h3>
<p>Checks to see if a username is available, and valid, for the server.</p>
<p>The server should check to ensure that, at the time of the request, the
username requested is available for use. This includes verifying that an
application service has not claimed the username and that the username
fits the server's desired requirements (for example, a server could dictate
that it does not permit usernames with underscores).</p>
<p>Matrix clients may wish to use this API prior to attempting registration,
however the clients must also be aware that using this API does not normally
reserve the username. This can mean that the username becomes unavailable
between checking its availability and attempting to register it.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>username</td>
<td>string</td>
<td><strong>Required.</strong> The username to check the
availability of.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>available</td>
<td>boolean</td>
<td>A flag to indicate that the username is available.
This should always be <tt class="docutils literal">true</tt> when the server
replies with 200 OK.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/register/available?username=my_cool_localpart</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The username is available</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;available&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>Part of the request was invalid or the username is not available. This may
include one of the following error codes:</p>
<ul class="simple">
<li><tt class="docutils literal">M_USER_IN_USE</tt> : The desired username is already taken.</li>
<li><tt class="docutils literal">M_INVALID_USERNAME</tt> : The desired username is not a valid user name.</li>
<li><tt class="docutils literal">M_EXCLUSIVE</tt> : The desired username is in the exclusive namespace
claimed by an application service.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_USER_IN_USE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Desired user ID is already taken.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="notes-on-password-management"></a></p>
<div class="section" id="notes-on-password-management">
<h3><a class="toc-backref" href="#id257">5.5.9&nbsp;&nbsp;&nbsp;Notes on password management</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Clients SHOULD enforce that the password provided is suitably complex. The
password SHOULD include a lower-case letter, an upper-case letter, a number
and a symbol and be at a minimum 8 characters in length. Servers MAY reject
weak passwords with an error code <tt class="docutils literal">M_WEAK_PASSWORD</tt>.</p>
</div>
</div>
</div>
<p><a class="anchor" id="adding-account-administrative-contact-information"></a></p>
<div class="section" id="adding-account-administrative-contact-information">
<h2><a class="toc-backref" href="#id258">5.6&nbsp;&nbsp;&nbsp;Adding Account Administrative Contact Information</a></h2>
<p>A homeserver may keep some contact information for administrative use.
This is independent of any information kept by any identity servers.</p>
<p><a class="anchor" id="get-matrix-client-r0-account-3pid"></a></p>
<div class="section" id="get-matrix-client-r0-account-3pid">
<h3><a class="toc-backref" href="#id259">5.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/account/3pid</tt></a></h3>
<p>Gets a list of the third party identifiers that the homeserver has
associated with the user's account.</p>
<p>This is <em>not</em> the same as the list of third party identifiers bound to
the user's Matrix ID in identity servers.</p>
<p>Identifiers in this list may be used by the homeserver as, for example,
identifiers that it will accept to reset the user's account password.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>threepids</td>
<td>[Third party identifier]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Third party identifier</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>medium</td>
<td>enum</td>
<td><strong>Required.</strong> The medium of the third party
identifier. One of: [&quot;email&quot;, &quot;msisdn&quot;]</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The third party identifier address.</td>
</tr>
<tr><td>validated_at</td>
<td>integer</td>
<td><strong>Required.</strong> The timestamp, in milliseconds, when
the identifier was validated by the identity
server.</td>
</tr>
<tr><td>added_at</td>
<td>integer</td>
<td><strong>Required.</strong> The timestamp, in milliseconds, when
the homeserver associated the third party
identifier with the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/account/3pid</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The lookup was successful.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;threepids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkey&#64;banana.island&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;validated_at&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1535176800000</span><span class="punctuation">,</span>
      <span class="name tag">&quot;added_at&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1535336848756</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-account-3pid"></a></p>
<div class="section" id="post-matrix-client-r0-account-3pid">
<h3><a class="toc-backref" href="#id260">5.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/3pid</tt></a></h3>
<p>Adds contact information to the user's account.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>three_pid_creds</td>
<td>ThreePidCredentials</td>
<td><strong>Required.</strong> The third party credentials to
associate with the account.</td>
</tr>
<tr><td>bind</td>
<td>boolean</td>
<td>Whether the homeserver should also bind this third
party identifier to the account's Matrix ID with
the passed identity server. Default: <tt class="docutils literal">false</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ThreePidCredentials</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> The client secret used in the
session with the identity server.</td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td><strong>Required.</strong> The identity server to use.</td>
</tr>
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session identifier given by the
identity server.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/account/3pid</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;three_pid_creds&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;id_server&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123987&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;d0n'tT3ll&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;bind&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The addition was successful.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;submit_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/path/to/submitToken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The credentials could not be verified with the identity server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_AUTH_FAILED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The third party credentials could not be verified by the identity server.&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-account-3pid-delete"></a></p>
<div class="section" id="post-matrix-client-r0-account-3pid-delete">
<h3><a class="toc-backref" href="#id261">5.6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/3pid/delete</tt></a></h3>
<p>Removes a third party identifier from the user's account. This might not
cause an unbind of the identifier from the identity server.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td>The identity server to unbind from. If not
provided, the homeserver MUST use the
<tt class="docutils literal">id_server</tt> the identifier was added through. If
the homeserver does not know the original
<tt class="docutils literal">id_server</tt>, it MUST return a
<tt class="docutils literal">id_server_unbind_result</tt> of <tt class="docutils literal"><span class="pre">no-support</span></tt>.</td>
</tr>
<tr><td>medium</td>
<td>enum</td>
<td><strong>Required.</strong> The medium of the third party
identifier being removed. One of: [&quot;email&quot;,
&quot;msisdn&quot;]</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The third party address being
removed.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>id_server_unbind_result</td>
<td>enum</td>
<td><strong>Required.</strong> An indicator as to whether or not
the homeserver was able to unbind the 3PID from
the identity server. <tt class="docutils literal">success</tt> indicates that
the indentity server has unbound the identifier
whereas <tt class="docutils literal"><span class="pre">no-support</span></tt> indicates that the identity
server refuses to support the request or the
homeserver was not able to determine an identity
server to unbind from. One of: [&quot;no-support&quot;,
&quot;success&quot;]</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/account/3pid/delete</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;id_server&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example&#64;example.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The homeserver has disassociated the third party identifier from the
user.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;id_server_unbind_result&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;success&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-account-3pid-email-requesttoken"></a></p>
<div class="section" id="post-matrix-client-r0-account-3pid-email-requesttoken">
<h3><a class="toc-backref" href="#id262">5.6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/3pid/email/requestToken</tt></a></h3>
<p>The homeserver must check that the given email address is <strong>not</strong>
already associated with an account on this homeserver. This API should
be used to request validation tokens when adding an email address to an
account. This API's parameters and response are identical to that of
the <a class="reference external" href="#post-matrix-client-r0-register-email-requesttoken"><tt class="docutils literal">/register/email/requestToken</tt></a> endpoint. The homeserver has the
choice of validating the email address itself, or proxying the request
to the <tt class="docutils literal">/validate/email/requestToken</tt> Identity Service API as
identified by <tt class="docutils literal">id_server</tt>. It is imperative that the
homeserver keep a list of trusted Identity Servers and only proxies to
those that it trusts.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> A unique string generated by the
client, and used to identify the validation
attempt. It must be a string consisting of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must
not exceed 255 characters and it must not be
empty.</td>
</tr>
<tr><td>email</td>
<td>string</td>
<td><strong>Required.</strong> The email address to validate.</td>
</tr>
<tr><td>send_attempt</td>
<td>integer</td>
<td><strong>Required.</strong> The server will only send an email
if the <tt class="docutils literal">send_attempt</tt> is a number greater than
the most recent one which it has seen, scoped to
that <tt class="docutils literal">email</tt> + <tt class="docutils literal">client_secret</tt> pair. This is
to avoid repeatedly sending the same email in the
case of request retries between the POSTing user
and the identity server. The client should
increment this value if they desire a new email
(e.g. a reminder) to be sent. If they do not, the
server should respond with success but not resend
the email.</td>
</tr>
<tr><td>next_link</td>
<td>string</td>
<td>Optional. When the validation is completed, the
identity server will redirect the user to this
URL. This option is ignored when submitting 3PID
validation information through a POST request.</td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td><strong>Required.</strong> The hostname of the identity server
to communicate with. May optionally include a
port. This parameter is ignored when the
homeserver handles 3PID verification.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID. Session IDs are
opaque strings that must consist entirely of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Their length must
not exceed 255 characters and they must not be
empty.</td>
</tr>
<tr><td>submit_url</td>
<td>string</td>
<td><p class="first">An optional field containing a URL where the
client must submit the validation token to, with
identical parameters to the Identity Service API's
<tt class="docutils literal">POST /validate/email/submitToken</tt> endpoint. The
homeserver must send this token to the user (if
applicable), who should then be prompted to
provide it to the client.</p>
<p class="last">If this field is not present, the client can
assume that verification will happen without the
client's involvement provided the homeserver
advertises this specification version in the
<tt class="docutils literal">/versions</tt> response (ie: r0.5.0).</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/account/3pid/email/requestToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;email&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&#64;example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;send_attempt&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>An email was sent to the given address. Note that this may be an
email containing the validation token or it may be informing the
user of an error.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;123abc&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;submit_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/path/to/submitToken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The third party identifier is already in use on the homeserver, or
the request was invalid.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_IN_USE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Third party identifier already in use&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The homeserver does not allow the third party identifier as a
contact option.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_DENIED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Third party identifier is not allowed&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-account-3pid-msisdn-requesttoken"></a></p>
<div class="section" id="post-matrix-client-r0-account-3pid-msisdn-requesttoken">
<h3><a class="toc-backref" href="#id263">5.6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/account/3pid/msisdn/requestToken</tt></a></h3>
<p>The homeserver must check that the given phone number is <strong>not</strong>
already associated with an account on this homeserver. This API should
be used to request validation tokens when adding a phone number to an
account. This API's parameters and response are identical to that of
the <a class="reference external" href="#post-matrix-client-r0-register-email-requesttoken"><tt class="docutils literal">/register/msisdn/requestToken</tt></a> endpoint. The homeserver has the
choice of validating the phone number itself, or proxying the request
to the <tt class="docutils literal">/validate/msisdn/requestToken</tt> Identity Service API as
identified by <tt class="docutils literal">id_server</tt>. It is imperative that the
homeserver keep a list of trusted Identity Servers and only proxies to
those that it trusts.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>client_secret</td>
<td>string</td>
<td><strong>Required.</strong> A unique string generated by the
client, and used to identify the validation
attempt. It must be a string consisting of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Its length must
not exceed 255 characters and it must not be
empty.</td>
</tr>
<tr><td>country</td>
<td>string</td>
<td><strong>Required.</strong> The two-letter uppercase ISO country
code that the number in <tt class="docutils literal">phone_number</tt> should be
parsed as if it were dialled from.</td>
</tr>
<tr><td>phone_number</td>
<td>string</td>
<td><strong>Required.</strong> The phone number to validate.</td>
</tr>
<tr><td>send_attempt</td>
<td>integer</td>
<td><strong>Required.</strong> The server will only send an SMS if
the <tt class="docutils literal">send_attempt</tt> is a number greater than the
most recent one which it has seen, scoped to that
<tt class="docutils literal">country</tt> + <tt class="docutils literal">phone_number</tt> + <tt class="docutils literal">client_secret</tt>
triple. This is to avoid repeatedly sending the
same SMS in the case of request retries between
the POSTing user and the identity server. The
client should increment this value if they desire
a new SMS (e.g. a reminder) to be sent.</td>
</tr>
<tr><td>next_link</td>
<td>string</td>
<td>Optional. When the validation is completed, the
identity server will redirect the user to this
URL. This option is ignored when submitting 3PID
validation information through a POST request.</td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td><strong>Required.</strong> The hostname of the identity server
to communicate with. May optionally include a
port. This parameter is ignored when the
homeserver handles 3PID verification.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sid</td>
<td>string</td>
<td><strong>Required.</strong> The session ID. Session IDs are
opaque strings that must consist entirely of the
characters <tt class="docutils literal"><span class="pre">[0-9a-zA-Z.=_-]</span></tt>. Their length must
not exceed 255 characters and they must not be
empty.</td>
</tr>
<tr><td>submit_url</td>
<td>string</td>
<td><p class="first">An optional field containing a URL where the
client must submit the validation token to, with
identical parameters to the Identity Service API's
<tt class="docutils literal">POST /validate/email/submitToken</tt> endpoint. The
homeserver must send this token to the user (if
applicable), who should then be prompted to
provide it to the client.</p>
<p class="last">If this field is not present, the client can
assume that verification will happen without the
client's involvement provided the homeserver
advertises this specification version in the
<tt class="docutils literal">/versions</tt> response (ie: r0.5.0).</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/account/3pid/msisdn/requestToken</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;client_secret&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monkeys_are_GREAT&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;country&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;GB&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;phone_number&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;07700900001&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;send_attempt&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>An SMS message was sent to the given phone number.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;123abc&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;submit_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.org/path/to/submitToken&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The third party identifier is already in use on the homeserver, or
the request was invalid.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_IN_USE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Third party identifier already in use&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The homeserver does not allow the third party identifier as a
contact option.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_THREEPID_DENIED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Third party identifier is not allowed&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="current-account-information"></a></p>
<div class="section" id="current-account-information">
<h2><a class="toc-backref" href="#id264">5.7&nbsp;&nbsp;&nbsp;Current account information</a></h2>
<p><a class="anchor" id="get-matrix-client-r0-account-whoami"></a></p>
<div class="section" id="get-matrix-client-r0-account-whoami">
<h3><a class="toc-backref" href="#id265">5.7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/account/whoami</tt></a></h3>
<p>Gets information about the owner of a given access token.</p>
<p>Note that, as with the rest of the Client-Server API,
Application Services may masquerade as users within their
namespace by giving a <tt class="docutils literal">user_id</tt> query parameter. In this
situation, the server should verify that the given <tt class="docutils literal">user_id</tt>
is registered by the appservice, and return it in the response
body.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The user id that owns the access
token.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/account/whoami</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The token belongs to a known user.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;joe:example.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The token is not recognised</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN_TOKEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Unrecognised access token.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The appservice cannot masquerade as the user or has not registered them.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Application service has not registered this user.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="capabilities-negotiation"></a></p>
<div class="section" id="capabilities-negotiation">
<h1><a class="toc-backref" href="#id266">6&nbsp;&nbsp;&nbsp;Capabilities negotiation</a></h1>
<p>A homeserver may not support certain operations and clients must be able to
query for what the homeserver can and can't offer. For example, a homeserver
may not support users changing their password as it is configured to perform
authentication against an external system.</p>
<p>The capabilities advertised through this system are intended to advertise
functionality which is optional in the API, or which depend in some way on
the state of the user or server. This system should not be used to advertise
unstable or experimental features - this is better done by the <tt class="docutils literal">/versions</tt>
endpoint.</p>
<p>Some examples of what a reasonable capability could be are:</p>
<ul class="simple">
<li>Whether the server supports user presence.</li>
<li>Whether the server supports optional features, such as the user or room
directories.</li>
<li>The rate limits or file type restrictions imposed on clients by the server.</li>
</ul>
<p>Some examples of what should <strong>not</strong> be a capability are:</p>
<ul class="simple">
<li>Whether the server supports a feature in the <tt class="docutils literal">unstable</tt> specification.</li>
<li>Media size limits - these are handled by the <tt class="docutils literal">/media/r0/config</tt>
API.</li>
<li>Optional encodings or alternative transports for communicating with the
server.</li>
</ul>
<p>Capabilities prefixed with <tt class="docutils literal">m.</tt> are reserved for definition in the Matrix
specification while other values may be used by servers using the Java package
naming convention. The capabilities supported by the Matrix specification are
defined later in this section.</p>
<p><a class="anchor" id="get-matrix-client-r0-capabilities"></a></p>
<div class="section" id="get-matrix-client-r0-capabilities">
<h2><a class="toc-backref" href="#id267">6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/capabilities</tt></a></h2>
<p>Gets information about the server's supported feature set
and other relevant capabilities.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>capabilities</td>
<td>Capabilities</td>
<td><strong>Required.</strong> The custom capabilities the server
supports, using the Java package naming
convention.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Capabilities</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>m.change_password</td>
<td>ChangePasswordCapability</td>
<td>Capability to indicate if the user can change
their password.</td>
</tr>
<tr><td>m.room_versions</td>
<td>RoomVersionsCapability</td>
<td>The room versions the server supports.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ChangePasswordCapability</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>enabled</td>
<td>boolean</td>
<td><strong>Required.</strong> True if the user can change their
password, false otherwise.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomVersionsCapability</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>default</td>
<td>string</td>
<td><strong>Required.</strong> The default room version the server
is using for new rooms.</td>
</tr>
<tr><td>available</td>
<td>{string: enum}</td>
<td><strong>Required.</strong> A detailed description of the room
versions the server supports.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/capabilities</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The capabilities of the server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;m.change_password&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;m.room_versions&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;available&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;1&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;stable&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;2&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;stable&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;3&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;unstable&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;test-version&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;unstable&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;com.example.custom.ratelimit&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;max_requests_per_hour&quot;</span><span class="punctuation">:</span> <span class="literal number integer">600</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-change-password-capability"></a></p>
<div class="section" id="m-change-password-capability">
<h2><a class="toc-backref" href="#id268">6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.change_password</tt> capability</a></h2>
<p>This capability has a single flag, <tt class="docutils literal">enabled</tt>, which indicates whether or not
the user can use the <tt class="docutils literal">/account/password</tt> API to change their password. If not
present, the client should assume that password changes are possible via the
API. When present, clients SHOULD respect the capability's <tt class="docutils literal">enabled</tt> flag
and indicate to the user if they are unable to change their password.</p>
<p>An example of the capability API's response for this capability is:</p>
<pre class="literal-block">
{
  &quot;capabilities&quot;: {
    &quot;m.change_password&quot;: {
      &quot;enabled&quot;: false
    }
  }
}
</pre>
</div>
<p><a class="anchor" id="m-room-versions-capability"></a></p>
<div class="section" id="m-room-versions-capability">
<h2><a class="toc-backref" href="#id269">6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room_versions</tt> capability</a></h2>
<p>This capability describes the default and available room versions a server
supports, and at what level of stability. Clients should make use of this
capability to determine if users need to be encouraged to upgrade their rooms.</p>
<p>An example of the capability API's response for this capability is:</p>
<pre class="literal-block">
{
  &quot;capabilities&quot;: {
    &quot;m.room_versions&quot;: {
      &quot;default&quot;: &quot;1&quot;,
      &quot;available&quot;: {
        &quot;1&quot;: &quot;stable&quot;,
        &quot;2&quot;: &quot;stable&quot;,
        &quot;3&quot;: &quot;unstable&quot;,
        &quot;custom-version&quot;: &quot;unstable&quot;
      }
    }
  }
}
</pre>
<p>This capability mirrors the same restrictions of <a class="reference external" href="../index.html#room-versions">room versions</a> to describe
which versions are stable and unstable. Clients should assume that the <tt class="docutils literal">default</tt>
version is <tt class="docutils literal">stable</tt>. Any version not explicitly labelled as <tt class="docutils literal">stable</tt> in the
<tt class="docutils literal">available</tt> versions is to be treated as <tt class="docutils literal">unstable</tt>. For example, a version
listed as <tt class="docutils literal"><span class="pre">future-stable</span></tt> should be treated as <tt class="docutils literal">unstable</tt>.</p>
<p>The <tt class="docutils literal">default</tt> version is the version the server is using to create new rooms.
Clients should encourage users with sufficient permissions in a room to upgrade
their room to the <tt class="docutils literal">default</tt> version when the room is using an <tt class="docutils literal">unstable</tt>
version.</p>
<p>When this capability is not listed, clients should use <tt class="docutils literal">&quot;1&quot;</tt> as the default
and only stable <tt class="docutils literal">available</tt> room version.</p>
</div>
</div>
<p><a class="anchor" id="pagination"></a></p>
<div class="section" id="pagination">
<h1><a class="toc-backref" href="#id270">7&nbsp;&nbsp;&nbsp;Pagination</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The paths referred to in this section are not actual endpoints. They only
serve as examples to explain how pagination functions.</p>
</div>
<p>Pagination is the process of dividing a dataset into multiple discrete pages.
Matrix makes use of pagination to allow clients to view extremely large datasets.
These datasets are not limited to events in a room (for example clients may want
to paginate a list of rooms in addition to events within those rooms). Regardless
of what is being paginated, there is a common approach which is used to give
clients an easy way of selecting subsets of a potentially changing dataset. Each
endpoint that uses pagination may use different parameters. However the theme
among them is that they take a <tt class="docutils literal">from</tt> and <tt class="docutils literal">to</tt> token, and occasionally
a <tt class="docutils literal">limit</tt> and <tt class="docutils literal">dir</tt>. Together, these parameters describe the position in a
data set, where <tt class="docutils literal">from</tt> and <tt class="docutils literal">to</tt> are known as &quot;stream tokens&quot; matching the
regular expression <tt class="docutils literal"><span class="pre">[a-zA-Z0-9.=_-]+</span></tt>. If supported, the <tt class="docutils literal">dir</tt> defines the
direction of events to return: either forwards (<tt class="docutils literal">f</tt>) or backwards (<tt class="docutils literal">b</tt>).
The response may contain tokens that can be used for retrieving results before
or after the returned set. These tokens may be called <cite>start</cite> or <cite>prev_batch</cite>
for retrieving the previous result set, or <cite>end</cite>, <cite>next_batch</cite> or <cite>next_token</cite>
for retrieving the next result set.</p>
<p>In the following examples, 'START' and 'END' are placeholders to signify the
start and end of the data sets respectively.</p>
<p>For example, if an endpoint had events E1 -&gt; E15. The client wants the last 5
events and doesn't know any previous events:</p>
<pre class="literal-block">
S                                                    E
|-E1-E2-E3-E4-E5-E6-E7-E8-E9-E10-E11-E12-E13-E14-E15-|
|                               |                    |
|                          _____|  &lt;--backwards--    |
|__________________       |         |        ________|
                   |      |         |        |
 GET /somepath?to=START&amp;limit=5&amp;dir=b&amp;from=END
 Returns:
   E15,E14,E13,E12,E11
</pre>
<p>Another example: a public room list has rooms R1 -&gt; R17. The client is showing 5
rooms at a time on screen, and is on page 2. They want to now show page 3 (rooms
R11 -&gt; 15):</p>
<pre class="literal-block">
S                                                           E
|  0  1  2  3  4  5  6  7  8  9  10  11  12  13  14  15  16 | stream token
|-R1-R2-R3-R4-R5-R6-R7-R8-R9-R10-R11-R12-R13-R14-R15-R16-R17| room
                  |____________| |________________|
                        |                |
                    Currently            |
                    viewing              |
                                         |
                         GET /roomslist?from=9&amp;to=END&amp;limit=5
                         Returns: R11,R12,R13,R14,R15
</pre>
<p>Note that tokens are treated in an <em>exclusive</em>, not inclusive, manner. The end
token from the initial request was '9' which corresponded to R10. When the 2nd
request was made, R10 did not appear again, even though from=9 was specified. If
you know the token, you already have the data.</p>
<p>Responses for pagination-capable endpoints SHOULD have a <tt class="docutils literal">chunk</tt> array alongside
the applicable stream tokens to represent the result set.</p>
<p>In general, when the end of a result set is reached the applicable stream token
will be excluded from the response. For example, if a user was backwards-paginating
events in a room they'd eventually reach the first event in the room. In this scenario,
the <tt class="docutils literal">prev_batch</tt> token would be excluded from the response. Some paginated
endpoints are open-ended in one direction, such as endpoints which expose an event
stream for an active room. In this case, it is not possible for the client to reach
the true &quot;end&quot; of the data set and therefore should always be presented with a token
to keep moving forwards.</p>
</div>
<p><a class="anchor" id="filtering"></a></p>
<div class="section" id="filtering">
<span id="filter"></span><h1><a class="toc-backref" href="#id271">8&nbsp;&nbsp;&nbsp;Filtering</a></h1>
<p>Filters can be created on the server and can be passed as as a parameter to APIs
which return events. These filters alter the data returned from those APIs.
Not all APIs accept filters.</p>
<p><a class="anchor" id="lazy-loading-room-members"></a></p>
<div class="section" id="lazy-loading-room-members">
<h2><a class="toc-backref" href="#id272">8.1&nbsp;&nbsp;&nbsp;Lazy-loading room members</a></h2>
<p>Membership events often take significant resources for clients to track. In an
effort to reduce the number of resources used, clients can enable &quot;lazy-loading&quot;
for room members. By doing this, servers will attempt to only send membership events
which are relevant to the client.</p>
<p>It is important to understand that lazy-loading is not intended to be a
perfect optimisation, and that it may not be practical for the server to
calculate precisely which membership events are relevant to the client.  As a
result, it is valid for the server to send redundant membership events to the
client to ease implementation, although such redundancy should be minimised
where possible to conserve bandwidth.</p>
<p>In terms of filters, lazy-loading is enabled by enabling <tt class="docutils literal">lazy_load_members</tt>
on a <tt class="docutils literal">RoomEventFilter</tt> (or a <tt class="docutils literal">StateFilter</tt> in the case of <tt class="docutils literal">/sync</tt> only).
When enabled, lazy-loading aware endpoints (see below) will only include
membership events for the <tt class="docutils literal">sender</tt> of events being included in the response.
For example, if a client makes a <tt class="docutils literal">/sync</tt> request with lazy-loading enabled,
the server will only return membership events for the <tt class="docutils literal">sender</tt> of events in
the timeline, not all members of a room.</p>
<p>When processing a sequence of events (e.g. by looping on <tt class="docutils literal">/sync</tt> or
paginating <tt class="docutils literal">/messages</tt>), it is common for blocks of events in the sequence
to share a similar set of senders.  Rather than responses in the sequence
sending duplicate membership events for these senders to the client, the
server MAY assume that clients will remember membership events they have
already been sent, and choose to skip sending membership events for members
whose membership has not changed.  These are called 'redundant membership
events'. Clients may request that redundant membership events are always
included in responses by setting <tt class="docutils literal">include_redundant_members</tt> to true in the
filter.</p>
<p>The expected pattern for using lazy-loading is currently:</p>
<ul class="simple">
<li>Client performs an initial /sync with lazy-loading enabled, and receives
only the membership events which relate to the senders of the events it
receives.</li>
<li>Clients which support display-name tab-completion or other operations which
require rapid access to all members in a room should call /members for the
currently selected room, with an <tt class="docutils literal"><span class="pre">?at</span></tt> parameter set to the /sync
response's from token. The member list for the room is then maintained by
the state in subsequent incremental /sync responses.</li>
<li>Clients which do not support tab-completion may instead pull in profiles for
arbitrary users (e.g. read receipts, typing notifications) on demand by
querying the room state or <tt class="docutils literal">/profile</tt>.</li>
</ul>
<!-- TODO-spec
This implies that GET /state should also take an ``?at`` param -->
<p>The current endpoints which support lazy-loading room members are:</p>
<ul class="simple">
<li><a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a></li>
<li><a class="reference external" href="#get-matrix-client-r0-rooms-roomid-messages"><tt class="docutils literal"><span class="pre">/rooms/&lt;room_id&gt;/messages</span></tt></a></li>
<li><a class="reference external" href="#get-matrix-client-r0-rooms-roomid-context-eventid"><tt class="docutils literal"><span class="pre">/rooms/{roomId}/context/{eventId}</span></tt></a></li>
</ul>
</div>
<p><a class="anchor" id="api-endpoints"></a></p>
<div class="section" id="api-endpoints">
<h2><a class="toc-backref" href="#id273">8.2&nbsp;&nbsp;&nbsp;API endpoints</a></h2>
<p><a class="anchor" id="post-matrix-client-r0-user-userid-filter"></a></p>
<div class="section" id="post-matrix-client-r0-user-userid-filter">
<h3><a class="toc-backref" href="#id274">8.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/user/{userId}/filter</span></tt></a></h3>
<p>Uploads a new filter definition to the homeserver.
Returns a filter ID that may be used in future requests to
restrict which events are returned to the client.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The id of the user uploading the
filter. The access token must be authorized to
make requests for this user id.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>event_fields</td>
<td>[string]</td>
<td>List of event fields to include. If this list is
absent then all fields are included. The entries
may include '.' charaters to indicate sub-fields.
So ['content.body'] will include the 'body' field
of the 'content' object. A literal '.' character
in a field name may be escaped using a '\'. A
server may include more fields than were
requested.</td>
</tr>
<tr><td>event_format</td>
<td>enum</td>
<td>The format to use for events. 'client' will return
the events in a format suitable for clients.
'federation' will return the raw event as
receieved over federation. The default is
'client'. One of: [&quot;client&quot;, &quot;federation&quot;]</td>
</tr>
<tr><td>presence</td>
<td>EventFilter</td>
<td>The presence updates to include.</td>
</tr>
<tr><td>account_data</td>
<td>EventFilter</td>
<td>The user account data that isn't associated with
rooms to include.</td>
</tr>
<tr><td>room</td>
<td>RoomFilter</td>
<td>Filters to be applied to room data.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>EventFilter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to return.</td>
</tr>
<tr><td>not_senders</td>
<td>[string]</td>
<td>A list of sender IDs to exclude. If this list is
absent then no senders are excluded. A matching
sender will be excluded even if it is listed in
the <tt class="docutils literal">'senders'</tt> filter.</td>
</tr>
<tr><td>not_types</td>
<td>[string]</td>
<td>A list of event types to exclude. If this list is
absent then no event types are excluded. A
matching type will be excluded even if it is
listed in the <tt class="docutils literal">'types'</tt> filter. A '*' can be
used as a wildcard to match any sequence of
characters.</td>
</tr>
<tr><td>senders</td>
<td>[string]</td>
<td>A list of senders IDs to include. If this list is
absent then all senders are included.</td>
</tr>
<tr><td>types</td>
<td>[string]</td>
<td>A list of event types to include. If this list is
absent then all event types are included. A
<tt class="docutils literal">'*'</tt> can be used as a wildcard to match any
sequence of characters.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomFilter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>not_rooms</td>
<td>[string]</td>
<td>A list of room IDs to exclude. If this list is
absent then no rooms are excluded. A matching room
will be excluded even if it is listed in the
<tt class="docutils literal">'rooms'</tt> filter. This filter is applied before
the filters in <tt class="docutils literal">ephemeral</tt>, <tt class="docutils literal">state</tt>,
<tt class="docutils literal">timeline</tt> or <tt class="docutils literal">account_data</tt></td>
</tr>
<tr><td>rooms</td>
<td>[string]</td>
<td>A list of room IDs to include. If this list is
absent then all rooms are included. This filter is
applied before the filters in <tt class="docutils literal">ephemeral</tt>,
<tt class="docutils literal">state</tt>, <tt class="docutils literal">timeline</tt> or <tt class="docutils literal">account_data</tt></td>
</tr>
<tr><td>ephemeral</td>
<td>RoomEventFilter</td>
<td>The events that aren't recorded in the room
history, e.g. typing and receipts, to include for
rooms.</td>
</tr>
<tr><td>include_leave</td>
<td>boolean</td>
<td>Include rooms that the user has left in the sync,
default false</td>
</tr>
<tr><td>state</td>
<td>StateFilter</td>
<td>The state events to include for rooms.</td>
</tr>
<tr><td>timeline</td>
<td>RoomEventFilter</td>
<td>The message and state update events to include for
rooms.</td>
</tr>
<tr><td>account_data</td>
<td>RoomEventFilter</td>
<td>The per user account data to include for rooms.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StateFilter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to return.</td>
</tr>
<tr><td>not_senders</td>
<td>[string]</td>
<td>A list of sender IDs to exclude. If this list is
absent then no senders are excluded. A matching
sender will be excluded even if it is listed in
the <tt class="docutils literal">'senders'</tt> filter.</td>
</tr>
<tr><td>not_types</td>
<td>[string]</td>
<td>A list of event types to exclude. If this list is
absent then no event types are excluded. A
matching type will be excluded even if it is
listed in the <tt class="docutils literal">'types'</tt> filter. A '*' can be
used as a wildcard to match any sequence of
characters.</td>
</tr>
<tr><td>senders</td>
<td>[string]</td>
<td>A list of senders IDs to include. If this list is
absent then all senders are included.</td>
</tr>
<tr><td>types</td>
<td>[string]</td>
<td>A list of event types to include. If this list is
absent then all event types are included. A
<tt class="docutils literal">'*'</tt> can be used as a wildcard to match any
sequence of characters.</td>
</tr>
<tr><td>lazy_load_members</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, enables lazy-loading of membership
events. See <a class="reference external" href="#lazy-loading-room-members">Lazy-loading room members</a> for more information.
Defaults to <tt class="docutils literal">false</tt>.</td>
</tr>
<tr><td>include_redundant_members</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, sends all membership events for all
events, even if they have already been sent to the
client. Does not apply unless
<tt class="docutils literal">lazy_load_members</tt> is <tt class="docutils literal">true</tt>. See <a class="reference external" href="#lazy-loading-room-members">Lazy-
loading room members</a> for more information. Defaults to
<tt class="docutils literal">false</tt>.</td>
</tr>
<tr><td>not_rooms</td>
<td>[string]</td>
<td>A list of room IDs to exclude. If this list is
absent then no rooms are excluded. A matching room
will be excluded even if it is listed in the
<tt class="docutils literal">'rooms'</tt> filter.</td>
</tr>
<tr><td>rooms</td>
<td>[string]</td>
<td>A list of room IDs to include. If this list is
absent then all rooms are included.</td>
</tr>
<tr><td>contains_url</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, includes only events with a <tt class="docutils literal">url</tt>
key in their content. If <tt class="docutils literal">false</tt>, excludes those
events. If omitted, <tt class="docutils literal">url</tt> key is not considered
for filtering.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomEventFilter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to return.</td>
</tr>
<tr><td>not_senders</td>
<td>[string]</td>
<td>A list of sender IDs to exclude. If this list is
absent then no senders are excluded. A matching
sender will be excluded even if it is listed in
the <tt class="docutils literal">'senders'</tt> filter.</td>
</tr>
<tr><td>not_types</td>
<td>[string]</td>
<td>A list of event types to exclude. If this list is
absent then no event types are excluded. A
matching type will be excluded even if it is
listed in the <tt class="docutils literal">'types'</tt> filter. A '*' can be
used as a wildcard to match any sequence of
characters.</td>
</tr>
<tr><td>senders</td>
<td>[string]</td>
<td>A list of senders IDs to include. If this list is
absent then all senders are included.</td>
</tr>
<tr><td>types</td>
<td>[string]</td>
<td>A list of event types to include. If this list is
absent then all event types are included. A
<tt class="docutils literal">'*'</tt> can be used as a wildcard to match any
sequence of characters.</td>
</tr>
<tr><td>lazy_load_members</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, enables lazy-loading of membership
events. See <a class="reference external" href="#lazy-loading-room-members">Lazy-loading room members</a> for more information.
Defaults to <tt class="docutils literal">false</tt>.</td>
</tr>
<tr><td>include_redundant_members</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, sends all membership events for all
events, even if they have already been sent to the
client. Does not apply unless
<tt class="docutils literal">lazy_load_members</tt> is <tt class="docutils literal">true</tt>. See <a class="reference external" href="#lazy-loading-room-members">Lazy-
loading room members</a> for more information. Defaults to
<tt class="docutils literal">false</tt>.</td>
</tr>
<tr><td>not_rooms</td>
<td>[string]</td>
<td>A list of room IDs to exclude. If this list is
absent then no rooms are excluded. A matching room
will be excluded even if it is listed in the
<tt class="docutils literal">'rooms'</tt> filter.</td>
</tr>
<tr><td>rooms</td>
<td>[string]</td>
<td>A list of room IDs to include. If this list is
absent then all rooms are included.</td>
</tr>
<tr><td>contains_url</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, includes only events with a <tt class="docutils literal">url</tt>
key in their content. If <tt class="docutils literal">false</tt>, excludes those
events. If omitted, <tt class="docutils literal">url</tt> key is not considered
for filtering.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>filter_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the filter that was
created. Cannot start with a <tt class="docutils literal">{</tt> as this
character is used to determine if the filter
provided is inline JSON or a previously declared
filter by homeservers on some APIs.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/user/%40alice%3Aexample.com/filter</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;room&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;m.room.*&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;not_rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;!726s6s6q:example.com&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;timeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="literal number integer">10</span><span class="punctuation">,</span>
      <span class="name tag">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;m.room.message&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;not_rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;!726s6s6q:example.com&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;not_senders&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;&#64;spam:example.com&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;ephemeral&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;m.receipt&quot;</span><span class="punctuation">,</span>
        <span class="literal string double">&quot;m.typing&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;not_rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;!726s6s6q:example.com&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;not_senders&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;&#64;spam:example.com&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;m.presence&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;not_senders&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
    <span class="punctuation">]</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;event_format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;client&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;event_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;content&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;sender&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The filter was created.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;filter_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;66696p746572&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-user-userid-filter-filterid"></a></p>
<div class="section" id="get-matrix-client-r0-user-userid-filter-filterid">
<h3><a class="toc-backref" href="#id275">8.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/user/{userId}/filter/{filterId}</span></tt></a></h3>
<p>Download a filter</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user ID to download a filter
for.</td>
</tr>
<tr><td>filterId</td>
<td>string</td>
<td><strong>Required.</strong> The filter ID to download.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Filter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_fields</td>
<td>[string]</td>
<td>List of event fields to include. If this list is
absent then all fields are included. The entries
may include '.' charaters to indicate sub-fields.
So ['content.body'] will include the 'body' field
of the 'content' object. A literal '.' character
in a field name may be escaped using a '\'. A
server may include more fields than were
requested.</td>
</tr>
<tr><td>event_format</td>
<td>enum</td>
<td>The format to use for events. 'client' will return
the events in a format suitable for clients.
'federation' will return the raw event as
receieved over federation. The default is
'client'. One of: [&quot;client&quot;, &quot;federation&quot;]</td>
</tr>
<tr><td>presence</td>
<td>EventFilter</td>
<td>The presence updates to include.</td>
</tr>
<tr><td>account_data</td>
<td>EventFilter</td>
<td>The user account data that isn't associated with
rooms to include.</td>
</tr>
<tr><td>room</td>
<td>RoomFilter</td>
<td>Filters to be applied to room data.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>EventFilter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to return.</td>
</tr>
<tr><td>not_senders</td>
<td>[string]</td>
<td>A list of sender IDs to exclude. If this list is
absent then no senders are excluded. A matching
sender will be excluded even if it is listed in
the <tt class="docutils literal">'senders'</tt> filter.</td>
</tr>
<tr><td>not_types</td>
<td>[string]</td>
<td>A list of event types to exclude. If this list is
absent then no event types are excluded. A
matching type will be excluded even if it is
listed in the <tt class="docutils literal">'types'</tt> filter. A '*' can be
used as a wildcard to match any sequence of
characters.</td>
</tr>
<tr><td>senders</td>
<td>[string]</td>
<td>A list of senders IDs to include. If this list is
absent then all senders are included.</td>
</tr>
<tr><td>types</td>
<td>[string]</td>
<td>A list of event types to include. If this list is
absent then all event types are included. A
<tt class="docutils literal">'*'</tt> can be used as a wildcard to match any
sequence of characters.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomFilter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>not_rooms</td>
<td>[string]</td>
<td>A list of room IDs to exclude. If this list is
absent then no rooms are excluded. A matching room
will be excluded even if it is listed in the
<tt class="docutils literal">'rooms'</tt> filter. This filter is applied before
the filters in <tt class="docutils literal">ephemeral</tt>, <tt class="docutils literal">state</tt>,
<tt class="docutils literal">timeline</tt> or <tt class="docutils literal">account_data</tt></td>
</tr>
<tr><td>rooms</td>
<td>[string]</td>
<td>A list of room IDs to include. If this list is
absent then all rooms are included. This filter is
applied before the filters in <tt class="docutils literal">ephemeral</tt>,
<tt class="docutils literal">state</tt>, <tt class="docutils literal">timeline</tt> or <tt class="docutils literal">account_data</tt></td>
</tr>
<tr><td>ephemeral</td>
<td>RoomEventFilter</td>
<td>The events that aren't recorded in the room
history, e.g. typing and receipts, to include for
rooms.</td>
</tr>
<tr><td>include_leave</td>
<td>boolean</td>
<td>Include rooms that the user has left in the sync,
default false</td>
</tr>
<tr><td>state</td>
<td>StateFilter</td>
<td>The state events to include for rooms.</td>
</tr>
<tr><td>timeline</td>
<td>RoomEventFilter</td>
<td>The message and state update events to include for
rooms.</td>
</tr>
<tr><td>account_data</td>
<td>RoomEventFilter</td>
<td>The per user account data to include for rooms.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StateFilter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to return.</td>
</tr>
<tr><td>not_senders</td>
<td>[string]</td>
<td>A list of sender IDs to exclude. If this list is
absent then no senders are excluded. A matching
sender will be excluded even if it is listed in
the <tt class="docutils literal">'senders'</tt> filter.</td>
</tr>
<tr><td>not_types</td>
<td>[string]</td>
<td>A list of event types to exclude. If this list is
absent then no event types are excluded. A
matching type will be excluded even if it is
listed in the <tt class="docutils literal">'types'</tt> filter. A '*' can be
used as a wildcard to match any sequence of
characters.</td>
</tr>
<tr><td>senders</td>
<td>[string]</td>
<td>A list of senders IDs to include. If this list is
absent then all senders are included.</td>
</tr>
<tr><td>types</td>
<td>[string]</td>
<td>A list of event types to include. If this list is
absent then all event types are included. A
<tt class="docutils literal">'*'</tt> can be used as a wildcard to match any
sequence of characters.</td>
</tr>
<tr><td>lazy_load_members</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, enables lazy-loading of membership
events. See <a class="reference external" href="#lazy-loading-room-members">Lazy-loading room members</a> for more information.
Defaults to <tt class="docutils literal">false</tt>.</td>
</tr>
<tr><td>include_redundant_members</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, sends all membership events for all
events, even if they have already been sent to the
client. Does not apply unless
<tt class="docutils literal">lazy_load_members</tt> is <tt class="docutils literal">true</tt>. See <a class="reference external" href="#lazy-loading-room-members">Lazy-
loading room members</a> for more information. Defaults to
<tt class="docutils literal">false</tt>.</td>
</tr>
<tr><td>not_rooms</td>
<td>[string]</td>
<td>A list of room IDs to exclude. If this list is
absent then no rooms are excluded. A matching room
will be excluded even if it is listed in the
<tt class="docutils literal">'rooms'</tt> filter.</td>
</tr>
<tr><td>rooms</td>
<td>[string]</td>
<td>A list of room IDs to include. If this list is
absent then all rooms are included.</td>
</tr>
<tr><td>contains_url</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, includes only events with a <tt class="docutils literal">url</tt>
key in their content. If <tt class="docutils literal">false</tt>, excludes those
events. If omitted, <tt class="docutils literal">url</tt> key is not considered
for filtering.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomEventFilter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to return.</td>
</tr>
<tr><td>not_senders</td>
<td>[string]</td>
<td>A list of sender IDs to exclude. If this list is
absent then no senders are excluded. A matching
sender will be excluded even if it is listed in
the <tt class="docutils literal">'senders'</tt> filter.</td>
</tr>
<tr><td>not_types</td>
<td>[string]</td>
<td>A list of event types to exclude. If this list is
absent then no event types are excluded. A
matching type will be excluded even if it is
listed in the <tt class="docutils literal">'types'</tt> filter. A '*' can be
used as a wildcard to match any sequence of
characters.</td>
</tr>
<tr><td>senders</td>
<td>[string]</td>
<td>A list of senders IDs to include. If this list is
absent then all senders are included.</td>
</tr>
<tr><td>types</td>
<td>[string]</td>
<td>A list of event types to include. If this list is
absent then all event types are included. A
<tt class="docutils literal">'*'</tt> can be used as a wildcard to match any
sequence of characters.</td>
</tr>
<tr><td>lazy_load_members</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, enables lazy-loading of membership
events. See <a class="reference external" href="#lazy-loading-room-members">Lazy-loading room members</a> for more information.
Defaults to <tt class="docutils literal">false</tt>.</td>
</tr>
<tr><td>include_redundant_members</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, sends all membership events for all
events, even if they have already been sent to the
client. Does not apply unless
<tt class="docutils literal">lazy_load_members</tt> is <tt class="docutils literal">true</tt>. See <a class="reference external" href="#lazy-loading-room-members">Lazy-
loading room members</a> for more information. Defaults to
<tt class="docutils literal">false</tt>.</td>
</tr>
<tr><td>not_rooms</td>
<td>[string]</td>
<td>A list of room IDs to exclude. If this list is
absent then no rooms are excluded. A matching room
will be excluded even if it is listed in the
<tt class="docutils literal">'rooms'</tt> filter.</td>
</tr>
<tr><td>rooms</td>
<td>[string]</td>
<td>A list of room IDs to include. If this list is
absent then all rooms are included.</td>
</tr>
<tr><td>contains_url</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, includes only events with a <tt class="docutils literal">url</tt>
key in their content. If <tt class="docutils literal">false</tt>, excludes those
events. If omitted, <tt class="docutils literal">url</tt> key is not considered
for filtering.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/user/%40alice%3Aexample.com/filter/66696p746572</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>&quot;The filter defintion&quot;</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;room&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;m.room.*&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;not_rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;!726s6s6q:example.com&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;timeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="literal number integer">10</span><span class="punctuation">,</span>
      <span class="name tag">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;m.room.message&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;not_rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;!726s6s6q:example.com&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;not_senders&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;&#64;spam:example.com&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;ephemeral&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;m.receipt&quot;</span><span class="punctuation">,</span>
        <span class="literal string double">&quot;m.typing&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;not_rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;!726s6s6q:example.com&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;not_senders&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;&#64;spam:example.com&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;m.presence&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;not_senders&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
    <span class="punctuation">]</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;event_format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;client&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;event_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;content&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;sender&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>Unknown filter.</p>
</div>
</div>
</div>
<p><a class="anchor" id="events"></a></p>
<div class="section" id="events">
<h1><a class="toc-backref" href="#id276">9&nbsp;&nbsp;&nbsp;Events</a></h1>
<p id="sect-events">The model of conversation history exposed by the client-server API can be
considered as a list of events. The server 'linearises' the
eventually-consistent event graph of events into an 'event stream' at any given
point in time:</p>
<pre class="literal-block">
[E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]
</pre>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>The format of events can change depending on room version. Check the
<a class="reference external" href="../index.html#room-versions">room version specification</a> for specific details on what to expect for
event formats. Examples contained within the client-server specification
are expected to be compatible with all specified room versions, however
some differences may still apply.</p>
<p class="last">For this version of the specification, clients only need to worry about
the event ID format being different depending on room version. Clients
should not be parsing the event ID, and instead be treating it as an
opaque string. No changes should be required to support the currently
available room versions.</p>
</div>
<p><a class="anchor" id="types-of-room-events"></a></p>
<div class="section" id="types-of-room-events">
<h2><a class="toc-backref" href="#id277">9.1&nbsp;&nbsp;&nbsp;Types of room events</a></h2>
<p>Room events are split into two categories:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">State Events:</th><td class="field-body">These are events which update the metadata state of the room (e.g. room topic,
room membership etc). State is keyed by a tuple of event <tt class="docutils literal">type</tt> and a
<tt class="docutils literal">state_key</tt>. State in the room with the same key-tuple will be overwritten.</td>
</tr>
<tr class="field"><th class="field-name">Message events:</th><td class="field-body">These are events which describe transient &quot;once-off&quot; activity in a room:
typically communication such as sending an instant message or setting up a
VoIP call.</td>
</tr>
</tbody>
</table>
<p>This specification outlines several events, all with the event type prefix
<tt class="docutils literal">m.</tt>. (See <a class="reference internal" href="#room-events">Room Events</a> for the m. event specification.) However,
applications may wish to add their own type of event, and this can be achieved
using the REST API detailed in the following sections. If new events are added,
the event <tt class="docutils literal">type</tt> key SHOULD follow the Java package naming convention,
e.g. <tt class="docutils literal">com.example.myapp.event</tt>.  This ensures event types are suitably
namespaced for each application and reduces the risk of clashes.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Events are not limited to the types defined in this specification. New or custom
event types can be created on a whim using the Java package naming convention.
For example, a <tt class="docutils literal">com.example.game.score</tt> event can be sent by clients and other
clients would receive it through Matrix, assuming the client has access to the
<tt class="docutils literal">com.example</tt> namespace.</p>
</div>
<p>Note that the structure of these events may be different than those in the
server-server API.</p>
<p><a class="anchor" id="event-fields"></a></p>
<div class="section" id="event-fields">
<h3><a class="toc-backref" href="#id278">9.1.1&nbsp;&nbsp;&nbsp;Event Fields</a></h3>
<p>The basic set of fields all events must have.</p>
<table border="1" class="colwidths-auto docutils">
<caption>Event</caption>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
</tbody>
</table>
</div>
<p><a class="anchor" id="room-event-fields"></a></p>
<div class="section" id="room-event-fields">
<h3><a class="toc-backref" href="#id279">9.1.2&nbsp;&nbsp;&nbsp;Room Event Fields</a></h3>
<p>Room Events have the following fields.</p>
<table border="1" class="colwidths-auto docutils">
<caption>Room Event</caption>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<!-- This is normally where we'd put the common_state_event_fields variable for the -->
<!-- magic table of what makes up a state event, however the table is verbose in our -->
<!-- custom rendering of swagger. To combat this, we just hardcode this particular -->
<!-- table. -->
</div>
<p><a class="anchor" id="state-event-fields"></a></p>
<div class="section" id="state-event-fields">
<h3><a class="toc-backref" href="#id280">9.1.3&nbsp;&nbsp;&nbsp;State Event Fields</a></h3>
<p>In addition to the fields of a Room Event, State Events have the following fields.</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="16%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> A unique key which defines the overwriting
semantics for this piece of room state. This value is often
a zero-length string. The presence of this key makes this
event a State Event. State keys starting with an <tt class="docutils literal">&#64;</tt> are
reserved for referencing user IDs, such as room members.
With the exception of a few events, state events set with
a given user's ID as the state key MUST only be set by that
user.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event. If there
is no previous content, this key will be missing.</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><a class="anchor" id="size-limits"></a></p>
<div class="section" id="size-limits">
<h2><a class="toc-backref" href="#id281">9.2&nbsp;&nbsp;&nbsp;Size limits</a></h2>
<p>The complete event MUST NOT be larger than 65535 bytes, when formatted as a
<a class="reference external" href="../server_server/r0.1.2#pdus">PDU for the Server-Server protocol</a>,
including any signatures, and encoded as <a class="reference external" href="../appendices.html#canonical-json">Canonical JSON</a>.</p>
<p>There are additional restrictions on sizes per key:</p>
<ul class="simple">
<li><tt class="docutils literal">sender</tt> MUST NOT exceed 255 bytes (including domain).</li>
<li><tt class="docutils literal">room_id</tt> MUST NOT exceed 255 bytes.</li>
<li><tt class="docutils literal">state_key</tt> MUST NOT exceed 255 bytes.</li>
<li><tt class="docutils literal">type</tt> MUST NOT exceed 255 bytes.</li>
<li><tt class="docutils literal">event_id</tt> MUST NOT exceed 255 bytes.</li>
</ul>
<p>Some event types have additional size restrictions which are specified in
the description of the event. Additional keys have no limit other than that
implied by the total 65 KB limit on events.</p>
</div>
<p><a class="anchor" id="room-events"></a></p>
<div class="section" id="room-events">
<h2><a class="toc-backref" href="#id282">9.3&nbsp;&nbsp;&nbsp;Room Events</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section is a work in progress.</p>
</div>
<p>This specification outlines several standard event types, all of which are
prefixed with <tt class="docutils literal">m.</tt></p>
<p><a class="anchor" id="m-room-aliases"></a></p>
<div class="section" id="m-room-aliases">
<h3><a class="toc-backref" href="#id283">9.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.aliases</tt></a></h3>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: The homeserver domain which owns these room aliases.</dd>
</dl>
<p>This event is sent by a homeserver directly to inform of changes to the list of aliases it knows about for that room. The <tt class="docutils literal">state_key</tt> for this event is set to the homeserver which owns the room alias. The entire set of known aliases for the room is the union of all the <tt class="docutils literal">m.room.aliases</tt> events, one for each homeserver. Clients <strong>should</strong> check the validity of any room alias given in this list before presenting it to the user as trusted fact. The lists given by this event should be considered simply as advice on which aliases might exist, for which the client can perform the lookup to confirm whether it receives the correct room ID.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>aliases</td>
<td>[string]</td>
<td><strong>Required.</strong> A list of room aliases.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;#somewhere:example.org&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;#another:example.org&quot;</span>
        <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.aliases&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-canonical-alias"></a></p>
<div class="section" id="m-room-canonical-alias">
<h3><a class="toc-backref" href="#id284">9.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.canonical_alias</tt></a></h3>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This event is used to inform the room about which alias should be
considered the canonical one. This could be for display purposes or as
suggestion to users which alias to use to advertise the room.</p>
<p>A room with an <tt class="docutils literal">m.room.canonical_alias</tt> event with an absent, null, or
empty <tt class="docutils literal">alias</tt> field should be treated the same as a room with no
<tt class="docutils literal">m.room.canonical_alias</tt> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>alias</td>
<td>string</td>
<td><strong>Required.</strong> The canonical alias.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#somewhere:localhost&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.canonical_alias&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-create"></a></p>
<div class="section" id="m-room-create">
<h3><a class="toc-backref" href="#id285">9.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.create</tt></a></h3>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This is the first event in a room and cannot be changed. It acts as the root of all other events.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>creator</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">user_id</tt> of the room creator.
This is set by the homeserver.</td>
</tr>
<tr><td>m.federate</td>
<td>boolean</td>
<td>Whether users on other servers can join this room.
Defaults to <tt class="docutils literal">true</tt> if key does not exist.</td>
</tr>
<tr><td>room_version</td>
<td>string</td>
<td>The version of the room. Defaults to <tt class="docutils literal">&quot;1&quot;</tt> if
the key does not exist.</td>
</tr>
<tr><td>predecessor</td>
<td>Previous Room</td>
<td>A reference to the room this room replaces, if the
previous room was upgraded.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Previous Room</caption>
<thead valign="bottom">
<tr><th class="head">Previous Room Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the old room.</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The event ID of the last known event
in the old room.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;creator&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;m.federate&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;predecessor&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$something:example.org&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!oldroom:example.org&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;room_version&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.create&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-join-rules"></a></p>
<div class="section" id="m-room-join-rules">
<h3><a class="toc-backref" href="#id286">9.3.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.join_rules</tt></a></h3>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>A room may be <tt class="docutils literal">public</tt> meaning anyone can join the room without any prior action. Alternatively, it can be <tt class="docutils literal">invite</tt> meaning that a user who wishes to join the room must first receive an invite to the room from someone already inside of the room. Currently, <tt class="docutils literal">knock</tt> and <tt class="docutils literal">private</tt> are reserved keywords which are not implemented.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>join_rule</td>
<td>enum</td>
<td><strong>Required.</strong> The type of rules used for users
wishing to join this room. One of: [&quot;public&quot;,
&quot;knock&quot;, &quot;invite&quot;, &quot;private&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;join_rule&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.join_rules&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-member"></a></p>
<div class="section" id="m-room-member">
<h3><a class="toc-backref" href="#id287">9.3.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.member</tt></a></h3>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: The <tt class="docutils literal">user_id</tt> this membership event relates to. In all cases except for when <tt class="docutils literal">membership</tt> is
<tt class="docutils literal">join</tt>, the user ID sending the event does not need to match the user ID in the <tt class="docutils literal">state_key</tt>,
unlike other events. Regular authorisation rules still apply.</dd>
</dl>
<p>Adjusts the membership state for a user in a room. It is preferable to use the membership APIs (<tt class="docutils literal"><span class="pre">/rooms/&lt;room</span> <span class="pre">id&gt;/invite</span></tt> etc) when performing membership actions rather than adjusting the state directly as there are a restricted set of valid transformations. For example, user A cannot force user B to join a room, and trying to force this state change directly will fail.</p>
<p>The following membership states are specified:</p>
<ul class="simple">
<li><tt class="docutils literal">invite</tt> - The user has been invited to join a room, but has not yet joined it. They may not participate in the room until they join.</li>
<li><tt class="docutils literal">join</tt> - The user has joined the room (possibly after accepting an invite), and may participate in it.</li>
<li><tt class="docutils literal">leave</tt> - The user was once joined to the room, but has since left (possibly by choice, or possibly by being kicked).</li>
<li><tt class="docutils literal">ban</tt> - The user has been banned from the room, and is no longer allowed to join it until they are un-banned from the room (by having their membership state set to a value other than <tt class="docutils literal">ban</tt>).</li>
<li><tt class="docutils literal">knock</tt> - This is a reserved word, which currently has no meaning.</li>
</ul>
<p>The <tt class="docutils literal">third_party_invite</tt> property will be set if this invite is an <tt class="docutils literal">invite</tt> event and is the successor of an <tt class="docutils literal">m.room.third_party_invite</tt> event, and absent otherwise.</p>
<p>This event may also include an <tt class="docutils literal">invite_room_state</tt> key inside the event's <tt class="docutils literal">unsigned</tt> data.
If present, this contains an array of <tt class="docutils literal">StrippedState</tt> Events. These events provide information
on a subset of state events such as the room name.</p>
<p>The user for which a membership applies is represented by the <tt class="docutils literal">state_key</tt>. Under some conditions,
the <tt class="docutils literal">sender</tt> and <tt class="docutils literal">state_key</tt> may not match - this may be interpreted as the <tt class="docutils literal">sender</tt> affecting
the membership state of the <tt class="docutils literal">state_key</tt> user.</p>
<p>The <tt class="docutils literal">membership</tt> for a given user can change over time. The table below represents the various changes
over time and how clients and servers must interpret those changes. Previous membership can be retrieved
from the <tt class="docutils literal">prev_content</tt> object on an event. If not present, the user's previous membership must be assumed
as <tt class="docutils literal">leave</tt>.</p>
<!-- TODO: Improve how this table is written? We use a csv-table to get around vertical header restrictions. -->
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head stub">&nbsp;</th>
<th class="head">to <tt class="docutils literal">invite</tt></th>
<th class="head">to <tt class="docutils literal">join</tt></th>
<th class="head">to <tt class="docutils literal">leave</tt></th>
<th class="head">to <tt class="docutils literal">ban</tt></th>
<th class="head">to <tt class="docutils literal">knock</tt></th>
</tr>
</thead>
<tbody valign="top">
<tr><th class="stub">from <tt class="docutils literal">invite</tt></th>
<td>No change.</td>
<td>User joined the room.</td>
<td>If the <tt class="docutils literal">state_key</tt> is the same as the <tt class="docutils literal">sender</tt>, the user rejected the invite. Otherwise, the <tt class="docutils literal">state_key</tt> user had their invite revoked.</td>
<td>User was banned.</td>
<td>Not implemented.</td>
</tr>
<tr><th class="stub">from <tt class="docutils literal">join</tt></th>
<td>Must never happen.</td>
<td><tt class="docutils literal">displayname</tt> or <tt class="docutils literal">avatar_url</tt> changed.</td>
<td>If the <tt class="docutils literal">state_key</tt> is the same as the <tt class="docutils literal">sender</tt>, the user left. Otherwise, the <tt class="docutils literal">state_key</tt> user was kicked.</td>
<td>User was kicked and banned.</td>
<td>Not implemented.</td>
</tr>
<tr><th class="stub">from <tt class="docutils literal">leave</tt></th>
<td>New invitation sent.</td>
<td>User joined.</td>
<td>No change.</td>
<td>User was banned.</td>
<td>Not implemented.</td>
</tr>
<tr><th class="stub">from <tt class="docutils literal">ban</tt></th>
<td>Must never happen.</td>
<td>Must never happen.</td>
<td>User was unbanned.</td>
<td>No change.</td>
<td>Not implemented.</td>
</tr>
<tr><th class="stub">from <tt class="docutils literal">knock</tt></th>
<td>Not implemented.</td>
<td>Not implemented.</td>
<td>Not implemented.</td>
<td>Not implemented.</td>
<td>Not implemented.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>EventContent</caption>
<thead valign="bottom">
<tr><th class="head">EventContent Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The avatar URL for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>displayname</td>
<td>string or null</td>
<td>The display name for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>membership</td>
<td>enum</td>
<td><strong>Required.</strong> The membership state of the user.
One of: [&quot;invite&quot;, &quot;join&quot;, &quot;knock&quot;, &quot;leave&quot;,
&quot;ban&quot;]</td>
</tr>
<tr><td>is_direct</td>
<td>boolean</td>
<td>Flag indicating if the room containing this event
was created with the intention of being a direct
chat. See <a class="reference internal" href="#module-dm">Direct Messaging</a>.</td>
</tr>
<tr><td>third_party_invite</td>
<td>Invite</td>
<td>&nbsp;</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Invite</caption>
<thead valign="bottom">
<tr><th class="head">Invite Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>display_name</td>
<td>string</td>
<td><strong>Required.</strong> A name which can be displayed to
represent the user instead of their third party
identifier</td>
</tr>
<tr><td>signed</td>
<td>signed</td>
<td><strong>Required.</strong> A block of content which has been
signed, which servers can use to verify the event.
Clients should ignore this.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>signed</caption>
<thead valign="bottom">
<tr><th class="head">signed Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The invited matrix user ID. Must be
equal to the user_id property of the event.</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><strong>Required.</strong> A single signature from the
verifying server, in the format specified by the
Signing Events section of the server-server API.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token property of the containing
third_party_invite object.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">UnsignedData Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>invite_room_state</td>
<td>[StrippedState]</td>
<td>A subset of the state of the room at the time of
the invite, if <tt class="docutils literal">membership</tt> is <tt class="docutils literal">invite</tt>. Note
that this state is informational, and SHOULD NOT
be trusted; once the client has joined the room,
it SHOULD fetch the live state from the server and
discard the invite_room_state. Also, clients must
not rely on any particular state being present
here; they SHOULD behave properly (with possibly a
degraded but not a broken experience) in the
absence of any particular events here. If they are
set on the room, at least the state for
<tt class="docutils literal">m.room.avatar</tt>, <tt class="docutils literal">m.room.canonical_alias</tt>,
<tt class="docutils literal">m.room.join_rules</tt>, and <tt class="docutils literal">m.room.name</tt> SHOULD
be included.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StrippedState</caption>
<thead valign="bottom">
<tr><th class="head">StrippedState Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>EventContent</td>
<td><strong>Required.</strong> The <tt class="docutils literal">content</tt> for the event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">state_key</tt> for the event.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">type</tt> for the event.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">sender</tt> for the event.</td>
</tr>
</tbody>
</table>
<p>Examples:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span><span class="punctuation">,</span>
        <span class="name tag">&quot;invite_room_state&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
                <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                    <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Example Room&quot;</span>
                <span class="punctuation">},</span>
                <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.org&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.name&quot;</span>
            <span class="punctuation">},</span>
            <span class="punctuation">{</span>
                <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                    <span class="name tag">&quot;join_rule&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span>
                <span class="punctuation">},</span>
                <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.org&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.join_rules&quot;</span>
            <span class="punctuation">}</span>
        <span class="punctuation">]</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;third_party_invite&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;alice&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;signed&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                    <span class="name tag">&quot;magic.forest&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                        <span class="name tag">&quot;ed25519:3&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg&quot;</span>
                    <span class="punctuation">}</span>
                <span class="punctuation">},</span>
                <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123&quot;</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-power-levels"></a></p>
<div class="section" id="m-room-power-levels">
<h3><a class="toc-backref" href="#id288">9.3.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.power_levels</tt></a></h3>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This event specifies the minimum level a user must have in order to perform a
certain action. It also specifies the levels of each user in the room.</p>
<p>If a <tt class="docutils literal">user_id</tt> is in the <tt class="docutils literal">users</tt> list, then that <tt class="docutils literal">user_id</tt> has the
associated power level. Otherwise they have the default level
<tt class="docutils literal">users_default</tt>. If <tt class="docutils literal">users_default</tt> is not supplied, it is assumed to be
0. If the room contains no <tt class="docutils literal">m.room.power_levels</tt> event, the room's creator has
a power level of 100, and all other users have a power level of 0.</p>
<p>The level required to send a certain event is governed by <tt class="docutils literal">events</tt>,
<tt class="docutils literal">state_default</tt> and <tt class="docutils literal">events_default</tt>. If an event type is specified in
<tt class="docutils literal">events</tt>, then the user must have at least the level specified in order to
send that event. If the event type is not supplied, it defaults to
<tt class="docutils literal">events_default</tt> for Message Events and <tt class="docutils literal">state_default</tt> for State
Events.</p>
<p>If there is no <tt class="docutils literal">state_default</tt> in the <tt class="docutils literal">m.room.power_levels</tt> event, the
<tt class="docutils literal">state_default</tt> is 50. If there is no <tt class="docutils literal">events_default</tt> in the
<tt class="docutils literal">m.room.power_levels</tt> event, the <tt class="docutils literal">events_default</tt> is 0. If the room
contains no <tt class="docutils literal">m.room.power_levels</tt> event, <em>both</em> the <tt class="docutils literal">state_default</tt> and
<tt class="docutils literal">events_default</tt> are 0.</p>
<p>The power level required to invite a user to the room, kick a user from the
room, ban a user from the room, or redact an event, is defined by <tt class="docutils literal">invite</tt>,
<tt class="docutils literal">kick</tt>, <tt class="docutils literal">ban</tt>, and <tt class="docutils literal">redact</tt>, respectively. Each of these levels defaults
to 50 if they are not specified in the <tt class="docutils literal">m.room.power_levels</tt> event, or if
the room contains no <tt class="docutils literal">m.room.power_levels</tt> event.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>As noted above, in the absence of an <tt class="docutils literal">m.room.power_levels</tt> event, the
<tt class="docutils literal">state_default</tt> is 0, and all users are considered to have power level 0.
That means that <strong>any</strong> member of the room can send an
<tt class="docutils literal">m.room.power_levels</tt> event, changing the permissions in the room.</p>
<p class="last">Server implementations should therefore ensure that each room has an
<tt class="docutils literal">m.room.power_levels</tt> event as soon as it is created. See also the
documentation of the <tt class="docutils literal">/createRoom</tt> API.</p>
</div>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>ban</td>
<td>integer</td>
<td>The level required to ban a user. Defaults to 50
if unspecified.</td>
</tr>
<tr><td>events</td>
<td>{string: integer}</td>
<td>The level required to send specific event types.
This is a mapping from event type to power level
required.</td>
</tr>
<tr><td>events_default</td>
<td>integer</td>
<td>The default level required to send message events.
Can be overridden by the <tt class="docutils literal">events</tt> key.  Defaults
to 0 if unspecified.</td>
</tr>
<tr><td>invite</td>
<td>integer</td>
<td>The level required to invite a user. Defaults to
50 if unspecified.</td>
</tr>
<tr><td>kick</td>
<td>integer</td>
<td>The level required to kick a user. Defaults to 50
if unspecified.</td>
</tr>
<tr><td>redact</td>
<td>integer</td>
<td>The level required to redact an event. Defaults to
50 if unspecified.</td>
</tr>
<tr><td>state_default</td>
<td>integer</td>
<td>The default level required to send state events.
Can be overridden by the <tt class="docutils literal">events</tt> key. Defaults
to 50 if unspecified.</td>
</tr>
<tr><td>users</td>
<td>{string: integer}</td>
<td>The power levels for specific users. This is a
mapping from <tt class="docutils literal">user_id</tt> to power level for that
user.</td>
</tr>
<tr><td>users_default</td>
<td>integer</td>
<td>The default power level for every user in the
room, unless their <tt class="docutils literal">user_id</tt> is mentioned in the
<tt class="docutils literal">users</tt> key. Defaults to 0 if unspecified.</td>
</tr>
<tr><td>notifications</td>
<td>Notifications</td>
<td>The power level requirements for specific
notification types. This is a mapping from <tt class="docutils literal">key</tt>
to power level for that notifications key.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Notifications</caption>
<thead valign="bottom">
<tr><th class="head">Notifications Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room</td>
<td>integer</td>
<td>The level required to trigger an <tt class="docutils literal">&#64;room</tt>
notification. Defaults to 50 if unspecified.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ban&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;m.room.name&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span><span class="punctuation">,</span>
            <span class="name tag">&quot;m.room.power_levels&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;events_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
        <span class="name tag">&quot;invite&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;kick&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;notifications&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;room&quot;</span><span class="punctuation">:</span> <span class="literal number integer">20</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;redact&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;state_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;&#64;example:localhost&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;users_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.power_levels&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-redaction"></a></p>
<div class="section" id="m-room-redaction">
<h3><a class="toc-backref" href="#id289">9.3.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.redaction</tt></a></h3>
<p><em>Message Event</em></p>
<p>Events can be redacted by either room or server admins. Redacting an event means that all keys not required by the protocol are stripped off, allowing admins to remove offensive or illegal content that may have been attached to any event. This cannot be undone, allowing server owners to physically delete the offending data.  There is also a concept of a moderator hiding a message event, which can be undone, but cannot be applied to state events. The event that has been redacted is specified in the <tt class="docutils literal">redacts</tt> event level key.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>reason</td>
<td>string</td>
<td>The reason for the redaction, if any.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Spamming&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;redacts&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$fukweghifu23:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.redaction&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="syncing"></a></p>
<div class="section" id="syncing">
<h2><a class="toc-backref" href="#id290">9.4&nbsp;&nbsp;&nbsp;Syncing</a></h2>
<p>To read events, the intended flow of operation is for clients to first call the
<a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a> API without a <tt class="docutils literal">since</tt> parameter. This returns the most recent
message events for each room, as well as the state of the room at the start of
the returned timeline. The response also includes a <tt class="docutils literal">next_batch</tt> field, which
should be used as the value of the <tt class="docutils literal">since</tt> parameter in the next call to
<tt class="docutils literal">/sync</tt>. Finally, the response includes, for each room, a <tt class="docutils literal">prev_batch</tt>
field, which can be passed as a <tt class="docutils literal">start</tt> parameter to the
<a class="reference external" href="#get-matrix-client-r0-rooms-roomid-messages"><tt class="docutils literal"><span class="pre">/rooms/&lt;room_id&gt;/messages</span></tt></a> API to retrieve earlier messages.</p>
<p>You can visualise the range of events being returned as:</p>
<pre class="literal-block">
[E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]
           ^                      ^
           |                      |
     prev_batch: '1-2-3'        next_batch: 'a-b-c'
</pre>
<p>Clients then receive new events by &quot;long-polling&quot; the homeserver via the
<tt class="docutils literal">/sync</tt> API, passing the value of the <tt class="docutils literal">next_batch</tt> field from the response
to the previous call as the <tt class="docutils literal">since</tt> parameter. The client should also pass a
<tt class="docutils literal">timeout</tt> parameter. The server will then hold open the HTTP connection for a
short period of time waiting for new events, returning early if an event
occurs. Only the <tt class="docutils literal">/sync</tt> API (and the deprecated <tt class="docutils literal">/events</tt> API) support
long-polling in this way.</p>
<p>The response for such an incremental sync can be visualised as:</p>
<pre class="literal-block">
[E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]-&gt;[E6]
                                  ^     ^
                                  |     |
                                  |  next_batch: 'x-y-z'
                                prev_batch: 'a-b-c'
</pre>
<p>Normally, all new events which are visible to the client will appear in the
response to the <tt class="docutils literal">/sync</tt> API. However, if a large number of events arrive
between calls to <tt class="docutils literal">/sync</tt>, a &quot;limited&quot; timeline is returned, containing only
the most recent message events. A state &quot;delta&quot; is also returned, summarising
any state changes in the omitted part of the timeline. The client may therefore
end up with &quot;gaps&quot; in its knowledge of the message timeline. The client can
fill these gaps using the <a class="reference external" href="#get-matrix-client-r0-rooms-roomid-messages"><tt class="docutils literal"><span class="pre">/rooms/&lt;room_id&gt;/messages</span></tt></a> API. This situation
looks like this:</p>
<pre class="literal-block">
                                  | gap |
                                  | &lt;-&gt; |
[E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]-&gt;[E6]-&gt;[E7]-&gt;[E8]-&gt;[E9]-&gt;[E10]
                                        ^                        ^
                                        |                        |
                                   prev_batch: 'd-e-f'       next_batch: 'u-v-w'
</pre>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Events are ordered in this API according to the arrival time of the event on
the homeserver. This can conflict with other APIs which order events based on
their partial ordering in the event graph. This can result in duplicate events
being received (once per distinct API called). Clients SHOULD de-duplicate
events based on the event ID when this happens.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The <tt class="docutils literal">/sync</tt> API returns a <tt class="docutils literal">state</tt> list which is separate from the
<tt class="docutils literal">timeline</tt>. This <tt class="docutils literal">state</tt> list allows clients to keep their model of the
room state in sync with that on the server. In the case of an initial
(<tt class="docutils literal">since</tt>-less) sync, the <tt class="docutils literal">state</tt> list represents the complete state of
the room at the <strong>start</strong> of the returned timeline (so in the case of a
recently-created room whose state fits entirely in the <tt class="docutils literal">timeline</tt>, the
<tt class="docutils literal">state</tt> list will be empty).</p>
<p>In the case of an incremental sync, the <tt class="docutils literal">state</tt> list gives a delta
between the state of the room at the <tt class="docutils literal">since</tt> parameter and that at the
start of the returned <tt class="docutils literal">timeline</tt>. (It will therefore be empty
unless the timeline was <tt class="docutils literal">limited</tt>.)</p>
<p class="last">In both cases, it should be noted that the events returned in the <tt class="docutils literal">state</tt>
list did <strong>not</strong> necessarily take place just before the returned
<tt class="docutils literal">timeline</tt>, so clients should not display them to the user in the timeline.</p>
</div>
<div class="admonition admonition-rationale">
<p class="first admonition-title">Rationale</p>
<p>An early design of this specification made the <tt class="docutils literal">state</tt> list represent the
room state at the end of the returned timeline, instead of the start. This
was unsatisfactory because it led to duplication of events between the
<tt class="docutils literal">state</tt> list and the <tt class="docutils literal">timeline</tt>, but more importantly, it made it
difficult for clients to show the timeline correctly.</p>
<p class="last">In particular, consider a returned timeline [M0, S1, M2], where M0 and M2 are
both messages sent by the same user, and S1 is a state event where that user
changes their displayname. If the <tt class="docutils literal">state</tt> list represents the room state at
the end of the timeline, the client must take a copy of the state dictionary,
and <em>rewind</em> S1, in order to correctly calculate the display name for M0.</p>
</div>
<!-- TODO-spec
Do we ever support streaming requests? Why not websockets? -->
<p><a class="anchor" id="get-matrix-client-r0-sync"></a></p>
<div class="section" id="get-matrix-client-r0-sync">
<h3><a class="toc-backref" href="#id291">9.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/sync</tt></a></h3>
<p>Synchronise the client's state with the latest state on the server.
Clients use this API when they first log in to get an initial snapshot
of the state on the server, and then continue to call this API to get
incremental deltas to the state, and to receive new messages.</p>
<p><em>Note</em>: This endpoint supports lazy-loading. See <a class="reference external" href="#filtering">Filtering</a>
for more information. Lazy-loading members is only supported on a <tt class="docutils literal">StateFilter</tt>
for this endpoint. When lazy-loading is enabled, servers MUST include the
syncing user's own membership event when they join a room, or when the
full state of rooms is requested, to aid discovering the user's avatar &amp;
displayname.</p>
<p>Like other members, the user's own membership event is eligible
for being considered redundant by the server. When a sync is <tt class="docutils literal">limited</tt>,
the server MUST return membership events for events in the gap
(between <tt class="docutils literal">since</tt> and the start of the returned timeline), regardless
as to whether or not they are redundant.  This ensures that joins/leaves
and profile changes which occur during the gap are not lost.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>filter</td>
<td>string</td>
<td><p class="first">The ID of a filter created using the filter API or
a filter JSON object encoded as a string. The
server will detect whether it is an ID or a JSON
object by whether the first character is a <tt class="docutils literal">&quot;{&quot;</tt>
open brace. Passing the JSON inline is best suited
to one off requests. Creating a filter using the
filter API is recommended for clients that reuse
the same filter multiple times, for example in
long poll requests.</p>
<p class="last">See <a class="reference external" href="#filtering">Filtering</a> for more
information.</p>
</td>
</tr>
<tr><td>since</td>
<td>string</td>
<td>A point in time to continue a sync from.</td>
</tr>
<tr><td>full_state</td>
<td>boolean</td>
<td><p class="first">Controls whether to include the full state for all
rooms the user is a member of.</p>
<p>If this is set to <tt class="docutils literal">true</tt>, then all state events
will be returned, even if <tt class="docutils literal">since</tt> is non-empty.
The timeline will still be limited by the
<tt class="docutils literal">since</tt> parameter. In this case, the <tt class="docutils literal">timeout</tt>
parameter will be ignored and the query will
return immediately, possibly with an empty
timeline.</p>
<p>If <tt class="docutils literal">false</tt>, and <tt class="docutils literal">since</tt> is non-empty, only
state which has changed since the point indicated
by <tt class="docutils literal">since</tt> will be returned.</p>
<p class="last">By default, this is <tt class="docutils literal">false</tt>.</p>
</td>
</tr>
<tr><td>set_presence</td>
<td>enum</td>
<td>Controls whether the client is automatically
marked as online by polling this API. If this
parameter is omitted then the client is
automatically marked as online when it uses this
API. Otherwise if the parameter is set to
&quot;offline&quot; then the client is not marked as being
online when it uses this API. When set to
&quot;unavailable&quot;, the client is marked as being idle.
One of: [&quot;offline&quot;, &quot;online&quot;, &quot;unavailable&quot;]</td>
</tr>
<tr><td>timeout</td>
<td>integer</td>
<td><p class="first">The maximum time to wait, in milliseconds, before
returning this request. If no events (or other
data) become available before this time elapses,
the server will return a response with empty
fields.</p>
<p class="last">By default, this is <tt class="docutils literal">0</tt>, so the server will
return immediately even if the response is empty.</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>next_batch</td>
<td>string</td>
<td><strong>Required.</strong> The batch token to supply in the
<tt class="docutils literal">since</tt> param of the next <tt class="docutils literal">/sync</tt> request.</td>
</tr>
<tr><td>rooms</td>
<td>Rooms</td>
<td>Updates to rooms.</td>
</tr>
<tr><td>presence</td>
<td>Presence</td>
<td>The updates to the presence status of other users.</td>
</tr>
<tr><td>account_data</td>
<td>Account Data</td>
<td>The global private data created by this user.</td>
</tr>
<tr><td>to_device</td>
<td>ToDevice</td>
<td>Information on the send-to-device messages for the
client device, as defined in
<a class="reference internal" href="#send-to-device-sync">Send-to-Device messaging</a>.</td>
</tr>
<tr><td>device_lists</td>
<td>DeviceLists</td>
<td>Information on end-to-end device updates, as
specified in <a class="reference internal" href="#device-lists-sync">End-to-end encryption</a>.</td>
</tr>
<tr><td>device_one_time_keys_count</td>
<td>{string: integer}</td>
<td>Information on end-to-end encryption keys, as
specified in <a class="reference internal" href="#device-lists-sync">End-to-end encryption</a>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Rooms</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>join</td>
<td>{string: Joined Room}</td>
<td>The rooms that the user has joined.</td>
</tr>
<tr><td>invite</td>
<td>{string: Invited Room}</td>
<td>The rooms that the user has been invited to.</td>
</tr>
<tr><td>leave</td>
<td>{string: Left Room}</td>
<td>The rooms that the user has left or been banned
from.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Joined Room</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>summary</td>
<td>RoomSummary</td>
<td>Information about the room which clients may need
to correctly render it to users.</td>
</tr>
<tr><td>state</td>
<td>State</td>
<td><p class="first">Updates to the state, between the time indicated
by the <tt class="docutils literal">since</tt> parameter, and the start of the
<tt class="docutils literal">timeline</tt> (or all state up to the start of the
<tt class="docutils literal">timeline</tt>, if <tt class="docutils literal">since</tt> is not given, or
<tt class="docutils literal">full_state</tt> is true).</p>
<p class="last">N.B. state updates for <tt class="docutils literal">m.room.member</tt> events
will be incomplete if <tt class="docutils literal">lazy_load_members</tt> is
enabled in the <tt class="docutils literal">/sync</tt> filter, and only return
the member events required to display the senders
of the timeline events in this response.</p>
</td>
</tr>
<tr><td>timeline</td>
<td>Timeline</td>
<td>The timeline of messages and state changes in the
room.</td>
</tr>
<tr><td>ephemeral</td>
<td>Ephemeral</td>
<td>The ephemeral events in the room that aren't
recorded in the timeline or state of the room.
e.g. typing.</td>
</tr>
<tr><td>account_data</td>
<td>Account Data</td>
<td>The private data that this user has attached to
this room.</td>
</tr>
<tr><td>unread_notifications</td>
<td>Unread Notification Counts</td>
<td>Counts of unread notifications for this room. See
the <a class="reference external" href="#receiving-notifications">Receiving notifications section</a> for more information on how these
are calculated.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomSummary</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>m.heroes</td>
<td>[string]</td>
<td><p class="first">The users which can be used to generate a room
name if the room does not have one. Required if
the room's <tt class="docutils literal">m.room.name</tt> or
<tt class="docutils literal">m.room.canonical_alias</tt> state events are unset
or empty.</p>
<p>This should be the first 5 members of the room,
ordered by stream ordering, which are joined or
invited. The list must never include the client's
own user ID. When no joined or invited members are
available, this should consist of the banned and
left users. More than 5 members may be provided,
however less than 5 should only be provided when
there are less than 5 members to represent.</p>
<p class="last">When lazy-loading room members is enabled, the
membership events for the heroes MUST be included
in the <tt class="docutils literal">state</tt>, unless they are redundant. When
the list of users changes, the server notifies the
client by sending a fresh list of heroes. If there
are no changes since the last sync, this field may
be omitted.</p>
</td>
</tr>
<tr><td>m.joined_member_count</td>
<td>integer</td>
<td>The number of users with <tt class="docutils literal">membership</tt> of
<tt class="docutils literal">join</tt>, including the client's own user ID. If
this field has not changed since the last sync, it
may be omitted. Required otherwise.</td>
</tr>
<tr><td>m.invited_member_count</td>
<td>integer</td>
<td>The number of users with <tt class="docutils literal">membership</tt> of
<tt class="docutils literal">invite</tt>. If this field has not changed since
the last sync, it may be omitted. Required
otherwise.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Ephemeral</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[Event]</td>
<td>List of events.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Unread Notification Counts</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>highlight_count</td>
<td>integer</td>
<td>The number of unread notifications for this room
with the highlight flag set</td>
</tr>
<tr><td>notification_count</td>
<td>integer</td>
<td>The total number of unread notifications for this
room</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Invited Room</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>invite_state</td>
<td>InviteState</td>
<td>The state of a room that the user has been invited
to. These state events may only have the
<tt class="docutils literal">sender</tt>, <tt class="docutils literal">type</tt>, <tt class="docutils literal">state_key</tt> and
<tt class="docutils literal">content</tt> keys present. These events do not
replace any state that the client already has for
the room, for example if the client has archived
the room. Instead the client should keep two
separate copies of the state: the one from the
<tt class="docutils literal">invite_state</tt> and one from the archived
<tt class="docutils literal">state</tt>. If the client joins the room then the
current state will be given as a delta against the
archived <tt class="docutils literal">state</tt> not the <tt class="docutils literal">invite_state</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>InviteState</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[StrippedState]</td>
<td>The StrippedState events that form the invite
state.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StrippedState</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>EventContent</td>
<td><strong>Required.</strong> The <tt class="docutils literal">content</tt> for the event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">state_key</tt> for the event.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">type</tt> for the event.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">sender</tt> for the event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Left Room</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>state</td>
<td>State</td>
<td>The state updates for the room up to the start of
the timeline.</td>
</tr>
<tr><td>timeline</td>
<td>Timeline</td>
<td>The timeline of messages and state changes in the
room up to the point when the user left.</td>
</tr>
<tr><td>account_data</td>
<td>Account Data</td>
<td>The private data that this user has attached to
this room.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>State</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[State Event]</td>
<td>List of events.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>State Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> A unique key which defines the
overwriting semantics for this piece of room
state. This value is often a zero-length string.
The presence of this key makes this event a State
Event. State keys starting with an <tt class="docutils literal">&#64;</tt> are
reserved for referencing user IDs, such as room
members. With the exception of a few events, state
events set with a given user's ID as the state key
MUST only be set by that user.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Timeline</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[Room Event]</td>
<td>List of events.</td>
</tr>
<tr><td>limited</td>
<td>boolean</td>
<td>True if the number of events returned was limited
by the <tt class="docutils literal">limit</tt> on the filter.</td>
</tr>
<tr><td>prev_batch</td>
<td>string</td>
<td>A token that can be supplied to the <tt class="docutils literal">from</tt>
parameter of the rooms/{roomId}/messages endpoint.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Room Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Presence</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[Event]</td>
<td>List of events.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Account Data</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[Event]</td>
<td>List of events.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/sync?filter=66696p746572&amp;since=s72594_4483_1934&amp;full_state=false&amp;set_presence=offline&amp;timeout=30000</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The initial snapshot or delta for the client to use to update their state.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;next_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s72595_4483_1934&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost:wefuiwegh8742w&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;last_active_ago&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2478593</span><span class="punctuation">,</span>
          <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;online&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;currently_active&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
          <span class="name tag">&quot;status_msg&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Making cupcakes&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.presence&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">]</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;account_data&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.example.custom.config&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;custom_config_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;custom_config_value&quot;</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">]</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;join&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;!726s6s6q:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;summary&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;m.heroes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;&#64;bob:example.com&quot;</span>
          <span class="punctuation">],</span>
          <span class="name tag">&quot;m.joined_member_count&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2</span><span class="punctuation">,</span>
          <span class="name tag">&quot;m.invited_member_count&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
              <span class="punctuation">},</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!726s6s6q:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
              <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
              <span class="punctuation">},</span>
              <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span>
            <span class="punctuation">}</span>
          <span class="punctuation">]</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;timeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
              <span class="punctuation">},</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!726s6s6q:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
              <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
              <span class="punctuation">},</span>
              <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span>
            <span class="punctuation">},</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
              <span class="punctuation">},</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!726s6s6q:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
              <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
              <span class="punctuation">}</span>
            <span class="punctuation">}</span>
          <span class="punctuation">],</span>
          <span class="name tag">&quot;limited&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
          <span class="name tag">&quot;prev_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t34-23535_0_0&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;ephemeral&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;user_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="literal string double">&quot;&#64;alice:matrix.org&quot;</span><span class="punctuation">,</span>
                  <span class="literal string double">&quot;&#64;bob:example.com&quot;</span>
                <span class="punctuation">]</span>
              <span class="punctuation">},</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.typing&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span>
            <span class="punctuation">}</span>
          <span class="punctuation">]</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;account_data&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                  <span class="name tag">&quot;u.work&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                    <span class="name tag">&quot;order&quot;</span><span class="punctuation">:</span> <span class="literal number float">0.9</span>
                  <span class="punctuation">}</span>
                <span class="punctuation">}</span>
              <span class="punctuation">},</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.tag&quot;</span>
            <span class="punctuation">},</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.example.custom.room.config&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;custom_config_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;custom_config_value&quot;</span>
              <span class="punctuation">}</span>
            <span class="punctuation">}</span>
          <span class="punctuation">]</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;invite&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;!696r7674:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;invite_state&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.name&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;My Room Name&quot;</span>
              <span class="punctuation">}</span>
            <span class="punctuation">},</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span>
              <span class="punctuation">}</span>
            <span class="punctuation">}</span>
          <span class="punctuation">]</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;leave&quot;</span><span class="punctuation">:</span> <span class="punctuation">{}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-events"></a></p>
<div class="section" id="get-matrix-client-r0-events">
<h3><a class="toc-backref" href="#id292">9.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/events</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>This will listen for new events and return them to the caller. This will
block until an event is received, or until the <tt class="docutils literal">timeout</tt> is reached.</p>
<p>This endpoint was deprecated in r0 of this specification. Clients
should instead call the <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a> API with a <tt class="docutils literal">since</tt> parameter. See
the <a class="reference external" href="https://matrix.org/docs/guides/client-server-migrating-from-v1.html#deprecated-endpoints">migration guide</a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>from</td>
<td>string</td>
<td>The token to stream from. This token is either
from a previous request to this API or from the
initial sync API.</td>
</tr>
<tr><td>timeout</td>
<td>integer</td>
<td>The maximum time in milliseconds to wait for an
event.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>start</td>
<td>string</td>
<td>A token which correlates to the first value in
<tt class="docutils literal">chunk</tt>. This is usually the same token supplied
to <tt class="docutils literal">from=</tt>.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>A token which correlates to the last value in
<tt class="docutils literal">chunk</tt>. This token should be used in the next
request to <tt class="docutils literal">/events</tt>.</td>
</tr>
<tr><td>chunk</td>
<td>[Event]</td>
<td>An array of events.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/events?from=s3456_9_0&amp;timeout=35000</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The events received, which may be none.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3456_9_0&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3457_9_0&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>Bad pagination <tt class="docutils literal">from</tt> parameter.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-initialsync"></a></p>
<div class="section" id="get-matrix-client-r0-initialsync">
<h3><a class="toc-backref" href="#id293">9.4.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/initialSync</tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>This returns the full state for this user, with an optional limit on the
number of messages per room to return.</p>
<p>This endpoint was deprecated in r0 of this specification. Clients
should instead call the <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a> API with no <tt class="docutils literal">since</tt> parameter. See
the <a class="reference external" href="https://matrix.org/docs/guides/client-server-migrating-from-v1.html#deprecated-endpoints">migration guide</a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of messages to return for each
room.</td>
</tr>
<tr><td>archived</td>
<td>boolean</td>
<td>Whether to include rooms that the user has left.
If <tt class="docutils literal">false</tt> then only rooms that the user has
been invited to or has joined are included. If set
to <tt class="docutils literal">true</tt> then rooms that the user has left are
included as well. By default this is <tt class="docutils literal">false</tt>.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>end</td>
<td>string</td>
<td><strong>Required.</strong> A token which correlates to the last
value in <tt class="docutils literal">chunk</tt>. This token should be used with
the <tt class="docutils literal">/events</tt> API to listen for new events.</td>
</tr>
<tr><td>presence</td>
<td>[Event]</td>
<td><strong>Required.</strong> A list of presence events.</td>
</tr>
<tr><td>rooms</td>
<td>[RoomInfo]</td>
<td><strong>Required.</strong></td>
</tr>
<tr><td>account_data</td>
<td>[Event]</td>
<td>The global private data created by this user.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomInfo</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of this room.</td>
</tr>
<tr><td>membership</td>
<td>enum</td>
<td><strong>Required.</strong> The user's membership state in this
room. One of: [&quot;invite&quot;, &quot;join&quot;, &quot;leave&quot;, &quot;ban&quot;]</td>
</tr>
<tr><td>invite</td>
<td>InviteEvent</td>
<td>The invite event if <tt class="docutils literal">membership</tt> is <tt class="docutils literal">invite</tt></td>
</tr>
<tr><td>messages</td>
<td>PaginationChunk</td>
<td>The pagination chunk for this room.</td>
</tr>
<tr><td>state</td>
<td>[StateEvent]</td>
<td>If the user is a member of the room this will be
the current state of the room as a list of events.
If the user has left the room this will be the
state of the room when they left it.</td>
</tr>
<tr><td>visibility</td>
<td>enum</td>
<td>Whether this room is visible to the
<tt class="docutils literal">/publicRooms</tt> API or not.&quot; One of: [&quot;private&quot;,
&quot;public&quot;]</td>
</tr>
<tr><td>account_data</td>
<td>[Event]</td>
<td>The private data that this user has attached to
this room.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>InviteEvent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>EventContent</td>
<td><strong>Required.</strong></td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.room.member'.</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">user_id</tt> this membership
event relates to. In all cases except for when
<tt class="docutils literal">membership</tt> is <tt class="docutils literal">join</tt>, the user ID sending
the event does not need to match the user ID in
the <tt class="docutils literal">state_key</tt>, unlike other events. Regular
authorisation rules still apply.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>EventContent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The avatar URL for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>displayname</td>
<td>string or null</td>
<td>The display name for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>membership</td>
<td>enum</td>
<td><strong>Required.</strong> The membership state of the user.
One of: [&quot;invite&quot;, &quot;join&quot;, &quot;knock&quot;, &quot;leave&quot;,
&quot;ban&quot;]</td>
</tr>
<tr><td>is_direct</td>
<td>boolean</td>
<td>Flag indicating if the room containing this event
was created with the intention of being a direct
chat. See <a class="reference internal" href="#module-dm">Direct Messaging</a>.</td>
</tr>
<tr><td>third_party_invite</td>
<td>Invite</td>
<td>&nbsp;</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Invite</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>display_name</td>
<td>string</td>
<td><strong>Required.</strong> A name which can be displayed to
represent the user instead of their third party
identifier</td>
</tr>
<tr><td>signed</td>
<td>signed</td>
<td><strong>Required.</strong> A block of content which has been
signed, which servers can use to verify the event.
Clients should ignore this.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>signed</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The invited matrix user ID. Must be
equal to the user_id property of the event.</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><strong>Required.</strong> A single signature from the
verifying server, in the format specified by the
Signing Events section of the server-server API.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token property of the containing
third_party_invite object.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StrippedState</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>EventContent</td>
<td><strong>Required.</strong> The <tt class="docutils literal">content</tt> for the event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">state_key</tt> for the event.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">type</tt> for the event.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">sender</tt> for the event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PaginationChunk</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>start</td>
<td>string</td>
<td><strong>Required.</strong> A token which correlates to the
first value in <tt class="docutils literal">chunk</tt>. Used for pagination.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td><strong>Required.</strong> A token which correlates to the last
value in <tt class="docutils literal">chunk</tt>. Used for pagination.</td>
</tr>
<tr><td>chunk</td>
<td>[RoomEvent]</td>
<td><strong>Required.</strong> If the user is a member of the room
this will be a list of the most recent messages
for this room. If the user has left the room this
will be the messages that preceeded them leaving.
This array will consist of at most <tt class="docutils literal">limit</tt>
elements.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomEvent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StateEvent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> A unique key which defines the
overwriting semantics for this piece of room
state. This value is often a zero-length string.
The presence of this key makes this event a State
Event. State keys starting with an <tt class="docutils literal">&#64;</tt> are
reserved for referencing user IDs, such as room
members. With the exception of a few events, state
events set with a given user's ID as the state key
MUST only be set by that user.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/initialSync?limit=2&amp;archived=true</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The user's current state.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3456_9_0&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost:wefuiwegh8742w&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;last_active_ago&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2478593</span><span class="punctuation">,</span>
        <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;online&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;currently_active&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
        <span class="name tag">&quot;status_msg&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Making cupcakes&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.presence&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;account_data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.example.custom.config&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;custom_config_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;custom_config_value&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;messages&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
            <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
            <span class="punctuation">}</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Gangnam Style&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/a526eYUSFFxlgbQYZmo442&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;thumbnail_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;thumbnail_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                  <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
                  <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span><span class="punctuation">,</span>
                  <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span><span class="punctuation">,</span>
                  <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span>
                <span class="punctuation">},</span>
                <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">480</span><span class="punctuation">,</span>
                <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">320</span><span class="punctuation">,</span>
                <span class="name tag">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2140786</span><span class="punctuation">,</span>
                <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1563685</span><span class="punctuation">,</span>
                <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;video/mp4&quot;</span>
              <span class="punctuation">},</span>
              <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.video&quot;</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
            <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
            <span class="punctuation">}</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3456_9_0&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t44-3453_9_0&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
          <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;join_rule&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span>
          <span class="punctuation">},</span>
          <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.join_rules&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
          <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
          <span class="punctuation">},</span>
          <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
          <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
          <span class="punctuation">},</span>
          <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
          <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
          <span class="punctuation">},</span>
          <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
          <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;creator&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;room_version&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;m.federate&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
            <span class="name tag">&quot;predecessor&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$something:example.org&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!oldroom:example.org&quot;</span>
            <span class="punctuation">}</span>
          <span class="punctuation">},</span>
          <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.create&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
          <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
          <span class="punctuation">},</span>
          <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
          <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ban&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
            <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;m.room.name&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span><span class="punctuation">,</span>
              <span class="name tag">&quot;m.room.power_levels&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;events_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
            <span class="name tag">&quot;invite&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kick&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
            <span class="name tag">&quot;redact&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
            <span class="name tag">&quot;state_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
            <span class="name tag">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;&#64;example:localhost&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;users_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
            <span class="name tag">&quot;notifications&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;room&quot;</span><span class="punctuation">:</span> <span class="literal number integer">20</span>
            <span class="punctuation">}</span>
          <span class="punctuation">},</span>
          <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.power_levels&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
          <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
          <span class="punctuation">},</span>
          <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
        <span class="punctuation">}</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;visibility&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;private&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;account_data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
          <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.tag&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;work&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;order&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
              <span class="punctuation">}</span>
            <span class="punctuation">}</span>
          <span class="punctuation">}</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
          <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.example.custom.room.config&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;custom_config_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;custom_config_value&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">}</span>
      <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>There is no avatar URL for this user or this user does not exist.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-events-eventid"></a></p>
<div class="section" id="get-matrix-client-r0-events-eventid">
<h3><a class="toc-backref" href="#id294">9.4.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/events/{eventId}</span></tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Get a single event based on <tt class="docutils literal">event_id</tt>. You must have permission to
retrieve this event e.g. by being a member in the room for this event.</p>
<p>This endpoint was deprecated in r0 of this specification. Clients
should instead call the <a class="reference external" href="#get-matrix-client-r0-rooms-roomid-event-eventid"><tt class="docutils literal"><span class="pre">/rooms/{roomId}/event/{eventId}</span></tt></a> API
or the <a class="reference external" href="#get-matrix-client-r0-rooms-roomid-context-eventid"><tt class="docutils literal"><span class="pre">/rooms/{roomId}/context/{eventId}</span></tt></a> API.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID to get.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/events/%24asfDuShaf7Gafaw%3Amatrix.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The full event.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
  <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The event was not found or you do not have permission to read this event.</p>
</div>
</div>
<p><a class="anchor" id="getting-events-for-a-room"></a></p>
<div class="section" id="getting-events-for-a-room">
<h2><a class="toc-backref" href="#id295">9.5&nbsp;&nbsp;&nbsp;Getting events for a room</a></h2>
<p>There are several APIs provided to <tt class="docutils literal">GET</tt> events for a room:</p>
<p><a class="anchor" id="get-matrix-client-r0-rooms-roomid-event-eventid"></a></p>
<div class="section" id="get-matrix-client-r0-rooms-roomid-event-eventid">
<h3><a class="toc-backref" href="#id296">9.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/event/{eventId}</span></tt></a></h3>
<p>Get a single event based on <tt class="docutils literal">roomId/eventId</tt>. You must have permission to
retrieve this event e.g. by being a member in the room for this event.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room the event is in.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID to get.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/rooms/%21636q39766251%3Amatrix.org/event/%24asfDuShaf7Gafaw%3Amatrix.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The full event.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
  <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The event was not found or you do not have permission to read this event.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-rooms-roomid-state-eventtype-statekey"></a></p>
<div class="section" id="get-matrix-client-r0-rooms-roomid-state-eventtype-statekey">
<h3><a class="toc-backref" href="#id297">9.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/state/{eventType}/{stateKey}</span></tt></a></h3>
<!-- For backwards compatibility with older links... -->
<p id="get-matrix-client-r0-rooms-roomid-state-eventtype">Looks up the contents of a state event in a room. If the user is
joined to the room then the state is taken from the current
state of the room. If the user has left the room then the state is
taken from the state of the room when they left.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to look up the state in.</td>
</tr>
<tr><td>eventType</td>
<td>string</td>
<td><strong>Required.</strong> The type of state to look up.</td>
</tr>
<tr><td>stateKey</td>
<td>string</td>
<td><strong>Required.</strong> The key of the state to look up.
Defaults to an empty string. When an empty string,
the trailing slash on this endpoint is optional.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/rooms/%21636q39766251%3Aexample.com/state/m.room.name/</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The content of the state event.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Example room name&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You aren't a member of the room and weren't previously a member of the room.</p>
<p><strong>Status code 404:</strong></p>
<p>The room has no state with the given type or key.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-rooms-roomid-state"></a></p>
<div class="section" id="get-matrix-client-r0-rooms-roomid-state">
<h3><a class="toc-backref" href="#id298">9.5.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/state</span></tt></a></h3>
<p>Get the state events for the current state of a room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to look up the state for.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>[StateEvent]</td>
<td>If the user is a member of the room this will be
the current state of the room as a list of events.
If the user has left the room then this will be
the state of the room when they left as a list of
events.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StateEvent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> A unique key which defines the
overwriting semantics for this piece of room
state. This value is often a zero-length string.
The presence of this key makes this event a State
Event. State keys starting with an <tt class="docutils literal">&#64;</tt> are
reserved for referencing user IDs, such as room
members. With the exception of a few events, state
events set with a given user's ID as the state key
MUST only be set by that user.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/rooms/%21636q39766251%3Aexample.com/state</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The current state of the room</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">[</span>
  <span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;join_rule&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.join_rules&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
  <span class="punctuation">},</span>
  <span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span>
  <span class="punctuation">},</span>
  <span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;creator&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_version&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;m.federate&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
      <span class="name tag">&quot;predecessor&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$something:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!oldroom:example.org&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.create&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
  <span class="punctuation">},</span>
  <span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;ban&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
      <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;m.room.name&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span><span class="punctuation">,</span>
        <span class="name tag">&quot;m.room.power_levels&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;events_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
      <span class="name tag">&quot;invite&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
      <span class="name tag">&quot;kick&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
      <span class="name tag">&quot;redact&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
      <span class="name tag">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;&#64;example:localhost&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;users_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
      <span class="name tag">&quot;notifications&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;room&quot;</span><span class="punctuation">:</span> <span class="literal number integer">20</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.power_levels&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">]</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You aren't a member of the room and weren't previously a member of the room.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-rooms-roomid-members"></a></p>
<div class="section" id="get-matrix-client-r0-rooms-roomid-members">
<h3><a class="toc-backref" href="#id299">9.5.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/members</span></tt></a></h3>
<p>Get the list of members for this room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to get the member events
for.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>at</td>
<td>string</td>
<td>The point in time (pagination token) to return
members for in the room. This token can be
obtained from a <tt class="docutils literal">prev_batch</tt> token returned for
each room by the sync API. Defaults to the current
state of the room, as determined by the server.</td>
</tr>
<tr><td>membership</td>
<td>enum</td>
<td>The kind of membership to filter for. Defaults to
no filtering if unspecified. When specified
alongside <tt class="docutils literal">not_membership</tt>, the two parameters
create an 'or' condition: either the membership
<em>is</em> the same as <tt class="docutils literal">membership</tt> <strong>or</strong> <em>is not</em>
the same as <tt class="docutils literal">not_membership</tt>. One of: [&quot;join&quot;,
&quot;invite&quot;, &quot;leave&quot;, &quot;ban&quot;]</td>
</tr>
<tr><td>not_membership</td>
<td>enum</td>
<td>The kind of membership to exclude from the
results. Defaults to no filtering if unspecified.
One of: [&quot;join&quot;, &quot;invite&quot;, &quot;leave&quot;, &quot;ban&quot;]</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[MemberEvent]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>MemberEvent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>EventContent</td>
<td><strong>Required.</strong></td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.room.member'.</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">user_id</tt> this membership
event relates to. In all cases except for when
<tt class="docutils literal">membership</tt> is <tt class="docutils literal">join</tt>, the user ID sending
the event does not need to match the user ID in
the <tt class="docutils literal">state_key</tt>, unlike other events. Regular
authorisation rules still apply.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>EventContent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The avatar URL for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>displayname</td>
<td>string or null</td>
<td>The display name for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>membership</td>
<td>enum</td>
<td><strong>Required.</strong> The membership state of the user.
One of: [&quot;invite&quot;, &quot;join&quot;, &quot;knock&quot;, &quot;leave&quot;,
&quot;ban&quot;]</td>
</tr>
<tr><td>is_direct</td>
<td>boolean</td>
<td>Flag indicating if the room containing this event
was created with the intention of being a direct
chat. See <a class="reference internal" href="#module-dm">Direct Messaging</a>.</td>
</tr>
<tr><td>third_party_invite</td>
<td>Invite</td>
<td>&nbsp;</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Invite</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>display_name</td>
<td>string</td>
<td><strong>Required.</strong> A name which can be displayed to
represent the user instead of their third party
identifier</td>
</tr>
<tr><td>signed</td>
<td>signed</td>
<td><strong>Required.</strong> A block of content which has been
signed, which servers can use to verify the event.
Clients should ignore this.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>signed</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The invited matrix user ID. Must be
equal to the user_id property of the event.</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><strong>Required.</strong> A single signature from the
verifying server, in the format specified by the
Signing Events section of the server-server API.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The token property of the containing
third_party_invite object.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StrippedState</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>EventContent</td>
<td><strong>Required.</strong> The <tt class="docutils literal">content</tt> for the event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">state_key</tt> for the event.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">type</tt> for the event.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">sender</tt> for the event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/rooms/%21636q39766251%3Aexample.com/members?at=YWxsCgpOb25lLDM1ODcwOA&amp;membership=join&amp;not_membership=leave</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of members of the room. If you are joined to the room then
this will be the current members of the room. If you have left the
room then this will be the members of the room when you left.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You aren't a member of the room and weren't previously a member of the room.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-rooms-roomid-joined-members"></a></p>
<div class="section" id="get-matrix-client-r0-rooms-roomid-joined-members">
<h3><a class="toc-backref" href="#id300">9.5.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/joined_members</span></tt></a></h3>
<p>This API returns a map of MXIDs to member info objects for members of the room. The current user must be in the room for it to work, unless it is an Application Service in which case any of the AS's users must be in the room. This API is primarily for Application Services and should be faster to respond than <tt class="docutils literal">/members</tt> as it can be implemented more efficiently on the server.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to get the members of.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>joined</td>
<td>{string: RoomMember}</td>
<td>A map from user ID to a RoomMember object.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomMember</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>display_name</td>
<td>string</td>
<td>The display name of the user this object is
representing.</td>
</tr>
<tr><td>avatar_url</td>
<td>string</td>
<td>The mxc avatar url of the user this object is
representing.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/rooms/%21636q39766251%3Aexample.com/joined_members</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>A map of MXID to room member objects.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;joined&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;&#64;bar:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bar&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://riot.ovh/printErCATzZijQsSDWorRaK&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You aren't a member of the room.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-rooms-roomid-messages"></a></p>
<div class="section" id="get-matrix-client-r0-rooms-roomid-messages">
<h3><a class="toc-backref" href="#id301">9.5.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/messages</span></tt></a></h3>
<p>This API returns a list of message and state events for a room. It uses
pagination query parameters to paginate history in the room.</p>
<p><em>Note</em>: This endpoint supports lazy-loading of room member events. See
<a class="reference external" href="#lazy-loading-room-members">Lazy-loading room members</a> for more information.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to get events from.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>from</td>
<td>string</td>
<td><strong>Required.</strong> The token to start returning events
from. This token can be obtained from a
<tt class="docutils literal">prev_batch</tt> token returned for each room by the
sync API, or from a <tt class="docutils literal">start</tt> or <tt class="docutils literal">end</tt> token
returned by a previous request to this endpoint.</td>
</tr>
<tr><td>to</td>
<td>string</td>
<td>The token to stop returning events at. This token
can be obtained from a <tt class="docutils literal">prev_batch</tt> token
returned for each room by the sync endpoint, or
from a <tt class="docutils literal">start</tt> or <tt class="docutils literal">end</tt> token returned by a
previous request to this endpoint.</td>
</tr>
<tr><td>dir</td>
<td>enum</td>
<td><strong>Required.</strong> The direction to return events from.
One of: [&quot;b&quot;, &quot;f&quot;]</td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to return. Default:
10.</td>
</tr>
<tr><td>filter</td>
<td>string</td>
<td>A JSON RoomEventFilter to filter returned events
with.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>start</td>
<td>string</td>
<td>The token the pagination starts from. If <tt class="docutils literal">dir=b</tt>
this will be the token supplied in <tt class="docutils literal">from</tt>.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>The token the pagination ends at. If <tt class="docutils literal">dir=b</tt>
this token should be used again to request even
earlier events.</td>
</tr>
<tr><td>chunk</td>
<td>[RoomEvent]</td>
<td>A list of room events. The order depends on the
<tt class="docutils literal">dir</tt> parameter. For <tt class="docutils literal">dir=b</tt> events will be in
reverse-chronological order, for <tt class="docutils literal">dir=f</tt> in
chronological order, so that events start at the
<tt class="docutils literal">from</tt> point.</td>
</tr>
<tr><td>state</td>
<td>[RoomStateEvent]</td>
<td><p class="first">A list of state events relevant to showing the
<tt class="docutils literal">chunk</tt>. For example, if <tt class="docutils literal">lazy_load_members</tt>
is enabled in the filter then this may contain the
membership events for the senders of events in the
<tt class="docutils literal">chunk</tt>.</p>
<p class="last">Unless <tt class="docutils literal">include_redundant_members</tt> is <tt class="docutils literal">true</tt>,
the server may remove membership events which
would have already been sent to the client in
prior calls to this endpoint, assuming the
membership of those members has not changed.</p>
</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomEvent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomStateEvent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> A unique key which defines the
overwriting semantics for this piece of room
state. This value is often a zero-length string.
The presence of this key makes this event a State
Event. State keys starting with an <tt class="docutils literal">&#64;</tt> are
reserved for referencing user IDs, such as room
members. With the exception of a few events, state
events set with a given user's ID as the state key
MUST only be set by that user.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/rooms/%21636q39766251%3Aexample.com/messages?from=s345_678_333&amp;dir=b&amp;limit=3&amp;filter=%7B%22contains_url%22%3Atrue%7D</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of messages with a new token to request more.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t47429-4392820_219380_26003_2265&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t47409-4357353_219380_26003_2265&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The room name&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.name&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Gangnam Style&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/a526eYUSFFxlgbQYZmo442&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;thumbnail_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;thumbnail_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span><span class="punctuation">,</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span>
          <span class="punctuation">},</span>
          <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">480</span><span class="punctuation">,</span>
          <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">320</span><span class="punctuation">,</span>
          <span class="name tag">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2140786</span><span class="punctuation">,</span>
          <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1563685</span><span class="punctuation">,</span>
          <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;video/mp4&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.video&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You aren't a member of the room.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-rooms-roomid-initialsync"></a></p>
<div class="section" id="get-matrix-client-r0-rooms-roomid-initialsync">
<h3><a class="toc-backref" href="#id302">9.5.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/initialSync</span></tt></a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This API is deprecated and will be removed from a future release.</p>
</div>
<p>Get a copy of the current state and the most recent messages in a room.</p>
<p>This endpoint was deprecated in r0 of this specification. There is no
direct replacement; the relevant information is returned by the
<a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a> API. See the <a class="reference external" href="https://matrix.org/docs/guides/client-server-migrating-from-v1.html#deprecated-endpoints">migration guide</a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to get the data.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>RoomInfo</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of this room.</td>
</tr>
<tr><td>membership</td>
<td>enum</td>
<td>The user's membership state in this room. One of:
[&quot;invite&quot;, &quot;join&quot;, &quot;leave&quot;, &quot;ban&quot;]</td>
</tr>
<tr><td>messages</td>
<td>PaginationChunk</td>
<td>The pagination chunk for this room.</td>
</tr>
<tr><td>state</td>
<td>[StateEvent]</td>
<td>If the user is a member of the room this will be
the current state of the room as a list of events.
If the user has left the room this will be the
state of the room when they left it.</td>
</tr>
<tr><td>visibility</td>
<td>enum</td>
<td>Whether this room is visible to the
<tt class="docutils literal">/publicRooms</tt> API or not.&quot; One of: [&quot;private&quot;,
&quot;public&quot;]</td>
</tr>
<tr><td>account_data</td>
<td>[Event]</td>
<td>The private data that this user has attached to
this room.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PaginationChunk</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>start</td>
<td>string</td>
<td><strong>Required.</strong> A token which correlates to the
first value in <tt class="docutils literal">chunk</tt>. Used for pagination.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td><strong>Required.</strong> A token which correlates to the last
value in <tt class="docutils literal">chunk</tt>. Used for pagination.</td>
</tr>
<tr><td>chunk</td>
<td>[RoomEvent]</td>
<td><strong>Required.</strong> If the user is a member of the room
this will be a list of the most recent messages
for this room. If the user has left the room this
will be the messages that preceeded them leaving.
This array will consist of at most <tt class="docutils literal">limit</tt>
elements.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RoomEvent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StateEvent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> A unique key which defines the
overwriting semantics for this piece of room
state. This value is often a zero-length string.
The presence of this key makes this event a State
Event. State keys starting with an <tt class="docutils literal">&#64;</tt> are
reserved for referencing user IDs, such as room
members. With the exception of a few events, state
events set with a given user's ID as the state key
MUST only be set by that user.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/rooms/%21636q39766251%3Aexample.com/initialSync</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The current state of the room</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;messages&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
        <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
        <span class="punctuation">}</span>
      <span class="punctuation">},</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.doc&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.doc&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;application/msword&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span>
          <span class="punctuation">},</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.file&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
        <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3456_9_0&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t44-3453_9_0&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;join_rule&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.join_rules&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;creator&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;room_version&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;m.federate&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;predecessor&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$something:example.org&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!oldroom:example.org&quot;</span>
        <span class="punctuation">}</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.create&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ban&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;m.room.name&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span><span class="punctuation">,</span>
          <span class="name tag">&quot;m.room.power_levels&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;events_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
        <span class="name tag">&quot;invite&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;kick&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;redact&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;state_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;&#64;example:localhost&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;users_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
        <span class="name tag">&quot;notifications&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;room&quot;</span><span class="punctuation">:</span> <span class="literal number integer">20</span>
        <span class="punctuation">}</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.power_levels&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;visibility&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;private&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;account_data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.tag&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;work&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;order&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You aren't a member of the room and weren't previously a member of the room.</p>
</div>
</div>
<p><a class="anchor" id="sending-events-to-a-room"></a></p>
<div class="section" id="sending-events-to-a-room">
<h2><a class="toc-backref" href="#id303">9.6&nbsp;&nbsp;&nbsp;Sending events to a room</a></h2>
<p><a class="anchor" id="put-matrix-client-r0-rooms-roomid-state-eventtype-statekey"></a></p>
<div class="section" id="put-matrix-client-r0-rooms-roomid-state-eventtype-statekey">
<h3><a class="toc-backref" href="#id304">9.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/rooms/{roomId}/state/{eventType}/{stateKey}</span></tt></a></h3>
<!-- For backwards compatibility with older links... -->
<p id="put-matrix-client-r0-rooms-roomid-state-eventtype">State events can be sent using this endpoint.  These events will be
overwritten if <tt class="docutils literal">&lt;room id&gt;</tt>, <tt class="docutils literal">&lt;event type&gt;</tt> and <tt class="docutils literal">&lt;state key&gt;</tt> all
match.</p>
<p>Requests to this endpoint <strong>cannot use transaction IDs</strong>
like other <tt class="docutils literal">PUT</tt> paths because they cannot be differentiated from the
<tt class="docutils literal">state_key</tt>. Furthermore, <tt class="docutils literal">POST</tt> is unsupported on state paths.</p>
<p>The body of the request should be the content object of the event; the
fields in this object will vary depending on the type of event. See
<a class="reference internal" href="#room-events">Room Events</a> for the <tt class="docutils literal">m.</tt> event specification.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to set the state in</td>
</tr>
<tr><td>eventType</td>
<td>string</td>
<td><strong>Required.</strong> The type of event to send.</td>
</tr>
<tr><td>stateKey</td>
<td>string</td>
<td><strong>Required.</strong> The state_key for the state to send.
Defaults to the empty string. When an empty
string, the trailing slash on this endpoint is
optional.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>A unique identifier for the event.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/rooms/%21636q39766251%3Aexample.com/state/m.room.member/%40alice%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>An ID for the sent event.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$YUwRidLecu:example.com&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The sender doesn't have permission to send the event into the room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;You do not have permission to send the event.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Examples</strong></p>
<p>Valid requests look like:</p>
<pre class="literal-block">
PUT /rooms/!roomid:domain/state/m.example.event
{ &quot;key&quot; : &quot;without a state key&quot; }

PUT /rooms/!roomid:domain/state/m.another.example.event/foo
{ &quot;key&quot; : &quot;with 'foo' as the state key&quot; }
</pre>
<p>In contrast, these requests are invalid:</p>
<pre class="literal-block">
POST /rooms/!roomid:domain/state/m.example.event/
{ &quot;key&quot; : &quot;cannot use POST here&quot; }

PUT /rooms/!roomid:domain/state/m.another.example.event/foo/11
{ &quot;key&quot; : &quot;txnIds are not supported&quot; }
</pre>
<p>Care should be taken to avoid setting the wrong <tt class="docutils literal">state key</tt>:</p>
<pre class="literal-block">
PUT /rooms/!roomid:domain/state/m.another.example.event/11
{ &quot;key&quot; : &quot;with '11' as the state key, but was probably intended to be a txnId&quot; }
</pre>
<p>The <tt class="docutils literal">state_key</tt> is often used to store state about individual users, by using
the user ID as the <tt class="docutils literal">state_key</tt> value. For example:</p>
<pre class="literal-block">
PUT /rooms/!roomid:domain/state/m.favorite.animal.event/%40my_user%3Aexample.org
{ &quot;animal&quot; : &quot;cat&quot;, &quot;reason&quot;: &quot;fluffy&quot; }
</pre>
<p>In some cases, there may be no need for a <tt class="docutils literal">state_key</tt>, so it can be omitted:</p>
<pre class="literal-block">
PUT /rooms/!roomid:domain/state/m.room.bgd.color
{ &quot;color&quot;: &quot;red&quot;, &quot;hex&quot;: &quot;#ff0000&quot; }
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-r0-rooms-roomid-send-eventtype-txnid"></a></p>
<div class="section" id="put-matrix-client-r0-rooms-roomid-send-eventtype-txnid">
<h3><a class="toc-backref" href="#id305">9.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/rooms/{roomId}/send/{eventType}/{txnId}</span></tt></a></h3>
<p>This endpoint is used to send a message event to a room. Message events
allow access to historical events and pagination, making them suited
for &quot;once-off&quot; activity in a room.</p>
<p>The body of the request should be the content object of the event; the
fields in this object will vary depending on the type of event. See
<a class="reference internal" href="#room-events">Room Events</a> for the m. event specification.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to send the event to.</td>
</tr>
<tr><td>eventType</td>
<td>string</td>
<td><strong>Required.</strong> The type of event to send.</td>
</tr>
<tr><td>txnId</td>
<td>string</td>
<td><strong>Required.</strong> The transaction ID for this event.
Clients should generate an ID unique across
requests with the same access token; it will be
used by the server to ensure idempotency of
requests.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>A unique identifier for the event.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/rooms/%21636q39766251%3Aexample.com/send/m.room.message/35</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;hello&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>An ID for the sent event.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$YUwRidLecu:example.com&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="redactions"></a></p>
<div class="section" id="redactions">
<h2><a class="toc-backref" href="#id306">9.7&nbsp;&nbsp;&nbsp;Redactions</a></h2>
<p>Since events are extensible it is possible for malicious users and/or servers
to add keys that are, for example offensive or illegal. Since some events
cannot be simply deleted, e.g. membership events, we instead 'redact' events.
This involves removing all keys from an event that are not required by the
protocol. This stripped down event is thereafter returned anytime a client or
remote server requests it. Redacting an event cannot be undone, allowing server
owners to delete the offending content from the databases. Events that have been
redacted include a <tt class="docutils literal">redacted_because</tt> key whose value is the event that caused
it to be redacted, which may include a reason.</p>
<p>Upon receipt of a redaction event, the server should strip off any keys not in
the following list:</p>
<ul class="simple">
<li><tt class="docutils literal">event_id</tt></li>
<li><tt class="docutils literal">type</tt></li>
<li><tt class="docutils literal">room_id</tt></li>
<li><tt class="docutils literal">sender</tt></li>
<li><tt class="docutils literal">state_key</tt></li>
<li><tt class="docutils literal">content</tt></li>
<li><tt class="docutils literal">hashes</tt></li>
<li><tt class="docutils literal">signatures</tt></li>
<li><tt class="docutils literal">depth</tt></li>
<li><tt class="docutils literal">prev_events</tt></li>
<li><tt class="docutils literal">prev_state</tt></li>
<li><tt class="docutils literal">auth_events</tt></li>
<li><tt class="docutils literal">origin</tt></li>
<li><tt class="docutils literal">origin_server_ts</tt></li>
<li><tt class="docutils literal">membership</tt></li>
</ul>
<!-- Note:
Some of the keys, such as ``hashes``, will appear on the federation-formatted
event and therefore the client may not be aware of them. -->
<p>The content object should also be stripped of all keys, unless it is one of
one of the following event types:</p>
<ul class="simple">
<li><tt class="docutils literal">m.room.member</tt> allows key <tt class="docutils literal">membership</tt>.</li>
<li><tt class="docutils literal">m.room.create</tt> allows key <tt class="docutils literal">creator</tt>.</li>
<li><tt class="docutils literal">m.room.join_rules</tt> allows key <tt class="docutils literal">join_rule</tt>.</li>
<li><tt class="docutils literal">m.room.power_levels</tt> allows keys <tt class="docutils literal">ban</tt>, <tt class="docutils literal">events</tt>, <tt class="docutils literal">events_default</tt>,
<tt class="docutils literal">kick</tt>, <tt class="docutils literal">redact</tt>, <tt class="docutils literal">state_default</tt>, <tt class="docutils literal">users</tt>, <tt class="docutils literal">users_default</tt>.</li>
<li><tt class="docutils literal">m.room.aliases</tt> allows key <tt class="docutils literal">aliases</tt>.</li>
<li><tt class="docutils literal">m.room.history_visibility</tt> allows key <tt class="docutils literal">history_visibility</tt>.</li>
</ul>
<p>The server should add the event causing the redaction to the <tt class="docutils literal">unsigned</tt>
property of the redacted event, under the <tt class="docutils literal">redacted_because</tt> key. When a
client receives a redaction event it should change the redacted event in the
same way a server does.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Redacted events can still affect the state of the room. When redacted,
state events behave as though their properties were simply not specified,
except those protected by the redaction algorithm. For example,
a redacted <tt class="docutils literal">join</tt> event will still result in the user being considered joined.
Similarly, a redacted topic does not necessarily cause the topic to revert to
what is was prior to the event - it causes the topic to be removed from the room.</p>
</div>
<p><a class="anchor" id="id83"></a></p>
<div class="section" id="id83">
<h3><a class="toc-backref" href="#id307">9.7.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="id84"></a></p>
<div class="section" id="id84">
<h4><a class="toc-backref" href="#id308">9.7.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.redaction</tt></a></h4>
<p><em>Message Event</em></p>
<p>Events can be redacted by either room or server admins. Redacting an event means that all keys not required by the protocol are stripped off, allowing admins to remove offensive or illegal content that may have been attached to any event. This cannot be undone, allowing server owners to physically delete the offending data.  There is also a concept of a moderator hiding a message event, which can be undone, but cannot be applied to state events. The event that has been redacted is specified in the <tt class="docutils literal">redacts</tt> event level key.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>reason</td>
<td>string</td>
<td>The reason for the redaction, if any.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Spamming&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;redacts&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$fukweghifu23:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.redaction&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="client-behaviour"></a></p>
<div class="section" id="client-behaviour">
<h3><a class="toc-backref" href="#id309">9.7.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p><a class="anchor" id="put-matrix-client-r0-rooms-roomid-redact-eventid-txnid"></a></p>
<div class="section" id="put-matrix-client-r0-rooms-roomid-redact-eventid-txnid">
<h4><a class="toc-backref" href="#id310">9.7.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/rooms/{roomId}/redact/{eventId}/{txnId}</span></tt></a></h4>
<p>Strips all information out of an event which isn't critical to the
integrity of the server-side representation of the room.</p>
<p>This cannot be undone.</p>
<p>Users may redact their own events, and any user with a power level
greater than or equal to the <cite>redact</cite> power level of the room may
redact events there.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room from which to redact the
event.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the event to redact</td>
</tr>
<tr><td>txnId</td>
<td>string</td>
<td><strong>Required.</strong> The transaction ID for this event.
Clients should generate a unique ID; it will be
used by the server to ensure idempotency of
requests.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>reason</td>
<td>string</td>
<td>The reason for the event being redacted.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>A unique identifier for the event.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/rooms/%21637q39766251%3Aexample.com/redact/bai2b1i9%3Amatrix.org/37</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Indecent material&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>An ID for the redaction event.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$YUwQidLecu:example.com&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
</div>
<p><a class="anchor" id="rooms"></a></p>
<div class="section" id="rooms">
<h1><a class="toc-backref" href="#id311">10&nbsp;&nbsp;&nbsp;Rooms</a></h1>
<p><a class="anchor" id="creation"></a></p>
<div class="section" id="creation">
<h2><a class="toc-backref" href="#id312">10.1&nbsp;&nbsp;&nbsp;Creation</a></h2>
<p>The homeserver will create an <tt class="docutils literal">m.room.create</tt> event when a room is created,
which serves as the root of the event graph for this room. This event also has a
<tt class="docutils literal">creator</tt> key which contains the user ID of the room creator. It will also
generate several other events in order to manage permissions in this room. This
includes:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt><tt class="docutils literal">m.room.power_levels</tt> <span class="classifier-delimiter">:</span> <span class="classifier">Sets the power levels of users and required power</span></dt>
<dd>levels for various actions within the room such as sending events.</dd>
</dl>
</li>
<li><tt class="docutils literal">m.room.join_rules</tt> : Whether the room is &quot;invite-only&quot; or not.</li>
</ul>
<p>See <a class="reference internal" href="#room-events">Room Events</a> for more information on these events. To create a room, a
client has to use the following API.</p>
<p><a class="anchor" id="post-matrix-client-r0-createroom"></a></p>
<div class="section" id="post-matrix-client-r0-createroom">
<h3><a class="toc-backref" href="#id313">10.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/createRoom</tt></a></h3>
<p>Create a new room with various configuration options.</p>
<p>The server MUST apply the normal state resolution rules when creating
the new room, including checking power levels for each event. It MUST
apply the events implied by the request in the following order:</p>
<ol class="arabic simple" start="0">
<li>A default <tt class="docutils literal">m.room.power_levels</tt> event, giving the room creator
(and not other members) permission to send state events. Overridden
by the <tt class="docutils literal">power_level_content_override</tt> parameter.</li>
<li>Events set by the <tt class="docutils literal">preset</tt>. Currently these are the <tt class="docutils literal">m.room.join_rules</tt>,
<tt class="docutils literal">m.room.history_visibility</tt>, and <tt class="docutils literal">m.room.guest_access</tt> state events.</li>
<li>Events listed in <tt class="docutils literal">initial_state</tt>, in the order that they are
listed.</li>
<li>Events implied by <tt class="docutils literal">name</tt> and <tt class="docutils literal">topic</tt> (<tt class="docutils literal">m.room.name</tt> and <tt class="docutils literal">m.room.topic</tt>
state events).</li>
<li>Invite events implied by <tt class="docutils literal">invite</tt> and <tt class="docutils literal">invite_3pid</tt> (<tt class="docutils literal">m.room.member</tt> with
<tt class="docutils literal">membership: invite</tt> and <tt class="docutils literal">m.room.third_party_invite</tt>).</li>
</ol>
<p>The available presets do the following with respect to room state:</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="10%" />
<col width="16%" />
<col width="11%" />
<col width="46%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Preset</th>
<th class="head"><tt class="docutils literal">join_rules</tt></th>
<th class="head"><tt class="docutils literal">history_visibility</tt></th>
<th class="head"><tt class="docutils literal">guest_access</tt></th>
<th class="head">Other</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">private_chat</tt></td>
<td><tt class="docutils literal">invite</tt></td>
<td><tt class="docutils literal">shared</tt></td>
<td><tt class="docutils literal">can_join</tt></td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal">trusted_private_chat</tt></td>
<td><tt class="docutils literal">invite</tt></td>
<td><tt class="docutils literal">shared</tt></td>
<td><tt class="docutils literal">can_join</tt></td>
<td>All invitees are given the same power level as the room creator.</td>
</tr>
<tr><td><tt class="docutils literal">public_chat</tt></td>
<td><tt class="docutils literal">public</tt></td>
<td><tt class="docutils literal">shared</tt></td>
<td><tt class="docutils literal">forbidden</tt></td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>The server will create a <tt class="docutils literal">m.room.create</tt> event in the room with the
requesting user as the creator, alongside other keys provided in the
<tt class="docutils literal">creation_content</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>visibility</td>
<td>enum</td>
<td>A <tt class="docutils literal">public</tt> visibility indicates that the room
will be shown in the published room list. A
<tt class="docutils literal">private</tt> visibility will hide the room from the
published room list. Rooms default to <tt class="docutils literal">private</tt>
visibility if this key is not included. NB: This
should not be confused with <tt class="docutils literal">join_rules</tt> which
also uses the word <tt class="docutils literal">public</tt>. One of: [&quot;public&quot;,
&quot;private&quot;]</td>
</tr>
<tr><td>room_alias_name</td>
<td>string</td>
<td><p class="first">The desired room alias <strong>local part</strong>. If this is
included, a room alias will be created and mapped
to the newly created room. The alias will belong
on the <em>same</em> homeserver which created the room.
For example, if this was set to &quot;foo&quot; and sent to
the homeserver &quot;example.com&quot; the complete room
alias would be <tt class="docutils literal">#foo:example.com</tt>.</p>
<p class="last">The complete room alias will become the canonical
alias for the room.</p>
</td>
</tr>
<tr><td>name</td>
<td>string</td>
<td>If this is included, an <tt class="docutils literal">m.room.name</tt> event will
be sent into the room to indicate the name of the
room. See Room Events for more information on
<tt class="docutils literal">m.room.name</tt>.</td>
</tr>
<tr><td>topic</td>
<td>string</td>
<td>If this is included, an <tt class="docutils literal">m.room.topic</tt> event
will be sent into the room to indicate the topic
for the room. See Room Events for more information
on <tt class="docutils literal">m.room.topic</tt>.</td>
</tr>
<tr><td>invite</td>
<td>[string]</td>
<td>A list of user IDs to invite to the room. This
will tell the server to invite everyone in the
list to the newly created room.</td>
</tr>
<tr><td>invite_3pid</td>
<td>[Invite3pid]</td>
<td>A list of objects representing third party IDs to
invite into the room.</td>
</tr>
<tr><td>room_version</td>
<td>string</td>
<td>The room version to set for the room. If not
provided, the homeserver is to use its configured
default. If provided, the homeserver will return a
400 error with the errcode
<tt class="docutils literal">M_UNSUPPORTED_ROOM_VERSION</tt> if it does not
support the room version.</td>
</tr>
<tr><td>creation_content</td>
<td>CreationContent</td>
<td>Extra keys, such as <tt class="docutils literal">m.federate</tt>, to be added to
the content of the <a class="reference internal" href="#m-room-create">m.room.create</a> event. The
server will clobber the following keys:
<tt class="docutils literal">creator</tt>, <tt class="docutils literal">room_version</tt>. Future versions of
the specification may allow the server to clobber
other keys.</td>
</tr>
<tr><td>initial_state</td>
<td>[StateEvent]</td>
<td><p class="first">A list of state events to set in the new room.
This allows the user to override the default state
events set in the new room. The expected format of
the state events are an object with type,
state_key and content keys set.</p>
<p class="last">Takes precedence over events set by <tt class="docutils literal">preset</tt>,
but gets overriden by <tt class="docutils literal">name</tt> and <tt class="docutils literal">topic</tt> keys.</p>
</td>
</tr>
<tr><td>preset</td>
<td>enum</td>
<td><p class="first">Convenience parameter for setting various default
state events based on a preset.</p>
<p class="last">If unspecified, the server should use the
<tt class="docutils literal">visibility</tt> to determine which preset to use. A
visbility of <tt class="docutils literal">public</tt> equates to a preset of
<tt class="docutils literal">public_chat</tt> and <tt class="docutils literal">private</tt> visibility equates
to a preset of <tt class="docutils literal">private_chat</tt>. One of:
[&quot;private_chat&quot;, &quot;public_chat&quot;,
&quot;trusted_private_chat&quot;]</p>
</td>
</tr>
<tr><td>is_direct</td>
<td>boolean</td>
<td>This flag makes the server set the <tt class="docutils literal">is_direct</tt>
flag on the <tt class="docutils literal">m.room.member</tt> events sent to the
users in <tt class="docutils literal">invite</tt> and <tt class="docutils literal">invite_3pid</tt>. See
<a class="reference internal" href="#module-dm">Direct Messaging</a> for more information.</td>
</tr>
<tr><td>power_level_content_override</td>
<td>Power Level Event Content</td>
<td>The power level content to override in the default
power level event. This object is applied on top
of the generated <a class="reference internal" href="#m-room-power-levels">m.room.power_levels</a> event
content prior to it being sent to the room.
Defaults to overriding nothing.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Invite3pid</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>id_server</td>
<td>string</td>
<td><strong>Required.</strong> The hostname+port of the identity
server which should be used for third party
identifier lookups.</td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The kind of address being passed in
the address field, for example <tt class="docutils literal">email</tt>.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The invitee's third party
identifier.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>StateEvent</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event to send.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>The state_key of the state event. Defaults to an
empty string.</td>
</tr>
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The content of the event.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The created room's ID.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/createRoom</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;preset&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public_chat&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_alias_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;thepub&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The Grand Duke Pub&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;All about happy hour&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;creation_content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;m.federate&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Information about the newly created room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!sefiuhWgwghwWgh:example.com&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The request is invalid. A meaningful <tt class="docutils literal">errcode</tt> and description
error text will be returned. Example reasons for rejection include:</p>
<ul class="simple">
<li>The request body is malformed (<tt class="docutils literal">errcode</tt> set to <tt class="docutils literal">M_BAD_JSON</tt>
or <tt class="docutils literal">M_NOT_JSON</tt>).</li>
<li>The room alias specified is already taken (<tt class="docutils literal">errcode</tt> set to
<tt class="docutils literal">M_ROOM_IN_USE</tt>).</li>
<li>The initial state implied by the parameters to the request is
invalid: for example, the user's <tt class="docutils literal">power_level</tt> is set below
that necessary to set the room name (<tt class="docutils literal">errcode</tt> set to
<tt class="docutils literal">M_INVALID_ROOM_STATE</tt>).</li>
<li>The homeserver doesn't support the requested room version, or
one or more users being invited to the new room are residents
of a homeserver which does not support the requested room version.
The <tt class="docutils literal">errcode</tt> will be <tt class="docutils literal">M_UNSUPPORTED_ROOM_VERSION</tt> in these
cases.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;An unknown error occurred&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="room-aliases"></a></p>
<div class="section" id="room-aliases">
<h2><a class="toc-backref" href="#id314">10.2&nbsp;&nbsp;&nbsp;Room aliases</a></h2>
<p>Servers may host aliases for rooms with human-friendly names. Aliases take the
form <tt class="docutils literal">#friendlyname:server.name</tt>.</p>
<p>As room aliases are scoped to a particular homeserver domain name, it is
likely that a homeserver will reject attempts to maintain aliases on other
domain names. This specification does not provide a way for homeservers to
send update requests to other servers. However, homeservers MUST handle
<tt class="docutils literal">GET</tt> requests to resolve aliases on other servers; they should do this using
the federation API if necessary.</p>
<p>Rooms store a <em>partial</em> list of room aliases via the <tt class="docutils literal">m.room.aliases</tt> state
event. This alias list is partial because it cannot guarantee that the alias
list is in any way accurate or up-to-date, as room aliases can point to
different room IDs over time. Crucially, the aliases in this event are
<strong>purely informational</strong> and SHOULD NOT be treated as accurate. They SHOULD
be checked before they are used or shared with another user. If a room
appears to have a room alias of <tt class="docutils literal">#alias:example.com</tt>, this SHOULD be checked
to make sure that the room's ID matches the <tt class="docutils literal">room_id</tt> returned from the
request.</p>
<p><a class="anchor" id="put-matrix-client-r0-directory-room-roomalias"></a></p>
<div class="section" id="put-matrix-client-r0-directory-room-roomalias">
<h3><a class="toc-backref" href="#id315">10.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/directory/room/{roomAlias}</span></tt></a></h3>
<p>Create a new mapping from room alias to room ID.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomAlias</td>
<td>string</td>
<td><strong>Required.</strong> The room alias to set.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The room ID to set.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/directory/room/%23monkeys%3Amatrix.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!abnjk1jdasj98:capuchins.com&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The mapping was created.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 409:</strong></p>
<p>A room alias with that name already exists.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Room alias #monkeys:matrix.org already exists.&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-directory-room-roomalias"></a></p>
<div class="section" id="get-matrix-client-r0-directory-room-roomalias">
<h3><a class="toc-backref" href="#id316">10.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/directory/room/{roomAlias}</span></tt></a></h3>
<p>Requests that the server resolve a room alias to a room ID.</p>
<p>The server will use the federation API to resolve the alias if the
domain part of the alias does not correspond to the server's own
domain.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomAlias</td>
<td>string</td>
<td><strong>Required.</strong> The room alias.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td>The room ID for this room alias.</td>
</tr>
<tr><td>servers</td>
<td>[string]</td>
<td>A list of servers that are aware of this room
alias.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/directory/room/%23monkeys%3Amatrix.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The room ID and other information for this alias.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!abnjk1jdasj98:capuchins.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;capuchins.com&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;another.com&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>There is no mapped room ID for this room alias.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Room alias #monkeys:matrix.org not found.&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="delete-matrix-client-r0-directory-room-roomalias"></a></p>
<div class="section" id="delete-matrix-client-r0-directory-room-roomalias">
<h3><a class="toc-backref" href="#id317">10.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">DELETE <span class="pre">/_matrix/client/r0/directory/room/{roomAlias}</span></tt></a></h3>
<p>Remove a mapping of room alias to room ID.</p>
<p>Servers may choose to implement additional access control checks here, for instance that room aliases can only be deleted by their creator or a server administrator.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomAlias</td>
<td>string</td>
<td><strong>Required.</strong> The room alias to remove.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">DELETE</span> <span class="name namespace">/_matrix/client/r0/directory/room/%23monkeys%3Amatrix.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The mapping was deleted.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>There is no mapped room ID for this room alias.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Room alias #monkeys:example.org not found.&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="permissions"></a></p>
<div class="section" id="permissions">
<h2><a class="toc-backref" href="#id318">10.3&nbsp;&nbsp;&nbsp;Permissions</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section is a work in progress.</p>
</div>
<p>Permissions for rooms are done via the concept of power levels - to do any
action in a room a user must have a suitable power level. Power levels are
stored as state events in a given room. The power levels required for operations
and the power levels for users are defined in <tt class="docutils literal">m.room.power_levels</tt>, where
both a default and specific users' power levels can be set.
By default all users have a power level of 0, other than the room creator whose
power level defaults to 100. Users can grant other users increased power levels
up to their own power level. For example, user A with a power level of 50 could
increase the power level of user B to a maximum of level 50. Power levels for
users are tracked per-room even if the user is not present in the room.
The keys contained in <tt class="docutils literal">m.room.power_levels</tt> determine the levels required for
certain operations such as kicking, banning and sending state events. See
<a class="reference internal" href="#m-room-power-levels">m.room.power_levels</a> for more information.</p>
<p>Clients may wish to assign names to particular power levels. A suggested mapping is as follows:
- 0   User
- 50  Moderator
- 100 Admin</p>
</div>
<p><a class="anchor" id="room-membership"></a></p>
<div class="section" id="room-membership">
<h2><a class="toc-backref" href="#id319">10.4&nbsp;&nbsp;&nbsp;Room membership</a></h2>
<p>Users need to be a member of a room in order to send and receive events in that
room. There are several states in which a user may be, in relation to a room:</p>
<ul class="simple">
<li>Unrelated (the user cannot send or receive events in the room)</li>
<li>Invited (the user has been invited to participate in the room, but is not
yet participating)</li>
<li>Joined (the user can send and receive events in the room)</li>
<li>Banned (the user is not allowed to join the room)</li>
</ul>
<p>There is an exception to the requirement that a user join a room before sending
events to it: users may send an <tt class="docutils literal">m.room.member</tt> event to a room with
<tt class="docutils literal">content.membership</tt> set to <tt class="docutils literal">leave</tt> to reject an invitation if they have
currently been invited to a room but have not joined it.</p>
<p>Some rooms require that users be invited to it before they can join; others
allow anyone to join. Whether a given room is an &quot;invite-only&quot; room is
determined by the room config key <tt class="docutils literal">m.room.join_rules</tt>. It can have one of the
following values:</p>
<dl class="docutils">
<dt><tt class="docutils literal">public</tt></dt>
<dd>This room is free for anyone to join without an invite.</dd>
<dt><tt class="docutils literal">invite</tt></dt>
<dd>This room can only be joined if you were invited.</dd>
</dl>
<p>The allowable state transitions of membership are:</p>
<pre class="literal-block">
                                     /ban
                +------------------------------------------------------+
                |                                                      |
                |  +----------------+  +----------------+              |
                |  |    /leave      |  |                |              |
                |  |                v  v                |              |
  /invite    +--------+           +-------+             |              |
------------&gt;| invite |&lt;----------| leave |----+        |              |
             +--------+  /invite  +-------+    |        |              |
               |                   |    ^      |        |              |
               |                   |    |      |        |              |
         /join |   +---------------+    |      |        |              |
               |   | /join if           |      |        |              |
               |   | join_rules         |      | /ban   | /unban       |
               |   | public      /leave |      |        |              |
               v   v               or   |      |        |              |
             +------+            /kick  |      |        |              |
------------&gt;| join |-------------------+      |        |              |
 /join       +------+                          v        |              |
 if             |                           +-----+     |              |
 join_rules     +--------------------------&gt;| ban |-----+              |
 public                   /ban              +-----+                    |
                                              ^ ^                      |
                                              | |                      |
----------------------------------------------+ +----------------------+
                /ban
</pre>
<p><a class="anchor" id="get-matrix-client-r0-joined-rooms"></a></p>
<div class="section" id="get-matrix-client-r0-joined-rooms">
<h3><a class="toc-backref" href="#id320">10.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/joined_rooms</tt></a></h3>
<p>This API returns a list of the user's current rooms.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>joined_rooms</td>
<td>[string]</td>
<td><strong>Required.</strong> The ID of each room in which the
user has <tt class="docutils literal">joined</tt> membership.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/joined_rooms</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of the rooms the user is in.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;joined_rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;!foo:example.com&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="joining-rooms"></a></p>
<div class="section" id="joining-rooms">
<h3><a class="toc-backref" href="#id321">10.4.2&nbsp;&nbsp;&nbsp;Joining rooms</a></h3>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-invite"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-invite">
<h4><a class="toc-backref" href="#id322">10.4.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/invite</span></tt></a></h4>
<p id="invite-by-user-id-endpoint"><em>Note that there are two forms of this API, which are documented separately.
This version of the API requires that the inviter knows the Matrix
identifier of the invitee. The other is documented in the</em>
<a class="reference internal" href="#invite-by-third-party-id-endpoint">third party invites section</a>.</p>
<p>This API invites a user to participate in a particular room.
They do not start participating in the room until they actually join the
room.</p>
<p>Only users currently in a particular room can invite other users to
join that room.</p>
<p>If the user was invited to the room, the homeserver will append a
<tt class="docutils literal">m.room.member</tt> event to the room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier (not alias) to
which to invite the user.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The fully qualified user ID of the
invitee.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21d41d8cd%3Amatrix.org/invite</span>  <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The user has been invited to join the room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The request is invalid. A meaningful <tt class="docutils literal">errcode</tt> and description
error text will be returned. Example reasons for rejection include:</p>
<ul class="simple">
<li>The request body is malformed (<tt class="docutils literal">errcode</tt> set to <tt class="docutils literal">M_BAD_JSON</tt>
or <tt class="docutils literal">M_NOT_JSON</tt>).</li>
<li>One or more users being invited to the room are residents of a
homeserver which does not support the requested room version. The
<tt class="docutils literal">errcode</tt> will be <tt class="docutils literal">M_UNSUPPORTED_ROOM_VERSION</tt> in these cases.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;An unknown error occurred&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You do not have permission to invite the user to the room. A meaningful <tt class="docutils literal">errcode</tt> and description error text will be returned. Example reasons for rejections are:</p>
<ul class="simple">
<li>The invitee has been banned from the room.</li>
<li>The invitee is already a member of the room.</li>
<li>The inviter is not currently in the room.</li>
<li>The inviter's power level is insufficient to invite users to the room.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org is banned from the room&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-join"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-join">
<h4><a class="toc-backref" href="#id323">10.4.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/join</span></tt></a></h4>
<p><em>Note that this API requires a room ID, not alias.</em> <tt class="docutils literal"><span class="pre">/join/{roomIdOrAlias}</span></tt> <em>exists if you have a room alias.</em></p>
<p>This API starts a user participating in a particular room, if that user
is allowed to participate in that room. After this call, the client is
allowed to see all current state events in the room, and all subsequent
events associated with the room until the user leaves the room.</p>
<p>After a user has joined a room, the room will appear as an entry in the
response of the <a class="reference external" href="#get-matrix-client-r0-initialsync"><tt class="docutils literal">/initialSync</tt></a> and <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a> APIs.</p>
<p>If a <tt class="docutils literal">third_party_signed</tt> was supplied, the homeserver must verify
that it matches a pending <tt class="docutils literal">m.room.third_party_invite</tt> event in the
room, and perform key validity checking if required by the event.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier (not alias) to
join.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>third_party_signed</td>
<td>Third Party Signed</td>
<td>A signature of an <tt class="docutils literal">m.third_party_invite</tt> token
to prove that this user owns a third party
identity which has been invited to the room.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Third Party Signed</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix ID of the user who issued
the invite.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix ID of the invitee.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The state key of the
m.third_party_invite event.</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><strong>Required.</strong> A signatures object containing a
signature of the entire signed object.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The joined room ID.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21d41d8cd%3Amatrix.org/join</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;third_party_signed&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;random8nonce&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;example.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ed25519:0&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;some9signature&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The room has been joined.</p>
<p>The joined room ID must be returned in the <tt class="docutils literal">room_id</tt> field.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!d41d8cd:matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You do not have permission to join the room. A meaningful <tt class="docutils literal">errcode</tt> and description error text will be returned. Example reasons for rejection are:</p>
<ul class="simple">
<li>The room is invite-only and the user was not invited.</li>
<li>The user has been banned from the room.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;You are not invited to this room.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-join-roomidoralias"></a></p>
<div class="section" id="post-matrix-client-r0-join-roomidoralias">
<h4><a class="toc-backref" href="#id324">10.4.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/join/{roomIdOrAlias}</span></tt></a></h4>
<p><em>Note that this API takes either a room ID or alias, unlike</em> <tt class="docutils literal"><span class="pre">/room/{roomId}/join</span></tt>.</p>
<p>This API starts a user participating in a particular room, if that user
is allowed to participate in that room. After this call, the client is
allowed to see all current state events in the room, and all subsequent
events associated with the room until the user leaves the room.</p>
<p>After a user has joined a room, the room will appear as an entry in the
response of the <a class="reference external" href="#get-matrix-client-r0-initialsync"><tt class="docutils literal">/initialSync</tt></a> and <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a> APIs.</p>
<p>If a <tt class="docutils literal">third_party_signed</tt> was supplied, the homeserver must verify
that it matches a pending <tt class="docutils literal">m.room.third_party_invite</tt> event in the
room, and perform key validity checking if required by the event.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomIdOrAlias</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier or alias to
join.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>server_name</td>
<td>[string]</td>
<td>The servers to attempt to join the room through.
One of the servers must be participating in the
room.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>third_party_signed</td>
<td>Third Party Signed</td>
<td>A signature of an <tt class="docutils literal">m.third_party_invite</tt> token
to prove that this user owns a third party
identity which has been invited to the room.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Third Party Signed</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix ID of the user who issued
the invite.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix ID of the invitee.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td><strong>Required.</strong> The state key of the
m.third_party_invite event.</td>
</tr>
<tr><td>signatures</td>
<td>Signatures</td>
<td><strong>Required.</strong> A signatures object containing a
signature of the entire signed object.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The joined room ID.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/join/%23monkeys%3Amatrix.org?server_name=matrix.org&amp;server_name=elsewhere.ca</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;third_party_signed&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;random8nonce&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;example.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ed25519:0&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;some9signature&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The room has been joined.</p>
<p>The joined room ID must be returned in the <tt class="docutils literal">room_id</tt> field.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!d41d8cd:matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You do not have permission to join the room. A meaningful <tt class="docutils literal">errcode</tt> and description error text will be returned. Example reasons for rejection are:</p>
<ul class="simple">
<li>The room is invite-only and the user was not invited.</li>
<li>The user has been banned from the room.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;You are not invited to this room.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="leaving-rooms"></a></p>
<div class="section" id="leaving-rooms">
<h3><a class="toc-backref" href="#id325">10.4.3&nbsp;&nbsp;&nbsp;Leaving rooms</a></h3>
<p>A user can leave a room to stop receiving events for that room. A user must
have been invited to or have joined the room before they are eligible to leave
the room. Leaving a room to which the user has been invited rejects the invite.
Once a user leaves a room, it will no longer appear in the response to the
<a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a> API unless it is explicitly requested via a filter with the
<tt class="docutils literal">include_leave</tt> field set to <tt class="docutils literal">true</tt>.</p>
<p>Whether or not they actually joined the room, if the room is an &quot;invite-only&quot;
room the user will need to be re-invited before they can re-join the room.</p>
<p>A user can also forget a room which they have left. Rooms which have been
forgotten will never appear the response to the <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a> API, until the user
re-joins or is re-invited.</p>
<p>A user may wish to force another user to leave a room. This can be done by
'kicking' the other user. To do so, the user performing the kick MUST have the
required power level. Once a user has been kicked, the behaviour is the same as
if they had left of their own accord. In particular, the user is free to
re-join if the room is not &quot;invite-only&quot;.</p>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-leave"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-leave">
<h4><a class="toc-backref" href="#id326">10.4.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/leave</span></tt></a></h4>
<p>This API stops a user participating in a particular room.</p>
<p>If the user was already in the room, they will no longer be able to see
new events in the room. If the room requires an invite to join, they
will need to be re-invited before they can re-join.</p>
<p>If the user was invited to the room, but had not joined, this call
serves to reject the invite.</p>
<p>The user will still be allowed to retrieve history from the room which
they were previously allowed to see.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier to leave.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21nkl290a%3Amatrix.org/leave</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The room has been left.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-forget"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-forget">
<h4><a class="toc-backref" href="#id327">10.4.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/forget</span></tt></a></h4>
<p>This API stops a user remembering about a particular room.</p>
<p>In general, history is a first class citizen in Matrix. After this API
is called, however, a user will no longer be able to retrieve history
for this room. If all users on a homeserver forget a room, the room is
eligible for deletion from that homeserver.</p>
<p>If the user is currently joined to the room, they must leave the room
before calling this API.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier to forget.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21au1ba7o%3Amatrix.org/forget</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The room has been forgotten.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The user has not left the room</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;User &#64;example:matrix.org is in room !au1ba7o:matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-kick"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-kick">
<h4><a class="toc-backref" href="#id328">10.4.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/kick</span></tt></a></h4>
<p>Kick a user from the room.</p>
<p>The caller must have the required power level in order to perform this operation.</p>
<p>Kicking a user adjusts the target member's membership state to be <tt class="docutils literal">leave</tt> with an
optional <tt class="docutils literal">reason</tt>. Like with other membership changes, a user can directly adjust
the target member's state by making a request to <tt class="docutils literal"><span class="pre">/rooms/&lt;room</span> <span class="pre">id&gt;/state/m.room.member/&lt;user</span> id&gt;</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier (not alias) from
which the user should be kicked.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The fully qualified user ID of the
user being kicked.</td>
</tr>
<tr><td>reason</td>
<td>string</td>
<td>The reason the user has been kicked. This will be
supplied as the  <tt class="docutils literal">reason</tt> on the target's
updated <a class="reference external" href="#m-room-member">m.room.member</a> event.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21e42d8c%3Amatrix.org/kick</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Telling unfunny jokes&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The user has been kicked from the room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You do not have permission to kick the user from the room. A meaningful <tt class="docutils literal">errcode</tt> and description error text will be returned. Example reasons for rejections are:</p>
<ul class="simple">
<li>The kicker is not currently in the room.</li>
<li>The kickee is not currently in the room.</li>
<li>The kicker's power level is insufficient to kick users from the room.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;You do not have a high enough power level to kick from this room.&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="banning-users-in-a-room"></a></p>
<div class="section" id="banning-users-in-a-room">
<h3><a class="toc-backref" href="#id329">10.4.4&nbsp;&nbsp;&nbsp;Banning users in a room</a></h3>
<p>A user may decide to ban another user in a room. 'Banning' forces the target
user to leave the room and prevents them from re-joining the room. A banned
user will not be treated as a joined user, and so will not be able to send or
receive events in the room. In order to ban someone, the user performing the
ban MUST have the required power level. To ban a user, a request should be made
to <a class="reference external" href="#post-matrix-client-r0-rooms-roomid-ban"><tt class="docutils literal"><span class="pre">/rooms/&lt;room_id&gt;/ban</span></tt></a> with:</p>
<pre class="literal-block">
{
  &quot;user_id&quot;: &quot;&lt;user id to ban&gt;&quot;
  &quot;reason&quot;: &quot;string: &lt;reason for the ban&gt;&quot;
}
</pre>
<p>Banning a user adjusts the banned member's membership state to <tt class="docutils literal">ban</tt>.
Like with other membership changes, a user can directly adjust the target
member's state, by making a request to
<tt class="docutils literal"><span class="pre">/rooms/&lt;room</span> <span class="pre">id&gt;/state/m.room.member/&lt;user</span> id&gt;</tt>:</p>
<pre class="literal-block">
{
  &quot;membership&quot;: &quot;ban&quot;
}
</pre>
<p>A user must be explicitly unbanned with a request to <a class="reference external" href="#post-matrix-client-r0-rooms-roomid-unban"><tt class="docutils literal"><span class="pre">/rooms/&lt;room_id&gt;/unban</span></tt></a>
before they can re-join the room or be re-invited.</p>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-ban"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-ban">
<h4><a class="toc-backref" href="#id330">10.4.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/ban</span></tt></a></h4>
<p>Ban a user in the room. If the user is currently in the room, also kick them.</p>
<p>When a user is banned from a room, they may not join it or be invited to it until they are unbanned.</p>
<p>The caller must have the required power level in order to perform this operation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier (not alias) from
which the user should be banned.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The fully qualified user ID of the
user being banned.</td>
</tr>
<tr><td>reason</td>
<td>string</td>
<td>The reason the user has been banned. This will be
supplied as the <tt class="docutils literal">reason</tt> on the target's updated
<a class="reference external" href="#m-room-member">m.room.member</a> event.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21e42d8c%3Amatrix.org/ban</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Telling unfunny jokes&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The user has been kicked and banned from the room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You do not have permission to ban the user from the room. A meaningful <tt class="docutils literal">errcode</tt> and description error text will be returned. Example reasons for rejections are:</p>
<ul class="simple">
<li>The banner is not currently in the room.</li>
<li>The banner's power level is insufficient to ban users from the room.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;You do not have a high enough power level to ban from this room.&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-unban"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-unban">
<h4><a class="toc-backref" href="#id331">10.4.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/unban</span></tt></a></h4>
<p>Unban a user from the room. This allows them to be invited to the room,
and join if they would otherwise be allowed to join according to its join rules.</p>
<p>The caller must have the required power level in order to perform this operation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier (not alias) from
which the user should be unbanned.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The fully qualified user ID of the
user being unbanned.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21e42d8c%3Amatrix.org/unban</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The user has been unbanned from the room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You do not have permission to unban the user from the room. A meaningful <tt class="docutils literal">errcode</tt> and description error text will be returned. Example reasons for rejections are:</p>
<ul class="simple">
<li>The unbanner's power level is insufficient to unban users from the room.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;You do not have a high enough power level to unban from this room.&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="listing-rooms"></a></p>
<div class="section" id="listing-rooms">
<h2><a class="toc-backref" href="#id332">10.5&nbsp;&nbsp;&nbsp;Listing rooms</a></h2>
<p><a class="anchor" id="get-matrix-client-r0-directory-list-room-roomid"></a></p>
<div class="section" id="get-matrix-client-r0-directory-list-room-roomid">
<h3><a class="toc-backref" href="#id333">10.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/directory/list/room/{roomId}</span></tt></a></h3>
<p>Gets the visibility of a given room on the server's public room directory.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>visibility</td>
<td>enum</td>
<td>The visibility of the room in the directory. One
of: [&quot;private&quot;, &quot;public&quot;]</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/directory/list/room/%21curbf%3Amatrix.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The visibility of the room in the directory</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;visibility&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The room is not known to the server</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Room not found&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-r0-directory-list-room-roomid"></a></p>
<div class="section" id="put-matrix-client-r0-directory-list-room-roomid">
<h3><a class="toc-backref" href="#id334">10.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/directory/list/room/{roomId}</span></tt></a></h3>
<p>Sets the visibility of a given room in the server's public room
directory.</p>
<p>Servers may choose to implement additional access control checks
here, for instance that room visibility can only be changed by
the room creator or a server administrator.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>visibility</td>
<td>enum</td>
<td>The new visibility setting for the room.  Defaults
to 'public'. One of: [&quot;private&quot;, &quot;public&quot;]</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/directory/list/room/%21curbf%3Amatrix.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;visibility&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The visibility was updated, or no change was needed.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The room is not known to the server</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Room not found&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-publicrooms"></a></p>
<div class="section" id="get-matrix-client-r0-publicrooms">
<h3><a class="toc-backref" href="#id335">10.5.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/publicRooms</tt></a></h3>
<p>Lists the public rooms on the server.</p>
<p>This API returns paginated responses. The rooms are ordered by the number
of joined members, with the largest rooms first.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>Limit the number of results returned.</td>
</tr>
<tr><td>since</td>
<td>string</td>
<td>A pagination token from a previous request,
allowing clients to get the next (or previous)
batch of rooms. The direction of pagination is
specified solely by which token is supplied,
rather than via an explicit flag.</td>
</tr>
<tr><td>server</td>
<td>string</td>
<td>The server to fetch the public room lists from.
Defaults to the local server.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[PublicRoomsChunk]</td>
<td><strong>Required.</strong> A paginated chunk of public rooms.</td>
</tr>
<tr><td>next_batch</td>
<td>string</td>
<td>A pagination token for the response. The absence
of this token means there are no more results to
fetch and the client should stop paginating.</td>
</tr>
<tr><td>prev_batch</td>
<td>string</td>
<td>A pagination token that allows fetching previous
results. The absence of this token means there are
no results before this batch, i.e. this is the
first batch.</td>
</tr>
<tr><td>total_room_count_estimate</td>
<td>integer</td>
<td>An estimate on the total number of public rooms,
if the server has an estimate.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PublicRoomsChunk</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>aliases</td>
<td>[string]</td>
<td>Aliases of the room. May be empty.</td>
</tr>
<tr><td>canonical_alias</td>
<td>string</td>
<td>The canonical alias of the room, if any.</td>
</tr>
<tr><td>name</td>
<td>string</td>
<td>The name of the room, if any.</td>
</tr>
<tr><td>num_joined_members</td>
<td>integer</td>
<td><strong>Required.</strong> The number of members joined to the
room.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room.</td>
</tr>
<tr><td>topic</td>
<td>string</td>
<td>The topic of the room, if any.</td>
</tr>
<tr><td>world_readable</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the room may be viewed by
guest users without joining.</td>
</tr>
<tr><td>guest_can_join</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether guest users may join the
room and participate in it. If they can, they will
be subject to ordinary power level rules like any
other user.</td>
</tr>
<tr><td>avatar_url</td>
<td>string</td>
<td>The URL for the room's avatar, if one is set.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/publicRooms</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of the rooms on the server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;#murrays:cheese.bar&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://bleeker.street/CHEDDARandBRIE&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;guest_can_join&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
      <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;CHEESE&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;num_joined_members&quot;</span><span class="punctuation">:</span> <span class="literal number integer">37</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!ol19s:bleecker.street&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Tasty tasty cheese&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;world_readable&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;next_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;p190q&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;prev_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;p1902&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;total_room_count_estimate&quot;</span><span class="punctuation">:</span> <span class="literal number integer">115</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-publicrooms"></a></p>
<div class="section" id="post-matrix-client-r0-publicrooms">
<h3><a class="toc-backref" href="#id336">10.5.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/publicRooms</tt></a></h3>
<p>Lists the public rooms on the server, with optional filter.</p>
<p>This API returns paginated responses. The rooms are ordered by the number
of joined members, with the largest rooms first.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>server</td>
<td>string</td>
<td>The server to fetch the public room lists from.
Defaults to the local server.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>Limit the number of results returned.</td>
</tr>
<tr><td>since</td>
<td>string</td>
<td>A pagination token from a previous request,
allowing clients to get the next (or previous)
batch of rooms.  The direction of pagination is
specified solely by which token is supplied,
rather than via an explicit flag.</td>
</tr>
<tr><td>filter</td>
<td>Filter</td>
<td>Filter to apply to the results.</td>
</tr>
<tr><td>include_all_networks</td>
<td>boolean</td>
<td>Whether or not to include all known
networks/protocols from application services on
the homeserver. Defaults to false.</td>
</tr>
<tr><td>third_party_instance_id</td>
<td>string</td>
<td>The specific third party network/protocol to
request from the homeserver. Can only be used if
<tt class="docutils literal">include_all_networks</tt> is false.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Filter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>generic_search_term</td>
<td>string</td>
<td>A string to search for in the room metadata, e.g.
name, topic, canonical alias etc. (Optional).</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[PublicRoomsChunk]</td>
<td><strong>Required.</strong> A paginated chunk of public rooms.</td>
</tr>
<tr><td>next_batch</td>
<td>string</td>
<td>A pagination token for the response. The absence
of this token means there are no more results to
fetch and the client should stop paginating.</td>
</tr>
<tr><td>prev_batch</td>
<td>string</td>
<td>A pagination token that allows fetching previous
results. The absence of this token means there are
no results before this batch, i.e. this is the
first batch.</td>
</tr>
<tr><td>total_room_count_estimate</td>
<td>integer</td>
<td>An estimate on the total number of public rooms,
if the server has an estimate.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PublicRoomsChunk</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>aliases</td>
<td>[string]</td>
<td>Aliases of the room. May be empty.</td>
</tr>
<tr><td>canonical_alias</td>
<td>string</td>
<td>The canonical alias of the room, if any.</td>
</tr>
<tr><td>name</td>
<td>string</td>
<td>The name of the room, if any.</td>
</tr>
<tr><td>num_joined_members</td>
<td>integer</td>
<td><strong>Required.</strong> The number of members joined to the
room.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room.</td>
</tr>
<tr><td>topic</td>
<td>string</td>
<td>The topic of the room, if any.</td>
</tr>
<tr><td>world_readable</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the room may be viewed by
guest users without joining.</td>
</tr>
<tr><td>guest_can_join</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether guest users may join the
room and participate in it. If they can, they will
be subject to ordinary power level rules like any
other user.</td>
</tr>
<tr><td>avatar_url</td>
<td>string</td>
<td>The URL for the room's avatar, if one is set.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/publicRooms</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="literal number integer">10</span><span class="punctuation">,</span>
  <span class="name tag">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;generic_search_term&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;include_all_networks&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
  <span class="name tag">&quot;third_party_instance_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;irc&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of the rooms on the server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;#murrays:cheese.bar&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://bleeker.street/CHEDDARandBRIE&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;guest_can_join&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
      <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;CHEESE&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;num_joined_members&quot;</span><span class="punctuation">:</span> <span class="literal number integer">37</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!ol19s:bleecker.street&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Tasty tasty cheese&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;world_readable&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;next_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;p190q&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;prev_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;p1902&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;total_room_count_estimate&quot;</span><span class="punctuation">:</span> <span class="literal number integer">115</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="user-data"></a></p>
<div class="section" id="user-data">
<h1><a class="toc-backref" href="#id337">11&nbsp;&nbsp;&nbsp;User Data</a></h1>
<p><a class="anchor" id="user-directory"></a></p>
<div class="section" id="user-directory">
<h2><a class="toc-backref" href="#id338">11.1&nbsp;&nbsp;&nbsp;User Directory</a></h2>
<p><a class="anchor" id="post-matrix-client-r0-user-directory-search"></a></p>
<div class="section" id="post-matrix-client-r0-user-directory-search">
<h3><a class="toc-backref" href="#id339">11.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/user_directory/search</tt></a></h3>
<p>Performs a search for users on the homeserver. The homeserver may
determine which subset of users are searched, however the homeserver
MUST at a minimum consider the users the requesting user shares a
room with and those who reside in public rooms (known to the homeserver).
The search MUST consider local users to the homeserver, and SHOULD
query remote users as part of the search.</p>
<p>The search is performed case-insensitively on user IDs and display
names preferably using a collation determined based upon the
<tt class="docutils literal"><span class="pre">Accept-Language</span></tt> header provided in the request, if present.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>search_term</td>
<td>string</td>
<td><strong>Required.</strong> The term to search for</td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of results to return. Defaults
to 10.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>results</td>
<td>[User]</td>
<td><strong>Required.</strong> Ordered by rank and then whether or
not profile info is available.</td>
</tr>
<tr><td>limited</td>
<td>boolean</td>
<td><strong>Required.</strong> Indicates if the result list has
been truncated by the limit.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>User</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The user's matrix user ID.</td>
</tr>
<tr><td>display_name</td>
<td>string</td>
<td>The display name of the user, if one exists.</td>
</tr>
<tr><td>avatar_url</td>
<td>string</td>
<td>The avatar url, as an MXC, if one exists.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/user_directory/search</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;search_term&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="literal number integer">10</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The results of the search.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;results&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;foo:bar.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Foo&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://bar.com/foo&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;limited&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="profiles"></a></p>
<div class="section" id="profiles">
<h2><a class="toc-backref" href="#id340">11.2&nbsp;&nbsp;&nbsp;Profiles</a></h2>
<p><a class="anchor" id="put-matrix-client-r0-profile-userid-displayname"></a></p>
<div class="section" id="put-matrix-client-r0-profile-userid-displayname">
<h3><a class="toc-backref" href="#id341">11.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/profile/{userId}/displayname</span></tt></a></h3>
<p>This API sets the given user's display name. You must have permission to
set this user's display name, e.g. you need to have their <tt class="docutils literal">access_token</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose display name to set.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>displayname</td>
<td>string</td>
<td>The new display name for this user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/profile/%40alice%3Aexample.com/displayname</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The display name was set.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-profile-userid-displayname"></a></p>
<div class="section" id="get-matrix-client-r0-profile-userid-displayname">
<h3><a class="toc-backref" href="#id342">11.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/profile/{userId}/displayname</span></tt></a></h3>
<p>Get the user's display name. This API may be used to fetch the user's
own displayname or to query the name of other users; either locally or
on remote homeservers.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose display name to get.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>displayname</td>
<td>string</td>
<td>The user's display name if they have set one,
otherwise not present.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/profile/%40alice%3Aexample.com/displayname</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The display name for this user.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>There is no display name for this user or this user does not exist.</p>
</div>
<p><a class="anchor" id="put-matrix-client-r0-profile-userid-avatar-url"></a></p>
<div class="section" id="put-matrix-client-r0-profile-userid-avatar-url">
<h3><a class="toc-backref" href="#id343">11.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/profile/{userId}/avatar_url</span></tt></a></h3>
<p>This API sets the given user's avatar URL. You must have permission to
set this user's avatar URL, e.g. you need to have their <tt class="docutils literal">access_token</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose avatar URL to set.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>avatar_url</td>
<td>string</td>
<td>The new avatar URL for this user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/profile/%40alice%3Aexample.com/avatar_url</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://matrix.org/wefh34uihSDRGhw34&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The avatar URL was set.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-profile-userid-avatar-url"></a></p>
<div class="section" id="get-matrix-client-r0-profile-userid-avatar-url">
<h3><a class="toc-backref" href="#id344">11.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/profile/{userId}/avatar_url</span></tt></a></h3>
<p>Get the user's avatar URL. This API may be used to fetch the user's
own avatar URL or to query the URL of other users; either locally or
on remote homeservers.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose avatar URL to get.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The user's avatar URL if they have set one,
otherwise not present.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/profile/%40alice%3Aexample.com/avatar_url</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The avatar URL for this user.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://matrix.org/SDGdghriugerRg&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>There is no avatar URL for this user or this user does not exist.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-profile-userid"></a></p>
<div class="section" id="get-matrix-client-r0-profile-userid">
<h3><a class="toc-backref" href="#id345">11.2.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/profile/{userId}</span></tt></a></h3>
<p>Get the combined profile information for this user. This API may be used
to fetch the user's own profile information or other users; either
locally or on remote homeservers. This API may return keys which are not
limited to <tt class="docutils literal">displayname</tt> or <tt class="docutils literal">avatar_url</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose profile information
to get.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The user's avatar URL if they have set one,
otherwise not present.</td>
</tr>
<tr><td>displayname</td>
<td>string</td>
<td>The user's display name if they have set one,
otherwise not present.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/profile/%40alice%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The avatar URL for this user.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://matrix.org/SDGdghriugerRg&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>There is no profile information for this user or this user does not exist.</p>
</div>
<p><a class="anchor" id="events-on-change-of-profile-information"></a></p>
<div class="section" id="events-on-change-of-profile-information">
<h3><a class="toc-backref" href="#id346">11.2.6&nbsp;&nbsp;&nbsp;Events on Change of Profile Information</a></h3>
<p>Because the profile display name and avatar information are likely to be used in
many places of a client's display, changes to these fields cause an automatic
propagation event to occur, informing likely-interested parties of the new
values. This change is conveyed using two separate mechanisms:</p>
<ul class="simple">
<li>a <tt class="docutils literal">m.room.member</tt> event (with a <tt class="docutils literal">join</tt> membership) is sent to every room
the user is a member of, to update the <tt class="docutils literal">displayname</tt> and <tt class="docutils literal">avatar_url</tt>.</li>
<li>a <tt class="docutils literal">m.presence</tt> presence status update is sent, again containing the new
values of the <tt class="docutils literal">displayname</tt> and <tt class="docutils literal">avatar_url</tt> keys, in addition to the
required <tt class="docutils literal">presence</tt> key containing the current presence state of the user.</li>
</ul>
<p>Both of these should be done automatically by the homeserver when a user
successfully changes their display name or avatar URL fields.</p>
<p>Additionally, when homeservers emit room membership events for their own
users, they should include the display name and avatar URL fields in these
events so that clients already have these details to hand, and do not have to
perform extra round trips to query it.</p>
</div>
</div>
</div>
<p><a class="anchor" id="security"></a></p>
<div class="section" id="security">
<h1><a class="toc-backref" href="#id347">12&nbsp;&nbsp;&nbsp;Security</a></h1>
<p><a class="anchor" id="rate-limiting"></a></p>
<div class="section" id="rate-limiting">
<h2><a class="toc-backref" href="#id348">12.1&nbsp;&nbsp;&nbsp;Rate limiting</a></h2>
<p>Homeservers SHOULD implement rate limiting to reduce the risk of being
overloaded. If a request is refused due to rate limiting, it should return a
standard error response of the form:</p>
<pre class="literal-block">
{
  &quot;errcode&quot;: &quot;M_LIMIT_EXCEEDED&quot;,
  &quot;error&quot;: &quot;string&quot;,
  &quot;retry_after_ms&quot;: integer (optional)
}
</pre>
<p>The <tt class="docutils literal">retry_after_ms</tt> key SHOULD be included to tell the client how long they
have to wait in milliseconds before they can try again.</p>
<!-- TODO-spec
- Surely we should recommend an algorithm for the rate limiting, rather than letting every
  homeserver come up with their own idea, causing totally unpredictable performance over
  federated rooms? -->
<!-- References -->
<!-- Links through the external API docs are below -->
<!-- ============================================= -->
<!-- Copyright 2016 OpenMarket Ltd -->
<!-- Copyright 2019 The Matrix.org Foundation C.I.C. -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="modules"></a></p>
<div class="section" id="modules">
<h1><a class="toc-backref" href="#id349">13&nbsp;&nbsp;&nbsp;Modules</a></h1>
<p>Modules are parts of the Client-Server API which are not universal to all
endpoints. Modules are strictly defined within this specification and
should not be mistaken for experimental extensions or optional features.
A compliant server implementation MUST support all modules and supporting
specification (unless the implementation only targets clients of certain
profiles, in which case only the required modules for those feature profiles
MUST be implemented). A compliant client implementation MUST support all
the required modules and supporting specification for the <a class="reference external" href="#feature-profiles">Feature Profile</a>
it targets.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!-- Copyright 2019 The Matrix.org Foundation C.I.C. -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
<p><a class="anchor" id="feature-profiles"></a></p>
<div class="section" id="feature-profiles">
<h2><a class="toc-backref" href="#id350">13.1&nbsp;&nbsp;&nbsp;Feature Profiles</a></h2>
<p id="sect-feature-profiles">Matrix supports many different kinds of clients: from embedded IoT devices to
desktop clients. Not all clients can provide the same feature sets as other
clients e.g. due to lack of physical hardware such as not having a screen.
Clients can fall into one of several profiles and each profile contains a set
of features that the client MUST support. This section details a set of
&quot;feature profiles&quot;. Clients are expected to implement a profile in its entirety
in order for it to be classified as that profile.</p>
<p><a class="anchor" id="summary"></a></p>
<div class="section" id="summary">
<h3><a class="toc-backref" href="#id351">13.1.1&nbsp;&nbsp;&nbsp;Summary</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="43%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Module / Profile</th>
<th class="head">Web</th>
<th class="head">Mobile</th>
<th class="head">Desktop</th>
<th class="head">CLI</th>
<th class="head">Embedded</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><a class="reference internal" href="#module-im">Instant Messaging</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-dm">Direct Messaging</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-mentions">Mentions</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-presence">Presence</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-push">Push Notifications</a></td>
<td>Optional</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-receipts">Receipts</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-read-markers">Fully read markers</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-typing">Typing Notifications</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-voip">VoIP</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-ignore-users">Ignoring Users</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-report-content">Reporting Content</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-content">Content Repository</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-history-visibility">Managing History Visibility</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-search">Server Side Search</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-room-upgrades">Room Upgrades</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-admin">Server Administration</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-event-context">Event Context</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-third-party-networks">Third Party Networks</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-to-device">Send-to-Device Messaging</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-device-management">Device Management</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-e2e">End-to-End Encryption</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-guest-access">Guest Accounts</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-room-previews">Room Previews</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-account-data">Client Config</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-sso-login">SSO Login</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-openid">OpenID</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-stickers">Stickers</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-server-acls">Server ACLs</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference external" href="#server-notices">Server Notices</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
</tbody>
</table>
<p><em>Please see each module for more details on what clients need to implement.</em></p>
<!-- Server Notices already has a link elsewhere. -->
</div>
<p><a class="anchor" id="clients"></a></p>
<div class="section" id="clients">
<h3><a class="toc-backref" href="#id352">13.1.2&nbsp;&nbsp;&nbsp;Clients</a></h3>
<p><a class="anchor" id="stand-alone-web-web"></a></p>
<div class="section" id="stand-alone-web-web">
<h4><a class="toc-backref" href="#id353">13.1.2.1&nbsp;&nbsp;&nbsp;Stand-alone web (<tt class="docutils literal">Web</tt>)</a></h4>
<p>This is a web page which heavily uses Matrix for communication. Single-page web
apps would be classified as a stand-alone web client, as would multi-page web
apps which use Matrix on nearly every page.</p>
</div>
<p><a class="anchor" id="mobile-mobile"></a></p>
<div class="section" id="mobile-mobile">
<h4><a class="toc-backref" href="#id354">13.1.2.2&nbsp;&nbsp;&nbsp;Mobile (<tt class="docutils literal">Mobile</tt>)</a></h4>
<p>This is a Matrix client specifically designed for consumption on mobile devices.
This is typically a mobile app but need not be so provided the feature set can
be reached (e.g. if a mobile site could display push notifications it could be
classified as a mobile client).</p>
</div>
<p><a class="anchor" id="desktop-desktop"></a></p>
<div class="section" id="desktop-desktop">
<h4><a class="toc-backref" href="#id355">13.1.2.3&nbsp;&nbsp;&nbsp;Desktop (<tt class="docutils literal">Desktop</tt>)</a></h4>
<p>This is a native GUI application which can run in its own environment outside a
browser.</p>
</div>
<p><a class="anchor" id="command-line-interface-cli"></a></p>
<div class="section" id="command-line-interface-cli">
<h4><a class="toc-backref" href="#id356">13.1.2.4&nbsp;&nbsp;&nbsp;Command Line Interface (<tt class="docutils literal">CLI</tt>)</a></h4>
<p>This is a client which is used via a text-based terminal.</p>
</div>
<p><a class="anchor" id="embedded-embedded"></a></p>
<div class="section" id="embedded-embedded">
<h4><a class="toc-backref" href="#id357">13.1.2.5&nbsp;&nbsp;&nbsp;Embedded (<tt class="docutils literal">Embedded</tt>)</a></h4>
<p>This is a client which is embedded into another application or an embedded
device.</p>
<p><a class="anchor" id="application"></a></p>
<div class="section" id="application">
<h5><a class="toc-backref" href="#id358">13.1.2.5.1&nbsp;&nbsp;&nbsp;Application</a></h5>
<p>This is a Matrix client which is embedded in another website, e.g. using
iframes. These embedded clients are typically for a single purpose
related to the website in question, and are not intended to be fully-fledged
communication apps.</p>
</div>
<p><a class="anchor" id="device"></a></p>
<div class="section" id="device">
<h5><a class="toc-backref" href="#id359">13.1.2.5.2&nbsp;&nbsp;&nbsp;Device</a></h5>
<p>This is a client which is typically running on an embedded device such as a
kettle, fridge or car. These clients tend to perform a few operations and run
in a resource constrained environment. Like embedded applications, they are
not intended to be fully-fledged communication systems.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
</div>
</div>
<p><a class="anchor" id="id86"></a></p>
<div class="section" id="id86">
<h2><a class="toc-backref" href="#id360">13.2&nbsp;&nbsp;&nbsp;Instant Messaging</a></h2>
<p id="module-im">This module adds support for sending human-readable messages to a room. It also
adds support for associating human-readable information with the room itself
such as a room name and topic.</p>
<p><a class="anchor" id="id87"></a></p>
<div class="section" id="id87">
<h3><a class="toc-backref" href="#id361">13.2.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-room-message"></a></p>
<div class="section" id="m-room-message">
<h4><a class="toc-backref" href="#id362">13.2.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.message</tt></a></h4>
<p><em>Message Event</em></p>
<p>This event is used when sending messages in a room. Messages are not limited to be text. The <tt class="docutils literal">msgtype</tt> key outlines the type of message, e.g. text, audio, image, video, etc. The <tt class="docutils literal">body</tt> key is text and MUST be used with every kind of <tt class="docutils literal">msgtype</tt> as a fallback mechanism for when a client cannot render a message. This allows clients to display <em>something</em> even if it is just plain text. For more information on <tt class="docutils literal">msgtypes</tt>, see <a class="reference internal" href="#m-room-message-msgtypes">m.room.message msgtypes</a>.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> The textual representation of this
message.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td><strong>Required.</strong> The type of message, e.g.
<tt class="docutils literal">m.image</tt>, <tt class="docutils literal">m.text</tt></td>
</tr>
</tbody>
</table>
<p>Examples:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bee Gees - Stayin' Alive&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2140786</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;audio/mpeg&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1563685</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.audio&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/ffed755USFFxlgbQYZGtryd&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;thinks this is an example emote&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;thinks &lt;b&gt;this&lt;/b&gt; is an example emote&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.emote&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.doc&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.doc&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;application/msword&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.file&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;filename.jpg&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">398</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">31037</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">394</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.image&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/JWEIFJgwEIhweiWJE&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Big Ben, London, UK&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;geo_uri&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;geo:51.5008,0.1247&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;thumbnail_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span><span class="punctuation">,</span>
                <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span><span class="punctuation">,</span>
                <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;thumbnail_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.location&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example notice&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an &lt;strong&gt;example&lt;/strong&gt; notice&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.notice&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;admin_contact&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mailto:server.admin&#64;example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Human-readable message to explain the notice&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;limit_type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monthly_active_user&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.server_notice&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;server_notice_type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.server_notice.usage_limit_reached&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Gangnam Style&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2140786</span><span class="punctuation">,</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">320</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;video/mp4&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1563685</span><span class="punctuation">,</span>
            <span class="name tag">&quot;thumbnail_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span><span class="punctuation">,</span>
                <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span><span class="punctuation">,</span>
                <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;thumbnail_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">480</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.video&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/a526eYUSFFxlgbQYZmo442&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-message-feedback"></a></p>
<div class="section" id="m-room-message-feedback">
<h4><a class="toc-backref" href="#id363">13.2.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.message.feedback</tt></a></h4>
<p><em>Message Event</em></p>
<p><strong>NB: Usage of this event is discouraged in favour of the</strong> <a class="reference internal" href="#module-receipts">receipts module</a>. <strong>Most clients will not recognise this event.</strong> Feedback events are events sent to acknowledge a message in some way. There are two supported acknowledgements: <tt class="docutils literal">delivered</tt> (sent when the event has been received) and <tt class="docutils literal">read</tt> (sent when the event has been observed by the end-user). The <tt class="docutils literal">target_event_id</tt> should reference the <tt class="docutils literal">m.room.message</tt> event being acknowledged.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>target_event_id</td>
<td>string</td>
<td><strong>Required.</strong> The event that this feedback is
related to.</td>
</tr>
<tr><td>type</td>
<td>enum</td>
<td><strong>Required.</strong> The type of feedback. One of:
[&quot;delivered&quot;, &quot;read&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;target_event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WEIGFHFW:localhost&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;delivered&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message.feedback&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<dl class="docutils">
<dt>Usage of this event is discouraged for several reasons:</dt>
<dd><ul class="first last simple">
<li>The number of feedback events will grow very quickly with the number of users
in the room. This event provides no way to &quot;batch&quot; feedback, unlike the
<a class="reference internal" href="#module-receipts">receipts module</a>.</li>
<li>Pairing feedback to messages gets complicated when paginating as feedback
arrives before the message it is acknowledging.</li>
<li>There are no guarantees that the client has seen the event ID being
acknowledged.</li>
</ul>
</dd>
</dl>
</div>
<p><a class="anchor" id="m-room-name"></a></p>
<div class="section" id="m-room-name">
<h4><a class="toc-backref" href="#id364">13.2.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.name</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>A room has an opaque room ID which is not human-friendly to read. A room
alias is human-friendly, but not all rooms have room aliases. The room name
is a human-friendly string designed to be displayed to the end-user. The
room name is not unique, as multiple rooms can have the same room name set.</p>
<p>A room with an <tt class="docutils literal">m.room.name</tt> event with an absent, null, or empty
<tt class="docutils literal">name</tt> field should be treated the same as a room with no <tt class="docutils literal">m.room.name</tt>
event.</p>
<p>An event of this type is automatically created when creating a room using
<tt class="docutils literal">/createRoom</tt> with the <tt class="docutils literal">name</tt> key.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>name</td>
<td>string</td>
<td><strong>Required.</strong> The name of the room. This MUST NOT
exceed 255 bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The room name&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.name&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-topic"></a></p>
<div class="section" id="m-room-topic">
<h4><a class="toc-backref" href="#id365">13.2.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.topic</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>A topic is a short message detailing what is currently being discussed in the room.  It can also be used as a way to display extra information about the room, which may not be suitable for the room name. The room topic can also be set when creating a room using <tt class="docutils literal">/createRoom</tt> with the <tt class="docutils literal">topic</tt> key.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>topic</td>
<td>string</td>
<td><strong>Required.</strong> The topic text.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;A room topic&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.topic&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-avatar"></a></p>
<div class="section" id="m-room-avatar">
<h4><a class="toc-backref" href="#id366">13.2.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.avatar</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>A picture that is associated with the room. This can be displayed alongside the room information.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>info</td>
<td>ImageInfo</td>
<td>Metadata about the image referred to in <tt class="docutils literal">url</tt>.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td><strong>Required.</strong> The URL to the image.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ImageInfo</caption>
<thead valign="bottom">
<tr><th class="head">ImageInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The intended display height of the image in
pixels. This may differ from the intrinsic
dimensions of the image file.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The intended display width of the image in pixels.
This may differ from the intrinsic dimensions of
the image file.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL (typically <a class="reference internal" href="#mxc-uri">MXC URI</a>) to a thumbnail of
the image. Only present if the thumbnail is
unencrypted.</td>
</tr>
<tr><td>thumbnail_file</td>
<td>EncryptedFile</td>
<td>Information on the encrypted thumbnail file, as
specified in <a class="reference internal" href="#encrypted-files">End-to-end encryption</a>. Only present if
the thumbnail is encrypted.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>ThumbnailInfo</td>
<td>Metadata about the image referred to in
<tt class="docutils literal">thumbnail_url</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ThumbnailInfo</caption>
<thead valign="bottom">
<tr><th class="head">ThumbnailInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The intended display height of the image in
pixels. This may differ from the intrinsic
dimensions of the image file.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The intended display width of the image in pixels.
This may differ from the intrinsic dimensions of
the image file.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">398</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">31037</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">394</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/JWEIFJgwEIhweiWJE&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.avatar&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-pinned-events"></a></p>
<div class="section" id="m-room-pinned-events">
<h4><a class="toc-backref" href="#id367">13.2.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.pinned_events</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This event is used to &quot;pin&quot; particular events in a room for other participants to review later. The order of the pinned events is guaranteed and based upon the order supplied in the event. Clients should be aware that the current user may not be able to see some of the events pinned due to visibility settings in the room. Clients are responsible for determining if a particular event in the pinned list is displayable, and have the option to not display it if it cannot be pinned in the client.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>pinned</td>
<td>[string]</td>
<td><strong>Required.</strong> An ordered list of event IDs to pin.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;pinned&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;$someevent:example.org&quot;</span>
        <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.pinned_events&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-message-msgtypes"></a></p>
<div class="section" id="m-room-message-msgtypes">
<h4><a class="toc-backref" href="#id368">13.2.1.7&nbsp;&nbsp;&nbsp;m.room.message msgtypes</a></h4>
<p>Each <a class="reference internal" href="#m-room-message">m.room.message</a> MUST have a <tt class="docutils literal">msgtype</tt> key which identifies the type
of message being sent. Each type has their own required and optional keys, as
outlined below. If a client cannot display the given <tt class="docutils literal">msgtype</tt> then it SHOULD
display the fallback plain text <tt class="docutils literal">body</tt> key instead.</p>
<p>Some message types support HTML in the event content that clients should prefer
to display if available. Currently <tt class="docutils literal">m.text</tt>, <tt class="docutils literal">m.emote</tt>, and <tt class="docutils literal">m.notice</tt>
support an additional <tt class="docutils literal">format</tt> parameter of <tt class="docutils literal">org.matrix.custom.html</tt>. When
this field is present, a <tt class="docutils literal">formatted_body</tt> with the HTML must be provided. The
plain text version of the HTML should be provided in the <tt class="docutils literal">body</tt>.</p>
<p>Clients should limit the HTML they render to avoid Cross-Site Scripting, HTML
injection, and similar attacks. The strongly suggested set of HTML tags to permit,
denying the use and rendering of anything else, is: <tt class="docutils literal">font</tt>, <tt class="docutils literal">del</tt>, <tt class="docutils literal">h1</tt>,
<tt class="docutils literal">h2</tt>, <tt class="docutils literal">h3</tt>, <tt class="docutils literal">h4</tt>, <tt class="docutils literal">h5</tt>, <tt class="docutils literal">h6</tt>, <tt class="docutils literal">blockquote</tt>, <tt class="docutils literal">p</tt>, <tt class="docutils literal">a</tt>, <tt class="docutils literal">ul</tt>,
<tt class="docutils literal">ol</tt>, <tt class="docutils literal">sup</tt>, <tt class="docutils literal">sub</tt>, <tt class="docutils literal">li</tt>, <tt class="docutils literal">b</tt>, <tt class="docutils literal">i</tt>, <tt class="docutils literal">u</tt>, <tt class="docutils literal">strong</tt>, <tt class="docutils literal">em</tt>,
<tt class="docutils literal">strike</tt>, <tt class="docutils literal">code</tt>, <tt class="docutils literal">hr</tt>, <tt class="docutils literal">br</tt>, <tt class="docutils literal">div</tt>, <tt class="docutils literal">table</tt>, <tt class="docutils literal">thead</tt>, <tt class="docutils literal">tbody</tt>,
<tt class="docutils literal">tr</tt>, <tt class="docutils literal">th</tt>, <tt class="docutils literal">td</tt>, <tt class="docutils literal">caption</tt>, <tt class="docutils literal">pre</tt>, <tt class="docutils literal">span</tt>, <tt class="docutils literal">img</tt>.</p>
<p>Not all attributes on those tags should be permitted as they may be avenues for
other disruption attempts, such as adding <tt class="docutils literal">onclick</tt> handlers or excessively
large text. Clients should only permit the attributes listed for the tags below.
Where <tt class="docutils literal"><span class="pre">data-mx-bg-color</span></tt> and <tt class="docutils literal"><span class="pre">data-mx-color</span></tt> are listed, clients should
translate the value (a 6-character hex color code) to the appropriate CSS/attributes
for the tag.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name"><tt class="docutils literal">font</tt>:</th><td class="field-body"><tt class="docutils literal"><span class="pre">data-mx-bg-color</span></tt>, <tt class="docutils literal"><span class="pre">data-mx-color</span></tt></td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">span</tt>:</th><td class="field-body"><tt class="docutils literal"><span class="pre">data-mx-bg-color</span></tt>, <tt class="docutils literal"><span class="pre">data-mx-color</span></tt></td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">a</tt>:</th><td class="field-body"><tt class="docutils literal">name</tt>, <tt class="docutils literal">target</tt>, <tt class="docutils literal">href</tt> (provided the value is not relative and has a scheme
matching one of: <tt class="docutils literal">https</tt>, <tt class="docutils literal">http</tt>, <tt class="docutils literal">ftp</tt>, <tt class="docutils literal">mailto</tt>, <tt class="docutils literal">magnet</tt>)</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">img</tt>:</th><td class="field-body"><tt class="docutils literal">width</tt>, <tt class="docutils literal">height</tt>, <tt class="docutils literal">alt</tt>, <tt class="docutils literal">title</tt>, <tt class="docutils literal">src</tt> (provided it is a <a class="reference internal" href="#module-content">Matrix Content (MXC) URI</a>)</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">ol</tt>:</th><td class="field-body"><tt class="docutils literal">start</tt></td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">code</tt>:</th><td class="field-body"><tt class="docutils literal">class</tt> (only classes which start with <tt class="docutils literal">language-</tt> for syntax highlighting)</td>
</tr>
</tbody>
</table>
<p>Additionally, web clients should ensure that <em>all</em> <tt class="docutils literal">a</tt> tags get a <tt class="docutils literal"><span class="pre">rel=&quot;noopener&quot;</span></tt>
to prevent the target page from referencing the client's tab/window.</p>
<p>Tags must not be nested more than 100 levels deep. Clients should only support the subset
of tags they can render, falling back to other representations of the tags where possible.
For example, a client may not be able to render tables correctly and instead could fall
back to rendering tab-delimited text.</p>
<p>In addition to not rendering unsafe HTML, clients should not emit unsafe HTML in events.
Likewise, clients should not generate HTML that is not needed, such as extra paragraph tags
surrounding text due to Rich Text Editors. HTML included in events should otherwise be valid,
such as having appropriate closing tags, appropriate attributes (considering the custom ones
defined in this specification), and generally valid structure.</p>
<p>A special tag, <tt class="docutils literal"><span class="pre">mx-reply</span></tt>, may appear on rich replies (described below) and should be
allowed if, and only if, the tag appears as the very first tag in the <tt class="docutils literal">formatted_body</tt>.
The tag cannot be nested and cannot be located after another tag in the tree. Because the
tag contains HTML, an <tt class="docutils literal"><span class="pre">mx-reply</span></tt> is expected to have a partner closing tag and should
be treated similar to a <tt class="docutils literal">div</tt>. Clients that support rich replies will end up stripping
the tag and its contents and therefore may wish to exclude the tag entirely.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A future iteration of the specification will support more powerful and extensible
message formatting options, such as the proposal <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1225">MSC1225</a>.</p>
</div>
<p><a class="anchor" id="m-text"></a></p>
<div class="section" id="m-text">
<h5><a class="toc-backref" href="#id369">13.2.1.7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.text</tt></a></h5>
<p>This message is the most basic message and is used to represent text.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> The body of the message.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.text'.</td>
</tr>
<tr><td>format</td>
<td>string</td>
<td>The format used in the <tt class="docutils literal">formatted_body</tt>.
Currently only <tt class="docutils literal">org.matrix.custom.html</tt> is
supported.</td>
</tr>
<tr><td>formatted_body</td>
<td>string</td>
<td>The formatted version of the <tt class="docutils literal">body</tt>. This is
required if <tt class="docutils literal">format</tt> is specified.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-emote"></a></p>
<div class="section" id="m-emote">
<h5><a class="toc-backref" href="#id370">13.2.1.7.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.emote</tt></a></h5>
<p>This message is similar to <tt class="docutils literal">m.text</tt> except that the sender is 'performing' the
action contained in the <tt class="docutils literal">body</tt> key, similar to <tt class="docutils literal">/me</tt> in IRC. This message
should be prefixed by the name of the sender. This message could also be
represented in a different colour to distinguish it from regular <tt class="docutils literal">m.text</tt>
messages.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> The emote action to perform.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.emote'.</td>
</tr>
<tr><td>format</td>
<td>string</td>
<td>The format used in the <tt class="docutils literal">formatted_body</tt>.
Currently only <tt class="docutils literal">org.matrix.custom.html</tt> is
supported.</td>
</tr>
<tr><td>formatted_body</td>
<td>string</td>
<td>The formatted version of the <tt class="docutils literal">body</tt>. This is
required if <tt class="docutils literal">format</tt> is specified.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;thinks this is an example emote&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;thinks &lt;b&gt;this&lt;/b&gt; is an example emote&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.emote&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-notice"></a></p>
<div class="section" id="m-notice">
<h5><a class="toc-backref" href="#id371">13.2.1.7.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.notice</tt></a></h5>
<p>The <tt class="docutils literal">m.notice</tt> type is primarily intended for responses from automated
clients. An <tt class="docutils literal">m.notice</tt> message must be treated the same way as a regular
<tt class="docutils literal">m.text</tt> message with two exceptions. Firstly, clients should present
<tt class="docutils literal">m.notice</tt> messages to users in a distinct manner, and secondly, <tt class="docutils literal">m.notice</tt>
messages must never be automatically responded to. This helps to prevent
infinite-loop situations where two automated clients continuously exchange
messages.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> The notice text to send.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.notice'.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example notice&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an &lt;strong&gt;example&lt;/strong&gt; notice&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.notice&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-image"></a></p>
<div class="section" id="m-image">
<h5><a class="toc-backref" href="#id372">13.2.1.7.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.image</tt></a></h5>
<p>This message represents a single image and an optional thumbnail.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> A textual representation of the
image. This could be the alt text of the image,
the filename of the image, or some kind of content
description for accessibility e.g. 'image
attachment'.</td>
</tr>
<tr><td>info</td>
<td>ImageInfo</td>
<td>Metadata about the image referred to in <tt class="docutils literal">url</tt>.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.image'.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td><strong>Required.</strong> Required if the file is unencrypted.
The URL (typically <a class="reference internal" href="#mxc-uri">MXC URI</a>) to the image.</td>
</tr>
<tr><td>file</td>
<td>EncryptedFile</td>
<td>Required if the file is encrypted. Information on
the encrypted file, as specified in
<a class="reference internal" href="#encrypted-files">End-to-end encryption</a>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ImageInfo</caption>
<thead valign="bottom">
<tr><th class="head">ImageInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The intended display height of the image in
pixels. This may differ from the intrinsic
dimensions of the image file.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The intended display width of the image in pixels.
This may differ from the intrinsic dimensions of
the image file.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL (typically <a class="reference internal" href="#mxc-uri">MXC URI</a>) to a thumbnail of
the image. Only present if the thumbnail is
unencrypted.</td>
</tr>
<tr><td>thumbnail_file</td>
<td>EncryptedFile</td>
<td>Information on the encrypted thumbnail file, as
specified in <a class="reference internal" href="#encrypted-files">End-to-end encryption</a>. Only present if
the thumbnail is encrypted.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>ThumbnailInfo</td>
<td>Metadata about the image referred to in
<tt class="docutils literal">thumbnail_url</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ThumbnailInfo</caption>
<thead valign="bottom">
<tr><th class="head">ThumbnailInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The intended display height of the image in
pixels. This may differ from the intrinsic
dimensions of the image file.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The intended display width of the image in pixels.
This may differ from the intrinsic dimensions of
the image file.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;filename.jpg&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">398</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">31037</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">394</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.image&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/JWEIFJgwEIhweiWJE&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-file"></a></p>
<div class="section" id="m-file">
<h5><a class="toc-backref" href="#id373">13.2.1.7.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.file</tt></a></h5>
<p>This message represents a generic file.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> A human-readable description of the
file. This is recommended to be the filename of
the original upload.</td>
</tr>
<tr><td>filename</td>
<td>string</td>
<td>The original filename of the uploaded file.</td>
</tr>
<tr><td>info</td>
<td>FileInfo</td>
<td>Information about the file referred to in <tt class="docutils literal">url</tt>.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.file'.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td><strong>Required.</strong> Required if the file is unencrypted.
The URL (typically <a class="reference internal" href="#mxc-uri">MXC URI</a>) to the file.</td>
</tr>
<tr><td>file</td>
<td>EncryptedFile</td>
<td>Required if the file is encrypted. Information on
the encrypted file, as specified in
<a class="reference internal" href="#encrypted-files">End-to-end encryption</a>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>FileInfo</caption>
<thead valign="bottom">
<tr><th class="head">FileInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the file e.g.
<tt class="docutils literal">application/msword</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>The size of the file in bytes.</td>
</tr>
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL to the thumbnail of the file. Only present
if the thumbnail is unencrypted.</td>
</tr>
<tr><td>thumbnail_file</td>
<td>EncryptedFile</td>
<td>Information on the encrypted thumbnail file, as
specified in <a class="reference internal" href="#encrypted-files">End-to-end encryption</a>. Only present if
the thumbnail is encrypted.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>ThumbnailInfo</td>
<td>Metadata about the image referred to in
<tt class="docutils literal">thumbnail_url</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ThumbnailInfo</caption>
<thead valign="bottom">
<tr><th class="head">ThumbnailInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The intended display height of the image in
pixels. This may differ from the intrinsic
dimensions of the image file.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The intended display width of the image in pixels.
This may differ from the intrinsic dimensions of
the image file.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.doc&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.doc&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;application/msword&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.file&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-audio"></a></p>
<div class="section" id="m-audio">
<h5><a class="toc-backref" href="#id374">13.2.1.7.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.audio</tt></a></h5>
<p>This message represents a single audio clip.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> A description of the audio e.g. 'Bee
Gees - Stayin' Alive', or some kind of content
description for accessibility e.g. 'audio
attachment'.</td>
</tr>
<tr><td>info</td>
<td>AudioInfo</td>
<td>Metadata for the audio clip referred to in
<tt class="docutils literal">url</tt>.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.audio'.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td><strong>Required.</strong> Required if the file is not
encrypted. The URL (typically <a class="reference internal" href="#mxc-uri">MXC URI</a>) to the
audio clip.</td>
</tr>
<tr><td>file</td>
<td>EncryptedFile</td>
<td>Required if the file is encrypted. Information on
the encrypted file, as specified in
<a class="reference internal" href="#encrypted-files">End-to-end encryption</a>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>AudioInfo</caption>
<thead valign="bottom">
<tr><th class="head">AudioInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>duration</td>
<td>integer</td>
<td>The duration of the audio in milliseconds.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the audio e.g. <tt class="docutils literal">audio/aac</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>The size of the audio clip in bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bee Gees - Stayin' Alive&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2140786</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;audio/mpeg&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1563685</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.audio&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/ffed755USFFxlgbQYZGtryd&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-location"></a></p>
<div class="section" id="m-location">
<h5><a class="toc-backref" href="#id375">13.2.1.7.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.location</tt></a></h5>
<p>This message represents a real-world location.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> A description of the location e.g.
'Big Ben, London, UK', or some kind of content
description for accessibility e.g. 'location
attachment'.</td>
</tr>
<tr><td>geo_uri</td>
<td>string</td>
<td><strong>Required.</strong> A geo URI representing this
location.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.location'.</td>
</tr>
<tr><td>info</td>
<td>LocationInfo</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>LocationInfo</caption>
<thead valign="bottom">
<tr><th class="head">LocationInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL to the thumbnail of the file. Only present
if the thumbnail is unencrypted.</td>
</tr>
<tr><td>thumbnail_file</td>
<td>EncryptedFile</td>
<td>Information on the encrypted thumbnail file, as
specified in <a class="reference internal" href="#encrypted-files">End-to-end encryption</a>. Only present if
the thumbnail is encrypted.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>ThumbnailInfo</td>
<td>Metadata about the image referred to in
<tt class="docutils literal">thumbnail_url</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ThumbnailInfo</caption>
<thead valign="bottom">
<tr><th class="head">ThumbnailInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The intended display height of the image in
pixels. This may differ from the intrinsic
dimensions of the image file.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The intended display width of the image in pixels.
This may differ from the intrinsic dimensions of
the image file.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Big Ben, London, UK&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;geo_uri&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;geo:51.5008,0.1247&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;thumbnail_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span><span class="punctuation">,</span>
                <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span><span class="punctuation">,</span>
                <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;thumbnail_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.location&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-video"></a></p>
<div class="section" id="m-video">
<h5><a class="toc-backref" href="#id376">13.2.1.7.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.video</tt></a></h5>
<p>This message represents a single video clip.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> A description of the video e.g.
'Gangnam style', or some kind of content
description for accessibility e.g. 'video
attachment'.</td>
</tr>
<tr><td>info</td>
<td>VideoInfo</td>
<td>Metadata about the video clip referred to in
<tt class="docutils literal">url</tt>.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.video'.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td><strong>Required.</strong> Required if the file is unencrypted.
The URL (typically <a class="reference internal" href="#mxc-uri">MXC URI</a>) to the video clip.</td>
</tr>
<tr><td>file</td>
<td>EncryptedFile</td>
<td>Required if the file is encrypted. Information on
the encrypted file, as specified in
<a class="reference internal" href="#encrypted-files">End-to-end encryption</a>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>VideoInfo</caption>
<thead valign="bottom">
<tr><th class="head">VideoInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>duration</td>
<td>integer</td>
<td>The duration of the video in milliseconds.</td>
</tr>
<tr><td>h</td>
<td>integer</td>
<td>The height of the video in pixels.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The width of the video in pixels.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the video e.g. <tt class="docutils literal">video/mp4</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>The size of the video in bytes.</td>
</tr>
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL (typically <a class="reference internal" href="#mxc-uri">MXC URI</a>) to an image
thumbnail of the video clip. Only present if the
thumbnail is unencrypted.</td>
</tr>
<tr><td>thumbnail_file</td>
<td>EncryptedFile</td>
<td>Information on the encrypted thumbnail file, as
specified in <a class="reference internal" href="#encrypted-files">End-to-end encryption</a>. Only present if
the thumbnail is encrypted.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>ThumbnailInfo</td>
<td>Metadata about the image referred to in
<tt class="docutils literal">thumbnail_url</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ThumbnailInfo</caption>
<thead valign="bottom">
<tr><th class="head">ThumbnailInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The intended display height of the image in
pixels. This may differ from the intrinsic
dimensions of the image file.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The intended display width of the image in pixels.
This may differ from the intrinsic dimensions of
the image file.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Gangnam Style&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2140786</span><span class="punctuation">,</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">320</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;video/mp4&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1563685</span><span class="punctuation">,</span>
            <span class="name tag">&quot;thumbnail_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span><span class="punctuation">,</span>
                <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span><span class="punctuation">,</span>
                <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;thumbnail_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">480</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.video&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/a526eYUSFFxlgbQYZmo442&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="id88"></a></p>
<div class="section" id="id88">
<h3><a class="toc-backref" href="#id377">13.2.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients SHOULD verify the structure of incoming events to ensure that the
expected keys exist and that they are of the right type. Clients can discard
malformed events or display a placeholder message to the user. Redacted
<tt class="docutils literal">m.room.message</tt> events MUST be removed from the client. This can either be
replaced with placeholder text (e.g. &quot;[REDACTED]&quot;) or the redacted message can
be removed entirely from the messages view.</p>
<p>Events which have attachments (e.g. <tt class="docutils literal">m.image</tt>, <tt class="docutils literal">m.file</tt>) SHOULD be
uploaded using the <a class="reference internal" href="#module-content">content repository module</a> where available. The
resulting <tt class="docutils literal"><span class="pre">mxc://</span></tt> URI can then be used in the <tt class="docutils literal">url</tt> key.</p>
<p>Clients MAY include a client generated thumbnail image for an attachment under
a <tt class="docutils literal">info.thumbnail_url</tt> key. The thumbnail SHOULD also be a <tt class="docutils literal"><span class="pre">mxc://</span></tt> URI.
Clients displaying events with attachments can either use the client generated
thumbnail or ask its homeserver to generate a thumbnail from the original
attachment using the <a class="reference internal" href="#module-content">content repository module</a>.</p>
<p><a class="anchor" id="recommendations-when-sending-messages"></a></p>
<div class="section" id="recommendations-when-sending-messages">
<h4><a class="toc-backref" href="#id378">13.2.2.1&nbsp;&nbsp;&nbsp;Recommendations when sending messages</a></h4>
<p>In the event of send failure, clients SHOULD retry requests using an
exponential-backoff algorithm for a
certain amount of time T. It is recommended that T is no longer than 5 minutes.
After this time, the client should stop retrying and mark the message as &quot;unsent&quot;.
Users should be able to manually resend unsent messages.</p>
<p>Users may type several messages at once and send them all in quick succession.
Clients SHOULD preserve the order in which they were sent by the user. This
means that clients should wait for the response to the previous request before
sending the next request. This can lead to head-of-line blocking. In order to
reduce the impact of head-of-line blocking, clients should use a queue per room
rather than a global queue, as ordering is only relevant within a single room
rather than between rooms.</p>
</div>
<p><a class="anchor" id="local-echo"></a></p>
<div class="section" id="local-echo">
<h4><a class="toc-backref" href="#id379">13.2.2.2&nbsp;&nbsp;&nbsp;Local echo</a></h4>
<p>Messages SHOULD appear immediately in the message view when a user presses the
&quot;send&quot; button. This should occur even if the message is still sending. This is
referred to as &quot;local echo&quot;. Clients SHOULD implement &quot;local echo&quot; of messages.
Clients MAY display messages in a different format to indicate that the server
has not processed the message. This format should be removed when the server
responds.</p>
<p>Clients need to be able to match the message they are sending with the same
message which they receive from the event stream. The echo of the same message
from the event stream is referred to as &quot;remote echo&quot;. Both echoes need to be
identified as the same message in order to prevent duplicate messages being
displayed. Ideally this pairing would occur transparently to the user: the UI
would not flicker as it transitions from local to remote. Flickering can be
reduced through clients making use of the transaction ID they used to send
a particular event. The transaction ID used will be included in the event's
<tt class="docutils literal">unsigned</tt> data as <tt class="docutils literal">transaction_id</tt> when it arrives through the event stream.</p>
<p>Clients unable to make use of the transaction ID are likely to experience
flickering when the remote echo arrives on the event stream <em>before</em>
the request to send the message completes. In that case the event
arrives before the client has obtained an event ID, making it impossible to
identify it as a remote echo. This results in the client displaying the message
twice for some time (depending on the server responsiveness) before the original
request to send the message completes. Once it completes, the client can take
remedial actions to remove the duplicate event by looking for duplicate event IDs.</p>
</div>
<p><a class="anchor" id="calculating-the-display-name-for-a-user"></a></p>
<div class="section" id="calculating-the-display-name-for-a-user">
<h4><a class="toc-backref" href="#id380">13.2.2.3&nbsp;&nbsp;&nbsp;Calculating the display name for a user</a></h4>
<p>Clients may wish to show the human-readable display name of a room member as
part of a membership list, or when they send a message. However, different
members may have conflicting display names. Display names MUST be disambiguated
before showing them to the user, in order to prevent spoofing of other users.</p>
<p>To ensure this is done consistently across clients, clients SHOULD use the
following algorithm to calculate a disambiguated display name for a given user:</p>
<ol class="arabic simple">
<li>Inspect the <tt class="docutils literal">m.room.member</tt> state event for the relevant user id.</li>
<li>If the <tt class="docutils literal">m.room.member</tt> state event has no <tt class="docutils literal">displayname</tt> field, or if
that field has a <tt class="docutils literal">null</tt> value, use the raw user id as the display
name. Otherwise:</li>
<li>If the <tt class="docutils literal">m.room.member</tt> event has a <tt class="docutils literal">displayname</tt> which is unique among
members of the room with <tt class="docutils literal">membership: join</tt> or <tt class="docutils literal">membership: invite</tt>, use
the given <tt class="docutils literal">displayname</tt> as the user-visible display name. Otherwise:</li>
<li>The <tt class="docutils literal">m.room.member</tt> event has a non-unique <tt class="docutils literal">displayname</tt>. This should be
disambiguated using the user id, for example &quot;display name
(&#64;id:homeserver.org)&quot;.<!-- TODO-spec
what does it mean for a ``displayname`` to be 'unique'? Are we
case-sensitive?  Do we care about homograph attacks? See
https://matrix.org/jira/browse/SPEC-221. -->
</li>
</ol>
<p>Developers should take note of the following when implementing the above
algorithm:</p>
<ul class="simple">
<li>The user-visible display name of one member can be affected by changes in the
state of another member. For example, if <tt class="docutils literal">&#64;user1:matrix.org</tt> is present in
a room, with <tt class="docutils literal">displayname: Alice</tt>, then when <tt class="docutils literal">&#64;user2:example.com</tt> joins
the room, also with <tt class="docutils literal">displayname: Alice</tt>, <em>both</em> users must be given
disambiguated display names. Similarly, when one of the users then changes
their display name, there is no longer a clash, and <em>both</em> users can be given
their chosen display name. Clients should be alert to this possibility and
ensure that all affected users are correctly renamed.</li>
<li>The display name of a room may also be affected by changes in the membership
list. This is due to the room name sometimes being based on user display
names (see <a class="reference internal" href="#calculating-the-display-name-for-a-room">Calculating the display name for a room</a>).</li>
<li>If the entire membership list is searched for clashing display names, this
leads to an O(N^2) implementation for building the list of room members. This
will be very inefficient for rooms with large numbers of members. It is
recommended that client implementations maintain a hash table mapping from
<tt class="docutils literal">displayname</tt> to a list of room members using that name. Such a table can
then be used for efficient calculation of whether disambiguation is needed.</li>
</ul>
</div>
<p><a class="anchor" id="displaying-membership-information-with-messages"></a></p>
<div class="section" id="displaying-membership-information-with-messages">
<h4><a class="toc-backref" href="#id381">13.2.2.4&nbsp;&nbsp;&nbsp;Displaying membership information with messages</a></h4>
<p>Clients may wish to show the display name and avatar URL of the room member who
sent a message. This can be achieved by inspecting the <tt class="docutils literal">m.room.member</tt> state
event for that user ID (see <a class="reference internal" href="#calculating-the-display-name-for-a-user">Calculating the display name for a user</a>).</p>
<p>When a user paginates the message history, clients may wish to show the
<strong>historical</strong> display name and avatar URL for a room member. This is possible
because older <tt class="docutils literal">m.room.member</tt> events are returned when paginating. This can
be implemented efficiently by keeping two sets of room state: old and current.
As new events arrive and/or the user paginates back in time, these two sets of
state diverge from each other. New events update the current state and paginated
events update the old state. When paginated events are processed sequentially,
the old state represents the state of the room <em>at the time the event was sent</em>.
This can then be used to set the historical display name and avatar URL.</p>
</div>
<p><a class="anchor" id="calculating-the-display-name-for-a-room"></a></p>
<div class="section" id="calculating-the-display-name-for-a-room">
<h4><a class="toc-backref" href="#id382">13.2.2.5&nbsp;&nbsp;&nbsp;Calculating the display name for a room</a></h4>
<p>Clients may wish to show a human-readable name for a room. There are a number
of possibilities for choosing a useful name. To ensure that rooms are named
consistently across clients, clients SHOULD use the following algorithm to
choose a name:</p>
<ol class="arabic simple">
<li>If the room has an <a class="reference internal" href="#m-room-name">m.room.name</a> state event with a non-empty <tt class="docutils literal">name</tt>
field, use the name given by that field.</li>
<li>If the room has an <a class="reference internal" href="#m-room-canonical-alias">m.room.canonical_alias</a> state event with a non-empty
<tt class="docutils literal">alias</tt> field, use the alias given by that field as the name.</li>
<li>If neither of the above conditions are met, the client can optionally guess
an alias from the <tt class="docutils literal">m.room.alias</tt> events in the room. This is a temporary
measure while clients do not promote canonical aliases as prominently. This
step may be removed in a future version of the specification.</li>
<li>If none of the above conditions are met, a name should be composed based
on the members of the room. Clients should consider <a class="reference external" href="#m-room-member">m.room.member</a> events
for users other than the logged-in user, as defined below.<ol class="lowerroman">
<li>If the number of <tt class="docutils literal">m.heroes</tt> for the room are greater or equal to
<tt class="docutils literal">m.joined_member_count + m.invited_member_count - 1</tt>, then use the
membership events for the heroes to calculate display names for the
users (<a class="reference internal" href="#calculating-the-display-name-for-a-user">disambiguating them if required</a>) and concatenating them. For
example, the client may choose to show &quot;Alice, Bob, and Charlie
(&#64;charlie:example.org)&quot; as the room name. The client may optionally
limit the number of users it uses to generate a room name.</li>
<li>If there are fewer heroes than <tt class="docutils literal">m.joined_member_count + m.invited_member_count
- 1</tt>, and <tt class="docutils literal">m.joined_member_count + m.invited_member_count</tt> is greater
than 1, the client should use the heroes to calculate display names for
the users (<a class="reference internal" href="#calculating-the-display-name-for-a-user">disambiguating them if required</a>) and concatenating them
alongside a count of the remaining users. For example, &quot;Alice, Bob, and
1234 others&quot;.</li>
<li>If <tt class="docutils literal">m.joined_member_count + m.invited_member_count</tt> is less than or
equal to 1 (indicating the member is alone), the client should use the
rules above to indicate that the room was empty. For example, &quot;Empty
Room (was Alice)&quot;, &quot;Empty Room (was Alice and 1234 others)&quot;, or
&quot;Empty Room&quot; if there are no heroes.</li>
</ol>
</li>
</ol>
<p>Clients SHOULD internationalise the room name to the user's language when using
the <tt class="docutils literal">m.heroes</tt> to calculate the name. Clients SHOULD use minimum 5 heroes to
calculate room names where possible, but may use more or less to fit better with
their user experience.</p>
</div>
<p><a class="anchor" id="forming-relationships-between-events"></a></p>
<div class="section" id="forming-relationships-between-events">
<h4><a class="toc-backref" href="#id383">13.2.2.6&nbsp;&nbsp;&nbsp;Forming relationships between events</a></h4>
<p>In some cases, events may wish to reference other events. This could be to form
a thread of messages for the user to follow along with, or to provide more context
as to what a particular event is describing. Currently, the only kind of relation
defined is a &quot;rich reply&quot; where a user may reference another message to create a
thread-like conversation.</p>
<p>Relationships are defined under an <tt class="docutils literal">m.relates_to</tt> key in the event's <tt class="docutils literal">content</tt>.
If the event is of the type <tt class="docutils literal">m.room.encrypted</tt>, the <tt class="docutils literal">m.relates_to</tt> key MUST NOT
be covered by the encryption and instead be put alongside the encryption information
held in the <tt class="docutils literal">content</tt>.</p>
<p><a class="anchor" id="rich-replies"></a></p>
<div class="section" id="rich-replies">
<h5><a class="toc-backref" href="#id384">13.2.2.6.1&nbsp;&nbsp;&nbsp;Rich replies</a></h5>
<p>Users may wish to reference another message when forming their own message, and
clients may wish to better embed the referenced message for the user to have a
better context for the conversation being had. This sort of embedding another
message in a message is known as a &quot;rich reply&quot;, or occasionally just a &quot;reply&quot;.</p>
<p>A rich reply is formed through use of an <tt class="docutils literal">m.relates_to</tt> relation for <tt class="docutils literal">m.in_reply_to</tt>
where a single key, <tt class="docutils literal">event_id</tt>, is used to reference the event being replied to.
The referenced event ID SHOULD belong to the same room where the reply is being sent.
Clients should be cautious of the event ID belonging to another room, or being invalid
entirely. Rich replies can only be constructed in the form of <tt class="docutils literal">m.room.message</tt> events
with a <tt class="docutils literal">msgtype</tt> of <tt class="docutils literal">m.text</tt> or <tt class="docutils literal">m.notice</tt>. Due to the fallback requirements, rich
replies cannot be constructed for types of <tt class="docutils literal">m.emote</tt>, <tt class="docutils literal">m.file</tt>, etc. Rich replies
may reference any other <tt class="docutils literal">m.room.message</tt> event, however. Rich replies may reference
another event which also has a rich reply, infinitely.</p>
<p>An <tt class="docutils literal">m.in_reply_to</tt> relationship looks like the following:</p>
<pre class="literal-block">
{
  ...
  &quot;type&quot;: &quot;m.room.message&quot;,
  &quot;content&quot;: {
    &quot;msgtype&quot;: &quot;m.text&quot;,
    &quot;body&quot;: &quot;&lt;body including fallback&gt;&quot;,
    &quot;format&quot;: &quot;org.matrix.custom.html&quot;,
    &quot;formatted_body&quot;: &quot;&lt;HTML including fallback&gt;&quot;,
    &quot;m.relates_to&quot;: {
      &quot;m.in_reply_to&quot;: {
        &quot;event_id&quot;: &quot;$another:event.com&quot;
      }
    }
  }
}
</pre>
<p><a class="anchor" id="fallbacks-and-event-representation"></a></p>
<div class="section" id="fallbacks-and-event-representation">
<h6><a class="toc-backref" href="#id385">13.2.2.6.1.1&nbsp;&nbsp;&nbsp;Fallbacks and event representation</a></h6>
<p>Some clients may not have support for rich replies and therefore need a fallback
to use instead. Clients that do not support rich replies should render the event
as if rich replies were not special.</p>
<p>Clients that do support rich replies MUST provide the fallback format on replies,
and MUST strip the fallback before rendering the reply. Rich replies MUST have
a <tt class="docutils literal">format</tt> of <tt class="docutils literal">org.matrix.custom.html</tt> and therefore a <tt class="docutils literal">formatted_body</tt>
alongside the <tt class="docutils literal">body</tt> and appropriate <tt class="docutils literal">msgtype</tt>. The specific fallback text
is different for each <tt class="docutils literal">msgtype</tt>, however the general format for the <tt class="docutils literal">body</tt> is:</p>
<pre class="code text literal-block">
&gt; &lt;&#64;alice:example.org&gt; This is the original body

This is where the reply goes
</pre>
<p>The <tt class="docutils literal">formatted_body</tt> should use the following template:</p>
<pre class="code html literal-block">
<span class="punctuation">&lt;</span><span class="name tag">mx-reply</span><span class="punctuation">&gt;</span>
  <span class="punctuation">&lt;</span><span class="name tag">blockquote</span><span class="punctuation">&gt;</span>
    <span class="punctuation">&lt;</span><span class="name tag">a</span> <span class="name attribute">href</span><span class="operator">=</span><span class="literal string">&quot;https://matrix.to/#/!somewhere:example.org/$event:example.org&quot;</span><span class="punctuation">&gt;</span>In reply to<span class="punctuation">&lt;/</span><span class="name tag">a</span><span class="punctuation">&gt;</span>
    <span class="punctuation">&lt;</span><span class="name tag">a</span> <span class="name attribute">href</span><span class="operator">=</span><span class="literal string">&quot;https://matrix.to/#/&#64;alice:example.org&quot;</span><span class="punctuation">&gt;</span>&#64;alice:example.org<span class="punctuation">&lt;/</span><span class="name tag">a</span><span class="punctuation">&gt;</span>
    <span class="punctuation">&lt;</span><span class="name tag">br</span> <span class="punctuation">/&gt;</span>
    <span class="comment">&lt;!-- This is where the related event's HTML would be. --&gt;</span>
  <span class="punctuation">&lt;/</span><span class="name tag">blockquote</span><span class="punctuation">&gt;</span>
<span class="punctuation">&lt;/</span><span class="name tag">mx-reply</span><span class="punctuation">&gt;</span>
This is where the reply goes.
</pre>
<p>If the related event does not have a <tt class="docutils literal">formatted_body</tt>, the event's <tt class="docutils literal">body</tt> should
be considered after encoding any HTML special characters. Note that the <tt class="docutils literal">href</tt> in
both of the anchors use a <a class="reference external" href="../appendices.html#matrix-to-navigation">matrix.to URI</a>.</p>
<p><a class="anchor" id="stripping-the-fallback"></a></p>
<div class="section" id="stripping-the-fallback">
<h7><a class="toc-backref" href="#id386">13.2.2.6.1.1.1&nbsp;&nbsp;&nbsp;Stripping the fallback</a></h7>
<p>Clients which support rich replies MUST strip the fallback from the event before
rendering the event. This is because the text provided in the fallback cannot be
trusted to be an accurate representation of the event. After removing the fallback,
clients are recommended to represent the event referenced by <tt class="docutils literal">m.in_reply_to</tt>
similar to the fallback's representation, although clients do have creative freedom
for their user interface. Clients should prefer the <tt class="docutils literal">formatted_body</tt> over the
<tt class="docutils literal">body</tt>, just like with other <tt class="docutils literal">m.room.message</tt> events.</p>
<p>To strip the fallback on the <tt class="docutils literal">body</tt>, the client should iterate over each line of
the string, removing any lines that start with the fallback prefix (&quot;&gt; &quot;,
including the space, without quotes) and stopping when a line is encountered without
the prefix. This prefix is known as the &quot;fallback prefix sequence&quot;.</p>
<p>To strip the fallback on the <tt class="docutils literal">formatted_body</tt>, the client should remove the
entirety of the <tt class="docutils literal"><span class="pre">mx-reply</span></tt> tag.</p>
</div>
<p><a class="anchor" id="fallback-for-m-text-m-notice-and-unrecognised-message-types"></a></p>
<div class="section" id="fallback-for-m-text-m-notice-and-unrecognised-message-types">
<h7><a class="toc-backref" href="#id387">13.2.2.6.1.1.2&nbsp;&nbsp;&nbsp;Fallback for <tt class="docutils literal">m.text</tt>, <tt class="docutils literal">m.notice</tt>, and unrecognised message types</a></h7>
<p>Using the prefix sequence, the first line of the related event's <tt class="docutils literal">body</tt> should
be prefixed with the user's ID, followed by each line being prefixed with the fallback
prefix sequence. For example:</p>
<pre class="literal-block">
&gt; &lt;&#64;alice:example.org&gt; This is the first line
&gt; This is the second line

This is the reply
</pre>
<p>The <tt class="docutils literal">formatted_body</tt> uses the template defined earlier in this section.</p>
</div>
<p><a class="anchor" id="fallback-for-m-emote"></a></p>
<div class="section" id="fallback-for-m-emote">
<h7><a class="toc-backref" href="#id388">13.2.2.6.1.1.3&nbsp;&nbsp;&nbsp;Fallback for <tt class="docutils literal">m.emote</tt></a></h7>
<p>Similar to the fallback for <tt class="docutils literal">m.text</tt>, each line gets prefixed with the fallback
prefix sequence. However an asterisk should be inserted before the user's ID, like
so:</p>
<pre class="literal-block">
&gt; * &lt;&#64;alice:example.org&gt; feels like today is going to be a great day

This is the reply
</pre>
<p>The <tt class="docutils literal">formatted_body</tt> has a subtle difference for the template where the asterisk
is also inserted ahead of the user's ID:</p>
<pre class="code html literal-block">
<span class="punctuation">&lt;</span><span class="name tag">mx-reply</span><span class="punctuation">&gt;</span>
  <span class="punctuation">&lt;</span><span class="name tag">blockquote</span><span class="punctuation">&gt;</span>
    <span class="punctuation">&lt;</span><span class="name tag">a</span> <span class="name attribute">href</span><span class="operator">=</span><span class="literal string">&quot;https://matrix.to/#/!somewhere:example.org/$event:example.org&quot;</span><span class="punctuation">&gt;</span>In reply to<span class="punctuation">&lt;/</span><span class="name tag">a</span><span class="punctuation">&gt;</span>
    * <span class="punctuation">&lt;</span><span class="name tag">a</span> <span class="name attribute">href</span><span class="operator">=</span><span class="literal string">&quot;https://matrix.to/#/&#64;alice:example.org&quot;</span><span class="punctuation">&gt;</span>&#64;alice:example.org<span class="punctuation">&lt;/</span><span class="name tag">a</span><span class="punctuation">&gt;</span>
    <span class="punctuation">&lt;</span><span class="name tag">br</span> <span class="punctuation">/&gt;</span>
    <span class="comment">&lt;!-- This is where the related event's HTML would be. --&gt;</span>
  <span class="punctuation">&lt;/</span><span class="name tag">blockquote</span><span class="punctuation">&gt;</span>
<span class="punctuation">&lt;/</span><span class="name tag">mx-reply</span><span class="punctuation">&gt;</span>
This is where the reply goes.
</pre>
</div>
<p><a class="anchor" id="fallback-for-m-image-m-video-m-audio-and-m-file"></a></p>
<div class="section" id="fallback-for-m-image-m-video-m-audio-and-m-file">
<h7><a class="toc-backref" href="#id389">13.2.2.6.1.1.4&nbsp;&nbsp;&nbsp;Fallback for <tt class="docutils literal">m.image</tt>, <tt class="docutils literal">m.video</tt>, <tt class="docutils literal">m.audio</tt>, and <tt class="docutils literal">m.file</tt></a></h7>
<p>The related event's <tt class="docutils literal">body</tt> would be a file name, which may not be very descriptive.
The related event should additionally not have a <tt class="docutils literal">format</tt> or <tt class="docutils literal">formatted_body</tt>
in the <tt class="docutils literal">content</tt> - if the event does have a <tt class="docutils literal">format</tt> and/or <tt class="docutils literal">formatted_body</tt>,
those fields should be ignored. Because the filename alone may not be descriptive,
the related event's <tt class="docutils literal">body</tt> should be considered to be <tt class="docutils literal">&quot;sent a file.&quot;</tt> such that
the output looks similar to the following:</p>
<pre class="literal-block">
&gt; &lt;&#64;alice:example.org&gt; sent a file.

This is the reply
</pre>
<pre class="code html literal-block">
<span class="punctuation">&lt;</span><span class="name tag">mx-reply</span><span class="punctuation">&gt;</span>
  <span class="punctuation">&lt;</span><span class="name tag">blockquote</span><span class="punctuation">&gt;</span>
    <span class="punctuation">&lt;</span><span class="name tag">a</span> <span class="name attribute">href</span><span class="operator">=</span><span class="literal string">&quot;https://matrix.to/#/!somewhere:example.org/$event:example.org&quot;</span><span class="punctuation">&gt;</span>In reply to<span class="punctuation">&lt;/</span><span class="name tag">a</span><span class="punctuation">&gt;</span>
    <span class="punctuation">&lt;</span><span class="name tag">a</span> <span class="name attribute">href</span><span class="operator">=</span><span class="literal string">&quot;https://matrix.to/#/&#64;alice:example.org&quot;</span><span class="punctuation">&gt;</span>&#64;alice:example.org<span class="punctuation">&lt;/</span><span class="name tag">a</span><span class="punctuation">&gt;</span>
    <span class="punctuation">&lt;</span><span class="name tag">br</span> <span class="punctuation">/&gt;</span>
    sent a file.
  <span class="punctuation">&lt;/</span><span class="name tag">blockquote</span><span class="punctuation">&gt;</span>
<span class="punctuation">&lt;/</span><span class="name tag">mx-reply</span><span class="punctuation">&gt;</span>
This is where the reply goes.
</pre>
<p>For <tt class="docutils literal">m.image</tt>, the text should be <tt class="docutils literal">&quot;sent an image.&quot;</tt>. For <tt class="docutils literal">m.video</tt>, the text
should be <tt class="docutils literal">&quot;sent a video.&quot;</tt>. For <tt class="docutils literal">m.audio</tt>, the text should be <tt class="docutils literal">&quot;sent an audio file&quot;</tt>.</p>
</div>
</div>
</div>
</div>
</div>
<p><a class="anchor" id="server-behaviour"></a></p>
<div class="section" id="server-behaviour">
<h3><a class="toc-backref" href="#id390">13.2.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Homeservers SHOULD reject <tt class="docutils literal">m.room.message</tt> events which don't have a
<tt class="docutils literal">msgtype</tt> key, or which don't have a textual <tt class="docutils literal">body</tt> key, with an HTTP status
code of 400.</p>
</div>
<p><a class="anchor" id="security-considerations"></a></p>
<div class="section" id="security-considerations">
<h3><a class="toc-backref" href="#id391">13.2.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Messages sent using this module are not encrypted, although end to end encryption is in development (see <a class="reference internal" href="#module-e2e">E2E module</a>).</p>
<p>Clients should sanitise <strong>all displayed keys</strong> for unsafe HTML to prevent Cross-Site
Scripting (XSS) attacks. This includes room names and topics.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="voice-over-ip"></a></p>
<div class="section" id="voice-over-ip">
<h2><a class="toc-backref" href="#id392">13.3&nbsp;&nbsp;&nbsp;Voice over IP</a></h2>
<p id="module-voip">This module outlines how two users in a room can set up a Voice over IP (VoIP)
call to each other. Voice and video calls are built upon the WebRTC 1.0 standard.
Call signalling is achieved by sending <a class="reference internal" href="#sect-events">message events</a> to the room.  In this
version of the spec, only two-party communication is supported (e.g. between two
peers, or between a peer and a multi-point conferencing unit).
This means that clients MUST only send call events to rooms with exactly two
participants.</p>
<p><a class="anchor" id="id89"></a></p>
<div class="section" id="id89">
<h3><a class="toc-backref" href="#id393">13.3.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-call-invite"></a></p>
<div class="section" id="m-call-invite">
<h4><a class="toc-backref" href="#id394">13.3.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.invite</tt></a></h4>
<p><em>Message Event</em></p>
<p>This event is sent by the caller when they wish to establish a call.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>call_id</td>
<td>string</td>
<td><strong>Required.</strong> A unique identifier for the call.</td>
</tr>
<tr><td>offer</td>
<td>Offer</td>
<td><strong>Required.</strong> The session description object</td>
</tr>
<tr><td>version</td>
<td>integer</td>
<td><strong>Required.</strong> The version of the VoIP
specification this message adheres to. This
specification is version 0.</td>
</tr>
<tr><td>lifetime</td>
<td>integer</td>
<td><strong>Required.</strong> The time in milliseconds that the
invite is valid for. Once the invite age exceeds
this value, clients should discard it. They should
also no longer show the call as awaiting an answer
in the UI.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Offer</caption>
<thead valign="bottom">
<tr><th class="head">Offer Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of session description.
Must be 'offer'.</td>
</tr>
<tr><td>sdp</td>
<td>string</td>
<td><strong>Required.</strong> The SDP text of the session
description.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;call_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;12345&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;lifetime&quot;</span><span class="punctuation">:</span> <span class="literal number integer">60000</span><span class="punctuation">,</span>
        <span class="name tag">&quot;offer&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;sdp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;v=0\r\no=- 6584580628695956864 2 IN IP4 127.0.0.1[...]&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;offer&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.invite&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-call-candidates"></a></p>
<div class="section" id="m-call-candidates">
<h4><a class="toc-backref" href="#id395">13.3.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.candidates</tt></a></h4>
<p><em>Message Event</em></p>
<p>This event is sent by callers after sending an invite and by the callee after answering. Its purpose is to give the other party additional ICE candidates to try using to communicate.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>call_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the call this event
relates to.</td>
</tr>
<tr><td>candidates</td>
<td>[Candidate]</td>
<td><strong>Required.</strong> Array of objects describing the
candidates.</td>
</tr>
<tr><td>version</td>
<td>integer</td>
<td><strong>Required.</strong> The version of the VoIP
specification this messages adheres to. This
specification is version 0.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Candidate</caption>
<thead valign="bottom">
<tr><th class="head">Candidate Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sdpMid</td>
<td>string</td>
<td><strong>Required.</strong> The SDP media type this candidate is
intended for.</td>
</tr>
<tr><td>sdpMLineIndex</td>
<td>number</td>
<td><strong>Required.</strong> The index of the SDP 'm' line this
candidate is intended for.</td>
</tr>
<tr><td>candidate</td>
<td>string</td>
<td><strong>Required.</strong> The SDP 'a' line of the candidate.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;call_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;12345&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;candidates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
                <span class="name tag">&quot;candidate&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;candidate:863018703 1 udp 2122260223 10.9.64.156 43670 typ host generation 0&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;sdpMLineIndex&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
                <span class="name tag">&quot;sdpMid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;audio&quot;</span>
            <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.candidates&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-call-answer"></a></p>
<div class="section" id="m-call-answer">
<h4><a class="toc-backref" href="#id396">13.3.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.answer</tt></a></h4>
<p><em>Message Event</em></p>
<p>This event is sent by the callee when they wish to answer the call.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>call_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the call this event
relates to.</td>
</tr>
<tr><td>answer</td>
<td>Answer</td>
<td><strong>Required.</strong> The session description object</td>
</tr>
<tr><td>version</td>
<td>number</td>
<td><strong>Required.</strong></td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Answer</caption>
<thead valign="bottom">
<tr><th class="head">Answer Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of session description.
Must be 'answer'.</td>
</tr>
<tr><td>sdp</td>
<td>string</td>
<td><strong>Required.</strong> The SDP text of the session
description.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;answer&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;sdp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;v=0\r\no=- 6584580628695956864 2 IN IP4 127.0.0.1[...]&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;answer&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;call_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;12345&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;lifetime&quot;</span><span class="punctuation">:</span> <span class="literal number integer">60000</span><span class="punctuation">,</span>
        <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.answer&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-call-hangup"></a></p>
<div class="section" id="m-call-hangup">
<h4><a class="toc-backref" href="#id397">13.3.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.hangup</tt></a></h4>
<p><em>Message Event</em></p>
<p>Sent by either party to signal their termination of the call. This can be sent either once the call has has been established or before to abort the call.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>call_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the call this event
relates to.</td>
</tr>
<tr><td>version</td>
<td>integer</td>
<td><strong>Required.</strong> The version of the VoIP
specification this message adheres to. This
specification is version 0.</td>
</tr>
<tr><td>reason</td>
<td>enum</td>
<td>Optional error reason for the hangup. This should
not be provided when the user naturally ends or
rejects the call. When there was an error in the
call negotiation, this should be <tt class="docutils literal">ice_failed</tt>
for when ICE negotiation fails or
<tt class="docutils literal">invite_timeout</tt> for when the other party did
not answer in time. One of: [&quot;ice_failed&quot;,
&quot;invite_timeout&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;call_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;12345&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.hangup&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id90"></a></p>
<div class="section" id="id90">
<h3><a class="toc-backref" href="#id398">13.3.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>A call is set up with message events exchanged as follows:</p>
<pre class="literal-block">
  Caller                    Callee
[Place Call]
m.call.invite -----------&gt;
m.call.candidate --------&gt;
[..candidates..] --------&gt;
                          [Answers call]
         &lt;--------------- m.call.answer
   [Call is active and ongoing]
         &lt;--------------- m.call.hangup
</pre>
<p>Or a rejected call:</p>
<pre class="literal-block">
  Caller                      Callee
m.call.invite ------------&gt;
m.call.candidate ---------&gt;
[..candidates..] ---------&gt;
                           [Rejects call]
           &lt;-------------- m.call.hangup
</pre>
<p>Calls are negotiated according to the WebRTC specification.</p>
<p><a class="anchor" id="glare"></a></p>
<div class="section" id="glare">
<h4><a class="toc-backref" href="#id399">13.3.2.1&nbsp;&nbsp;&nbsp;Glare</a></h4>
<p>&quot;Glare&quot; is a problem which occurs when two users call each other at roughly the
same time. This results in the call failing to set up as there already is an
incoming/outgoing call. A glare resolution algorithm can be used to determine
which call to hangup and which call to answer. If both clients implement the
same algorithm then they will both select the same call and the call will be
successfully connected.</p>
<p>As calls are &quot;placed&quot; to rooms rather than users, the glare resolution algorithm
outlined below is only considered for calls which are to the same room. The
algorithm is as follows:</p>
<ul class="simple">
<li>If an <tt class="docutils literal">m.call.invite</tt> to a room is received whilst the client is
<strong>preparing to send</strong> an <tt class="docutils literal">m.call.invite</tt> to the same room:<ul>
<li>the client should cancel its outgoing call and instead
automatically accept the incoming call on behalf of the user.</li>
</ul>
</li>
<li>If an <tt class="docutils literal">m.call.invite</tt> to a room is received <strong>after the client has sent</strong>
an <tt class="docutils literal">m.call.invite</tt> to the same room and is waiting for a response:<ul>
<li>the client should perform a lexicographical comparison of the call IDs of
the two calls and use the <em>lesser</em> of the two calls, aborting the
greater. If the incoming call is the lesser, the client should accept
this call on behalf of the user.</li>
</ul>
</li>
</ul>
<p>The call setup should appear seamless to the user as if they had simply placed
a call and the other party had accepted. This means any media stream that had been
setup for use on a call should be transferred and used for the call that
replaces it.</p>
</div>
</div>
<p><a class="anchor" id="id91"></a></p>
<div class="section" id="id91">
<h3><a class="toc-backref" href="#id400">13.3.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>The homeserver MAY provide a TURN server which clients can use to contact the
remote party. The following HTTP API endpoints will be used by clients in order
to get information about the TURN server.</p>
<p><a class="anchor" id="get-matrix-client-r0-voip-turnserver"></a></p>
<div class="section" id="get-matrix-client-r0-voip-turnserver">
<h4><a class="toc-backref" href="#id401">13.3.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/voip/turnServer</tt></a></h4>
<p>This API provides credentials for the client to use when initiating
calls.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>username</td>
<td>string</td>
<td><strong>Required.</strong> The username to use.</td>
</tr>
<tr><td>password</td>
<td>string</td>
<td><strong>Required.</strong> The password to use.</td>
</tr>
<tr><td>uris</td>
<td>[string]</td>
<td><strong>Required.</strong> A list of TURN URIs</td>
</tr>
<tr><td>ttl</td>
<td>integer</td>
<td><strong>Required.</strong> The time-to-live in seconds</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/voip/turnServer</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The TURN server credentials.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;username&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1443779631:&#64;user:example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;JlKfBy1QwLrO20385QyAtEyIv0=&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;uris&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;turn:turn.example.com:3478?transport=udp&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;turn:10.20.30.40:3478?transport=tcp&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;turns:10.20.30.40:443?transport=tcp&quot;</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;ttl&quot;</span><span class="punctuation">:</span> <span class="literal number integer">86400</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id92"></a></p>
<div class="section" id="id92">
<h3><a class="toc-backref" href="#id402">13.3.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Calls should only be placed to rooms with one other user in them. If they are
placed to group chat rooms it is possible that another user will intercept and
answer the call.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id93"></a></p>
<div class="section" id="id93">
<h2><a class="toc-backref" href="#id403">13.4&nbsp;&nbsp;&nbsp;Typing Notifications</a></h2>
<p id="module-typing">Users may wish to be informed when another user is typing in a room. This can be
achieved using typing notifications. These are ephemeral events scoped to a
<tt class="docutils literal">room_id</tt>. This means they do not form part of the
<a class="reference external" href="index.html#event-graphs">Event Graph</a> but still have a <tt class="docutils literal">room_id</tt> key.</p>
<p><a class="anchor" id="id94"></a></p>
<div class="section" id="id94">
<h3><a class="toc-backref" href="#id404">13.4.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-typing"></a></p>
<div class="section" id="m-typing">
<h4><a class="toc-backref" href="#id405">13.4.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.typing</tt></a></h4>
<p>Informs the client of the list of users currently typing.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_ids</td>
<td>[string]</td>
<td><strong>Required.</strong> The list of user IDs typing in this
room, if any.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;user_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;&#64;alice:matrix.org&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;&#64;bob:example.com&quot;</span>
        <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.typing&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id95"></a></p>
<div class="section" id="id95">
<h3><a class="toc-backref" href="#id406">13.4.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>When a client receives an <tt class="docutils literal">m.typing</tt> event, it MUST use the user ID list to
<strong>REPLACE</strong> its knowledge of every user who is currently typing. The reason for
this is that the server <em>does not remember</em> users who are not currently typing
as that list gets big quickly. The client should mark as not typing any user ID
who is not in that list.</p>
<p>It is recommended that clients store a <tt class="docutils literal">boolean</tt> indicating whether the user
is typing or not. Whilst this value is <tt class="docutils literal">true</tt> a timer should fire periodically
every N seconds to send a typing HTTP request. The value of N is recommended to
be no more than 20-30 seconds. This request should be re-sent by the client to
continue informing the server the user is still typing. As subsequent
requests will replace older requests, a safety margin of 5 seconds before the
expected timeout runs out is recommended. When the user stops typing, the
state change of the <tt class="docutils literal">boolean</tt> to <tt class="docutils literal">false</tt> should trigger another HTTP request
to inform the server that the user has stopped typing.</p>
<p><a class="anchor" id="put-matrix-client-r0-rooms-roomid-typing-userid"></a></p>
<div class="section" id="put-matrix-client-r0-rooms-roomid-typing-userid">
<h4><a class="toc-backref" href="#id407">13.4.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/rooms/{roomId}/typing/{userId}</span></tt></a></h4>
<p>This tells the server that the user is typing for the next N
milliseconds where N is the value specified in the <tt class="docutils literal">timeout</tt> key.
Alternatively, if <tt class="docutils literal">typing</tt> is <tt class="docutils literal">false</tt>, it tells the server that the
user has stopped typing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user who has started to type.</td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room in which the user is
typing.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>typing</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the user is typing or not.
If <tt class="docutils literal">false</tt>, the <tt class="docutils literal">timeout</tt> key can be omitted.</td>
</tr>
<tr><td>timeout</td>
<td>integer</td>
<td>The length of time in milliseconds to mark this
user as typing.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/rooms/%21wefh3sfukhs%3Aexample.com/typing/%40alice%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;typing&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
  <span class="name tag">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="literal number integer">30000</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The new typing state was set.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id96"></a></p>
<div class="section" id="id96">
<h3><a class="toc-backref" href="#id408">13.4.3&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Clients may not wish to inform everyone in a room that they are typing and
instead only specific users in the room.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id97"></a></p>
<div class="section" id="id97">
<h2><a class="toc-backref" href="#id409">13.5&nbsp;&nbsp;&nbsp;Receipts</a></h2>
<p id="module-receipts">This module adds in support for receipts. These receipts are a form of
acknowledgement of an event. This module defines a single acknowledgement:
<tt class="docutils literal">m.read</tt> which indicates that the user has read up to a given event.</p>
<p>Sending a receipt for each event can result in sending large amounts of traffic
to a homeserver. To prevent this from becoming a problem, receipts are implemented
using &quot;up to&quot; markers. This marker indicates that the acknowledgement applies
to all events &quot;up to and including&quot; the event specified. For example, marking
an event as &quot;read&quot; would indicate that the user had read all events <em>up to</em> the
referenced event. See the <a class="reference external" href="#receiving-notifications">Receiving notifications</a>
section for more information on how read receipts affect notification counts.</p>
<p><a class="anchor" id="id98"></a></p>
<div class="section" id="id98">
<h3><a class="toc-backref" href="#id410">13.5.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p>Each <tt class="docutils literal">user_id</tt>, <tt class="docutils literal">receipt_type</tt> pair must be associated with only a
single <tt class="docutils literal">event_id</tt>.</p>
<p><a class="anchor" id="m-receipt"></a></p>
<div class="section" id="m-receipt">
<h4><a class="toc-backref" href="#id411">13.5.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.receipt</tt></a></h4>
<p>Informs the client of new receipts.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>$EVENT_ID</td>
<td>Receipts</td>
<td>The mapping of event ID to a collection of
receipts for this event ID. The event ID is the ID
of the event being acknowledged and <em>not</em> an ID
for the receipt itself.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Receipts</caption>
<thead valign="bottom">
<tr><th class="head">Receipts Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>m.read</td>
<td>Users</td>
<td>A collection of users who have sent <tt class="docutils literal">m.read</tt>
receipts for this event.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Users</caption>
<thead valign="bottom">
<tr><th class="head">Users Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>$USER_ID</td>
<td>Receipt</td>
<td>The mapping of user ID to receipt. The user ID is
the entity who sent this receipt.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Receipt</caption>
<thead valign="bottom">
<tr><th class="head">Receipt Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>ts</td>
<td>number</td>
<td>The timestamp the receipt was sent at.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;$1435641916114394fHBLK:matrix.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;m.read&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;&#64;rikj:jki.re&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                    <span class="name tag">&quot;ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1436451550453</span>
                <span class="punctuation">}</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.receipt&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id99"></a></p>
<div class="section" id="id99">
<h3><a class="toc-backref" href="#id412">13.5.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>In <tt class="docutils literal">/sync</tt>, receipts are listed under the <tt class="docutils literal">ephemeral</tt> array of events
for a given room. New receipts that come down the event streams are deltas
which update existing mappings. Clients should replace older receipt acknowledgements
based on <tt class="docutils literal">user_id</tt> and <tt class="docutils literal">receipt_type</tt> pairs. For example:</p>
<pre class="literal-block">
Client receives m.receipt:
  user = &#64;alice:example.com
  receipt_type = m.read
  event_id = $aaa:example.com

Client receives another m.receipt:
  user = &#64;alice:example.com
  receipt_type = m.read
  event_id = $bbb:example.com

The client should replace the older acknowledgement for $aaa:example.com with
this one for $bbb:example.com
</pre>
<p>Clients should send read receipts when there is some certainty that the event in
question has been <strong>displayed</strong> to the user. Simply receiving an event does not
provide enough certainty that the user has seen the event. The user SHOULD need
to <em>take some action</em> such as viewing the room that the event was sent to or
dismissing a notification in order for the event to count as &quot;read&quot;. Clients
SHOULD NOT send read receipts for events sent by their own user.</p>
<p>A client can update the markers for its user by interacting with the following
HTTP APIs.</p>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-receipt-receipttype-eventid"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-receipt-receipttype-eventid">
<h4><a class="toc-backref" href="#id413">13.5.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/receipt/{receiptType}/{eventId}</span></tt></a></h4>
<p>This API updates the marker for the given receipt type to the event ID
specified.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room in which to send the event.</td>
</tr>
<tr><td>receiptType</td>
<td>enum</td>
<td><strong>Required.</strong> The type of receipt to send. One of:
[&quot;m.read&quot;]</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID to acknowledge up to.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21wefuh21ffskfuh345%3Aexample.com/receipt/m.read/%241924376522eioj%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The receipt was sent.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id100"></a></p>
<div class="section" id="id100">
<h3><a class="toc-backref" href="#id414">13.5.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>For efficiency, receipts SHOULD be batched into one event per room before
delivering them to clients.</p>
<p>Receipts are sent across federation as EDUs with type <tt class="docutils literal">m.receipt</tt>. The
format of the EDUs are:</p>
<pre class="literal-block">
{
    &lt;room_id&gt;: {
        &lt;receipt_type&gt;: {
            &lt;user_id&gt;: { &lt;content&gt; }
        },
        ...
    },
    ...
}
</pre>
<p>These are always sent as deltas to previously sent receipts. Currently only a
single <tt class="docutils literal">&lt;receipt_type&gt;</tt> should be used: <tt class="docutils literal">m.read</tt>.</p>
</div>
<p><a class="anchor" id="id101"></a></p>
<div class="section" id="id101">
<h3><a class="toc-backref" href="#id415">13.5.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>As receipts are sent outside the context of the event graph, there are no
integrity checks performed on the contents of <tt class="docutils literal">m.receipt</tt> events.</p>
<!-- Copyright 2018 New Vector Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id102"></a></p>
<div class="section" id="id102">
<h2><a class="toc-backref" href="#id416">13.6&nbsp;&nbsp;&nbsp;Fully read markers</a></h2>
<p id="module-read-markers">The history for a given room may be split into three sections: messages the
user has read (or indicated they aren't interested in them), messages the user
might have read some but not others, and messages the user hasn't seen yet.
The &quot;fully read marker&quot; (also known as a &quot;read marker&quot;) marks the last event
of the first section, whereas the user's read receipt marks the last event of
the second section.</p>
<p><a class="anchor" id="id103"></a></p>
<div class="section" id="id103">
<h3><a class="toc-backref" href="#id417">13.6.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p>The user's fully read marker is kept as an event in the room's <a class="reference external" href="#client-config">account data</a>.
The event may be read to determine the user's current fully read marker location
in the room, and just like other account data events the event will be pushed down
the event stream when updated.</p>
<p>The fully read marker is kept under an <tt class="docutils literal">m.fully_read</tt> event. If the event does
not exist on the user's account data, the fully read marker should be considered
to be the user's read receipt location.</p>
<p><a class="anchor" id="m-fully-read"></a></p>
<div class="section" id="m-fully-read">
<h4><a class="toc-backref" href="#id418">13.6.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.fully_read</tt></a></h4>
<p>The current location of the user's read marker in a room. This event appears in the user's room account data for the room the marker is applicable for.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The event the user's read marker is
located at in the room.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$someplace:example.org&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!somewhere:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.fully_read&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id104"></a></p>
<div class="section" id="id104">
<h3><a class="toc-backref" href="#id419">13.6.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>The client cannot update fully read markers by directly modifying the <tt class="docutils literal">m.fully_read</tt>
account data event. Instead, the client must make use of the read markers API
to change the values.</p>
<p>The read markers API can additionally update the user's read receipt (<tt class="docutils literal">m.read</tt>)
location in the same operation as setting the fully read marker location. This is
because read receipts and read markers are commonly updated at the same time,
and therefore the client might wish to save an extra HTTP call. Providing an
<tt class="docutils literal">m.read</tt> location performs the same task as a request to <tt class="docutils literal"><span class="pre">/receipts/m.read/$event:example.org</span></tt>.</p>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-read-markers"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-read-markers">
<h4><a class="toc-backref" href="#id420">13.6.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/read_markers</span></tt></a></h4>
<p>Sets the position of the read marker for a given room, and optionally
the read receipt's location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room ID to set the read marker
in for the user.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>m.fully_read</td>
<td>string</td>
<td><strong>Required.</strong> The event ID the read marker should
be located at. The event MUST belong to the room.</td>
</tr>
<tr><td>m.read</td>
<td>string</td>
<td>The event ID to set the read receipt location at.
This is equivalent to calling
<tt class="docutils literal"><span class="pre">/receipt/m.read/$elsewhere:example.org</span></tt> and is
provided here to save that extra call.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21somewhere%3Aexample.org/read_markers</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;m.fully_read&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$somewhere:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;m.read&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$elsewhere:example.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The read marker, and read receipt if provided, have been updated.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id105"></a></p>
<div class="section" id="id105">
<h3><a class="toc-backref" href="#id421">13.6.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>The server MUST prevent clients from setting <tt class="docutils literal">m.fully_read</tt> directly in
room account data. The server must additionally ensure that it treats the
presence of <tt class="docutils literal">m.read</tt> in the <tt class="docutils literal">/read_markers</tt> request the same as how it
would for a request to <tt class="docutils literal"><span class="pre">/receipts/m.read/$event:example.org</span></tt>.</p>
<p>Upon updating the <tt class="docutils literal">m.fully_read</tt> event due to a request to <tt class="docutils literal">/read_markers</tt>,
the server MUST send the updated account data event through to the client via
the event stream (eg: <tt class="docutils literal">/sync</tt>), provided any applicable filters are also
satisfied.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id106"></a></p>
<div class="section" id="id106">
<h2><a class="toc-backref" href="#id422">13.7&nbsp;&nbsp;&nbsp;Presence</a></h2>
<p id="module-presence">Each user has the concept of presence information. This encodes:</p>
<ul class="simple">
<li>Whether the user is currently online</li>
<li>How recently the user was last active (as seen by the server)</li>
<li>Whether a given client considers the user to be currently idle</li>
<li>Arbitrary information about the user's current status (e.g. &quot;in a meeting&quot;).</li>
</ul>
<p>This information is collated from both per-device (<tt class="docutils literal">online</tt>, <tt class="docutils literal">idle</tt>,
<tt class="docutils literal">last_active</tt>) and per-user (status) data, aggregated by the user's homeserver
and transmitted as an <tt class="docutils literal">m.presence</tt> event. Presence events are sent to
interested parties where users share a room membership.</p>
<p>User's presence state is represented by the <tt class="docutils literal">presence</tt> key, which is an enum
of one of the following:</p>
<ul class="simple">
<li><tt class="docutils literal">online</tt> : The default state when the user is connected to an event
stream.</li>
<li><tt class="docutils literal">unavailable</tt> : The user is not reachable at this time e.g. they are
idle.</li>
<li><tt class="docutils literal">offline</tt> : The user is not connected to an event stream or is
explicitly suppressing their profile information from being sent.</li>
</ul>
<p><a class="anchor" id="id107"></a></p>
<div class="section" id="id107">
<h3><a class="toc-backref" href="#id423">13.7.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-presence"></a></p>
<div class="section" id="m-presence">
<h4><a class="toc-backref" href="#id424">13.7.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.presence</tt></a></h4>
<p>Informs the client of a user's presence state change.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The current avatar URL for this user, if any.</td>
</tr>
<tr><td>displayname</td>
<td>string</td>
<td>The current display name for this user, if any.</td>
</tr>
<tr><td>last_active_ago</td>
<td>number</td>
<td>The last time since this used performed some
action, in milliseconds.</td>
</tr>
<tr><td>presence</td>
<td>enum</td>
<td><strong>Required.</strong> The presence state for this user.
One of: [&quot;online&quot;, &quot;offline&quot;, &quot;unavailable&quot;]</td>
</tr>
<tr><td>currently_active</td>
<td>boolean</td>
<td>Whether the user is currently active</td>
</tr>
<tr><td>status_msg</td>
<td>string</td>
<td>An optional description to accompany the presence.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost:wefuiwegh8742w&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;currently_active&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
        <span class="name tag">&quot;last_active_ago&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2478593</span><span class="punctuation">,</span>
        <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;online&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;status_msg&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Making cupcakes&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.presence&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id108"></a></p>
<div class="section" id="id108">
<h3><a class="toc-backref" href="#id425">13.7.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients can manually set/get their presence using the HTTP APIs listed below.</p>
<p><a class="anchor" id="put-matrix-client-r0-presence-userid-status"></a></p>
<div class="section" id="put-matrix-client-r0-presence-userid-status">
<h4><a class="toc-backref" href="#id426">13.7.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/presence/{userId}/status</span></tt></a></h4>
<p>This API sets the given user's presence state. When setting the status,
the activity time is updated to reflect that activity; the client does
not need to specify the <tt class="docutils literal">last_active_ago</tt> field. You cannot set the
presence state of another user.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose presence state to
update.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>presence</td>
<td>enum</td>
<td><strong>Required.</strong> The new presence state. One of:
[&quot;online&quot;, &quot;offline&quot;, &quot;unavailable&quot;]</td>
</tr>
<tr><td>status_msg</td>
<td>string</td>
<td>The status message to attach to this state.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/presence/%40alice%3Aexample.com/status</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;online&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;status_msg&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;I am here.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The new presence state was set.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-presence-userid-status"></a></p>
<div class="section" id="get-matrix-client-r0-presence-userid-status">
<h4><a class="toc-backref" href="#id427">13.7.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/presence/{userId}/status</span></tt></a></h4>
<p>Get the given user's presence state.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose presence state to
get.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>presence</td>
<td>enum</td>
<td><strong>Required.</strong> This user's presence. One of:
[&quot;online&quot;, &quot;offline&quot;, &quot;unavailable&quot;]</td>
</tr>
<tr><td>last_active_ago</td>
<td>integer</td>
<td>The length of time in milliseconds since an action
was performed by this user.</td>
</tr>
<tr><td>status_msg</td>
<td>string or null</td>
<td>The state message for this user if one was set.</td>
</tr>
<tr><td>currently_active</td>
<td>boolean</td>
<td>Whether the user is currently active</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/presence/%40alice%3Aexample.com/status</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The presence state for this user.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;unavailable&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;last_active_ago&quot;</span><span class="punctuation">:</span> <span class="literal number integer">420845</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You are not allowed to see this user's presence status.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;You are not allowed to see their presence&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>There is no presence state for this user. This user may not exist or
isn't exposing presence information to you.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;An unknown error occurred&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="last-active-ago"></a></p>
<div class="section" id="last-active-ago">
<h4><a class="toc-backref" href="#id428">13.7.2.3&nbsp;&nbsp;&nbsp;Last active ago</a></h4>
<p>The server maintains a timestamp of the last time it saw a pro-active event from
the user. A pro-active event may be sending a message to a room or changing
presence state to <tt class="docutils literal">online</tt>. This timestamp is presented via a key called
<tt class="docutils literal">last_active_ago</tt> which gives the relative number of milliseconds since the
pro-active event.</p>
<p>To reduce the number of presence updates sent to clients the server may include
a <tt class="docutils literal">currently_active</tt> boolean field when the presence state is <tt class="docutils literal">online</tt>. When
true, the server will not send further updates to the last active time until an
update is sent to the client with either a) <tt class="docutils literal">currently_active</tt> set to false or
b) a presence state other than <tt class="docutils literal">online</tt>. During this period clients must
consider the user to be currently active, irrespective of the last active time.</p>
<p>The last active time must be up to date whenever the server gives a presence
event to the client. The <tt class="docutils literal">currently_active</tt> mechanism should purely be used by
servers to stop sending continuous presence updates, as opposed to disabling
last active tracking entirely. Thus clients can fetch up to date last active
times by explicitly requesting the presence for a given user.</p>
</div>
<p><a class="anchor" id="idle-timeout"></a></p>
<div class="section" id="idle-timeout">
<h4><a class="toc-backref" href="#id429">13.7.2.4&nbsp;&nbsp;&nbsp;Idle timeout</a></h4>
<p>The server will automatically set a user's presence to <tt class="docutils literal">unavailable</tt> if their
last active time was over a threshold value (e.g. 5 minutes). Clients can
manually set a user's presence to <tt class="docutils literal">unavailable</tt>. Any activity that bumps the
last active time on any of the user's clients will cause the server to
automatically set their presence to <tt class="docutils literal">online</tt>.</p>
</div>
</div>
<p><a class="anchor" id="id109"></a></p>
<div class="section" id="id109">
<h3><a class="toc-backref" href="#id430">13.7.3&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Presence information is shared with all users who share a room with the target
user. In large public rooms this could be undesirable.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!-- Copyright 2019 The Matrix.org Foundation C.I.C. -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id110"></a></p>
<div class="section" id="id110">
<h2><a class="toc-backref" href="#id431">13.8&nbsp;&nbsp;&nbsp;Content repository</a></h2>
<p id="module-content">The content repository (or &quot;media repository&quot;) allows users to upload
files to their homeserver for later user. For example, files which the
user wants to send to a room would be uploaded here, as would an avatar
the user wants to use.</p>
<p>Uploads are POSTed to a resource on the user's local homeserver which
returns a MXC URI which can later be used to GET the download. Content
is downloaded from the recipient's local homeserver, which must first
transfer the content from the origin homeserver using the same API
(unless the origin and destination homeservers are the same).</p>
<p>When serving content, the server SHOULD provide a <tt class="docutils literal"><span class="pre">Content-Security-Policy</span></tt>
header. The recommended policy is <tt class="docutils literal">sandbox; <span class="pre">default-src</span> 'none'; <span class="pre">script-src</span>
'none'; <span class="pre">plugin-types</span> application/pdf; <span class="pre">style-src</span> <span class="pre">'unsafe-inline';</span> <span class="pre">object-src</span>
'self';</tt>.</p>
<p><a class="anchor" id="matrix-content-mxc-uris"></a></p>
<div class="section" id="matrix-content-mxc-uris">
<h3><a class="toc-backref" href="#id432">13.8.1&nbsp;&nbsp;&nbsp;Matrix Content (MXC) URIs</a></h3>
<p id="mxc-uri">Content locations are represented as Matrix Content (MXC) URIs. They look
like:</p>
<pre class="literal-block">
mxc://&lt;server-name&gt;/&lt;media-id&gt;

&lt;server-name&gt; : The name of the homeserver where this content originated, e.g. matrix.org
&lt;media-id&gt; : An opaque ID which identifies the content.
</pre>
</div>
<p><a class="anchor" id="id111"></a></p>
<div class="section" id="id111">
<h3><a class="toc-backref" href="#id433">13.8.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients can upload and download content using the following HTTP APIs.</p>
<p><a class="anchor" id="post-matrix-media-r0-upload"></a></p>
<div class="section" id="post-matrix-media-r0-upload">
<h4><a class="toc-backref" href="#id434">13.8.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/media/r0/upload</tt></a></h4>
<p>Upload some content to the content repository.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>header parameters</em></td>
</tr>
<tr><td>Content-Type</td>
<td>string</td>
<td>The content type of the file being uploaded</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>filename</td>
<td>string</td>
<td>The name of the file being uploaded</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content_uri</td>
<td>string</td>
<td><strong>Required.</strong> The <a class="reference internal" href="#mxc-uri">MXC URI</a> to the uploaded
content.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/media/r0/upload?filename=War+and+Peace.pdf</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">Content-Type: application/pdf</span>

&lt;bytes&gt;
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The <a class="reference internal" href="#mxc-uri">MXC URI</a> for the uploaded content.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;content_uri&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.com/AQwafuaFswefuhsfAFAgsw&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user does not have permission to upload the content. Some reasons for this error include:</p>
<ul class="simple">
<li>The server does not permit the file type.</li>
<li>The user has reached a quota for uploaded content.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Cannot upload this content&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 413:</strong></p>
<p>The uploaded content is too large for the server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TOO_LARGE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Cannot upload files larger than 100mb&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-media-r0-download-servername-mediaid"></a></p>
<div class="section" id="get-matrix-media-r0-download-servername-mediaid">
<h4><a class="toc-backref" href="#id435">13.8.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/media/r0/download/{serverName}/{mediaId}</span></tt></a></h4>
<p>Download content from the content repository.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>serverName</td>
<td>string</td>
<td><strong>Required.</strong> The server name from the <tt class="docutils literal"><span class="pre">mxc://</span></tt>
URI (the authoritory component)</td>
</tr>
<tr><td>mediaId</td>
<td>string</td>
<td><strong>Required.</strong> The media ID from the <tt class="docutils literal"><span class="pre">mxc://</span></tt> URI
(the path component)</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>allow_remote</td>
<td>boolean</td>
<td>Indicates to the server that it should not attempt
to fetch the media if it is deemed remote. This is
to prevent routing loops where the server contacts
itself. Defaults to true if not provided.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response headers:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Content-Type</td>
<td>string</td>
<td>The content type of the file that was previously
uploaded.</td>
</tr>
<tr><td>Content-Disposition</td>
<td>string</td>
<td>The name of the file that was previously uploaded,
if set.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>file</td>
<td><strong>Required.</strong> The bytes for the uploaded file.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/media/r0/download/matrix.org/ascERGshawAWawugaAcauga?allow_remote=False</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The content that was previously uploaded.</p>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 502:</strong></p>
<p>The content is too large for the server to serve.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TOO_LARGE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Content is too large to serve&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-media-r0-download-servername-mediaid-filename"></a></p>
<div class="section" id="get-matrix-media-r0-download-servername-mediaid-filename">
<h4><a class="toc-backref" href="#id436">13.8.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/media/r0/download/{serverName}/{mediaId}/{fileName}</span></tt></a></h4>
<p>Download content from the content repository. This is the same as
the download endpoint above, except permitting a desired file name.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>serverName</td>
<td>string</td>
<td><strong>Required.</strong> The server name from the <tt class="docutils literal"><span class="pre">mxc://</span></tt>
URI (the authoritory component)</td>
</tr>
<tr><td>mediaId</td>
<td>string</td>
<td><strong>Required.</strong> The media ID from the <tt class="docutils literal"><span class="pre">mxc://</span></tt> URI
(the path component)</td>
</tr>
<tr><td>fileName</td>
<td>string</td>
<td><strong>Required.</strong> A filename to give in the <tt class="docutils literal">Content-
Disposition</tt> header.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>allow_remote</td>
<td>boolean</td>
<td>Indicates to the server that it should not attempt
to fetch the media if it is deemed remote. This is
to prevent routing loops where the server contacts
itself. Defaults to true if not provided.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response headers:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Content-Type</td>
<td>string</td>
<td>The content type of the file that was previously
uploaded.</td>
</tr>
<tr><td>Content-Disposition</td>
<td>string</td>
<td>The <tt class="docutils literal">fileName</tt> requested or the name of the file
that was previously uploaded, if set.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>file</td>
<td><strong>Required.</strong> The bytes for the uploaded file.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/media/r0/download/matrix.org/ascERGshawAWawugaAcauga/filename.jpg?allow_remote=False</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The content that was previously uploaded.</p>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 502:</strong></p>
<p>The content is too large for the server to serve.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TOO_LARGE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Content is too large to serve&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-media-r0-thumbnail-servername-mediaid"></a></p>
<div class="section" id="get-matrix-media-r0-thumbnail-servername-mediaid">
<h4><a class="toc-backref" href="#id437">13.8.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/media/r0/thumbnail/{serverName}/{mediaId}</span></tt></a></h4>
<p>Download a thumbnail of content from the content repository. See the <a class="reference external" href="#thumbnails">thumbnailing</a>
section for more information.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>serverName</td>
<td>string</td>
<td><strong>Required.</strong> The server name from the <tt class="docutils literal"><span class="pre">mxc://</span></tt>
URI (the authoritory component)</td>
</tr>
<tr><td>mediaId</td>
<td>string</td>
<td><strong>Required.</strong> The media ID from the <tt class="docutils literal"><span class="pre">mxc://</span></tt> URI
(the path component)</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>width</td>
<td>integer</td>
<td><strong>Required.</strong> The <em>desired</em> width of the
thumbnail. The actual thumbnail may be larger than
the size specified.</td>
</tr>
<tr><td>height</td>
<td>integer</td>
<td><strong>Required.</strong> The <em>desired</em> height of the
thumbnail. The actual thumbnail may be larger than
the size specified.</td>
</tr>
<tr><td>method</td>
<td>enum</td>
<td>The desired resizing method. See the <a class="reference external" href="#thumbnails">thumbnailing</a> section for more information. One
of: [&quot;crop&quot;, &quot;scale&quot;]</td>
</tr>
<tr><td>allow_remote</td>
<td>boolean</td>
<td>Indicates to the server that it should not attempt
to fetch the media if it is deemed remote. This is
to prevent routing loops where the server contacts
itself. Defaults to true if not provided.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response headers:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Content-Type</td>
<td>string</td>
<td>The content type of the thumbnail.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>file</td>
<td><strong>Required.</strong> The bytes for the thumbnail.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/media/r0/thumbnail/example.org/ascERGshawAWawugaAcauga?width=64&amp;height=64&amp;method=scale&amp;allow_remote=False</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>A thumbnail of the requested content.</p>
<p><strong>Status code 400:</strong></p>
<p>The request does not make sense to the server, or the server cannot thumbnail
the content. For example, the client requested non-integer dimensions or asked
for negatively-sized images.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Cannot generate thumbnails for the requested content&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 413:</strong></p>
<p>The local content is too large for the server to thumbnail.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TOO_LARGE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Content is too large to thumbnail&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 502:</strong></p>
<p>The remote content is too large for the server to thumbnail.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_TOO_LARGE&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Content is too large to thumbnail&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-media-r0-preview-url"></a></p>
<div class="section" id="get-matrix-media-r0-preview-url">
<h4><a class="toc-backref" href="#id438">13.8.2.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/media/r0/preview_url</tt></a></h4>
<p>Get information about a URL for a client</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>url</td>
<td>string</td>
<td><strong>Required.</strong> The URL to get a preview of.</td>
</tr>
<tr><td>ts</td>
<td>integer</td>
<td>The preferred point in time to return a preview
for. The server may return a newer version if it
does not have the requested version available.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>matrix:image:size</td>
<td>integer</td>
<td>The byte-size of the image. Omitted if there is no
image attached.</td>
</tr>
<tr><td>og:image</td>
<td>string</td>
<td>An <a class="reference internal" href="#mxc-uri">MXC URI</a> to the image. Omitted if there is no
image.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/media/r0/preview_url?url=https%3A%2F%2Fmatrix.org&amp;ts=1510610716656</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The OpenGraph data for the URL, which may be empty. Some values are
replaced with matrix equivalents if they are provided in the response.
The differences from the OpenGraph protocol are described here.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;og:title&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Matrix Blog Post&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;og:description&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is a really cool blog post from matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;og:image&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.com/ascERGshawAWawugaAcauga&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;og:image:type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/png&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;og:image:height&quot;</span><span class="punctuation">:</span> <span class="literal number integer">48</span><span class="punctuation">,</span>
  <span class="name tag">&quot;og:image:width&quot;</span><span class="punctuation">:</span> <span class="literal number integer">48</span><span class="punctuation">,</span>
  <span class="name tag">&quot;matrix:image:size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">102400</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-media-r0-config"></a></p>
<div class="section" id="get-matrix-media-r0-config">
<h4><a class="toc-backref" href="#id439">13.8.2.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/media/r0/config</tt></a></h4>
<p>This endpoint allows clients to retrieve the configuration of the content
repository, such as upload limitations.
Clients SHOULD use this as a guide when using content repository endpoints.
All values are intentionally left optional. Clients SHOULD follow
the advice given in the field description when the field is not available.</p>
<p><strong>NOTE:</strong> Both clients and server administrators should be aware that proxies
between the client and the server may affect the apparent behaviour of content
repository APIs, for example, proxies may enforce a lower upload size limit
than is advertised by the server on this endpoint.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>m.upload.size</td>
<td>integer</td>
<td>The maximum size an upload can be in bytes.
Clients SHOULD use this as a guide when uploading
content. If not listed or null, the size limit
should be treated as unknown.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/media/r0/config</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The public content repository configuration for the matrix server.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;m.upload.size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50000000</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;An unknown error occurred&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="thumbnails"></a></p>
<div class="section" id="thumbnails">
<h4><a class="toc-backref" href="#id440">13.8.2.7&nbsp;&nbsp;&nbsp;Thumbnails</a></h4>
<p>The homeserver SHOULD be able to supply thumbnails for uploaded images and
videos. The exact file types which can be thumbnailed are not currently
specified - see <a class="reference external" href="https://github.com/matrix-org/matrix-doc/issues/1938">Issue #1938</a>
for more information.</p>
<p>The thumbnail methods are &quot;crop&quot; and &quot;scale&quot;. &quot;scale&quot; tries to return an
image where either the width or the height is smaller than the requested
size. The client should then scale and letterbox the image if it needs to
fit within a given rectangle. &quot;crop&quot; tries to return an image where the
width and height are close to the requested size and the aspect matches
the requested size. The client should scale the image if it needs to fit
within a given rectangle.</p>
<p>The dimensions given to the thumbnail API are the minimum size the client
would prefer. Servers must never return thumbnails smaller than the client's
requested dimensions, unless the content being thumbnailed is smaller than
the dimensions. When the content is smaller than the requested dimensions,
servers should return the original content rather than thumbnail it.</p>
<p>Servers SHOULD produce thumbnails with the following dimensions and methods:</p>
<ul class="simple">
<li>32x32, crop</li>
<li>96x96, crop</li>
<li>320x240, scale</li>
<li>640x480, scale</li>
<li>800x600, scale</li>
</ul>
<dl class="docutils">
<dt>In summary:</dt>
<dd><ul class="first last simple">
<li>&quot;scale&quot; maintains the original aspect ratio of the image</li>
<li>&quot;crop&quot; provides an image in the aspect ratio of the sizes given in the request</li>
<li>The server will return an image larger than or equal to the dimensions requested
where possible.</li>
</ul>
</dd>
</dl>
<p>Servers MUST NOT upscale thumbnails under any circumstance. Servers MUST NOT
return a smaller thumbnail than requested, unless the original content makes
that impossible.</p>
</div>
</div>
<p><a class="anchor" id="id113"></a></p>
<div class="section" id="id113">
<h3><a class="toc-backref" href="#id441">13.8.3&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>The HTTP GET endpoint does not require any authentication. Knowing the URL of
the content is sufficient to retrieve the content, even if the entity isn't in
the room.</p>
<p>MXC URIs are vulnerable to directory traversal attacks such as
<tt class="docutils literal"><span class="pre">mxc://127.0.0.1/../../../some_service/etc/passwd</span></tt>. This would cause the target
homeserver to try to access and return this file. As such, homeservers MUST
sanitise MXC URIs by allowing only alphanumeric (<tt class="docutils literal"><span class="pre">A-Za-z0-9</span></tt>), <tt class="docutils literal">_</tt>
and  <tt class="docutils literal">-</tt> characters in the <tt class="docutils literal"><span class="pre">server-name</span></tt> and <tt class="docutils literal"><span class="pre">media-id</span></tt> values. This set
of whitelisted characters allows URL-safe base64 encodings specified in RFC 4648.
Applying this character whitelist is preferable to blacklisting <tt class="docutils literal">.</tt> and <tt class="docutils literal">/</tt>
as there are techniques around blacklisted characters (percent-encoded characters,
UTF-8 encoded traversals, etc).</p>
<p>Homeservers have additional content-specific concerns:</p>
<ul class="simple">
<li>Clients may try to upload very large files. Homeservers should not store files
that are too large and should not serve them to clients, returning a HTTP 413
error with the <tt class="docutils literal">M_TOO_LARGE</tt> code.</li>
<li>Clients may try to upload very large images. Homeservers should not attempt to
generate thumbnails for images that are too large, returning a HTTP 413 error
with the <tt class="docutils literal">M_TOO_LARGE</tt> code.</li>
<li>Remote homeservers may host very large files or images. Homeservers should not
proxy or thumbnail large files or images from remote homeservers, returning a
HTTP 502 error with the <tt class="docutils literal">M_TOO_LARGE</tt> code.</li>
<li>Clients may try to upload a large number of files. Homeservers should limit the
number and total size of media that can be uploaded by clients, returning a
HTTP 403 error with the <tt class="docutils literal">M_FORBIDDEN</tt> code.</li>
<li>Clients may try to access a large number of remote files through a homeserver.
Homeservers should restrict the number and size of remote files that it caches.</li>
<li>Clients or remote homeservers may try to upload malicious files targeting
vulnerabilities in either the homeserver thumbnailing or the client decoders.</li>
</ul>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id114"></a></p>
<div class="section" id="id114">
<span id="to-device"></span><span id="module-to-device"></span><h2><a class="toc-backref" href="#id442">13.9&nbsp;&nbsp;&nbsp;Send-to-Device messaging</a></h2>
<p>This module provides a means by which clients can exchange signalling messages
without them being stored permanently as part of a shared communication
history. A message is delivered exactly once to each client device.</p>
<p>The primary motivation for this API is exchanging data that is meaningless or
undesirable to persist in the room DAG - for example, one-time authentication
tokens or key data. It is not intended for conversational data, which should be
sent using the normal <a class="reference external" href="#put-matrix-client-r0-rooms-roomid-send-eventtype-txnid"><tt class="docutils literal"><span class="pre">/rooms/&lt;room_id&gt;/send</span></tt></a> API for consistency throughout
Matrix.</p>
<p><a class="anchor" id="id115"></a></p>
<div class="section" id="id115">
<h3><a class="toc-backref" href="#id443">13.9.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>To send a message to other devices, a client should call <a class="reference external" href="#put-matrix-client-r0-sendtodevice-eventtype-txnid"><tt class="docutils literal">/sendToDevice</tt></a>.
Only one message can be sent to each device per transaction, and they must all
have the same event type. The device ID in the request body can be set to <tt class="docutils literal">*</tt>
to request that the message be sent to all known devices.</p>
<p>If there are send-to-device messages waiting for a client, they will be
returned by <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a>, as detailed in <a class="reference internal" href="#send-to-device-sync">Extensions to /sync</a>. Clients should
inspect the <tt class="docutils literal">type</tt> of each returned event, and ignore any they do not
understand.</p>
</div>
<p><a class="anchor" id="id116"></a></p>
<div class="section" id="id116">
<h3><a class="toc-backref" href="#id444">13.9.2&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Servers should store pending messages for local users until they are
successfully delivered to the destination device. When a client calls <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a>
with an access token which corresponds to a device with pending messages, the
server should list the pending messages, in order of arrival, in the response
body.</p>
<p>When the client calls <tt class="docutils literal">/sync</tt> again with the <tt class="docutils literal">next_batch</tt> token from the
first response, the server should infer that any send-to-device messages in
that response have been delivered successfully, and delete them from the store.</p>
<p>If there is a large queue of send-to-device messages, the server should
limit the number sent in each <tt class="docutils literal">/sync</tt> response. 100 messages is recommended
as a reasonable limit.</p>
<p>If the client sends messages to users on remote domains, those messages should
be sent on to the remote servers via
<a class="reference external" href="../server_server/r0.1.2.html#send-to-device-messaging">federation</a>.</p>
<!-- TODO-spec:

* Is a server allowed to delete undelivered messages? After how long? What
  about if the device is deleted?

* If the destination HS doesn't support the ``m.direct_to_device`` EDU, it
  will just get dumped. Should we indicate that to the client? -->
</div>
<p><a class="anchor" id="protocol-definitions"></a></p>
<div class="section" id="protocol-definitions">
<h3><a class="toc-backref" href="#id445">13.9.3&nbsp;&nbsp;&nbsp;Protocol definitions</a></h3>
<p><a class="anchor" id="put-matrix-client-r0-sendtodevice-eventtype-txnid"></a></p>
<div class="section" id="put-matrix-client-r0-sendtodevice-eventtype-txnid">
<h4><a class="toc-backref" href="#id446">13.9.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/sendToDevice/{eventType}/{txnId}</span></tt></a></h4>
<p>This endpoint is used to send send-to-device events to a set of
client devices.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>eventType</td>
<td>string</td>
<td><strong>Required.</strong> The type of event to send.</td>
</tr>
<tr><td>txnId</td>
<td>string</td>
<td><strong>Required.</strong> The transaction ID for this event.
Clients should generate an ID unique across
requests with the same access token; it will be
used by the server to ensure idempotency of
requests.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>messages</td>
<td>{string: {string: EventContent}}</td>
<td>The messages to send. A map from user ID, to a map
from device ID to message body. The device ID may
also be <cite>*</cite>, meaning all known devices for the
user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/sendToDevice/m.new_device/35</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;messages&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;TLLBEANAAG&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;example_content_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;value&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The message was successfully sent.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<!-- TODO-spec:

* What should a server do if the user id or device id is unknown? Presumably
  it shouldn't reject the request outright, because some of the destinations
  may be valid. Should we add something to the response? -->
<!-- anchor for link from /sync api spec -->
</div>
<p><a class="anchor" id="extensions-to-sync"></a></p>
<div class="section" id="extensions-to-sync">
<span id="send-to-device-sync"></span><h4><a class="toc-backref" href="#id447">13.9.3.2&nbsp;&nbsp;&nbsp;Extensions to /sync</a></h4>
<p>This module adds the following properties to the <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a> response:</p>
<!-- todo: generate this from a swagger definition? -->
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="12%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>to_device</td>
<td>ToDevice</td>
<td>Optional. Information on the send-to-device messages
for the client device.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">ToDevice</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[Event]</td>
<td>List of send-to-device messages.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Event</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="15%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>EventContent</td>
<td>The content of this event. The fields in this
object will vary depending on the type of event.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td>The Matrix user ID of the user who sent this
event.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td>The type of event.</td>
</tr>
</tbody>
</table>
<p>Example response:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;next_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s72595_4483_1934&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="name tag">&quot;leave&quot;</span><span class="punctuation">:</span> <span class="punctuation">{},</span> <span class="name tag">&quot;join&quot;</span><span class="punctuation">:</span> <span class="punctuation">{},</span> <span class="name tag">&quot;invite&quot;</span><span class="punctuation">:</span> <span class="punctuation">{}},</span>
  <span class="name tag">&quot;to_device&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.new_device&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;XYZABCDE&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="literal string double">&quot;!726s6s6q:example.com&quot;</span><span class="punctuation">]</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">]</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
</div>
<p><a class="anchor" id="id117"></a></p>
<div class="section" id="id117">
<h2><a class="toc-backref" href="#id448">13.10&nbsp;&nbsp;&nbsp;Device Management</a></h2>
<p id="module-device-management">This module provides a means for a user to manage their <a class="reference external" href="../index.html#devices">devices</a>.</p>
<p><a class="anchor" id="id118"></a></p>
<div class="section" id="id118">
<h3><a class="toc-backref" href="#id449">13.10.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients that implement this module should offer the user a list of registered
devices, as well as the means to update their display names. Clients should
also allow users to delete disused devices.</p>
<p><a class="anchor" id="get-matrix-client-r0-devices"></a></p>
<div class="section" id="get-matrix-client-r0-devices">
<h4><a class="toc-backref" href="#id450">13.10.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/devices</tt></a></h4>
<p>Gets information about all devices for the current user.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>devices</td>
<td>[Device]</td>
<td>A list of all registered devices for this user.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Device</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>device_id</td>
<td>string</td>
<td><strong>Required.</strong> Identifier of this device.</td>
</tr>
<tr><td>display_name</td>
<td>string</td>
<td>Display name set by the user for this device.
Absent if no name has been set.</td>
</tr>
<tr><td>last_seen_ip</td>
<td>string</td>
<td>The IP address where this device was last seen.
(May be a few minutes out of date, for efficiency
reasons).</td>
</tr>
<tr><td>last_seen_ts</td>
<td>integer</td>
<td>The timestamp (in milliseconds since the unix
epoch) when this devices was last seen. (May be a
few minutes out of date, for efficiency reasons).</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/devices</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>Device information</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;devices&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;QBUAZIFURK&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;android&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;last_seen_ip&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1.2.3.4&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;last_seen_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1474491775024</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-devices-deviceid"></a></p>
<div class="section" id="get-matrix-client-r0-devices-deviceid">
<h4><a class="toc-backref" href="#id451">13.10.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/devices/{deviceId}</span></tt></a></h4>
<p>Gets information on a single device, by device id.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>deviceId</td>
<td>string</td>
<td><strong>Required.</strong> The device to retrieve.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Device</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>device_id</td>
<td>string</td>
<td><strong>Required.</strong> Identifier of this device.</td>
</tr>
<tr><td>display_name</td>
<td>string</td>
<td>Display name set by the user for this device.
Absent if no name has been set.</td>
</tr>
<tr><td>last_seen_ip</td>
<td>string</td>
<td>The IP address where this device was last seen.
(May be a few minutes out of date, for efficiency
reasons).</td>
</tr>
<tr><td>last_seen_ts</td>
<td>integer</td>
<td>The timestamp (in milliseconds since the unix
epoch) when this devices was last seen. (May be a
few minutes out of date, for efficiency reasons).</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/devices/QBUAZIFURK</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Device information</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;QBUAZIFURK&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;android&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;last_seen_ip&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1.2.3.4&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;last_seen_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1474491775024</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The current user has no device with the given ID.</p>
</div>
<p><a class="anchor" id="put-matrix-client-r0-devices-deviceid"></a></p>
<div class="section" id="put-matrix-client-r0-devices-deviceid">
<h4><a class="toc-backref" href="#id452">13.10.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/devices/{deviceId}</span></tt></a></h4>
<p>Updates the metadata on the given device.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>deviceId</td>
<td>string</td>
<td><strong>Required.</strong> The device to update.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>display_name</td>
<td>string</td>
<td>The new display name for this device. If not
given, the display name is unchanged.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/devices/QBUAZIFURK</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;My other phone&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The device was successfully updated.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The current user has no device with the given ID.</p>
</div>
<p><a class="anchor" id="delete-matrix-client-r0-devices-deviceid"></a></p>
<div class="section" id="delete-matrix-client-r0-devices-deviceid">
<h4><a class="toc-backref" href="#id453">13.10.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">DELETE <span class="pre">/_matrix/client/r0/devices/{deviceId}</span></tt></a></h4>
<p>This API endpoint uses the <a class="reference internal" href="#user-interactive-authentication-api">User-Interactive Authentication API</a>.</p>
<p>Deletes the given device, and invalidates any access token associated with it.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>deviceId</td>
<td>string</td>
<td><strong>Required.</strong> The device to delete.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>auth</td>
<td>Authentication Data</td>
<td>Additional authentication information for the
user-interactive authentication API.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Authentication Data</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The login type that the client is
attempting to complete.</td>
</tr>
<tr><td>session</td>
<td>string</td>
<td>The value of the session key given by the
homeserver.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">DELETE</span> <span class="name namespace">/_matrix/client/r0/devices/QBUAZIFURK</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.type.foo&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxxxx&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;example_credential&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;verypoorsharedsecret&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The device was successfully removed, or had been removed
previously.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The homeserver requires additional authentication information.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;flows&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;stages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;example.type.foo&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;example.type.baz&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;example_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foobar&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxxxxxyz&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;completed&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;example.type.foo&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-delete-devices"></a></p>
<div class="section" id="post-matrix-client-r0-delete-devices">
<h4><a class="toc-backref" href="#id454">13.10.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/delete_devices</tt></a></h4>
<p>This API endpoint uses the <a class="reference internal" href="#user-interactive-authentication-api">User-Interactive Authentication API</a>.</p>
<p>Deletes the given devices, and invalidates any access token associated with them.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>devices</td>
<td>[string]</td>
<td><strong>Required.</strong> The list of device IDs to delete.</td>
</tr>
<tr><td>auth</td>
<td>Authentication Data</td>
<td>Additional authentication information for the
user-interactive authentication API.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Authentication Data</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The login type that the client is
attempting to complete.</td>
</tr>
<tr><td>session</td>
<td>string</td>
<td>The value of the session key given by the
homeserver.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/delete_devices</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;devices&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;QBUAZIFURK&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;AUIECTSRND&quot;</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.type.foo&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxxxx&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;example_credential&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;verypoorsharedsecret&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The devices were successfully removed, or had been removed
previously.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The homeserver requires additional authentication information.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;flows&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;stages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;example.type.foo&quot;</span>
      <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;example.type.baz&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;example_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foobar&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;session&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxxxxxyz&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;completed&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;example.type.foo&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id119"></a></p>
<div class="section" id="id119">
<h3><a class="toc-backref" href="#id455">13.10.2&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Deleting devices has security implications: it invalidates the access_token
assigned to the device, so an attacker could use it to log out the real user
(and do it repeatedly every time the real user tries to log in to block the
attacker). Servers should require additional authentication beyond the access
token when deleting devices (for example, requiring that the user resubmit
their password).</p>
<p>The display names of devices are publicly visible. Clients should consider
advising the user of this.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!-- Copyright 2019 The Matrix.org Foundation C.I.C. -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id120"></a></p>
<div class="section" id="id120">
<h2><a class="toc-backref" href="#id456">13.11&nbsp;&nbsp;&nbsp;End-to-End Encryption</a></h2>
<p id="module-e2e">Matrix optionally supports end-to-end encryption, allowing rooms to be created
whose conversation contents are not decryptable or interceptable on any of the
participating homeservers.</p>
<p><a class="anchor" id="key-distribution"></a></p>
<div class="section" id="key-distribution">
<h3><a class="toc-backref" href="#id457">13.11.1&nbsp;&nbsp;&nbsp;Key Distribution</a></h3>
<p>Encryption and Authentication in Matrix is based around public-key
cryptography. The Matrix protocol provides a basic mechanism for exchange of
public keys, though an out-of-band channel is required to exchange fingerprints
between users to build a web of trust.</p>
<p><a class="anchor" id="id121"></a></p>
<div class="section" id="id121">
<h4><a class="toc-backref" href="#id458">13.11.1.1&nbsp;&nbsp;&nbsp;Overview</a></h4>
<pre class="code literal-block">
1) Bob publishes the public keys and supported algorithms for his
   device. This may include long-term identity keys, and/or one-time
   keys.

                                      +----------+  +--------------+
                                      | Bob's HS |  | Bob's Device |
                                      +----------+  +--------------+
                                            |              |
                                            |&lt;=============|
                                              /keys/upload

2) Alice requests Bob's public identity keys and supported algorithms.

  +----------------+  +------------+  +----------+
  | Alice's Device |  | Alice's HS |  | Bob's HS |
  +----------------+  +------------+  +----------+
         |                  |               |
         |=================&gt;|==============&gt;|
           /keys/query        &lt;federation&gt;

3) Alice selects an algorithm and claims any one-time keys needed.

  +----------------+  +------------+  +----------+
  | Alice's Device |  | Alice's HS |  | Bob's HS |
  +----------------+  +------------+  +----------+
         |                  |               |
         |=================&gt;|==============&gt;|
           /keys/claim         &lt;federation&gt;
</pre>
</div>
<p><a class="anchor" id="key-algorithms"></a></p>
<div class="section" id="key-algorithms">
<h4><a class="toc-backref" href="#id459">13.11.1.2&nbsp;&nbsp;&nbsp;Key algorithms</a></h4>
<p>The name <tt class="docutils literal">ed25519</tt> corresponds to the <a class="reference external" href="http://ed25519.cr.yp.to/">Ed25519</a> signature algorithm. The key
is a 32-byte Ed25519 public key, encoded using <a class="reference external" href="../appendices.html#unpadded-base64">unpadded Base64</a>. Example:</p>
<pre class="code json literal-block">
<span class="literal string double">&quot;SogYyrkTldLz0BXP+GYWs0qaYacUI0RleEqNT8J3riQ&quot;</span>
</pre>
<p>The name <tt class="docutils literal">curve25519</tt> corresponds to the <a class="reference external" href="https://cr.yp.to/ecdh.html">Curve25519</a> ECDH algorithm. The
key is a 32-byte Curve25519 public key, encoded using <a class="reference external" href="../appendices.html#unpadded-base64">unpadded
Base64</a>. Example:</p>
<pre class="code json literal-block">
<span class="literal string double">&quot;JGLn/yafz74HB2AbPLYJWIVGnKAtqECOBf11yyXac2Y&quot;</span>
</pre>
<p>The name <tt class="docutils literal">signed_curve25519</tt> also corresponds to the Curve25519 algorithm,
but keys using this algorithm are objects with the properties <tt class="docutils literal">key</tt> (giving
the Base64-encoded 32-byte Curve25519 public key), and <tt class="docutils literal">signatures</tt> (giving a
signature for the key object, as described in <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>). Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;06UzBknVHFMwgi7AVloY7ylC+xhOhEX4PkNge14Grl8&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;&#64;user:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;ed25519:EGURVBUNJP&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;YbJva03ihSj5mPk+CHMJKUKlCXCPFXjXOK6VqBnN9nA2evksQcTGn6hwQfrgRHIDDXO2le49x7jnWJHMJrJoBQ&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="id122"></a></p>
<div class="section" id="id122">
<h4><a class="toc-backref" href="#id460">13.11.1.3&nbsp;&nbsp;&nbsp;Device keys</a></h4>
<p>Each device should have one Ed25519 signing key. This key should be generated
on the device from a cryptographically secure source, and the private part of
the key should never be exported from the device. This key is used as the
fingerprint for a device by other clients.</p>
<p>A device will generally need to generate a number of additional keys. Details
of these will vary depending on the messaging algorithm in use.</p>
<p>Algorithms generally require device identity keys as well as signing keys. Some
algorithms also require one-time keys to improve their secrecy and deniability.
These keys are used once during session establishment, and are then thrown
away.</p>
<p>For Olm version 1, each device requires a single Curve25519 identity key, and a
number of signed Curve25519 one-time keys.</p>
</div>
<p><a class="anchor" id="uploading-keys"></a></p>
<div class="section" id="uploading-keys">
<h4><a class="toc-backref" href="#id461">13.11.1.4&nbsp;&nbsp;&nbsp;Uploading keys</a></h4>
<p>A device uploads the public parts of identity keys to their homeserver as a
signed JSON object, using the <a class="reference external" href="#post-matrix-client-r0-keys-upload"><tt class="docutils literal">/keys/upload</tt></a> API.
The JSON object must include the public part of the device's Ed25519 key, and
must be signed by that key, as described in <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
<p>One-time keys are also uploaded to the homeserver using the <a class="reference external" href="#post-matrix-client-r0-keys-upload"><tt class="docutils literal">/keys/upload</tt></a>
API.</p>
<p>Devices must store the private part of each key they upload. They can
discard the private part of a one-time key when they receive a message using
that key. However it's possible that a one-time key given out by a homeserver
will never be used, so the device that generates the key will never know that
it can discard the key. Therefore a device could end up trying to store too
many private keys. A device that is trying to store too many private keys may
discard keys starting with the oldest.</p>
</div>
<p><a class="anchor" id="tracking-the-device-list-for-a-user"></a></p>
<div class="section" id="tracking-the-device-list-for-a-user">
<h4><a class="toc-backref" href="#id462">13.11.1.5&nbsp;&nbsp;&nbsp;Tracking the device list for a user</a></h4>
<p>Before Alice can send an encrypted message to Bob, she needs a list of each of
his devices and the associated identity keys, so that she can establish an
encryption session with each device. This list can be obtained by calling
<a class="reference external" href="#post-matrix-client-r0-keys-query"><tt class="docutils literal">/keys/query</tt></a>, passing Bob's user ID in the <tt class="docutils literal">device_keys</tt> parameter.</p>
<p>From time to time, Bob may add new devices, and Alice will need to know this so
that she can include his new devices for later encrypted messages. A naive
solution to this would be to call <a class="reference external" href="#post-matrix-client-r0-keys-query"><tt class="docutils literal">/keys/query</tt></a> before sending each message -
however, the number of users and devices may be large and this would be
inefficient.</p>
<p>It is therefore expected that each client will maintain a list of devices for a
number of users (in practice, typically each user with whom we share an
encrypted room). Furthermore, it is likely that this list will need to be
persisted between invocations of the client application (to preserve device
verification data and to alert Alice if Bob suddenly gets a new
device).</p>
<p>Alice's client can maintain a list of Bob's devices via the following
process:</p>
<ol class="arabic simple">
<li>It first sets a flag to record that it is now tracking Bob's device list,
and a separate flag to indicate that its list of Bob's devices is
outdated. Both flags should be in storage which persists over client
restarts.</li>
<li>It then makes a request to <a class="reference external" href="#post-matrix-client-r0-keys-query"><tt class="docutils literal">/keys/query</tt></a>, passing Bob's user ID in the
<tt class="docutils literal">device_keys</tt> parameter. When the request completes, it stores the
resulting list of devices in persistent storage, and clears the 'outdated'
flag.</li>
<li>During its normal processing of responses to <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a>, Alice's client
inspects the <tt class="docutils literal">changed</tt> property of the <a class="reference internal" href="#device-lists-sync"><tt class="docutils literal">device_lists</tt></a> field. If it is
tracking the device lists of any of the listed users, then it marks the
device lists for those users outdated, and initiates another request to
<a class="reference external" href="#post-matrix-client-r0-keys-query"><tt class="docutils literal">/keys/query</tt></a> for them.</li>
<li>Periodically, Alice's client stores the <tt class="docutils literal">next_batch</tt> field of the result
from <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a> in persistent storage. If Alice later restarts her client, it
can obtain a list of the users who have updated their device list while it
was offline by calling <a class="reference external" href="#get-matrix-client-r0-keys-changes"><tt class="docutils literal">/keys/changes</tt></a>, passing the recorded <tt class="docutils literal">next_batch</tt>
field as the <tt class="docutils literal">from</tt> parameter. If the client is tracking the device list
of any of the users listed in the response, it marks them as outdated. It
combines this list with those already flagged as outdated, and initiates a
<a class="reference external" href="#post-matrix-client-r0-keys-query"><tt class="docutils literal">/keys/query</tt></a> request for all of them.</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Bob may update one of his devices while Alice has a request to
<tt class="docutils literal">/keys/query</tt> in flight. Alice's client may therefore see Bob's user ID in
the <tt class="docutils literal">device_lists</tt> field of the <tt class="docutils literal">/sync</tt> response while the first request
is in flight, and initiate a second request to <tt class="docutils literal">/keys/query</tt>. This may
lead to either of two related problems.</p>
<p>The first problem is that, when the first request completes, the client will
clear the 'outdated' flag for Bob's devices. If the second request fails, or
the client is shut down before it completes, this could lead to Alice using
an outdated list of Bob's devices.</p>
<p>The second possibility is that, under certain conditions, the second request
may complete <em>before</em> the first one. When the first request completes, the
client could overwrite the later results from the second request with those
from the first request.</p>
<p class="last">Clients MUST guard against these situations. For example, a client could
ensure that only one request to <tt class="docutils literal">/keys/query</tt> is in flight at a time for
each user, by queuing additional requests until the first completes.
Alternatively, the client could make a new request immediately, but ensure
that the first request's results are ignored (possibly by cancelling the
request).</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When Bob and Alice share a room, with Bob tracking Alice's devices, she may leave
the room and then add a new device. Bob will not be notified of this change,
as he doesn't share a room anymore with Alice. When they start sharing a
room again, Bob has an out-of-date list of Alice's devices. In order to address
this issue, Bob's homeserver will add Alice's user ID to the <tt class="docutils literal">changed</tt> property of
the <tt class="docutils literal">device_lists</tt> field, thus Bob will update his list of Alice's devices as part
of his normal processing. Note that Bob can also be notified when he stops sharing
any room with Alice by inspecting the <tt class="docutils literal">left</tt> property of the <tt class="docutils literal">device_lists</tt>
field, and as a result should remove her from its list of tracked users.</p>
</div>
</div>
<p><a class="anchor" id="sending-encrypted-attachments"></a></p>
<div class="section" id="sending-encrypted-attachments">
<h4><a class="toc-backref" href="#id463">13.11.1.6&nbsp;&nbsp;&nbsp;Sending encrypted attachments</a></h4>
<p>When encryption is enabled in a room, files should be uploaded encrypted on
the homeserver.</p>
<p>In order to achieve this, a client should generate a single-use 256-bit AES
key, and encrypt the file using AES-CTR. The counter should be 64-bit long,
starting at 0 and prefixed by a random 64-bit Initialization Vector (IV), which
together form a 128-bit unique counter block.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">An IV must never be used multiple times with the same key. This implies that
if there are multiple files to encrypt in the same message, typically an
image and its thumbnail, the files must not share both the same key and IV.</p>
</div>
<p>Then, the encrypted file can be uploaded to the homeserver.
The key and the IV must be included in the room event along with the resulting
<tt class="docutils literal"><span class="pre">mxc://</span></tt> in order to allow recipients to decrypt the file. As the event
containing those will be Megolm encrypted, the server will never have access to
the decrypted file.</p>
<p>A hash of the ciphertext must also be included, in order to prevent the homeserver from
changing the file content.</p>
<p>A client should send the data as an encrypted <tt class="docutils literal">m.room.message</tt> event, using
either <tt class="docutils literal">m.file</tt> as the msgtype, or the appropriate msgtype for the file
type. The key is sent using the <a class="reference external" href="https://tools.ietf.org/html/rfc7517#appendix-A.3">JSON Web Key</a> format, with a <a class="reference external" href="https://w3c.github.io/webcrypto/#iana-section-jwk">W3C
extension</a>.</p>
<!-- anchor for link from m.message api spec -->
<p><a class="anchor" id="extensions-to-m-message-msgtypes"></a></p>
<div class="section" id="extensions-to-m-message-msgtypes">
<span id="encrypted-files"></span><h5><a class="toc-backref" href="#id464">13.11.1.6.1&nbsp;&nbsp;&nbsp;Extensions to <tt class="docutils literal">m.message</tt> msgtypes</a></h5>
<p>This module adds <tt class="docutils literal">file</tt> and <tt class="docutils literal">thumbnail_file</tt> properties, of type
<tt class="docutils literal">EncryptedFile</tt>, to <tt class="docutils literal">m.message</tt> msgtypes that reference files, such as
<a class="reference internal" href="#m-file">m.file</a> and <a class="reference internal" href="#m-image">m.image</a>, replacing the <tt class="docutils literal">url</tt> and <tt class="docutils literal">thumbnail_url</tt>
properties.</p>
<!-- todo: generate this from a swagger definition? -->
<p><tt class="docutils literal">EncryptedFile</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="20%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>url</td>
<td>string</td>
<td><strong>Required.</strong> The URL to the file.</td>
</tr>
<tr><td>key</td>
<td>JWK</td>
<td><strong>Required.</strong> A <a class="reference external" href="https://tools.ietf.org/html/rfc7517#appendix-A.3">JSON Web Key</a> object.</td>
</tr>
<tr><td>iv</td>
<td>string</td>
<td><strong>Required.</strong> The Initialisation Vector used by
AES-CTR, encoded as unpadded base64.</td>
</tr>
<tr><td>hashes</td>
<td>{string: string}</td>
<td><strong>Required.</strong> A map from an algorithm name to a hash
of the ciphertext, encoded as unpadded base64. Clients
should support the SHA-256 hash, which uses the key
<tt class="docutils literal">sha256</tt>.</td>
</tr>
<tr><td>v</td>
<td>string</td>
<td><strong>Required.</strong> Version of the encrypted attachments
protocol. Must be <tt class="docutils literal">v2</tt>.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">JWK</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="12%" />
<col width="77%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>kty</td>
<td>string</td>
<td><strong>Required.</strong> Key type. Must be <tt class="docutils literal">oct</tt>.</td>
</tr>
<tr><td>key_ops</td>
<td>[string]</td>
<td><strong>Required.</strong> Key operations. Must at least contain
<tt class="docutils literal">encrypt</tt> and <tt class="docutils literal">decrypt</tt>.</td>
</tr>
<tr><td>alg</td>
<td>string</td>
<td><strong>Required.</strong> Algorithm. Must be <tt class="docutils literal">A256CTR</tt>.</td>
</tr>
<tr><td>k</td>
<td>string</td>
<td><strong>Required.</strong> The key, encoded as urlsafe unpadded base64.</td>
</tr>
<tr><td>ext</td>
<td>boolean</td>
<td><strong>Required.</strong> Extractable. Must be <tt class="docutils literal">true</tt>. This is a
<a class="reference external" href="https://w3c.github.io/webcrypto/#iana-section-jwk">W3C extension</a>.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.jpg&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;v&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;v2&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;A256CTR&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;ext&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;k&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;aWF6-32KGYaC3A_FEUCk1Bt0JA37zP0wrStgmdCaW-0&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;key_ops&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="literal string double">&quot;encrypt&quot;</span><span class="punctuation">,</span><span class="literal string double">&quot;decrypt&quot;</span><span class="punctuation">],</span>
        <span class="name tag">&quot;kty&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;oct&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;iv&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;w+sE15fzSc0AAAAAAAAAAA&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;hashes&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;fdSLu/YkRx3Wyh3KQabP3rd6+SFiKg5lsJZQHtkSAYA&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1536</span><span class="punctuation">,</span>
      <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">422018</span><span class="punctuation">,</span>
      <span class="name tag">&quot;thumbnail_file&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;hashes&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;/NogKqW5bz/m8xHgFiH5haFGjCNVmUIPLzfvOhHdrxY&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;iv&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;U+k7PfwLr6UAAAAAAAAAAA&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;A256CTR&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;ext&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
          <span class="name tag">&quot;k&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;RMyd6zhlbifsACM1DXkCbioZ2u0SywGljTH8JmGcylg&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;key_ops&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="literal string double">&quot;encrypt&quot;</span><span class="punctuation">,</span> <span class="literal string double">&quot;decrypt&quot;</span><span class="punctuation">],</span>
          <span class="name tag">&quot;kty&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;oct&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/pmVJxyxGlmxHposwVSlOaEOv&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;v&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;v2&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;thumbnail_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">768</span><span class="punctuation">,</span>
        <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">211009</span><span class="punctuation">,</span>
        <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">432</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">864</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.image&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="claiming-one-time-keys"></a></p>
<div class="section" id="claiming-one-time-keys">
<h4><a class="toc-backref" href="#id465">13.11.1.7&nbsp;&nbsp;&nbsp;Claiming one-time keys</a></h4>
<p>A client wanting to set up a session with another device can claim a one-time
key for that device. This is done by making a request to the <a class="reference external" href="#post-matrix-client-r0-keys-claim"><tt class="docutils literal">/keys/claim</tt></a>
API.</p>
<p>A homeserver should rate-limit the number of one-time keys that a given user or
remote server can claim. A homeserver should discard the public part of a one
time key once it has given that key to another user.</p>
</div>
</div>
<p><a class="anchor" id="device-verification"></a></p>
<div class="section" id="device-verification">
<h3><a class="toc-backref" href="#id466">13.11.2&nbsp;&nbsp;&nbsp;Device verification</a></h3>
<p>Before Alice sends Bob encrypted data, or trusts data received from him, she
may want to verify that she is actually communicating with him, rather than a
man-in-the-middle. This verification process requires an out-of-band channel:
there is no way to do it within Matrix without trusting the administrators of
the homeservers.</p>
<p>In Matrix, verification works by Alice meeting Bob in person, or contacting him
via some other trusted medium, and use <a class="reference internal" href="#sas-verification">SAS Verification</a> to interactively
verify Bob's devices. Alice and Bob may also read aloud their unpadded base64
encoded Ed25519 public key, as returned by <tt class="docutils literal">/keys/query</tt>.</p>
<p>Device verification may reach one of several conclusions. For example:</p>
<ul class="simple">
<li>Alice may &quot;accept&quot; the device. This means that she is satisfied that the
device belongs to Bob. She can then encrypt sensitive material for that
device, and knows that messages received were sent from that device.</li>
<li>Alice may &quot;reject&quot; the device. She will do this if she knows or suspects
that Bob does not control that device (or equivalently, does not trust
Bob). She will not send sensitive material to that device, and cannot trust
messages apparently received from it.</li>
<li>Alice may choose to skip the device verification process. She is not able
to verify that the device actually belongs to Bob, but has no reason to
suspect otherwise. The encryption protocol continues to protect against
passive eavesdroppers.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Once the signing key has been verified, it is then up to the encryption
protocol to verify that a given message was sent from a device holding that
Ed25519 private key, or to encrypt a message so that it may only be
decrypted by such a device. For the Olm protocol, this is documented at
<a class="reference external" href="https://matrix.org/git/olm/about/docs/signing.rst">https://matrix.org/git/olm/about/docs/signing.rst</a>.</p>
</div>
<p><a class="anchor" id="key-verification-framework"></a></p>
<div class="section" id="key-verification-framework">
<h4><a class="toc-backref" href="#id467">13.11.2.1&nbsp;&nbsp;&nbsp;Key verification framework</a></h4>
<p>Verifying keys manually by reading out the Ed25519 key is not very user friendly,
and can lead to errors. In order to help mitigate errors, and to make the process
eaiser for users, some verification methods are supported by the specification.
The methods all use a common framework for negotiating the key verification.</p>
<p>To use this framework, Alice's client would send <tt class="docutils literal">m.key.verification.request</tt>
events to Bob's devices. All of the <tt class="docutils literal">to_device</tt> messages sent to Bob MUST have
the same <tt class="docutils literal">transaction_id</tt> to indicate they are part of the same request. This
allows Bob to reject the request on one device, and have it apply to all of his
devices. Similarly, it allows Bob to process the verification on one device without
having to involve all of his devices.</p>
<p>When Bob's device receives a <tt class="docutils literal">m.key.verification.request</tt>, it should prompt Bob
to verify keys with Alice using one of the supported methods in the request. If
Bob's device does not understand any of the methods, it should not cancel the request
as one of his other devices may support the request. Instead, Bob's device should
tell Bob that an unsupported method was used for starting key verification. The
prompt for Bob to accept/reject Alice's request (or the unsupported method prompt)
should be automatically dismissed 10 minutes after the <tt class="docutils literal">timestamp</tt> field or 2
minutes after Bob's client receives the message, whichever comes first, if Bob
does not interact with the prompt. The prompt should additionally be hidden if
an appropriate <tt class="docutils literal">m.key.verification.cancel</tt> message is received.</p>
<p>If Bob rejects the request, Bob's client must send a <tt class="docutils literal">m.key.verification.cancel</tt>
message to Alice's device. Upon receipt, Alice's device should tell her that Bob
does not want to verify her device and send <tt class="docutils literal">m.key.verification.cancel</tt> messages
to all of Bob's devices to notify them that the request was rejected.</p>
<p>If Bob accepts the request, Bob's device starts the key verification process by
sending a <tt class="docutils literal">m.key.verification.start</tt> message to Alice's device. Upon receipt
of this message, Alice's device should send a <tt class="docutils literal">m.key.verification.cancel</tt> message
to all of Bob's other devices to indicate the process has been started. The start
message must use the same <tt class="docutils literal">transaction_id</tt> from the original key verification
request if it is in response to the request. The start message can be sent indepdently
of any request.</p>
<p>Individual verification methods may add additional steps, events, and properties to
the verification messages. Event types for methods defined in this specification must
be under the <tt class="docutils literal">m.key.verification</tt> namespace and any other event types must be namespaced
according to the Java package naming convention.</p>
<p>Any of Alice's or Bob's devices can cancel the key verification request or process
at any time with a <tt class="docutils literal">m.key.verification.cancel</tt> message to all applicable devices.</p>
<p>This framework yields the following handshake, assuming both Alice and Bob each have
2 devices, Bob's first device accepts the key verification request, and Alice's second
device initiates the request. Note how Alice's first device is not involved in the
request or verification process.</p>
<pre class="literal-block">
+---------------+ +---------------+                    +-------------+ +-------------+
| AliceDevice1  | | AliceDevice2  |                    | BobDevice1  | | BobDevice2  |
+---------------+ +---------------+                    +-------------+ +-------------+
        |                 |                                   |               |
        |                 | m.key.verification.request        |               |
        |                 |----------------------------------&gt;|               |
        |                 |                                   |               |
        |                 | m.key.verification.request        |               |
        |                 |--------------------------------------------------&gt;|
        |                 |                                   |               |
        |                 |          m.key.verification.start |               |
        |                 |&lt;----------------------------------|               |
        |                 |                                   |               |
        |                 | m.key.verification.cancel         |               |
        |                 |--------------------------------------------------&gt;|
        |                 |                                   |               |
</pre>
<p>After the handshake, the verification process begins.</p>
<p><a class="anchor" id="m-key-verification-request"></a></p>
<div class="section" id="m-key-verification-request">
<h5><a class="toc-backref" href="#id468">13.11.2.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.request</tt></a></h5>
<p>Requests a key verification with another user's devices. Typically sent as a
<a class="reference internal" href="#to-device">to-device</a> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>from_device</td>
<td>string</td>
<td><strong>Required.</strong> The device ID which is initiating
the request.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td><strong>Required.</strong> An opaque identifier for the
verification request. Must be unique with respect
to the devices involved.</td>
</tr>
<tr><td>methods</td>
<td>[string]</td>
<td><strong>Required.</strong> The verification methods supported
by the sender.</td>
</tr>
<tr><td>timestamp</td>
<td>integer</td>
<td><strong>Required.</strong> The POSIX timestamp in milliseconds
for when the request was made. If the request is
in the future by more than 5 minutes or more than
10 minutes in the past, the message should be
ignored by the receiver.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;from_device&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;AliceDevice2&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;m.sas.v1&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1559598944869</span><span class="punctuation">,</span>
        <span class="name tag">&quot;transaction_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;S0meUniqueAndOpaqueString&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.key.verification.request&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-key-verification-start"></a></p>
<div class="section" id="m-key-verification-start">
<h5><a class="toc-backref" href="#id469">13.11.2.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.start</tt></a></h5>
<p>Begins a key verification process. Typically sent as a <a class="reference internal" href="#to-device">to-device</a> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>from_device</td>
<td>string</td>
<td><strong>Required.</strong> The device ID which is initiating
the process.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td><strong>Required.</strong> An opaque identifier for the
verification process. Must be unique with respect
to the devices involved. Must be the same as the
<tt class="docutils literal">transaction_id</tt> given in the
<tt class="docutils literal">m.key.verification.request</tt> if this process is
originating from a request.</td>
</tr>
<tr><td>method</td>
<td>string</td>
<td><strong>Required.</strong> The verification method to use.</td>
</tr>
<tr><td>next_method</td>
<td>string</td>
<td>Optional method to use to verify the other user's
key with. Applicable when the <tt class="docutils literal">method</tt> chosen
only verifies one user's key.</td>
</tr>
</tbody>
</table>
<p>Examples:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;from_device&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;BobDevice1&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;method&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.sas.v1&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;transaction_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;S0meUniqueAndOpaqueString&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.key.verification.start&quot;</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;from_device&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;BobDevice1&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;hashes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;sha256&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;key_agreement_protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;curve25519&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;message_authentication_codes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;hkdf-hmac-sha256&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;method&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.sas.v1&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;short_authentication_string&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;decimal&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;emoji&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;transaction_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;S0meUniqueAndOpaqueString&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.key.verification.start&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-key-verification-cancel"></a></p>
<div class="section" id="m-key-verification-cancel">
<h5><a class="toc-backref" href="#id470">13.11.2.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.cancel</tt></a></h5>
<p>Cancels a key verification process/request. Typically sent as a <a class="reference internal" href="#to-device">to-device</a> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>transaction_id</td>
<td>string</td>
<td><strong>Required.</strong> The opaque identifier for the
verification process/request.</td>
</tr>
<tr><td>reason</td>
<td>string</td>
<td><strong>Required.</strong> A human readable description of the
<tt class="docutils literal">code</tt>. The client should only rely on this
string if it does not understand the <tt class="docutils literal">code</tt>.</td>
</tr>
<tr><td>code</td>
<td>string</td>
<td><p class="first"><strong>Required.</strong> The error code for why the
process/request was cancelled by the user. Error
codes should use the Java package naming
convention if not in the following list:</p>
<p><tt class="docutils literal">m.user</tt>: The user cancelled the verification.</p>
<p><tt class="docutils literal">m.timeout</tt>: The verification process timed out.
Verification processes can define their own
timeout parameters.</p>
<p><tt class="docutils literal">m.unknown_transaction</tt>: The device does not
know about the given transaction ID.</p>
<p><tt class="docutils literal">m.unknown_method</tt>: The device does not know how
to handle the requested method. This should be
sent for <tt class="docutils literal">m.key.verification.start</tt> messages and
messages defined by individual verification
processes.</p>
<p><tt class="docutils literal">m.unexpected_message</tt>: The device received an
unexpected message. Typically raised when one of
the parties is handling the verification out of
order.</p>
<p><tt class="docutils literal">m.key_mismatch</tt>: The key was not verified.</p>
<p><tt class="docutils literal">m.user_mismatch</tt>: The expected user did not
match the user verified.</p>
<p><tt class="docutils literal">m.invalid_message</tt>: The message received was
invalid.</p>
<p><tt class="docutils literal">m.accepted</tt>: A <tt class="docutils literal">m.key.verification.request</tt>
was accepted by a different   device. The device
receiving this error can ignore the verification
request.</p>
<p class="last">Clients should be careful to avoid error loops.
For example, if a device sends an incorrect
message and the client returns
<tt class="docutils literal">m.invalid_message</tt> to which it gets an
unexpected response with <tt class="docutils literal">m.unexpected_message</tt>,
the client should not respond again with
<tt class="docutils literal">m.unexpected_message</tt> to avoid the other device
potentially sending another error response.</p>
<!-- The above blank line is important for RST. -->
</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;code&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.user&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;User rejected the key verification request&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;transaction_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;S0meUniqueAndOpaqueString&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.key.verification.cancel&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="short-authentication-string-sas-verification"></a></p>
<div class="section" id="short-authentication-string-sas-verification">
<span id="sas-verification"></span><h4><a class="toc-backref" href="#id471">13.11.2.2&nbsp;&nbsp;&nbsp;Short Authentication String (SAS) verification</a></h4>
<p>SAS verification is a user-friendly key verification process built off the common
framework outlined above. SAS verification is intended to be a highly interactive
process for users, and as such exposes verfiication methods which are easier for
users to use.</p>
<p>The verification process is heavily inspired by Phil Zimmerman's ZRTP key agreement
handshake. A key part of key agreement in ZRTP is the hash commitment: the party that
begins the Diffie-Hellman key sharing sends a hash of their part of the Diffie-Hellman
exchange, and does not send their part of the Diffie-Hellman exchange until they have
received the other party's part. Thus an attacker essentially only has one attempt to
attack the Diffie-Hellman exchange, and hence we can verify fewer bits while still
achieving a high degree of security: if we verify n bits, then an attacker has a 1 in
2<sup>n</sup> chance of success.  For example, if we verify 40 bits, then an attacker has
a 1 in 1,099,511,627,776 chance (or less than 1 in 1012 chance) of success. A failed
attack would result in a mismatched Short Authentication String, alerting users to the
attack.</p>
<p>The verification process takes place over <a class="reference internal" href="#to-device">to-device</a> messages in two phases:</p>
<ol class="arabic simple">
<li>Key agreement phase (based on <a class="reference external" href="https://tools.ietf.org/html/rfc6189#section-4.4.1">ZRTP key agreement</a>).</li>
<li>Key verification phase (based on HMAC).</li>
</ol>
<p>The process between Alice and Bob verifying each other would be:</p>
<ol class="arabic simple">
<li>Alice and Bob establish a secure out-of-band connection, such as meeting
in-person or a video call. &quot;Secure&quot; here means that either party cannot be
impersonated, not explicit secrecy.</li>
<li>Alice and Bob communicate which devices they'd like to verify with each other.</li>
<li>Alice selects Bob's device from the device list and begins verification.</li>
<li>Alice's client ensures it has a copy of Bob's device key.</li>
<li>Alice's device sends Bob's device a <tt class="docutils literal">m.key.verification.start</tt> message.</li>
<li>Bob's device receives the message and selects a key agreement protocol, hash
algorithm, message authentication code, and SAS method supported by Alice's
device.</li>
<li>Bob's device ensures it has a copy of Alice's device key.</li>
<li>Bob's device creates an ephemeral Curve25519 key pair (<span class="formula"><i>K</i><span class="scripts"><sup class="script"><i>private</i></sup><sub class="script"><i>B</i></sub></span>, <i>K</i><span class="scripts"><sup class="script"><i>public</i></sup><sub class="script"><i>B</i></sub></span></span>), and
calculates the hash (using the chosen algorithm) of the public key <span class="formula"><i>K</i><span class="scripts"><sup class="script"><i>public</i></sup><sub class="script"><i>B</i></sub></span></span>.</li>
<li>Bob's device replies to Alice's device with a <tt class="docutils literal">m.key.verification.accept</tt> message.</li>
<li>Alice's device receives Bob's message and stores the commitment hash for later use.</li>
<li>Alice's device creates an ephemeral Curve25519 key pair (<span class="formula"><i>K</i><span class="scripts"><sup class="script"><i>private</i></sup><sub class="script"><i>A</i></sub></span>, <i>K</i><span class="scripts"><sup class="script"><i>public</i></sup><sub class="script"><i>A</i></sub></span></span>) and
replies to Bob's device with a <tt class="docutils literal">m.key.verification.key</tt>, sending only the public
key <span class="formula"><i>K</i><span class="scripts"><sup class="script"><i>public</i></sup><sub class="script"><i>A</i></sub></span></span>.</li>
<li>Bob's device receives Alice's message and replies with its own <tt class="docutils literal">m.key.verification.key</tt>
message containing its public key <span class="formula"><i>K</i><span class="scripts"><sup class="script"><i>public</i></sup><sub class="script"><i>B</i></sub></span></span>.</li>
<li>Alice's device receives Bob's message and verifies the commitment hash from earlier
matches the hash of the key Bob's device just sent and the content of Alice's
<tt class="docutils literal">m.key.verification.start</tt> message.</li>
<li>Both Alice and Bob's devices perform an Elliptic-curve Diffie-Hellman (<span class="formula"><i>ECDH</i>(<i>K</i><span class="scripts"><sup class="script"><i>private</i></sup><sub class="script"><i>A</i></sub></span>, <i>K</i><span class="scripts"><sup class="script"><i>public</i></sup><sub class="script"><i>B</i></sub></span>)</span>),
using the result as the shared secret.</li>
<li>Both Alice and Bob's devices display a SAS to their users, which is derived
from the shared key using one of the methods in this section. If multiple SAS
methods are available, clients should allow the users to select a method.</li>
<li>Alice and Bob compare the strings shown by their devices, and tell their devices if
they match or not.</li>
<li>Assuming they match, Alice and Bob's devices calculate the HMAC of their own device keys
and a comma-separated sorted list of of the key IDs that they wish the other user
to verify, using SHA-256 as the hash function. HMAC is defined in [RFC 2104](<a class="reference external" href="https://tools.ietf.org/html/rfc2104">https://tools.ietf.org/html/rfc2104</a>).
The key for the HMAC is different for each item and is calculated by generating
32 bytes (256 bits) using <a class="reference external" href="#SAS-HKDF">the key verification HKDF</a>.</li>
<li>Alice's device sends Bob's device a <tt class="docutils literal">m.key.verification.mac</tt> message containing the
MAC of Alice's device keys and the MAC of her key IDs to be verified. Bob's device does
the same for Bob's device keys and key IDs concurrently with Alice.</li>
<li>When the other device receives the <tt class="docutils literal">m.key.verification.mac</tt> message, the device
calculates the HMAC of its copies of the other device's keys given in the message,
as well as the HMAC of the comma-seperated, sorted, list of key IDs in the message.
The device compares these with the HMAC values given in the message, and if everything
matches then the device keys are verified.</li>
</ol>
<p>The wire protocol looks like the following between Alice and Bob's devices:</p>
<pre class="literal-block">
+-------------+                    +-----------+
| AliceDevice |                    | BobDevice |
+-------------+                    +-----------+
      |                                 |
      | m.key.verification.start        |
      |--------------------------------&gt;|
      |                                 |
      |       m.key.verification.accept |
      |&lt;--------------------------------|
      |                                 |
      | m.key.verification.key          |
      |--------------------------------&gt;|
      |                                 |
      |          m.key.verification.key |
      |&lt;--------------------------------|
      |                                 |
      | m.key.verification.mac          |
      |--------------------------------&gt;|
      |                                 |
      |          m.key.verification.mac |
      |&lt;--------------------------------|
      |                                 |
</pre>
<p><a class="anchor" id="error-and-exception-handling"></a></p>
<div class="section" id="error-and-exception-handling">
<h5><a class="toc-backref" href="#id472">13.11.2.2.1&nbsp;&nbsp;&nbsp;Error and exception handling</a></h5>
<p>At any point the interactive verfication can go wrong. The following describes what
to do when an error happens:</p>
<ul class="simple">
<li>Alice or Bob can cancel the verification at any time. A <tt class="docutils literal">m.key.verification.cancel</tt>
message must be sent to signify the cancellation.</li>
<li>The verification can time out. Clients should time out a verification that does not
complete within 10 minutes. Additionally, clients should expire a <tt class="docutils literal">transaction_id</tt>
which goes unused for 10 minutes after having last sent/received it. The client should
inform the user that the verification timed out, and send an appropriate
<tt class="docutils literal">m.key.verification.cancel</tt> message to the other device.</li>
<li>When the same device attempts to intiate multiple verification attempts, the receipient
should cancel all attempts with that device.</li>
<li>When a device receives an unknown <tt class="docutils literal">transaction_id</tt>, it should send an appropriate
<tt class="docutils literal">m.key.verfication.cancel</tt> message to the other device indicating as such. This
does not apply for inbound <tt class="docutils literal">m.key.verification.start</tt> or <tt class="docutils literal">m.key.verification.cancel</tt>
messages.</li>
<li>If the two devices do not share a common key share, hash, HMAC, or SAS method then
the device should notify the other device with an appropriate <tt class="docutils literal">m.key.verification.cancel</tt>
message.</li>
<li>If the user claims the Short Authentication Strings do not match, the device should
send an appropriate <tt class="docutils literal">m.key.verification.cancel</tt> message to the other device.</li>
<li>If the device receives a message out of sequence or that it was not expecting, it should
notify the other device with an appropriate <tt class="docutils literal">m.key.verification.cancel</tt> message.</li>
</ul>
</div>
<p><a class="anchor" id="verification-messages-specific-to-sas"></a></p>
<div class="section" id="verification-messages-specific-to-sas">
<h5><a class="toc-backref" href="#id473">13.11.2.2.2&nbsp;&nbsp;&nbsp;Verification messages specific to SAS</a></h5>
<p>Building off the common framework, the following events are involved in SAS verification.</p>
<p>The <tt class="docutils literal">m.key.verification.cancel</tt> event is unchanged, however the following error codes
are used in addition to those already specified:</p>
<ul class="simple">
<li><tt class="docutils literal">m.unknown_method</tt>: The devices are unable to agree on the key agreement, hash, MAC,
or SAS method.</li>
<li><tt class="docutils literal">m.mismatched_commitment</tt>: The hash commitment did not match.</li>
<li><tt class="docutils literal">m.mismatched_sas</tt>: The SAS did not match.</li>
</ul>
</div>
<p><a class="anchor" id="id123"></a></p>
<div class="section" id="id123">
<h5><a class="toc-backref" href="#id474">13.11.2.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.start</tt></a></h5>
<p>Begins a SAS key verification process. Typically sent as a <a class="reference internal" href="#to-device">to-device</a> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>from_device</td>
<td>string</td>
<td><strong>Required.</strong> The device ID which is initiating
the process.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td><strong>Required.</strong> An opaque identifier for the
verification process. Must be unique with respect
to the devices involved. Must be the same as the
<tt class="docutils literal">transaction_id</tt> given in the
<tt class="docutils literal">m.key.verification.request</tt> if this process is
originating from a request.</td>
</tr>
<tr><td>method</td>
<td>string</td>
<td><strong>Required.</strong> The verification method to use. Must
be <tt class="docutils literal">m.sas.v1</tt>. Must be 'm.sas.v1'.</td>
</tr>
<tr><td>key_agreement_protocols</td>
<td>[string]</td>
<td><strong>Required.</strong> The key agreement protocols the
sending device understands. Must include at least
<tt class="docutils literal">curve25519</tt>.</td>
</tr>
<tr><td>hashes</td>
<td>[string]</td>
<td><strong>Required.</strong> The hash methods the sending device
understands. Must include at least <tt class="docutils literal">sha256</tt>.</td>
</tr>
<tr><td>message_authentication_codes</td>
<td>[string]</td>
<td><strong>Required.</strong> The message authentication codes
that the sending device understands. Must include
at least <tt class="docutils literal"><span class="pre">hkdf-hmac-sha256</span></tt>.</td>
</tr>
<tr><td>short_authentication_string</td>
<td>[enum]</td>
<td><strong>Required.</strong> The SAS methods the sending device
(and the sending device's user) understands. Must
include at least <tt class="docutils literal">decimal</tt>. Optionally can
include <tt class="docutils literal">emoji</tt>. One of: [&quot;decimal&quot;, &quot;emoji&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;from_device&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;BobDevice1&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;hashes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;sha256&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;key_agreement_protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;curve25519&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;message_authentication_codes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;hkdf-hmac-sha256&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;method&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.sas.v1&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;short_authentication_string&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;decimal&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;emoji&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;transaction_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;S0meUniqueAndOpaqueString&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.key.verification.start&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-key-verification-accept"></a></p>
<div class="section" id="m-key-verification-accept">
<h5><a class="toc-backref" href="#id475">13.11.2.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.accept</tt></a></h5>
<p>Accepts a previously sent <tt class="docutils literal">m.key.verification.start</tt> messge. Typically sent as a
<a class="reference internal" href="#to-device">to-device</a> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>transaction_id</td>
<td>string</td>
<td><strong>Required.</strong> An opaque identifier for the
verification process. Must be the same as the one
used for the <tt class="docutils literal">m.key.verification.start</tt> message.</td>
</tr>
<tr><td>method</td>
<td>string</td>
<td><strong>Required.</strong> The verification method to use. Must
be 'm.sas.v1'.</td>
</tr>
<tr><td>key_agreement_protocol</td>
<td>string</td>
<td><strong>Required.</strong> The key agreement protocol the
device is choosing to use, out of the options in
the <tt class="docutils literal">m.key.verification.start</tt> message.</td>
</tr>
<tr><td>hash</td>
<td>string</td>
<td><strong>Required.</strong> The hash method the device is
choosing to use, out of the options in the
<tt class="docutils literal">m.key.verification.start</tt> message.</td>
</tr>
<tr><td>message_authentication_code</td>
<td>string</td>
<td><strong>Required.</strong> The message authentication code the
device is choosing to use, out of the options in
the <tt class="docutils literal">m.key.verification.start</tt> message.</td>
</tr>
<tr><td>short_authentication_string</td>
<td>[enum]</td>
<td><strong>Required.</strong> The SAS methods both devices
involved in the verification process understand.
Must be a subset of the options in the
<tt class="docutils literal">m.key.verification.start</tt> message. One of:
[&quot;decimal&quot;, &quot;emoji&quot;]</td>
</tr>
<tr><td>commitment</td>
<td>string</td>
<td><strong>Required.</strong> The hash (encoded as unpadded
base64) of the concatenation of the device's
ephemeral public key (encoded as unpadded base64)
and the canonical JSON representation of the
<tt class="docutils literal">m.key.verification.start</tt> message.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;commitment&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sha256&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;key_agreement_protocol&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;curve25519&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;message_authentication_code&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;hkdf-hmac-sha256&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;method&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.sas.v1&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;short_authentication_string&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;decimal&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;emoji&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;transaction_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;S0meUniqueAndOpaqueString&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.key.verification.accept&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-key-verification-key"></a></p>
<div class="section" id="m-key-verification-key">
<h5><a class="toc-backref" href="#id476">13.11.2.2.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.key</tt></a></h5>
<p>Sends the ephemeral public key for a device to the partner device. Typically sent as a
<a class="reference internal" href="#to-device">to-device</a> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>transaction_id</td>
<td>string</td>
<td><strong>Required.</strong> An opaque identifier for the
verification process. Must be the same as the one
used for the <tt class="docutils literal">m.key.verification.start</tt> message.</td>
</tr>
<tr><td>key</td>
<td>string</td>
<td><strong>Required.</strong> The device's ephemeral public key,
encoded as unpadded base64.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;transaction_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;S0meUniqueAndOpaqueString&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.key.verification.key&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-key-verification-mac"></a></p>
<div class="section" id="m-key-verification-mac">
<h5><a class="toc-backref" href="#id477">13.11.2.2.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.key.verification.mac</tt></a></h5>
<p>Sends the MAC of a device's key to the partner device. Typically sent as a
<a class="reference internal" href="#to-device">to-device</a> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>transaction_id</td>
<td>string</td>
<td><strong>Required.</strong> An opaque identifier for the
verification process. Must be the same as the one
used for the <tt class="docutils literal">m.key.verification.start</tt> message.</td>
</tr>
<tr><td>mac</td>
<td>{string: string}</td>
<td><strong>Required.</strong> A map of the key ID to the MAC of
the key, using the algorithm in the verification
process. The MAC is encoded as unpadded base64.</td>
</tr>
<tr><td>keys</td>
<td>string</td>
<td><strong>Required.</strong> The MAC of the comma-separated,
sorted, list of key IDs given in the <tt class="docutils literal">mac</tt>
property, encoded as unpadded base64.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;keys&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;2Wptgo4CwmLo/Y8B8qinxApKaCkBG2fjTWB7AbP5Uy+aIbygsSdLOFzvdDjww8zUVKCmI02eP9xtyJxc/cLiBA&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;mac&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:ABCDEF&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;transaction_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;S0meUniqueAndOpaqueString&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.key.verification.mac&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="hkdf-calculation"></a></p>
<div class="section" id="hkdf-calculation">
<span id="sas-hkdf"></span><h5><a class="toc-backref" href="#id478">13.11.2.2.7&nbsp;&nbsp;&nbsp;HKDF calculation</a></h5>
<p>In all of the SAS methods, HKDF is as defined in [RFC 5869](<a class="reference external" href="https://tools.ietf.org/html/rfc5869">https://tools.ietf.org/html/rfc5869</a>)
and uses the previously agreed-upon hash function for the hash function. The shared
secret is supplied as the input keying material. No salt is used, and the input
parameter is the concatenation of:</p>
<blockquote>
<ul class="simple">
<li>The string <tt class="docutils literal">MATRIX_KEY_VERIFICATION_SAS</tt>.</li>
<li>The Matrix ID of the user who sent the <tt class="docutils literal">m.key.verification.start</tt> message.</li>
<li>The Device ID of the device which sent the <tt class="docutils literal">m.key.verification.start</tt> message.</li>
<li>The Matrix ID of the user who sent the <tt class="docutils literal">m.key.verification.accept</tt> message.</li>
<li>The Device ID of the device which sent the <tt class="docutils literal">m.key.verification.accept</tt> message.</li>
<li>The <tt class="docutils literal">transaction_id</tt> being used.</li>
</ul>
</blockquote>
<div class="admonition admonition-rationale">
<p class="first admonition-title">Rationale</p>
<p class="last">HKDF is used over the plain shared secret as it results in a harder attack
as well as more uniform data to work with.</p>
</div>
<p>For verification of each party's device keys, HKDF is as defined in RFC 5869 and
uses SHA-256 as the hash function. The shared secret is supplied as the input keying
material. No salt is used, and in the input parameter is the concatenation of:</p>
<blockquote>
<ul class="simple">
<li>The string <tt class="docutils literal">MATRIX_KEY_VERIFICATION_MAC</tt>.</li>
<li>The Matrix ID of the user whose key is being MAC-ed.</li>
<li>The Device ID of the device sending the MAC.</li>
<li>The Matrix ID of the other user.</li>
<li>The Device ID of the device receiving the MAC.</li>
<li>The <tt class="docutils literal">transaction_id</tt> being used.</li>
<li>The Key ID of the key being MAC-ed, or the string <tt class="docutils literal">KEY_IDS</tt> if the item
being MAC-ed is the list of key IDs.</li>
</ul>
</blockquote>
</div>
<p><a class="anchor" id="sas-method-decimal"></a></p>
<div class="section" id="sas-method-decimal">
<h5><a class="toc-backref" href="#id479">13.11.2.2.8&nbsp;&nbsp;&nbsp;SAS method: <tt class="docutils literal">decimal</tt></a></h5>
<p>Generate 5 bytes using <a class="reference external" href="#SAS-HKDF">HKDF</a> then take sequences of 13 bits to
convert to decimal numbers (resulting in 3 numbers between 0 and 8191 inclusive
each). Add 1000 to each calculated number.</p>
<p>The bitwise operations to get the numbers given the 5 bytes
<span class="formula"><i>B</i><sub>0</sub>, <i>B</i><sub>1</sub>, <i>B</i><sub>2</sub>, <i>B</i><sub>3</sub>, <i>B</i><sub>4</sub></span> would be:</p>
<ul class="simple">
<li>First: <span class="formula">(<i>B</i><sub>0</sub>≪5|<i>B</i><sub>1</sub>≫3) + 1000</span></li>
<li>Second: <span class="formula">((<i>B</i><sub>1</sub>&0<i>x</i>7)≪10|<i>B</i><sub>2</sub>≪2|<i>B</i><sub>3</sub>≫6) + 1000</span></li>
<li>Third: <span class="formula">((<i>B</i><sub>3</sub>&0<i>x</i>3<i>F</i>)≪7|<i>B</i><sub>4</sub>≫1) + 1000</span></li>
</ul>
<p>The digits are displayed to the user either with an appropriate separator,
such as dashes, or with the numbers on individual lines.</p>
</div>
<p><a class="anchor" id="sas-method-emoji"></a></p>
<div class="section" id="sas-method-emoji">
<h5><a class="toc-backref" href="#id480">13.11.2.2.9&nbsp;&nbsp;&nbsp;SAS method: <tt class="docutils literal">emoji</tt></a></h5>
<p>Generate 6 bytes using <a class="reference external" href="#SAS-HKDF">HKDF</a> then split the first 42 bits into
7 groups of 6 bits, similar to how one would base64 encode something. Convert
each group of 6 bits to a number and use the following table to get the corresponding
emoji:</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="18%" />
<col width="18%" />
<col width="27%" />
<col width="36%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Number</th>
<th class="head">Emoji</th>
<th class="head">Unicode</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>0</td>
<td>🐶</td>
<td><tt class="docutils literal">U+1F436</tt></td>
<td>Dog</td>
</tr>
<tr><td>1</td>
<td>🐱</td>
<td><tt class="docutils literal">U+1F431</tt></td>
<td>Cat</td>
</tr>
<tr><td>2</td>
<td>🦁</td>
<td><tt class="docutils literal">U+1F981</tt></td>
<td>Lion</td>
</tr>
<tr><td>3</td>
<td>🐎</td>
<td><tt class="docutils literal">U+1F40E</tt></td>
<td>Horse</td>
</tr>
<tr><td>4</td>
<td>🦄</td>
<td><tt class="docutils literal">U+1F984</tt></td>
<td>Unicorn</td>
</tr>
<tr><td>5</td>
<td>🐷</td>
<td><tt class="docutils literal">U+1F437</tt></td>
<td>Pig</td>
</tr>
<tr><td>6</td>
<td>🐘</td>
<td><tt class="docutils literal">U+1F418</tt></td>
<td>Elephant</td>
</tr>
<tr><td>7</td>
<td>🐰</td>
<td><tt class="docutils literal">U+1F430</tt></td>
<td>Rabbit</td>
</tr>
<tr><td>8</td>
<td>🐼</td>
<td><tt class="docutils literal">U+1F43C</tt></td>
<td>Panda</td>
</tr>
<tr><td>9</td>
<td>🐓</td>
<td><tt class="docutils literal">U+1F413</tt></td>
<td>Rooster</td>
</tr>
<tr><td>10</td>
<td>🐧</td>
<td><tt class="docutils literal">U+1F427</tt></td>
<td>Penguin</td>
</tr>
<tr><td>11</td>
<td>🐢</td>
<td><tt class="docutils literal">U+1F422</tt></td>
<td>Turtle</td>
</tr>
<tr><td>12</td>
<td>🐟</td>
<td><tt class="docutils literal">U+1F41F</tt></td>
<td>Fish</td>
</tr>
<tr><td>13</td>
<td>🐙</td>
<td><tt class="docutils literal">U+1F419</tt></td>
<td>Octopus</td>
</tr>
<tr><td>14</td>
<td>🦋</td>
<td><tt class="docutils literal">U+1F98B</tt></td>
<td>Butterfly</td>
</tr>
<tr><td>15</td>
<td>🌷</td>
<td><tt class="docutils literal">U+1F337</tt></td>
<td>Flower</td>
</tr>
<tr><td>16</td>
<td>🌳</td>
<td><tt class="docutils literal">U+1F333</tt></td>
<td>Tree</td>
</tr>
<tr><td>17</td>
<td>🌵</td>
<td><tt class="docutils literal">U+1F335</tt></td>
<td>Cactus</td>
</tr>
<tr><td>18</td>
<td>🍄</td>
<td><tt class="docutils literal">U+1F344</tt></td>
<td>Mushroom</td>
</tr>
<tr><td>19</td>
<td>🌏</td>
<td><tt class="docutils literal">U+1F30F</tt></td>
<td>Globe</td>
</tr>
<tr><td>20</td>
<td>🌙</td>
<td><tt class="docutils literal">U+1F319</tt></td>
<td>Moon</td>
</tr>
<tr><td>21</td>
<td>☁️</td>
<td><tt class="docutils literal">U+2601U+FE0F</tt></td>
<td>Cloud</td>
</tr>
<tr><td>22</td>
<td>🔥</td>
<td><tt class="docutils literal">U+1F525</tt></td>
<td>Fire</td>
</tr>
<tr><td>23</td>
<td>🍌</td>
<td><tt class="docutils literal">U+1F34C</tt></td>
<td>Banana</td>
</tr>
<tr><td>24</td>
<td>🍎</td>
<td><tt class="docutils literal">U+1F34E</tt></td>
<td>Apple</td>
</tr>
<tr><td>25</td>
<td>🍓</td>
<td><tt class="docutils literal">U+1F353</tt></td>
<td>Strawberry</td>
</tr>
<tr><td>26</td>
<td>🌽</td>
<td><tt class="docutils literal">U+1F33D</tt></td>
<td>Corn</td>
</tr>
<tr><td>27</td>
<td>🍕</td>
<td><tt class="docutils literal">U+1F355</tt></td>
<td>Pizza</td>
</tr>
<tr><td>28</td>
<td>🎂</td>
<td><tt class="docutils literal">U+1F382</tt></td>
<td>Cake</td>
</tr>
<tr><td>29</td>
<td>❤️</td>
<td><tt class="docutils literal">U+2764U+FE0F</tt></td>
<td>Heart</td>
</tr>
<tr><td>30</td>
<td>😀</td>
<td><tt class="docutils literal">U+1F600</tt></td>
<td>Smiley</td>
</tr>
<tr><td>31</td>
<td>🤖</td>
<td><tt class="docutils literal">U+1F916</tt></td>
<td>Robot</td>
</tr>
<tr><td>32</td>
<td>🎩</td>
<td><tt class="docutils literal">U+1F3A9</tt></td>
<td>Hat</td>
</tr>
<tr><td>33</td>
<td>👓</td>
<td><tt class="docutils literal">U+1F453</tt></td>
<td>Glasses</td>
</tr>
<tr><td>34</td>
<td>🔧</td>
<td><tt class="docutils literal">U+1F527</tt></td>
<td>Spanner</td>
</tr>
<tr><td>35</td>
<td>🎅</td>
<td><tt class="docutils literal">U+1F385</tt></td>
<td>Santa</td>
</tr>
<tr><td>36</td>
<td>👍</td>
<td><tt class="docutils literal">U+1F44D</tt></td>
<td>Thumbs Up</td>
</tr>
<tr><td>37</td>
<td>☂️</td>
<td><tt class="docutils literal">U+2602U+FE0F</tt></td>
<td>Umbrella</td>
</tr>
<tr><td>38</td>
<td>⌛</td>
<td><tt class="docutils literal">U+231B</tt></td>
<td>Hourglass</td>
</tr>
<tr><td>39</td>
<td>⏰</td>
<td><tt class="docutils literal">U+23F0</tt></td>
<td>Clock</td>
</tr>
<tr><td>40</td>
<td>🎁</td>
<td><tt class="docutils literal">U+1F381</tt></td>
<td>Gift</td>
</tr>
<tr><td>41</td>
<td>💡</td>
<td><tt class="docutils literal">U+1F4A1</tt></td>
<td>Light Bulb</td>
</tr>
<tr><td>42</td>
<td>📕</td>
<td><tt class="docutils literal">U+1F4D5</tt></td>
<td>Book</td>
</tr>
<tr><td>43</td>
<td>✏️</td>
<td><tt class="docutils literal">U+270FU+FE0F</tt></td>
<td>Pencil</td>
</tr>
<tr><td>44</td>
<td>📎</td>
<td><tt class="docutils literal">U+1F4CE</tt></td>
<td>Paperclip</td>
</tr>
<tr><td>45</td>
<td>✂️</td>
<td><tt class="docutils literal">U+2702U+FE0F</tt></td>
<td>Scissors</td>
</tr>
<tr><td>46</td>
<td>🔒</td>
<td><tt class="docutils literal">U+1F512</tt></td>
<td>Lock</td>
</tr>
<tr><td>47</td>
<td>🔑</td>
<td><tt class="docutils literal">U+1F511</tt></td>
<td>Key</td>
</tr>
<tr><td>48</td>
<td>🔨</td>
<td><tt class="docutils literal">U+1F528</tt></td>
<td>Hammer</td>
</tr>
<tr><td>49</td>
<td>☎️</td>
<td><tt class="docutils literal">U+260EU+FE0F</tt></td>
<td>Telephone</td>
</tr>
<tr><td>50</td>
<td>🏁</td>
<td><tt class="docutils literal">U+1F3C1</tt></td>
<td>Flag</td>
</tr>
<tr><td>51</td>
<td>🚂</td>
<td><tt class="docutils literal">U+1F682</tt></td>
<td>Train</td>
</tr>
<tr><td>52</td>
<td>🚲</td>
<td><tt class="docutils literal">U+1F6B2</tt></td>
<td>Bicycle</td>
</tr>
<tr><td>53</td>
<td>✈️</td>
<td><tt class="docutils literal">U+2708U+FE0F</tt></td>
<td>Aeroplane</td>
</tr>
<tr><td>54</td>
<td>🚀</td>
<td><tt class="docutils literal">U+1F680</tt></td>
<td>Rocket</td>
</tr>
<tr><td>55</td>
<td>🏆</td>
<td><tt class="docutils literal">U+1F3C6</tt></td>
<td>Trophy</td>
</tr>
<tr><td>56</td>
<td>⚽</td>
<td><tt class="docutils literal">U+26BD</tt></td>
<td>Ball</td>
</tr>
<tr><td>57</td>
<td>🎸</td>
<td><tt class="docutils literal">U+1F3B8</tt></td>
<td>Guitar</td>
</tr>
<tr><td>58</td>
<td>🎺</td>
<td><tt class="docutils literal">U+1F3BA</tt></td>
<td>Trumpet</td>
</tr>
<tr><td>59</td>
<td>🔔</td>
<td><tt class="docutils literal">U+1F514</tt></td>
<td>Bell</td>
</tr>
<tr><td>60</td>
<td>⚓</td>
<td><tt class="docutils literal">U+2693</tt></td>
<td>Anchor</td>
</tr>
<tr><td>61</td>
<td>🎧</td>
<td><tt class="docutils literal">U+1F3A7</tt></td>
<td>Headphones</td>
</tr>
<tr><td>62</td>
<td>📁</td>
<td><tt class="docutils literal">U+1F4C1</tt></td>
<td>Folder</td>
</tr>
<tr><td>63</td>
<td>📌</td>
<td><tt class="docutils literal">U+1F4CC</tt></td>
<td>Pin</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This table is available as JSON at
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/blob/master/data-definitions/sas-emoji.json">https://github.com/matrix-org/matrix-doc/blob/master/data-definitions/sas-emoji.json</a></p>
</div>
<div class="admonition admonition-rationale">
<p class="first admonition-title">Rationale</p>
<p>The emoji above were chosen to:</p>
<ul class="last simple">
<li>Be recognisable without colour.</li>
<li>Be recognisable at a small size.</li>
<li>Be recognisable by most cultures.</li>
<li>Be distinguishable from each other.</li>
<li>Easily described by a few words.</li>
<li>Avoid symbols with negative connotations.</li>
<li>Be likely similar across multiple platforms.</li>
</ul>
</div>
<p>Clients SHOULD show the emoji with the descriptions from the table, or appropriate
translation of those descriptions. Client authors SHOULD collaborate to create a
common set of translations for all languages.</p>
<!-- section name changed, so make sure that old links keep working -->
</div>
</div>
</div>
<p><a class="anchor" id="sharing-keys-between-devices"></a></p>
<div class="section" id="sharing-keys-between-devices">
<span id="key-sharing"></span><h3><a class="toc-backref" href="#id481">13.11.3&nbsp;&nbsp;&nbsp;Sharing keys between devices</a></h3>
<p>If Bob has an encrypted conversation with Alice on his computer, and then logs in
through his phone for the first time, he may want to have access to the previously
exchanged messages. To address this issue, several methods are provided to
allow users to transfer keys from one device to another.</p>
<p><a class="anchor" id="key-requests"></a></p>
<div class="section" id="key-requests">
<h4><a class="toc-backref" href="#id482">13.11.3.1&nbsp;&nbsp;&nbsp;Key requests</a></h4>
<p>When a device is missing keys to decrypt messages, it can request the keys by
sending <a class="reference internal" href="#m-room-key-request">m.room_key_request</a> to-device messages to other devices with
<tt class="docutils literal">action</tt> set to <tt class="docutils literal">request</tt>. If a device wishes to share the keys with that
device, it can forward the keys to the first device by sending an encrypted
<a class="reference internal" href="#m-forwarded-room-key">m.forwarded_room_key</a> to-device message. The first device should then send an
<a class="reference internal" href="#m-room-key-request">m.room_key_request</a> to-device message with <tt class="docutils literal">action</tt> set to
<tt class="docutils literal">cancel_request</tt> to the other devices that it had originally sent the key
request to; a device that receives a <tt class="docutils literal">cancel_request</tt> should disregard any
previously-received <tt class="docutils literal">request</tt> message with the same <tt class="docutils literal">request_id</tt> and
<tt class="docutils literal">requesting_device_id</tt>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Key sharing can be a big attack vector, thus it must be done very carefully.
A reasonable strategy is for a user's client to only send keys requested by the
verified devices of the same user.</p>
</div>
</div>
<p><a class="anchor" id="key-exports"></a></p>
<div class="section" id="key-exports">
<h4><a class="toc-backref" href="#id483">13.11.3.2&nbsp;&nbsp;&nbsp;Key exports</a></h4>
<p>Keys can be manually exported from one device to an encrypted file, copied to
another device, and imported. The file is encrypted using a user-supplied
passphrase, and is created as follows:</p>
<ol class="arabic">
<li><p class="first">Encode the sessions as a JSON object, formatted as described in <a class="reference internal" href="#key-export-format">Key export
format</a>.</p>
</li>
<li><p class="first">Generate a 512-bit key from the user-entered passphrase by computing
<a class="reference external" href="https://tools.ietf.org/html/rfc2898#section-5.2">PBKDF2</a>(HMAC-SHA-512, passphrase, S, N, 512), where S is a 128-bit
cryptographically-random salt and N is the number of rounds.  N should be at
least 100,000.  The keys K and K' are set to the first and last 256 bits of
this generated key, respectively.  K is used as an AES-256 key, and K' is
used as an HMAC-SHA-256 key.</p>
</li>
<li><p class="first">Serialize the JSON object as a UTF-8 string, and encrypt it using
AES-CTR-256 with the key K generated above, and with a 128-bit
cryptographically-random initialization vector, IV, that has bit 63 set to
zero. (Setting bit 63 to zero in IV is needed to work around differences in
implementations of AES-CTR.)</p>
</li>
<li><p class="first">Concatenate the following data:</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Size (bytes)</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>1</td>
<td>Export format version, which must be <tt class="docutils literal">0x01</tt>.</td>
</tr>
<tr><td>16</td>
<td>The salt S.</td>
</tr>
<tr><td>16</td>
<td>The initialization vector IV.</td>
</tr>
<tr><td>4</td>
<td>The number of rounds N, as a big-endian unsigned 32-bit integer.</td>
</tr>
<tr><td>variable</td>
<td>The encrypted JSON object.</td>
</tr>
<tr><td>32</td>
<td>The HMAC-SHA-256 of all the above string concatenated together,
using K' as the key.</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Base64-encode the string above. Newlines may be added to avoid overly long
lines.</p>
</li>
<li><p class="first">Prepend the resulting string with <tt class="docutils literal"><span class="pre">-----BEGIN</span> MEGOLM SESSION <span class="pre">DATA-----</span></tt>,
with a trailing newline, and append <tt class="docutils literal"><span class="pre">-----END</span> MEGOLM SESSION <span class="pre">DATA-----</span></tt>,
with a leading and trailing newline.</p>
</li>
</ol>
<p><a class="anchor" id="key-export-format"></a></p>
<div class="section" id="key-export-format">
<h5><a class="toc-backref" href="#id484">13.11.3.2.1&nbsp;&nbsp;&nbsp;Key export format</a></h5>
<p>The exported sessions are formatted as a JSON array of <tt class="docutils literal">SessionData</tt> objects
described as follows:</p>
<p><tt class="docutils literal">SessionData</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>algorithm</td>
<td>string</td>
<td>Required. The encryption algorithm
that the session uses. Must be
<tt class="docutils literal"><span class="pre">m.megolm.v1.aes-sha2</span></tt>.</td>
</tr>
<tr><td>forwarding_curve25519_key_chain</td>
<td>[string]</td>
<td>Required. Chain of Curve25519 keys
through which this session was
forwarded, via
<a class="reference internal" href="#m-forwarded-room-key">m.forwarded_room_key</a> events.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>Required. The room where the
session is used.</td>
</tr>
<tr><td>sender_key</td>
<td>string</td>
<td>Required. The Curve25519 key of the
device which initiated the session
originally.</td>
</tr>
<tr><td>sender_claimed_keys</td>
<td>{string:
string}</td>
<td>Required. The Ed25519 key of the
device which initiated the session
originally.</td>
</tr>
<tr><td>session_id</td>
<td>string</td>
<td>Required. The ID of the session.</td>
</tr>
<tr><td>session_key</td>
<td>string</td>
<td>Required. The key for the session.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;sessions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.megolm.v1.aes-sha2&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;forwarding_curve25519_key_chain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                <span class="literal string double">&quot;hPQNcabIABgGnx3/ACv/jmMmiQHoeFfuLB17tzWp6Hw&quot;</span>
            <span class="punctuation">],</span>
            <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;sender_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;RF3s+E7RkTQTGF2d8Deol0FkQvgII2aJDf3/Jp5mxVU&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;sender_claimed_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;ed25519&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;device ed25519 identity key&gt;&quot;</span><span class="punctuation">,</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;session_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;session_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;AgAAAADxKHa9uFxcXzwYoNueL5Xqi69IkD4sni8Llf...&quot;</span>
        <span class="punctuation">},</span>
        <span class="error">...</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="messaging-algorithms"></a></p>
<div class="section" id="messaging-algorithms">
<h3><a class="toc-backref" href="#id485">13.11.4&nbsp;&nbsp;&nbsp;Messaging Algorithms</a></h3>
<p><a class="anchor" id="messaging-algorithm-names"></a></p>
<div class="section" id="messaging-algorithm-names">
<h4><a class="toc-backref" href="#id486">13.11.4.1&nbsp;&nbsp;&nbsp;Messaging Algorithm Names</a></h4>
<p>Messaging algorithm names use the extensible naming scheme used throughout this
specification. Algorithm names that start with <tt class="docutils literal">m.</tt> are reserved for
algorithms defined by this specification. Implementations wanting to experiment
with new algorithms must be uniquely globally namespaced following Java's package
naming conventions.</p>
<p>Algorithm names should be short and meaningful, and should list the primitives
used by the algorithm so that it is easier to see if the algorithm is using a
broken primitive.</p>
<p>A name of <tt class="docutils literal">m.olm.v1</tt> is too short: it gives no information about the primitives
in use, and is difficult to extend for different primitives. However a name of
<tt class="docutils literal"><span class="pre">m.olm.v1.ecdh-curve25519-hdkfsha256.hmacsha256.hkdfsha256-aes256-cbc-hmac64sha256</span></tt>
is too long despite giving a more precise description of the algorithm: it adds
to the data transfer overhead and sacrifices clarity for human readers without
adding any useful extra information.</p>
</div>
<p><a class="anchor" id="m-olm-v1-curve25519-aes-sha2"></a></p>
<div class="section" id="m-olm-v1-curve25519-aes-sha2">
<h4><a class="toc-backref" href="#id487">13.11.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">m.olm.v1.curve25519-aes-sha2</span></tt></a></h4>
<p>The name <tt class="docutils literal"><span class="pre">m.olm.v1.curve25519-aes-sha2</span></tt> corresponds to version 1 of the Olm
ratchet, as defined by the <a class="reference external" href="http://matrix.org/docs/spec/olm.html">Olm specification</a>. This uses:</p>
<ul class="simple">
<li>Curve25519 for the initial key agreement.</li>
<li>HKDF-SHA-256 for ratchet key derivation.</li>
<li>Curve25519 for the root key ratchet.</li>
<li>HMAC-SHA-256 for the chain key ratchet.</li>
<li>HKDF-SHA-256, AES-256 in CBC mode, and 8 byte truncated HMAC-SHA-256 for authenticated encryption.</li>
</ul>
<p>Devices that support Olm must include &quot;m.olm.v1.curve25519-aes-sha2&quot; in their
list of supported messaging algorithms, must list a Curve25519 device key, and
must publish Curve25519 one-time keys.</p>
<p>An event encrypted using Olm has the following format:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.encrypted&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.olm.v1.curve25519-aes-sha2&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;sender_curve25519_key&gt;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;&lt;device_curve25519_key&gt;&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;encrypted_payload_base_64&gt;&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><tt class="docutils literal">ciphertext</tt> is a mapping from device Curve25519 key to an encrypted payload
for that device. <tt class="docutils literal">body</tt> is a Base64-encoded Olm message body. <tt class="docutils literal">type</tt> is an
integer indicating the type of the message body: 0 for the initial pre-key
message, 1 for ordinary messages.</p>
<p>Olm sessions will generate messages with a type of 0 until they receive a
message. Once a session has decrypted a message it will produce messages with
a type of 1.</p>
<p>When a client receives a message with a type of 0 it must first check if it
already has a matching session. If it does then it will use that session to
try to decrypt the message. If there is no existing session then the client
must create a new session and use the new session to decrypt the message. A
client must not persist a session or remove one-time keys used by a session
until it has successfully decrypted a message using that session.</p>
<p>Messages with type 1 can only be decrypted with an existing session. If there
is no matching session, the client must treat this as an invalid message.</p>
<p>The plaintext payload is of the form:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;type of the plaintext event&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;content for the plaintext event&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;sender_user_id&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;recipient&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;recipient_user_id&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;recipient_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;ed25519&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;our_ed25519_key&gt;&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;ed25519&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;sender_ed25519_key&gt;&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>The type and content of the plaintext message event are given in the payload.</p>
<p>Other properties are included in order to prevent an attacker from publishing
someone else's curve25519 keys as their own and subsequently claiming to have
sent messages which they didn't.
<tt class="docutils literal">sender</tt> must correspond to the user who sent the event, <tt class="docutils literal">recipient</tt> to
the local user, and <tt class="docutils literal">recipient_keys</tt> to the local ed25519 key.</p>
<p>Clients must confirm that the <tt class="docutils literal">sender_key</tt> and the <tt class="docutils literal">ed25519</tt> field value
under the <tt class="docutils literal">keys</tt> property match the keys returned by <a class="reference external" href="#post-matrix-client-r0-keys-query"><tt class="docutils literal">/keys/query</tt></a> for
the given user, and must also verify the signature of the payload. Without
this check, a client cannot be sure that the sender device owns the private
part of the ed25519 key it claims to have in the Olm payload.
This is crucial when the ed25519 key corresponds to a verified device.</p>
<p>If a client has multiple sessions established with another device, it should
use the session from which it last received and successfully decrypted a
message. For these purposes, a session that has not received any messages
should use its creation time as the time that it last received a message.
A client may expire old sessions by defining a maximum number of olm sessions
that it will maintain for each device, and expiring sessions on a Least Recently
Used basis.  The maximum number of olm sessions maintained per device should
be at least 4.</p>
<p><a class="anchor" id="recovering-from-undecryptable-messages"></a></p>
<div class="section" id="recovering-from-undecryptable-messages">
<h5><a class="toc-backref" href="#id488">13.11.4.2.1&nbsp;&nbsp;&nbsp;Recovering from undecryptable messages</a></h5>
<p>Occasionally messages may be undecryptable by clients due to a variety of reasons.
When this happens to an Olm-encrypted message, the client should assume that the Olm
session has become corrupted and create a new one to replace it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Megolm-encrypted messages generally do not have the same problem. Usually the key
for an undecryptable Megolm-encrypted message will come later, allowing the client
to decrypt it successfully. Olm does not have a way to recover from the failure,
making this session replacement process required.</p>
</div>
<p>To establish a new session, the client sends a <a class="reference external" href="#m-dummy">m.dummy</a> to-device event
to the other party to notify them of the new session details.</p>
<p>Clients should rate-limit the number of sessions it creates per device that it receives
a message from. Clients should not create a new session with another device if it has
already created one for that given device in the past 1 hour.</p>
<p>Clients should attempt to mitigate loss of the undecryptable messages. For example,
Megolm sessions that were sent using the old session would have been lost. The client
can attempt to retrieve the lost sessions through <tt class="docutils literal">m.room_key_request</tt> messages.</p>
</div>
</div>
<p><a class="anchor" id="m-megolm-v1-aes-sha2"></a></p>
<div class="section" id="m-megolm-v1-aes-sha2">
<h4><a class="toc-backref" href="#id489">13.11.4.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">m.megolm.v1.aes-sha2</span></tt></a></h4>
<p>The name <tt class="docutils literal"><span class="pre">m.megolm.v1.aes-sha2</span></tt> corresponds to version 1 of the Megolm
ratchet, as defined by the <a class="reference external" href="http://matrix.org/docs/spec/megolm.html">Megolm specification</a>. This uses:</p>
<ul class="simple">
<li>HMAC-SHA-256 for the hash ratchet.</li>
<li>HKDF-SHA-256, AES-256 in CBC mode, and 8 byte truncated HMAC-SHA-256 for authenticated encryption.</li>
<li>Ed25519 for message authenticity.</li>
</ul>
<p>Devices that support Megolm must support Olm, and include &quot;m.megolm.v1.aes-sha2&quot; in
their list of supported messaging algorithms.</p>
<p>An event encrypted using Megolm has the following format:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.encrypted&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.megolm.v1.aes-sha2&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;sender_curve25519_key&gt;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;sender_device_id&gt;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;session_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;outbound_group_session_id&gt;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;encrypted_payload_base_64&gt;&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>The encrypted payload can contain any message event. The plaintext is of the form:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;event_type&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;event_content&gt;&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;the room_id&gt;&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>We include the room ID in the payload, because otherwise the homeserver would
be able to change the room a message was sent in.</p>
<p>Clients must guard against replay attacks by keeping track of the ratchet indices
of Megolm sessions. They should reject messages with a ratchet index that they
have already decrypted. Care should be taken in order to avoid false positives, as a
client may decrypt the same event twice as part of its normal processing.</p>
<p>As with Olm events, clients must confirm that the <tt class="docutils literal">sender_key</tt> belongs to the user
who sent the message. The same reasoning applies, but the sender ed25519 key has to be
inferred from the <tt class="docutils literal">keys.ed25519</tt> property of the event which established the Megolm
session.</p>
<p>In order to enable end-to-end encryption in a room, clients can send a
<tt class="docutils literal">m.room.encryption</tt> state event specifying <tt class="docutils literal"><span class="pre">m.megolm.v1.aes-sha2</span></tt> as its
<tt class="docutils literal">algorithm</tt> property.</p>
<p>When creating a Megolm session in a room, clients must share the corresponding session
key using Olm with the intended recipients, so that they can decrypt future messages
encrypted using this session. A <tt class="docutils literal">m.room_key</tt> event is used to do this. Clients
must also handle <tt class="docutils literal">m.room_key</tt> events sent by other devices in order to decrypt their
messages.</p>
</div>
</div>
<p><a class="anchor" id="id125"></a></p>
<div class="section" id="id125">
<h3><a class="toc-backref" href="#id490">13.11.5&nbsp;&nbsp;&nbsp;Protocol definitions</a></h3>
<p><a class="anchor" id="id126"></a></p>
<div class="section" id="id126">
<h4><a class="toc-backref" href="#id491">13.11.5.1&nbsp;&nbsp;&nbsp;Events</a></h4>
<p><a class="anchor" id="m-room-encryption"></a></p>
<div class="section" id="m-room-encryption">
<h5><a class="toc-backref" href="#id492">13.11.5.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.encryption</tt></a></h5>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>Defines how messages sent in this room should be encrypted.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>algorithm</td>
<td>string</td>
<td><strong>Required.</strong> The encryption algorithm to be used
to encrypt messages sent in this room. Must be
'm.megolm.v1.aes-sha2'.</td>
</tr>
<tr><td>rotation_period_ms</td>
<td>integer</td>
<td>How long the session should be used before
changing it. <tt class="docutils literal">604800000</tt> (a week) is the
recommended default.</td>
</tr>
<tr><td>rotation_period_msgs</td>
<td>integer</td>
<td>How many messages should be sent before changing
the session. <tt class="docutils literal">100</tt> is the recommended default.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.megolm.v1.aes-sha2&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rotation_period_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">604800000</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rotation_period_msgs&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.encryption&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-encrypted"></a></p>
<div class="section" id="m-room-encrypted">
<h5><a class="toc-backref" href="#id493">13.11.5.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.encrypted</tt></a></h5>
<p>This event type is used when sending encrypted events. It can be used either
within a room (in which case it will have all of the <a class="reference internal" href="#room-event-fields">Room Event fields</a>), or
as a <a class="reference internal" href="#to-device">to-device</a> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>algorithm</td>
<td>enum</td>
<td><strong>Required.</strong> The encryption algorithm used to
encrypt this event. The value of this field
determines which other properties will be present.
One of: [&quot;m.olm.v1.curve25519-aes-sha2&quot;,
&quot;m.megolm.v1.aes-sha2&quot;]</td>
</tr>
<tr><td>ciphertext</td>
<td>string or {string: CiphertextInfo}</td>
<td><strong>Required.</strong> The encrypted content of the event.
Either the encrypted payload itself, in the case
of a Megolm event, or a map from the recipient
Curve25519 identity key to ciphertext information,
in the case of an Olm event. For more details, see
<a class="reference internal" href="#messaging-algorithms">Messaging Algorithms</a>.</td>
</tr>
<tr><td>sender_key</td>
<td>string</td>
<td><strong>Required.</strong> The Curve25519 key of the sender.</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td>The ID of the sending device. Required with
Megolm.</td>
</tr>
<tr><td>session_id</td>
<td>string</td>
<td>The ID of the session used to encrypt the message.
Required with Megolm.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>CiphertextInfo</caption>
<thead valign="bottom">
<tr><th class="head">CiphertextInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td>The encrypted payload.</td>
</tr>
<tr><td>type</td>
<td>integer</td>
<td>The Olm message type.</td>
</tr>
</tbody>
</table>
<p>Examples:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.megolm.v1.aes-sha2&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;AwgAEnACgAkLmt6qF84IK++J7UDH2Za1YVchHyprqTqsg...&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;RJYKSTBOIE&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;sender_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;IlRMeOPX2e0MurIyfWEucYBRVOEEUMrOHqn/8mLqMjA&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;session_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.encrypted&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.olm.v1.curve25519-aes-sha2&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;7qZcfnBmbEGzxxaWfBjElJuvn7BZx+lSz/SvFrDF/z8&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;AwogGJJzMhf/S3GQFXAOrCZ3iKyGU5ZScVtjI0KypTYrW...&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
            <span class="punctuation">}</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;sender_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Szl29ksW/L8yZGWAX+8dY1XyFi+i5wm+DRhTGkbMiwU&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.encrypted&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-key"></a></p>
<div class="section" id="m-room-key">
<h5><a class="toc-backref" href="#id494">13.11.5.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room_key</tt></a></h5>
<p>This event type is used to exchange keys for end-to-end encryption. Typically
it is encrypted as an <tt class="docutils literal">m.room.encrypted</tt> event, then sent as a <a class="reference internal" href="#to-device">to-device</a> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>algorithm</td>
<td>string</td>
<td><strong>Required.</strong> The encryption algorithm the key in
this event is to be used with. Must be
'm.megolm.v1.aes-sha2'.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The room where the key is used.</td>
</tr>
<tr><td>session_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the session that the key
is for.</td>
</tr>
<tr><td>session_key</td>
<td>string</td>
<td><strong>Required.</strong> The key to be exchanged.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.megolm.v1.aes-sha2&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;session_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;session_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;AgAAAADxKHa9uFxcXzwYoNueL5Xqi69IkD4sni8LlfJL7qNBEY...&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room_key&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-key-request"></a></p>
<div class="section" id="m-room-key-request">
<h5><a class="toc-backref" href="#id495">13.11.5.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room_key_request</tt></a></h5>
<p>This event type is used to request keys for end-to-end encryption. It is sent as an
unencrypted <a class="reference internal" href="#to-device">to-device</a> event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>RequestedKeyInfo</td>
<td>Information about the requested key. Required when
<tt class="docutils literal">action</tt> is <tt class="docutils literal">request</tt>.</td>
</tr>
<tr><td>action</td>
<td>enum</td>
<td><strong>Required.</strong> One of: [&quot;request&quot;,
&quot;cancel_request&quot;]</td>
</tr>
<tr><td>requesting_device_id</td>
<td>string</td>
<td><strong>Required.</strong> ID of the device requesting the key.</td>
</tr>
<tr><td>request_id</td>
<td>string</td>
<td><strong>Required.</strong> A random string uniquely identifying
the request for a key. If the key is requested
multiple times, it should be reused. It should
also reused in order to cancel a request.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>RequestedKeyInfo</caption>
<thead valign="bottom">
<tr><th class="head">RequestedKeyInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>algorithm</td>
<td>string</td>
<td><strong>Required.</strong> The encryption algorithm the
requested key in this event is to be used with.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The room where the key is used.</td>
</tr>
<tr><td>sender_key</td>
<td>string</td>
<td><strong>Required.</strong> The Curve25519 key of the device
which initiated the session originally.</td>
</tr>
<tr><td>session_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the session that the key
is for.</td>
</tr>
</tbody>
</table>
<p>Examples:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;action&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;cancel_request&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;request_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1495474790150.19&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;requesting_device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;RJYKSTBOIE&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room_key_request&quot;</span>
<span class="punctuation">}</span>
</pre>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;action&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;request&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.megolm.v1.aes-sha2&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;sender_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;RF3s+E7RkTQTGF2d8Deol0FkQvgII2aJDf3/Jp5mxVU&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;session_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;request_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1495474790150.19&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;requesting_device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;RJYKSTBOIE&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room_key_request&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-forwarded-room-key"></a></p>
<div class="section" id="m-forwarded-room-key">
<h5><a class="toc-backref" href="#id496">13.11.5.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.forwarded_room_key</tt></a></h5>
<p>This event type is used to forward keys for end-to-end encryption. Typically
it is encrypted as an <tt class="docutils literal">m.room.encrypted</tt> event, then sent as a <a class="reference internal" href="#to-device">to-device</a>
event.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>algorithm</td>
<td>string</td>
<td><strong>Required.</strong> The encryption algorithm the key in
this event is to be used with.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The room where the key is used.</td>
</tr>
<tr><td>sender_key</td>
<td>string</td>
<td><strong>Required.</strong> The Curve25519 key of the device
which initiated the session originally.</td>
</tr>
<tr><td>session_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the session that the key
is for.</td>
</tr>
<tr><td>session_key</td>
<td>string</td>
<td><strong>Required.</strong> The key to be exchanged.</td>
</tr>
<tr><td>sender_claimed_ed25519_key</td>
<td>string</td>
<td><strong>Required.</strong> The Ed25519 key of the device which
initiated the session originally. It is 'claimed'
because the receiving device has no way to tell
that the original room_key actually came from a
device which owns the private part of this key
unless they have done device verification.</td>
</tr>
<tr><td>forwarding_curve25519_key_chain</td>
<td>[string]</td>
<td><strong>Required.</strong> Chain of Curve25519 keys. It starts
out empty, but each time the key is forwarded to
another device, the previous sender in the chain
is added to the end of the list. For example, if
the key is forwarded from A to B to C, this field
is empty between A and B, and contains A's
Curve25519 key between B and C.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.megolm.v1.aes-sha2&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;forwarding_curve25519_key_chain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;hPQNcabIABgGnx3/ACv/jmMmiQHoeFfuLB17tzWp6Hw&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;sender_claimed_ed25519_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;aj40p+aw64yPIdsxoog8jhPu9i7l7NcFRecuOQblE3Y&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;sender_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;RF3s+E7RkTQTGF2d8Deol0FkQvgII2aJDf3/Jp5mxVU&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;session_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;session_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;AgAAAADxKHa9uFxcXzwYoNueL5Xqi69IkD4sni8Llf...&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.forwarded_room_key&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="id127"></a></p>
<div class="section" id="id127">
<h5><a class="toc-backref" href="#id497">13.11.5.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.dummy</tt></a></h5>
<p>This event type is used to indicate new Olm sessions for end-to-end encryption.
Typically it is encrypted as an <tt class="docutils literal">m.room.encrypted</tt> event, then sent as a <a class="reference internal" href="#to-device">to-device</a>
event.</p>
<p>The event does not have any content associated with it. The sending client is expected
to send a key share request shortly after this message, causing the receiving client to
process this <tt class="docutils literal">m.dummy</tt> event as the most recent event and using the keyshare request
to set up the session. The keyshare request and <tt class="docutils literal">m.dummy</tt> combination should result
in the original sending client receiving keys over the newly established session.</p>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.dummy&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="key-management-api"></a></p>
<div class="section" id="key-management-api">
<h4><a class="toc-backref" href="#id498">13.11.5.2&nbsp;&nbsp;&nbsp;Key management API</a></h4>
<p><a class="anchor" id="post-matrix-client-r0-keys-upload"></a></p>
<div class="section" id="post-matrix-client-r0-keys-upload">
<h5><a class="toc-backref" href="#id499">13.11.5.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/keys/upload</tt></a></h5>
<p>Publishes end-to-end encryption keys for the device.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>device_keys</td>
<td>DeviceKeys</td>
<td>Identity keys for the device. May be absent if no
new identity keys are required.</td>
</tr>
<tr><td>one_time_keys</td>
<td>{string: string or object}</td>
<td><p class="first">One-time public keys for &quot;pre-key&quot; messages.  The
names of the properties should be in the format
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;key_id&gt;</span></tt>. The format of the key is
determined by the <a class="reference external" href="#key-algorithms">key algorithm</a>.</p>
<p class="last">May be absent if no new one-time keys are
required.</p>
</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>DeviceKeys</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the user the device
belongs to. Must match the user ID used when
logging in.</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the device these keys
belong to. Must match the device ID used when
logging in.</td>
</tr>
<tr><td>algorithms</td>
<td>[string]</td>
<td><strong>Required.</strong> The encryption algorithms supported
by this device.</td>
</tr>
<tr><td>keys</td>
<td>{string: string}</td>
<td><strong>Required.</strong> Public identity keys. The names of
the properties should be in the format
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;device_id&gt;</span></tt>. The keys themselves
should be encoded as specified by the key
algorithm.</td>
</tr>
<tr><td>signatures</td>
<td>{string: {string: string}}</td>
<td><p class="first"><strong>Required.</strong> Signatures for the device key
object. A map from user ID, to a map from
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;device_id&gt;</span></tt> to the signature.</p>
<p class="last">The signature is calculated using the process
described at <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>one_time_key_counts</td>
<td>{string: integer}</td>
<td><strong>Required.</strong> For each key algorithm, the number
of unclaimed one-time keys of that type currently
held on the server for this device.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/keys/upload</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;device_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;JLAFKJWSCS&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;algorithms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;m.olm.curve25519-aes-sha256&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;m.megolm.v1.aes-sha&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;curve25519:JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;3C5BFWi2Y8MaVvjM8M22DBmh24PmgR0nPvJOIArzgyI&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;lEuiRJBit0IG6nUf5pUzWTUEsRVVe/HJkoKuEww9ULI&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;dSO80A01XiigH3uBiDVx/EjzaoycHcjq9lfQX0uWsqxl2giMIiSPR8a4d291W1ihKJL/a+myXS367WT6NAIcBA&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;one_time_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;curve25519:AAAAAQ&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;/qyvZvwjiTxGdGU0RCguDCLeR+nmsb3FfNG3/Ve4vU8&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signed_curve25519:AAAAHg&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;zKbLg+NrIjpnagy+pIY6uPL4ZwEG2v+8F9lmgsnlZzs&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;FLWxXqGbwrb8SM3Y795eB6OA8bwBcoMZFXBqnTn58AYWZSqiD45tlBVcDa2L7RwdKXebW/VzDlnfVJ+9jok1Bw&quot;</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;signed_curve25519:AAAAHQ&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;j3fR3HemM16M7CWhoI4Sk5ZsdmdfQHsKL1xuSft6MSw&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;IQeCEPb9HFk217cU9kw9EOiusC6kMIkoIRnbnfOh5Oc63S1ghgyjShBGpu34blQomoalCyXWyhaaT3MrLZYQAA&quot;</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The provided keys were sucessfully uploaded.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;one_time_key_counts&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;curve25519&quot;</span><span class="punctuation">:</span> <span class="literal number integer">10</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signed_curve25519&quot;</span><span class="punctuation">:</span> <span class="literal number integer">20</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-keys-query"></a></p>
<div class="section" id="post-matrix-client-r0-keys-query">
<h5><a class="toc-backref" href="#id500">13.11.5.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/keys/query</tt></a></h5>
<p>Returns the current devices and identity keys for the given users.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>timeout</td>
<td>integer</td>
<td>The time (in milliseconds) to wait when
downloading keys from remote servers. 10 seconds
is the recommended default.</td>
</tr>
<tr><td>device_keys</td>
<td>{string: [string]}</td>
<td><strong>Required.</strong> The keys to be downloaded. A map
from user ID, to a list of device IDs, or to an
empty list to indicate all devices for the
corresponding user.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td>If the client is fetching keys as a result of a
device update received in a sync request, this
should be the 'since' token of that sync request,
or any later sync token. This allows the server to
ensure its response contains the keys advertised
by the notification in that sync.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>failures</td>
<td>{string: object}</td>
<td><p class="first">If any remote homeservers could not be reached,
they are recorded here. The names of the
properties are the names of the unreachable
servers.</p>
<p class="last">If the homeserver could be reached, but the user
or device was unknown, no failure is recorded.
Instead, the corresponding user or device is
missing from the <tt class="docutils literal">device_keys</tt> result.</p>
</td>
</tr>
<tr><td>device_keys</td>
<td>{string: {string: DeviceKeys}}</td>
<td>Information on the queried devices. A map from
user ID, to a map from device ID to device
information.  For each device, the information
returned will be the same as uploaded via
<tt class="docutils literal">/keys/upload</tt>, with the addition of an
<tt class="docutils literal">unsigned</tt> property.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>DeviceKeys</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the user the device
belongs to. Must match the user ID used when
logging in.</td>
</tr>
<tr><td>device_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the device these keys
belong to. Must match the device ID used when
logging in.</td>
</tr>
<tr><td>algorithms</td>
<td>[string]</td>
<td><strong>Required.</strong> The encryption algorithms supported
by this device.</td>
</tr>
<tr><td>keys</td>
<td>{string: string}</td>
<td><strong>Required.</strong> Public identity keys. The names of
the properties should be in the format
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;device_id&gt;</span></tt>. The keys themselves
should be encoded as specified by the key
algorithm.</td>
</tr>
<tr><td>signatures</td>
<td>{string: {string: string}}</td>
<td><p class="first"><strong>Required.</strong> Signatures for the device key
object. A map from user ID, to a map from
<tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;device_id&gt;</span></tt> to the signature.</p>
<p class="last">The signature is calculated using the process
described at <a class="reference external" href="../appendices.html#signing-json">Signing JSON</a>.</p>
</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedDeviceInfo</td>
<td>Additional data added to the device key
information by intermediate servers, and not
covered by the signatures.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedDeviceInfo</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>device_display_name</td>
<td>string</td>
<td>The display name which the user set on the device.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/keys/query</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="literal number integer">10000</span><span class="punctuation">,</span>
  <span class="name tag">&quot;device_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">[]</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;string&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The device information</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;failures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{},</span>
  <span class="name tag">&quot;device_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;device_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;JLAFKJWSCS&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;algorithms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="literal string double">&quot;m.olm.v1.curve25519-aes-sha256&quot;</span><span class="punctuation">,</span>
          <span class="literal string double">&quot;m.megolm.v1.aes-sha&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;curve25519:JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;3C5BFWi2Y8MaVvjM8M22DBmh24PmgR0nPvJOIArzgyI&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;lEuiRJBit0IG6nUf5pUzWTUEsRVVe/HJkoKuEww9ULI&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;dSO80A01XiigH3uBiDVx/EjzaoycHcjq9lfQX0uWsqxl2giMIiSPR8a4d291W1ihKJL/a+myXS367WT6NAIcBA&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;device_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice's mobile phone&quot;</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-keys-claim"></a></p>
<div class="section" id="post-matrix-client-r0-keys-claim">
<h5><a class="toc-backref" href="#id501">13.11.5.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/keys/claim</tt></a></h5>
<p>Claims one-time keys for use in pre-key messages.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>timeout</td>
<td>integer</td>
<td>The time (in milliseconds) to wait when
downloading keys from remote servers. 10 seconds
is the recommended default.</td>
</tr>
<tr><td>one_time_keys</td>
<td>{string: {string: string}}</td>
<td><strong>Required.</strong> The keys to be claimed. A map from
user ID, to a map from device ID to algorithm
name.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>failures</td>
<td>{string: object}</td>
<td><p class="first">If any remote homeservers could not be reached,
they are recorded here. The names of the
properties are the names of the unreachable
servers.</p>
<p class="last">If the homeserver could be reached, but the user
or device was unknown, no failure is recorded.
Instead, the corresponding user or device is
missing from the <tt class="docutils literal">one_time_keys</tt> result.</p>
</td>
</tr>
<tr><td>one_time_keys</td>
<td>{string: {string: string or object}}</td>
<td><p class="first"><strong>Required.</strong> One-time keys for the queried
devices. A map from user ID, to a map from devices
to a map from <tt class="docutils literal"><span class="pre">&lt;algorithm&gt;:&lt;key_id&gt;</span></tt> to the key
object.</p>
<p class="last">See the <a class="reference external" href="#key-algorithms">key algorithms</a>
section for information on the Key Object format.</p>
</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/keys/claim</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="literal number integer">10000</span><span class="punctuation">,</span>
  <span class="name tag">&quot;one_time_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;signed_curve25519&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The claimed keys.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;failures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{},</span>
  <span class="name tag">&quot;one_time_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;signed_curve25519:AAAAHg&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;zKbLg+NrIjpnagy+pIY6uPL4ZwEG2v+8F9lmgsnlZzs&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;ed25519:JLAFKJWSCS&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;FLWxXqGbwrb8SM3Y795eB6OA8bwBcoMZFXBqnTn58AYWZSqiD45tlBVcDa2L7RwdKXebW/VzDlnfVJ+9jok1Bw&quot;</span>
            <span class="punctuation">}</span>
          <span class="punctuation">}</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-keys-changes"></a></p>
<div class="section" id="get-matrix-client-r0-keys-changes">
<h5><a class="toc-backref" href="#id502">13.11.5.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/keys/changes</tt></a></h5>
<p>Gets a list of users who have updated their device identity keys since a
previous sync token.</p>
<p>The server should include in the results any users who:</p>
<ul class="simple">
<li>currently share a room with the calling user (ie, both users have
membership state <tt class="docutils literal">join</tt>); <em>and</em></li>
<li>added new device identity keys or removed an existing device with
identity keys, between <tt class="docutils literal">from</tt> and <tt class="docutils literal">to</tt>.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>from</td>
<td>string</td>
<td><strong>Required.</strong> The desired start point of the list.
Should be the <tt class="docutils literal">next_batch</tt> field from a response
to an earlier call to <tt class="docutils literal">/sync</tt>. Users who have not
uploaded new device identity keys since this
point, nor deleted existing devices with identity
keys since then, will be excluded from the
results.</td>
</tr>
<tr><td>to</td>
<td>string</td>
<td><strong>Required.</strong> The desired end point of the list.
Should be the <tt class="docutils literal">next_batch</tt> field from a recent
call to <tt class="docutils literal">/sync</tt> - typically the most recent such
call. This may be used by the server as a hint to
check its caches are up to date.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>changed</td>
<td>[string]</td>
<td>The Matrix User IDs of all users who updated their
device identity keys.</td>
</tr>
<tr><td>left</td>
<td>[string]</td>
<td>The Matrix User IDs of all users who may have left
all the end-to-end encrypted rooms they previously
shared with the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/keys/changes?from=s72594_4483_1934&amp;to=s75689_5632_2435</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The list of users who updated their devices.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;changed&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;&#64;bob:example.org&quot;</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;left&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;&#64;clara:example.com&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;&#64;doug:example.org&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<!-- anchor for link from /sync api spec -->
</div>
</div>
<p><a class="anchor" id="id129"></a></p>
<div class="section" id="id129">
<span id="device-lists-sync"></span><h4><a class="toc-backref" href="#id503">13.11.5.3&nbsp;&nbsp;&nbsp;Extensions to /sync</a></h4>
<p>This module adds an optional <tt class="docutils literal">device_lists</tt> property to the <a class="reference external" href="#get-matrix-client-r0-sync"><tt class="docutils literal">/sync</tt></a>
response, as specified below. The server need only populate this property for
an incremental <tt class="docutils literal">/sync</tt> (ie, one where the <tt class="docutils literal">since</tt> parameter was
specified). The client is expected to use <a class="reference external" href="#post-matrix-client-r0-keys-query"><tt class="docutils literal">/keys/query</tt></a> or <a class="reference external" href="#get-matrix-client-r0-keys-changes"><tt class="docutils literal">/keys/changes</tt></a>
for the equivalent functionality after an initial sync, as documented in
<a class="reference internal" href="#tracking-the-device-list-for-a-user">Tracking the device list for a user</a>.</p>
<p>It also adds a <tt class="docutils literal">one_time_keys_count</tt> property. Note the spelling difference
with the <tt class="docutils literal">one_time_key_counts</tt> property in the <a class="reference external" href="#post-matrix-client-r0-keys-upload"><tt class="docutils literal">/keys/upload</tt></a> response.</p>
<!-- todo: generate this from a swagger definition? -->
<!-- device_lists: { changed: ["@user:server", ... ]}, -->
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>device_lists</td>
<td>DeviceLists</td>
<td>Optional. Information on e2e device updates. Note:
only present on an incremental sync.</td>
</tr>
<tr><td>device_one_time_keys_count</td>
<td>{string:
integer}</td>
<td>Optional. For each key algorithm, the number of
unclaimed one-time keys currently held on the server
for this device.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">DeviceLists</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="12%" />
<col width="77%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>changed</td>
<td>[string]</td>
<td>List of users who have updated their device identity keys,
or who now share an encrypted room with the client since
the previous sync response.</td>
</tr>
<tr><td>left</td>
<td>[string]</td>
<td>List of users with whom we do not share any encrypted rooms
anymore since the previous sync response.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For optimal performance, Alice should be added to <tt class="docutils literal">changed</tt> in Bob's sync only
when she adds a new device, or when Alice and Bob now share a room but didn't
share any room previously. However, for the sake of simpler logic, a server
may add Alice to <tt class="docutils literal">changed</tt> when Alice and Bob share a new room, even if they
previously already shared a room.</p>
</div>
<p>Example response:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;next_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s72595_4483_1934&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="name tag">&quot;leave&quot;</span><span class="punctuation">:</span> <span class="punctuation">{},</span> <span class="name tag">&quot;join&quot;</span><span class="punctuation">:</span> <span class="punctuation">{},</span> <span class="name tag">&quot;invite&quot;</span><span class="punctuation">:</span> <span class="punctuation">{}},</span>
  <span class="name tag">&quot;device_lists&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;changed&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
       <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;left&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
       <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
    <span class="punctuation">],</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;device_one_time_keys_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;curve25519&quot;</span><span class="punctuation">:</span> <span class="literal number integer">10</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signed_curve25519&quot;</span><span class="punctuation">:</span> <span class="literal number integer">20</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<!-- References -->
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
</div>
<p><a class="anchor" id="room-history-visibility"></a></p>
<div class="section" id="room-history-visibility">
<h2><a class="toc-backref" href="#id504">13.12&nbsp;&nbsp;&nbsp;Room History Visibility</a></h2>
<p id="module-history-visibility">This module adds support for controlling the visibility of previous events in a
room.</p>
<p>In all cases except <tt class="docutils literal">world_readable</tt>, a user needs to join a room to view events in that room. Once they
have joined a room, they will gain access to a subset of events in the room. How
this subset is chosen is controlled by the <tt class="docutils literal">m.room.history_visibility</tt> event
outlined below. After a user has left a room, they may see any events which they
were allowed to see before they left the room, but no events received after they
left.</p>
<p>The four options for the <tt class="docutils literal">m.room.history_visibility</tt> event are:</p>
<ul class="simple">
<li><tt class="docutils literal">world_readable</tt> - All events while this is the
<tt class="docutils literal">m.room.history_visibility</tt> value may be shared by any participating
homeserver with anyone, regardless of whether they have ever joined the room.</li>
<li><tt class="docutils literal">shared</tt> - Previous events are always accessible to newly joined members. All
events in the room are accessible, even those sent when the member was not a part
of the room.</li>
<li><tt class="docutils literal">invited</tt> - Events are accessible to newly joined members from the point
they were invited onwards. Events stop being accessible when the member's state
changes to something other than <tt class="docutils literal">invite</tt> or <tt class="docutils literal">join</tt>.</li>
<li><tt class="docutils literal">joined</tt> - Events are accessible to newly joined members from the point
they joined the room onwards. Events stop being accessible when the member's state
changes to something other than <tt class="docutils literal">join</tt>.</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">These options are applied at the point an event is <em>sent</em>. Checks are
performed with the state of the <tt class="docutils literal">m.room.history_visibility</tt> event when the
event in question is added to the DAG. This means clients cannot
retrospectively choose to show or hide history to new users if the setting at
that time was more restrictive.</p>
</div>
<p><a class="anchor" id="id130"></a></p>
<div class="section" id="id130">
<h3><a class="toc-backref" href="#id505">13.12.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-room-history-visibility"></a></p>
<div class="section" id="m-room-history-visibility">
<h4><a class="toc-backref" href="#id506">13.12.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.history_visibility</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This event controls whether a user can see the events that happened in a room from before they joined.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>history_visibility</td>
<td>enum</td>
<td><strong>Required.</strong> Who can see the room history. One
of: [&quot;invited&quot;, &quot;joined&quot;, &quot;shared&quot;,
&quot;world_readable&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;history_visibility&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;shared&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.history_visibility&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id131"></a></p>
<div class="section" id="id131">
<h3><a class="toc-backref" href="#id507">13.12.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients that implement this module MUST present to the user the possible options
for setting history visibility when creating a room.</p>
<p>Clients may want to display a notice that their events may be read by non-joined
people if the value is set to <tt class="docutils literal">world_readable</tt>.</p>
</div>
<p><a class="anchor" id="id132"></a></p>
<div class="section" id="id132">
<h3><a class="toc-backref" href="#id508">13.12.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>By default if no <tt class="docutils literal">history_visibility</tt> is set, or if the value is not understood, the visibility is assumed to be
<tt class="docutils literal">shared</tt>. The rules governing whether a user is allowed to see an event depend
on the state of the room <em>at that event</em>.</p>
<ol class="arabic simple">
<li>If the <tt class="docutils literal">history_visibility</tt> was set to <tt class="docutils literal">world_readable</tt>, allow.</li>
<li>If the user's <tt class="docutils literal">membership</tt> was <tt class="docutils literal">join</tt>, allow.</li>
<li>If <tt class="docutils literal">history_visibility</tt> was set to <tt class="docutils literal">shared</tt>, and the user joined the
room at any point after the event was sent, allow.</li>
<li>If the user's <tt class="docutils literal">membership</tt> was <tt class="docutils literal">invite</tt>, and the <tt class="docutils literal">history_visibility</tt>
was set to <tt class="docutils literal">invited</tt>, allow.</li>
<li>Otherwise, deny.</li>
</ol>
<p>For <tt class="docutils literal">m.room.history_visibility</tt> events themselves, the user should be allowed
to see the event if the <tt class="docutils literal">history_visibility</tt> before <em>or</em> after the event
would allow them to see it. (For example, a user should be able to see
<tt class="docutils literal">m.room.history_visibility</tt> events which change the <tt class="docutils literal">history_visibility</tt>
from <tt class="docutils literal">world_readable</tt> to <tt class="docutils literal">joined</tt> <em>or</em> from <tt class="docutils literal">joined</tt> to
<tt class="docutils literal">world_readable</tt>, even if that user was not a member of the room.)</p>
<p>Likewise, for the user's own <tt class="docutils literal">m.room.member</tt> events, the user should be
allowed to see the event if their <tt class="docutils literal">membership</tt> before <em>or</em> after the event
would allow them to see it. (For example, a user can always see
<tt class="docutils literal">m.room.member</tt> events which set their membership to <tt class="docutils literal">join</tt>, or which
change their membership from <tt class="docutils literal">join</tt> to any other value, even if
<tt class="docutils literal">history_visibility</tt> is <tt class="docutils literal">joined</tt>.)</p>
</div>
<p><a class="anchor" id="id133"></a></p>
<div class="section" id="id133">
<h3><a class="toc-backref" href="#id509">13.12.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>The default value for <tt class="docutils literal">history_visibility</tt> is <tt class="docutils literal">shared</tt> for
backwards-compatibility reasons. Clients need to be aware that by not setting
this event they are exposing all of their room history to anyone in the room.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!-- Copyright 2019 The Matrix.org Foundation C.I.C. -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id134"></a></p>
<div class="section" id="id134">
<h2><a class="toc-backref" href="#id510">13.13&nbsp;&nbsp;&nbsp;Push Notifications</a></h2>
<pre class="literal-block" id="module-push">
                                  +--------------------+  +-------------------+
                 Matrix HTTP      |                    |  |                   |
            Notification Protocol |   App Developer    |  |   Device Vendor   |
                                  |                    |  |                   |
          +-------------------+   | +----------------+ |  | +---------------+ |
          |                   |   | |                | |  | |               | |
          | Matrix homeserver +-----&gt;  Push Gateway  +------&gt; Push Provider | |
          |                   |   | |                | |  | |               | |
          +-^-----------------+   | +----------------+ |  | +----+----------+ |
            |                     |                    |  |      |            |
   Matrix   |                     |                    |  |      |            |
Client/Server API  +              |                    |  |      |            |
            |      |              +--------------------+  +-------------------+
            |   +--+-+                                           |
            |   |    &lt;-------------------------------------------+
            +---+    |
                |    |          Provider Push Protocol
                +----+

        Mobile Device or Client
</pre>
<p>This module adds support for push notifications. Homeservers send notifications
of events to user-configured HTTP endpoints. Users may also configure a
number of rules that determine which events generate notifications. These are
all stored and managed by the user's homeserver. This allows user-specific push
settings to be reused between client applications.</p>
<p>The above diagram shows the flow of push notifications being sent to a handset
where push notifications are submitted via the handset vendor, such as Apple's
APNS or Google's GCM. This happens as follows:</p>
<ol class="arabic simple">
<li>The client app signs in to a homeserver.</li>
<li>The client app registers with its vendor's Push Provider and
obtains a routing token of some kind.</li>
<li>The mobile app uses the Client/Server API to add a 'pusher', providing the
URL of a specific Push Gateway which is configured for that
application. It also provides the routing token it has acquired from the
Push Provider.</li>
<li>The homeserver starts sending HTTP requests to the Push Gateway using the
supplied URL. The Push Gateway relays this notification to
the Push Provider, passing the routing token along with any
necessary private credentials the provider requires to send push
notifications.</li>
<li>The Push Provider sends the notification to the device.</li>
</ol>
<p>Definitions for terms used in this section are below:</p>
<dl class="docutils">
<dt>Push Provider</dt>
<dd>A push provider is a service managed by the device vendor which can send
notifications directly to the device. Google Cloud Messaging (GCM) and Apple
Push Notification Service (APNS) are two examples of push providers.</dd>
<dt>Push Gateway</dt>
<dd>A push gateway is a server that receives HTTP event notifications from
homeservers and passes them on to a different protocol such as APNS for iOS
devices or GCM for Android devices. Clients inform the homeserver which
Push Gateway to send notifications to when it sets up a Pusher.</dd>
</dl>
<dl class="docutils" id="def-pushers">
<dt>Pusher</dt>
<dd>A pusher is a worker on the homeserver that manages the sending
of HTTP notifications for a user. A user can have multiple pushers: one per
device.</dd>
<dt>Push Rule</dt>
<dd>A push rule is a single rule that states under what <em>conditions</em> an event should
be passed onto a push gateway and <em>how</em> the notification should be presented.
These rules are stored on the user's homeserver. They are manually configured
by the user, who can create and view them via the Client/Server API.</dd>
<dt>Push Ruleset</dt>
<dd>A push ruleset <em>scopes a set of rules according to some criteria</em>. For example,
some rules may only be applied for messages from a particular sender,
a particular room, or by default. The push ruleset contains the entire set
of scopes and rules.</dd>
</dl>
<p><a class="anchor" id="id135"></a></p>
<div class="section" id="id135">
<h3><a class="toc-backref" href="#id511">13.13.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients MUST configure a Pusher before they will receive push notifications.
There is a single API endpoint for this, as described below.</p>
<p><a class="anchor" id="get-matrix-client-r0-pushers"></a></p>
<div class="section" id="get-matrix-client-r0-pushers">
<h4><a class="toc-backref" href="#id512">13.13.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/pushers</tt></a></h4>
<p>Gets all currently active pushers for the authenticated user.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>pushers</td>
<td>[Pusher]</td>
<td>An array containing the current pushers for the
user</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Pusher</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>pushkey</td>
<td>string</td>
<td><strong>Required.</strong> This is a unique identifier for this
pusher. See <tt class="docutils literal">/set</tt> for more detail. Max length,
512 bytes.</td>
</tr>
<tr><td>kind</td>
<td>string</td>
<td><strong>Required.</strong> The kind of pusher. <tt class="docutils literal">&quot;http&quot;</tt> is a
pusher that sends HTTP pokes.</td>
</tr>
<tr><td>app_id</td>
<td>string</td>
<td><strong>Required.</strong> This is a reverse-DNS style
identifier for the application. Max length, 64
chars.</td>
</tr>
<tr><td>app_display_name</td>
<td>string</td>
<td><strong>Required.</strong> A string that will allow the user to
identify what application owns this pusher.</td>
</tr>
<tr><td>device_display_name</td>
<td>string</td>
<td><strong>Required.</strong> A string that will allow the user to
identify what device owns this pusher.</td>
</tr>
<tr><td>profile_tag</td>
<td>string</td>
<td>This string determines which set of device
specific rules this pusher executes.</td>
</tr>
<tr><td>lang</td>
<td>string</td>
<td><strong>Required.</strong> The preferred language for receiving
notifications (e.g. 'en' or 'en-US')</td>
</tr>
<tr><td>data</td>
<td>PusherData</td>
<td><strong>Required.</strong> A dictionary of information for the
pusher implementation itself.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PusherData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>url</td>
<td>string</td>
<td>Required if <tt class="docutils literal">kind</tt> is <tt class="docutils literal">http</tt>. The URL to use
to send notifications to.</td>
</tr>
<tr><td>format</td>
<td>string</td>
<td>The format to use when sending notifications to
the Push Gateway.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/pushers</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The pushers for this user.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;pushers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;pushkey&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Xp/MzCt8/9DcSNE9cuiaoT5Ac55job3TdLSSmtmYl4A=&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;http&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;app_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;face.mcapp.appy.prod&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;app_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Appy McAppface&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;device_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice's Phone&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;profile_tag&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xyz&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;en-US&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://example.com/_matrix/push/v1/notify&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-r0-pushers-set"></a></p>
<div class="section" id="post-matrix-client-r0-pushers-set">
<h4><a class="toc-backref" href="#id513">13.13.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/pushers/set</tt></a></h4>
<p>This endpoint allows the creation, modification and deletion of <a class="reference internal" href="#def-pushers">pushers</a>
for this user ID. The behaviour of this endpoint varies depending on the
values in the JSON body.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>pushkey</td>
<td>string</td>
<td><p class="first"><strong>Required.</strong> This is a unique identifier for this
pusher. The value you should use for this is the
routing or destination address information for the
notification, for example, the APNS token for APNS
or the Registration ID for GCM. If your
notification client has no such concept, use any
unique identifier. Max length, 512 bytes.</p>
<p class="last">If the <tt class="docutils literal">kind</tt> is <tt class="docutils literal">&quot;email&quot;</tt>, this is the email
address to send notifications to.</p>
</td>
</tr>
<tr><td>kind</td>
<td>string</td>
<td><strong>Required.</strong> The kind of pusher to configure.
<tt class="docutils literal">&quot;http&quot;</tt> makes a pusher that sends HTTP pokes.
<tt class="docutils literal">&quot;email&quot;</tt> makes a pusher that emails the user
with unread notifications. <tt class="docutils literal">null</tt> deletes the
pusher.</td>
</tr>
<tr><td>app_id</td>
<td>string</td>
<td><p class="first"><strong>Required.</strong> This is a reverse-DNS style
identifier for the application. It is recommended
that this end with the platform, such that
different platform versions get different app
identifiers. Max length, 64 chars.</p>
<p class="last">If the <tt class="docutils literal">kind</tt> is <tt class="docutils literal">&quot;email&quot;</tt>, this is
<tt class="docutils literal">&quot;m.email&quot;</tt>.</p>
</td>
</tr>
<tr><td>app_display_name</td>
<td>string</td>
<td><strong>Required.</strong> A string that will allow the user to
identify what application owns this pusher.</td>
</tr>
<tr><td>device_display_name</td>
<td>string</td>
<td><strong>Required.</strong> A string that will allow the user to
identify what device owns this pusher.</td>
</tr>
<tr><td>profile_tag</td>
<td>string</td>
<td>This string determines which set of device
specific rules this pusher executes.</td>
</tr>
<tr><td>lang</td>
<td>string</td>
<td><strong>Required.</strong> The preferred language for receiving
notifications (e.g. 'en' or 'en-US').</td>
</tr>
<tr><td>data</td>
<td>PusherData</td>
<td><strong>Required.</strong> A dictionary of information for the
pusher implementation itself. If <tt class="docutils literal">kind</tt> is
<tt class="docutils literal">http</tt>, this should contain <tt class="docutils literal">url</tt> which is the
URL to use to send notifications to.</td>
</tr>
<tr><td>append</td>
<td>boolean</td>
<td>If true, the homeserver should add another pusher
with the given pushkey and App ID in addition to
any others with different user IDs. Otherwise, the
homeserver must remove any other pushers with the
same App ID and pushkey for different users. The
default is <tt class="docutils literal">false</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PusherData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>url</td>
<td>string</td>
<td>Required if <tt class="docutils literal">kind</tt> is <tt class="docutils literal">http</tt>. The URL to use
to send notifications to. MUST be an HTTPS URL
with a path of  <tt class="docutils literal">/_matrix/push/v1/notify</tt>.</td>
</tr>
<tr><td>format</td>
<td>string</td>
<td>The format to send notifications in to Push
Gateways if the <tt class="docutils literal">kind</tt> is <tt class="docutils literal">http</tt>. The details
about what fields the homeserver should send to
the push gateway are defined in the <a class="reference external" href="../push_gateway/r0.1.0.html">Push Gateway
Specification</a>. Currently the only format
available is 'event_id_only'.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/pushers/set</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;en&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;http&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;app_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Mat Rix&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;device_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;iPhone 9&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;profile_tag&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;xxyyzz&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;app_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;com.example.app.ios&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;pushkey&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;APA91bHPRgkF3JUikC4ENAHEeMrd41Zxv3hVZjC9KtT8OvPVGJ-hQMRKRrZuJAEcl7B338qju59zJMjw2DELjzEvxwYv7hH5Ynpc1ODQ0aT4U4OFEeco8ohsN5PjL1iC2dNtk2BAokeMCg2ZXKqpc8FXKmhX94kIxQ&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://push-gateway.location.here/_matrix/push/v1/notify&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_id_only&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;append&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The pusher was set.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>One or more of the pusher values were invalid.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Missing parameters: lang, data&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_MISSING_PARAM&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="listing-notifications"></a></p>
<div class="section" id="listing-notifications">
<h4><a class="toc-backref" href="#id514">13.13.1.3&nbsp;&nbsp;&nbsp;Listing Notifications</a></h4>
<p>A client can retrieve a list of events that it has been notified about. This
may be useful so that users can see a summary of what important messages they
have received.</p>
<p><a class="anchor" id="get-matrix-client-r0-notifications"></a></p>
<div class="section" id="get-matrix-client-r0-notifications">
<h5><a class="toc-backref" href="#id515">13.13.1.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/notifications</tt></a></h5>
<p>This API is used to paginate through the list of events that the
user has been, or would have been notified about.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>from</td>
<td>string</td>
<td>Pagination token given to retrieve the next set of
events.</td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>Limit on the number of events to return in this
request.</td>
</tr>
<tr><td>only</td>
<td>string</td>
<td>Allows basic filtering of events returned. Supply
<tt class="docutils literal">highlight</tt> to return only events where the
notification had the highlight tweak set.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>next_token</td>
<td>string</td>
<td>The token to supply in the <tt class="docutils literal">from</tt> param of the
next <tt class="docutils literal">/notifications</tt> request in order to
request more events. If this is absent, there are
no more results.</td>
</tr>
<tr><td>notifications</td>
<td>[Notification]</td>
<td><strong>Required.</strong> The list of events that triggered
notifications.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Notification</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>actions</td>
<td>[object or string]</td>
<td><strong>Required.</strong> The action(s) to perform when the
conditions for this rule are met. See <a class="reference internal" href="#push-rules-api">Push Rules:
API</a>.</td>
</tr>
<tr><td>event</td>
<td>Event</td>
<td><strong>Required.</strong> The Event object for the event that
triggered the notification.</td>
</tr>
<tr><td>profile_tag</td>
<td>string</td>
<td>The profile tag of the rule that matched this
event.</td>
</tr>
<tr><td>read</td>
<td>boolean</td>
<td><strong>Required.</strong> Indicates whether the user has sent
a read receipt indicating that they have read this
message.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room in which the
event was posted.</td>
</tr>
<tr><td>ts</td>
<td>integer</td>
<td><strong>Required.</strong> The unix timestamp at which the
event notification was sent, in milliseconds.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>The ID of this event, if applicable.</td>
</tr>
<tr><td>content</td>
<td>EventContent</td>
<td>The content of this event. The fields in this
object will vary depending on the type of event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td>Timestamp in milliseconds on originating
homeserver when this event was sent.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td>The MXID of the user who sent this event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>Optional. This key will only be present for state
events. A unique key which defines the overwriting
semantics for this piece of room state.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td>The type of event.</td>
</tr>
<tr><td>unsigned</td>
<td>Unsigned</td>
<td>Information about this event which was not sent by
the originating homeserver</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Unsigned</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>Time in milliseconds since the event was sent.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this state.
This will be present only for state events
appearing in the <tt class="docutils literal">timeline</tt>. If this is not a
state event, or there is no previous content, this
key will be missing.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>Optional. The transaction ID set when this message
was sent. This key will only be present for
message events sent by the device calling this
API.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/notifications?from=xxxxx&amp;limit=20&amp;only=highlight</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A batch of events is being returned</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;next_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abcdef&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;notifications&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;notify&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;profile_tag&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;hcbvkzxhcvb&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;read&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!abcdefg:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1475508881945</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
        <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id136"></a></p>
<div class="section" id="id136">
<h4><a class="toc-backref" href="#id516">13.13.1.4&nbsp;&nbsp;&nbsp;Receiving notifications</a></h4>
<p>Servers MUST include the number of unread notifications in a client's <tt class="docutils literal">/sync</tt>
stream, and MUST update it as it changes. Notifications are determined by the
push rules which apply to an event.</p>
<p>When the user updates their read receipt (either by using the API or by sending an
event), notifications prior to and including that event MUST be marked as read.</p>
</div>
<p><a class="anchor" id="push-rules"></a></p>
<div class="section" id="push-rules">
<h4><a class="toc-backref" href="#id517">13.13.1.5&nbsp;&nbsp;&nbsp;Push Rules</a></h4>
<p>A push rule is a single rule that states under what <em>conditions</em> an event should
be passed onto a push gateway and <em>how</em> the notification should be presented.
There are different &quot;kinds&quot; of push rules and each rule has an associated
priority. Every push rule MUST have a <tt class="docutils literal">kind</tt> and <tt class="docutils literal">rule_id</tt>. The <tt class="docutils literal">rule_id</tt>
is a unique string within the kind of rule and its' scope: <tt class="docutils literal">rule_ids</tt> do not
need to be unique between rules of the same kind on different devices. Rules may
have extra keys depending on the value of <tt class="docutils literal">kind</tt>. The different kinds of rule
in descending order of priority are:</p>
<dl class="docutils">
<dt>Override Rules <tt class="docutils literal">override</tt></dt>
<dd>The highest priority rules are user-configured overrides.</dd>
<dt>Content-specific Rules <tt class="docutils literal">content</tt></dt>
<dd>These configure behaviour for (unencrypted) messages that match certain
patterns. Content rules take one parameter: <tt class="docutils literal">pattern</tt>, that gives the glob
pattern to match against. This is treated in the same way as <tt class="docutils literal">pattern</tt> for
<tt class="docutils literal">event_match</tt>.</dd>
<dt>Room-specific Rules <tt class="docutils literal">room</tt></dt>
<dd>These rules change the behaviour of all messages for a given room. The
<tt class="docutils literal">rule_id</tt> of a room rule is always the ID of the room that it affects.</dd>
<dt>Sender-specific rules <tt class="docutils literal">sender</tt></dt>
<dd>These rules configure notification behaviour for messages from a specific
Matrix user ID. The <tt class="docutils literal">rule_id</tt> of Sender rules is always the Matrix user
ID of the user whose messages they'd apply to.</dd>
<dt>Underride rules <tt class="docutils literal">underride</tt></dt>
<dd>These are identical to <tt class="docutils literal">override</tt> rules, but have a lower priority than
<tt class="docutils literal">content</tt>, <tt class="docutils literal">room</tt> and <tt class="docutils literal">sender</tt> rules.</dd>
</dl>
<p>This means that the full list of rule kinds, in descending priority order, is
as follows:</p>
<ul class="simple">
<li>Global Override</li>
<li>Global Content</li>
<li>Global Room</li>
<li>Global Sender</li>
<li>Global Underride</li>
</ul>
<p>Rules with the same <tt class="docutils literal">kind</tt> can specify an ordering priority. This determines
which rule is selected in the event of multiple matches. For example, a rule
matching &quot;tea&quot; and a separate rule matching &quot;time&quot; would both match the sentence
&quot;It's time for tea&quot;. The ordering of the rules would then resolve the tiebreak
to determine which rule is executed. Only <tt class="docutils literal">actions</tt> for highest priority rule
will be sent to the Push Gateway.</p>
<p>Each rule can be enabled or disabled. Disabled rules never match. If no rules
match an event, the homeserver MUST NOT notify the Push Gateway for that event.
Homeservers MUST NOT notify the Push Gateway for events that the user has sent
themselves.</p>
<p><a class="anchor" id="actions"></a></p>
<div class="section" id="actions">
<h5><a class="toc-backref" href="#id518">13.13.1.5.1&nbsp;&nbsp;&nbsp;Actions</a></h5>
<p>All rules have an associated list of <tt class="docutils literal">actions</tt>. An action affects if and how a
notification is delivered for a matching event. The following actions are defined:</p>
<dl class="docutils">
<dt><tt class="docutils literal">notify</tt></dt>
<dd>This causes each matching event to generate a notification.</dd>
<dt><tt class="docutils literal">dont_notify</tt></dt>
<dd>This prevents each matching event from generating a notification</dd>
<dt><tt class="docutils literal">coalesce</tt></dt>
<dd>This enables notifications for matching events but activates homeserver
specific behaviour to intelligently coalesce multiple events into a single
notification. Not all homeservers may support this. Those that do not support
it should treat it as the <tt class="docutils literal">notify</tt> action.</dd>
<dt><tt class="docutils literal">set_tweak</tt></dt>
<dd>Sets an entry in the <tt class="docutils literal">tweaks</tt> dictionary key that is sent in the notification
request to the Push Gateway. This takes the form of a dictionary with a
<tt class="docutils literal">set_tweak</tt> key whose value is the name of the tweak to set. It may also
have a <tt class="docutils literal">value</tt> key which is the value to which it should be set.</dd>
</dl>
<p>Actions that have no parameters are represented as a string. Otherwise, they are
represented as a dictionary with a key equal to their name and other keys as
their parameters, e.g. <tt class="docutils literal">{ &quot;set_tweak&quot;: &quot;sound&quot;, &quot;value&quot;: &quot;default&quot; }</tt></p>
<p><a class="anchor" id="tweaks"></a></p>
<div class="section" id="tweaks">
<h6><a class="toc-backref" href="#id519">13.13.1.5.1.1&nbsp;&nbsp;&nbsp;Tweaks</a></h6>
<p>The <tt class="docutils literal">set_tweak</tt> action is used to add an entry to the 'tweaks' dictionary
that is sent in the notification request to the Push Gateway. The following
tweaks are defined:</p>
<dl class="docutils">
<dt><tt class="docutils literal">sound</tt></dt>
<dd>A string representing the sound to be played when this notification arrives.
A value of <tt class="docutils literal">default</tt> means to play a default sound. A device may choose to
alert the user by some other means if appropriate, eg. vibration.</dd>
<dt><tt class="docutils literal">highlight</tt></dt>
<dd>A boolean representing whether or not this message should be highlighted in
the UI. This will normally take the form of presenting the message in a
different colour and/or style. The UI might also be adjusted to draw
particular attention to the room in which the event occurred. If a
<tt class="docutils literal">highlight</tt> tweak is given with no value, its value is defined to be
<tt class="docutils literal">true</tt>. If no highlight tweak is given at all then the value of
<tt class="docutils literal">highlight</tt> is defined to be false.</dd>
</dl>
<p>Tweaks are passed transparently through the homeserver so client applications
and Push Gateways may agree on additional tweaks. For example, a tweak may be
added to specify how to flash the notification light on a mobile device.</p>
</div>
</div>
<p><a class="anchor" id="predefined-rules"></a></p>
<div class="section" id="predefined-rules">
<h5><a class="toc-backref" href="#id520">13.13.1.5.2&nbsp;&nbsp;&nbsp;Predefined Rules</a></h5>
<p>Homeservers can specify &quot;server-default rules&quot; which operate at a lower priority
than &quot;user-defined rules&quot;. The <tt class="docutils literal">rule_id</tt> for all server-default rules MUST
start with a dot (&quot;.&quot;) to identify them as &quot;server-default&quot;. The following
server-default rules are specified:</p>
<p><a class="anchor" id="default-override-rules"></a></p>
<div class="section" id="default-override-rules">
<h6><a class="toc-backref" href="#id521">13.13.1.5.2.1&nbsp;&nbsp;&nbsp;Default Override Rules</a></h6>
<p><a class="anchor" id="m-rule-master"></a></p>
<div class="section" id="m-rule-master">
<h7><a class="toc-backref" href="#id522">13.13.1.5.2.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.master</tt></a></h7>
<p>Matches all events, this can be enabled to turn off all push notifications
other than those generated by override rules set by the user. By default this
rule is disabled.</p>
<p>Definition</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.master&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[],</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;dont_notify&quot;</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-rule-suppress-notices"></a></p>
<div class="section" id="m-rule-suppress-notices">
<h7><a class="toc-backref" href="#id523">13.13.1.5.2.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.suppress_notices</tt></a></h7>
<p>Matches messages with a <tt class="docutils literal">msgtype</tt> of <tt class="docutils literal">notice</tt>. This should be an
<tt class="docutils literal">override</tt> rule so that it takes priority over <tt class="docutils literal">content</tt> / <tt class="docutils literal">sender</tt> /
<tt class="docutils literal">room</tt> rules.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.suppress_notices&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;content.msgtype&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.notice&quot;</span><span class="punctuation">,</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;dont_notify&quot;</span><span class="punctuation">,</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-rule-invite-for-me"></a></p>
<div class="section" id="m-rule-invite-for-me">
<h7><a class="toc-backref" href="#id524">13.13.1.5.2.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.invite_for_me</tt></a></h7>
<p>Matches any invites to a new room for this user.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.invite_for_me&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;content.membership&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;state_key&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;[the user's Matrix ID]&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
       <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
        <span class="punctuation">}</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-rule-member-event"></a></p>
<div class="section" id="m-rule-member-event">
<h7><a class="toc-backref" href="#id525">13.13.1.5.2.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.member_event</tt></a></h7>
<p>Matches any <tt class="docutils literal">m.room.member_event</tt>.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.member_event&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;dont_notify&quot;</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-rule-contains-display-name"></a></p>
<div class="section" id="m-rule-contains-display-name">
<h7><a class="toc-backref" href="#id526">13.13.1.5.2.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.contains_display_name</tt></a></h7>
<p>Matches any message whose content is unencrypted and contains the user's
current display name in the room in which it was sent.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.contains_display_name&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;contains_display_name&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-rule-tombstone"></a></p>
<div class="section" id="m-rule-tombstone">
<h7><a class="toc-backref" href="#id527">13.13.1.5.2.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.tombstone</tt></a></h7>
<p>Matches any event whose type is <tt class="docutils literal">m.room.tombstone</tt>. This is intended
to notify users of a room when it is upgraded, similar to what an
<tt class="docutils literal">&#64;room</tt> notification would accomplish.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.tombstone&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.tombstone&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
        <span class="punctuation">}</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-rule-roomnotif"></a></p>
<div class="section" id="m-rule-roomnotif">
<h7><a class="toc-backref" href="#id528">13.13.1.5.2.1.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.roomnotif</tt></a></h7>
<p>Matches any message whose content is unencrypted and contains the
text <tt class="docutils literal">&#64;room</tt>, signifying the whole room should be notified of
the event.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.roomnotif&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;content.body&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;room&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sender_notification_permission&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;room&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
        <span class="punctuation">}</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="default-content-rules"></a></p>
<div class="section" id="default-content-rules">
<h6><a class="toc-backref" href="#id529">13.13.1.5.2.2&nbsp;&nbsp;&nbsp;Default Content Rules</a></h6>
<p><a class="anchor" id="m-rule-contains-user-name"></a></p>
<div class="section" id="m-rule-contains-user-name">
<h7><a class="toc-backref" href="#id530">13.13.1.5.2.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.contains_user_name</tt></a></h7>
<p>Matches any message whose content is unencrypted and contains the local part
of the user's Matrix ID, separated by word boundaries.</p>
<p>Definition (as a <tt class="docutils literal">content</tt> rule):</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.contains_user_name&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;[the local part of the user's Matrix ID]&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="default-underride-rules"></a></p>
<div class="section" id="default-underride-rules">
<h6><a class="toc-backref" href="#id531">13.13.1.5.2.3&nbsp;&nbsp;&nbsp;Default Underride Rules</a></h6>
<p><a class="anchor" id="m-rule-call"></a></p>
<div class="section" id="m-rule-call">
<h7><a class="toc-backref" href="#id532">13.13.1.5.2.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.call</tt></a></h7>
<p>Matches any incoming VOIP call.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.call&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.invite&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ring&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
        <span class="punctuation">}</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-rule-encrypted-room-one-to-one"></a></p>
<div class="section" id="m-rule-encrypted-room-one-to-one">
<h7><a class="toc-backref" href="#id533">13.13.1.5.2.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.encrypted_room_one_to_one</tt></a></h7>
<p>Matches any encrypted event sent in a room with exactly two members.
Unlike other push rules, this rule cannot be matched against the content
of the event by nature of it being encrypted. This causes the rule to
be an &quot;all or nothing&quot; match where it either matches <em>all</em> events that
are encrypted (in 1:1 rooms) or none.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.encrypted_room_one_to_one&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;room_member_count&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;is&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;2&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.encrypted&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
        <span class="punctuation">}</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-rule-room-one-to-one"></a></p>
<div class="section" id="m-rule-room-one-to-one">
<h7><a class="toc-backref" href="#id534">13.13.1.5.2.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.room_one_to_one</tt></a></h7>
<p>Matches any message sent in a room with exactly two members.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.room_one_to_one&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;room_member_count&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;is&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;2&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
        <span class="punctuation">}</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-rule-message"></a></p>
<div class="section" id="m-rule-message">
<h7><a class="toc-backref" href="#id535">13.13.1.5.2.3.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.message</tt></a></h7>
<p>Matches all chat messages.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
     <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.message&quot;</span><span class="punctuation">,</span>
     <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
     <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
     <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
         <span class="punctuation">{</span>
             <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
             <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
             <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span>
         <span class="punctuation">}</span>
     <span class="punctuation">],</span>
     <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
         <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
         <span class="punctuation">{</span>
             <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
             <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
         <span class="punctuation">}</span>
     <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-rule-encrypted"></a></p>
<div class="section" id="m-rule-encrypted">
<h7><a class="toc-backref" href="#id536">13.13.1.5.2.3.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">.m.rule.encrypted</tt></a></h7>
<p>Matches all encrypted events. Unlike other push rules, this rule cannot
be matched against the content of the event by nature of it being encrypted.
This causes the rule to be an &quot;all or nothing&quot; match where it either
matches <em>all</em> events that are encrypted (in group rooms) or none.</p>
<p>Definition:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
     <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.encrypted&quot;</span><span class="punctuation">,</span>
     <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
     <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
     <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
         <span class="punctuation">{</span>
             <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
             <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
             <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.encrypted&quot;</span>
         <span class="punctuation">}</span>
     <span class="punctuation">],</span>
     <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
         <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
         <span class="punctuation">{</span>
             <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
             <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
         <span class="punctuation">}</span>
     <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="conditions"></a></p>
<div class="section" id="conditions">
<h5><a class="toc-backref" href="#id537">13.13.1.5.3&nbsp;&nbsp;&nbsp;Conditions</a></h5>
<p>Override, Underride and Default Rules MAY have a list of 'conditions'.
All conditions must hold true for an event in order to apply the <tt class="docutils literal">action</tt> for
the event. A rule with no conditions always matches. Room, Sender, User and
Content rules do not have conditions in the same way, but instead have
predefined conditions. These conditions can be configured using the parameters
outlined below. In the cases of room and sender rules, the <tt class="docutils literal">rule_id</tt> of the
rule determines its behaviour. The following conditions are defined:</p>
<dl class="docutils">
<dt><tt class="docutils literal">event_match</tt></dt>
<dd><p class="first">This is a glob pattern match on a field of the event. Parameters:</p>
<ul class="last simple">
<li><tt class="docutils literal">key</tt>: The dot-separated field of the event to match, e.g. <tt class="docutils literal">content.body</tt></li>
<li><tt class="docutils literal">pattern</tt>: The glob-style pattern to match against. Patterns with no
special glob characters should be treated as having asterisks
prepended and appended when testing the condition.</li>
</ul>
</dd>
<dt><tt class="docutils literal">contains_display_name</tt></dt>
<dd>This matches unencrypted messages where <tt class="docutils literal">content.body</tt> contains the owner's
display name in that room. This is a separate rule because display names may
change and as such it would be hard to maintain a rule that matched the user's
display name. This condition has no parameters.</dd>
<dt><tt class="docutils literal">room_member_count</tt></dt>
<dd><p class="first">This matches the current number of members in the room. Parameters:</p>
<ul class="last simple">
<li><tt class="docutils literal">is</tt>: A decimal integer optionally prefixed by one of, <tt class="docutils literal">==</tt>, <tt class="docutils literal">&lt;</tt>,
<tt class="docutils literal">&gt;</tt>, <tt class="docutils literal">&gt;=</tt> or <tt class="docutils literal">&lt;=</tt>. A prefix of <tt class="docutils literal">&lt;</tt> matches rooms where the member
count is strictly less than the given number and so forth. If no prefix is
present, this parameter defaults to <tt class="docutils literal">==</tt>.</li>
</ul>
</dd>
<dt><tt class="docutils literal">sender_notification_permission</tt></dt>
<dd><p class="first">This takes into account the current power levels in the room, ensuring the
sender of the event has high enough power to trigger the notification.</p>
<p>Parameters:</p>
<ul class="last simple">
<li><tt class="docutils literal">key</tt>: A string that determines the power level the sender must have to trigger
notifications of a given type, such as <tt class="docutils literal">room</tt>. Refer to the <a class="reference internal" href="#m-room-power-levels">m.room.power_levels</a>
event schema for information about what the defaults are and how to interpret the event.
The <tt class="docutils literal">key</tt> is used to look up the power level required to send a notification type
from the <tt class="docutils literal">notifications</tt> object in the power level event content.</li>
</ul>
</dd>
</dl>
<p>Unrecognised conditions MUST NOT match any events, effectively making the push
rule disabled.</p>
</div>
</div>
<p><a class="anchor" id="push-rules-api"></a></p>
<div class="section" id="push-rules-api">
<h4><a class="toc-backref" href="#id538">13.13.1.6&nbsp;&nbsp;&nbsp;Push Rules: API</a></h4>
<p>Clients can retrieve, add, modify and remove push rules globally or per-device
using the APIs below.</p>
<p><a class="anchor" id="get-matrix-client-r0-pushrules"></a></p>
<div class="section" id="get-matrix-client-r0-pushrules">
<h5><a class="toc-backref" href="#id539">13.13.1.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/pushrules/</tt></a></h5>
<p>Retrieve all push rulesets for this user. Clients can &quot;drill-down&quot; on
the rulesets by suffixing a <tt class="docutils literal">scope</tt> to this path e.g.
<tt class="docutils literal">/pushrules/global/</tt>. This will return a subset of this data under the
specified key e.g. the <tt class="docutils literal">global</tt> key.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>global</td>
<td>Ruleset</td>
<td><strong>Required.</strong> The global ruleset.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Ruleset</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>override</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>room</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>sender</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>underride</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PushRule</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>actions</td>
<td>[object or string]</td>
<td><strong>Required.</strong> The actions to perform when this
rule is matched.</td>
</tr>
<tr><td>default</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether this is a default rule, or
has been set explicitly.</td>
</tr>
<tr><td>enabled</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the push rule is enabled or
not.</td>
</tr>
<tr><td>rule_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of this rule.</td>
</tr>
<tr><td>conditions</td>
<td>[PushCondition]</td>
<td>The conditions that must hold true for an event in
order for a rule to be applied to an event. A rule
with no conditions always matches. Only applicable
to <tt class="docutils literal">underride</tt> and <tt class="docutils literal">override</tt> rules.</td>
</tr>
<tr><td>pattern</td>
<td>string</td>
<td>The glob-style pattern to match against.  Only
applicable to <tt class="docutils literal">content</tt> rules.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PushCondition</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>kind</td>
<td>string</td>
<td><strong>Required.</strong> The kind of condition to apply. See
<a class="reference external" href="#conditions">conditions</a> for more information
on the allowed kinds and how they work.</td>
</tr>
<tr><td>key</td>
<td>string</td>
<td><p class="first">Required for <tt class="docutils literal">event_match</tt> conditions. The dot-
separated field of the event to match.</p>
<p class="last">Required for <tt class="docutils literal">sender_notification_permission</tt>
conditions. The field in the power level event the
user needs a minimum power level for. Fields must
be specified under the <tt class="docutils literal">notifications</tt> property
in the power level event's <tt class="docutils literal">content</tt>.</p>
</td>
</tr>
<tr><td>pattern</td>
<td>string</td>
<td>Required for <tt class="docutils literal">event_match</tt> conditions. The glob-
style pattern to match against. Patterns with no
special glob characters should be treated as
having asterisks prepended and appended when
testing the condition.</td>
</tr>
<tr><td>is</td>
<td>string</td>
<td>Required for <tt class="docutils literal">room_member_count</tt> conditions. A
decimal integer optionally prefixed by one of, ==,
&lt;, &gt;, &gt;= or &lt;=. A prefix of &lt; matches rooms where
the member count is strictly less than the given
number and so forth. If no prefix is present, this
parameter defaults to ==.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/pushrules/</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>All the push rulesets for this user.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;global&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;alice&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.contains_user_name&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;override&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="literal string double">&quot;dont_notify&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[],</span>
        <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.master&quot;</span>
      <span class="punctuation">},</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="literal string double">&quot;dont_notify&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;content.msgtype&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.notice&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.suppress_notices&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;room&quot;</span><span class="punctuation">:</span> <span class="punctuation">[],</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="punctuation">[],</span>
    <span class="name tag">&quot;underride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ring&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.invite&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.call&quot;</span>
      <span class="punctuation">},</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;contains_display_name&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.contains_display_name&quot;</span>
      <span class="punctuation">},</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;is&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;2&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;room_member_count&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.room_one_to_one&quot;</span>
      <span class="punctuation">},</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;content.membership&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;state_key&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.invite_for_me&quot;</span>
      <span class="punctuation">},</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.member_event&quot;</span>
      <span class="punctuation">},</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.message&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">]</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-pushrules-scope-kind-ruleid"></a></p>
<div class="section" id="get-matrix-client-r0-pushrules-scope-kind-ruleid">
<h5><a class="toc-backref" href="#id540">13.13.1.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></h5>
<p>Retrieve a single specified push rule.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> <tt class="docutils literal">global</tt> to specify global rules.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>PushRule</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>actions</td>
<td>[object or string]</td>
<td><strong>Required.</strong> The actions to perform when this
rule is matched.</td>
</tr>
<tr><td>default</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether this is a default rule, or
has been set explicitly.</td>
</tr>
<tr><td>enabled</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the push rule is enabled or
not.</td>
</tr>
<tr><td>rule_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of this rule.</td>
</tr>
<tr><td>conditions</td>
<td>[PushCondition]</td>
<td>The conditions that must hold true for an event in
order for a rule to be applied to an event. A rule
with no conditions always matches. Only applicable
to <tt class="docutils literal">underride</tt> and <tt class="docutils literal">override</tt> rules.</td>
</tr>
<tr><td>pattern</td>
<td>string</td>
<td>The glob-style pattern to match against.  Only
applicable to <tt class="docutils literal">content</tt> rules.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PushCondition</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>kind</td>
<td>string</td>
<td><strong>Required.</strong> The kind of condition to apply. See
<a class="reference external" href="#conditions">conditions</a> for more information
on the allowed kinds and how they work.</td>
</tr>
<tr><td>key</td>
<td>string</td>
<td><p class="first">Required for <tt class="docutils literal">event_match</tt> conditions. The dot-
separated field of the event to match.</p>
<p class="last">Required for <tt class="docutils literal">sender_notification_permission</tt>
conditions. The field in the power level event the
user needs a minimum power level for. Fields must
be specified under the <tt class="docutils literal">notifications</tt> property
in the power level event's <tt class="docutils literal">content</tt>.</p>
</td>
</tr>
<tr><td>pattern</td>
<td>string</td>
<td>Required for <tt class="docutils literal">event_match</tt> conditions. The glob-
style pattern to match against. Patterns with no
special glob characters should be treated as
having asterisks prepended and appended when
testing the condition.</td>
</tr>
<tr><td>is</td>
<td>string</td>
<td>Required for <tt class="docutils literal">room_member_count</tt> conditions. A
decimal integer optionally prefixed by one of, ==,
&lt;, &gt;, &gt;= or &lt;=. A prefix of &lt; matches rooms where
the member count is strictly less than the given
number and so forth. If no prefix is present, this
parameter defaults to ==.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/pushrules/global/content/nocake</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The specific push rule. This will also include keys specific to the
rule itself such as the rule's <tt class="docutils literal">actions</tt> and <tt class="docutils literal">conditions</tt> if set.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;dont_notify&quot;</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;cake*lie&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;nocake&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
  <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="delete-matrix-client-r0-pushrules-scope-kind-ruleid"></a></p>
<div class="section" id="delete-matrix-client-r0-pushrules-scope-kind-ruleid">
<h5><a class="toc-backref" href="#id541">13.13.1.6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">DELETE <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></h5>
<p>This endpoint removes the push rule defined in the path.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> <tt class="docutils literal">global</tt> to specify global rules.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">DELETE</span> <span class="name namespace">/_matrix/client/r0/pushrules/global/content/nocake</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The push rule was deleted.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-r0-pushrules-scope-kind-ruleid"></a></p>
<div class="section" id="put-matrix-client-r0-pushrules-scope-kind-ruleid">
<h5><a class="toc-backref" href="#id542">13.13.1.6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></h5>
<p>This endpoint allows the creation, modification and deletion of pushers
for this user ID. The behaviour of this endpoint varies depending on the
values in the JSON body.</p>
<p>When creating push rules, they MUST be enabled by default.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> <tt class="docutils literal">global</tt> to specify global rules.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>before</td>
<td>string</td>
<td>Use 'before' with a <tt class="docutils literal">rule_id</tt> as its value to
make the new rule the next-most important rule
with respect to the given user defined rule. It is
not possible to add a rule relative to a
predefined server rule.</td>
</tr>
<tr><td>after</td>
<td>string</td>
<td>This makes the new rule the next-less important
rule relative to the given user defined rule. It
is not possible to add a rule relative to a
predefined server rule.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>actions</td>
<td>[enum]</td>
<td><strong>Required.</strong> The action(s) to perform when the
conditions for this rule are met. One of:
[&quot;notify&quot;, &quot;dont_notify&quot;, &quot;coalesce&quot;, &quot;set_tweak&quot;]</td>
</tr>
<tr><td>conditions</td>
<td>[PushCondition]</td>
<td>The conditions that must hold true for an event in
order for a rule to be applied to an event. A rule
with no conditions always matches. Only applicable
to <tt class="docutils literal">underride</tt> and <tt class="docutils literal">override</tt> rules.</td>
</tr>
<tr><td>pattern</td>
<td>string</td>
<td>Only applicable to <tt class="docutils literal">content</tt> rules. The glob-
style pattern to match against.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PushCondition</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>kind</td>
<td>string</td>
<td><strong>Required.</strong> The kind of condition to apply. See
<a class="reference external" href="#conditions">conditions</a> for more information
on the allowed kinds and how they work.</td>
</tr>
<tr><td>key</td>
<td>string</td>
<td><p class="first">Required for <tt class="docutils literal">event_match</tt> conditions. The dot-
separated field of the event to match.</p>
<p class="last">Required for <tt class="docutils literal">sender_notification_permission</tt>
conditions. The field in the power level event the
user needs a minimum power level for. Fields must
be specified under the <tt class="docutils literal">notifications</tt> property
in the power level event's <tt class="docutils literal">content</tt>.</p>
</td>
</tr>
<tr><td>pattern</td>
<td>string</td>
<td>Required for <tt class="docutils literal">event_match</tt> conditions. The glob-
style pattern to match against. Patterns with no
special glob characters should be treated as
having asterisks prepended and appended when
testing the condition.</td>
</tr>
<tr><td>is</td>
<td>string</td>
<td>Required for <tt class="docutils literal">room_member_count</tt> conditions. A
decimal integer optionally prefixed by one of, ==,
&lt;, &gt;, &gt;= or &lt;=. A prefix of &lt; matches rooms where
the member count is strictly less than the given
number and so forth. If no prefix is present, this
parameter defaults to ==.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/pushrules/global/content/nocake?before=someRuleId&amp;after=anotherRuleId</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;cake*lie&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;notify&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The push rule was created/updated.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>There was a problem configuring this push rule.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;before/after rule not found: someRuleId&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-pushrules-scope-kind-ruleid-enabled"></a></p>
<div class="section" id="get-matrix-client-r0-pushrules-scope-kind-ruleid-enabled">
<h5><a class="toc-backref" href="#id543">13.13.1.6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}/enabled</span></tt></a></h5>
<p>This endpoint gets whether the specified push rule is enabled.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> Either <tt class="docutils literal">global</tt> or
<tt class="docutils literal"><span class="pre">device/&lt;profile_tag&gt;</span></tt> to specify global rules
or device rules for the given <tt class="docutils literal">profile_tag</tt>.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>enabled</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the push rule is enabled or
not.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/pushrules/global/cake/nocake/enabled</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>Whether the push rule is enabled.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-r0-pushrules-scope-kind-ruleid-enabled"></a></p>
<div class="section" id="put-matrix-client-r0-pushrules-scope-kind-ruleid-enabled">
<h5><a class="toc-backref" href="#id544">13.13.1.6.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}/enabled</span></tt></a></h5>
<p>This endpoint allows clients to enable or disable the specified push rule.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> <tt class="docutils literal">global</tt> to specify global rules.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>enabled</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the push rule is enabled or
not.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/pushrules/global/content/nocake/enabled</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The push rule was enabled or disabled.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-pushrules-scope-kind-ruleid-actions"></a></p>
<div class="section" id="get-matrix-client-r0-pushrules-scope-kind-ruleid-actions">
<h5><a class="toc-backref" href="#id545">13.13.1.6.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}/actions</span></tt></a></h5>
<p>This endpoint get the actions for the specified push rule.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> Either <tt class="docutils literal">global</tt> or
<tt class="docutils literal"><span class="pre">device/&lt;profile_tag&gt;</span></tt> to specify global rules
or device rules for the given <tt class="docutils literal">profile_tag</tt>.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>actions</td>
<td>[string]</td>
<td><strong>Required.</strong> The action(s) to perform for this
rule.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/pushrules/global/content/nocake/actions</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The actions for this push rule.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;notify&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-r0-pushrules-scope-kind-ruleid-actions"></a></p>
<div class="section" id="put-matrix-client-r0-pushrules-scope-kind-ruleid-actions">
<h5><a class="toc-backref" href="#id546">13.13.1.6.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/pushrules/{scope}/{kind}/{ruleId}/actions</span></tt></a></h5>
<p>This endpoint allows clients to change the actions of a push rule.
This can be used to change the actions of builtin rules.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> <tt class="docutils literal">global</tt> to specify global rules.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>actions</td>
<td>[enum]</td>
<td><strong>Required.</strong> The action(s) to perform for this
rule. One of: [&quot;notify&quot;, &quot;dont_notify&quot;,
&quot;coalesce&quot;, &quot;set_tweak&quot;]</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/pushrules/global/room/%23spam%3Aexample.com/actions</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;notify&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The actions for the push rule were set.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="push-rules-events"></a></p>
<div class="section" id="push-rules-events">
<h4><a class="toc-backref" href="#id547">13.13.1.7&nbsp;&nbsp;&nbsp;Push Rules: Events</a></h4>
<p>When a user changes their push rules a <tt class="docutils literal">m.push_rules</tt> event is sent to all
clients in the <tt class="docutils literal">account_data</tt> section of their next <tt class="docutils literal">/sync</tt> request. The
content of the event is the current push rules for the user.</p>
<p><a class="anchor" id="m-push-rules"></a></p>
<div class="section" id="m-push-rules">
<h5><a class="toc-backref" href="#id548">13.13.1.7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.push_rules</tt></a></h5>
<p>Describes all push rules for this user.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>global</td>
<td>Ruleset</td>
<td>The global ruleset</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Ruleset</caption>
<thead valign="bottom">
<tr><th class="head">Ruleset Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>override</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>room</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>sender</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>underride</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PushRule</caption>
<thead valign="bottom">
<tr><th class="head">PushRule Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>actions</td>
<td>[object or string]</td>
<td><strong>Required.</strong> The actions to perform when this
rule is matched.</td>
</tr>
<tr><td>default</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether this is a default rule, or
has been set explicitly.</td>
</tr>
<tr><td>enabled</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the push rule is enabled or
not.</td>
</tr>
<tr><td>rule_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of this rule.</td>
</tr>
<tr><td>conditions</td>
<td>[PushCondition]</td>
<td>The conditions that must hold true for an event in
order for a rule to be applied to an event. A rule
with no conditions always matches. Only applicable
to <tt class="docutils literal">underride</tt> and <tt class="docutils literal">override</tt> rules.</td>
</tr>
<tr><td>pattern</td>
<td>string</td>
<td>The glob-style pattern to match against.  Only
applicable to <tt class="docutils literal">content</tt> rules.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PushCondition</caption>
<thead valign="bottom">
<tr><th class="head">PushCondition Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>kind</td>
<td>string</td>
<td><strong>Required.</strong> The kind of condition to apply. See
<a class="reference external" href="#conditions">conditions</a> for more information
on the allowed kinds and how they work.</td>
</tr>
<tr><td>key</td>
<td>string</td>
<td><p class="first">Required for <tt class="docutils literal">event_match</tt> conditions. The dot-
separated field of the event to match.</p>
<p class="last">Required for <tt class="docutils literal">sender_notification_permission</tt>
conditions. The field in the power level event the
user needs a minimum power level for. Fields must
be specified under the <tt class="docutils literal">notifications</tt> property
in the power level event's <tt class="docutils literal">content</tt>.</p>
</td>
</tr>
<tr><td>pattern</td>
<td>string</td>
<td>Required for <tt class="docutils literal">event_match</tt> conditions. The glob-
style pattern to match against. Patterns with no
special glob characters should be treated as
having asterisks prepended and appended when
testing the condition.</td>
</tr>
<tr><td>is</td>
<td>string</td>
<td>Required for <tt class="docutils literal">room_member_count</tt> conditions. A
decimal integer optionally prefixed by one of, ==,
&lt;, &gt;, &gt;= or &lt;=. A prefix of &lt; matches rooms where
the member count is strictly less than the given
number and so forth. If no prefix is present, this
parameter defaults to ==.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;global&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
                        <span class="punctuation">},</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;alice&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.contains_user_name&quot;</span>
                <span class="punctuation">}</span>
            <span class="punctuation">],</span>
            <span class="name tag">&quot;override&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="literal string double">&quot;dont_notify&quot;</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[],</span>
                    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.master&quot;</span>
                <span class="punctuation">},</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="literal string double">&quot;dont_notify&quot;</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;content.msgtype&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.notice&quot;</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.suppress_notices&quot;</span>
                <span class="punctuation">}</span>
            <span class="punctuation">],</span>
            <span class="name tag">&quot;room&quot;</span><span class="punctuation">:</span> <span class="punctuation">[],</span>
            <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="punctuation">[],</span>
            <span class="name tag">&quot;underride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ring&quot;</span>
                        <span class="punctuation">},</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.invite&quot;</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.call&quot;</span>
                <span class="punctuation">},</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
                        <span class="punctuation">},</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;contains_display_name&quot;</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.contains_display_name&quot;</span>
                <span class="punctuation">},</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
                        <span class="punctuation">},</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;is&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;2&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;room_member_count&quot;</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.room_one_to_one&quot;</span>
                <span class="punctuation">},</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
                        <span class="punctuation">},</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span>
                        <span class="punctuation">},</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;content.membership&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span>
                        <span class="punctuation">},</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;state_key&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.invite_for_me&quot;</span>
                <span class="punctuation">},</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.member_event&quot;</span>
                <span class="punctuation">},</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                        <span class="punctuation">{</span>
                            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span>
                        <span class="punctuation">}</span>
                    <span class="punctuation">],</span>
                    <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.message&quot;</span>
                <span class="punctuation">}</span>
            <span class="punctuation">]</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.push_rules&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="examples"></a></p>
<div class="section" id="examples">
<h5><a class="toc-backref" href="#id549">13.13.1.7.2&nbsp;&nbsp;&nbsp;Examples</a></h5>
<p>To create a rule that suppresses notifications for the room with ID
<tt class="docutils literal">!dj234r78wl45Gh4D:matrix.org</tt>:</p>
<pre class="literal-block">
curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/r0/pushrules/global/room/%21dj234r78wl45Gh4D%3Amatrix.org?access_token=123456&quot; -d \
'{
   &quot;actions&quot; : [&quot;dont_notify&quot;]
 }'
</pre>
<p>To suppress notifications for the user <tt class="docutils literal">&#64;spambot:matrix.org</tt>:</p>
<pre class="literal-block">
curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/r0/pushrules/global/sender/%40spambot%3Amatrix.org?access_token=123456&quot; -d \
'{
   &quot;actions&quot; : [&quot;dont_notify&quot;]
 }'
</pre>
<p>To always notify for messages that contain the work 'cake' and set a specific
sound (with a rule_id of <tt class="docutils literal">SSByZWFsbHkgbGlrZSBjYWtl</tt>):</p>
<pre class="literal-block">
curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/r0/pushrules/global/content/SSByZWFsbHkgbGlrZSBjYWtl?access_token=123456&quot; -d \
'{
   &quot;pattern&quot;: &quot;cake&quot;,
   &quot;actions&quot; : [&quot;notify&quot;, {&quot;set_sound&quot;:&quot;cakealarm.wav&quot;}]
 }'
</pre>
<p>To add a rule suppressing notifications for messages starting with 'cake' but
ending with 'lie', superseding the previous rule:</p>
<pre class="literal-block">
curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/r0/pushrules/global/content/U3BvbmdlIGNha2UgaXMgYmVzdA?access_token=123456&amp;before=SSByZWFsbHkgbGlrZSBjYWtl&quot; -d \
'{
   &quot;pattern&quot;: &quot;cake*lie&quot;,
   &quot;actions&quot; : [&quot;notify&quot;]
 }'
</pre>
<p>To add a custom sound for notifications messages containing the word 'beer' in
any rooms with 10 members or fewer (with greater importance than the room,
sender and content rules):</p>
<pre class="literal-block">
curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/r0/pushrules/global/override/U2VlIHlvdSBpbiBUaGUgRHVrZQ?access_token=123456&quot; -d \
'{
   &quot;conditions&quot;: [
     {&quot;kind&quot;: &quot;event_match&quot;, &quot;key&quot;: &quot;content.body&quot;, &quot;pattern&quot;: &quot;beer&quot; },
     {&quot;kind&quot;: &quot;room_member_count&quot;, &quot;is&quot;: &quot;&lt;=10&quot;}
   ],
   &quot;actions&quot; : [
     &quot;notify&quot;,
     {&quot;set_sound&quot;:&quot;beeroclock.wav&quot;}
   ]
 }'
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="id141"></a></p>
<div class="section" id="id141">
<h3><a class="toc-backref" href="#id550">13.13.2&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
</div>
<p><a class="anchor" id="push-gateway-behaviour"></a></p>
<div class="section" id="push-gateway-behaviour">
<h3><a class="toc-backref" href="#id551">13.13.3&nbsp;&nbsp;&nbsp;Push Gateway behaviour</a></h3>
<p><a class="anchor" id="recommendations-for-apns"></a></p>
<div class="section" id="recommendations-for-apns">
<h4><a class="toc-backref" href="#id552">13.13.3.1&nbsp;&nbsp;&nbsp;Recommendations for APNS</a></h4>
<p>The exact format for sending APNS notifications is flexible and up to the
client app and its' push gateway to agree on. As APNS requires that the sender
has a private key owned by the app developer, each app must have its own push
gateway. It is recommended that:</p>
<ul class="simple">
<li>The APNS token be base64 encoded and used as the pushkey.</li>
<li>A different app_id be used for apps on the production and sandbox
APS environments.</li>
<li>APNS push gateways do not attempt to wait for errors from the APNS
gateway before returning and instead to store failures and return
'rejected' responses next time that pushkey is used.</li>
</ul>
</div>
</div>
<p><a class="anchor" id="id142"></a></p>
<div class="section" id="id142">
<h3><a class="toc-backref" href="#id553">13.13.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Clients specify the Push Gateway URL to use to send event notifications to. This
URL should be over HTTPS and <em>never</em> over HTTP.</p>
<p>As push notifications will pass through a Push Provider, message content
shouldn't be sent in the push itself where possible. Instead, Push Gateways
should send a &quot;sync&quot; command to instruct the client to get new events from the
homeserver directly.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="third-party-invites"></a></p>
<div class="section" id="third-party-invites">
<h2><a class="toc-backref" href="#id554">13.14&nbsp;&nbsp;&nbsp;Third party invites</a></h2>
<p id="module-third-party-invites">This module adds in support for inviting new members to a room where their
Matrix user ID is not known, instead addressing them by a third party identifier
such as an email address.
There are two flows here; one if a Matrix user ID is known for the third party
identifier, and one if not. Either way, the client calls <tt class="docutils literal">/invite</tt> with the
details of the third party identifier.</p>
<p>The homeserver asks the identity server whether a Matrix user ID is known for
that identifier:</p>
<ul class="simple">
<li>If it is, an invite is simply issued for that user.</li>
<li>If it is not, the homeserver asks the identity server to record the details of
the invitation, and to notify the invitee's homeserver of this pending invitation if it gets
a binding for this identifier in the future. The identity server returns a token
and public key to the inviting homeserver.</li>
</ul>
<p>When the invitee's homeserver receives the notification of the binding, it
should insert an <tt class="docutils literal">m.room.member</tt> event into the room's graph for that user,
with <tt class="docutils literal">content.membership</tt> = <tt class="docutils literal">invite</tt>, as well as a
<tt class="docutils literal">content.third_party_invite</tt> property which contains proof that the invitee
does indeed own that third party identifier. See the <a class="reference external" href="#m-room-member">m.room.member</a>
schema for more information.</p>
<p><a class="anchor" id="id144"></a></p>
<div class="section" id="id144">
<h3><a class="toc-backref" href="#id555">13.14.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-room-third-party-invite"></a></p>
<div class="section" id="m-room-third-party-invite">
<h4><a class="toc-backref" href="#id556">13.14.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.third_party_invite</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: The token, of which a signature must be produced in order to join the room.</dd>
</dl>
<p>Acts as an <tt class="docutils literal">m.room.member</tt> invite event, where there isn't a target user_id to invite. This event contains a token and a public key whose private key must be used to sign the token. Any user who can present that signature may use this invitation to join the target room.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>display_name</td>
<td>string</td>
<td><strong>Required.</strong> A user-readable string which
represents the user who has been invited. This
should not contain the user's third party ID, as
otherwise when the invite is accepted it would
leak the association between the matrix ID and the
third party ID.</td>
</tr>
<tr><td>key_validity_url</td>
<td>string</td>
<td><strong>Required.</strong> A URL which can be fetched, with
querystring public_key=public_key, to validate
whether the key has been revoked. The URL must
return a JSON object containing a boolean property
named 'valid'.</td>
</tr>
<tr><td>public_key</td>
<td>string</td>
<td><strong>Required.</strong> A base64-encoded ed25519 key with
which token must be signed (though a signature
from any entry in public_keys is also sufficient).
This exists for backwards compatibility.</td>
</tr>
<tr><td>public_keys</td>
<td>[PublicKeys]</td>
<td>Keys with which the token may be signed.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>PublicKeys</caption>
<thead valign="bottom">
<tr><th class="head">PublicKeys Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>key_validity_url</td>
<td>string</td>
<td>An optional URL which can be fetched, with
querystring public_key=public_key, to validate
whether the key has been revoked. The URL must
return a JSON object containing a boolean property
named 'valid'. If this URL is absent, the key must
be considered valid indefinitely.</td>
</tr>
<tr><td>public_key</td>
<td>string</td>
<td><strong>Required.</strong> A base-64 encoded ed25519 key with
which token may be signed.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;key_validity_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://magic.forest/verifykey&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;public_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;public_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
                <span class="name tag">&quot;key_validity_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://magic.forest/verifykey&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;public_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;def456&quot;</span>
            <span class="punctuation">}</span>
        <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;pc98&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.third_party_invite&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id145"></a></p>
<div class="section" id="id145">
<h3><a class="toc-backref" href="#id557">13.14.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>A client asks a server to invite a user by their third party identifier.</p>
<p><a class="anchor" id="id146"></a></p>
<div class="section" id="id146">
<h4><a class="toc-backref" href="#id558">13.14.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/invite</span></tt></a></h4>
<p id="invite-by-third-party-id-endpoint"><em>Note that there are two forms of this API, which are documented separately.
This version of the API does not require that the inviter know the Matrix
identifier of the invitee, and instead relies on third party identifiers.
The homeserver uses an identity server to perform the mapping from
third party identifier to a Matrix identifier. The other is documented in the</em>
<a class="reference internal" href="#invite-by-user-id-endpoint">joining rooms section</a>.</p>
<p>This API invites a user to participate in a particular room.
They do not start participating in the room until they actually join the
room.</p>
<p>Only users currently in a particular room can invite other users to
join that room.</p>
<p>If the identity server did know the Matrix user identifier for the
third party identifier, the homeserver will append a <tt class="docutils literal">m.room.member</tt>
event to the room.</p>
<p>If the identity server does not know a Matrix user identifier for the
passed third party identifier, the homeserver will issue an invitation
which can be accepted upon providing proof of ownership of the third
party identifier. This is achieved by the identity server generating a
token, which it gives to the inviting homeserver. The homeserver will
add an <tt class="docutils literal">m.room.third_party_invite</tt> event into the graph for the room,
containing that token.</p>
<p>When the invitee binds the invited third party identifier to a Matrix
user ID, the identity server will give the user a list of pending
invitations, each containing:</p>
<ul class="simple">
<li>The room ID to which they were invited</li>
<li>The token given to the homeserver</li>
<li>A signature of the token, signed with the identity server's private key</li>
<li>The matrix user ID who invited them to the room</li>
</ul>
<p>If a token is requested from the identity server, the homeserver will
append a <tt class="docutils literal">m.room.third_party_invite</tt> event to the room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier (not alias) to
which to invite the user.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td><strong>Required.</strong> The hostname+port of the identity
server which should be used for third party
identifier lookups.</td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The kind of address being passed in
the address field, for example <tt class="docutils literal">email</tt>.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The invitee's third party
identifier.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21d41d8cd%3Amatrix.org/invite</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;id_server&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;cheeky&#64;monkey.com&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The user has been invited to join the room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You do not have permission to invite the user to the room. A meaningful <tt class="docutils literal">errcode</tt> and description error text will be returned. Example reasons for rejections are:</p>
<ul class="simple">
<li>The invitee has been banned from the room.</li>
<li>The invitee is already a member of the room.</li>
<li>The inviter is not currently in the room.</li>
<li>The inviter's power level is insufficient to invite users to the room.</li>
</ul>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org is banned from the room&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id147"></a></p>
<div class="section" id="id147">
<h3><a class="toc-backref" href="#id559">13.14.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Upon receipt of an <tt class="docutils literal">/invite</tt>, the server is expected to look up the third party
identifier with the provided identity server. If the lookup yields a result for
a Matrix User ID then the normal invite process can be initiated. This process
ends up looking like this:</p>
<pre class="literal-block">
+---------+                         +-------------+                                    +-----------------+
| Client  |                         | Homeserver  |                                    | IdentityServer  |
+---------+                         +-------------+                                    +-----------------+
    |                                     |                                                    |
    | POST /invite                        |                                                    |
    |------------------------------------&gt;|                                                    |
    |                                     |                                                    |
    |                                     | GET /lookup                                        |
    |                                     |---------------------------------------------------&gt;|
    |                                     |                                                    |
    |                                     |                                     User ID result |
    |                                     |&lt;---------------------------------------------------|
    |                                     |                                                    |
    |                                     | Invite process for the discovered User ID          |
    |                                     |------------------------------------------          |
    |                                     |                                         |          |
    |                                     |&lt;-----------------------------------------          |
    |                                     |                                                    |
    |        Complete the /invite request |                                                    |
    |&lt;------------------------------------|                                                    |
    |                                     |                                                    |
</pre>
<p>However, if the lookup does not yield a bound User ID, the homeserver must store
the invite on the identity server and emit a valid <tt class="docutils literal">m.room.third_party_invite</tt>
event to the room. This process ends up looking like this:</p>
<pre class="literal-block">
+---------+                         +-------------+                                               +-----------------+
| Client  |                         | Homeserver  |                                               | IdentityServer  |
+---------+                         +-------------+                                               +-----------------+
    |                                     |                                                               |
    | POST /invite                        |                                                               |
    |------------------------------------&gt;|                                                               |
    |                                     |                                                               |
    |                                     | GET /lookup                                                   |
    |                                     |--------------------------------------------------------------&gt;|
    |                                     |                                                               |
    |                                     |                                             &quot;no users&quot; result |
    |                                     |&lt;--------------------------------------------------------------|
    |                                     |                                                               |
    |                                     | POST /store-invite                                            |
    |                                     |--------------------------------------------------------------&gt;|
    |                                     |                                                               |
    |                                     |          Information needed for the m.room.third_party_invite |
    |                                     |&lt;--------------------------------------------------------------|
    |                                     |                                                               |
    |                                     | Emit m.room.third_party_invite to the room                    |
    |                                     |-------------------------------------------                    |
    |                                     |                                          |                    |
    |                                     |&lt;------------------------------------------                    |
    |                                     |                                                               |
    |        Complete the /invite request |                                                               |
    |&lt;------------------------------------|                                                               |
    |                                     |                                                               |
</pre>
<p>All homeservers MUST verify the signature in the event's
<tt class="docutils literal">content.third_party_invite.signed</tt> object.</p>
<p>The third party user will then need to verify their identity, which results in
a call from the identity server to the homeserver that bound the third party
identifier to a user. The homeserver then exchanges the <tt class="docutils literal">m.room.third_party_invite</tt>
event in the room for a complete <tt class="docutils literal">m.room.member</tt> event for <tt class="docutils literal">membership: invite</tt>
for the user that has bound the third party identifier.</p>
<p>If a homeserver is joining a room for the first time because of an
<tt class="docutils literal">m.room.third_party_invite</tt>, the server which is already participating in the
room (which is chosen as per the standard server-server specification) MUST
validate that the public key used for signing is still valid, by checking
<tt class="docutils literal">key_validity_url</tt> in the above described way.</p>
<p>No other homeservers may reject the joining of the room on the basis of
<tt class="docutils literal">key_validity_url</tt>, this is so that all homeservers have a consistent view of
the room. They may, however, indicate to their clients that a member's
membership is questionable.</p>
<p>For example, given H1, H2, and H3 as homeservers, UserA as a user of H1, and an
identity server IS, the full sequence for a third party invite would look like
the following. This diagram assumes H1 and H2 are residents of the room while
H3 is attempting to join.</p>
<pre class="literal-block">
+-------+ +-----------------+         +-----+                                          +-----+           +-----+                      +-----+
| UserA | | ThirdPartyUser  |         | H1  |                                          | H2  |           | H3  |                      | IS  |
+-------+ +-----------------+         +-----+                                          +-----+           +-----+                      +-----+
    |              |                     |                                                |                 |                            |
    | POST /invite for ThirdPartyUser    |                                                |                 |                            |
    |-----------------------------------&gt;|                                                |                 |                            |
    |              |                     |                                                |                 |                            |
    |              |                     | GET /lookup                                    |                 |                            |
    |              |                     |----------------------------------------------------------------------------------------------&gt;|
    |              |                     |                                                |                 |                            |
    |              |                     |                                                |                Lookup results (empty object) |
    |              |                     |&lt;----------------------------------------------------------------------------------------------|
    |              |                     |                                                |                 |                            |
    |              |                     | POST /store-invite                             |                 |                            |
    |              |                     |----------------------------------------------------------------------------------------------&gt;|
    |              |                     |                                                |                 |                            |
    |              |                     |                                                |      Token, keys, etc for third party invite |
    |              |                     |&lt;----------------------------------------------------------------------------------------------|
    |              |                     |                                                |                 |                            |
    |              |                     | (Federation) Emit m.room.third_party_invite    |                 |                            |
    |              |                     |-----------------------------------------------&gt;|                 |                            |
    |              |                     |                                                |                 |                            |
    |           Complete /invite request |                                                |                 |                            |
    |&lt;-----------------------------------|                                                |                 |                            |
    |              |                     |                                                |                 |                            |
    |              | Verify identity     |                                                |                 |                            |
    |              |--------------------------------------------------------------------------------------------------------------------&gt;|
    |              |                     |                                                |                 |                            |
    |              |                     |                                                |                 |          POST /3pid/onbind |
    |              |                     |                                                |                 |&lt;---------------------------|
    |              |                     |                                                |                 |                            |
    |              |                     |                         PUT /exchange_third_party_invite/:roomId |                            |
    |              |                     |&lt;-----------------------------------------------------------------|                            |
    |              |                     |                                                |                 |                            |
    |              |                     | Verify the request                             |                 |                            |
    |              |                     |-------------------                             |                 |                            |
    |              |                     |                  |                             |                 |                            |
    |              |                     |&lt;------------------                             |                 |                            |
    |              |                     |                                                |                 |                            |
    |              |                     | (Federation) Emit m.room.member for invite     |                 |                            |
    |              |                     |-----------------------------------------------&gt;|                 |                            |
    |              |                     |                                                |                 |                            |
    |              |                     |                                                |                 |                            |
    |              |                     | (Federation) Emit the m.room.member event sent to H2             |                            |
    |              |                     |-----------------------------------------------------------------&gt;|                            |
    |              |                     |                                                |                 |                            |
    |              |                     | Complete /exchange_third_party_invite/:roomId request            |                            |
    |              |                     |-----------------------------------------------------------------&gt;|                            |
    |              |                     |                                                |                 |                            |
    |              |                     |                                                |                 | Participate in the room    |
    |              |                     |                                                |                 |------------------------    |
    |              |                     |                                                |                 |                       |    |
    |              |                     |                                                |                 |&lt;-----------------------    |
    |              |                     |                                                |                 |                            |
</pre>
<p>Note that when H1 sends the <tt class="docutils literal">m.room.member</tt> event to H2 and H3 it does not
have to block on either server's receipt of the event. Likewise, H1 may complete
the <tt class="docutils literal"><span class="pre">/exchange_third_party_invite/:roomId</span></tt> request at the same time as sending
the <tt class="docutils literal">m.room.member</tt> event to H2 and H3. Additionally, H3 may complete the
<tt class="docutils literal">/3pid/onbind</tt> request it got from IS at any time - the completion is not shown
in the diagram.</p>
<p>H1 MUST verify the request from H3 to ensure the <tt class="docutils literal">signed</tt> property is correct
as well as the <tt class="docutils literal">key_validity_url</tt> as still being valid. This is done by making
a request to the <a class="reference external" href="../identity_service/r0.2.0.html#get-matrix-identity-api-v1-pubkey-isvalid">identity server /isvalid</a> endpoint, using the provided URL
rather than constructing a new one. The query string and response for the provided
URL must match the Identity Service Specification.</p>
<p>The reason that no other homeserver may reject the event based on checking
<tt class="docutils literal">key_validity_url</tt> is that we must ensure event acceptance is deterministic.
If some other participating server doesn't have a network path to the keyserver,
or if the keyserver were to go offline, or revoke its keys, that other server
would reject the event and cause the participating servers' graphs to diverge.
This relies on participating servers trusting each other, but that trust is
already implied by the server-server protocol. Also, the public key signature
verification must still be performed, so the attack surface here is minimized.</p>
</div>
<p><a class="anchor" id="id148"></a></p>
<div class="section" id="id148">
<h3><a class="toc-backref" href="#id560">13.14.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>There are a number of privacy and trust implications to this module.</p>
<p>It is important for user privacy that leaking the mapping between a matrix user
ID and a third party identifier is hard. In particular, being able to look up
all third party identifiers from a matrix user ID (and accordingly, being able
to link each third party identifier) should be avoided wherever possible.
To this end, the third party identifier is not put in any event, rather an
opaque display name provided by the identity server is put into the events.
Clients should not remember or display third party identifiers from invites,
other than for the use of the inviter themself.</p>
<p>Homeservers are not required to trust any particular identity server(s). It is
generally a client's responsibility to decide which identity servers it trusts,
not a homeserver's. Accordingly, this API takes identity servers as input from
end users, and doesn't have any specific trusted set. It is possible some
homeservers may want to supply defaults, or reject some identity servers for
<em>its</em> users, but no homeserver is allowed to dictate which identity servers
<em>other</em> homeservers' users trust.</p>
<p>There is some risk of denial of service attacks by flooding homeservers or
identity servers with many requests, or much state to store. Defending against
these is left to the implementer's discretion.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id149"></a></p>
<div class="section" id="id149">
<h2><a class="toc-backref" href="#id561">13.15&nbsp;&nbsp;&nbsp;Server Side Search</a></h2>
<p id="module-search">The search API allows clients to perform full text search across events in all
rooms that the user has been in, including those that they have left. Only
events that the user is allowed to see will be searched, e.g. it won't include
events in rooms that happened after you left.</p>
<p><a class="anchor" id="id150"></a></p>
<div class="section" id="id150">
<h3><a class="toc-backref" href="#id562">13.15.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>There is a single HTTP API for performing server-side search, documented below.</p>
<p><a class="anchor" id="post-matrix-client-r0-search"></a></p>
<div class="section" id="post-matrix-client-r0-search">
<h4><a class="toc-backref" href="#id563">13.15.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/r0/search</tt></a></h4>
<p>Performs a full text search across different categories.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>next_batch</td>
<td>string</td>
<td>The point to return events from. If given, this
should be a <tt class="docutils literal">next_batch</tt> result from a previous
call to this endpoint.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>search_categories</td>
<td>Categories</td>
<td><strong>Required.</strong> Describes which categories to search
in and their criteria.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Categories</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_events</td>
<td>Room Events Criteria</td>
<td>Mapping of category name to search criteria.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Room Events Criteria</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>search_term</td>
<td>string</td>
<td><strong>Required.</strong> The string to search events for</td>
</tr>
<tr><td>keys</td>
<td>[enum]</td>
<td>The keys to search. Defaults to all. One of:
[&quot;content.body&quot;, &quot;content.name&quot;, &quot;content.topic&quot;]</td>
</tr>
<tr><td>filter</td>
<td>Filter</td>
<td>This takes a <a class="reference internal" href="#filter">filter</a>.</td>
</tr>
<tr><td>order_by</td>
<td>enum</td>
<td>The order in which to search for results. By
default, this is <tt class="docutils literal">&quot;rank&quot;</tt>. One of: [&quot;recent&quot;,
&quot;rank&quot;]</td>
</tr>
<tr><td>event_context</td>
<td>Include Event Context</td>
<td>Configures whether any context for the events
returned are included in the response.</td>
</tr>
<tr><td>include_state</td>
<td>boolean</td>
<td>Requests the server return the current state for
each room returned.</td>
</tr>
<tr><td>groupings</td>
<td>Groupings</td>
<td>Requests that the server partitions the result set
based on the provided list of keys.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Filter</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to return.</td>
</tr>
<tr><td>not_senders</td>
<td>[string]</td>
<td>A list of sender IDs to exclude. If this list is
absent then no senders are excluded. A matching
sender will be excluded even if it is listed in
the <tt class="docutils literal">'senders'</tt> filter.</td>
</tr>
<tr><td>not_types</td>
<td>[string]</td>
<td>A list of event types to exclude. If this list is
absent then no event types are excluded. A
matching type will be excluded even if it is
listed in the <tt class="docutils literal">'types'</tt> filter. A '*' can be
used as a wildcard to match any sequence of
characters.</td>
</tr>
<tr><td>senders</td>
<td>[string]</td>
<td>A list of senders IDs to include. If this list is
absent then all senders are included.</td>
</tr>
<tr><td>types</td>
<td>[string]</td>
<td>A list of event types to include. If this list is
absent then all event types are included. A
<tt class="docutils literal">'*'</tt> can be used as a wildcard to match any
sequence of characters.</td>
</tr>
<tr><td>lazy_load_members</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, enables lazy-loading of membership
events. See <a class="reference external" href="#lazy-loading-room-members">Lazy-loading room members</a> for more information.
Defaults to <tt class="docutils literal">false</tt>.</td>
</tr>
<tr><td>include_redundant_members</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, sends all membership events for all
events, even if they have already been sent to the
client. Does not apply unless
<tt class="docutils literal">lazy_load_members</tt> is <tt class="docutils literal">true</tt>. See <a class="reference external" href="#lazy-loading-room-members">Lazy-
loading room members</a> for more information. Defaults to
<tt class="docutils literal">false</tt>.</td>
</tr>
<tr><td>not_rooms</td>
<td>[string]</td>
<td>A list of room IDs to exclude. If this list is
absent then no rooms are excluded. A matching room
will be excluded even if it is listed in the
<tt class="docutils literal">'rooms'</tt> filter.</td>
</tr>
<tr><td>rooms</td>
<td>[string]</td>
<td>A list of room IDs to include. If this list is
absent then all rooms are included.</td>
</tr>
<tr><td>contains_url</td>
<td>boolean</td>
<td>If <tt class="docutils literal">true</tt>, includes only events with a <tt class="docutils literal">url</tt>
key in their content. If <tt class="docutils literal">false</tt>, excludes those
events. If omitted, <tt class="docutils literal">url</tt> key is not considered
for filtering.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Include Event Context</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>before_limit</td>
<td>integer</td>
<td>How many events before the result are returned. By
default, this is <tt class="docutils literal">5</tt>.</td>
</tr>
<tr><td>after_limit</td>
<td>integer</td>
<td>How many events after the result are returned. By
default, this is <tt class="docutils literal">5</tt>.</td>
</tr>
<tr><td>include_profile</td>
<td>boolean</td>
<td>Requests that the server returns the historic
profile information for the users that sent the
events that were returned. By default, this is
<tt class="docutils literal">false</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Groupings</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>group_by</td>
<td>[Group]</td>
<td>List of groups to request.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Group</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>key</td>
<td>enum</td>
<td>Key that defines the group. One of: [&quot;room_id&quot;,
&quot;sender&quot;]</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Results</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>search_categories</td>
<td>Result Categories</td>
<td><strong>Required.</strong> Describes which categories to search
in and their criteria.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Result Categories</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_events</td>
<td>Result Room Events</td>
<td>Mapping of category name to search criteria.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Result Room Events</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>count</td>
<td>integer</td>
<td>An approximate count of the total number of
results found.</td>
</tr>
<tr><td>highlights</td>
<td>[string]</td>
<td>List of words which should be highlighted, useful
for stemming which may change the query terms.</td>
</tr>
<tr><td>results</td>
<td>[Result]</td>
<td>List of results in the requested order.</td>
</tr>
<tr><td>state</td>
<td>{string: [State Event]}</td>
<td><p class="first">The current state for every room in the results.
This is included if the request had the
<tt class="docutils literal">include_state</tt> key set with a value of
<tt class="docutils literal">true</tt>.</p>
<p class="last">The <tt class="docutils literal">string</tt> key is the room ID for which the
<tt class="docutils literal">State Event</tt> array belongs to.</p>
</td>
</tr>
<tr><td>groups</td>
<td>{string: {string: Group Value}}</td>
<td><p class="first">Any groups that were requested.</p>
<p class="last">The outer <tt class="docutils literal">string</tt> key is the group key
requested (eg: <tt class="docutils literal">room_id</tt> or <tt class="docutils literal">sender</tt>). The
inner <tt class="docutils literal">string</tt> key is the grouped value (eg: a
room's ID or a user's ID).</p>
</td>
</tr>
<tr><td>next_batch</td>
<td>string</td>
<td>Token that can be used to get the next batch of
results, by passing as the <cite>next_batch</cite> parameter
to the next call. If this field is absent, there
are no more results.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Result</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>rank</td>
<td>number</td>
<td>A number that describes how closely this result
matches the search. Higher is closer.</td>
</tr>
<tr><td>result</td>
<td>Event</td>
<td>The event that matched.</td>
</tr>
<tr><td>context</td>
<td>Event Context</td>
<td>Context for result, if requested.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event Context</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>start</td>
<td>string</td>
<td>Pagination token for the start of the chunk</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>Pagination token for the end of the chunk</td>
</tr>
<tr><td>profile_info</td>
<td>{string: User Profile}</td>
<td><p class="first">The historic profile information of the users that
sent the events returned.</p>
<p class="last">The <tt class="docutils literal">string</tt> key is the user ID for which the
profile belongs to.</p>
</td>
</tr>
<tr><td>events_before</td>
<td>[Event]</td>
<td>Events just before the result.</td>
</tr>
<tr><td>events_after</td>
<td>[Event]</td>
<td>Events just after the result.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>User Profile</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>displayname</td>
<td>string</td>
<td>&nbsp;</td>
</tr>
<tr><td>avatar_url</td>
<td>string</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>State Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> A unique key which defines the
overwriting semantics for this piece of room
state. This value is often a zero-length string.
The presence of this key makes this event a State
Event. State keys starting with an <tt class="docutils literal">&#64;</tt> are
reserved for referencing user IDs, such as room
members. With the exception of a few events, state
events set with a given user's ID as the state key
MUST only be set by that user.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Group Value</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>next_batch</td>
<td>string</td>
<td>Token that can be used to get the next batch of
results in the group, by passing as the
<cite>next_batch</cite> parameter to the next call. If this
field is absent, there are no more results in this
group.</td>
</tr>
<tr><td>order</td>
<td>integer</td>
<td>Key that can be used to order different groups.</td>
</tr>
<tr><td>results</td>
<td>[string]</td>
<td>Which results are in this group.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/search?next_batch=YWxsCgpOb25lLDM1ODcwOA</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;search_categories&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;room_events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;content.body&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;search_term&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;martians and men&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;order_by&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;recent&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;groupings&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;group_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;room_id&quot;</span>
          <span class="punctuation">}</span>
        <span class="punctuation">]</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>Results of the search.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;search_categories&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;room_events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;groups&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;!qPewotXpIctQySfjSy:localhost&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;order&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span><span class="punctuation">,</span>
            <span class="name tag">&quot;next_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;BdgFsdfHSf-dsFD&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;results&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
              <span class="literal string double">&quot;$144429830826TWwbB:localhost&quot;</span>
            <span class="punctuation">]</span>
          <span class="punctuation">}</span>
        <span class="punctuation">}</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;highlights&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;martians&quot;</span><span class="punctuation">,</span>
        <span class="literal string double">&quot;men&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;next_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;5FdgFsd234dfgsdfFD&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;count&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1224</span><span class="punctuation">,</span>
      <span class="name tag">&quot;results&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
          <span class="name tag">&quot;rank&quot;</span><span class="punctuation">:</span> <span class="literal number float">0.00424866</span><span class="punctuation">,</span>
          <span class="name tag">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$144429830826TWwbB:localhost&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!qPewotXpIctQySfjSy:localhost&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
            <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
            <span class="punctuation">}</span>
          <span class="punctuation">}</span>
        <span class="punctuation">}</span>
      <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>Part of the request was invalid.</p>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="search-categories"></a></p>
<div class="section" id="search-categories">
<h3><a class="toc-backref" href="#id564">13.15.2&nbsp;&nbsp;&nbsp;Search Categories</a></h3>
<p>The search API allows clients to search in different categories of items.
Currently the only specified category is <tt class="docutils literal">room_events</tt>.</p>
<p><a class="anchor" id="id153"></a></p>
<div class="section" id="id153">
<h4><a class="toc-backref" href="#id565">13.15.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">room_events</tt></a></h4>
<p>This category covers all events that the user is allowed to see, including
events in rooms that they have left. The search is performed on certain keys of
certain event types.</p>
<p>The supported keys to search over are:</p>
<ul class="simple">
<li><tt class="docutils literal">content.body</tt> in <tt class="docutils literal">m.room.message</tt></li>
<li><tt class="docutils literal">content.name</tt> in <tt class="docutils literal">m.room.name</tt></li>
<li><tt class="docutils literal">content.topic</tt> in <tt class="docutils literal">m.room.topic</tt></li>
</ul>
<p>The search will <em>not</em> include rooms that are end to end encrypted.</p>
<p>The results include a <tt class="docutils literal">rank</tt> key that can be used to sort the results by
relevancy. The higher the <tt class="docutils literal">rank</tt> the more relevant the result is.</p>
<p>The value of <tt class="docutils literal">count</tt> gives an approximation of the total number of
results. Homeservers may give an estimate rather than an exact value for this
field.</p>
</div>
</div>
<p><a class="anchor" id="ordering"></a></p>
<div class="section" id="ordering">
<h3><a class="toc-backref" href="#id566">13.15.3&nbsp;&nbsp;&nbsp;Ordering</a></h3>
<p>The client can specify the ordering that the server returns results in. The two
allowed orderings are:</p>
<ul class="simple">
<li><tt class="docutils literal">rank</tt>, which returns the most relevant results first.</li>
<li><tt class="docutils literal">recent</tt>, which returns the most recent results first.</li>
</ul>
<p>The default ordering is <tt class="docutils literal">rank</tt>.</p>
</div>
<p><a class="anchor" id="groups"></a></p>
<div class="section" id="groups">
<h3><a class="toc-backref" href="#id567">13.15.4&nbsp;&nbsp;&nbsp;Groups</a></h3>
<p>The client can request that the results are returned along with grouping
information, e.g. grouped by <tt class="docutils literal">room_id</tt>. In this case the response will
contain a group entry for each distinct value of <tt class="docutils literal">room_id</tt>. Each group entry
contains at least a list of the <tt class="docutils literal">event_ids</tt> that are in that group, as well
as potentially other metadata about the group.</p>
<p>The current required supported groupings are:</p>
<ul class="simple">
<li><tt class="docutils literal">room_id</tt></li>
<li><tt class="docutils literal">sender</tt></li>
</ul>
</div>
<p><a class="anchor" id="id154"></a></p>
<div class="section" id="id154">
<h3><a class="toc-backref" href="#id568">13.15.5&nbsp;&nbsp;&nbsp;Pagination</a></h3>
<p>The server may return a <tt class="docutils literal">next_batch</tt> key at various places in the response.
These are used to paginate the results. To fetch more results, the client
should send the <em>same</em> request to the server with a <tt class="docutils literal">next_batch</tt> query
parameter set to that of the token.</p>
<p>The scope of the pagination is defined depending on where the <tt class="docutils literal">next_batch</tt>
token was returned. For example, using a token inside a group will return more
results from within that group.</p>
<p>The currently supported locations for the <tt class="docutils literal">next_batch</tt> token are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">search_categories.&lt;category&gt;.next_batch</span></tt></li>
<li><tt class="docutils literal"><span class="pre">search_categories.&lt;category&gt;.groups.&lt;group_key&gt;.&lt;group_id&gt;.next_batch</span></tt></li>
</ul>
<p>A server need not support pagination, even if there are more matching results.
In that case, they must not return a <tt class="docutils literal">next_batch</tt> token in the response.</p>
</div>
<p><a class="anchor" id="id155"></a></p>
<div class="section" id="id155">
<h3><a class="toc-backref" href="#id569">13.15.6&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>The server must only return results that the user has permission to see.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="guest-access"></a></p>
<div class="section" id="guest-access">
<h2><a class="toc-backref" href="#id570">13.16&nbsp;&nbsp;&nbsp;Guest Access</a></h2>
<p id="module-guest-access">There are times when it is desirable for clients to be able to interact with
rooms without having to fully register for an account on a homeserver or join
the room. This module specifies how these clients should interact with servers
in order to participate in rooms as guests.</p>
<p>Guest users retrieve access tokens from a homeserver using the ordinary
<a class="reference external" href="#post-matrix-client-r0-register">register endpoint</a>, specifying
the <tt class="docutils literal">kind</tt> parameter as <tt class="docutils literal">guest</tt>. They may then interact with the
client-server API as any other user would, but will only have access to a subset
of the API as described the Client behaviour subsection below.
Homeservers may choose not to allow this access at all to their local users, but
have no information about whether users on other homeservers are guests or not.</p>
<p>Guest users can also upgrade their account by going through the ordinary
<tt class="docutils literal">register</tt> flow, but specifying the additional POST parameter
<tt class="docutils literal">guest_access_token</tt> containing the guest's access token. They are also
required to specify the <tt class="docutils literal">username</tt> parameter to the value of the local part of
their username, which is otherwise optional.</p>
<p>This module does not fully factor in federation; it relies on individual
homeservers properly adhering to the rules set out in this module, rather than
allowing all homeservers to enforce the rules on each other.</p>
<p><a class="anchor" id="id156"></a></p>
<div class="section" id="id156">
<h3><a class="toc-backref" href="#id571">13.16.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-room-guest-access"></a></p>
<div class="section" id="m-room-guest-access">
<h4><a class="toc-backref" href="#id572">13.16.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.guest_access</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This event controls whether guest users are allowed to join rooms. If this event is absent, servers should act as if it is present and has the guest_access value &quot;forbidden&quot;.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>guest_access</td>
<td>enum</td>
<td><strong>Required.</strong> Whether guests can join the room.
One of: [&quot;can_join&quot;, &quot;forbidden&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;guest_access&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;can_join&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.guest_access&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id157"></a></p>
<div class="section" id="id157">
<h3><a class="toc-backref" href="#id573">13.16.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>The following API endpoints are allowed to be accessed by guest accounts for
retrieving events:</p>
<ul class="simple">
<li><a class="reference external" href="#get-matrix-client-r0-rooms-roomid-state">GET /rooms/:room_id/state</a></li>
<li><a class="reference external" href="#get-matrix-client-r0-rooms-roomid-context-eventid">GET /rooms/:room_id/context/:event_id</a></li>
<li><a class="reference external" href="#get-matrix-client-r0-rooms-roomid-event-eventid">GET /rooms/:room_id/event/:event_id</a></li>
<li><a class="reference external" href="#get-matrix-client-r0-rooms-roomid-state-eventtype-statekey">GET /rooms/:room_id/state/:event_type/:state_key</a></li>
<li><a class="reference external" href="#get-matrix-client-r0-rooms-roomid-messages">GET /rooms/:room_id/messages</a></li>
<li><a class="reference external" href="#get-matrix-client-r0-rooms-roomid-initialsync">GET /rooms/:room_id/initialSync</a></li>
<li><a class="reference external" href="#get-matrix-client-r0-sync">GET /sync</a></li>
<li><a class="reference internal" href="#peeking-events-api">GET /events</a> as used for room previews.</li>
</ul>
<p>The following API endpoints are allowed to be accessed by guest accounts for
sending events:</p>
<ul class="simple">
<li><a class="reference external" href="#post-matrix-client-r0-rooms-roomid-join">POST /rooms/:room_id/join</a></li>
<li><a class="reference external" href="#post-matrix-client-r0-rooms-roomid-leave">POST /rooms/:room_id/leave</a></li>
<li><a class="reference external" href="#put-matrix-client-r0-rooms-roomid-send-eventtype-txnid">PUT /rooms/:room_id/send/m.room.message/:txn_id</a></li>
<li><a class="reference external" href="#put-matrix-client-r0-sendtodevice-eventtype-txnid">PUT /sendToDevice/{eventType}/{txnId}</a></li>
</ul>
<p>The following API endpoints are allowed to be accessed by guest accounts for
their own account maintenance:</p>
<ul class="simple">
<li><a class="reference external" href="#put-matrix-client-r0-profile-userid-displayname">PUT /profile/:user_id/displayname</a></li>
<li><a class="reference external" href="#get-matrix-client-r0-devices">GET /devices</a></li>
<li><a class="reference external" href="#get-matrix-client-r0-devices-deviceid">GET /devices/{deviceId}</a></li>
<li><a class="reference external" href="#put-matrix-client-r0-devices-deviceid">PUT /devices/{deviceId}</a></li>
</ul>
<p>The following API endpoints are allowed to be accessed by guest accounts for
end-to-end encryption:</p>
<ul class="simple">
<li><a class="reference external" href="#post-matrix-client-r0-keys-upload">POST /keys/upload</a></li>
<li><a class="reference external" href="#post-matrix-client-r0-keys-query">POST /keys/query</a></li>
<li><a class="reference external" href="#post-matrix-client-r0-keys-claim">POST /keys/claim</a></li>
</ul>
</div>
<p><a class="anchor" id="id159"></a></p>
<div class="section" id="id159">
<h3><a class="toc-backref" href="#id574">13.16.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Servers MUST only allow guest users to join rooms if the <tt class="docutils literal">m.room.guest_access</tt>
state event is present on the room, and has the <tt class="docutils literal">guest_access</tt> value
<tt class="docutils literal">can_join</tt>. If the <tt class="docutils literal">m.room.guest_access</tt> event is changed to stop this from
being the case, the server MUST set those users' <tt class="docutils literal">m.room.member</tt> state to
<tt class="docutils literal">leave</tt>.</p>
</div>
<p><a class="anchor" id="id160"></a></p>
<div class="section" id="id160">
<h3><a class="toc-backref" href="#id575">13.16.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Each homeserver manages its own guest accounts itself, and whether an account
is a guest account or not is not information passed from server to server.
Accordingly, any server participating in a room is trusted to properly enforce
the permissions outlined in this section.</p>
<p>Homeservers may want to enable protections such as captchas for guest
registration to prevent spam, denial of service, and similar attacks.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id161"></a></p>
<div class="section" id="id161">
<h2><a class="toc-backref" href="#id576">13.17&nbsp;&nbsp;&nbsp;Room Previews</a></h2>
<p id="module-room-previews">It is sometimes desirable to offer a preview of a room, where a user can &quot;lurk&quot;
and read messages posted to the room, without joining the room. This can be
particularly effective when combined with <a class="reference internal" href="#guest-access">Guest Access</a>.</p>
<p>Previews are implemented via the <tt class="docutils literal">world_readable</tt> <a class="reference internal" href="#room-history-visibility">Room History Visibility</a>.
setting, along with a special version of the
<a class="reference external" href="#get-matrix-client-r0-events">GET /events</a> endpoint.</p>
<p><a class="anchor" id="id162"></a></p>
<div class="section" id="id162">
<h3><a class="toc-backref" href="#id577">13.17.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>A client wishing to view a room without joining it should call
<a class="reference external" href="#get-matrix-client-r0-rooms-roomid-initialsync">GET /rooms/:room_id/initialSync</a>,
followed by <a class="reference internal" href="#peeking-events-api">GET /events</a>. Clients will need to do this
in parallel for each room they wish to view.</p>
<p>Clients can of course also call other endpoints such as
<a class="reference external" href="#get-matrix-client-r0-rooms-roomid-messages">GET /rooms/:room_id/messages</a>
and <a class="reference external" href="#get-matrix-client-r0-search">GET /search</a> to access
events outside the <tt class="docutils literal">/events</tt> stream.</p>
<p><a class="anchor" id="id166"></a></p>
<div class="section" id="id166">
<span id="peeking-events-api"></span><h4><a class="toc-backref" href="#id578">13.17.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/events</tt></a></h4>
<p>This will listen for new events related to a particular room and return
them to the caller. This will block until an event is received, or until
the <tt class="docutils literal">timeout</tt> is reached.</p>
<p>This API is the same as the normal <tt class="docutils literal">/events</tt> endpoint, but can be
called by users who have not joined the room.</p>
<p>Note that the normal <tt class="docutils literal">/events</tt> endpoint has been deprecated. This
API will also be deprecated at some point, but its replacement is not
yet known.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>from</td>
<td>string</td>
<td>The token to stream from. This token is either
from a previous request to this API or from the
initial sync API.</td>
</tr>
<tr><td>timeout</td>
<td>integer</td>
<td>The maximum time in milliseconds to wait for an
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>The room ID for which events should be returned.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>start</td>
<td>string</td>
<td>A token which correlates to the first value in
<tt class="docutils literal">chunk</tt>. This is usually the same token supplied
to <tt class="docutils literal">from=</tt>.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>A token which correlates to the last value in
<tt class="docutils literal">chunk</tt>. This token should be used in the next
request to <tt class="docutils literal">/events</tt>.</td>
</tr>
<tr><td>chunk</td>
<td>[Event]</td>
<td>An array of events.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/events?from=s3456_9_0&amp;timeout=35000&amp;room_id=%21somewhere%3Aover.the.rainbow</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The events received, which may be none.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3456_9_0&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3457_9_0&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!somewhere:over.the.rainbow&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>Bad pagination <tt class="docutils literal">from</tt> parameter.</p>
</div>
</div>
<p><a class="anchor" id="id167"></a></p>
<div class="section" id="id167">
<h3><a class="toc-backref" href="#id579">13.17.2&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>For clients which have not joined a room, servers are required to only return
events where the room state at the event had the <tt class="docutils literal">m.room.history_visibility</tt>
state event present with <tt class="docutils literal">history_visibility</tt> value <tt class="docutils literal">world_readable</tt>.</p>
</div>
<p><a class="anchor" id="id168"></a></p>
<div class="section" id="id168">
<h3><a class="toc-backref" href="#id580">13.17.3&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Clients may wish to display to their users that rooms which are
<tt class="docutils literal">world_readable</tt> <em>may</em> be showing messages to non-joined users. There is no
way using this module to find out whether any non-joined guest users <em>do</em> see
events in the room, or to list or count any lurking users.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!-- Copyright 2018 New Vector Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="room-tagging"></a></p>
<div class="section" id="room-tagging">
<h2><a class="toc-backref" href="#id581">13.18&nbsp;&nbsp;&nbsp;Room Tagging</a></h2>
<p id="module-tagging">Users can add tags to rooms. Tags are namespaced strings used to label rooms.
A room may have multiple tags. Tags are only visible to the user that set them
but are shared across all their devices.</p>
<p><a class="anchor" id="id169"></a></p>
<div class="section" id="id169">
<h3><a class="toc-backref" href="#id582">13.18.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p>The tags on a room are received as single <tt class="docutils literal">m.tag</tt> event in the
<tt class="docutils literal">account_data</tt> section of a room. The content of the <tt class="docutils literal">m.tag</tt> event is a
<tt class="docutils literal">tags</tt> key whose value is an object mapping the name of each tag to another
object.</p>
<p>The JSON object associated with each tag gives information about the tag, e.g how
to order the rooms with a given tag.</p>
<p>Ordering information is given under the <tt class="docutils literal">order</tt> key as a number between 0 and
1. The numbers are compared such that 0 is displayed first. Therefore a room
with an <tt class="docutils literal">order</tt> of <tt class="docutils literal">0.2</tt> would be displayed before a room with an <tt class="docutils literal">order</tt>
of <tt class="docutils literal">0.7</tt>. If a room has a tag without an <tt class="docutils literal">order</tt> key then it should appear
after the rooms with that tag that have an <tt class="docutils literal">order</tt> key.</p>
<p>The name of a tag MUST NOT exceed 255 bytes.</p>
<p>The tag namespace is defined as follows:</p>
<ul class="simple">
<li>The namespace <tt class="docutils literal">m.*</tt> is reserved for tags defined in the Matrix specification. Clients must ignore
any tags in this namespace they don't understand.</li>
<li>The namespace <tt class="docutils literal">u.*</tt> is reserved for user-defined tags. The portion of the string after the <tt class="docutils literal">u.</tt>
is defined to be the display name of this tag. No other semantics should be inferred from tags in
this namespace.</li>
<li>A client or app willing to use special tags for advanced functionality should namespace them similarly to state keys: <tt class="docutils literal">tld.name.*</tt></li>
<li>Any tag in the <tt class="docutils literal">tld.name.*</tt> form but not matching the namespace of the current client should be ignored</li>
<li>Any tag not matching the above rules should be interpreted as a user tag from the <tt class="docutils literal">u.*</tt> namespace, as if
the name had already had <tt class="docutils literal">u.</tt> stripped from the start (ie. the name of the tag is used as the
display name directly). These non-namespaced tags are supported for historical reasons. New tags should use
one of the defined namespaces above.</li>
</ul>
<p>Two special names are listed in the specification:
The following tags are defined in the <tt class="docutils literal">m.*</tt> namespace:</p>
<ul class="simple">
<li><tt class="docutils literal">m.favourite</tt>: The user's favourite rooms. These should be shown with higher precedence than other rooms.</li>
<li><tt class="docutils literal">m.lowpriority</tt>: These should be shown with lower precedence than others.</li>
<li><tt class="docutils literal">m.server_notice</tt>: Used to identify <a class="reference external" href="#module-server-notices">Server Notice Rooms</a>.</li>
</ul>
<p><a class="anchor" id="m-tag"></a></p>
<div class="section" id="m-tag">
<h4><a class="toc-backref" href="#id583">13.18.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.tag</tt></a></h4>
<p>Informs the client of tags on a room.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>tags</td>
<td>{string: Tag}</td>
<td>The tags on the room and their contents.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Tag</caption>
<thead valign="bottom">
<tr><th class="head">Tag Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>order</td>
<td>number</td>
<td>A number in a range <tt class="docutils literal">[0,1]</tt> describing a
relative position of the room under the given tag.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;u.work&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;order&quot;</span><span class="punctuation">:</span> <span class="literal number float">0.9</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.tag&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id170"></a></p>
<div class="section" id="id170">
<h3><a class="toc-backref" href="#id584">13.18.2&nbsp;&nbsp;&nbsp;Client Behaviour</a></h3>
<p><a class="anchor" id="get-matrix-client-r0-user-userid-rooms-roomid-tags"></a></p>
<div class="section" id="get-matrix-client-r0-user-userid-rooms-roomid-tags">
<h4><a class="toc-backref" href="#id585">13.18.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/user/{userId}/rooms/{roomId}/tags</span></tt></a></h4>
<p>List the tags set by a user on a room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The id of the user to get tags for.
The access token must be authorized to make
requests for this user ID.</td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room to get tags for.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>tags</td>
<td>{string: Tag}</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Tag</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>order</td>
<td>number</td>
<td>A number in a range <tt class="docutils literal">[0,1]</tt> describing a
relative position of the room under the given tag.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/user/%40alice%3Aexample.com/rooms/%21726s6s6q%3Aexample.com/tags</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The list of tags for the user for the room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;m.favourite&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;order&quot;</span><span class="punctuation">:</span> <span class="literal number float">0.1</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;u.Work&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;order&quot;</span><span class="punctuation">:</span> <span class="literal number float">0.7</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;u.Customers&quot;</span><span class="punctuation">:</span> <span class="punctuation">{}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-r0-user-userid-rooms-roomid-tags-tag"></a></p>
<div class="section" id="put-matrix-client-r0-user-userid-rooms-roomid-tags-tag">
<h4><a class="toc-backref" href="#id586">13.18.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/user/{userId}/rooms/{roomId}/tags/{tag}</span></tt></a></h4>
<p>Add a tag to the room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The id of the user to add a tag for.
The access token must be authorized to make
requests for this user ID.</td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room to add a tag to.</td>
</tr>
<tr><td>tag</td>
<td>string</td>
<td><strong>Required.</strong> The tag to add.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>order</td>
<td>number</td>
<td>A number in a range <tt class="docutils literal">[0,1]</tt> describing a
relative position of the room under the given tag.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/user/%40alice%3Aexample.com/rooms/%21726s6s6q%3Aexample.com/tags/u.work</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;order&quot;</span><span class="punctuation">:</span> <span class="literal number float">0.25</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The tag was successfully added.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="delete-matrix-client-r0-user-userid-rooms-roomid-tags-tag"></a></p>
<div class="section" id="delete-matrix-client-r0-user-userid-rooms-roomid-tags-tag">
<h4><a class="toc-backref" href="#id587">13.18.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">DELETE <span class="pre">/_matrix/client/r0/user/{userId}/rooms/{roomId}/tags/{tag}</span></tt></a></h4>
<p>Remove a tag from the room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The id of the user to remove a tag
for. The access token must be authorized to make
requests for this user ID.</td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room to remove a tag
from.</td>
</tr>
<tr><td>tag</td>
<td>string</td>
<td><strong>Required.</strong> The tag to remove.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">DELETE</span> <span class="name namespace">/_matrix/client/r0/user/%40alice%3Aexample.com/rooms/%21726s6s6q%3Aexample.com/tags/u.work</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The tag was successfully removed.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
</div>
<p><a class="anchor" id="id171"></a></p>
<div class="section" id="id171">
<h2><a class="toc-backref" href="#id588">13.19&nbsp;&nbsp;&nbsp;Client Config</a></h2>
<p id="module-account-data">Clients can store custom config data for their account on their homeserver.
This account data will be synced between different devices and can persist
across installations on a particular device. Users may only view the account
data for their own account</p>
<p>The account_data may be either global or scoped to a particular rooms.</p>
<p><a class="anchor" id="id172"></a></p>
<div class="section" id="id172">
<h3><a class="toc-backref" href="#id589">13.19.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p>The client receives the account data as events in the <tt class="docutils literal">account_data</tt> sections
of a <tt class="docutils literal">/sync</tt>.</p>
<p>These events can also be received in a <tt class="docutils literal">/events</tt> response or in the
<tt class="docutils literal">account_data</tt> section of a room in <tt class="docutils literal">/sync</tt>. <tt class="docutils literal">m.tag</tt>
events appearing in <tt class="docutils literal">/events</tt> will have a <tt class="docutils literal">room_id</tt> with the room
the tags are for.</p>
</div>
<p><a class="anchor" id="id173"></a></p>
<div class="section" id="id173">
<h3><a class="toc-backref" href="#id590">13.19.2&nbsp;&nbsp;&nbsp;Client Behaviour</a></h3>
<p><a class="anchor" id="put-matrix-client-r0-user-userid-account-data-type"></a></p>
<div class="section" id="put-matrix-client-r0-user-userid-account-data-type">
<h4><a class="toc-backref" href="#id591">13.19.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/user/{userId}/account_data/{type}</span></tt></a></h4>
<p>Set some account_data for the client. This config is only visible to the user
that set the account_data. The config will be synced to clients in the
top-level <tt class="docutils literal">account_data</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the user to set
account_data for. The access token must be
authorized to make requests for this user ID.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The event type of the account_data
to set. Custom types should be namespaced to avoid
clashes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/user/%40alice%3Aexample.com/account_data/org.example.custom.config</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;custom_account_data_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;custom_config_value&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The account_data was successfully added.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-user-userid-account-data-type"></a></p>
<div class="section" id="get-matrix-client-r0-user-userid-account-data-type">
<h4><a class="toc-backref" href="#id592">13.19.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/user/{userId}/account_data/{type}</span></tt></a></h4>
<p>Get some account_data for the client. This config is only visible to the user
that set the account_data.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the user to get
account_data for. The access token must be
authorized to make requests for this user ID.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The event type of the account_data
to get. Custom types should be namespaced to avoid
clashes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/user/%40alice%3Aexample.com/account_data/org.example.custom.config</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The account data content for the given type.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;custom_account_data_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;custom_config_value&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-r0-user-userid-rooms-roomid-account-data-type"></a></p>
<div class="section" id="put-matrix-client-r0-user-userid-rooms-roomid-account-data-type">
<h4><a class="toc-backref" href="#id593">13.19.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/r0/user/{userId}/rooms/{roomId}/account_data/{type}</span></tt></a></h4>
<p>Set some account_data for the client on a given room. This config is only
visible to the user that set the account_data. The config will be synced to
clients in the per-room <tt class="docutils literal">account_data</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the user to set
account_data for. The access token must be
authorized to make requests for this user ID.</td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room to set
account_data on.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The event type of the account_data
to set. Custom types should be namespaced to avoid
clashes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/r0/user/%40alice%3Aexample.com/rooms/%21726s6s6q%3Aexample.com/account_data/org.example.custom.room.config</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;custom_account_data_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;custom_account_data_value&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The account_data was successfully added.</p>
</div>
<p><a class="anchor" id="get-matrix-client-r0-user-userid-rooms-roomid-account-data-type"></a></p>
<div class="section" id="get-matrix-client-r0-user-userid-rooms-roomid-account-data-type">
<h4><a class="toc-backref" href="#id594">13.19.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/user/{userId}/rooms/{roomId}/account_data/{type}</span></tt></a></h4>
<p>Get some account_data for the client on a given room. This config is only
visible to the user that set the account_data.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the user to set
account_data for. The access token must be
authorized to make requests for this user ID.</td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room to get
account_data for.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The event type of the account_data
to get. Custom types should be namespaced to avoid
clashes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/user/%40alice%3Aexample.com/rooms/%21726s6s6q%3Aexample.com/account_data/org.example.custom.room.config</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The account data content for the given type.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;custom_account_data_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;custom_config_value&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id174"></a></p>
<div class="section" id="id174">
<h3><a class="toc-backref" href="#id595">13.19.3&nbsp;&nbsp;&nbsp;Server Behaviour</a></h3>
<p>Servers MUST reject clients from setting account data for event types that
the server manages. Currently, this only includes <a class="reference internal" href="#m-fully-read">m.fully_read</a>.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id175"></a></p>
<div class="section" id="id175">
<h2><a class="toc-backref" href="#id596">13.20&nbsp;&nbsp;&nbsp;Server Administration</a></h2>
<p id="module-admin">This module adds capabilities for server administrators to inspect server state
and data.</p>
<p><a class="anchor" id="id176"></a></p>
<div class="section" id="id176">
<h3><a class="toc-backref" href="#id597">13.20.1&nbsp;&nbsp;&nbsp;Client Behaviour</a></h3>
<p><a class="anchor" id="get-matrix-client-r0-admin-whois-userid"></a></p>
<div class="section" id="get-matrix-client-r0-admin-whois-userid">
<h4><a class="toc-backref" href="#id598">13.20.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/admin/whois/{userId}</span></tt></a></h4>
<p>Gets information about a particular user.</p>
<p>This API may be restricted to only be called by the user being looked
up, or by a server admin. Server-local administrator privileges are not
specified in this document.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user to look up.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_id</td>
<td>string</td>
<td>The Matrix user ID of the user.</td>
</tr>
<tr><td>devices</td>
<td>{string: DeviceInfo}</td>
<td>Each key is an identitfier for one of the user's
devices.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>DeviceInfo</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sessions</td>
<td>[SessionInfo]</td>
<td>A user's sessions (i.e. what they did with an
access token from one login).</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>SessionInfo</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>connections</td>
<td>[ConnectionInfo]</td>
<td>Information particular connections in the session.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ConnectionInfo</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>ip</td>
<td>string</td>
<td>Most recently seen IP address of the session.</td>
</tr>
<tr><td>last_seen</td>
<td>integer</td>
<td>Unix timestamp that the session was last active.</td>
</tr>
<tr><td>user_agent</td>
<td>string</td>
<td>User agent string last seen in the session.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/admin/whois/%40peter%3Arabbit.rocks</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The lookup was successful.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;peter:rabbit.rocks&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;devices&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;teapot&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;sessions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
          <span class="name tag">&quot;connections&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;last_seen&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1411996332123</span><span class="punctuation">,</span>
              <span class="name tag">&quot;user_agent&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;curl/7.31.0-DEV&quot;</span>
            <span class="punctuation">},</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;10.0.0.2&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;last_seen&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1411996332123</span><span class="punctuation">,</span>
              <span class="name tag">&quot;user_agent&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.120 Safari/537.36&quot;</span>
            <span class="punctuation">}</span>
          <span class="punctuation">]</span>
        <span class="punctuation">}</span>
      <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
</div>
<p><a class="anchor" id="id177"></a></p>
<div class="section" id="id177">
<h2><a class="toc-backref" href="#id599">13.21&nbsp;&nbsp;&nbsp;Event Context</a></h2>
<p id="module-event-context">This API returns a number of events that happened just before and after the
specified event. This allows clients to get the context surrounding an event.</p>
<p><a class="anchor" id="id178"></a></p>
<div class="section" id="id178">
<h3><a class="toc-backref" href="#id600">13.21.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>There is a single HTTP API for retrieving event context, documented below.</p>
<p><a class="anchor" id="get-matrix-client-r0-rooms-roomid-context-eventid"></a></p>
<div class="section" id="get-matrix-client-r0-rooms-roomid-context-eventid">
<h4><a class="toc-backref" href="#id601">13.21.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/rooms/{roomId}/context/{eventId}</span></tt></a></h4>
<p>This API returns a number of events that happened just before and
after the specified event. This allows clients to get the context
surrounding an event.</p>
<p><em>Note</em>: This endpoint supports lazy-loading of room member events. See
<a class="reference external" href="#lazy-loading-room-members">Lazy-loading room members</a> for more information.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to get events from.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event to get context around.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to return. Default:
10.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>start</td>
<td>string</td>
<td>A token that can be used to paginate backwards
with.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>A token that can be used to paginate forwards
with.</td>
</tr>
<tr><td>events_before</td>
<td>[Room Event]</td>
<td>A list of room events that happened just before
the requested event, in reverse-chronological
order.</td>
</tr>
<tr><td>event</td>
<td>Room Event</td>
<td>Details of the requested event.</td>
</tr>
<tr><td>events_after</td>
<td>[Room Event]</td>
<td>A list of room events that happened just after the
requested event, in chronological order.</td>
</tr>
<tr><td>state</td>
<td>[State Event]</td>
<td>The state of the room at the last event returned.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Room Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>State Event</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The fields in this object will vary
depending on the type of event. When interacting
with the REST API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The type of event. This SHOULD be
namespaced similar to Java package naming
conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
<tr><td>event_id</td>
<td>string</td>
<td><strong>Required.</strong> The globally unique event
identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> Contains the fully-qualified ID of
the user who sent this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on
originating homeserver when this event was sent.</td>
</tr>
<tr><td>unsigned</td>
<td>UnsignedData</td>
<td>Contains optional extra information about the
event.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room associated with
this event. Will not be present on events that
arrive through <tt class="docutils literal">/sync</tt>, despite being required
everywhere else.</td>
</tr>
<tr><td>prev_content</td>
<td>EventContent</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td><strong>Required.</strong> A unique key which defines the
overwriting semantics for this piece of room
state. This value is often a zero-length string.
The presence of this key makes this event a State
Event. State keys starting with an <tt class="docutils literal">&#64;</tt> are
reserved for referencing user IDs, such as room
members. With the exception of a few events, state
events set with a given user's ID as the state key
MUST only be set by that user.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>UnsignedData</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The time in milliseconds that has elapsed since
the event was sent. This field is generated by the
local homeserver, and may be incorrect if the
local time on at least one of the two servers is
out of sync, which can cause the age to either be
negative or greater than it actually is.</td>
</tr>
<tr><td>redacted_because</td>
<td>Event</td>
<td>Optional. The event that redacted this event, if
any.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>The client-supplied transaction ID, if the client
being given the event is the same one which sent
it.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/rooms/%21636q39766251%3Aexample.com/context/%24f3h4d129462ha%3Aexample.com?limit=3</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The events and state surrounding the requested event.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t29-57_2_0_2&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;events_after&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;format&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.custom.html&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;formatted_body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;event&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;filename.jpg&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">398</span><span class="punctuation">,</span>
        <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">394</span><span class="punctuation">,</span>
        <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">31037</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/JWEIFJgwEIhweiWJE&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.image&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$f3h4d129462ha:example.com&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;events_before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.doc&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.doc&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;application/msword&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.file&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t27-54_2_0_2&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;creator&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;room_version&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;m.federate&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
        <span class="name tag">&quot;predecessor&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$something:example.org&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!oldroom:example.org&quot;</span>
        <span class="punctuation">}</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.create&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
      <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.org&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id180"></a></p>
<div class="section" id="id180">
<h3><a class="toc-backref" href="#id602">13.21.2&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>The server must only return results that the user has permission to see.</p>
<!-- Copyright 2019 New Vector Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="sso-client-login"></a></p>
<div class="section" id="sso-client-login">
<h2><a class="toc-backref" href="#id603">13.22&nbsp;&nbsp;&nbsp;SSO client login</a></h2>
<p id="module-sso-login">Single Sign-On (SSO) is a generic term which refers to protocols which allow
users to log into applications via a single web-based authentication portal.
Examples include &quot;Central Authentication Service&quot; (CAS) and SAML.</p>
<p>An overview of the process, as used in Matrix, is as follows:</p>
<ol class="arabic simple">
<li>The Matrix client instructs the user's browser to navigate to the
<a class="reference external" href="#get-matrix-client-r0-login-sso-redirect"><tt class="docutils literal">/login/sso/redirect</tt></a> endpoint on the user's homeserver.</li>
<li>The homeserver responds with an HTTP redirect to the SSO user interface,
which the browser follows.</li>
<li>The SSO system authenticates the user.</li>
<li>The SSO server and the homeserver interact to verify the user's identity
and other authentication information, potentially using a number of redirects.</li>
<li>The browser is directed to the <tt class="docutils literal">redirectUrl</tt> provided by the client with
a <tt class="docutils literal">loginToken</tt> query parameter for the client to log in with.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the older <a class="reference external" href="https://matrix.org/docs/spec/client_server/r0.4.0.html#cas-based-client-login">r0.4.0 version</a>
of this specification it was possible to authenticate via CAS when the server
provides a <tt class="docutils literal">m.login.cas</tt> login flow. This specification deprecates the use
of <tt class="docutils literal">m.login.cas</tt> to instead prefer <tt class="docutils literal">m.login.sso</tt>, which is the same process
with the only change being which redirect endpoint to use: for <tt class="docutils literal">m.login.cas</tt>, use
<tt class="docutils literal">/cas/redirect</tt> and for <tt class="docutils literal">m.login.sso</tt> use <tt class="docutils literal">/sso/redirect</tt> (described below).
The endpoints are otherwise the same.</p>
</div>
<p><a class="anchor" id="id181"></a></p>
<div class="section" id="id181">
<h3><a class="toc-backref" href="#id604">13.22.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>The client starts the process by instructing the browser to navigate to
<a class="reference external" href="#get-matrix-client-r0-login-sso-redirect"><tt class="docutils literal">/login/sso/redirect</tt></a> with an appropriate <tt class="docutils literal">redirectUrl</tt>. Once authentication
is successful, the browser will be redirected to that <tt class="docutils literal">redirectUrl</tt>.</p>
<!-- TODO-spec

Should we recommend some sort of CSRF protection here (specifically, we
should guard against people accidentally logging in by sending them a link
to ``/login/sso/redirect``.

Maybe we should recommend that the ``redirectUrl`` should contain a CSRF
token which the client should then check before sending the login token to
``/login``? -->
<p><a class="anchor" id="get-matrix-client-r0-login-sso-redirect"></a></p>
<div class="section" id="get-matrix-client-r0-login-sso-redirect">
<h4><a class="toc-backref" href="#id605">13.22.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/login/sso/redirect</tt></a></h4>
<p>A web-based Matrix client should instruct the user's browser to
navigate to this endpoint in order to log in via SSO.</p>
<p>The server MUST respond with an HTTP redirect to the SSO interface.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">No.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>redirectUrl</td>
<td>string</td>
<td><strong>Required.</strong> URI to which the user will be
redirected after the homeserver has authenticated
the user with SSO.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/login/sso/redirect</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 302:</strong></p>
<p>A redirect to the SSO interface.</p>
</div>
</div>
<p><a class="anchor" id="id182"></a></p>
<div class="section" id="id182">
<h3><a class="toc-backref" href="#id606">13.22.2&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>The URI for the SSO system to be used should be configured on the server by the
server administrator. The server is expected to set up any endpoints required to
interact with that SSO system. For example, for CAS authentication the homeserver
should provide a means for the administrator to configure where the CAS server is
and the REST endpoints which consume the ticket. A good reference for how CAS could
be implemented is available in the older <a class="reference external" href="https://matrix.org/docs/spec/client_server/r0.4.0.html#cas-based-client-login">r0.4.0 version</a>
of this specification.</p>
<p><a class="anchor" id="handling-the-redirect-endpoint"></a></p>
<div class="section" id="handling-the-redirect-endpoint">
<h4><a class="toc-backref" href="#id607">13.22.2.1&nbsp;&nbsp;&nbsp;Handling the redirect endpoint</a></h4>
<p>When responding to the <tt class="docutils literal">/login/sso/redirect</tt> endpoint, the server must
generate a URI for the SSO login page with any appropriate parameters.</p>
<!-- TODO-spec:

It might be nice if the server did some validation of the ``redirectUrl``
parameter, so that we could check that aren't going to redirect to a non-TLS
endpoint, and to give more meaningful errors in the case of
faulty/poorly-configured clients. -->
</div>
<p><a class="anchor" id="handling-the-authentication-endpoint"></a></p>
<div class="section" id="handling-the-authentication-endpoint">
<h4><a class="toc-backref" href="#id608">13.22.2.2&nbsp;&nbsp;&nbsp;Handling the authentication endpoint</a></h4>
<p>Once the homeserver has verified the user's identity with the SSO system, it
MUST map the user ID to a valid <a class="reference external" href="../index.html#user-identifiers">Matrix user identifier</a>.
The guidance in <a class="reference external" href="../index.html#mapping-from-other-character-sets">Mapping from other character sets</a> may be useful.</p>
<p>If the generated user identifier represents a new user, it should be registered
as a new user.</p>
<p>Finally, the server should generate a short-term login token. The generated
token should be a macaroon, suitable for use with the <tt class="docutils literal">m.login.token</tt> type of
the <a class="reference external" href="#post-matrix-client-r0-login"><tt class="docutils literal">/login</tt></a> API, and <a class="reference external" href="#token-based">token-based interactive login</a>. The
lifetime of this token SHOULD be limited to around five seconds. This token is
given to the client via the <tt class="docutils literal">loginToken</tt> query parameter previously mentioned.</p>
<!-- Copyright 2016 OpenMarket Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
</div>
<p><a class="anchor" id="id185"></a></p>
<div class="section" id="id185">
<h2><a class="toc-backref" href="#id609">13.23&nbsp;&nbsp;&nbsp;Direct Messaging</a></h2>
<p id="module-dm">All communication over Matrix happens within a room. It is sometimes
desirable to offer users the concept of speaking directly to one
particular person. This module defines a way of marking certain rooms
as 'direct chats' with a given person. This does not restrict the chat
to being between exactly two people since this would preclude the
presence of automated 'bot' users or even a 'personal assistant' who is
able to answer direct messages on behalf of the user in their absence.</p>
<p>A room may not necessarily be considered 'direct' by all members of the
room, but a signalling mechanism exists to propagate the information of
whether a chat is 'direct' to an invitee.</p>
<p><a class="anchor" id="id186"></a></p>
<div class="section" id="id186">
<h3><a class="toc-backref" href="#id610">13.23.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-direct"></a></p>
<div class="section" id="m-direct">
<h4><a class="toc-backref" href="#id611">13.23.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.direct</tt></a></h4>
<p>A map of which rooms are considered 'direct' rooms for specific users
is kept in  <tt class="docutils literal">account_data</tt> in an event of type <tt class="docutils literal">m.direct</tt>. The
content of this event is an object where the keys are the user IDs
and values are lists of room ID strings of the 'direct' rooms for
that user ID.</p>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;!abcdefgh:example.com&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;!hgfedcba:example.com&quot;</span>
        <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.direct&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id187"></a></p>
<div class="section" id="id187">
<h3><a class="toc-backref" href="#id612">13.23.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>To start a direct chat with another user, the inviting user's client
should set the <tt class="docutils literal">is_direct</tt> flag to <a class="reference external" href="#post-matrix-client-r0-createroom"><tt class="docutils literal">/createRoom</tt></a>. The client should do
this whenever the flow the user has followed is one where their
intention is to speak directly with another person, as opposed to bringing that
person in to a shared room. For example, clicking on 'Start Chat' beside a
person's profile picture would imply the <tt class="docutils literal">is_direct</tt> flag should be set.</p>
<p>The invitee's client may use the <tt class="docutils literal">is_direct</tt> flag in the <a class="reference external" href="#m-room-member">m.room.member</a>
event to automatically mark the room as a direct chat but this is not
required: it may for example, prompt the user, or ignore the flag altogether.</p>
<p>Both the inviting client and the invitee's client should record the fact that
the room is a direct chat by storing an <tt class="docutils literal">m.direct</tt> event in the account data
using <a class="reference external" href="#put-matrix-client-r0-user-userid-account-data-type"><tt class="docutils literal"><span class="pre">/user/&lt;user_id&gt;/account_data/&lt;type&gt;</span></tt></a>.</p>
</div>
<p><a class="anchor" id="id188"></a></p>
<div class="section" id="id188">
<h3><a class="toc-backref" href="#id613">13.23.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>When the <tt class="docutils literal">is_direct</tt> flag is given to <a class="reference external" href="#post-matrix-client-r0-createroom"><tt class="docutils literal">/createRoom</tt></a>, the home
server must set the <tt class="docutils literal">is_direct</tt> flag in the invite member event for any users
invited in the <a class="reference external" href="#post-matrix-client-r0-createroom"><tt class="docutils literal">/createRoom</tt></a> call.</p>
<!-- Copyright 2018 Travis Ralston -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id189"></a></p>
<div class="section" id="id189">
<h2><a class="toc-backref" href="#id614">13.24&nbsp;&nbsp;&nbsp;Ignoring Users</a></h2>
<p id="module-ignore-users">With all the communication through Matrix it may be desirable to ignore a
particular user for whatever reason. This module defines how clients and
servers can implement the ignoring of users.</p>
<p><a class="anchor" id="id190"></a></p>
<div class="section" id="id190">
<h3><a class="toc-backref" href="#id615">13.24.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-ignored-user-list"></a></p>
<div class="section" id="m-ignored-user-list">
<h4><a class="toc-backref" href="#id616">13.24.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.ignored_user_list</tt></a></h4>
<p>A map of users which are considered ignored is kept in <tt class="docutils literal">account_data</tt>
in an event type of <tt class="docutils literal">m.ignored_user_list</tt>.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>ignored_users</td>
<td>Ignored users</td>
<td><strong>Required.</strong> The map of users to ignore</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Ignored users</caption>
<thead valign="bottom">
<tr><th class="head">Ignored users Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>$USER_ID</td>
<td>Ignored User</td>
<td>An empty object for future enhancement</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ignored_users&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;&#64;someone:example.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.ignored_user_list&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id191"></a></p>
<div class="section" id="id191">
<h3><a class="toc-backref" href="#id617">13.24.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>To ignore a user, effectively blocking them, the client should add the target
user to the <tt class="docutils literal">m.ignored_user_list</tt> event in their account data using
<a class="reference external" href="#put-matrix-client-r0-user-userid-account-data-type"><tt class="docutils literal"><span class="pre">/user/&lt;user_id&gt;/account_data/&lt;type&gt;</span></tt></a>. Once ignored, the client will no longer
receive events sent by that user, with the exception of state events. The client
should either hide previous content sent by the newly ignored user or perform
a new <tt class="docutils literal">/sync</tt> with no previous token.</p>
<p>Invites to new rooms by ignored users will not be sent to the client. The server
may optionally reject the invite on behalf of the client.</p>
<p>State events will still be sent to the client, even if the user is ignored.
This is to ensure parts, such as the room name, do not appear different to the
user just because they ignored the sender.</p>
<p>To remove a user from the ignored users list, remove them from the account data
event. The server will resume sending events from the previously ignored user,
however it should not send events that were missed while the user was ignored.
To receive the events that were sent while the user was ignored the client
should perform a fresh sync. The client may also un-hide any events it previously
hid due to the user becoming ignored.</p>
</div>
<p><a class="anchor" id="id192"></a></p>
<div class="section" id="id192">
<h3><a class="toc-backref" href="#id618">13.24.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Following an update of the <tt class="docutils literal">m.ignored_user_list</tt>, the sync API for all clients
should immediately start ignoring (or un-ignoring) the user. Clients are responsible
for determining if they should hide previously sent events or to start a new sync
stream.</p>
<p>Servers must still send state events sent by ignored users to clients.</p>
<p>Servers must not send room invites from ignored users to clients. Servers may
optionally decide to reject the invite, however.</p>
<!-- Copyright 2018 New Vector Ltd. -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="sticker-messages"></a></p>
<div class="section" id="sticker-messages">
<h2><a class="toc-backref" href="#id619">13.25&nbsp;&nbsp;&nbsp;Sticker Messages</a></h2>
<p id="module-stickers">This module allows users to send sticker messages in to rooms or direct
messaging sessions.</p>
<p>Sticker messages are specialised image messages that are displayed without
controls (e.g. no &quot;download&quot; link, or light-box view on click, as would be
displayed for for <a class="reference internal" href="#m-image">m.image</a> events).</p>
<p>Sticker messages are intended to provide simple &quot;reaction&quot; events in the message
timeline. The matrix client should provide some mechanism to display the sticker
&quot;body&quot; e.g. as a tooltip on hover, or in a modal when the sticker image is
clicked.</p>
<p><a class="anchor" id="id193"></a></p>
<div class="section" id="id193">
<h3><a class="toc-backref" href="#id620">13.25.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p>Sticker events are received as a single <tt class="docutils literal">m.sticker</tt> event in the
<tt class="docutils literal">timeline</tt> section of a room, in a <tt class="docutils literal">/sync</tt>.</p>
<p><a class="anchor" id="m-sticker"></a></p>
<div class="section" id="m-sticker">
<h4><a class="toc-backref" href="#id621">13.25.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.sticker</tt></a></h4>
<p><em>Message Event</em></p>
<p>This message represents a single sticker image.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> A textual representation or
associated description of the sticker image. This
could be the alt text of the original image, or a
message to accompany and further describe the
sticker.</td>
</tr>
<tr><td>info</td>
<td>ImageInfo</td>
<td><strong>Required.</strong> Metadata about the image referred to
in <tt class="docutils literal">url</tt> including a thumbnail representation.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td><strong>Required.</strong> The URL to the sticker image. This
must be a valid <tt class="docutils literal"><span class="pre">mxc://</span></tt> URI.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ImageInfo</caption>
<thead valign="bottom">
<tr><th class="head">ImageInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The intended display height of the image in
pixels. This may differ from the intrinsic
dimensions of the image file.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The intended display width of the image in pixels.
This may differ from the intrinsic dimensions of
the image file.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL (typically <a class="reference internal" href="#mxc-uri">MXC URI</a>) to a thumbnail of
the image. Only present if the thumbnail is
unencrypted.</td>
</tr>
<tr><td>thumbnail_file</td>
<td>EncryptedFile</td>
<td>Information on the encrypted thumbnail file, as
specified in <a class="reference internal" href="#encrypted-files">End-to-end encryption</a>. Only present if
the thumbnail is encrypted.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>ThumbnailInfo</td>
<td>Metadata about the image referred to in
<tt class="docutils literal">thumbnail_url</tt>.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>ThumbnailInfo</caption>
<thead valign="bottom">
<tr><th class="head">ThumbnailInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The intended display height of the image in
pixels. This may differ from the intrinsic
dimensions of the image file.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The intended display width of the image in pixels.
This may differ from the intrinsic dimensions of
the image file.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Landing&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">200</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/png&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">73602</span><span class="punctuation">,</span>
            <span class="name tag">&quot;thumbnail_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">200</span><span class="punctuation">,</span>
                <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/png&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">73602</span><span class="punctuation">,</span>
                <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">140</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;thumbnail_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://matrix.org/sHhqkFCvSkFwtmvtETOtKnLP&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">140</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://matrix.org/sHhqkFCvSkFwtmvtETOtKnLP&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.sticker&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id194"></a></p>
<div class="section" id="id194">
<h3><a class="toc-backref" href="#id622">13.25.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients supporting this message type should display the image content from the
event URL directly in the timeline.</p>
<p>A thumbnail image should be provided in the <tt class="docutils literal">info</tt> object. This is
largely intended as a fallback for clients that do not fully support the
<tt class="docutils literal">m.sticker</tt> event type. In most cases it is fine to set the thumbnail URL to the
same URL as the main event content.</p>
<p>It is recommended that sticker image content should be 512x512 pixels in size
or smaller. The dimensions of the image file should be twice the intended
display size specified in the <tt class="docutils literal">info</tt> object in order to assist
rendering sharp images on higher DPI screens.</p>
<!-- Copyright 2018 Travis Ralston -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id195"></a></p>
<div class="section" id="id195">
<h2><a class="toc-backref" href="#id623">13.26&nbsp;&nbsp;&nbsp;Reporting Content</a></h2>
<p id="module-report-content">Users may encounter content which they find inappropriate and should be able
to report it to the server administrators or room moderators for review. This
module defines a way for users to report content.</p>
<p>Content is reported based upon a negative score, where -100 is &quot;most offensive&quot;
and 0 is &quot;inoffensive&quot;.</p>
<p><a class="anchor" id="id196"></a></p>
<div class="section" id="id196">
<h3><a class="toc-backref" href="#id624">13.26.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-report-eventid"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-report-eventid">
<h4><a class="toc-backref" href="#id625">13.26.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/report/{eventId}</span></tt></a></h4>
<p>Reports an event as inappropriate to the server, which may then notify
the appropriate people.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room in which the event being
reported is located.</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event to report.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>score</td>
<td>integer</td>
<td><strong>Required.</strong> The score to rate this content as
where -100 is most offensive and 0 is inoffensive.</td>
</tr>
<tr><td>reason</td>
<td>string</td>
<td><strong>Required.</strong> The reason the content is being
reported. May be blank.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21637q39766251%3Aexample.com/report/%24something%3Aexample.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;score&quot;</span><span class="punctuation">:</span> <span class="literal number integer">-100</span><span class="punctuation">,</span>
  <span class="name tag">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;this makes me sad&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The event has been reported successfully.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id197"></a></p>
<div class="section" id="id197">
<h3><a class="toc-backref" href="#id626">13.26.2&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Servers are free to handle the reported content however they desire. This may
be a dedicated room to alert server administrators to the reported content or
some other mechanism for notifying the appropriate people.</p>
</div>
</div>
<p><a class="anchor" id="id198"></a></p>
<div class="section" id="id198">
<h2><a class="toc-backref" href="#id627">13.27&nbsp;&nbsp;&nbsp;Third Party Networks</a></h2>
<p id="module-third-party-networks">Application services can provide access to third party networks via bridging.
This allows Matrix users to communicate with users on other communication
platforms, with messages ferried back and forth by the application service. A
single application service may bridge multiple third party networks, and many
individual locations within those networks. A single third party network
location may be bridged to multiple Matrix rooms.</p>
<p><a class="anchor" id="third-party-lookups"></a></p>
<div class="section" id="third-party-lookups">
<h3><a class="toc-backref" href="#id628">13.27.1&nbsp;&nbsp;&nbsp;Third Party Lookups</a></h3>
<p>A client may wish to provide a rich interface for joining third party
locations and connecting with third party users. Information necessary for
such an interface is provided by third party lookups.</p>
<p><a class="anchor" id="get-matrix-client-r0-thirdparty-protocols"></a></p>
<div class="section" id="get-matrix-client-r0-thirdparty-protocols">
<h4><a class="toc-backref" href="#id629">13.27.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/thirdparty/protocols</tt></a></h4>
<p>Fetches the overall metadata about protocols supported by the
homeserver. Includes both the available protocols and all fields
required for queries against each protocol.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<p><cite>No parameters</cite></p>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Protocol</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_fields</td>
<td>[string]</td>
<td><strong>Required.</strong> Fields which may be used to identify
a third party user. These should be ordered to
suggest the way that entities may be grouped,
where higher groupings are ordered first. For
example, the name of a network should be searched
before the nickname of a user.</td>
</tr>
<tr><td>location_fields</td>
<td>[string]</td>
<td><strong>Required.</strong> Fields which may be used to identify
a third party location. These should be ordered to
suggest the way that entities may be grouped,
where higher groupings are ordered first. For
example, the name of a network should be searched
before the name of a channel.</td>
</tr>
<tr><td>icon</td>
<td>string</td>
<td><strong>Required.</strong> A content URI representing an icon
for the third party protocol.</td>
</tr>
<tr><td>field_types</td>
<td>{string: Field Type}</td>
<td><p class="first"><strong>Required.</strong> The type definitions for the fields
defined in the <tt class="docutils literal">user_fields</tt> and
<tt class="docutils literal">location_fields</tt>. Each entry in those arrays
MUST have an entry here. The <tt class="docutils literal">string</tt> key for
this object is field name itself.</p>
<p class="last">May be an empty object if no fields are defined.</p>
</td>
</tr>
<tr><td>instances</td>
<td>[Protocol Instance]</td>
<td><strong>Required.</strong> A list of objects representing
independent instances of configuration. For
example, multiple networks on IRC if multiple are
provided by the same application service.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Field Type</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>regexp</td>
<td>string</td>
<td><strong>Required.</strong> A regular expression for validation
of a field's value. This may be relatively coarse
to verify the value as the application service
providing this protocol may apply additional
validation or filtering.</td>
</tr>
<tr><td>placeholder</td>
<td>string</td>
<td><strong>Required.</strong> An placeholder serving as a valid
example of the field value.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Protocol Instance</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>desc</td>
<td>string</td>
<td><strong>Required.</strong> A human-readable description for the
protocol, such as the name.</td>
</tr>
<tr><td>icon</td>
<td>string</td>
<td>An optional content URI representing the protocol.
Overrides the one provided at the higher level
Protocol object.</td>
</tr>
<tr><td>fields</td>
<td>object</td>
<td><strong>Required.</strong> Preset values for <tt class="docutils literal">fields</tt> the
client may use to search by.</td>
</tr>
<tr><td>network_id</td>
<td>string</td>
<td><strong>Required.</strong> A unique identifier across all
instances.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/thirdparty/protocols</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The protocols supported by the homeserver.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;irc&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;user_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;network&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;nickname&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;location_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;network&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;channel&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/aBcDeFgH&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;field_types&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;network&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;([a-z0-9]+\\.)*[a-z0-9]+&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;placeholder&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;irc.example.org&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;[^\\s]+&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;placeholder&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;username&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;channel&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#[^\\s]+&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;placeholder&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#foobar&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;instances&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;network_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;freenode&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Freenode&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/JkLmNoPq&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;network&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;freenode.net&quot;</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">]</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;gitter&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;user_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;username&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;location_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;room&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;field_types&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;username&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;[^\\s]+&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;placeholder&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;username&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;room&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;[^\\s]+\\/[^\\s]+&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;placeholder&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;matrix-org/matrix-doc&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;instances&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;network_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;gitter&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Gitter&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/zXyWvUt&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">{}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">]</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-thirdparty-protocol-protocol"></a></p>
<div class="section" id="get-matrix-client-r0-thirdparty-protocol-protocol">
<h4><a class="toc-backref" href="#id630">13.27.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/thirdparty/protocol/{protocol}</span></tt></a></h4>
<p>Fetches the metadata from the homeserver about a particular third party protocol.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>protocol</td>
<td>string</td>
<td><strong>Required.</strong> The name of the protocol.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<caption>Protocol</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_fields</td>
<td>[string]</td>
<td><strong>Required.</strong> Fields which may be used to identify
a third party user. These should be ordered to
suggest the way that entities may be grouped,
where higher groupings are ordered first. For
example, the name of a network should be searched
before the nickname of a user.</td>
</tr>
<tr><td>location_fields</td>
<td>[string]</td>
<td><strong>Required.</strong> Fields which may be used to identify
a third party location. These should be ordered to
suggest the way that entities may be grouped,
where higher groupings are ordered first. For
example, the name of a network should be searched
before the name of a channel.</td>
</tr>
<tr><td>icon</td>
<td>string</td>
<td><strong>Required.</strong> A content URI representing an icon
for the third party protocol.</td>
</tr>
<tr><td>field_types</td>
<td>{string: Field Type}</td>
<td><p class="first"><strong>Required.</strong> The type definitions for the fields
defined in the <tt class="docutils literal">user_fields</tt> and
<tt class="docutils literal">location_fields</tt>. Each entry in those arrays
MUST have an entry here. The <tt class="docutils literal">string</tt> key for
this object is field name itself.</p>
<p class="last">May be an empty object if no fields are defined.</p>
</td>
</tr>
<tr><td>instances</td>
<td>[Protocol Instance]</td>
<td><strong>Required.</strong> A list of objects representing
independent instances of configuration. For
example, multiple networks on IRC if multiple are
provided by the same application service.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Field Type</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>regexp</td>
<td>string</td>
<td><strong>Required.</strong> A regular expression for validation
of a field's value. This may be relatively coarse
to verify the value as the application service
providing this protocol may apply additional
validation or filtering.</td>
</tr>
<tr><td>placeholder</td>
<td>string</td>
<td><strong>Required.</strong> An placeholder serving as a valid
example of the field value.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Protocol Instance</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>desc</td>
<td>string</td>
<td><strong>Required.</strong> A human-readable description for the
protocol, such as the name.</td>
</tr>
<tr><td>icon</td>
<td>string</td>
<td>An optional content URI representing the protocol.
Overrides the one provided at the higher level
Protocol object.</td>
</tr>
<tr><td>fields</td>
<td>object</td>
<td><strong>Required.</strong> Preset values for <tt class="docutils literal">fields</tt> the
client may use to search by.</td>
</tr>
<tr><td>network_id</td>
<td>string</td>
<td><strong>Required.</strong> A unique identifier across all
instances.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/thirdparty/protocol/irc</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The protocol was found and metadata returned.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;user_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;network&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;nickname&quot;</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;location_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;network&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;channel&quot;</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/aBcDeFgH&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;field_types&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;network&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;([a-z0-9]+\\.)*[a-z0-9]+&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;placeholder&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;irc.example.org&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;[^\\s#]+&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;placeholder&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;username&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;channel&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#[^\\s]+&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;placeholder&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#foobar&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;instances&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Freenode&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.org/JkLmNoPq&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;network&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;freenode&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;network_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;freenode&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The protocol is unknown.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-thirdparty-location-protocol"></a></p>
<div class="section" id="get-matrix-client-r0-thirdparty-location-protocol">
<h4><a class="toc-backref" href="#id631">13.27.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/thirdparty/location/{protocol}</span></tt></a></h4>
<p>Requesting this endpoint with a valid protocol name results in a list
of successful mapping results in a JSON array. Each result contains
objects to represent the Matrix room or rooms that represent a portal
to this third party network. Each has the Matrix room alias string,
an identifier for the particular third party network protocol, and an
object containing the network-specific fields that comprise this
identifier. It should attempt to canonicalise the identifier as much
as reasonably possible given the network type.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>protocol</td>
<td>string</td>
<td><strong>Required.</strong> The protocol used to communicate to
the third party network.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>searchFields</td>
<td>string</td>
<td>One or more custom fields to help identify the
third party location.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>[Location]</td>
<td>List of matched third party locations.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Location</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>alias</td>
<td>string</td>
<td><strong>Required.</strong> An alias for a matrix room.</td>
</tr>
<tr><td>protocol</td>
<td>string</td>
<td><strong>Required.</strong> The protocol ID that the third party
location is a part of.</td>
</tr>
<tr><td>fields</td>
<td>object</td>
<td><strong>Required.</strong> Information used to identify this
third party location.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/thirdparty/location/irc</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>At least one portal room was found.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">[</span>
  <span class="punctuation">{</span>
    <span class="name tag">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#freenode_#matrix:matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;irc&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;network&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;freenode&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;channel&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#matrix&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">]</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>No portal rooms were found.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-thirdparty-user-protocol"></a></p>
<div class="section" id="get-matrix-client-r0-thirdparty-user-protocol">
<h4><a class="toc-backref" href="#id632">13.27.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/r0/thirdparty/user/{protocol}</span></tt></a></h4>
<p>Retrieve a Matrix User ID linked to a user on the third party service, given
a set of user parameters.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>protocol</td>
<td>string</td>
<td><strong>Required.</strong> The name of the protocol.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>fields...</td>
<td>string</td>
<td>One or more custom fields that are passed to the
AS to help identify the user.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>[User]</td>
<td>List of matched third party users.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>User</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>userid</td>
<td>string</td>
<td><strong>Required.</strong> A Matrix User ID represting a third
party user.</td>
</tr>
<tr><td>protocol</td>
<td>string</td>
<td><strong>Required.</strong> The protocol ID that the third party
location is a part of.</td>
</tr>
<tr><td>fields</td>
<td>object</td>
<td><strong>Required.</strong> Information used to identify this
third party location.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/thirdparty/user/irc</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The Matrix User IDs found with the given parameters.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">[</span>
  <span class="punctuation">{</span>
    <span class="name tag">&quot;userid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;_gitter_jim:matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;gitter&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;user&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;jim&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">]</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The Matrix User ID was not found</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-thirdparty-location"></a></p>
<div class="section" id="get-matrix-client-r0-thirdparty-location">
<h4><a class="toc-backref" href="#id633">13.27.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/thirdparty/location</tt></a></h4>
<p>Retrieve an array of third party network locations from a Matrix room
alias.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>alias</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix room alias to look up.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>[Location]</td>
<td>List of matched third party locations.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>Location</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>alias</td>
<td>string</td>
<td><strong>Required.</strong> An alias for a matrix room.</td>
</tr>
<tr><td>protocol</td>
<td>string</td>
<td><strong>Required.</strong> The protocol ID that the third party
location is a part of.</td>
</tr>
<tr><td>fields</td>
<td>object</td>
<td><strong>Required.</strong> Information used to identify this
third party location.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/thirdparty/location?alias=%23matrix%3Amatrix.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>All found third party locations.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">[</span>
  <span class="punctuation">{</span>
    <span class="name tag">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#freenode_#matrix:matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;irc&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;network&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;freenode&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;channel&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#matrix&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">]</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The Matrix room alias was not found</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-r0-thirdparty-user"></a></p>
<div class="section" id="get-matrix-client-r0-thirdparty-user">
<h4><a class="toc-backref" href="#id634">13.27.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/r0/thirdparty/user</tt></a></h4>
<p>Retrieve an array of third party users from a Matrix User ID.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>userid</td>
<td>string</td>
<td><strong>Required.</strong> The Matrix User ID to look up.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;body&gt;</td>
<td>[User]</td>
<td>List of matched third party users.</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-auto docutils">
<caption>User</caption>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>userid</td>
<td>string</td>
<td><strong>Required.</strong> A Matrix User ID represting a third
party user.</td>
</tr>
<tr><td>protocol</td>
<td>string</td>
<td><strong>Required.</strong> The protocol ID that the third party
location is a part of.</td>
</tr>
<tr><td>fields</td>
<td>object</td>
<td><strong>Required.</strong> Information used to identify this
third party location.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/r0/thirdparty/user?userid=%40bob%3Amatrix.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>An array of third party users.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">[</span>
  <span class="punctuation">{</span>
    <span class="name tag">&quot;userid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;_gitter_jim:matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;gitter&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;user&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;jim&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">]</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The Matrix User ID was not found</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_NOT_FOUND&quot;</span>
<span class="punctuation">}</span>
</pre>
<!-- Copyright 2018 New Vector Ltd. -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
</div>
<p><a class="anchor" id="id199"></a></p>
<div class="section" id="id199">
<h2><a class="toc-backref" href="#id635">13.28&nbsp;&nbsp;&nbsp;OpenID</a></h2>
<p id="module-openid">This module allows users to verify their identity with a third party service. The
third party service does need to be matrix-aware in that it will need to know to
resolve matrix homeservers to exchange the user's token for identity information.</p>
<p><a class="anchor" id="post-matrix-client-r0-user-userid-openid-request-token"></a></p>
<div class="section" id="post-matrix-client-r0-user-userid-openid-request-token">
<h3><a class="toc-backref" href="#id636">13.28.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/user/{userId}/openid/request_token</span></tt></a></h3>
<p>Gets an OpenID token object that the requester may supply to another
service to verify their identity in Matrix. The generated token is only
valid for exchanging for user information from the federation API for
OpenID.</p>
<p>The access token generated is only valid for the OpenID API. It cannot
be used to request another OpenID access token or call <tt class="docutils literal">/sync</tt>, for
example.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user to request and OpenID token
for. Should be the user who is authenticated for
the request.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>access_token</td>
<td>string</td>
<td><strong>Required.</strong> An access token the consumer may use
to verify the identity of the person who generated
the token. This is given to the federation API
<tt class="docutils literal">GET /openid/userinfo</tt>.</td>
</tr>
<tr><td>token_type</td>
<td>string</td>
<td><strong>Required.</strong> The string <tt class="docutils literal">Bearer</tt>.</td>
</tr>
<tr><td>matrix_server_name</td>
<td>string</td>
<td><strong>Required.</strong> The homeserver domain the consumer
should use when attempting to verify the user's
identity.</td>
</tr>
<tr><td>expires_in</td>
<td>integer</td>
<td><strong>Required.</strong> The number of seconds before this
token expires and a new one must be generated.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/user/%40alice%3Aexample.com/openid/request_token</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>OpenID token information. This response is nearly compatible with the
response documented in the <a class="reference external" href="http://openid.net/specs/openid-connect-core-1_0.html#TokenResponse">OpenID 1.0 Specification</a>
with the only difference being the lack of an <tt class="docutils literal">id_token</tt>. Instead,
the Matrix homeserver's name is provided.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;SomeT0kenHere&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;token_type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bearer&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;matrix_server_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;expires_in&quot;</span><span class="punctuation">:</span> <span class="literal number integer">3600</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 429:</strong></p>
<p>This request was rate-limited.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_LIMIT_EXCEEDED&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Too many requests&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;retry_after_ms&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2000</span>
<span class="punctuation">}</span>
</pre>
<!-- Copyright 2018 New Vector Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="server-access-control-lists-acls-for-rooms"></a></p>
<div class="section" id="server-access-control-lists-acls-for-rooms">
<h2><a class="toc-backref" href="#id637">13.29&nbsp;&nbsp;&nbsp;Server Access Control Lists (ACLs) for rooms</a></h2>
<p id="module-server-acls">In some scenarios room operators may wish to prevent a malicious or untrusted
server from participating in their room. Sending an <a class="reference internal" href="#m-room-server-acl">m.room.server_acl</a> state
event into a room is an effective way to prevent the server from participating
in the room at the federation level.</p>
<p>Server ACLs can also be used to make rooms only federate with a limited set of
servers, or retroactively make the room no longer federate with any other server,
similar to setting the <tt class="docutils literal">m.federate</tt> value on the <a class="reference internal" href="#m-room-create">m.room.create</a> event.</p>
<p><a class="anchor" id="m-room-server-acl"></a></p>
<div class="section" id="m-room-server-acl">
<h3><a class="toc-backref" href="#id638">13.29.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.server_acl</tt></a></h3>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>An event to indicate which servers are permitted to participate in the
room. Server ACLs may allow or deny groups of hosts. All servers participating
in the room, including those that are denied, are expected to uphold the
server ACL. Servers that do not uphold the ACLs MUST be added to the denied hosts
list in order for the ACLs to remain effective.</p>
<p>The <tt class="docutils literal">allow</tt> and <tt class="docutils literal">deny</tt> lists are lists of globs supporting <tt class="docutils literal">?</tt> and <tt class="docutils literal">*</tt>
as wildcards. When comparing against the server ACLs, the suspect server's port
number must not be considered. Therefore <tt class="docutils literal">evil.com</tt>, <tt class="docutils literal">evil.com:8448</tt>, and
<tt class="docutils literal">evil.com:1234</tt> would all match rules that apply to <tt class="docutils literal">evil.com</tt>, for example.</p>
<p>The ACLs are applied to servers when they make requests, and are applied in
the following order:</p>
<ol class="arabic simple">
<li>If there is no <tt class="docutils literal">m.room.server_acl</tt> event in the room state, allow.</li>
<li>If the server name is an IP address (v4 or v6) literal, and <tt class="docutils literal">allow_ip_literals</tt>
is present and <tt class="docutils literal">false</tt>, deny.</li>
<li>If the server name matches an entry in the <tt class="docutils literal">deny</tt> list, deny.</li>
<li>If the server name matches an entry in the <tt class="docutils literal">allow</tt> list, allow.</li>
<li>Otherwise, deny.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Server ACLs do not restrict the events relative to the room DAG via authorisation
rules, but instead act purely at the network layer to determine which servers are
allowed to connect and interact with a given room.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Failing to provide an <tt class="docutils literal">allow</tt> rule of some kind will prevent <strong>all</strong>
servers from participating in the room, including the sender. This renders
the room unusable. A common allow rule is <tt class="docutils literal">[ &quot;*&quot; ]</tt> which would still
permit the use of the <tt class="docutils literal">deny</tt> list without losing the room.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">All compliant servers must implement server ACLs.  However, legacy or noncompliant
servers exist which do not uphold ACLs, and these MUST be manually appended to
the denied hosts list when setting an ACL to prevent them from leaking events from
banned servers into a room. Currently, the only way to determine noncompliant hosts is
to check the <tt class="docutils literal">prev_events</tt> of leaked events, therefore detecting servers which
are not upholding the ACLs. Server versions can also be used to try to detect hosts that
will not uphold the ACLs, although this is not comprehensive. Server ACLs were added
in Synapse v0.32.0, although other server implementations and versions exist in the world.</p>
</div>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>allow_ip_literals</td>
<td>boolean</td>
<td><p class="first">True to allow server names that are IP address
literals. False to deny. Defaults to true if
missing or otherwise not a boolean.</p>
<p class="last">This is strongly recommended to be set to
<tt class="docutils literal">false</tt> as servers running with IP literal names
are strongly discouraged in order to require
legitimate homeservers to be backed by a valid
registered domain name.</p>
</td>
</tr>
<tr><td>allow</td>
<td>[string]</td>
<td><p class="first">The server names to allow in the room, excluding
any port information. Wildcards may be used to
cover a wider range of hosts, where <tt class="docutils literal">*</tt> matches
zero or more characters and <tt class="docutils literal">?</tt> matches exactly
one character.</p>
<p class="last"><strong>This defaults to an empty list when not
provided, effectively disallowing every server.</strong></p>
</td>
</tr>
<tr><td>deny</td>
<td>[string]</td>
<td><p class="first">The server names to disallow in the room,
excluding any port information. Wildcards may be
used to cover a wider range of hosts, where <tt class="docutils literal">*</tt>
matches zero or more characters and <tt class="docutils literal">?</tt> matches
exactly one character.</p>
<p class="last">This defaults to an empty list when not provided.</p>
</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;allow&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;*&quot;</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;allow_ip_literals&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
        <span class="name tag">&quot;deny&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;*.evil.com&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;evil.com&quot;</span>
        <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.server_acl&quot;</span>
<span class="punctuation">}</span>
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Port numbers are not supported because it is unclear to parsers whether a
port number should be matched or an IP address literal. Additionally, it
is unlikely that one would trust a server running on a particular domain's
port but not a different port, especially considering the server host can
easily change ports.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CIDR notation is not supported for IP addresses because Matrix does not
encourage the use of IPs for identifying servers. Instead, a blanket
<tt class="docutils literal">allow_ip_literals</tt> is provided to cover banning them.</p>
</div>
</div>
<p><a class="anchor" id="id200"></a></p>
<div class="section" id="id200">
<h3><a class="toc-backref" href="#id639">13.29.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients are not expected to perform any additional duties beyond sending the
event. Clients should describe changes to the server ACLs to the user in the
user interface, such as in the timeline.</p>
<p>Clients may wish to kick affected users from the room prior to denying a server
access to the room to help prevent those servers from participating and to
provide feedback to the users that they have been excluded from the room.</p>
</div>
<p><a class="anchor" id="id201"></a></p>
<div class="section" id="id201">
<h3><a class="toc-backref" href="#id640">13.29.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Servers MUST prevent blacklisted servers from sending events or participating
in the room when an <a class="reference internal" href="#m-room-server-acl">m.room.server_acl</a> event is present in the room state.
Which APIs are specifically affected are described in the Server-Server API
specification.</p>
<p>Servers should still send events to denied servers if they are still residents
of the room.</p>
</div>
<p><a class="anchor" id="id202"></a></p>
<div class="section" id="id202">
<h3><a class="toc-backref" href="#id641">13.29.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Server ACLs are only effective if every server in the room honours them. Servers
that do not honour the ACLs may still permit events sent by denied servers into
the room, leaking them to other servers in the room. To effectively enforce an
ACL in a room, the servers that do not honour the ACLs should be denied in the
room as well.</p>
<!-- Copyright 2018 New Vector Ltd. -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="user-room-and-group-mentions"></a></p>
<div class="section" id="user-room-and-group-mentions">
<h2><a class="toc-backref" href="#id642">13.30&nbsp;&nbsp;&nbsp;User, room, and group mentions</a></h2>
<p id="module-mentions">This module allows users to mention other users, rooms, and groups within
a room message. This is achieved by including a <a class="reference external" href="../appendices.html#matrix-to-navigation">matrix.to URI</a> in the HTML
body of an <a class="reference internal" href="#m-room-message">m.room.message</a> event. This module does not have any server-specific
behaviour to it.</p>
<p>Mentions apply only to <a class="reference internal" href="#m-room-message">m.room.message</a> events where the <tt class="docutils literal">msgtype</tt> is <tt class="docutils literal">m.text</tt>,
<tt class="docutils literal">m.emote</tt>, or <tt class="docutils literal">m.notice</tt>. The <tt class="docutils literal">format</tt> for the event must be <tt class="docutils literal">org.matrix.custom.html</tt>
and therefore requires a <tt class="docutils literal">formatted_body</tt>.</p>
<p>To make a mention, reference the entity being mentioned in the <tt class="docutils literal">formatted_body</tt>
using an anchor, like so:</p>
<pre class="literal-block">
{
    &quot;body&quot;: &quot;Hello Alice!&quot;,
    &quot;msgtype&quot;: &quot;m.text&quot;,
    &quot;format&quot;: &quot;org.matrix.custom.html&quot;,
    &quot;formatted_body&quot;: &quot;Hello &lt;a href='https://matrix.to/#/&#64;alice:example.org'&gt;Alice&lt;/a&gt;!&quot;
}
</pre>
<p><a class="anchor" id="id203"></a></p>
<div class="section" id="id203">
<h3><a class="toc-backref" href="#id643">13.30.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>In addition to using the appropriate <tt class="docutils literal">matrix.to URI</tt> for the mention,
clients should use the following guidelines when making mentions in events
to be sent:</p>
<ul class="simple">
<li>When mentioning users, use the user's potentially ambiguous display name for
the anchor's text. If the user does not have a display name, use the user's
ID.</li>
<li>When mentioning rooms, use the canonical alias for the room. If the room
does not have a canonical alias, prefer one of the aliases listed on the
room. If no alias can be found, fall back to the room ID. In all cases,
use the alias/room ID being linked to as the anchor's text.</li>
<li>When referencing groups, use the group ID as the anchor's text.</li>
</ul>
<p>The text component of the anchor should be used in the event's <tt class="docutils literal">body</tt> where
the mention would normally be represented, as shown in the example above.</p>
<p>Clients should display mentions differently from other elements. For example,
this may be done by changing the background color of the mention to indicate
that it is different from a normal link.</p>
<p>If the current user is mentioned in a message (either by a mention as defined
in this module or by a push rule), the client should show that mention differently
from other mentions, such as by using a red background color to signify to the
user that they were mentioned.</p>
<p>When clicked, the mention should navigate the user to the appropriate room, group,
or user information.</p>
<!-- Copyright 2019 New Vector Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id205"></a></p>
<div class="section" id="id205">
<h2><a class="toc-backref" href="#id644">13.31&nbsp;&nbsp;&nbsp;Room Upgrades</a></h2>
<p id="module-room-upgrades">From time to time, a room may need to be upgraded to a different room version for a
variety for reasons. This module defines a way for rooms to upgrade to a different
room version when needed.</p>
<p><a class="anchor" id="id206"></a></p>
<div class="section" id="id206">
<h3><a class="toc-backref" href="#id645">13.31.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-room-tombstone"></a></p>
<div class="section" id="m-room-tombstone">
<h4><a class="toc-backref" href="#id646">13.31.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.tombstone</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>A state event signifying that a room has been upgraded to a different room version, and that clients should go there.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> A server-defined message.</td>
</tr>
<tr><td>replacement_room</td>
<td>string</td>
<td><strong>Required.</strong> The new room the client should be
visiting.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This room has been replaced&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;replacement_room&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!newroom:example.org&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.tombstone&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id207"></a></p>
<div class="section" id="id207">
<h3><a class="toc-backref" href="#id647">13.31.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients which understand <tt class="docutils literal">m.room.tombstone</tt> events and the <tt class="docutils literal">predecessor</tt> field on
<tt class="docutils literal">m.room.create</tt> events should communicate to the user that the room was upgraded.
One way of accomplishing this would be hiding the old room from the user's room list
and showing banners linking between the old and new room - ensuring that permalinks
work when referencing the old room. Another approach may be to virtually merge the
rooms such that the old room's timeline seamlessly continues into the new timeline
without the user having to jump between the rooms.</p>
<p><a class="anchor" id="post-matrix-client-r0-rooms-roomid-upgrade"></a></p>
<div class="section" id="post-matrix-client-r0-rooms-roomid-upgrade">
<h4><a class="toc-backref" href="#id648">13.31.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/r0/rooms/{roomId}/upgrade</span></tt></a></h4>
<p>Upgrades the given room to a particular room version.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">No.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Request format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room to upgrade.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>new_version</td>
<td>string</td>
<td><strong>Required.</strong> The new version for the room.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Response format:</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>replacement_room</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the new room.</td>
</tr>
</tbody>
</table>
<p class="httpheaders">Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/r0/rooms/%21oldroom%3Aexample.org/upgrade</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;new_version&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;2&quot;</span>
<span class="punctuation">}</span>
</pre>
<p class="httpheaders">Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The room was successfully upgraded.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;replacement_room&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!newroom:example.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>The request was invalid. One way this can happen is if the room version
requested is not supported by the homeserver.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNSUPPORTED_ROOM_VERSION&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This server does not support that room version&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The user is not permitted to upgrade the room.</p>
<p class="httpheaders">Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;You cannot upgrade this room&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id208"></a></p>
<div class="section" id="id208">
<h3><a class="toc-backref" href="#id649">13.31.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>When the client requests to upgrade a known room to a known version, the server:</p>
<ol class="arabic">
<li><p class="first">Checks that the user has permission to send <tt class="docutils literal">m.room.tombstone</tt> events in the room.</p>
</li>
<li><p class="first">Creates a replacement room with a <tt class="docutils literal">m.room.create</tt> event containing a <tt class="docutils literal">predecessor</tt>
field and the applicable <tt class="docutils literal">room_version</tt>.</p>
</li>
<li><p class="first">Replicates transferable state events to the new room. The exact details for what is
transferred is left as an implementation detail, however the recommended state events
to transfer are:</p>
<ul class="simple">
<li><tt class="docutils literal">m.room.server_acl</tt></li>
<li><tt class="docutils literal">m.room.encryption</tt></li>
<li><tt class="docutils literal">m.room.name</tt></li>
<li><tt class="docutils literal">m.room.avatar</tt></li>
<li><tt class="docutils literal">m.room.topic</tt></li>
<li><tt class="docutils literal">m.room.guest_access</tt></li>
<li><tt class="docutils literal">m.room.history_visibility</tt></li>
<li><tt class="docutils literal">m.room.join_rules</tt></li>
<li><tt class="docutils literal">m.room.power_levels</tt></li>
</ul>
<p>Membership events should not be transferred to the new room due to technical limitations
of servers not being able to impersonate people from other homeservers. Additionally,
servers should not transfer state events which are sensitive to who sent them, such as
events outside of the Matrix namespace where clients may rely on the sender to match
certain criteria.</p>
</li>
<li><p class="first">Moves any local aliases to the new room.</p>
</li>
<li><p class="first">Sends a <tt class="docutils literal">m.room.tombstone</tt> event to the old room to indicate that it is not intended
to be used any further.</p>
</li>
<li><p class="first">If possible, the power levels in the old room should also be modified to prevent sending
of events and inviting new users. For example, setting <tt class="docutils literal">events_default</tt> and <tt class="docutils literal">invite</tt>
to the greater of <tt class="docutils literal">50</tt> and <tt class="docutils literal">users_default + 1</tt>.</p>
</li>
</ol>
<p>When a user joins the new room, the server should automatically transfer/replicate some of
the user's personalized settings such as notifications, tags, etc.</p>
<!-- Copyright 2019 The Matrix.org Foundation C.I.C. -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
</div>
</div>
<p><a class="anchor" id="id209"></a></p>
<div class="section" id="id209">
<h2><a class="toc-backref" href="#id650">13.32&nbsp;&nbsp;&nbsp;Server Notices</a></h2>
<p id="module-server-notices">Homeserver hosts often want to send messages to users in an official capacity,
or have resource limits which affect a user's ability to use the homeserver.
For example, the homeserver may be limited to a certain number of active users
per month and has exceeded that limit. To communicate this failure to users,
the homeserver would use the Server Notices room.</p>
<p>The aesthetics of the room (name, topic, avatar, etc) are left as an implementation
detail. It is recommended that the homeserver decorate the room such that it looks
like an official room to users.</p>
<p><a class="anchor" id="id210"></a></p>
<div class="section" id="id210">
<h3><a class="toc-backref" href="#id651">13.32.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p>Notices are sent to the client as normal <tt class="docutils literal">m.room.message</tt> events with a
<tt class="docutils literal">msgtype</tt> of <tt class="docutils literal">m.server_notice</tt> in the server notices room. Events with
a <tt class="docutils literal">m.server_notice</tt> <tt class="docutils literal">msgtype</tt> outside of the server notice room must
be ignored by clients.</p>
<p>The specified values for <tt class="docutils literal">server_notice_type</tt> are:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">m.server_notice.usage_limit_reached</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body"><p class="first">The server has exceeded some limit which requires the server administrator
to intervene. The <tt class="docutils literal">limit_type</tt> describes the kind of limit reached.
The specified values for <tt class="docutils literal">limit_type</tt> are:</p>
<table class="last docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">monthly_active_user</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The server's number of active users in the last 30 days has exceeded the
maximum. New connections are being refused by the server. What defines
&quot;active&quot; is left as an implementation detail, however servers are encouraged
to treat syncing users as &quot;active&quot;.</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<p><a class="anchor" id="m-room-message-m-server-notice"></a></p>
<div class="section" id="m-room-message-m-server-notice">
<h4><a class="toc-backref" href="#id652">13.32.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.message (m.server_notice)</tt></a></h4>
<p><em>Message Event</em></p>
<p>Represents a server notice for a user.</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td><strong>Required.</strong> A human-readable description of the
notice.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td><strong>Required.</strong> Must be 'm.server_notice'.</td>
</tr>
<tr><td>server_notice_type</td>
<td>string</td>
<td><strong>Required.</strong> The type of notice being
represented.</td>
</tr>
<tr><td>admin_contact</td>
<td>string</td>
<td>A URI giving a contact method for the server
administrator. Required if the notice type is
<tt class="docutils literal">m.server_notice.usage_limit_reached</tt>.</td>
</tr>
<tr><td>limit_type</td>
<td>string</td>
<td>The kind of usage limit the server has exceeded.
Required if the notice type is
<tt class="docutils literal">m.server_notice.usage_limit_reached</tt>.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;admin_contact&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mailto:server.admin&#64;example.org&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Human-readable message to explain the notice&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;limit_type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;monthly_active_user&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.server_notice&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;server_notice_type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.server_notice.usage_limit_reached&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id211"></a></p>
<div class="section" id="id211">
<h3><a class="toc-backref" href="#id653">13.32.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients can identify the server notices room by the <tt class="docutils literal">m.server_notice</tt> tag
on the room. Active notices are represented by the <a class="reference external" href="#m-room-pinned-events">pinned events</a>
in the server notices room. Server notice events pinned in that room should
be shown to the user through special UI and not through the normal pinned
events interface in the client. For example, clients may show warning banners
or bring up dialogs to get the user's attention. Events which are not server
notice events and are pinned in the server notices room should be shown just
like any other pinned event in a room.</p>
<p>The client must not expect to be able to reject an invite to join the server
notices room. Attempting to reject the invite must result in a
<tt class="docutils literal">M_CANNOT_LEAVE_SERVER_NOTICE_ROOM</tt> error. Servers should not prevent the user
leaving the room after joining the server notices room, however the same error
code must be used if the server will prevent leaving the room.</p>
</div>
<p><a class="anchor" id="id212"></a></p>
<div class="section" id="id212">
<h3><a class="toc-backref" href="#id654">13.32.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Servers should manage exactly 1 server notices room per user. Servers must
identify this room to clients with the <tt class="docutils literal">m.server_notice</tt> tag. Servers should
invite the target user rather than automatically join them to the server notice
room.</p>
<p>How servers send notices to clients, and which user they use to send the events,
is left as an implementation detail for the server.</p>
</div>
</div>
</div>
</div>
</body>
</html>
