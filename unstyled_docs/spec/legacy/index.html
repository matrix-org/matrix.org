<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
 * basic.css
 * ~~~~~~~~~
 *
 * Sphinx stylesheet -- basic theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- main layout ----------------------------------------------------------- */

div.clearer {
    clear: both;
}

/* -- relbar ---------------------------------------------------------------- */

div.related {
    width: 100%;
    font-size: 90%;
}

div.related h3 {
    display: none;
}

div.related ul {
    margin: 0;
    padding: 0 0 0 10px;
    list-style: none;
}

div.related li {
    display: inline;
}

div.related li.right {
    float: right;
    margin-right: 5px;
}

/* -- sidebar --------------------------------------------------------------- */

div.sphinxsidebarwrapper {
    padding: 10px 5px 0 10px;
}

div.sphinxsidebar {
    float: left;
    width: 230px;
    margin-left: -100%;
    font-size: 90%;
}

div.sphinxsidebar ul {
    list-style: none;
}

div.sphinxsidebar ul ul,
div.sphinxsidebar ul.want-points {
    margin-left: 20px;
    list-style: square;
}

div.sphinxsidebar ul ul {
    margin-top: 0;
    margin-bottom: 0;
}

div.sphinxsidebar form {
    margin-top: 10px;
}

div.sphinxsidebar input {
    border: 1px solid #98dbcc;
    font-family: sans-serif;
    font-size: 1em;
}

img {
    border: 0;
}

/* -- search page ----------------------------------------------------------- */

ul.search {
    margin: 10px 0 0 20px;
    padding: 0;
}

ul.search li {
    padding: 5px 0 5px 20px;
    background-image: url(file.png);
    background-repeat: no-repeat;
    background-position: 0 7px;
}

ul.search li a {
    font-weight: bold;
}

ul.search li div.context {
    color: #888;
    margin: 2px 0 0 30px;
    text-align: left;
}

ul.keywordmatches li.goodmatch a {
    font-weight: bold;
}

/* -- index page ------------------------------------------------------------ */

table.contentstable {
    width: 90%;
}

table.contentstable p.biglink {
    line-height: 150%;
}

a.biglink {
    font-size: 1.3em;
}

span.linkdescr {
    font-style: italic;
    padding-top: 5px;
    font-size: 90%;
}

/* -- general index --------------------------------------------------------- */

table.indextable {
    width: 100%;
}

table.indextable td {
    text-align: left;
    vertical-align: top;
}

table.indextable dl, table.indextable dd {
    margin-top: 0;
    margin-bottom: 0;
}

table.indextable tr.pcap {
    height: 10px;
}

table.indextable tr.cap {
    margin-top: 10px;
    background-color: #f2f2f2;
}

img.toggler {
    margin-right: 3px;
    margin-top: 3px;
    cursor: pointer;
}

div.modindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

div.genindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

/* -- general body styles --------------------------------------------------- */

a.headerlink {
    visibility: hidden;
}

h1:hover > a.headerlink,
h2:hover > a.headerlink,
h3:hover > a.headerlink,
h4:hover > a.headerlink,
h5:hover > a.headerlink,
h6:hover > a.headerlink,
dt:hover > a.headerlink {
    visibility: visible;
}

div.document p.caption {
    text-align: inherit;
}

div.document td {
    text-align: left;
}

.field-list ul {
    padding-left: 1em;
}

.first {
    margin-top: 0 !important;
}

p.rubric {
    margin-top: 30px;
    font-weight: bold;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* -- sidebars -------------------------------------------------------------- */

div.sidebar {
    margin: 0 0 0.5em 1em;
    border: 1px solid #ddb;
    padding: 7px 7px 0 7px;
    background-color: #ffe;
    width: 40%;
    float: right;
}

p.sidebar-title {
    font-weight: bold;
}

/* -- topics ---------------------------------------------------------------- */

div.topic {
    border: 1px solid #ccc;
    padding: 7px 7px 0 7px;
    margin: 10px 0 10px 0;
}

p.topic-title {
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 10px;
}

/* -- admonitions ----------------------------------------------------------- */

div.admonition {
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 7px;
}

div.admonition dt {
    font-weight: bold;
}

div.admonition dl {
    margin-bottom: 0;
}

p.admonition-title {
    margin: 0px 10px 5px 0px;
    font-weight: bold;
}

div.document p.centered {
    text-align: center;
    margin-top: 25px;
}

/* -- tables ---------------------------------------------------------------- */

table.docutils {
    border: 0;
    border-collapse: collapse;
}

table.docutils td, table.docutils th {
    padding: 1px 8px 1px 5px;
    border-top: 0;
    border-left: 0;
    border-right: 0;
    border-bottom: 1px solid #aaa;
}

table.field-list td, table.field-list th {
    border: 0 !important;
}

table.footnote td, table.footnote th {
    border: 0 !important;
}

th {
    text-align: left;
    padding-right: 5px;
}

table.citation {
    border-left: solid 1px gray;
    margin-left: 1px;
}

table.citation td {
    border-bottom: none;
}

/* -- other body styles ----------------------------------------------------- */

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl {
    margin-bottom: 15px;
}

dd p {
    margin-top: 0px;
}

dd ul, dd table {
    margin-bottom: 10px;
}

dd {
    margin-top: 3px;
    margin-bottom: 10px;
    margin-left: 30px;
}

dt:target, .highlighted {
    background-color: #fbe54e;
}

dl.glossary dt {
    font-weight: bold;
    font-size: 1.1em;
}

.field-list ul {
    margin: 0;
    padding-left: 1em;
}

.field-list p {
    margin: 0;
}

.refcount {
    color: #060;
}

.optional {
    font-size: 1.3em;
}

.versionmodified {
    font-style: italic;
}

.system-message {
    background-color: #fda;
    padding: 5px;
    border: 3px solid red;
}

.footnote:target  {
    background-color: #ffa
}

.line-block {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
}

.line-block .line-block {
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 1.5em;
}

.guilabel, .menuselection {
    font-family: sans-serif;
}

.accelerator {
    text-decoration: underline;
}

.classifier {
    font-style: oblique;
}

/* -- code displays --------------------------------------------------------- */

pre {
    overflow: auto;
}

td.linenos pre {
    padding: 5px 0px;
    border: 0;
    background-color: transparent;
    color: #aaa;
}

table.highlighttable {
    margin-left: 0.5em;
}

table.highlighttable td {
    padding: 0 0.5em 0 0.5em;
}

tt.descname {
    background-color: transparent;
    font-weight: bold;
    font-size: 1.2em;
}

tt.descclassname {
    background-color: transparent;
}

tt.xref, a tt {
    background-color: transparent;
    font-weight: bold;
}

h1 tt, h2 tt, h3 tt, h4 tt, h5 tt, h6 tt {
    background-color: transparent;
}

.viewcode-link {
    float: right;
}

.viewcode-back {
    float: right;
    font-family: sans-serif;
}

div.viewcode-block:target {
    margin: -1px -10px;
    padding: 0 10px;
}

/* -- math display ---------------------------------------------------------- */

img.math {
    vertical-align: middle;
}

div.document div.math p {
    text-align: center;
}

span.eqno {
    float: right;
}

/* -- printout stylesheet --------------------------------------------------- */

@media print {
    div.document,
    div.documentwrapper,
    div.bodywrapper {
        margin: 0 !important;
        width: 100%;
    }

    div.sphinxsidebar,
    div.related,
    div.footer,
    #top-link {
        display: none;
    }
}


</style>
<style type="text/css">

pre.code .comment, code .comment { color: green }
pre.code .keyword, code .keyword { color: darkred; font-weight: bold }
pre.code .name.builtin, code .name.builtin { color: darkred; font-weight: bold }
pre.code .name.tag, code .name.tag { color: darkgreen }
pre.code .literal, code .literal { color: darkblue }
pre.code .literal.number, code .literal.number { color: blue }


/* HTTP Methods have class "name function" */
pre.code.http .name.function,  code.http .name.function { color: black; font-weight: bold }
/* HTTP Paths have class "name namespace" */
pre.code.http .name.namespace, code.http .name.namespace { color: darkgreen }
/* HTTP "HTTP" strings have class "keyword reserved" */
pre.code.http .keyword.reserved, code.http .keyword.reserved { color: black; font-weight: bold }
/* HTTP Header names have class "name attribute" */
pre.code.http .name.attribute, code.http .name.attribute { color: black; font-weight: bold }

</style>
<style type="text/css">

/*
 * nature.css_t
 * ~~~~~~~~~~~~
 *
 * Sphinx stylesheet -- nature theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- page layout ----------------------------------------------------------- */

body {
    font-family: Arial, sans-serif;
    font-size: 100%;
    /*background-color: #111;*/
    color: #555;
    margin: 0;
    padding: 0;
}

div.documentwrapper {
    float: left;
    width: 100%;
}

div.bodywrapper {
    margin: 0 0 0 230px;
}

hr {
    border: 1px solid #B1B4B6;
}

/*
div.document {
    background-color: #eee;
}
*/

div.document {
    background-color: #ffffff;
    color: #3E4349;
    padding: 0 30px 30px 30px;
    font-size: 0.9em;
}

div.footer {
    color: #555;
    width: 100%;
    padding: 13px 0;
    text-align: center;
    font-size: 75%;
}

div.footer a {
    color: #444;
    text-decoration: underline;
}

div.related {
    background-color: #6BA81E;
    line-height: 32px;
    color: #fff;
    text-shadow: 0px 1px 0 #444;
    font-size: 0.9em;
}

div.related a {
    color: #E2F3CC;
}

div.sphinxsidebar {
    font-size: 0.75em;
    line-height: 1.5em;
}

div.sphinxsidebarwrapper{
    padding: 20px 0;
}

div.sphinxsidebar h3,
div.sphinxsidebar h4 {
    font-family: Arial, sans-serif;
    color: #222;
    font-size: 1.2em;
    font-weight: normal;
    margin: 0;
    padding: 5px 10px;
    background-color: #ddd;
    text-shadow: 1px 1px 0 white
}

div.sphinxsidebar h4{
    font-size: 1.1em;
}

div.sphinxsidebar h3 a {
    color: #444;
}


div.sphinxsidebar p {
    color: #888;
    padding: 5px 20px;
}

div.sphinxsidebar p.topless {
}

div.sphinxsidebar ul {
    margin: 10px 20px;
    padding: 0;
    color: #000;
}

div.sphinxsidebar a {
    color: #444;
}

div.sphinxsidebar input {
    border: 1px solid #ccc;
    font-family: sans-serif;
    font-size: 1em;
}

div.sphinxsidebar input[type=text]{
    margin-left: 20px;
}

/* -- body styles ----------------------------------------------------------- */

a {
    color: #005B81;
    text-decoration: none;
}

a:hover {
    color: #E32E00;
    text-decoration: underline;
}

div.document h1,
div.document h2,
div.document h3,
div.document h4,
div.document h5,
div.document h6 {
    font-family: Arial, sans-serif;
    background-color: #BED4EB;
    font-weight: normal;
    color: #212224;
    margin: 30px 0px 10px 0px;
    padding: 5px 0 5px 10px;
    text-shadow: 0px 1px 0 white
}

div.document h1 { border-top: 20px solid white; margin-top: 0; font-size: 200%; }
div.document h2 { font-size: 150%; background-color: #C8D5E3; }
div.document h3 { font-size: 120%; background-color: #D8DEE3; }
div.document h4 { font-size: 110%; background-color: #D8DEE3; }
div.document h5 { font-size: 100%; background-color: #D8DEE3; }
div.document h6 { font-size: 100%; background-color: #D8DEE3; }

a.headerlink {
    color: #c60f0f;
    font-size: 0.8em;
    padding: 0 4px 0 4px;
    text-decoration: none;
}

a.headerlink:hover {
    background-color: #c60f0f;
    color: white;
}

div.document p, div.document dd, div.document li {
    line-height: 1.5em;
}

div.admonition p.admonition-title + p {
    display: inline;
}

div.highlight{
    background-color: white;
}

div.note {
    background-color: #eee;
    border: 1px solid #ccc;
}

div.seealso {
    background-color: #ffc;
    border: 1px solid #ff6;
}

div.topic {
    background-color: #eee;
}

div.warning {
    background-color: #ffe4e4;
    border: 1px solid #f66;
}

p.admonition-title {
    display: inline;
}

p.admonition-title:after {
    content: ":";
}

pre {
    padding: 10px;
    background-color: White;
    color: #222;
    line-height: 1.2em;
    border: 1px solid #C6C9CB;
    font-size: 1.1em;
    margin: 1.5em 0 1.5em 0;
    -webkit-box-shadow: 1px 1px 1px #d8d8d8;
    -moz-box-shadow: 1px 1px 1px #d8d8d8;
}

tt {
    background-color: #ecf0f3;
    color: #222;
    /* padding: 1px 2px; */
    font-size: 1.1em;
    font-family: monospace;
}

.viewcode-back {
    font-family: Arial, sans-serif;
}

div.viewcode-block:target {
    background-color: #f4debf;
    border-top: 1px solid #ac9;
    border-bottom: 1px solid #ac9;
}

ul li dd {
	margin-top: 0;
}

ul li dl {
	margin-bottom: 0;
}

li dl dd {
	margin-bottom: 0;
}

dd ul {
	padding-left: 0;
}

li dd ul {
	margin-bottom: 0;
}

table {
    margin-top: 10px;
    margin-bottom: 10px;
    border: 0;
    border-collapse: collapse;
}

td[colspan]:not([colspan="1"]) {
    background: #eeeeee;
}

thead {
    background: #eeeeee;
}

div.admonition-rationale {
    background-color: #efe;
    border: 1px solid #ccc;
}


</style>
<style type="text/css">

blockquote {
    margin: 20px 0 30px;
    border-left: 5px solid;
    padding-left: 20px;
}

</style>
</head>
<body>

<div class="document">


<p><a class="anchor" id="matrix-specification"></a></p>
<div class="section" id="matrix-specification">
<h1><a class="toc-backref" href="#id58">1&nbsp;&nbsp;&nbsp;Matrix Specification</a></h1>
%outdatedspecwarning%
<p><a class="anchor" id="version-0-2-0"></a></p>
<div class="section" id="version-0-2-0">
<h2><a class="toc-backref" href="#id59">1.1&nbsp;&nbsp;&nbsp;Version: 0.2.0</a></h2>
<p>This specification has been generated from
<a class="reference external" href="https://github.com/matrix-org/matrix-doc">https://github.com/matrix-org/matrix-doc</a> using
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/blob/master/scripts/gendoc.py">https://github.com/matrix-org/matrix-doc/blob/master/scripts/gendoc.py</a> as of
revision <tt class="docutils literal">master,24356d8</tt> - <a class="reference external" href="https://github.com/matrix-org/matrix-doc/tree/24356d8">https://github.com/matrix-org/matrix-doc/tree/24356d8</a></p>
<p><a class="anchor" id="changelog"></a></p>
<div class="section" id="changelog">
<h3><a class="toc-backref" href="#id60">1.1.1&nbsp;&nbsp;&nbsp;Changelog</a></h3>
<p>This update fundamentally restructures the specification. The specification has
been split into more digestible &quot;modules&quot; which each describe a particular
function (e.g. typing). This was done in order make the specification easier to
maintain and help define which modules are mandatory for certain types
of clients. Types of clients along with the mandatory modules can be found in a
new &quot;Feature Profiles&quot; section. This update also begins to aggressively
standardise on using Swagger and JSON Schema to document HTTP endpoints and
Events respectively. It also introduces a number of new concepts to Matrix.</p>
<dl class="docutils">
<dt>Additions:</dt>
<dd><ul class="first last simple">
<li>New section: Feature Profiles.</li>
<li>New section: Receipts.</li>
<li>New section: Room history visibility.</li>
<li>New event: <tt class="docutils literal">m.receipt</tt>.</li>
<li>New event: <tt class="docutils literal">m.room.canonical_alias</tt></li>
<li>New event: <tt class="docutils literal">m.room.history_visibility</tt></li>
<li>New keys: <tt class="docutils literal">/createRoom</tt> - allows room &quot;presets&quot; using <tt class="docutils literal">preset</tt> and
<tt class="docutils literal">initial_state</tt> keys.</li>
<li>New endpoint: <tt class="docutils literal">/tokenrefresh</tt> - Related to refreshing access tokens.</li>
</ul>
</dd>
<dt>Modifications:</dt>
<dd><ul class="first last simple">
<li>Convert most of the older HTTP APIs to Swagger documentation.</li>
<li>Convert most of the older event formats to JSON Schema.</li>
<li>Move selected client-server sections to be &quot;Modules&quot;.</li>
</ul>
</dd>
</dl>
<p>For a full changelog, see
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/blob/master/CHANGELOG.rst">https://github.com/matrix-org/matrix-doc/blob/master/CHANGELOG.rst</a></p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#matrix-specification" id="id58">1&nbsp;&nbsp;&nbsp;Matrix Specification</a><ul class="auto-toc">
<li><a class="reference internal" href="#version-0-2-0" id="id59">1.1&nbsp;&nbsp;&nbsp;Version: 0.2.0</a><ul class="auto-toc">
<li><a class="reference internal" href="#changelog" id="id60">1.1.1&nbsp;&nbsp;&nbsp;Changelog</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#introduction" id="id61">2&nbsp;&nbsp;&nbsp;Introduction</a></li>
<li><a class="reference internal" href="#overview" id="id62">3&nbsp;&nbsp;&nbsp;Overview</a><ul class="auto-toc">
<li><a class="reference internal" href="#architecture" id="id63">3.1&nbsp;&nbsp;&nbsp;Architecture</a><ul class="auto-toc">
<li><a class="reference internal" href="#users" id="id64">3.1.1&nbsp;&nbsp;&nbsp;Users</a></li>
<li><a class="reference internal" href="#events" id="id65">3.1.2&nbsp;&nbsp;&nbsp;Events</a></li>
<li><a class="reference internal" href="#event-graphs" id="id66">3.1.3&nbsp;&nbsp;&nbsp;Event Graphs</a></li>
<li><a class="reference internal" href="#room-structure" id="id67">3.1.4&nbsp;&nbsp;&nbsp;Room structure</a><ul class="auto-toc">
<li><a class="reference internal" href="#room-aliases" id="id68">3.1.4.1&nbsp;&nbsp;&nbsp;Room Aliases</a></li>
</ul>
</li>
<li><a class="reference internal" href="#identity" id="id69">3.1.5&nbsp;&nbsp;&nbsp;Identity</a></li>
<li><a class="reference internal" href="#profiles" id="id70">3.1.6&nbsp;&nbsp;&nbsp;Profiles</a></li>
<li><a class="reference internal" href="#private-user-data" id="id71">3.1.7&nbsp;&nbsp;&nbsp;Private User Data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api-standards" id="id72">3.2&nbsp;&nbsp;&nbsp;API Standards</a></li>
</ul>
</li>
<li><a class="reference internal" href="#client-server-api" id="id73">4&nbsp;&nbsp;&nbsp;Client-Server API</a><ul class="auto-toc">
<li><a class="reference internal" href="#client-authentication" id="id74">4.1&nbsp;&nbsp;&nbsp;Client Authentication</a><ul class="auto-toc">
<li><a class="reference internal" href="#user-interactive-authentication-api" id="id75">4.1.1&nbsp;&nbsp;&nbsp;User-Interactive Authentication API</a><ul class="auto-toc">
<li><a class="reference internal" href="#example" id="id76">4.1.1.1&nbsp;&nbsp;&nbsp;Example</a></li>
<li><a class="reference internal" href="#password-based" id="id77">4.1.1.2&nbsp;&nbsp;&nbsp;Password-based</a></li>
<li><a class="reference internal" href="#google-recaptcha" id="id78">4.1.1.3&nbsp;&nbsp;&nbsp;Google ReCaptcha</a></li>
<li><a class="reference internal" href="#token-based" id="id79">4.1.1.4&nbsp;&nbsp;&nbsp;Token-based</a></li>
<li><a class="reference internal" href="#oauth2-based" id="id80">4.1.1.5&nbsp;&nbsp;&nbsp;OAuth2-based</a></li>
<li><a class="reference internal" href="#email-based-identity-server" id="id81">4.1.1.6&nbsp;&nbsp;&nbsp;Email-based (identity server)</a></li>
<li><a class="reference internal" href="#dummy-auth" id="id82">4.1.1.7&nbsp;&nbsp;&nbsp;Dummy Auth</a></li>
<li><a class="reference internal" href="#fallback" id="id83">4.1.1.8&nbsp;&nbsp;&nbsp;Fallback</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api-calls-using-the-user-interactive-authentication-mechanism" id="id84">4.1.2&nbsp;&nbsp;&nbsp;API calls using the User-Interactive Authentication mechanism</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-api-v2-alpha-register" id="id85">4.1.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v2_alpha/register</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-api-v1-login" id="id86">4.1.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v1/login</tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-api-v1-tokenrefresh" id="id87">4.1.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v1/tokenrefresh</tt></a></li>
<li><a class="reference internal" href="#login-fallback" id="id88">4.1.2.4&nbsp;&nbsp;&nbsp;Login Fallback</a></li>
<li><a class="reference internal" href="#changing-password" id="id89">4.1.2.5&nbsp;&nbsp;&nbsp;Changing Password</a></li>
<li><a class="reference internal" href="#adding-account-administrative-contact-information" id="id90">4.1.2.6&nbsp;&nbsp;&nbsp;Adding Account Administrative Contact Information</a></li>
<li><a class="reference internal" href="#fetching-currently-associated-contact-information" id="id91">4.1.2.7&nbsp;&nbsp;&nbsp;Fetching Currently Associated Contact Information</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#pagination" id="id92">4.2&nbsp;&nbsp;&nbsp;Pagination</a><ul class="auto-toc">
<li><a class="reference internal" href="#pagination-request-query-parameters" id="id93">4.2.1&nbsp;&nbsp;&nbsp;Pagination Request Query Parameters</a></li>
<li><a class="reference internal" href="#pagination-response" id="id94">4.2.2&nbsp;&nbsp;&nbsp;Pagination Response</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1" id="id95">4.3&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#types-of-room-events" id="id96">4.3.1&nbsp;&nbsp;&nbsp;Types of room events</a></li>
<li><a class="reference internal" href="#syncing" id="id97">4.3.2&nbsp;&nbsp;&nbsp;Syncing</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-api-v1-events" id="id98">4.3.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/events</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-events-eventid" id="id99">4.3.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/events/{eventId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-initialsync" id="id100">4.3.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/initialSync</tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-v2-alpha-sync" id="id101">4.3.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/v2_alpha/sync</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#getting-events-for-a-room" id="id102">4.3.3&nbsp;&nbsp;&nbsp;Getting events for a room</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-api-v1-rooms-roomid-initialsync" id="id103">4.3.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/initialSync</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-rooms-roomid-members" id="id104">4.3.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/members</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-rooms-roomid-state" id="id105">4.3.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/state</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-rooms-roomid-state-eventtype-statekey" id="id106">4.3.3.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/state/{eventType}/{stateKey}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-rooms-roomid-messages" id="id107">4.3.3.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/messages</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sending-events-to-a-room" id="id108">4.3.4&nbsp;&nbsp;&nbsp;Sending events to a room</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-api-v1-rooms-roomid-state-eventtype-statekey" id="id109">4.3.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/state/{eventType}/{stateKey}</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-api-v1-rooms-roomid-send-eventtype" id="id110">4.3.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/send/{eventType}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-api-v1-rooms-roomid-send-eventtype-txnid" id="id111">4.3.4.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/send/{eventType}/{txnId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#redactions" id="id112">4.3.5&nbsp;&nbsp;&nbsp;Redactions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rooms" id="id113">4.4&nbsp;&nbsp;&nbsp;Rooms</a><ul class="auto-toc">
<li><a class="reference internal" href="#creation" id="id114">4.4.1&nbsp;&nbsp;&nbsp;Creation</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-api-v1-createroom" id="id115">4.4.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v1/createRoom</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id2" id="id116">4.4.2&nbsp;&nbsp;&nbsp;Room aliases</a></li>
<li><a class="reference internal" href="#permissions" id="id117">4.4.3&nbsp;&nbsp;&nbsp;Permissions</a></li>
<li><a class="reference internal" href="#joining-rooms" id="id118">4.4.4&nbsp;&nbsp;&nbsp;Joining rooms</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-api-v1-rooms-roomid-invite" id="id119">4.4.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/invite</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-api-v1-rooms-roomid-join" id="id120">4.4.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/join</span></tt></a></li>
<li><a class="reference internal" href="#post-join-roomid" id="id121">4.4.4.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/join/{roomId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#leaving-rooms" id="id122">4.4.5&nbsp;&nbsp;&nbsp;Leaving rooms</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-api-v1-rooms-roomid-forget" id="id123">4.4.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/forget</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-api-v1-rooms-roomid-leave" id="id124">4.4.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/leave</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#banning-users-in-a-room" id="id125">4.4.6&nbsp;&nbsp;&nbsp;Banning users in a room</a></li>
<li><a class="reference internal" href="#listing-rooms" id="id126">4.4.7&nbsp;&nbsp;&nbsp;Listing rooms</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-api-v1-publicrooms" id="id127">4.4.7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/publicRooms</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id3" id="id128">4.5&nbsp;&nbsp;&nbsp;Profiles</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-api-v1-profile-userid-displayname" id="id129">4.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/profile/{userId}/displayname</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-profile-userid-displayname" id="id130">4.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/profile/{userId}/displayname</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-api-v1-profile-userid-avatar-url" id="id131">4.5.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/profile/{userId}/avatar_url</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-profile-userid-avatar-url" id="id132">4.5.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/profile/{userId}/avatar_url</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-profile-userid" id="id133">4.5.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/profile/{userId}</span></tt></a></li>
<li><a class="reference internal" href="#events-on-change-of-profile-information" id="id134">4.5.6&nbsp;&nbsp;&nbsp;Events on Change of Profile Information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#security" id="id135">4.6&nbsp;&nbsp;&nbsp;Security</a><ul class="auto-toc">
<li><a class="reference internal" href="#rate-limiting" id="id136">4.6.1&nbsp;&nbsp;&nbsp;Rate limiting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#event-structure" id="id137">4.7&nbsp;&nbsp;&nbsp;Event Structure</a><ul class="auto-toc">
<li><a class="reference internal" href="#event-fields" id="id138">4.7.1&nbsp;&nbsp;&nbsp;Event Fields</a></li>
<li><a class="reference internal" href="#room-event-fields" id="id139">4.7.2&nbsp;&nbsp;&nbsp;Room Event Fields</a></li>
<li><a class="reference internal" href="#state-event-fields" id="id140">4.7.3&nbsp;&nbsp;&nbsp;State Event Fields</a></li>
<li><a class="reference internal" href="#differences-between-v1-and-v2-events" id="id141">4.7.4&nbsp;&nbsp;&nbsp;Differences between /v1 and /v2 events</a></li>
<li><a class="reference internal" href="#size-limits" id="id142">4.7.5&nbsp;&nbsp;&nbsp;Size limits</a></li>
<li><a class="reference internal" href="#room-events" id="id143">4.7.6&nbsp;&nbsp;&nbsp;Room Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-aliases" id="id144">4.7.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.aliases</tt></a></li>
<li><a class="reference internal" href="#m-room-canonical-alias" id="id145">4.7.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.canonical_alias</tt></a></li>
<li><a class="reference internal" href="#m-room-create" id="id146">4.7.6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.create</tt></a></li>
<li><a class="reference internal" href="#m-room-join-rules" id="id147">4.7.6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.join_rules</tt></a></li>
<li><a class="reference internal" href="#m-room-member" id="id148">4.7.6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.member</tt></a></li>
<li><a class="reference internal" href="#m-room-power-levels" id="id149">4.7.6.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.power_levels</tt></a></li>
<li><a class="reference internal" href="#m-room-redaction" id="id150">4.7.6.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.redaction</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#signing-events" id="id151">4.8&nbsp;&nbsp;&nbsp;Signing Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#canonical-json" id="id152">4.8.1&nbsp;&nbsp;&nbsp;Canonical JSON</a><ul class="auto-toc">
<li><a class="reference internal" href="#grammar" id="id153">4.8.1.1&nbsp;&nbsp;&nbsp;Grammar</a></li>
</ul>
</li>
<li><a class="reference internal" href="#signing-json" id="id154">4.8.2&nbsp;&nbsp;&nbsp;Signing JSON</a><ul class="auto-toc">
<li><a class="reference internal" href="#signing-details" id="id155">4.8.2.1&nbsp;&nbsp;&nbsp;Signing Details</a></li>
<li><a class="reference internal" href="#checking-for-a-signature" id="id156">4.8.2.2&nbsp;&nbsp;&nbsp;Checking for a Signature</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4" id="id157">4.8.3&nbsp;&nbsp;&nbsp;Signing Events</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#modules" id="id158">5&nbsp;&nbsp;&nbsp;Modules</a><ul class="auto-toc">
<li><a class="reference internal" href="#feature-profiles" id="id159">5.1&nbsp;&nbsp;&nbsp;Feature Profiles</a><ul class="auto-toc">
<li><a class="reference internal" href="#summary" id="id160">5.1.1&nbsp;&nbsp;&nbsp;Summary</a></li>
<li><a class="reference internal" href="#clients" id="id161">5.1.2&nbsp;&nbsp;&nbsp;Clients</a><ul class="auto-toc">
<li><a class="reference internal" href="#stand-alone-web-web" id="id162">5.1.2.1&nbsp;&nbsp;&nbsp;Stand-alone web (<tt class="docutils literal">Web</tt>)</a></li>
<li><a class="reference internal" href="#mobile-mobile" id="id163">5.1.2.2&nbsp;&nbsp;&nbsp;Mobile (<tt class="docutils literal">Mobile</tt>)</a></li>
<li><a class="reference internal" href="#desktop-desktop" id="id164">5.1.2.3&nbsp;&nbsp;&nbsp;Desktop (<tt class="docutils literal">Desktop</tt>)</a></li>
<li><a class="reference internal" href="#command-line-interface-cli" id="id165">5.1.2.4&nbsp;&nbsp;&nbsp;Command Line Interface (<tt class="docutils literal">CLI</tt>)</a></li>
<li><a class="reference internal" href="#embedded-embedded" id="id166">5.1.2.5&nbsp;&nbsp;&nbsp;Embedded (<tt class="docutils literal">Embedded</tt>)</a><ul class="auto-toc">
<li><a class="reference internal" href="#application" id="id167">5.1.2.5.1&nbsp;&nbsp;&nbsp;Application</a></li>
<li><a class="reference internal" href="#device" id="id168">5.1.2.5.2&nbsp;&nbsp;&nbsp;Device</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id5" id="id169">5.2&nbsp;&nbsp;&nbsp;Instant Messaging</a><ul class="auto-toc">
<li><a class="reference internal" href="#id6" id="id170">5.2.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-message" id="id171">5.2.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.message</tt></a></li>
<li><a class="reference internal" href="#m-room-message-feedback" id="id172">5.2.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.message.feedback</tt></a></li>
<li><a class="reference internal" href="#m-room-name" id="id173">5.2.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.name</tt></a></li>
<li><a class="reference internal" href="#m-room-topic" id="id174">5.2.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.topic</tt></a></li>
<li><a class="reference internal" href="#m-room-avatar" id="id175">5.2.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.avatar</tt></a></li>
<li><a class="reference internal" href="#m-room-message-msgtypes" id="id176">5.2.1.6&nbsp;&nbsp;&nbsp;m.room.message msgtypes</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-text" id="id177">5.2.1.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.text</tt></a></li>
<li><a class="reference internal" href="#m-emote" id="id178">5.2.1.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.emote</tt></a></li>
<li><a class="reference internal" href="#m-notice" id="id179">5.2.1.6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.notice</tt></a></li>
<li><a class="reference internal" href="#m-image" id="id180">5.2.1.6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.image</tt></a></li>
<li><a class="reference internal" href="#m-file" id="id181">5.2.1.6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.file</tt></a></li>
<li><a class="reference internal" href="#m-location" id="id182">5.2.1.6.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.location</tt></a></li>
<li><a class="reference internal" href="#m-video" id="id183">5.2.1.6.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.video</tt></a></li>
<li><a class="reference internal" href="#m-audio" id="id184">5.2.1.6.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.audio</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#client-behaviour" id="id185">5.2.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#recommendations-when-sending-messages" id="id186">5.2.2.1&nbsp;&nbsp;&nbsp;Recommendations when sending messages</a></li>
<li><a class="reference internal" href="#local-echo" id="id187">5.2.2.2&nbsp;&nbsp;&nbsp;Local echo</a></li>
<li><a class="reference internal" href="#calculating-the-display-name-for-a-user" id="id188">5.2.2.3&nbsp;&nbsp;&nbsp;Calculating the display name for a user</a></li>
<li><a class="reference internal" href="#displaying-membership-information-with-messages" id="id189">5.2.2.4&nbsp;&nbsp;&nbsp;Displaying membership information with messages</a></li>
<li><a class="reference internal" href="#calculating-the-display-name-for-a-room" id="id190">5.2.2.5&nbsp;&nbsp;&nbsp;Calculating the display name for a room</a></li>
</ul>
</li>
<li><a class="reference internal" href="#server-behaviour" id="id191">5.2.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#security-considerations" id="id192">5.2.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#voice-over-ip" id="id193">5.3&nbsp;&nbsp;&nbsp;Voice over IP</a><ul class="auto-toc">
<li><a class="reference internal" href="#id7" id="id194">5.3.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-call-invite" id="id195">5.3.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.invite</tt></a></li>
<li><a class="reference internal" href="#m-call-candidates" id="id196">5.3.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.candidates</tt></a></li>
<li><a class="reference internal" href="#m-call-answer" id="id197">5.3.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.answer</tt></a></li>
<li><a class="reference internal" href="#m-call-hangup" id="id198">5.3.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.hangup</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8" id="id199">5.3.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#glare" id="id200">5.3.2.1&nbsp;&nbsp;&nbsp;Glare</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9" id="id201">5.3.3&nbsp;&nbsp;&nbsp;Server behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-api-v1-turnserver" id="id202">5.3.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/turnServer</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id10" id="id203">5.3.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11" id="id204">5.4&nbsp;&nbsp;&nbsp;Typing Notifications</a><ul class="auto-toc">
<li><a class="reference internal" href="#id12" id="id205">5.4.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-typing" id="id206">5.4.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.typing</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id13" id="id207">5.4.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-api-v1-rooms-roomid-typing-userid" id="id208">5.4.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/typing/{userId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id14" id="id209">5.4.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id15" id="id210">5.4.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id16" id="id211">5.5&nbsp;&nbsp;&nbsp;Receipts</a><ul class="auto-toc">
<li><a class="reference internal" href="#id17" id="id212">5.5.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-receipt" id="id213">5.5.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.receipt</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id18" id="id214">5.5.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-v2-alpha-rooms-roomid-receipt-receipttype-eventid" id="id215">5.5.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/v2_alpha/rooms/{roomId}/receipt/{receiptType}/{eventId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id19" id="id216">5.5.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id20" id="id217">5.5.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id21" id="id218">5.6&nbsp;&nbsp;&nbsp;Presence</a><ul class="auto-toc">
<li><a class="reference internal" href="#id22" id="id219">5.6.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-presence" id="id220">5.6.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.presence</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id23" id="id221">5.6.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#put-matrix-client-api-v1-presence-userid-status" id="id222">5.6.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/presence/{userId}/status</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-presence-userid-status" id="id223">5.6.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/presence/{userId}/status</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-client-api-v1-presence-list-userid" id="id224">5.6.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/presence/list/{userId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-presence-list-userid" id="id225">5.6.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/presence/list/{userId}</span></tt></a></li>
<li><a class="reference internal" href="#idle-timeout" id="id226">5.6.2.5&nbsp;&nbsp;&nbsp;Idle timeout</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id24" id="id227">5.6.3&nbsp;&nbsp;&nbsp;Server behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#propagating-profile-information" id="id228">5.6.3.1&nbsp;&nbsp;&nbsp;Propagating profile information</a></li>
<li><a class="reference internal" href="#last-active-ago" id="id229">5.6.3.2&nbsp;&nbsp;&nbsp;Last active ago</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id25" id="id230">5.6.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id26" id="id231">5.7&nbsp;&nbsp;&nbsp;Content repository</a><ul class="auto-toc">
<li><a class="reference internal" href="#id27" id="id232">5.7.1&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-media-v1-download-servername-mediaid" id="id233">5.7.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/media/v1/download/{serverName}/{mediaId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-media-v1-thumbnail-servername-mediaid" id="id234">5.7.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/media/v1/thumbnail/{serverName}/{mediaId}</span></tt></a></li>
<li><a class="reference internal" href="#post-matrix-media-v1-upload" id="id235">5.7.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/media/v1/upload</tt></a></li>
<li><a class="reference internal" href="#thumbnails" id="id236">5.7.1.4&nbsp;&nbsp;&nbsp;Thumbnails</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id28" id="id237">5.7.2&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id29" id="id238">5.7.3&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id30" id="id239">5.8&nbsp;&nbsp;&nbsp;End-to-End Encryption</a></li>
<li><a class="reference internal" href="#room-history-visibility" id="id240">5.9&nbsp;&nbsp;&nbsp;Room History Visibility</a><ul class="auto-toc">
<li><a class="reference internal" href="#id31" id="id241">5.9.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-history-visibility" id="id242">5.9.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.history_visibility</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id32" id="id243">5.9.2&nbsp;&nbsp;&nbsp;Client behaviour</a></li>
<li><a class="reference internal" href="#id33" id="id244">5.9.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id34" id="id245">5.9.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id35" id="id246">5.10&nbsp;&nbsp;&nbsp;Push Notifications</a><ul class="auto-toc">
<li><a class="reference internal" href="#id36" id="id247">5.10.1&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-api-v1-pushers-set" id="id248">5.10.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v1/pushers/set</tt></a></li>
<li><a class="reference internal" href="#push-rules" id="id249">5.10.1.2&nbsp;&nbsp;&nbsp;Push Rules</a><ul class="auto-toc">
<li><a class="reference internal" href="#actions" id="id250">5.10.1.2.1&nbsp;&nbsp;&nbsp;Actions</a><ul class="auto-toc">
<li><a class="reference internal" href="#tweaks" id="id251">5.10.1.2.1.1&nbsp;&nbsp;&nbsp;Tweaks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#predefined-rules" id="id252">5.10.1.2.2&nbsp;&nbsp;&nbsp;Predefined Rules</a></li>
<li><a class="reference internal" href="#conditions" id="id253">5.10.1.2.3&nbsp;&nbsp;&nbsp;Conditions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#push-rules-api" id="id254">5.10.1.3&nbsp;&nbsp;&nbsp;Push Rules: API</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-client-api-v1-pushrules" id="id255">5.10.1.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/pushrules/</tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-api-v1-pushrules-scope-kind-ruleid" id="id256">5.10.1.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></li>
<li><a class="reference internal" href="#get-matrix-client-api-v1-pushrules-scope-kind-ruleid" id="id257">5.10.1.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></li>
<li><a class="reference internal" href="#delete-matrix-client-api-v1-pushrules-scope-kind-ruleid" id="id258">5.10.1.3.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">DELETE <span class="pre">/_matrix/client/api/v1/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></li>
<li><a class="reference internal" href="#put-matrix-client-api-v1-pushrules-scope-kind-ruleid-enabled" id="id259">5.10.1.3.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/pushrules/{scope}/{kind}/{ruleId}/enabled</span></tt></a></li>
<li><a class="reference internal" href="#examples" id="id260">5.10.1.3.6&nbsp;&nbsp;&nbsp;Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id37" id="id261">5.10.2&nbsp;&nbsp;&nbsp;Server behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-push-v1-notify" id="id262">5.10.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/push/v1/notify</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#push-gateway-behaviour" id="id263">5.10.3&nbsp;&nbsp;&nbsp;Push Gateway behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#recommendations-for-apns" id="id264">5.10.3.1&nbsp;&nbsp;&nbsp;Recommendations for APNS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id38" id="id265">5.10.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#third-party-invites" id="id266">5.11&nbsp;&nbsp;&nbsp;Third party invites</a><ul class="auto-toc">
<li><a class="reference internal" href="#id39" id="id267">5.11.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-third-party-invite" id="id268">5.11.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.third_party_invite</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id40" id="id269">5.11.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#id41" id="id270">5.11.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/invite</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id42" id="id271">5.11.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id43" id="id272">5.11.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id44" id="id273">5.12&nbsp;&nbsp;&nbsp;Server Side Search</a><ul class="auto-toc">
<li><a class="reference internal" href="#id45" id="id274">5.12.1&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#post-matrix-client-api-v1-search" id="id275">5.12.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v1/search</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#search-categories" id="id276">5.12.2&nbsp;&nbsp;&nbsp;Search Categories</a><ul class="auto-toc">
<li><a class="reference internal" href="#id46" id="id277">5.12.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">room_events</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id47" id="id278">5.12.3&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#guest-access" id="id279">5.13&nbsp;&nbsp;&nbsp;Guest access</a><ul class="auto-toc">
<li><a class="reference internal" href="#id48" id="id280">5.13.1&nbsp;&nbsp;&nbsp;Events</a><ul class="auto-toc">
<li><a class="reference internal" href="#m-room-guest-access" id="id281">5.13.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.guest_access</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id49" id="id282">5.13.2&nbsp;&nbsp;&nbsp;Client behaviour</a><ul class="auto-toc">
<li><a class="reference internal" href="#id50" id="id283">5.13.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/events</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id51" id="id284">5.13.3&nbsp;&nbsp;&nbsp;Server behaviour</a></li>
<li><a class="reference internal" href="#id52" id="id285">5.13.4&nbsp;&nbsp;&nbsp;Security considerations</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#application-service-api" id="id286">6&nbsp;&nbsp;&nbsp;Application Service API</a><ul class="auto-toc">
<li><a class="reference internal" href="#application-services" id="id287">6.1&nbsp;&nbsp;&nbsp;Application Services</a><ul class="auto-toc">
<li><a class="reference internal" href="#registration" id="id288">6.1.1&nbsp;&nbsp;&nbsp;Registration</a></li>
<li><a class="reference internal" href="#home-server-application-service-api" id="id289">6.1.2&nbsp;&nbsp;&nbsp;Home Server -&gt; Application Service API</a><ul class="auto-toc">
<li><a class="reference internal" href="#pushing-events" id="id290">6.1.2.1&nbsp;&nbsp;&nbsp;Pushing events</a></li>
<li><a class="reference internal" href="#querying" id="id291">6.1.2.2&nbsp;&nbsp;&nbsp;Querying</a></li>
<li><a class="reference internal" href="#http-apis" id="id292">6.1.2.3&nbsp;&nbsp;&nbsp;HTTP APIs</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-rooms-roomalias" id="id293">6.1.2.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/rooms/{roomAlias}</span></tt></a></li>
<li><a class="reference internal" href="#put-transactions-txnid" id="id294">6.1.2.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/transactions/{txnId}</span></tt></a></li>
<li><a class="reference internal" href="#get-users-userid" id="id295">6.1.2.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/users/{userId}</span></tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#client-server-v2-api-extensions" id="id296">6.1.3&nbsp;&nbsp;&nbsp;Client-Server v2 API Extensions</a><ul class="auto-toc">
<li><a class="reference internal" href="#identity-assertion" id="id297">6.1.3.1&nbsp;&nbsp;&nbsp;Identity assertion</a></li>
<li><a class="reference internal" href="#timestamp-massaging" id="id298">6.1.3.2&nbsp;&nbsp;&nbsp;Timestamp massaging</a></li>
<li><a class="reference internal" href="#server-admin-style-permissions" id="id299">6.1.3.3&nbsp;&nbsp;&nbsp;Server admin style permissions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id-conventions" id="id300">6.1.4&nbsp;&nbsp;&nbsp;ID conventions</a><ul class="auto-toc">
<li><a class="reference internal" href="#user-ids" id="id301">6.1.4.1&nbsp;&nbsp;&nbsp;User IDs</a></li>
<li><a class="reference internal" href="#id53" id="id302">6.1.4.2&nbsp;&nbsp;&nbsp;Room Aliases</a></li>
<li><a class="reference internal" href="#id54" id="id303">6.1.4.3&nbsp;&nbsp;&nbsp;Event fields</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#federation-api" id="id304">7&nbsp;&nbsp;&nbsp;Federation API</a><ul class="auto-toc">
<li><a class="reference internal" href="#server-discovery" id="id305">7.1&nbsp;&nbsp;&nbsp;Server Discovery</a><ul class="auto-toc">
<li><a class="reference internal" href="#resolving-server-names" id="id306">7.1.1&nbsp;&nbsp;&nbsp;Resolving Server Names</a></li>
<li><a class="reference internal" href="#retrieving-server-keys" id="id307">7.1.2&nbsp;&nbsp;&nbsp;Retrieving Server Keys</a><ul class="auto-toc">
<li><a class="reference internal" href="#version-2" id="id308">7.1.2.1&nbsp;&nbsp;&nbsp;Version 2</a><ul class="auto-toc">
<li><a class="reference internal" href="#publishing-keys" id="id309">7.1.2.1.1&nbsp;&nbsp;&nbsp;Publishing Keys</a></li>
<li><a class="reference internal" href="#querying-keys-through-another-server" id="id310">7.1.2.1.2&nbsp;&nbsp;&nbsp;Querying Keys Through Another Server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#version-1" id="id311">7.1.2.2&nbsp;&nbsp;&nbsp;Version 1</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#transactions" id="id312">7.2&nbsp;&nbsp;&nbsp;Transactions</a><ul class="auto-toc">
<li><a class="reference internal" href="#transaction-fields" id="id313">7.2.1&nbsp;&nbsp;&nbsp;Transaction Fields</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pdus" id="id314">7.3&nbsp;&nbsp;&nbsp;PDUs</a><ul class="auto-toc">
<li><a class="reference internal" href="#required-pdu-fields" id="id315">7.3.1&nbsp;&nbsp;&nbsp;Required PDU Fields</a></li>
<li><a class="reference internal" href="#state-update-pdu-fields" id="id316">7.3.2&nbsp;&nbsp;&nbsp;State Update PDU Fields</a></li>
</ul>
</li>
<li><a class="reference internal" href="#edus" id="id317">7.4&nbsp;&nbsp;&nbsp;EDUs</a></li>
<li><a class="reference internal" href="#protocol-urls" id="id318">7.5&nbsp;&nbsp;&nbsp;Protocol URLs</a></li>
<li><a class="reference internal" href="#id55" id="id319">7.6&nbsp;&nbsp;&nbsp;Joining Rooms</a></li>
<li><a class="reference internal" href="#backfilling" id="id320">7.7&nbsp;&nbsp;&nbsp;Backfilling</a></li>
<li><a class="reference internal" href="#authentication" id="id321">7.8&nbsp;&nbsp;&nbsp;Authentication</a><ul class="auto-toc">
<li><a class="reference internal" href="#request-authentication" id="id322">7.8.1&nbsp;&nbsp;&nbsp;Request Authentication</a></li>
<li><a class="reference internal" href="#response-authentication" id="id323">7.8.2&nbsp;&nbsp;&nbsp;Response Authentication</a></li>
<li><a class="reference internal" href="#client-tls-certificates" id="id324">7.8.3&nbsp;&nbsp;&nbsp;Client TLS Certificates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#server-server-authorization" id="id325">7.9&nbsp;&nbsp;&nbsp;Server-Server Authorization</a></li>
<li><a class="reference internal" href="#state-conflict-resolution" id="id326">7.10&nbsp;&nbsp;&nbsp;State Conflict Resolution</a></li>
<li><a class="reference internal" href="#id56" id="id327">7.11&nbsp;&nbsp;&nbsp;Presence</a></li>
<li><a class="reference internal" href="#id57" id="id328">7.12&nbsp;&nbsp;&nbsp;Profiles</a></li>
<li><a class="reference internal" href="#directory" id="id329">7.13&nbsp;&nbsp;&nbsp;Directory</a></li>
</ul>
</li>
<li><a class="reference internal" href="#identity-servers" id="id330">8&nbsp;&nbsp;&nbsp;Identity Servers</a></li>
<li><a class="reference internal" href="#appendices" id="id331">9&nbsp;&nbsp;&nbsp;Appendices</a><ul class="auto-toc">
<li><a class="reference internal" href="#security-threat-model" id="id332">9.1&nbsp;&nbsp;&nbsp;Security Threat Model</a><ul class="auto-toc">
<li><a class="reference internal" href="#denial-of-service" id="id333">9.1.1&nbsp;&nbsp;&nbsp;Denial of Service</a><ul class="auto-toc">
<li><a class="reference internal" href="#threat-resource-exhaustion" id="id334">9.1.1.1&nbsp;&nbsp;&nbsp;Threat: Resource Exhaustion</a></li>
<li><a class="reference internal" href="#threat-unrecoverable-consistency-violations" id="id335">9.1.1.2&nbsp;&nbsp;&nbsp;Threat: Unrecoverable Consistency Violations</a></li>
<li><a class="reference internal" href="#threat-bad-history" id="id336">9.1.1.3&nbsp;&nbsp;&nbsp;Threat: Bad History</a></li>
<li><a class="reference internal" href="#threat-block-network-traffic" id="id337">9.1.1.4&nbsp;&nbsp;&nbsp;Threat: Block Network Traffic</a></li>
<li><a class="reference internal" href="#threat-high-volume-of-messages" id="id338">9.1.1.5&nbsp;&nbsp;&nbsp;Threat: High Volume of Messages</a></li>
<li><a class="reference internal" href="#threat-banning-users-without-necessary-authorisation" id="id339">9.1.1.6&nbsp;&nbsp;&nbsp;Threat: Banning users without necessary authorisation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spoofing" id="id340">9.1.2&nbsp;&nbsp;&nbsp;Spoofing</a><ul class="auto-toc">
<li><a class="reference internal" href="#threat-altering-message-contents" id="id341">9.1.2.1&nbsp;&nbsp;&nbsp;Threat: Altering Message Contents</a></li>
<li><a class="reference internal" href="#threat-fake-message-origin-field" id="id342">9.1.2.2&nbsp;&nbsp;&nbsp;Threat: Fake Message &quot;origin&quot; Field</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spamming" id="id343">9.1.3&nbsp;&nbsp;&nbsp;Spamming</a><ul class="auto-toc">
<li><a class="reference internal" href="#threat-unsolicited-messages" id="id344">9.1.3.1&nbsp;&nbsp;&nbsp;Threat: Unsolicited Messages</a></li>
<li><a class="reference internal" href="#threat-abusive-messages" id="id345">9.1.3.2&nbsp;&nbsp;&nbsp;Threat: Abusive Messages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spying" id="id346">9.1.4&nbsp;&nbsp;&nbsp;Spying</a><ul class="auto-toc">
<li><a class="reference internal" href="#threat-disclosure-during-transmission" id="id347">9.1.4.1&nbsp;&nbsp;&nbsp;Threat: Disclosure during Transmission</a></li>
<li><a class="reference internal" href="#threat-disclosure-to-servers-outside-chatroom" id="id348">9.1.4.2&nbsp;&nbsp;&nbsp;Threat: Disclosure to Servers Outside Chatroom</a></li>
</ul>
</li>
<li><a class="reference internal" href="#threat-disclosure-to-servers-within-chatroom" id="id349">9.1.5&nbsp;&nbsp;&nbsp;Threat: Disclosure to Servers Within Chatroom</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cryptographic-test-vectors" id="id350">9.2&nbsp;&nbsp;&nbsp;Cryptographic Test Vectors</a><ul class="auto-toc">
<li><a class="reference internal" href="#signing-key" id="id351">9.2.1&nbsp;&nbsp;&nbsp;Signing Key</a></li>
<li><a class="reference internal" href="#json-signing" id="id352">9.2.2&nbsp;&nbsp;&nbsp;JSON Signing</a></li>
<li><a class="reference internal" href="#event-signing" id="id353">9.2.3&nbsp;&nbsp;&nbsp;Event Signing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>
<p><a class="anchor" id="introduction"></a></p>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#id61">2&nbsp;&nbsp;&nbsp;Introduction</a></h1>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">The Matrix specification is still evolving: the APIs are not yet frozen
and this document is in places a work in progress or stale. We have made every
effort to clearly flag areas which are still being finalised.
We're publishing it at this point because it's complete enough to be more than
useful and provide a canonical reference to how Matrix is evolving. Our end
goal is to mirror WHATWG's <a class="reference external" href="http://wiki.whatwg.org/wiki/FAQ#What_does_.22Living_Standard.22_mean.3F">Living Standard</a>.</p>
</div>
<p>Matrix is a set of open APIs for open-federated Instant Messaging (IM), Voice
over IP (VoIP) and Internet of Things (IoT) communication, designed to create
and support a new global real-time communication ecosystem. The intention is to
provide an open decentralised pubsub layer for the internet for securely
persisting and publishing/subscribing JSON objects. This specification is the
ongoing result of standardising the APIs used by the various components of the
Matrix ecosystem to communicate with one another.</p>
<p>The principles that Matrix attempts to follow are:</p>
<ul class="simple">
<li>Pragmatic Web-friendly APIs (i.e. JSON over REST)</li>
<li>Keep It Simple &amp; Stupid<ul>
<li>provide a simple architecture with minimal third-party dependencies.</li>
</ul>
</li>
<li>Fully open:<ul>
<li>Fully open federation - anyone should be able to participate in the global
Matrix network</li>
<li>Fully open standard - publicly documented standard with no IP or patent
licensing encumbrances</li>
<li>Fully open source reference implementation - liberally-licensed example
implementations with no IP or patent licensing encumbrances</li>
</ul>
</li>
<li>Empowering the end-user<ul>
<li>The user should be able to choose the server and clients they use</li>
<li>The user should be control how private their communication is</li>
<li>The user should know precisely where their data is stored</li>
</ul>
</li>
<li>Fully decentralised - no single points of control over conversations or the
network as a whole</li>
<li>Learning from history to avoid repeating it<ul>
<li>Trying to take the best aspects of XMPP, SIP, IRC, SMTP, IMAP and NNTP
whilst trying to avoid their failings</li>
</ul>
</li>
</ul>
<p>The functionality that Matrix provides includes:</p>
<ul class="simple">
<li>Creation and management of fully distributed chat rooms with no
single points of control or failure</li>
<li>Eventually-consistent cryptographically secure synchronisation of room
state across a global open network of federated servers and services</li>
<li>Sending and receiving extensible messages in a room with (optional)
end-to-end encryption</li>
<li>Extensible user management (inviting, joining, leaving, kicking, banning)
mediated by a power-level based user privilege system.</li>
<li>Extensible room state management (room naming, aliasing, topics, bans)</li>
<li>Extensible user profile management (avatars, display names, etc)</li>
<li>Managing user accounts (registration, login, logout)</li>
<li>Use of 3rd Party IDs (3PIDs) such as email addresses, phone numbers,
Facebook accounts to authenticate, identify and discover users on Matrix.</li>
<li>Trusted federation of Identity servers for:<ul>
<li>Publishing user public keys for PKI</li>
<li>Mapping of 3PIDs to Matrix IDs</li>
</ul>
</li>
</ul>
<p>The end goal of Matrix is to be a ubiquitous messaging layer for synchronising
arbitrary data between sets of people, devices and services - be that for
instant messages, VoIP call setups, or any other objects that need to be
reliably and persistently pushed from A to B in an inter-operable and federated
manner.</p>
</div>
<p><a class="anchor" id="overview"></a></p>
<div class="section" id="overview">
<h1><a class="toc-backref" href="#id62">3&nbsp;&nbsp;&nbsp;Overview</a></h1>
<p><a class="anchor" id="architecture"></a></p>
<div class="section" id="architecture">
<h2><a class="toc-backref" href="#id63">3.1&nbsp;&nbsp;&nbsp;Architecture</a></h2>
<p>Matrix defines APIs for synchronising extensible JSON objects known as
&quot;events&quot; between compatible clients, servers and services. Clients are
typically messaging/VoIP applications or IoT devices/hubs and communicate by
synchronising communication history with their &quot;homeserver&quot; using the
&quot;Client-Server API&quot;. Each homeserver stores the communication history and
account information for all of its clients, and shares data with the wider
Matrix ecosystem by synchronising communication history with other homeservers
and their clients.</p>
<p>Clients typically communicate with each other by emitting events in the
context of a virtual &quot;room&quot;. Room data is replicated across <em>all of the
homeservers</em> whose users are participating in a given room. As such, <em>no
single homeserver has control or ownership over a given room</em>. Homeservers
model communication history as a partially ordered graph of events known as
the room's &quot;event graph&quot;, which is synchronised with eventual consistency
between the participating servers using the &quot;Server-Server API&quot;. This process
of synchronising shared conversation history between homeservers run by
different parties is called &quot;Federation&quot;. Matrix optimises for the the
Availability and Partitioned properties of CAP theorem at
the expense of Consistency.</p>
<p>For example, for client A to send a message to client B, client A performs an
HTTP PUT of the required JSON event on its homeserver (HS) using the
client-server API. A's HS appends this event to its copy of the room's event
graph, signing the message in the context of the graph for integrity. A's HS
then replicates the message to B's HS by performing an HTTP PUT using the
server-server API. B's HS authenticates the request, validates the event's
signature, authorises the event's contents and then adds it to its copy of the
room's event graph. Client B then receives the message from his homeserver via
a long-lived GET request.</p>
<pre class="literal-block">
                  How data flows between clients
                  ==============================

{ Matrix client A }                             { Matrix client B }
    ^          |                                    ^          |
    |  events  |  Client-Server API                 |  events  |
    |          V                                    |          V
+------------------+                            +------------------+
|                  |---------( HTTPS )---------&gt;|                  |
|   Home Server    |                            |   Home Server    |
|                  |&lt;--------( HTTPS )----------|                  |
+------------------+      Server-Server API     +------------------+
                       History Synchronisation
                           (Federation)
</pre>
<p><a class="anchor" id="users"></a></p>
<div class="section" id="users">
<h3><a class="toc-backref" href="#id64">3.1.1&nbsp;&nbsp;&nbsp;Users</a></h3>
<p>Each client is associated with a user account, which is identified in Matrix
using a unique &quot;User ID&quot;. This ID is namespaced to the homeserver which
allocated the account and has the form:</p>
<pre class="literal-block">
&#64;localpart:domain
</pre>
<p>The <tt class="docutils literal">localpart</tt> of a user ID may be a user name, or an opaque ID identifying
this user. The <tt class="docutils literal">domain</tt> of a user ID is the domain of the homeserver.</p>
<!-- TODO-spec
- Need to specify precise grammar for Matrix IDs -->
</div>
<p><a class="anchor" id="events"></a></p>
<div class="section" id="events">
<h3><a class="toc-backref" href="#id65">3.1.2&nbsp;&nbsp;&nbsp;Events</a></h3>
<p>All data exchanged over Matrix is expressed as an &quot;event&quot;. Typically each client
action (e.g. sending a message) correlates with exactly one event. Each event
has a <tt class="docutils literal">type</tt> which is used to differentiate different kinds of data. <tt class="docutils literal">type</tt>
values MUST be uniquely globally namespaced following Java's <a class="reference external" href="https://en.wikipedia.org/wiki/Java_package#Package_naming_conventions">package naming
conventions</a>, e.g.
<tt class="docutils literal">com.example.myapp.event</tt>. The special top-level namespace <tt class="docutils literal">m.</tt> is reserved
for events defined in the Matrix specification - for instance <tt class="docutils literal">m.room.message</tt>
is the event type for instant messages. Events are usually sent in the context
of a &quot;Room&quot;.</p>
</div>
<p><a class="anchor" id="event-graphs"></a></p>
<div class="section" id="event-graphs">
<h3><a class="toc-backref" href="#id66">3.1.3&nbsp;&nbsp;&nbsp;Event Graphs</a></h3>
<p id="sect-event-graph">Events exchanged in the context of a room are stored in a directed acyclic graph
(DAG) called an &quot;event graph&quot;. The partial ordering of this graph gives the
chronological ordering of events within the room. Each event in the graph has a
list of zero or more &quot;parent&quot; events, which refer to any preceding events
which have no chronological successor from the perspective of the homeserver
which created the event.</p>
<p>Typically an event has a single parent: the most recent message in the room at
the point it was sent. However, homeservers may legitimately race with each
other when sending messages, resulting in a single event having multiple
successors. The next event added to the graph thus will have multiple parents.
Every event graph has a single root event with no parent.</p>
<p>To order and ease chronological comparison between the events within the graph,
homeservers maintain a <tt class="docutils literal">depth</tt> metadata field on each event. An event's
<tt class="docutils literal">depth</tt> is a positive integer that is strictly greater than the depths of any
of its parents. The root event should have a depth of 1. Thus if one event is
before another, then it must have a strictly smaller depth.</p>
</div>
<p><a class="anchor" id="room-structure"></a></p>
<div class="section" id="room-structure">
<h3><a class="toc-backref" href="#id67">3.1.4&nbsp;&nbsp;&nbsp;Room structure</a></h3>
<p>A room is a conceptual place where users can send and receive events. Events are
sent to a room, and all participants in that room with sufficient access will
receive the event. Rooms are uniquely identified internally via &quot;Room IDs&quot;,
which have the form:</p>
<pre class="literal-block">
!opaque_id:domain
</pre>
<p>There is exactly one room ID for each room. Whilst the room ID does contain a
domain, it is simply for globally namespacing room IDs. The room does NOT
reside on the domain specified. Room IDs are not meant to be human readable.
They are case-sensitive. The following conceptual diagram shows an
<tt class="docutils literal">m.room.message</tt> event being sent to the room <tt class="docutils literal">!qporfwt:matrix.org</tt>:</p>
<pre class="literal-block">
 { &#64;alice:matrix.org }                             { &#64;bob:domain.com }
         |                                                 ^
         |                                                 |
[HTTP POST]                                  [HTTP GET]
Room ID: !qporfwt:matrix.org                 Room ID: !qporfwt:matrix.org
Event type: m.room.message                   Event type: m.room.message
Content: { JSON object }                     Content: { JSON object }
         |                                                 |
         V                                                 |
 +------------------+                          +------------------+
 |   Home Server    |                          |   Home Server    |
 |   matrix.org     |                          |   domain.com     |
 +------------------+                          +------------------+
         |                                                 ^
         |         [HTTP PUT]                              |
         |         Room ID: !qporfwt:matrix.org            |
         |         Event type: m.room.message              |
         |         Content: { JSON object }                |
         `-------&gt; Pointer to the preceding message  ------`
                   PKI signature from matrix.org
                   Transaction-layer metadata
                   PKI Authorization header

               ...................................
              |           Shared Data             |
              | State:                            |
              |   Room ID: !qporfwt:matrix.org    |
              |   Servers: matrix.org, domain.com |
              |   Members:                        |
              |    - &#64;alice:matrix.org            |
              |    - &#64;bob:domain.com              |
              | Messages:                         |
              |   - &#64;alice:matrix.org             |
              |     Content: { JSON object }      |
              |...................................|
</pre>
<p>Federation maintains <em>shared data structures</em> per-room between multiple home
servers. The data is split into <tt class="docutils literal">message events</tt> and <tt class="docutils literal">state events</tt>.</p>
<dl class="docutils">
<dt>Message events:</dt>
<dd>These describe transient 'once-off' activity in a room such as an
instant messages, VoIP call setups, file transfers, etc. They generally
describe communication activity.</dd>
<dt>State events:</dt>
<dd>These describe updates to a given piece of persistent information
('state') related to a room, such as the room's name, topic, membership,
participating servers, etc. State is modelled as a lookup table of key/value
pairs per room, with each key being a tuple of <tt class="docutils literal">state_key</tt> and <tt class="docutils literal">event type</tt>.
Each state event updates the value of a given key.</dd>
</dl>
<p>The state of the room at a given point is calculated by considering all events
preceding and including a given event in the graph. Where events describe the
same state, a merge conflict algorithm is applied. The state resolution
algorithm is transitive and does not depend on server state, as it must
consistently select the same event irrespective of the server or the order the
events were received in. Events are signed by the originating server (the
signature includes the parent relations, type, depth and payload hash) and are
pushed over federation to the participating servers in a room, currently using
full mesh topology. Servers may also request backfill of events over federation
from the other servers participating in a room.</p>
<p><a class="anchor" id="room-aliases"></a></p>
<div class="section" id="room-aliases">
<h4><a class="toc-backref" href="#id68">3.1.4.1&nbsp;&nbsp;&nbsp;Room Aliases</a></h4>
<p>Each room can also have multiple &quot;Room Aliases&quot;, which look like:</p>
<pre class="literal-block">
#room_alias:domain
</pre>
<!-- TODO
- Need to specify precise grammar for Room Aliases -->
<p>A room alias &quot;points&quot; to a room ID and is the human-readable label by which
rooms are publicised and discovered.  The room ID the alias is pointing to can
be obtained by visiting the domain specified. Note that the mapping from a room
alias to a room ID is not fixed, and may change over time to point to a
different room ID. For this reason, Clients SHOULD resolve the room alias to a
room ID once and then use that ID on subsequent requests. Room aliases MUST NOT
exceed 255 bytes (including the domain).</p>
<p>When resolving a room alias the server will also respond with a list of servers
that are in the room that can be used to join via.</p>
<pre class="literal-block">
     HTTP GET
#matrix:domain.com      !aaabaa:matrix.org
        |                    ^
        |                    |
 _______V____________________|____
|          domain.com            |
| Mappings:                      |
| #matrix &gt;&gt; !aaabaa:matrix.org  |
| #golf   &gt;&gt; !wfeiofh:sport.com  |
| #bike   &gt;&gt; !4rguxf:matrix.org  |
|________________________________|
</pre>
</div>
</div>
<p><a class="anchor" id="identity"></a></p>
<div class="section" id="identity">
<h3><a class="toc-backref" href="#id69">3.1.5&nbsp;&nbsp;&nbsp;Identity</a></h3>
<p>Users in Matrix are identified via their matrix user ID (MXID). However,
existing 3rd party ID namespaces can also be used in order to identify Matrix
users. A Matrix &quot;Identity&quot; describes both the user ID and any other existing IDs
from third party namespaces <em>linked</em> to their account.
Matrix users can <em>link</em> third-party IDs (3PIDs) such as email addresses, social
network accounts and phone numbers to their user ID. Linking 3PIDs creates a
mapping from a 3PID to a user ID. This mapping can then be used by Matrix
users in order to discover the MXIDs of their contacts.
In order to ensure that the mapping from 3PID to user ID is genuine, a globally
federated cluster of trusted &quot;Identity Servers&quot; (IS) are used to verify the 3PID
and persist and replicate the mappings.</p>
<p>Usage of an IS is not required in order for a client application to be part of
the Matrix ecosystem. However, without one clients will not be able to look up
user IDs using 3PIDs.</p>
</div>
<p><a class="anchor" id="profiles"></a></p>
<div class="section" id="profiles">
<h3><a class="toc-backref" href="#id70">3.1.6&nbsp;&nbsp;&nbsp;Profiles</a></h3>
<p>Users may publish arbitrary key/value data associated with their account - such
as a human readable display name, a profile photo URL, contact information
(email address, phone numbers, website URLs etc).</p>
<!-- TODO
Actually specify the different types of data - e.g. what format are display
names allowed to be? -->
</div>
<p><a class="anchor" id="private-user-data"></a></p>
<div class="section" id="private-user-data">
<h3><a class="toc-backref" href="#id71">3.1.7&nbsp;&nbsp;&nbsp;Private User Data</a></h3>
<p>Users may also store arbitrary private key/value data in their account - such as
client preferences, or server configuration settings which lack any other
dedicated API.  The API is symmetrical to managing Profile data.</p>
<!-- TODO
Would it really be overengineered to use the same API for both profile &
private user data, but with different ACLs? -->
</div>
</div>
<p><a class="anchor" id="api-standards"></a></p>
<div class="section" id="api-standards">
<h2><a class="toc-backref" href="#id72">3.2&nbsp;&nbsp;&nbsp;API Standards</a></h2>
<!-- TODO
Need to specify any HMAC or access_token lifetime/ratcheting tricks
We need to specify capability negotiation for extensible transports -->
<p>The mandatory baseline for communication in Matrix is exchanging JSON objects
over HTTP APIs. HTTPS is mandated as the baseline for server-server
(federation) communication.  HTTPS is recommended for client-server
communication, although HTTP may be supported as a fallback to support basic
HTTP clients. More efficient optional transports for client-server
communication will in future be supported as optional extensions - e.g. a
packed binary encoding over stream-cipher encrypted TCP socket for
low-bandwidth/low-roundtrip mobile usage. For the default HTTP transport, all
API calls use a Content-Type of <tt class="docutils literal">application/json</tt>.  In addition, all strings
MUST be encoded as UTF-8. Clients are authenticated using opaque
<tt class="docutils literal">access_token</tt> strings (see <a class="reference internal" href="#client-authentication">Client Authentication</a> for details), passed as a
query string parameter on all requests.</p>
<p>Any errors which occur at the Matrix API level MUST return a &quot;standard error
response&quot;. This is a JSON object which looks like:</p>
<pre class="literal-block">
{
  &quot;errcode&quot;: &quot;&lt;error code&gt;&quot;,
  &quot;error&quot;: &quot;&lt;error message&gt;&quot;
}
</pre>
<p>The <tt class="docutils literal">error</tt> string will be a human-readable error message, usually a sentence
explaining what went wrong. The <tt class="docutils literal">errcode</tt> string will be a unique string
which can be used to handle an error message e.g. <tt class="docutils literal">M_FORBIDDEN</tt>. These error
codes should have their namespace first in ALL CAPS, followed by a single _ to
ease separating the namespace from the error code. For example, if there was a
custom namespace <tt class="docutils literal">com.mydomain.here</tt>, and a
<tt class="docutils literal">FORBIDDEN</tt> code, the error code should look like
<tt class="docutils literal">COM.MYDOMAIN.HERE_FORBIDDEN</tt>. There may be additional keys depending on the
error, but the keys <tt class="docutils literal">error</tt> and <tt class="docutils literal">errcode</tt> MUST always be present.</p>
<p>Some standard error codes are below:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name"><tt class="docutils literal">M_FORBIDDEN</tt>:</th><td class="field-body">Forbidden access, e.g. joining a room without permission, failed login.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_UNKNOWN_TOKEN</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">The access token specified was not recognised.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_BAD_JSON</tt>:</th><td class="field-body">Request contained valid JSON, but it was malformed in some way, e.g. missing
required keys, invalid values for keys.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_NOT_JSON</tt>:</th><td class="field-body">Request did not contain valid JSON.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_NOT_FOUND</tt>:</th><td class="field-body">No resource was found for this request.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_LIMIT_EXCEEDED</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">Too many requests have been sent in a short period of time. Wait a while then
try again.</td>
</tr>
</tbody>
</table>
<p>Some requests have unique error codes:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name"><tt class="docutils literal">M_USER_IN_USE</tt>:</th><td class="field-body">Encountered when trying to register a user ID which has been taken.</td>
</tr>
<tr class="field"><th class="field-name"><tt class="docutils literal">M_ROOM_IN_USE</tt>:</th><td class="field-body">Encountered when trying to create a room which has been taken.</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><tt class="docutils literal">M_BAD_PAGINATION</tt>:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">Encountered when specifying bad pagination query parameters.</td>
</tr>
</tbody>
</table>
<p id="sect-txn-ids">The Client-Server API typically uses <tt class="docutils literal">HTTP POST</tt> to submit requests. This
means these requests are not idempotent. The C-S API also allows <tt class="docutils literal">HTTP PUT</tt> to
make requests idempotent. In order to use a <tt class="docutils literal">PUT</tt>, paths should be suffixed
with <tt class="docutils literal">/{txnId}</tt>. <tt class="docutils literal">{txnId}</tt> is a unique client-generated transaction ID which
identifies the request, and is scoped to a given Client (identified by that
client's <tt class="docutils literal">access_token</tt>). Crucially, it <strong>only</strong> serves to identify new
requests from retransmits. After the request has finished, the <tt class="docutils literal">{txnId}</tt>
value should be changed (how is not specified; a monotonically increasing
integer is recommended). It is preferable to use <tt class="docutils literal">HTTP PUT</tt> to make sure
requests to send messages do not get sent more than once should clients need to
retransmit requests.</p>
<p>Valid requests look like:</p>
<pre class="literal-block">
POST /some/path/here?access_token=secret
{
  &quot;key&quot;: &quot;This is a post.&quot;
}

PUT /some/path/here/11?access_token=secret
{
  &quot;key&quot;: &quot;This is a put with a txnId of 11.&quot;
}
</pre>
<p>In contrast, these are invalid requests:</p>
<pre class="literal-block">
POST /some/path/here/11?access_token=secret
{
  &quot;key&quot;: &quot;This is a post, but it has a txnId.&quot;
}

PUT /some/path/here?access_token=secret
{
  &quot;key&quot;: &quot;This is a put but it is missing a txnId.&quot;
}
</pre>
</div>
</div>
<p><a class="anchor" id="client-server-api"></a></p>
<div class="section" id="client-server-api">
<h1><a class="toc-backref" href="#id73">4&nbsp;&nbsp;&nbsp;Client-Server API</a></h1>
<p>The client-server API provides a simple lightweight API to let clients send
messages, control rooms and synchronise conversation history. It is designed to
support both lightweight clients which store no state and lazy-load data from
the server as required - as well as heavyweight clients which maintain a full
local persistent copy of server state.</p>
<p>This mostly describes v1 of the Client-Server API as featured in the original September
2014 launch of Matrix, apart from user-interactive authentication where it is
encouraged to move to v2, therefore this is the version documented here.
Version 2 is currently in development (as of Jan-March 2015) as an incremental
but backwards-incompatible refinement of Version 1 and will be released
shortly.</p>
<p>Documentation for the old <a class="reference external" href="../attic/v1_registration_login.rst">V1 authentication</a> is still available separately.</p>
<p><a class="anchor" id="client-authentication"></a></p>
<div class="section" id="client-authentication">
<h2><a class="toc-backref" href="#id74">4.1&nbsp;&nbsp;&nbsp;Client Authentication</a></h2>
<p>Most API endpoints require the user to identify themselves by presenting
previously obtained credentials in the form of an <tt class="docutils literal">access_token</tt> query
parameter.</p>
<p>In API version 2, when credentials are missing or invalid, the HTTP call will
return with a status of 401 and the error code, <tt class="docutils literal">M_MISSING_TOKEN</tt> or
<tt class="docutils literal">M_UNKNOWN_TOKEN</tt> respectively.</p>
<p><a class="anchor" id="user-interactive-authentication-api"></a></p>
<div class="section" id="user-interactive-authentication-api">
<h3><a class="toc-backref" href="#id75">4.1.1&nbsp;&nbsp;&nbsp;User-Interactive Authentication API</a></h3>
<p id="sect-auth-api">This section refers to API Version 2.</p>
<p>Some API endpoints such as <tt class="docutils literal">login</tt> or <tt class="docutils literal">register</tt> require authentication that
interacts with the user. The home server may provide many different ways of
authenticating, such as user/password auth, login via a social network (OAuth2),
login by confirming a token sent to their email address, etc. This specification
does not define how home servers should authorise their users but instead
defines the standard interface which implementations should follow so that ANY
client can login to ANY home server.</p>
<p>The process takes the form of one or more stages, where at each stage the client
submits a set of data for a given stage type and awaits a response from the
server, which will either be a final success or a request to perform an
additional stage. This exchange continues until the final success.</p>
<p>Authentication works by client and server exchanging dictionaries. This
specification covers how this is done over JSON HTTP POST.</p>
<p>For each endpoint, a server offers one of more 'flows' that the client can use
to authenticate itself. Each flow comprises one or more 'stages'. Flows may have
more than one stage to implement n-factor auth. When all stages are complete,
authentication is complete and the API call succeeds. To establish what flows a
server supports for an endpoint, a client sends the request with no
authentication. A request to an endpoint that uses User-Interactive
Authentication never succeeds without auth. Home Servers may allow requests that
don't require auth by offering a stage with only the <tt class="docutils literal">m.login.dummy</tt> auth
type. The home server returns a response with HTTP status 401 and a JSON object
as follows:</p>
<pre class="literal-block">
{
  &quot;flows&quot;: [
    {
      &quot;stages&quot;: [ &quot;example.type.foo&quot;, &quot;example.type.bar&quot; ]
    },
    {
      &quot;stages&quot;: [ &quot;example.type.foo&quot;, &quot;example.type.baz&quot; ]
    }
  ],
  &quot;params&quot;: {
      &quot;example.type.baz&quot;: {
          &quot;example_key&quot;: &quot;foobar&quot;
      }
  },
  &quot;session&quot;: &quot;xxxxxx&quot;
}
</pre>
<p>In addition to the <tt class="docutils literal">flows</tt>, this object contains some extra
information:</p>
<dl class="docutils">
<dt>params</dt>
<dd>This section contains any information that the client will need to know in
order to use a given type of authentication. For each login stage type
presented, that type may be present as a key in this dictionary. For example,
the public part of an OAuth client ID could be given here.</dd>
<dt>session</dt>
<dd>This is a session identifier that the client must pass back to the home
server, if one is provided, in subsequent attempts to authenticate in the same
API call.</dd>
</dl>
<p>The client then chooses a flow and attempts to complete one of the stages. It
does this by resubmitting the same request with the the addition of an 'auth'
key in the object that it submits. This dictionary contains a <tt class="docutils literal">type</tt> key whose
value is the name of the stage type that the client is attempting to complete.
It must also contains a <tt class="docutils literal">session</tt> key with the value of the session key given
by the home server, if one was given. It also contains other keys dependent on
the stage type being attempted. For example, if the client is attempting to
complete login type <tt class="docutils literal">example.type.foo</tt>, it might submit something like this:</p>
<pre class="literal-block">
{
  &quot;a_request_parameter&quot;: &quot;something&quot;,
  &quot;another_request_parameter&quot;: &quot;something else&quot;,
  &quot;auth&quot;: {
      &quot;type&quot;: &quot;example.type.foo&quot;,
      &quot;session&quot;, &quot;xxxxxx&quot;,
      &quot;example_credential&quot;: &quot;verypoorsharedsecret&quot;
  }
}
</pre>
<p>If the home server deems the authentication attempt to be successful but still
requires more stages to be completed, it returns HTTP status 401 along with the
same object as when no authentication was attempted, with the addition of the
<tt class="docutils literal">completed</tt> key which is an array of stage type the client has completed
successfully:</p>
<pre class="literal-block">
{
  &quot;completed&quot;: [ &quot;example.type.foo&quot; ],
  &quot;flows&quot;: [
    {
      &quot;stages&quot;: [ &quot;example.type.foo&quot;, &quot;example.type.bar&quot; ]
    },
    {
      &quot;stages&quot;: [ &quot;example.type.foo&quot;, &quot;example.type.baz&quot; ]
    }
  ],
  &quot;params&quot;: {
      &quot;example.type.baz&quot;: {
          &quot;example_key&quot;: &quot;foobar&quot;
      }
  },
  &quot;session&quot;: &quot;xxxxxx&quot;
}
</pre>
<p>If the home server decides the attempt was unsuccessful, it returns an error
message in the standard format:</p>
<pre class="literal-block">
{
  &quot;errcode&quot;: &quot;M_EXAMPLE_ERROR&quot;,
  &quot;error&quot;: &quot;Something was wrong&quot;
}
</pre>
<p>Individual stages may require more than one request to complete, in which case
the response will be as if the request was unauthenticated with the addition of
any other keys as defined by the login type.</p>
<p>If the client has completed all stages of a flow, the home server performs the
API call and returns the result as normal.</p>
<p>Some authentication types may be completed by means other than through the
Matrix client, for example, an email confirmation may be completed when the user
clicks on the link in the email. In this case, the client retries the request
with an auth dict containing only the session key. The response to this will be
the same as if the client were attempting to complete an auth state normally,
i.e. the request will either complete or request auth, with the presence or
absence of that login stage type in the 'completed' array indicating whether
that stage is complete.</p>
<p><a class="anchor" id="example"></a></p>
<div class="section" id="example">
<h4><a class="toc-backref" href="#id76">4.1.1.1&nbsp;&nbsp;&nbsp;Example</a></h4>
<p>At a high level, the requests made for an API call completing an auth flow with
three stages will resemble the following diagram:</p>
<pre class="literal-block">
 _______________________
|       Stage 1         |
| type: &quot;&lt;stage type1&gt;&quot; |
|  ___________________  |
| |_Request_1_________| | &lt;-- Returns &quot;session&quot; key which is used throughout.
|  ___________________  |
| |_Request_2_________| |
|_______________________|
          |
          |
 _________V_____________
|       Stage 2         |
| type: &quot;&lt;stage type2&gt;&quot; |
|  ___________________  |
| |_Request_1_________| |
|  ___________________  |
| |_Request_2_________| |
|  ___________________  |
| |_Request_3_________| |
|_______________________|
          |
          |
 _________V_____________
|       Stage 3         |
| type: &quot;&lt;stage type3&gt;&quot; |
|  ___________________  |
| |_Request_1_________| | &lt;-- Returns API response
|_______________________|
</pre>
<dl class="docutils">
<dt>This specification defines the following login types:</dt>
<dd><ul class="first last simple">
<li><tt class="docutils literal">m.login.password</tt></li>
<li><tt class="docutils literal">m.login.recaptcha</tt></li>
<li><tt class="docutils literal">m.login.oauth2</tt></li>
<li><tt class="docutils literal">m.login.email.identity</tt></li>
<li><tt class="docutils literal">m.login.token</tt></li>
<li><tt class="docutils literal">m.login.dummy</tt></li>
</ul>
</dd>
</dl>
</div>
<p><a class="anchor" id="password-based"></a></p>
<div class="section" id="password-based">
<h4><a class="toc-backref" href="#id77">4.1.1.2&nbsp;&nbsp;&nbsp;Password-based</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.password</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">The client submits a username and secret password, both sent in plain-text.</td>
</tr>
</tbody>
</table>
<p>To respond to this type, reply with an auth dict as follows:</p>
<pre class="literal-block">
{
  &quot;type&quot;: &quot;m.login.password&quot;,
  &quot;user&quot;: &quot;&lt;user_id or user localpart&gt;&quot;,
  &quot;password&quot;: &quot;&lt;password&gt;&quot;
}
</pre>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">Clients SHOULD enforce that the password provided is suitably complex. The
password SHOULD include a lower-case letter, an upper-case letter, a number
and a symbol and be at a minimum 8 characters in length. Servers MAY reject
weak passwords with an error code <tt class="docutils literal">M_WEAK_PASSWORD</tt>.</p>
</div>
</div>
<p><a class="anchor" id="google-recaptcha"></a></p>
<div class="section" id="google-recaptcha">
<h4><a class="toc-backref" href="#id78">4.1.1.3&nbsp;&nbsp;&nbsp;Google ReCaptcha</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.recaptcha</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">The user completes a Google ReCaptcha 2.0 challenge</td>
</tr>
</tbody>
</table>
<p>To respond to this type, reply with an auth dict as follows:</p>
<pre class="literal-block">
{
  &quot;type&quot;: &quot;m.login.recaptcha&quot;,
  &quot;response&quot;: &quot;&lt;captcha response&gt;&quot;
}
</pre>
</div>
<p><a class="anchor" id="token-based"></a></p>
<div class="section" id="token-based">
<h4><a class="toc-backref" href="#id79">4.1.1.4&nbsp;&nbsp;&nbsp;Token-based</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.token</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">The client submits a username and token.</td>
</tr>
</tbody>
</table>
<p>To respond to this type, reply with an auth dict as follows:</p>
<pre class="literal-block">
{
  &quot;type&quot;: &quot;m.login.token&quot;,
  &quot;user&quot;: &quot;&lt;user_id or user localpart&gt;&quot;,
  &quot;token&quot;: &quot;&lt;token&gt;&quot;,
  &quot;txn_id&quot;: &quot;&lt;client generated nonce&gt;&quot;
}
</pre>
<p>The <tt class="docutils literal">nonce</tt> should be a random string generated by the client for the
request. The same <tt class="docutils literal">nonce</tt> should be used if retrying the request.</p>
<p>There are many ways a client may receive a <tt class="docutils literal">token</tt>, including via an email or
from an existing logged in device.</p>
<p>The <tt class="docutils literal">txn_id</tt> may be used by the server to disallow other devices from using
the token, thus providing &quot;single use&quot; tokens while still allowing the device
to retry the request. This would be done by tying the token to the <tt class="docutils literal">txn_id</tt>
server side, as well as potentially invalidating the token completely once the
device has successfully logged in (e.g. when we receive a request from the
newly provisioned access_token).</p>
<p>The <tt class="docutils literal">token</tt> must be a macaroon.</p>
</div>
<p><a class="anchor" id="oauth2-based"></a></p>
<div class="section" id="oauth2-based">
<h4><a class="toc-backref" href="#id80">4.1.1.5&nbsp;&nbsp;&nbsp;OAuth2-based</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.oauth2</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">Authentication is supported via OAuth2 URLs. This login consists of multiple
requests.</td>
</tr>
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><tt class="docutils literal">uri</tt>: Authorization Request URI OR service selection URI. Both contain an
encoded <tt class="docutils literal">redirect URI</tt>.</td>
</tr>
</tbody>
</table>
<p>The home server acts as a 'confidential' client for the purposes of OAuth2.  If
the uri is a <tt class="docutils literal">service selection URI</tt>, it MUST point to a webpage which prompts
the user to choose which service to authorize with. On selection of a service,
this MUST link through to an <tt class="docutils literal">Authorization Request URI</tt>. If there is only one
service which the home server accepts when logging in, this indirection can be
skipped and the &quot;uri&quot; key can be the <tt class="docutils literal">Authorization Request URI</tt>.</p>
<p>The client then visits the <tt class="docutils literal">Authorization Request URI</tt>, which then shows the
OAuth2 Allow/Deny prompt. Hitting 'Allow' redirects to the <tt class="docutils literal">redirect URI</tt> with
the auth code. Home servers can choose any path for the <tt class="docutils literal">redirect URI</tt>. Once
the OAuth flow has completed, the client retries the request with the session
only, as above.</p>
</div>
<p><a class="anchor" id="email-based-identity-server"></a></p>
<div class="section" id="email-based-identity-server">
<h4><a class="toc-backref" href="#id81">4.1.1.6&nbsp;&nbsp;&nbsp;Email-based (identity server)</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.email.identity</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">Authentication is supported by authorising an email address with an identity
server.</td>
</tr>
</tbody>
</table>
<p>Prior to submitting this, the client should authenticate with an identity
server. After authenticating, the session information should be submitted to
the home server.</p>
<p>To respond to this type, reply with an auth dict as follows:</p>
<pre class="literal-block">
{
  &quot;type&quot;: &quot;m.login.email.identity&quot;,
  &quot;threepidCreds&quot;: [
    {
      &quot;sid&quot;: &quot;&lt;identity server session id&gt;&quot;,
      &quot;client_secret&quot;: &quot;&lt;identity server client secret&gt;&quot;,
      &quot;id_server&quot;: &quot;&lt;url of identity server authed with, e.g. 'matrix.org:8090'&gt;&quot;
    }
  ]
}
</pre>
</div>
<p><a class="anchor" id="dummy-auth"></a></p>
<div class="section" id="dummy-auth">
<h4><a class="toc-backref" href="#id82">4.1.1.7&nbsp;&nbsp;&nbsp;Dummy Auth</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Type:</th><td class="field-body"><tt class="docutils literal">m.login.dummy</tt></td>
</tr>
<tr class="field"><th class="field-name">Description:</th><td class="field-body">Dummy authentication always succeeds and requires no extra parameters. Its
purpose is to allow servers to not require any form of User-Interactive
Authentication to perform a request.</td>
</tr>
</tbody>
</table>
<p>To respond to this type, reply with an auth dict with just the type and session,
if provided:</p>
<pre class="literal-block">
{
  &quot;type&quot;: &quot;m.login.dummy&quot;,
}
</pre>
</div>
<p><a class="anchor" id="fallback"></a></p>
<div class="section" id="fallback">
<h4><a class="toc-backref" href="#id83">4.1.1.8&nbsp;&nbsp;&nbsp;Fallback</a></h4>
<p>Clients cannot be expected to be able to know how to process every single login
type. If a client does not know how to handle a given login type, it can direct
the user to a web browser with the URL of a fallback page which will allow the
user to complete that login step out-of-band in their web browser. The URL it
should open is the Home Server base URL plus prefix, plus:</p>
<pre class="literal-block">
/auth/&lt;stage type&gt;/fallback/web?session=&lt;session ID&gt;
</pre>
<p>Where <tt class="docutils literal">stage type</tt> is the type name of the stage it is attempting and
<tt class="docutils literal">session id</tt> is the ID of the session given by the home server.</p>
<p>This MUST return an HTML page which can perform this authentication stage. This
page must attempt to call the JavaScript function <tt class="docutils literal">window.onAuthDone</tt> when
the authentication has been completed.</p>
</div>
</div>
<p><a class="anchor" id="api-calls-using-the-user-interactive-authentication-mechanism"></a></p>
<div class="section" id="api-calls-using-the-user-interactive-authentication-mechanism">
<h3><a class="toc-backref" href="#id84">4.1.2&nbsp;&nbsp;&nbsp;API calls using the User-Interactive Authentication mechanism</a></h3>
<p>This section refers to API Version 2. These API calls currently use the prefix
<tt class="docutils literal">/_matrix/client/v2_alpha</tt>.</p>
<p><a class="anchor" id="post-matrix-client-api-v2-alpha-register"></a></p>
<div class="section" id="post-matrix-client-api-v2-alpha-register">
<h4><a class="toc-backref" href="#id85">4.1.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v2_alpha/register</tt></a></h4>
<p>Register for an account on this homeserver.</p>
<p>There are two kinds of user account:</p>
<ul class="simple">
<li><cite>user</cite> accounts. These accounts may use the full API described in this
specification.</li>
<li><cite>guest</cite> accounts. These accounts may have limited permissions and may not be
supported by all servers.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td>The kind of account to register. Defaults to
<cite>user</cite>. One of: [&quot;guest&quot;, &quot;user&quot;]</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>username</td>
<td>string</td>
<td>The local part of the desired Matrix ID. If
omitted, the homeserver MUST generate a Matrix ID
local part.</td>
</tr>
<tr><td>bind_email</td>
<td>boolean</td>
<td>If true, the server binds the email used for
authentication to the Matrix ID with the ID
Server.</td>
</tr>
<tr><td>password</td>
<td>string</td>
<td><strong>Required.</strong> The desired password for the
account.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="14%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>access_token</td>
<td>string</td>
<td>An access token for the account. This access token
can then be used to authorize other requests. The
access token may expire at some point, and if so,
it SHOULD come with a <tt class="docutils literal">refresh_token</tt>. There is
no specific error message to indicate that a
request has failed because an access token has
expired; instead, if a client has reason to
believe its access token is valid, and it receives
an auth error, they should attempt to refresh for
a new token on failure, and retry the request with
the new token.</td>
</tr>
<tr><td>home_server</td>
<td>string</td>
<td>The hostname of the Home Server on which the
account has been registered.</td>
</tr>
<tr><td>refresh_token</td>
<td>string</td>
<td>(optional) A <tt class="docutils literal">refresh_token</tt> may be exchanged
for a new <tt class="docutils literal">access_token</tt> using the /tokenrefresh
API endpoint.</td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td>The fully-qualified Matrix ID that has been
registered.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v2_alpha/register?kind=guest</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;username&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;cheeky_monkey&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ilovebananas&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;bind_email&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
<span class="punctuation">}</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The account has been registered.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;home_server&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;refresh_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;def456&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>Part of the request was invalid. This may include one of the following error codes:</p>
<ul class="simple">
<li><tt class="docutils literal">M_USER_IN_USE</tt> : The desired user ID is already taken.</li>
<li><tt class="docutils literal">M_EXCLUSIVE</tt> : The desired user ID is in the exclusive namespace
claimed by an application service.</li>
</ul>
<p>These errors may be returned at any stage of the registration process,
including after authentication if the requested user ID was registered
whilst the client was performing authentication.</p>
<p>Home Servers MUST perform the relevant checks and return these codes before
performing <a class="reference internal" href="#sect-auth-api">User-Interactive Authentication</a>, although they may also return
them after authentication is completed if, for example, the requested user ID
was registered whilst the client was performing authentication.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_USER_IN_USE&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Desired user ID is already taken.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Old V1 API docs: <a class="reference external" href="/docs/api/client-server/#!/-registration"><tt class="docutils literal">/register</tt></a></p>
</div>
<p><a class="anchor" id="post-matrix-client-api-v1-login"></a></p>
<div class="section" id="post-matrix-client-api-v1-login">
<h4><a class="toc-backref" href="#id86">4.1.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v1/login</tt></a></h4>
<p>Authenticates the user by password, and issues an access token they can use to
authorize themself in subsequent requests.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>password</td>
<td>string</td>
<td><strong>Required.</strong> The user's password.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> The login type being used. Currently
only &quot;m.login.password&quot; is supported.</td>
</tr>
<tr><td>user</td>
<td>string</td>
<td><strong>Required.</strong> The fully qualified user ID or just
local part of the user ID, to log in.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="14%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>access_token</td>
<td>string</td>
<td>An access token for the account. This access token
can then be used to authorize other requests. The
access token may expire at some point, and if so,
it SHOULD come with a <tt class="docutils literal">refresh_token</tt>. There is
no specific error message to indicate that a
request has failed because an access token has
expired; instead, if a client has reason to
believe its access token is valid, and it receives
an auth error, they should attempt to refresh for
a new token on failure, and retry the request with
the new token.</td>
</tr>
<tr><td>home_server</td>
<td>string</td>
<td>The hostname of the Home Server on which the
account has been registered.</td>
</tr>
<tr><td>refresh_token</td>
<td>string</td>
<td>(optional) A <tt class="docutils literal">refresh_token</tt> may be exchanged
for a new <tt class="docutils literal">access_token</tt> using the /tokenrefresh
API endpoint.</td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td>The fully-qualified Matrix ID that has been
registered.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/login</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.login.pasword&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;user&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;cheeky_monkey&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ilovebananas&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The user has been authenticated.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;home_server&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>Part of the request was invalid. For example, the login type may not be recognised.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bad login type.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The login attempt failed. For example, the password may have been incorrect.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span><span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-api-v1-tokenrefresh"></a></p>
<div class="section" id="post-matrix-client-api-v1-tokenrefresh">
<h4><a class="toc-backref" href="#id87">4.1.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v1/tokenrefresh</tt></a></h4>
<p>Exchanges a refresh token for a new access token. This is intended to be used if
the access token has expired.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="14%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>refresh_token</td>
<td>string</td>
<td><strong>Required.</strong> The refresh token which was issued
by the server.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="14%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>access_token</td>
<td>string</td>
<td>An access token for the account. This access token
can then be used to authorize other requests. The
access token may expire at some point, and if so,
it SHOULD come with a <tt class="docutils literal">refresh_token</tt>.</td>
</tr>
<tr><td>refresh_token</td>
<td>string</td>
<td>(optional) A <tt class="docutils literal">refresh_token</tt> may be exchanged
for a new <tt class="docutils literal">access_token</tt> using the TODO Linkify
/tokenrefresh API endpoint.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/tokenrefresh</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;refresh_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;a1b2c3&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The refresh token was accepted, and a new access token has been issued.
The passed refresh token is no longer valid and cannot be used.
A new refresh token will have been returned unless some policy does
not allow the user to continue to renew their session.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;bearwithme123&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;refresh_token&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;exchangewithme987&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The exchange attempt failed. For example, the refresh token may have already been used.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span><span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="login-fallback"></a></p>
<div class="section" id="login-fallback">
<h4><a class="toc-backref" href="#id88">4.1.2.4&nbsp;&nbsp;&nbsp;Login Fallback</a></h4>
<p>If a client does not recognize any or all login flows it can use the fallback
login API:</p>
<pre class="literal-block">
GET /_matrix/static/client/login/
</pre>
<p>This returns an HTML and JavaScript page which can perform the entire login
process. The page will attempt to call the JavaScript function
<tt class="docutils literal">window.onLogin</tt> when login has been successfully completed.</p>
</div>
<p><a class="anchor" id="changing-password"></a></p>
<div class="section" id="changing-password">
<h4><a class="toc-backref" href="#id89">4.1.2.5&nbsp;&nbsp;&nbsp;Changing Password</a></h4>
<p>Request:</p>
<pre class="literal-block">
POST $V2PREFIX/account/password
</pre>
<p>This API endpoint uses the User-Interactive Authentication API. An access token
should be submitted to this endpoint if the client has an active session. The
Home Server may change the flows available depending on whether a valid access
token is provided.</p>
<p>The body of the POST request is a JSON object containing:</p>
<dl class="docutils">
<dt>new_password</dt>
<dd>The new password for the account.</dd>
</dl>
<p>On success, an empty JSON object is returned.</p>
<p>The error code M_NOT_FOUND is returned if the user authenticated with a third
party identifier but the Home Server could not find a matching account in its
database.</p>
</div>
<p><a class="anchor" id="adding-account-administrative-contact-information"></a></p>
<div class="section" id="adding-account-administrative-contact-information">
<h4><a class="toc-backref" href="#id90">4.1.2.6&nbsp;&nbsp;&nbsp;Adding Account Administrative Contact Information</a></h4>
<p>Request:</p>
<pre class="literal-block">
POST $V2PREFIX/account/3pid
</pre>
<p>Used to add contact information to the user's account.</p>
<p>The body of the POST request is a JSON object containing:</p>
<dl class="docutils">
<dt>threePidCreds</dt>
<dd>An object containing contact information.</dd>
<dt>bind</dt>
<dd>Optional. A boolean indicating whether the Home Server should also bind this
third party identifier to the account's matrix ID with the Identity Server. If
supplied and true, the Home Server must bind the 3pid accordingly.</dd>
</dl>
<p>The contact information object comprises:</p>
<dl class="docutils">
<dt>id_server</dt>
<dd>The colon-separated hostname and port of the Identity Server used to
authenticate the third party identifier. If the port is the default, it and the
colon should be omitted.</dd>
<dt>sid</dt>
<dd>The session ID given by the Identity Server</dd>
<dt>client_secret</dt>
<dd>The client secret used in the session with the Identity Server.</dd>
</dl>
<p>On success, the empty JSON object is returned.</p>
<p>May also return error codes:</p>
<dl class="docutils">
<dt>M_THREEPID_AUTH_FAILED</dt>
<dd>If the credentials provided could not be verified with the ID Server.</dd>
</dl>
</div>
<p><a class="anchor" id="fetching-currently-associated-contact-information"></a></p>
<div class="section" id="fetching-currently-associated-contact-information">
<h4><a class="toc-backref" href="#id91">4.1.2.7&nbsp;&nbsp;&nbsp;Fetching Currently Associated Contact Information</a></h4>
<p>Request:</p>
<pre class="literal-block">
GET $V2PREFIX/account/3pid
</pre>
<p>This returns a list of third party identifiers that the Home Server has
associated with the user's account. This is <em>not</em> the same as the list of third
party identifiers bound to the user's Matrix ID in Identity Servers. Identifiers
in this list may be used by the Home Server as, for example, identifiers that it
will accept to reset the user's account password.</p>
<p>Returns a JSON object with the key <tt class="docutils literal">threepids</tt> whose contents is an array of
objects with the following keys:</p>
<dl class="docutils">
<dt>medium</dt>
<dd>The medium of the 3pid (eg, <tt class="docutils literal">email</tt>)</dd>
<dt>address</dt>
<dd>The textual address of the 3pid, eg. the email address</dd>
</dl>
</div>
</div>
</div>
<p><a class="anchor" id="pagination"></a></p>
<div class="section" id="pagination">
<h2><a class="toc-backref" href="#id92">4.2&nbsp;&nbsp;&nbsp;Pagination</a></h2>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">The paths referred to in this section are not actual endpoints. They only
serve as examples to explain how pagination functions.</p>
</div>
<p>Pagination is the process of dividing a dataset into multiple discrete pages.
Matrix makes use of pagination to allow clients to view extremely large datasets.
These datasets are not limited to events in a room (for example clients may want
to paginate a list of rooms in addition to events within those rooms). Regardless
of <em>what</em> is being paginated, there is a common underlying API which is used to
to give clients a consistent way of selecting subsets of a potentially changing
dataset. Requests pass in <tt class="docutils literal">from</tt>, <tt class="docutils literal">to</tt>, <tt class="docutils literal">dir</tt> and <tt class="docutils literal">limit</tt> parameters
which describe where to read from the stream. <tt class="docutils literal">from</tt> and <tt class="docutils literal">to</tt> are opaque
textual 'stream tokens' which describe the current position in the dataset.
The <tt class="docutils literal">dir</tt> parameter is an enum representing the direction of events to return:
either <tt class="docutils literal">f</tt> orwards or <tt class="docutils literal">b</tt> ackwards. The response returns new <tt class="docutils literal">start</tt> and
<tt class="docutils literal">end</tt> stream token values which can then be passed to subsequent requests to
continue pagination. Not all endpoints will make use of all the parameters
outlined here: see the specific endpoint in question for more information.</p>
<p><a class="anchor" id="pagination-request-query-parameters"></a></p>
<div class="section" id="pagination-request-query-parameters">
<h3><a class="toc-backref" href="#id93">4.2.1&nbsp;&nbsp;&nbsp;Pagination Request Query Parameters</a></h3>
<dl class="docutils">
<dt>Query parameters:</dt>
<dd><dl class="first last docutils">
<dt>from:</dt>
<dd>$streamtoken - The opaque token to start streaming from.</dd>
<dt>to:</dt>
<dd>$streamtoken - The opaque token to end streaming at. Typically,
clients will not know the item of data to end at, so this will usually be
omitted.</dd>
<dt>limit:</dt>
<dd>integer - An integer representing the maximum number of items to
return.</dd>
<dt>dir:</dt>
<dd>f|b - The direction to return events in. Typically this is <tt class="docutils literal">b</tt> to paginate
backwards in time.</dd>
</dl>
</dd>
</dl>
<p>'START' and 'END' are placeholder values used in these examples to describe the
start and end of the dataset respectively.</p>
<p>Unless specified, the default pagination parameters are <tt class="docutils literal">from=START</tt>,
<tt class="docutils literal">to=END</tt>, without a limit set.</p>
<p>For example, if an endpoint had events E1 -&gt; E15. The client wants the last 5
events and doesn't know any previous events:</p>
<pre class="literal-block">
S                                                    E
|-E1-E2-E3-E4-E5-E6-E7-E8-E9-E10-E11-E12-E13-E14-E15-|
|                               |                    |
|                          _____|  &lt;--backwards--    |
|__________________       |         |        ________|
                   |      |         |        |
 GET /somepath?to=START&amp;limit=5&amp;dir=b&amp;from=END
 Returns:
   E15,E14,E13,E12,E11
</pre>
<p>Another example: a public room list has rooms R1 -&gt; R17. The client is showing 5
rooms at a time on screen, and is on page 2. They want to
now show page 3 (rooms R11 -&gt; 15):</p>
<pre class="literal-block">
S                                                           E
|  0  1  2  3  4  5  6  7  8  9  10  11  12  13  14  15  16 | stream token
|-R1-R2-R3-R4-R5-R6-R7-R8-R9-R10-R11-R12-R13-R14-R15-R16-R17| room
                  |____________| |________________|
                        |                |
                    Currently            |
                    viewing              |
                                         |
                         GET /roomslist?from=9&amp;to=END&amp;limit=5
                         Returns: R11,R12,R13,R14,R15
</pre>
<p>Note that tokens are treated in an <em>exclusive</em>, not inclusive, manner. The end
token from the initial request was '9' which corresponded to R10. When the 2nd
request was made, R10 did not appear again, even though from=9 was specified. If
you know the token, you already have the data.</p>
</div>
<p><a class="anchor" id="pagination-response"></a></p>
<div class="section" id="pagination-response">
<h3><a class="toc-backref" href="#id94">4.2.2&nbsp;&nbsp;&nbsp;Pagination Response</a></h3>
<p>Responses to pagination requests MUST follow the format:</p>
<pre class="literal-block">
{
  &quot;chunk&quot;: [ ... , Responses , ... ],
  &quot;start&quot; : $streamtoken,
  &quot;end&quot; : $streamtoken
}
</pre>
<p>Where $streamtoken is an opaque token which can be used in another query to
get the next set of results. The &quot;start&quot; and &quot;end&quot; keys can only be omitted if
the complete dataset is provided in &quot;chunk&quot;.</p>
</div>
</div>
<p><a class="anchor" id="id1"></a></p>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id95">4.3&nbsp;&nbsp;&nbsp;Events</a></h2>
<p id="sect-events">The model of conversation history exposed by the client-server API can be
considered as a list of events. The server 'linearises' the
eventually-consistent event graph of events into an 'event stream' at any given
point in time:</p>
<pre class="literal-block">
[E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]-&gt;[E6]-&gt;[E7]-&gt;[E8]-&gt;[E9]
</pre>
<p>Clients can add to the stream by POSTing message or state events, and can read
from the stream via the <a class="reference external" href="/docs/api/client-server/#!/-events/initial_sync"><tt class="docutils literal">/initialSync</tt></a>, <a class="reference external" href="/docs/api/client-server/#!/-rooms/get_room_sync_data"><tt class="docutils literal"><span class="pre">/rooms/&lt;room_id&gt;/initialSync</span></tt></a>, <a class="reference external" href="/docs/api/client-server/#!/-events/get_event_stream">Event
Stream</a> and <a class="reference external" href="/docs/api/client-server/#!/-rooms/get_messages"><tt class="docutils literal"><span class="pre">/rooms/&lt;room_id&gt;/messages</span></tt></a> APIs.</p>
<p>For reading events, the intended flow of operation is to call
$PREFIX/initialSync, which returns all of the state and the last N events in the
event stream for each room, including <tt class="docutils literal">start</tt> and <tt class="docutils literal">end</tt> values describing the
pagination of each room's event stream. For instance,
$PREFIX/initialSync?limit=5 might return the events for a room in the
rooms[0].messages.chunk[] array, with tokens describing the start and end of the
range in rooms[0].messages.start as '1-2-3' and rooms[0].messages.end as
'a-b-c'.</p>
<p>You can visualise the range of events being returned as:</p>
<pre class="literal-block">
[E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]-&gt;[E6]-&gt;[E7]-&gt;[E8]-&gt;[E9]
                            ^                             ^
                            |                             |
                      start: '1-2-3'                end: 'a-b-c'
</pre>
<p>Now, to receive future events in real-time on the event stream, you simply GET
$PREFIX/events with a <tt class="docutils literal">from</tt> parameter of 'a-b-c': in other words passing in the
<tt class="docutils literal">end</tt> token returned by initial sync. The request blocks until new events are
available or until your specified timeout elapses, and then returns a
new paginatable chunk of events alongside new start and end parameters:</p>
<pre class="literal-block">
[E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]-&gt;[E6]-&gt;[E7]-&gt;[E8]-&gt;[E9]-&gt;[E10]
                                                          ^      ^
                                                          |      |
                                                          |  end: 'x-y-z'
                                                    start: 'a-b-c'
</pre>
<p>To resume polling the events stream, you pass in the new <tt class="docutils literal">end</tt> token as the
<tt class="docutils literal">from</tt> parameter of $PREFIX/events and poll again.</p>
<p>Similarly, to paginate events backwards in order to lazy-load in previous
history from the room, you simply GET $PREFIX/rooms/&lt;room_id&gt;/messages
specifying the <tt class="docutils literal">from</tt> token to paginate backwards from and a limit of the number
of messages to retrieve. For instance, calling this API with a <tt class="docutils literal">from</tt> parameter
of '1-2-3' and a limit of 5 would return:</p>
<pre class="literal-block">
[E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]-&gt;[E6]-&gt;[E7]-&gt;[E8]-&gt;[E9]-&gt;[E10]
^                            ^
|                            |
start: 'u-v-w'          end: '1-2-3'
</pre>
<p>To continue paginating backwards, one calls the /messages API again, supplying
the new <tt class="docutils literal">start</tt> value as the <tt class="docutils literal">from</tt> parameter.</p>
<p><a class="anchor" id="types-of-room-events"></a></p>
<div class="section" id="types-of-room-events">
<h3><a class="toc-backref" href="#id96">4.3.1&nbsp;&nbsp;&nbsp;Types of room events</a></h3>
<p>Room events are split into two categories:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">State Events:</th><td class="field-body">These are events which update the metadata state of the room (e.g. room topic,
room membership etc). State is keyed by a tuple of event <tt class="docutils literal">type</tt> and a
<tt class="docutils literal">state_key</tt>. State in the room with the same key-tuple will be overwritten.</td>
</tr>
<tr class="field"><th class="field-name">Message events:</th><td class="field-body">These are events which describe transient &quot;once-off&quot; activity in a room:
typically communication such as sending an instant message or setting up a
VoIP call.</td>
</tr>
</tbody>
</table>
<p>This specification outlines several events, all with the event type prefix
<tt class="docutils literal">m.</tt>. (See <a class="reference internal" href="#room-events">Room Events</a> for the m. event specification.) However,
applications may wish to add their own type of event, and this can be achieved
using the REST API detailed in the following sections. If new events are added,
the event <tt class="docutils literal">type</tt> key SHOULD follow the Java package naming convention,
e.g. <tt class="docutils literal">com.example.myapp.event</tt>.  This ensures event types are suitably
namespaced for each application and reduces the risk of clashes.</p>
</div>
<p><a class="anchor" id="syncing"></a></p>
<div class="section" id="syncing">
<h3><a class="toc-backref" href="#id97">4.3.2&nbsp;&nbsp;&nbsp;Syncing</a></h3>
<p>Clients receive new events by &quot;long-polling&quot; the home server via the events API.
This involves specifying a timeout in the request which will hold
open the HTTP connection for a short period of time waiting for new events,
returning early if an event occurs. Only the events API supports long-polling.
All events which are visible to the client will appear in the
events API. When the request returns, an <tt class="docutils literal">end</tt> token is included in the
response. This token can be used in the next request to continue where the
last request left off. Multiple events can be returned per long-poll.</p>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">Events are ordered in this API according to the arrival time of the event on
the homeserver. This can conflict with other APIs which order events based on
their partial ordering in the event graph. This can result in duplicate events
being received (once per distinct API called). Clients SHOULD de-duplicate
events based on the event ID when this happens.</p>
</div>
<!-- TODO-spec
Do we ever support streaming requests? Why not websockets? -->
<p>When the client first logs in, they will need to initially synchronise with
their home server. This is achieved via the initial sync API described below.
This API also returns an <tt class="docutils literal">end</tt> token which can be used with the event stream.</p>
<p><a class="anchor" id="get-matrix-client-api-v1-events"></a></p>
<div class="section" id="get-matrix-client-api-v1-events">
<h4><a class="toc-backref" href="#id98">4.3.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/events</tt></a></h4>
<p>This will listen for new events and return them to the caller. This will block
until an event is received, or until the <tt class="docutils literal">timeout</tt> is reached.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>from</td>
<td>string</td>
<td>The token to stream from. This token is either
from a previous request to this API or from the
initial sync API.</td>
</tr>
<tr><td>timeout</td>
<td>integer</td>
<td>The maximum time in milliseconds to wait for an
event.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[Event]</td>
<td>An array of events.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>A token which correlates to the last value in
<tt class="docutils literal">chunk</tt>. This token should be used in the next
request to <tt class="docutils literal">/events</tt>.</td>
</tr>
<tr><td>start</td>
<td>string</td>
<td>A token which correlates to the first value in
<tt class="docutils literal">chunk</tt>. This is usually the same token supplied
to <tt class="docutils literal">from=</tt>.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Event</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>The globally unique event identifier.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>The ID of the room associated with this event.</td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td>Contains the fully-qualified ID of the user who
<em>sent</em> this event.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/events?from=s3456_9_0&amp;timeout=35000</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The events received, which may be none.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3456_9_0&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3457_9_0&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">32</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;incoming message&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14328055551tzaee:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432804485886</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:localhost&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-events-eventid"></a></p>
<div class="section" id="get-matrix-client-api-v1-events-eventid">
<h4><a class="toc-backref" href="#id99">4.3.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/events/{eventId}</span></tt></a></h4>
<p>Get a single event based on <tt class="docutils literal">event_id</tt>. You must have permission to retrieve
this event e.g. by being a member in the room for this event.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID to get.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/events/%24asfDuShaf7Gafaw%3Amatrix.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The full event.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Hello world!&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;room_id:&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!wfgy43Sg4a:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$asfDuShaf7Gafaw:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-initialsync"></a></p>
<div class="section" id="get-matrix-client-api-v1-initialsync">
<h4><a class="toc-backref" href="#id100">4.3.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/initialSync</tt></a></h4>
<p>This returns the full state for this user, with an optional limit on the number
of messages per room to return.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of messages to return for each
room.</td>
</tr>
<tr><td>archived</td>
<td>boolean</td>
<td>Whether to include rooms that the user has left.
If <tt class="docutils literal">false</tt> then only rooms that the user has
been invited to or has joined are included. If set
to <tt class="docutils literal">true</tt> then rooms that the user has left are
included as well. By default this is <tt class="docutils literal">false</tt>.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>end</td>
<td>string</td>
<td>A token which correlates to the last value in
<tt class="docutils literal">chunk</tt>. This token should be used with the
<tt class="docutils literal">/events</tt> API to listen for new events.</td>
</tr>
<tr><td>presence</td>
<td>[Event]</td>
<td>A list of presence events.</td>
</tr>
<tr><td>rooms</td>
<td>[RoomInfo]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Event</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="19%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>{EventContent}</td>
<td>The fields in this object will vary depending on
the type of event. When interacting with the REST
API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td>The type of event. This SHOULD be namespaced
similar to Java package naming conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">RoomInfo</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="22%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>invite</td>
<td>{InviteEvent}</td>
<td>The invite event if <tt class="docutils literal">membership</tt> is <tt class="docutils literal">invite</tt></td>
</tr>
<tr><td>membership</td>
<td>enum</td>
<td>The user's membership state in this room. One of:
[&quot;invite&quot;, &quot;join&quot;, &quot;leave&quot;, &quot;ban&quot;]</td>
</tr>
<tr><td>messages</td>
<td>{PaginationChunk}</td>
<td>The pagination chunk for this room.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>The ID of this room.</td>
</tr>
<tr><td>state</td>
<td>[StateEvent]</td>
<td>If the user is a member of the room this will be
the current state of the room as a list of events.
If the user has left the room this will be the
state of the room when they left it.</td>
</tr>
<tr><td>visibility</td>
<td>enum</td>
<td>Whether this room is visible to the
<tt class="docutils literal">/publicRooms</tt> API or not.&quot; One of: [&quot;private&quot;,
&quot;public&quot;]</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">InviteEvent</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="18%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>{EventContent}</td>
<td>&nbsp;</td>
</tr>
<tr><td>invite_room_state</td>
<td>[StrippedState]</td>
<td>A subset of the state of the room at the time of
the invite, if <tt class="docutils literal">membership</tt> is <tt class="docutils literal">invite</tt></td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>The <tt class="docutils literal">user_id</tt> this membership event relates to.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td>Must be 'm.room.member'.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">EventContent</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="17%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The avatar URL for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>displayname</td>
<td>string or null</td>
<td>The display name for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>membership</td>
<td>enum</td>
<td>The membership state of the user. One of:
[&quot;invite&quot;, &quot;join&quot;, &quot;knock&quot;, &quot;leave&quot;, &quot;ban&quot;]</td>
</tr>
<tr><td>third_party_invite</td>
<td>{Invite}</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Invite</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>signed</td>
<td>{signed}</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">signed</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="17%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mxid</td>
<td>string</td>
<td>The invited matrix user ID. Must be equal to the
user_id property of the event.</td>
</tr>
<tr><td>signatures</td>
<td>{Signatures}</td>
<td>A single signature from the verifying server, in
the format specified by the Signing Events
section.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td>The token property of the containing
third_party_invite object.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">StrippedState</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="19%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>{EventContent}</td>
<td>The <tt class="docutils literal">content</tt> for the event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>The <tt class="docutils literal">state_key</tt> for the event.</td>
</tr>
<tr><td>type</td>
<td>enum</td>
<td>The <tt class="docutils literal">type</tt> for the event. One of:
[&quot;m.room.join_rules&quot;, &quot;m.room.canonical_alias&quot;,
&quot;m.room.avatar&quot;, &quot;m.room.name&quot;]</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">PaginationChunk</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="15%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[RoomEvent]</td>
<td>If the user is a member of the room this will be a
list of the most recent messages for this room. If
the user has left the room this will be the
messages that preceeded them leaving. This array
will consist of at most <tt class="docutils literal">limit</tt> elements.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>A token which correlates to the last value in
<tt class="docutils literal">chunk</tt>. Used for pagination.</td>
</tr>
<tr><td>start</td>
<td>string</td>
<td>A token which correlates to the first value in
<tt class="docutils literal">chunk</tt>. Used for pagination.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">RoomEvent</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>The globally unique event identifier.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>The ID of the room associated with this event.</td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td>Contains the fully-qualified ID of the user who
<em>sent</em> this event.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">StateEvent</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="18%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>prev_content</td>
<td>{EventContent}</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>A unique key which defines the overwriting
semantics for this piece of room state. This value
is often a zero-length string. The presence of
this key makes this event a State Event. The key
MUST NOT start with '_'.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/initialSync?limit=2&amp;archived=true</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The user's current state.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3456_9_0&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/GCmhgzMPRjqgpODLsNQzVuHZ#auto&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bob&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;last_active_ago&quot;</span><span class="punctuation">:</span> <span class="literal number integer">31053</span><span class="punctuation">,</span>
                <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;online&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:localhost&quot;</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.presence&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;messages&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                    <span class="punctuation">{</span>
                        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">343513403</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                            <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
                        <span class="punctuation">},</span>
                        <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14328044851tzTJS:localhost&quot;</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432804485886</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:localhost&quot;</span>
                    <span class="punctuation">},</span>
                    <span class="punctuation">{</span>
                        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">343511809</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                            <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;bar&quot;</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
                        <span class="punctuation">},</span>
                        <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14328044872spjFg:localhost&quot;</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432804487480</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:localhost&quot;</span>
                    <span class="punctuation">}</span>
                <span class="punctuation">],</span>
                <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3456_9_0&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t44-3453_9_0&quot;</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">7148266897</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                        <span class="name tag">&quot;join_rule&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span>
                    <span class="punctuation">},</span>
                    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14259997323TLwtb:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1425999732392</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.join_rules&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:localhost&quot;</span>
                <span class="punctuation">},</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">6547561012</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/fzysBrHpPEeTGANCVLXWXNMI#auto&quot;</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="keyword constant">null</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span>
                    <span class="punctuation">},</span>
                    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1426600438280zExKY:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1426600438277</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:localhost&quot;</span>
                <span class="punctuation">},</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">7148267200</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                        <span class="name tag">&quot;creator&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:localhost&quot;</span>
                    <span class="punctuation">},</span>
                    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14259997320KhbwJ:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1425999732089</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.create&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:localhost&quot;</span>
                <span class="punctuation">},</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1622568720</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/GCmhgzMPRjqgpODLsNQzVuHZ#auto&quot;</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bob&quot;</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span>
                    <span class="punctuation">},</span>
                    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1431525430134MxlLX:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431525430569</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;replaces_state&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$142652023736BSXcM:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:localhost&quot;</span>
                <span class="punctuation">},</span>
                <span class="punctuation">{</span>
                    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">7148267004</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                        <span class="name tag">&quot;ban&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                            <span class="name tag">&quot;m.room.name&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span><span class="punctuation">,</span>
                            <span class="name tag">&quot;m.room.power_levels&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
                        <span class="punctuation">},</span>
                        <span class="name tag">&quot;events_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;kick&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;redact&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;state_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
                        <span class="name tag">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                            <span class="name tag">&quot;&#64;alice:localhost&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
                        <span class="punctuation">},</span>
                        <span class="name tag">&quot;users_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
                    <span class="punctuation">},</span>
                    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14259997322mqfaq:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1425999732285</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.power_levels&quot;</span><span class="punctuation">,</span>
                    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:localhost&quot;</span>
                <span class="punctuation">}</span>
            <span class="punctuation">],</span>
            <span class="name tag">&quot;visibility&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;private&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-v2-alpha-sync"></a></p>
<div class="section" id="get-matrix-client-v2-alpha-sync">
<h4><a class="toc-backref" href="#id101">4.3.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/v2_alpha/sync</tt></a></h4>
<p>Synchronise the client's state with the latest state on the server. Clients use
this API when they first log in to get an initial snapshot of the state on the
server, and then continue to call this API to get incremental deltas to the
state, and to receive new messages.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="14%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>filter</td>
<td>string</td>
<td>The ID of a filter created using the filter API.</td>
</tr>
<tr><td>since</td>
<td>string</td>
<td>A point in time to continue a sync from.</td>
</tr>
<tr><td>full_state</td>
<td>boolean</td>
<td><p class="first">Controls whether to include the full state for all
rooms the user is a member of.</p>
<p>If this is set to <tt class="docutils literal">true</tt>, then all state events
will be returned, even if <tt class="docutils literal">since</tt> is non-empty.
The timeline will still be limited by the
<tt class="docutils literal">since</tt> parameter. In this case, the <tt class="docutils literal">timeout</tt>
parameter will be ignored and the query will
return immediately, possibly with an empty
timeline.</p>
<p>If <tt class="docutils literal">false</tt>, and <tt class="docutils literal">since</tt> is non-empty, only
state which has changed since the point indicated
by <tt class="docutils literal">since</tt> will be returned.</p>
<p class="last">By default, this is <tt class="docutils literal">false</tt>.</p>
</td>
</tr>
<tr><td>set_presence</td>
<td>enum</td>
<td>Controls whether the client is automatically
marked as online by polling this API. If this
parameter is omitted then the client is
automatically marked as online when it uses this
API. Otherwise if the parameter is set to
&quot;offline&quot; then the client is not marked as being
online when it uses this API. One of: [&quot;offline&quot;]</td>
</tr>
<tr><td>timeout</td>
<td>integer</td>
<td>The maximum time to poll in milliseconds before
returning this request.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>next_batch</td>
<td>string</td>
<td>The batch token to supply in the <tt class="docutils literal">since</tt> param
of the next <tt class="docutils literal">/sync</tt> request.</td>
</tr>
<tr><td>presence</td>
<td>{Presence}</td>
<td>The updates to the presence status of other users.</td>
</tr>
<tr><td>rooms</td>
<td>{Rooms}</td>
<td>Updates to rooms.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Presence</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[NO_TITLE]</td>
<td>List of events</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">NO_TITLE</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="18%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>{EventContent}</td>
<td>The content of this event. The fields in this
object will vary depending on the type of event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td>Timestamp in milliseconds on originating
homeserver when this event was sent.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td>The MXID of the user who sent this event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>Optional. This key will only be present for state
events. A unique key which defines the overwriting
semantics for this piece of room state.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td>The type of event.</td>
</tr>
<tr><td>unsigned</td>
<td>{Unsigned}</td>
<td>Information about this event which was not sent by
the originating homeserver</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Unsigned</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="18%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>Time in milliseconds since the event was sent.</td>
</tr>
<tr><td>prev_content</td>
<td>{EventContent}</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this state.
This will be present only for state events
appearing in the <tt class="docutils literal">timeline</tt>. If this is not a
state event, or there is no previous content, this
key will be missing.</td>
</tr>
<tr><td>replaces_state</td>
<td>string</td>
<td>Optional. The event_id of the previous event for
this state. This will be present only for state
events appearing in the <tt class="docutils literal">timeline</tt>. If this is
not a state event, or there is no previous
content, this key will be missing.</td>
</tr>
<tr><td>transaction_id</td>
<td>string</td>
<td>Optional. The transaction ID set when this message
was sent. This key will only be present for
message events sent by the device calling this
API.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Rooms</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="27%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>invite</td>
<td>{string: Invited Room}</td>
<td>The rooms that the user has been invited to.</td>
</tr>
<tr><td>join</td>
<td>{string: Joined Room}</td>
<td>The rooms that the user has joined.</td>
</tr>
<tr><td>leave</td>
<td>{string: Left Room}</td>
<td>The rooms that the user has left or been banned
from.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Invited Room</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="17%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>invite_state</td>
<td>{InviteState}</td>
<td>The state of a room that the user has been invited
to. These state events may only have the
<tt class="docutils literal">sender</tt>, <tt class="docutils literal">type</tt>, <tt class="docutils literal">state_key</tt> and
<tt class="docutils literal">content</tt> keys present. These events do not
replace any state that the client already has for
the room, for example if the client has archived
the room. Instead the client should keep two
separate copies of the state: the one from the
<tt class="docutils literal">invite_state</tt> and one from the archived
<tt class="docutils literal">state</tt>. If the client joins the room then the
current state will be given as a delta against the
archived <tt class="docutils literal">state</tt> not the <tt class="docutils literal">invite_state</tt>.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">InviteState</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[NO_TITLE]</td>
<td>List of events</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Joined Room</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="15%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>ephemeral</td>
<td>{Ephemeral}</td>
<td>The ephemeral events in the room that aren't
recorded in the timeline or state of the room.
e.g. typing.</td>
</tr>
<tr><td>state</td>
<td>{State}</td>
<td>Updates to the state, between the time indicated
by the <tt class="docutils literal">since</tt> parameter, and the start of the
<tt class="docutils literal">timeline</tt> (or all state up to the start of the
<tt class="docutils literal">timeline</tt>, if <tt class="docutils literal">since</tt> is not given, or
<tt class="docutils literal">full_state</tt> is true).</td>
</tr>
<tr><td>timeline</td>
<td>{Timeline}</td>
<td>The timeline of messages and state changes in the
room.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Ephemeral</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[NO_TITLE]</td>
<td>List of events</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">State</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>events</td>
<td>[NO_TITLE]</td>
<td>List of events</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Timeline</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>limited</td>
<td>boolean</td>
<td>True if the number of events returned was limited
by the <tt class="docutils literal">limit</tt> on the filter</td>
</tr>
<tr><td>prev_batch</td>
<td>string</td>
<td>If the batch was limited then this is a token that
can be supplied to the server to retrieve earlier
events</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Left Room</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>state</td>
<td>{State}</td>
<td>The state updates for the room up to the start of
the timeline.</td>
</tr>
<tr><td>timeline</td>
<td>{Timeline}</td>
<td>The timeline of messages and state changes in the
room up to the point when the user left.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/v2_alpha/sync?filter=66696p746572&amp;since=s72594_4483_1934&amp;full_state=false&amp;set_presence=offline&amp;timeout=30000</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The initial snapshot or delta for the client to use to update their state.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;next_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s72595_4483_1934&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.presence&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;online&quot;</span><span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">]</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;rooms&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;join&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;!726s6s6q:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">},</span>
              <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1417731086795</span><span class="punctuation">,</span>
              <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$66697273743031:example.com&quot;</span>
            <span class="punctuation">}</span>
          <span class="punctuation">]</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;timeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">},</span>
              <span class="name tag">&quot;prev_content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span><span class="punctuation">},</span>
              <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1417731086795</span><span class="punctuation">,</span>
              <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$7365636s6r6432:example.com&quot;</span>
            <span class="punctuation">},</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">124524</span><span class="punctuation">,</span>
              <span class="name tag">&quot;txn_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;1234&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;I am a fish&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
              <span class="punctuation">},</span>
              <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1417731086797</span><span class="punctuation">,</span>
              <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$74686972643033:example.com&quot;</span>
            <span class="punctuation">}</span>
          <span class="punctuation">],</span>
          <span class="name tag">&quot;limited&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
          <span class="name tag">&quot;prev_batch&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t34-23535_0_0&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;ephemeral&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.typing&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="name tag">&quot;user_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">]}</span>
            <span class="punctuation">}</span>
          <span class="punctuation">]</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;invite&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;!696r7674:example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;invite_state&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.name&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;My Room Name&quot;</span><span class="punctuation">}</span>
            <span class="punctuation">},</span>
            <span class="punctuation">{</span>
              <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span><span class="punctuation">}</span>
            <span class="punctuation">}</span>
          <span class="punctuation">]</span>
        <span class="punctuation">}</span>
      <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;leave&quot;</span><span class="punctuation">:</span> <span class="punctuation">{}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="getting-events-for-a-room"></a></p>
<div class="section" id="getting-events-for-a-room">
<h3><a class="toc-backref" href="#id102">4.3.3&nbsp;&nbsp;&nbsp;Getting events for a room</a></h3>
<p>There are several APIs provided to <tt class="docutils literal">GET</tt> events for a room:</p>
<p><a class="anchor" id="get-matrix-client-api-v1-rooms-roomid-initialsync"></a></p>
<div class="section" id="get-matrix-client-api-v1-rooms-roomid-initialsync">
<h4><a class="toc-backref" href="#id103">4.3.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/initialSync</span></tt></a></h4>
<p>Get a copy of the current state and the most recent messages in a room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to get the data.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<p><tt class="docutils literal">RoomInfo</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="22%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>membership</td>
<td>enum</td>
<td>The user's membership state in this room. One of:
[&quot;invite&quot;, &quot;join&quot;, &quot;leave&quot;, &quot;ban&quot;]</td>
</tr>
<tr><td>messages</td>
<td>{PaginationChunk}</td>
<td>The pagination chunk for this room.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>The ID of this room.</td>
</tr>
<tr><td>state</td>
<td>[StateEvent]</td>
<td>If the user is a member of the room this will be
the current state of the room as a list of events.
If the user has left the room this will be the
state of the room when they left it.</td>
</tr>
<tr><td>visibility</td>
<td>enum</td>
<td>Whether this room is visible to the
<tt class="docutils literal">/publicRooms</tt> API or not.&quot; One of: [&quot;private&quot;,
&quot;public&quot;]</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">PaginationChunk</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="15%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[RoomEvent]</td>
<td>If the user is a member of the room this will be a
list of the most recent messages for this room. If
the user has left the room this will be the
messages that preceeded them leaving. This array
will consist of at most <tt class="docutils literal">limit</tt> elements.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>A token which correlates to the last value in
<tt class="docutils literal">chunk</tt>. Used for pagination.</td>
</tr>
<tr><td>start</td>
<td>string</td>
<td>A token which correlates to the first value in
<tt class="docutils literal">chunk</tt>. Used for pagination.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">RoomEvent</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>The globally unique event identifier.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>The ID of the room associated with this event.</td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td>Contains the fully-qualified ID of the user who
<em>sent</em> this event.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">StateEvent</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="18%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>prev_content</td>
<td>{EventContent}</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>A unique key which defines the overwriting
semantics for this piece of room state. This value
is often a zero-length string. The presence of
this key makes this event a State Event. The key
MUST NOT start with '_'.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21636q39766251%3Aexample.com/initialSync</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The current state of the room</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;messages&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">343513403</span><span class="punctuation">,</span>
        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;foo&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14328044851tzTJS:example.com&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432804485886</span><span class="punctuation">,</span>
        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
      <span class="punctuation">},</span>
      <span class="punctuation">{</span>
        <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">343511809</span><span class="punctuation">,</span>
        <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;bar&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14328044872spjFg:example.com&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432804487480</span><span class="punctuation">,</span>
        <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span>
      <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3456_9_0&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t44-3453_9_0&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">7148266897</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;join_rule&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14259997323TLwtb:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1425999732392</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.join_rules&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">6547561012</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.com/fzysBrHpPEeTGANCVLXWXNMI#auto&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="keyword constant">null</span><span class="punctuation">,</span>
        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1426600438280zExKY:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1426600438277</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">7148267200</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;creator&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14259997320KhbwJ:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1425999732089</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.create&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1622568720</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.com/GCmhgzMPRjqgpODLsNQzVuHZ#auto&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bob&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1431525430134MxlLX:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431525430569</span><span class="punctuation">,</span>
      <span class="name tag">&quot;replaces_state&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$142652023736BSXcM:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">7148267004</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ban&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;m.room.name&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span><span class="punctuation">,</span>
          <span class="name tag">&quot;m.room.power_levels&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;events_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
        <span class="name tag">&quot;kick&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;redact&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;state_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;users_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14259997322mqfaq:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1425999732285</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.power_levels&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;visibility&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;private&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-rooms-roomid-members"></a></p>
<div class="section" id="get-matrix-client-api-v1-rooms-roomid-members">
<h4><a class="toc-backref" href="#id104">4.3.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/members</span></tt></a></h4>
<p>Get the list of members for this room.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to get the member events
for.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="18%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[MemberEvent]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">MemberEvent</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="18%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>{EventContent}</td>
<td>&nbsp;</td>
</tr>
<tr><td>invite_room_state</td>
<td>[StrippedState]</td>
<td>A subset of the state of the room at the time of
the invite, if <tt class="docutils literal">membership</tt> is <tt class="docutils literal">invite</tt></td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>The <tt class="docutils literal">user_id</tt> this membership event relates to.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td>Must be 'm.room.member'.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">EventContent</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="17%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The avatar URL for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>displayname</td>
<td>string or null</td>
<td>The display name for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>membership</td>
<td>enum</td>
<td>The membership state of the user. One of:
[&quot;invite&quot;, &quot;join&quot;, &quot;knock&quot;, &quot;leave&quot;, &quot;ban&quot;]</td>
</tr>
<tr><td>third_party_invite</td>
<td>{Invite}</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Invite</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>signed</td>
<td>{signed}</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">signed</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="17%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mxid</td>
<td>string</td>
<td>The invited matrix user ID. Must be equal to the
user_id property of the event.</td>
</tr>
<tr><td>signatures</td>
<td>{Signatures}</td>
<td>A single signature from the verifying server, in
the format specified by the Signing Events
section.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td>The token property of the containing
third_party_invite object.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">StrippedState</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="19%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>{EventContent}</td>
<td>The <tt class="docutils literal">content</tt> for the event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>The <tt class="docutils literal">state_key</tt> for the event.</td>
</tr>
<tr><td>type</td>
<td>enum</td>
<td>The <tt class="docutils literal">type</tt> for the event. One of:
[&quot;m.room.join_rules&quot;, &quot;m.room.canonical_alias&quot;,
&quot;m.room.avatar&quot;, &quot;m.room.name&quot;]</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21636q39766251%3Aexample.com/members</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of members of the room. If you are joined to the room then
this will be the current members of the room. If you have left te
room then this will be the members of the room when you left.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">6547561012</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.com/fzysBrHpPEeTGANCVLXWXNMI#auto&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="keyword constant">null</span><span class="punctuation">,</span>
        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1426600438280zExKY:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1426600438277</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1622568720</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.com/GCmhgzMPRjqgpODLsNQzVuHZ#auto&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bob&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1431525430134MxlLX:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431525430569</span><span class="punctuation">,</span>
      <span class="name tag">&quot;replaces_state&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$142652023736BSXcM:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-rooms-roomid-state"></a></p>
<div class="section" id="get-matrix-client-api-v1-rooms-roomid-state">
<h4><a class="toc-backref" href="#id105">4.3.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/state</span></tt></a></h4>
<p>Get the state events for the current state of a room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to look up the state for.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<p><tt class="docutils literal">RoomState</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="17%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>N/A</td>
<td>[StateEvent]</td>
<td>If the user is a member of the room this will be
the current state of the room as a list of events.
If the user has left the room then this will be
the state of the room when they left as a list of
events.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21636q39766251%3Aexample.com/state</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The current state of the room</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">[</span>
  <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">7148266897</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;join_rule&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14259997323TLwtb:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1425999732392</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.join_rules&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
  <span class="punctuation">},</span>
  <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">6547561012</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.com/fzysBrHpPEeTGANCVLXWXNMI#auto&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="keyword constant">null</span><span class="punctuation">,</span>
          <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1426600438280zExKY:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1426600438277</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
  <span class="punctuation">},</span>
  <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">7148267200</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;creator&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14259997320KhbwJ:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1425999732089</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.create&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
  <span class="punctuation">},</span>
  <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1622568720</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.com/GCmhgzMPRjqgpODLsNQzVuHZ#auto&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bob&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1431525430134MxlLX:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431525430569</span><span class="punctuation">,</span>
      <span class="name tag">&quot;replaces_state&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$142652023736BSXcM:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span>
  <span class="punctuation">},</span>
  <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">7148267004</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;ban&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
          <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
              <span class="name tag">&quot;m.room.name&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span><span class="punctuation">,</span>
              <span class="name tag">&quot;m.room.power_levels&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
           <span class="punctuation">},</span>
           <span class="name tag">&quot;events_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
           <span class="name tag">&quot;kick&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
           <span class="name tag">&quot;redact&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
           <span class="name tag">&quot;state_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
           <span class="name tag">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
               <span class="name tag">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
           <span class="punctuation">},</span>
           <span class="name tag">&quot;users_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14259997322mqfaq:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1425999732285</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!636q39766251:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.power_levels&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">]</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-rooms-roomid-state-eventtype-statekey"></a></p>
<div class="section" id="get-matrix-client-api-v1-rooms-roomid-state-eventtype-statekey">
<h4><a class="toc-backref" href="#id106">4.3.3.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/state/{eventType}/{stateKey}</span></tt></a></h4>
<p>Looks up the contents of a state event in a room. If the user is joined to the
room then the state is taken from the current state of the room. If the user has
left the room then the state is taken from the state of the room when they left.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to look up the state in.</td>
</tr>
<tr><td>eventType</td>
<td>string</td>
<td><strong>Required.</strong> The type of state to look up.</td>
</tr>
<tr><td>stateKey</td>
<td>string</td>
<td><strong>Required.</strong> The key of the state to look up.
Defaults to the empty string.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21636q39766251%3Aexample.com/state/m.room.name/</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The content of the state event.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span><span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Example room name&quot;</span><span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-rooms-roomid-messages"></a></p>
<div class="section" id="get-matrix-client-api-v1-rooms-roomid-messages">
<h4><a class="toc-backref" href="#id107">4.3.3.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/messages</span></tt></a></h4>
<p>This API returns a list of message and state events for a room. It uses
pagination query parameters to paginate history in the room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to get events from.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>from</td>
<td>string</td>
<td><strong>Required.</strong> The token to start returning events
from. This token can be obtained from the initial
sync API.</td>
</tr>
<tr><td>dir</td>
<td>enum</td>
<td><strong>Required.</strong> The direction to return events from.
One of: [&quot;b&quot;, &quot;f&quot;]</td>
</tr>
<tr><td>limit</td>
<td>integer</td>
<td>The maximum number of events to return. Default:
10.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="15%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[RoomEvent]</td>
<td>A list of room events.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>The token the pagination ends at. If <tt class="docutils literal">dir=b</tt>
this token should be used again to request even
earlier events.</td>
</tr>
<tr><td>start</td>
<td>string</td>
<td>The token to start paginating from. If <tt class="docutils literal">dir=b</tt>
this will be the token supplied in <tt class="docutils literal">from</tt>.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21636q39766251%3Aexample.com/messages?from=s345_678_333&amp;dir=b&amp;limit=3</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of messages with a new token to request more.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t47429-4392820_219380_26003_2265&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;t47409-4357353_219380_26003_2265&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1444812213737</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1444812213350496Caaaa:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;hello world&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;m.text&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;!Xq3620DUiqCaoxq:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1042</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1444812194656</span> <span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1444812213350496Cbbbb:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;the world is big&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;m.text&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;!Xq3620DUiqCaoxq:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">20123</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1444812163990</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1444812213350496Ccccc:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;New room name&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;prev_content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Old room name&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;!Xq3620DUiqCaoxq:example.com&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;m.room.name&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50789</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="sending-events-to-a-room"></a></p>
<div class="section" id="sending-events-to-a-room">
<h3><a class="toc-backref" href="#id108">4.3.4&nbsp;&nbsp;&nbsp;Sending events to a room</a></h3>
<p><a class="anchor" id="put-matrix-client-api-v1-rooms-roomid-state-eventtype-statekey"></a></p>
<div class="section" id="put-matrix-client-api-v1-rooms-roomid-state-eventtype-statekey">
<h4><a class="toc-backref" href="#id109">4.3.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/state/{eventType}/{stateKey}</span></tt></a></h4>
<p>State events can be sent using this endpoint.  These events will be overwritten
if <tt class="docutils literal">&lt;room id&gt;</tt>, <tt class="docutils literal">&lt;event type&gt;</tt> and <tt class="docutils literal">&lt;state key&gt;</tt> all match.  If the state
event has an empty <tt class="docutils literal">state_key</tt>, it can be omitted from the path.</p>
<p>Requests to this endpoint <strong>cannot use transaction IDs</strong> like other <tt class="docutils literal">PUT</tt>
paths because they cannot be differentiated from the <tt class="docutils literal">state_key</tt>. Furthermore,
<tt class="docutils literal">POST</tt> is unsupported on state paths.</p>
<p>The body of the request should be the content object of the event; the fields in
this object will vary depending on the type of event. See <a class="reference internal" href="#room-events">Room Events</a> for the
<tt class="docutils literal">m.</tt> event specification.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to set the state in</td>
</tr>
<tr><td>eventType</td>
<td>string</td>
<td><strong>Required.</strong> The type of event to send.</td>
</tr>
<tr><td>stateKey</td>
<td>string</td>
<td><strong>Required.</strong> The state_key for the state to send.
Defaults to the empty string.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>A unique identifier for the event.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21636q39766251%3Aexample.com/state/m.room.name/</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
    <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;New name for the room&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>An ID for the sent event.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;YUwRidLecu&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Examples</strong></p>
<p>Valid requests look like:</p>
<pre class="literal-block">
PUT /rooms/!roomid:domain/state/m.example.event
{ &quot;key&quot; : &quot;without a state key&quot; }

PUT /rooms/!roomid:domain/state/m.another.example.event/foo
{ &quot;key&quot; : &quot;with 'foo' as the state key&quot; }
</pre>
<p>In contrast, these requests are invalid:</p>
<pre class="literal-block">
POST /rooms/!roomid:domain/state/m.example.event/
{ &quot;key&quot; : &quot;cannot use POST here&quot; }

PUT /rooms/!roomid:domain/state/m.another.example.event/foo/11
{ &quot;key&quot; : &quot;txnIds are not supported&quot; }
</pre>
<p>Care should be taken to avoid setting the wrong <tt class="docutils literal">state key</tt>:</p>
<pre class="literal-block">
PUT /rooms/!roomid:domain/state/m.another.example.event/11
{ &quot;key&quot; : &quot;with '11' as the state key, but was probably intended to be a txnId&quot; }
</pre>
<p>The <tt class="docutils literal">state_key</tt> is often used to store state about individual users, by using
the user ID as the <tt class="docutils literal">state_key</tt> value. For example:</p>
<pre class="literal-block">
PUT /rooms/!roomid:domain/state/m.favorite.animal.event/%40my_user%3Adomain.com
{ &quot;animal&quot; : &quot;cat&quot;, &quot;reason&quot;: &quot;fluffy&quot; }
</pre>
<p>In some cases, there may be no need for a <tt class="docutils literal">state_key</tt>, so it can be omitted:</p>
<pre class="literal-block">
PUT /rooms/!roomid:domain/state/m.room.bgd.color
{ &quot;color&quot;: &quot;red&quot;, &quot;hex&quot;: &quot;#ff0000&quot; }
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-api-v1-rooms-roomid-send-eventtype"></a></p>
<div class="section" id="post-matrix-client-api-v1-rooms-roomid-send-eventtype">
<h4><a class="toc-backref" href="#id110">4.3.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/send/{eventType}</span></tt></a></h4>
<p>This endpoint can be used to send a message event to a room; however the lack of
a transaction ID means that it is possible to cause message duplication if
events are resent on error, so it is preferable to use <a class="reference internal" href="#put-matrix-client-api-v1-rooms-roomid-send-eventtype-txnid">PUT
/_matrix/client/api/v1/rooms/{roomId}/send/{eventType}/{txnId}</a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to send the event to.</td>
</tr>
<tr><td>eventType</td>
<td>string</td>
<td><strong>Required.</strong> The type of event to send.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>A unique identifier for the event.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21636q39766251%3Aexample.com/send/m.room.message</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;hello&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>An ID for the sent event.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;YUwRidLecu&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-api-v1-rooms-roomid-send-eventtype-txnid"></a></p>
<div class="section" id="put-matrix-client-api-v1-rooms-roomid-send-eventtype-txnid">
<h4><a class="toc-backref" href="#id111">4.3.4.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/send/{eventType}/{txnId}</span></tt></a></h4>
<p>This endpoint is used to send a message event to a room. Message events allow
access to historical events and pagination, making them suited for &quot;once-off&quot;
activity in a room.</p>
<p>The body of the request should be the content object of the event; the fields in
this object will vary depending on the type of event. See <a class="reference internal" href="#room-events">Room Events</a> for the
m. event specification.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room to send the event to.</td>
</tr>
<tr><td>eventType</td>
<td>string</td>
<td><strong>Required.</strong> The type of event to send.</td>
</tr>
<tr><td>txnId</td>
<td>string</td>
<td><strong>Required.</strong> The transaction ID for this event.
Clients should generate a unique ID; it will be
used by the server to ensure idempotency of
requests.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>A unique identifier for the event.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21636q39766251%3Aexample.com/send/m.room.message/35</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;hello&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>An ID for the sent event.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;YUwRidLecu&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="redactions"></a></p>
<div class="section" id="redactions">
<h3><a class="toc-backref" href="#id112">4.3.5&nbsp;&nbsp;&nbsp;Redactions</a></h3>
<p>Since events are extensible it is possible for malicious users and/or servers
to add keys that are, for example offensive or illegal. Since some events
cannot be simply deleted, e.g. membership events, we instead 'redact' events.
This involves removing all keys from an event that are not required by the
protocol. This stripped down event is thereafter returned anytime a client or
remote server requests it. Redacting an event cannot be undone, allowing server
owners to delete the offending content from the databases. Events that have been
redacted include a <tt class="docutils literal">redacted_because</tt> key whose value is the event that caused
it to be redacted, which may include a reason.</p>
<!-- TODO
Currently, only room admins can redact events by sending a ``m.room.redaction``
event, but server admins also need to be able to redact events by a similar
mechanism. -->
<p>Upon receipt of a redaction event, the server should strip off any keys not in
the following list:</p>
<ul class="simple">
<li><tt class="docutils literal">event_id</tt></li>
<li><tt class="docutils literal">type</tt></li>
<li><tt class="docutils literal">room_id</tt></li>
<li><tt class="docutils literal">user_id</tt></li>
<li><tt class="docutils literal">state_key</tt></li>
<li><tt class="docutils literal">prev_state</tt></li>
<li><tt class="docutils literal">content</tt></li>
</ul>
<p>The content object should also be stripped of all keys, unless it is one of
one of the following event types:</p>
<ul>
<li><p class="first"><tt class="docutils literal">m.room.member</tt> allows key <tt class="docutils literal">membership</tt></p>
</li>
<li><p class="first"><tt class="docutils literal">m.room.create</tt> allows key <tt class="docutils literal">creator</tt></p>
</li>
<li><p class="first"><tt class="docutils literal">m.room.join_rules</tt> allows key <tt class="docutils literal">join_rule</tt></p>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">m.room.power_levels</tt> allows keys <tt class="docutils literal">ban</tt>, <tt class="docutils literal">events</tt>, <tt class="docutils literal">events_default</tt>,</dt>
<dd><p class="first last"><tt class="docutils literal">kick</tt>, <tt class="docutils literal">redact</tt>, <tt class="docutils literal">state_default</tt>, <tt class="docutils literal">users</tt>, <tt class="docutils literal">users_default</tt>.</p>
</dd>
</dl>
</li>
<li><p class="first"><tt class="docutils literal">m.room.aliases</tt> allows key <tt class="docutils literal">aliases</tt></p>
</li>
</ul>
<!-- TODO
Need to update m.room.power_levels to reflect new power levels formatting -->
<p>The redaction event should be added under the key <tt class="docutils literal">redacted_because</tt>. When a
client receives a redaction event it should change the redacted event
in the same way a server does.</p>
</div>
</div>
<p><a class="anchor" id="rooms"></a></p>
<div class="section" id="rooms">
<h2><a class="toc-backref" href="#id113">4.4&nbsp;&nbsp;&nbsp;Rooms</a></h2>
<p><a class="anchor" id="creation"></a></p>
<div class="section" id="creation">
<h3><a class="toc-backref" href="#id114">4.4.1&nbsp;&nbsp;&nbsp;Creation</a></h3>
<p>The home server will create an <tt class="docutils literal">m.room.create</tt> event when a room is created,
which serves as the root of the event graph for this room. This event also has a
<tt class="docutils literal">creator</tt> key which contains the user ID of the room creator. It will also
generate several other events in order to manage permissions in this room. This
includes:</p>
<ul>
<li><dl class="first docutils">
<dt><tt class="docutils literal">m.room.power_levels</tt> <span class="classifier-delimiter">:</span> <span class="classifier">Sets the power levels of users and required power</span></dt>
<dd><p class="first last">levels for various actions within the room such as sending events.</p>
</dd>
</dl>
</li>
<li><p class="first"><tt class="docutils literal">m.room.join_rules</tt> : Whether the room is &quot;invite-only&quot; or not.</p>
</li>
</ul>
<p>See <a class="reference internal" href="#room-events">Room Events</a> for more information on these events. To create a room, a
client has to use the the following API.</p>
<p><a class="anchor" id="post-matrix-client-api-v1-createroom"></a></p>
<div class="section" id="post-matrix-client-api-v1-createroom">
<h4><a class="toc-backref" href="#id115">4.4.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v1/createRoom</tt></a></h4>
<p>Create a new room with various configuration options.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="15%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>invite</td>
<td>array[string]</td>
<td>A list of user IDs to invite to the room. This
will tell the server to invite everyone in the
list to the newly created room.</td>
</tr>
<tr><td>room_alias_name</td>
<td>string</td>
<td>The desired room alias <strong>local part</strong>. If this is
included, a room alias will be created and mapped
to the newly created room. The alias will belong
on the <em>same</em> home server which created the room.
For example, if this was set to &quot;foo&quot; and sent to
the homeserver &quot;example.com&quot; the complete room
alias would be <tt class="docutils literal">#foo:example.com</tt>.</td>
</tr>
<tr><td>visibility</td>
<td>string</td>
<td>A <tt class="docutils literal">public</tt> visibility indicates that the room
will be shown in the published room list. A
<tt class="docutils literal">private</tt> visibility will hide the room from the
published room list. Rooms default to <tt class="docutils literal">private</tt>
visibility if this key is not included. NB: This
should not be confused with <tt class="docutils literal">join_rules</tt> which
also uses the word <tt class="docutils literal">public</tt>.</td>
</tr>
<tr><td>topic</td>
<td>string</td>
<td>If this is included, an <tt class="docutils literal">m.room.topic</tt> event
will be sent into the room to indicate the topic
for the room. See Room Events for more information
on <tt class="docutils literal">m.room.topic</tt>.</td>
</tr>
<tr><td>preset</td>
<td>string</td>
<td><p class="first">Convenience parameter for setting various default
state events based on a preset. Must be either:</p>
<p><tt class="docutils literal">private_chat</tt> =&gt;   <tt class="docutils literal">join_rules</tt> is set to
<tt class="docutils literal">invite</tt>.   <tt class="docutils literal">history_visibility</tt> is set to
<tt class="docutils literal">shared</tt>.</p>
<p><tt class="docutils literal">trusted_private_chat</tt> =&gt;     <tt class="docutils literal">join_rules</tt> is
set to <tt class="docutils literal">invite</tt>.     <tt class="docutils literal">history_visibility</tt> is
set to <tt class="docutils literal">shared</tt>.     All invitees are given the
same power level as the room creator.</p>
<p class="last"><tt class="docutils literal">public_chat</tt>: =&gt;     <tt class="docutils literal">join_rules</tt> is set to
<tt class="docutils literal">public</tt>.     <tt class="docutils literal">history_visibility</tt> is set to
<tt class="docutils literal">shared</tt>.</p>
</td>
</tr>
<tr><td>creation_content</td>
<td>object</td>
<td>Extra keys to be added to the content of the
<tt class="docutils literal">m.room.create</tt>. The server will clober the
following keys: <tt class="docutils literal">creator</tt>. Future versions of
the specification may allow the server to clobber
other keys.</td>
</tr>
<tr><td>initial_state</td>
<td>array[object]</td>
<td>A list of state events to set in the new room.
This allows the user to override the default state
events set in the new room. The expected format of
the state events are an object with type,
state_key and content keys set. Takes precedence
over events set by <tt class="docutils literal">presets</tt>, but gets overriden
by <tt class="docutils literal">name</tt> and <tt class="docutils literal">topic</tt> keys.</td>
</tr>
<tr><td>initial_state[0].content</td>
<td>string</td>
<td>&nbsp;</td>
</tr>
<tr><td>initial_state[0].state_key</td>
<td>string</td>
<td>&nbsp;</td>
</tr>
<tr><td>initial_state[0].type</td>
<td>string</td>
<td>&nbsp;</td>
</tr>
<tr><td>name</td>
<td>string</td>
<td>If this is included, an <tt class="docutils literal">m.room.name</tt> event will
be sent into the room to indicate the name of the
room. See Room Events for more information on
<tt class="docutils literal">m.room.name</tt>.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td>The created room's ID.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/createRoom</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;preset&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public_chat&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;room_alias_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;thepub&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The Grand Duke Pub&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;All about happy hour&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;creation_content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;m.federate&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>Information about the newly created room.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!sefiuhWgwghwWgh:example.com&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id2"></a></p>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id116">4.4.2&nbsp;&nbsp;&nbsp;Room aliases</a></h3>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">This section is a work in progress.</p>
</div>
<p>Room aliases can be created by sending a <tt class="docutils literal">PUT <span class="pre">/directory/room/&lt;room</span> alias&gt;</tt>:</p>
<pre class="literal-block">
{
  &quot;room_id&quot;: &lt;room id&gt;
}
</pre>
<p>They can be deleted by sending a <tt class="docutils literal">DELETE <span class="pre">/directory/room/&lt;room</span> alias&gt;</tt> with
no content. Only some privileged users may be able to delete room aliases, e.g.
server admins, the creator of the room alias, etc. This specification does not
outline the privilege level required for deleting room aliases.</p>
<p>As room aliases are scoped to a particular home server domain name, it is
likely that a home server will reject attempts to maintain aliases on other
domain names. This specification does not provide a way for home servers to
send update requests to other servers.</p>
<p>Rooms store a <em>partial</em> list of room aliases via the <tt class="docutils literal">m.room.aliases</tt> state
event. This alias list is partial because it cannot guarantee that the alias
list is in any way accurate or up-to-date, as room aliases can point to
different room IDs over time. Crucially, the aliases in this event are
<strong>purely informational</strong> and SHOULD NOT be treated as accurate. They SHOULD
be checked before they are used or shared with another user. If a room
appears to have a room alias of <tt class="docutils literal">#alias:example.com</tt>, this SHOULD be checked
to make sure that the room's ID matches the <tt class="docutils literal">room_id</tt> returned from the
request.</p>
<p>Room aliases can be checked in the same way they are resolved; by sending a
<tt class="docutils literal">GET <span class="pre">/directory/room/&lt;room</span> alias&gt;</tt>:</p>
<pre class="literal-block">
{
  &quot;room_id&quot;: &lt;room id&gt;,
  &quot;servers&quot;: [ &lt;domain&gt;, &lt;domain2&gt;, &lt;domain3&gt; ]
}
</pre>
<p>Home servers can respond to resolve requests for aliases on other domains than
their own by using the federation API to ask other domain name home servers.</p>
</div>
<p><a class="anchor" id="permissions"></a></p>
<div class="section" id="permissions">
<h3><a class="toc-backref" href="#id117">4.4.3&nbsp;&nbsp;&nbsp;Permissions</a></h3>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">This section is a work in progress.</p>
</div>
<p>Permissions for rooms are done via the concept of power levels - to do any
action in a room a user must have a suitable power level. Power levels are
stored as state events in a given room. The power levels required for operations
and the power levels for users are defined in <tt class="docutils literal">m.room.power_levels</tt>, where
both a default and specific users' power levels can be set.
By default all users have a power level of 0, other than the room creator whose
power level defaults to 100. Users can grant other users increased power levels
up to their own power level. For example, user A with a power level of 50 could
increase the power level of user B to a maximum of level 50. Power levels for
users are tracked per-room even if the user is not present in the room.
The keys contained in <tt class="docutils literal">m.room.power_levels</tt> determine the levels required for
certain operations such as kicking, banning and sending state events. See
<a class="reference internal" href="#m-room-power-levels">m.room.power_levels</a> for more information.</p>
</div>
<p><a class="anchor" id="joining-rooms"></a></p>
<div class="section" id="joining-rooms">
<h3><a class="toc-backref" href="#id118">4.4.4&nbsp;&nbsp;&nbsp;Joining rooms</a></h3>
<p>Users need to be a member of a room in order to send and receive events in that
room. There are several states in which a user may be, in relation to a room:</p>
<ul class="simple">
<li>Unrelated (the user cannot send or receive events in the room)</li>
<li>Invited (the user has been invited to participate in the room, but is not
yet participating)</li>
<li>Joined (the user can send and receive events in the room)</li>
<li>Banned (the user is not allowed to join the room)</li>
</ul>
<p>There is an exception to the requirement that a user join a room before sending
events to it: users may send an <tt class="docutils literal">m.room.member</tt> event to a room with
<tt class="docutils literal">content.membership</tt> set to <tt class="docutils literal">leave</tt> to reject an invitation if they have
currently been invited to a room but have not joined it.</p>
<p>Some rooms require that users be invited to it before they can join; others
allow anyone to join. Whether a given room is an &quot;invite-only&quot; room is
determined by the room config key <tt class="docutils literal">m.room.join_rules</tt>. It can have one of the
following values:</p>
<dl class="docutils">
<dt><tt class="docutils literal">public</tt></dt>
<dd>This room is free for anyone to join without an invite.</dd>
<dt><tt class="docutils literal">invite</tt></dt>
<dd>This room can only be joined if you were invited.</dd>
</dl>
<p><a class="anchor" id="post-matrix-client-api-v1-rooms-roomid-invite"></a></p>
<div class="section" id="post-matrix-client-api-v1-rooms-roomid-invite">
<h4><a class="toc-backref" href="#id119">4.4.4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/invite</span></tt></a></h4>
<p id="invite-by-user-id-endpoint"><em>Note that there are two forms of this API, which are documented separately.
This version of the API requires that the inviter knows the Matrix identifier of
the invitee. The other is documented in the</em> <a class="reference internal" href="#invite-by-third-party-id-endpoint">third party invites section</a>.</p>
<p>This API invites a user to participate in a particular room. They do not start
participating in the room until they actually join the room.</p>
<p>Only users currently in a particular room can invite other users to join that
room.</p>
<p>If the user was invited to the room, the home server will append a
<tt class="docutils literal">m.room.member</tt> event to the room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier (not alias) to
which to invite the user.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td><strong>Required.</strong> The fully qualified user ID of the
invitee.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21d41d8cd%3Amatrix.org/invite</span>  <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The user has been invited to join the room.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You do not have permission to invite the user to the room. A meaningful <tt class="docutils literal">errcode</tt> and description error text will be returned. Example reasons for rejections are:</p>
<ul class="simple">
<li>The invitee has been banned from the room.</li>
<li>The invitee is already a member of the room.</li>
<li>The inviter is not currently in the room.</li>
<li>The inviter's power level is insufficient to invite users to the room.</li>
</ul>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span><span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span> <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org is banned from the room&quot;</span><span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-api-v1-rooms-roomid-join"></a></p>
<div class="section" id="post-matrix-client-api-v1-rooms-roomid-join">
<h4><a class="toc-backref" href="#id120">4.4.4.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/join</span></tt></a></h4>
<p>This API starts a user participating in a particular room, if that user is
allowed to participate in that room. After this call, the client is allowed to
see all current state events in the room, and all subsequent events associated
with the room until the user leaves the room.</p>
<p>After a user has joined a room, the room will appear as an entry in the response
of the <tt class="docutils literal">/initialSync</tt> API.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier or room alias to
join.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%23monkeys%3Amatrix.org/join</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The room has been joined.</p>
<p>The joined room ID must be returned in the <tt class="docutils literal">room_id</tt> field.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span><span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!d41d8cd:matrix.org&quot;</span><span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You do not have permission to join the room. A meaningful <tt class="docutils literal">errcode</tt> and description error text will be returned. Example reasons for rejection are:</p>
<ul class="simple">
<li>The room is invite-only and the user was not invited.</li>
<li>The user has been banned from the room.</li>
</ul>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span><span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span> <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;You are not invited to this room.&quot;</span><span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-join-roomid"></a></p>
<div class="section" id="post-join-roomid">
<h4><a class="toc-backref" href="#id121">4.4.4.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/join/{roomId}</span></tt></a></h4>
<p><tt class="docutils literal"><span class="pre">/join/{roomId}</span></tt> is an alias for <a class="reference external" href="#post-matrix-client-api-v1-rooms-roomid-join">/_matrix/client/api/v1/rooms/{roomId}/join</a>.</p>
</div>
</div>
<p><a class="anchor" id="leaving-rooms"></a></p>
<div class="section" id="leaving-rooms">
<h3><a class="toc-backref" href="#id122">4.4.5&nbsp;&nbsp;&nbsp;Leaving rooms</a></h3>
<p>A user can leave a room to stop receiving events for that room. A user must
have been invited to or have joined the room before they are eligible to leave
the room. Leaving a room to which the user has been invited rejects the invite.
Once a user leaves a room, it will no longer appear on the <a class="reference external" href="/docs/api/client-server/#!/-events/initial_sync"><tt class="docutils literal">/initialSync</tt></a> API.</p>
<p>Whether or not they actually joined the room, if the room is
an &quot;invite-only&quot; room they will need to be re-invited before they can re-join
the room.</p>
<p><a class="anchor" id="post-matrix-client-api-v1-rooms-roomid-forget"></a></p>
<div class="section" id="post-matrix-client-api-v1-rooms-roomid-forget">
<h4><a class="toc-backref" href="#id123">4.4.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/forget</span></tt></a></h4>
<p>This API stops a user remembering about a particular room.</p>
<p>In general, history is a first class citizen in Matrix. After this API is
called, however, a user will no longer be able to retrieve history for this
room. If all users on a homeserver forget a room, the room is eligible for
deletion from that homeserver.</p>
<p>If the user is currently joined to the room, they will implicitly leave the room
as part of this API call.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier to forget.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21au1ba7o%3Amatrix.org/forget</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The room has been forgotten.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-api-v1-rooms-roomid-leave"></a></p>
<div class="section" id="post-matrix-client-api-v1-rooms-roomid-leave">
<h4><a class="toc-backref" href="#id124">4.4.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/leave</span></tt></a></h4>
<p>This API stops a user participating in a particular room.</p>
<p>If the user was already in the room, they will no longer be able to see new
events in the room. If the room requires an invite to join, they will need to be
re-invited before they can re-join.</p>
<p>If the user was invited to the room, but had not joined, this call serves to
reject the invite.</p>
<p>The user will still be allowed to retrieve history from the room which they were
previously allowed to see.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier to leave.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21nkl290a%3Amatrix.org/leave</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The room has been left.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="banning-users-in-a-room"></a></p>
<div class="section" id="banning-users-in-a-room">
<h3><a class="toc-backref" href="#id125">4.4.6&nbsp;&nbsp;&nbsp;Banning users in a room</a></h3>
<p>A user may decide to ban another user in a room. 'Banning' forces the target
user to leave the room and prevents them from re-joining the room. A banned
user will not be treated as a joined user, and so will not be able to send or
receive events in the room. In order to ban someone, the user performing the
ban MUST have the required power level. To ban a user, a request should be made
to <a class="reference external" href="/docs/api/client-server/#!/-rooms/ban"><tt class="docutils literal"><span class="pre">/rooms/&lt;room_id&gt;/ban</span></tt></a> with:</p>
<pre class="literal-block">
{
  &quot;user_id&quot;: &quot;&lt;user id to ban&quot;
  &quot;reason&quot;: &quot;string: &lt;reason for the ban&gt;&quot;
}
</pre>
<p>Banning a user adjusts the banned member's membership state to <tt class="docutils literal">ban</tt> and
adjusts the power level of this event to a level higher than the banned person.
Like with other membership changes, a user can directly adjust the target
member's state, by making a request to
<tt class="docutils literal"><span class="pre">/rooms/&lt;room</span> <span class="pre">id&gt;/state/m.room.member/&lt;user</span> id&gt;</tt>:</p>
<pre class="literal-block">
{
  &quot;membership&quot;: &quot;ban&quot;
}
</pre>
</div>
<p><a class="anchor" id="listing-rooms"></a></p>
<div class="section" id="listing-rooms">
<h3><a class="toc-backref" href="#id126">4.4.7&nbsp;&nbsp;&nbsp;Listing rooms</a></h3>
<p><a class="anchor" id="get-matrix-client-api-v1-publicrooms"></a></p>
<div class="section" id="get-matrix-client-api-v1-publicrooms">
<h4><a class="toc-backref" href="#id127">4.4.7.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/publicRooms</tt></a></h4>
<p>Lists the public rooms on the server.</p>
<p>This API returns paginated responses.</p>
<p>Request format:</p>
<p><cite>No parameters</cite></p>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="23%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[PublicRoomsChunk]</td>
<td>A paginated chunk of public rooms.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>A pagination token for the response.</td>
</tr>
<tr><td>start</td>
<td>string</td>
<td>A pagination token for the response.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">PublicRoomsChunk</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="13%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>aliases</td>
<td>[string]</td>
<td>Aliases of the room. May be empty.</td>
</tr>
<tr><td>guest_can_join</td>
<td>boolean</td>
<td>Whether guest users may join the room and
participate in it. If they can, they will be
subject to ordinary power level rules like any
other user.</td>
</tr>
<tr><td>name</td>
<td>string</td>
<td>The name of the room, if any. May be null.</td>
</tr>
<tr><td>num_joined_members</td>
<td>number</td>
<td>The number of members joined to the room.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>The ID of the room.</td>
</tr>
<tr><td>topic</td>
<td>string</td>
<td>The topic of the room, if any. May be null.</td>
</tr>
<tr><td>world_readable</td>
<td>boolean</td>
<td>Whether the room may be viewed by guest users
without joining.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/publicRooms</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of the rooms on the server.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="literal string double">&quot;#murrays:cheese.bar&quot;</span><span class="punctuation">],</span>
      <span class="name tag">&quot;guest_can_join&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
      <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;CHEESE&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;num_joined_members&quot;</span><span class="punctuation">:</span> <span class="literal number integer">37</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!ol19s:bleecker.street&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Tasty tasty cheese&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;world_readable&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
    <span class="punctuation">}</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;p190q&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;p1902&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="id3"></a></p>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id128">4.5&nbsp;&nbsp;&nbsp;Profiles</a></h2>
<p><a class="anchor" id="put-matrix-client-api-v1-profile-userid-displayname"></a></p>
<div class="section" id="put-matrix-client-api-v1-profile-userid-displayname">
<h3><a class="toc-backref" href="#id129">4.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/profile/{userId}/displayname</span></tt></a></h3>
<p>This API sets the given user's display name. You must have permission to set
this user's display name, e.g. you need to have their <tt class="docutils literal">access_token</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose display name to set.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>displayname</td>
<td>string</td>
<td>The new display name for this user.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/api/v1/profile/%40alice%3Aexample.com/displayname</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The display name was set.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-profile-userid-displayname"></a></p>
<div class="section" id="get-matrix-client-api-v1-profile-userid-displayname">
<h3><a class="toc-backref" href="#id130">4.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/profile/{userId}/displayname</span></tt></a></h3>
<p>Get the user's display name. This API may be used to fetch the user's own
displayname or to query the name of other users; either locally or on remote
homeservers.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose display name to get.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>displayname</td>
<td>string</td>
<td>The user's display name if they have set one.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/profile/%40alice%3Aexample.com/displayname</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The display name for this user.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-api-v1-profile-userid-avatar-url"></a></p>
<div class="section" id="put-matrix-client-api-v1-profile-userid-avatar-url">
<h3><a class="toc-backref" href="#id131">4.5.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/profile/{userId}/avatar_url</span></tt></a></h3>
<p>This API sets the given user's avatar URL. You must have permission to set this
user's avatar URL, e.g. you need to have their <tt class="docutils literal">access_token</tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose avatar URL to set.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>avatar_url</td>
<td>string</td>
<td>The new avatar URL for this user.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/api/v1/profile/%40alice%3Aexample.com/avatar_url</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://matrix.org/wefh34uihSDRGhw34&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The avatar URL was set.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-profile-userid-avatar-url"></a></p>
<div class="section" id="get-matrix-client-api-v1-profile-userid-avatar-url">
<h3><a class="toc-backref" href="#id132">4.5.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/profile/{userId}/avatar_url</span></tt></a></h3>
<p>Get the user's avatar URL. This API may be used to fetch the user's own avatar
URL or to query the URL of other users; either locally or on remote homeservers.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose avatar URL to get.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The user's avatar URL if they have set one.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/profile/%40alice%3Aexample.com/avatar_url</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The avatar URL for this user.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://matrix.org/SDGdghriugerRg&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-profile-userid"></a></p>
<div class="section" id="get-matrix-client-api-v1-profile-userid">
<h3><a class="toc-backref" href="#id133">4.5.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/profile/{userId}</span></tt></a></h3>
<p>Get the combined profile information for this user. This API may be used to
fetch the user's own profile information or other users; either locally or on
remote homeservers. This API may return keys which are not limited to
<tt class="docutils literal">displayname</tt> or <tt class="docutils literal">avatar_url</tt>.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose avatar URL to get.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The user's avatar URL if they have set one.</td>
</tr>
<tr><td>displayname</td>
<td>string</td>
<td>The user's display name if they have set one.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/profile/%40alice%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The avatar URL for this user.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://matrix.org/SDGdghriugerRg&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="events-on-change-of-profile-information"></a></p>
<div class="section" id="events-on-change-of-profile-information">
<h3><a class="toc-backref" href="#id134">4.5.6&nbsp;&nbsp;&nbsp;Events on Change of Profile Information</a></h3>
<p>Because the profile display name and avatar information are likely to be used in
many places of a client's display, changes to these fields cause an automatic
propagation event to occur, informing likely-interested parties of the new
values. This change is conveyed using two separate mechanisms:</p>
<ul class="simple">
<li>a <tt class="docutils literal">m.room.member</tt> event is sent to every room the user is a member of,
to update the <tt class="docutils literal">displayname</tt> and <tt class="docutils literal">avatar_url</tt>.</li>
<li>a <tt class="docutils literal">m.presence</tt> presence status update is sent, again containing the new
values of the <tt class="docutils literal">displayname</tt> and <tt class="docutils literal">avatar_url</tt> keys, in addition to the
required <tt class="docutils literal">presence</tt> key containing the current presence state of the user.</li>
</ul>
<p>Both of these should be done automatically by the home server when a user
successfully changes their display name or avatar URL fields.</p>
<p>Additionally, when home servers emit room membership events for their own
users, they should include the display name and avatar URL fields in these
events so that clients already have these details to hand, and do not have to
perform extra round trips to query it.</p>
</div>
</div>
<p><a class="anchor" id="security"></a></p>
<div class="section" id="security">
<h2><a class="toc-backref" href="#id135">4.6&nbsp;&nbsp;&nbsp;Security</a></h2>
<p><a class="anchor" id="rate-limiting"></a></p>
<div class="section" id="rate-limiting">
<h3><a class="toc-backref" href="#id136">4.6.1&nbsp;&nbsp;&nbsp;Rate limiting</a></h3>
<p>Home servers SHOULD implement rate limiting to reduce the risk of being
overloaded. If a request is refused due to rate limiting, it should return a
standard error response of the form:</p>
<pre class="literal-block">
{
  &quot;errcode&quot;: &quot;M_LIMIT_EXCEEDED&quot;,
  &quot;error&quot;: &quot;string&quot;,
  &quot;retry_after_ms&quot;: integer (optional)
}
</pre>
<p>The <tt class="docutils literal">retry_after_ms</tt> key SHOULD be included to tell the client how long they
have to wait in milliseconds before they can try again.</p>
<!-- TODO-spec
- Surely we should recommend an algorithm for the rate limiting, rather than letting every
  homeserver come up with their own idea, causing totally unpredictable performance over
  federated rooms? -->
<!-- Links through the external API docs are below -->
<!-- ============================================= -->
</div>
</div>
<p><a class="anchor" id="event-structure"></a></p>
<div class="section" id="event-structure">
<h2><a class="toc-backref" href="#id137">4.7&nbsp;&nbsp;&nbsp;Event Structure</a></h2>
<p>All communication in Matrix is expressed in the form of data objects called
Events. These are the fundamental building blocks common to the client-server,
server-server and application-service APIs, and are described below.</p>
<p><a class="anchor" id="event-fields"></a></p>
<div class="section" id="event-fields">
<h3><a class="toc-backref" href="#id138">4.7.1&nbsp;&nbsp;&nbsp;Event Fields</a></h3>
<p>The basic set of fields all events must have.</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>object</td>
<td>The fields in this object will vary depending on
the type of event. When interacting with the REST
API, this is the HTTP body.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td>The type of event. This SHOULD be namespaced
similar to Java package naming conventions e.g.
'com.example.subdomain.event.type'</td>
</tr>
</tbody>
</table>
</div>
<p><a class="anchor" id="room-event-fields"></a></p>
<div class="section" id="room-event-fields">
<h3><a class="toc-backref" href="#id139">4.7.2&nbsp;&nbsp;&nbsp;Room Event Fields</a></h3>
<p>In addition to the Event fields, Room Events MUST have the following additional
field.</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>The globally unique event identifier.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>The ID of the room associated with this event.</td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td>Contains the fully-qualified ID of the user who
<em>sent</em> this event.</td>
</tr>
</tbody>
</table>
</div>
<p><a class="anchor" id="state-event-fields"></a></p>
<div class="section" id="state-event-fields">
<h3><a class="toc-backref" href="#id140">4.7.3&nbsp;&nbsp;&nbsp;State Event Fields</a></h3>
<p>In addition to the Room Event fields, State Events have the following additional
fields.</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="14%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>prev_content</td>
<td>object</td>
<td>Optional. The previous <tt class="docutils literal">content</tt> for this event.
If there is no previous content, this key will be
missing.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>A unique key which defines the overwriting
semantics for this piece of room state. This value
is often a zero-length string. The presence of
this key makes this event a State Event. The key
MUST NOT start with '_'.</td>
</tr>
</tbody>
</table>
</div>
<p><a class="anchor" id="differences-between-v1-and-v2-events"></a></p>
<div class="section" id="differences-between-v1-and-v2-events">
<h3><a class="toc-backref" href="#id141">4.7.4&nbsp;&nbsp;&nbsp;Differences between /v1 and /v2 events</a></h3>
<p>There are a few differences between how events are formatted for sending
between servers over federation and how they are formatted for sending between
a server and its clients.</p>
<p>Additionally there are a few differences between the format of events in the
responses to client APIs with a /v1 prefix and responses APIs with a /v2
prefix.</p>
<p>Events in responses for APIs with the /v2 prefix are generated from an event
formatted for federation by:</p>
<ul class="simple">
<li>Removing the following keys:
<tt class="docutils literal">auth_events</tt>, <tt class="docutils literal">prev_events</tt>, <tt class="docutils literal">hashes</tt>, <tt class="docutils literal">signatures</tt>, <tt class="docutils literal">depth</tt>,
<tt class="docutils literal">origin</tt>, <tt class="docutils literal">prev_state</tt>.</li>
<li>Adding an <tt class="docutils literal">age</tt> to the <tt class="docutils literal">unsigned</tt> object which gives the time in
milliseconds that has elapsed since the event was sent.</li>
<li>Adding <tt class="docutils literal">prev_content</tt> and <tt class="docutils literal">prev_sender</tt> to the <tt class="docutils literal">unsigned</tt> object if the
event is a <tt class="docutils literal">state event</tt>, which give the previous content and previous
sender of that state key</li>
<li>Adding a <tt class="docutils literal">redacted_because</tt> to the <tt class="docutils literal">unsigned</tt> object if the event was
redacted which gives the event that redacted it.</li>
<li>Adding a <tt class="docutils literal">transaction_id</tt> to the <tt class="docutils literal">unsigned</tt> object if the event was sent
by the client requesting it.</li>
</ul>
<p>Events in responses for APIs with the /v1 prefix are generated from an event
formatted for the /v2 prefix by:</p>
<ul class="simple">
<li>Moving the folling keys from the <tt class="docutils literal">unsigned</tt> object to the top level event
object: <tt class="docutils literal">age</tt>, <tt class="docutils literal">redacted_because</tt>, <tt class="docutils literal">replaces_state</tt>, <tt class="docutils literal">prev_content</tt>.</li>
<li>Removing the <tt class="docutils literal">unsigned</tt> object.</li>
<li>Rename the <tt class="docutils literal">sender</tt> key to <tt class="docutils literal">user_id</tt>.</li>
<li>If the event was an <tt class="docutils literal">m.room.member</tt> with <tt class="docutils literal">membership</tt> set to <tt class="docutils literal">invite</tt>
then adding a <tt class="docutils literal">invite_room_state</tt> key to the top level event object.</li>
</ul>
</div>
<p><a class="anchor" id="size-limits"></a></p>
<div class="section" id="size-limits">
<h3><a class="toc-backref" href="#id142">4.7.5&nbsp;&nbsp;&nbsp;Size limits</a></h3>
<p>The total size of any event MUST NOT exceed 65 KB. There are additional
restrictions on sizes per key:</p>
<ul class="simple">
<li><tt class="docutils literal">user_id</tt> MUST NOT exceed 255 bytes (including domain).</li>
<li><tt class="docutils literal">room_id</tt> MUST NOT exceed 255 bytes.</li>
<li><tt class="docutils literal">state_key</tt> MUST NOT exceed 255 bytes.</li>
<li><tt class="docutils literal">type</tt> MUST NOT exceed 255 bytes.</li>
<li><tt class="docutils literal">event_id</tt> MUST NOT exceed 255 bytes.</li>
</ul>
<p>Some event types have additional size restrictions which are specified in
the description of the event. Additional keys have no limit other than that
implied by the total 65 KB limit on events.</p>
</div>
<p><a class="anchor" id="room-events"></a></p>
<div class="section" id="room-events">
<h3><a class="toc-backref" href="#id143">4.7.6&nbsp;&nbsp;&nbsp;Room Events</a></h3>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">This section is a work in progress.</p>
</div>
<p>This specification outlines several standard event types, all of which are
prefixed with <tt class="docutils literal">m.</tt></p>
<p><a class="anchor" id="m-room-aliases"></a></p>
<div class="section" id="m-room-aliases">
<h4><a class="toc-backref" href="#id144">4.7.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.aliases</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: The homeserver domain which owns these room aliases.</dd>
</dl>
<p>This event is sent by a homeserver directly to inform of changes to the list of
aliases it knows about for that room. The <tt class="docutils literal">state_key</tt> for this event is set to
the homeserver which owns the room alias. The entire set of known aliases for
the room is the union of all the <tt class="docutils literal">m.room.aliases</tt> events, one for each
homeserver. Clients <strong>should</strong> check the validity of any room alias given in
this list before presenting it to the user as trusted fact. The lists given by
this event should be considered simply as advice on which aliases might exist,
for which the client can perform the lookup to confirm whether it receives the
correct room ID.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>aliases</td>
<td>[string]</td>
<td>A list of room aliases.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;#somewhere:localhost&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;#another:localhost&quot;</span>
        <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.aliases&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-canonical-alias"></a></p>
<div class="section" id="m-room-canonical-alias">
<h4><a class="toc-backref" href="#id145">4.7.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.canonical_alias</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This event is used to inform the room about which alias should be considered the
canonical one. This could be for display purposes or as suggestion to users
which alias to use to advertise the room.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>alias</td>
<td>string</td>
<td>The canonical alias.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#somewhere:localhost&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.canonical_alias&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-create"></a></p>
<div class="section" id="m-room-create">
<h4><a class="toc-backref" href="#id146">4.7.6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.create</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This is the first event in a room and cannot be changed. It acts as the root of
all other events.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>creator</td>
<td>string</td>
<td>The <tt class="docutils literal">user_id</tt> of the room creator. This is set
by the homeserver.</td>
</tr>
<tr><td>m.federate</td>
<td>boolean</td>
<td>Whether users on other servers can join this room.
Defaults to <tt class="docutils literal">true</tt> if key does not exist.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;creator&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.create&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-join-rules"></a></p>
<div class="section" id="m-room-join-rules">
<h4><a class="toc-backref" href="#id147">4.7.6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.join_rules</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>A room may be <tt class="docutils literal">public</tt> meaning anyone can join the room without any prior
action. Alternatively, it can be <tt class="docutils literal">invite</tt> meaning that a user who wishes to
join the room must first receive an invite to the room from someone already
inside of the room. Currently, <tt class="docutils literal">knock</tt> and <tt class="docutils literal">private</tt> are reserved keywords
which are not implemented.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>join_rule</td>
<td>enum</td>
<td>The type of rules used for users wishing to join
this room. One of: [&quot;public&quot;, &quot;knock&quot;, &quot;invite&quot;,
&quot;private&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;join_rule&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;public&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.join_rules&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-member"></a></p>
<div class="section" id="m-room-member">
<h4><a class="toc-backref" href="#id148">4.7.6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.member</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: The <tt class="docutils literal">user_id</tt> this membership event relates to.</dd>
</dl>
<p>Adjusts the membership state for a user in a room. It is preferable to use the
membership APIs (<tt class="docutils literal"><span class="pre">/rooms/&lt;room</span> <span class="pre">id&gt;/invite</span></tt> etc) when performing membership
actions rather than adjusting the state directly as there are a restricted set
of valid transformations. For example, user A cannot force user B to join a
room, and trying to force this state change directly will fail.</p>
<p>The <tt class="docutils literal">third_party_invite</tt> property will be set if this invite is an <tt class="docutils literal">invite</tt>
event and is the successor of an <tt class="docutils literal">m.room.third_party_invite</tt> event, and absent
otherwise.</p>
<p>This event may also include an <tt class="docutils literal">invite_room_state</tt> key <strong>outside the</strong>
<tt class="docutils literal">content</tt> <strong>key</strong>. If present, this contains an array of <tt class="docutils literal">StrippedState</tt>
Events. These events provide information on a few select state events such as
the room name.
<tt class="docutils literal">EventContent</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="17%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">EventContent Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The avatar URL for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>displayname</td>
<td>string or null</td>
<td>The display name for this user, if any. This is
added by the homeserver.</td>
</tr>
<tr><td>membership</td>
<td>enum</td>
<td>The membership state of the user. One of:
[&quot;invite&quot;, &quot;join&quot;, &quot;knock&quot;, &quot;leave&quot;, &quot;ban&quot;]</td>
</tr>
<tr><td>third_party_invite</td>
<td>{Invite}</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Invite</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Invite Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>signed</td>
<td>{signed}</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">signed</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="17%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">signed Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mxid</td>
<td>string</td>
<td>The invited matrix user ID. Must be equal to the
user_id property of the event.</td>
</tr>
<tr><td>signatures</td>
<td>{Signatures}</td>
<td>A single signature from the verifying server, in
the format specified by the Signing Events
section.</td>
</tr>
<tr><td>token</td>
<td>string</td>
<td>The token property of the containing
third_party_invite object.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">StrippedState</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="17%" />
<col width="62%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">StrippedState Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>{EventContent}</td>
<td>The <tt class="docutils literal">content</tt> for the event.</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>The <tt class="docutils literal">state_key</tt> for the event.</td>
</tr>
<tr><td>type</td>
<td>enum</td>
<td>The <tt class="docutils literal">type</tt> for the event. One of:
[&quot;m.room.join_rules&quot;, &quot;m.room.canonical_alias&quot;,
&quot;m.room.avatar&quot;, &quot;m.room.name&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/SEsfnsuifSDFSSEF#auto&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;membership&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;join&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;invite_room_state&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Forest of Magic&quot;</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.name&quot;</span>
        <span class="punctuation">},</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;join_rules&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.join_rules&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-power-levels"></a></p>
<div class="section" id="m-room-power-levels">
<h4><a class="toc-backref" href="#id149">4.7.6.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.power_levels</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This event specifies the minimum level a user must have in order to perform a
certain action. It also specifies the levels of each user in the room. If a
<tt class="docutils literal">user_id</tt> is in the <tt class="docutils literal">users</tt> list, then that <tt class="docutils literal">user_id</tt> has the associated
power level. Otherwise they have the default level <tt class="docutils literal">users_default</tt>. If
<tt class="docutils literal">users_default</tt> is not supplied, it is assumed to be 0. The level required to
send a certain event is governed by <tt class="docutils literal">events</tt>, <tt class="docutils literal">state_default</tt> and
<tt class="docutils literal">events_default</tt>. If an event type is specified in <tt class="docutils literal">events</tt>, then the user
must have at least the level specified in order to send that event. If the event
type is not supplied, it defaults to <tt class="docutils literal">events_default</tt> for Message Events and
<tt class="docutils literal">state_default</tt> for State Events.</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="20%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>ban</td>
<td>number</td>
<td>The level required to ban a user.</td>
</tr>
<tr><td>events</td>
<td>{string: number}</td>
<td>The level required to send specific event types.
This is a mapping from event type to power level
required.</td>
</tr>
<tr><td>events_default</td>
<td>number</td>
<td>The default level required to send message events.
Can be overridden by the <tt class="docutils literal">events</tt> key.</td>
</tr>
<tr><td>kick</td>
<td>number</td>
<td>The level required to kick a user.</td>
</tr>
<tr><td>redact</td>
<td>number</td>
<td>The level required to redact an event.</td>
</tr>
<tr><td>state_default</td>
<td>number</td>
<td>The default level required to send state events.
Can be overridden by the <tt class="docutils literal">events</tt> key.</td>
</tr>
<tr><td>users</td>
<td>{string: number}</td>
<td>The power levels for specific users. This is a
mapping from <tt class="docutils literal">user_id</tt> to power level for that
user.</td>
</tr>
<tr><td>users_default</td>
<td>number</td>
<td>The default power level for every user in the
room, unless their <tt class="docutils literal">user_id</tt> is mentioned in the
<tt class="docutils literal">users</tt> key.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ban&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;m.room.name&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span><span class="punctuation">,</span>
            <span class="name tag">&quot;m.room.power_levels&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;events_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
        <span class="name tag">&quot;kick&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;redact&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;state_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">50</span><span class="punctuation">,</span>
        <span class="name tag">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;&#64;example:localhost&quot;</span><span class="punctuation">:</span> <span class="literal number integer">100</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;users_default&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.power_levels&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-redaction"></a></p>
<div class="section" id="m-room-redaction">
<h4><a class="toc-backref" href="#id150">4.7.6.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.redaction</tt></a></h4>
<p><em>Message Event</em></p>
<p>Events can be redacted by either room or server admins. Redacting an event means
that all keys not required by the protocol are stripped off, allowing admins to
remove offensive or illegal content that may have been attached to any event.
This cannot be undone, allowing server owners to physically delete the offending
data.  There is also a concept of a moderator hiding a message event, which can
be undone, but cannot be applied to state events. The event that has been
redacted is specified in the <tt class="docutils literal">redacts</tt> event level key.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>reason</td>
<td>string</td>
<td>The reason for the redaction, if any.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Spamming&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;redacts&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!fukweghifu23:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.redaction&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="signing-events"></a></p>
<div class="section" id="signing-events">
<h2><a class="toc-backref" href="#id151">4.8&nbsp;&nbsp;&nbsp;Signing Events</a></h2>
<p><a class="anchor" id="canonical-json"></a></p>
<div class="section" id="canonical-json">
<h3><a class="toc-backref" href="#id152">4.8.1&nbsp;&nbsp;&nbsp;Canonical JSON</a></h3>
<p>Matrix events are represented using JSON objects. If we want to sign JSON
events we need to encode the JSON as a binary string. Unfortunately the same
JSON can be encoded in different ways by changing how much white space is used
or by changing the order of keys within objects. Therefore we have to define an
encoding which can be reproduced byte for byte by any JSON library.</p>
<p>We define the canonical JSON encoding for a value to be the shortest UTF-8 JSON
encoding with dictionary keys lexicographically sorted by unicode codepoint.
Numbers in the JSON must be integers in the range [-(2**53)+1, (2**53)-1].</p>
<p>We pick UTF-8 as the encoding as it should be available to all platforms and
JSON received from the network is likely to be already encoded using UTF-8.
We sort the keys to give a consistent ordering. We force integers to be in the
range where they can be accurately represented using IEEE double precision
floating point numbers since a number of JSON libraries represent all numbers
using this representation.</p>
<pre class="code python literal-block">
<span class="keyword namespace">import</span> <span class="name namespace">json</span>

<span class="keyword">def</span> <span class="name function">canonical_json</span><span class="punctuation">(</span><span class="name">value</span><span class="punctuation">):</span>
    <span class="keyword">return</span> <span class="name">json</span><span class="operator">.</span><span class="name">dumps</span><span class="punctuation">(</span>
        <span class="name">value</span><span class="punctuation">,</span>
        <span class="comment"># Encode code-points outside of ASCII as UTF-8 rather than \u escapes</span>
        <span class="name">ensure_ascii</span><span class="operator">=</span><span class="name builtin pseudo">False</span><span class="punctuation">,</span>
        <span class="comment"># Remove unnecessary white space.</span>
        <span class="name">separators</span><span class="operator">=</span><span class="punctuation">(</span><span class="literal string">','</span><span class="punctuation">,</span><span class="literal string">':'</span><span class="punctuation">),</span>
        <span class="comment"># Sort the keys of dictionaries.</span>
        <span class="name">sort_keys</span><span class="operator">=</span><span class="name builtin pseudo">True</span><span class="punctuation">,</span>
        <span class="comment"># Encode the resulting unicode as UTF-8 bytes.</span>
    <span class="punctuation">)</span><span class="operator">.</span><span class="name">encode</span><span class="punctuation">(</span><span class="literal string">&quot;UTF-8&quot;</span><span class="punctuation">)</span>
</pre>
<p><a class="anchor" id="grammar"></a></p>
<div class="section" id="grammar">
<h4><a class="toc-backref" href="#id153">4.8.1.1&nbsp;&nbsp;&nbsp;Grammar</a></h4>
<p>Adapted from the grammar in <a class="reference external" href="http://tools.ietf.org/html/rfc7159">http://tools.ietf.org/html/rfc7159</a> removing
insignificant whitespace, fractions, exponents and redundant character escapes</p>
<pre class="code literal-block">
value     = false / null / true / object / array / number / string
false     = %x66.61.6c.73.65
null      = %x6e.75.6c.6c
true      = %x74.72.75.65
object    = %x7B [ member *( %x2C member ) ] %7D
member    = string %x3A value
array     = %x5B [ value *( %x2C value ) ] %5B
number    = [ %x2D ] int
int       = %x30 / ( %x31-39 *digit )
digit     = %x30-39
string    = %x22 *char %x22
char      = unescaped / %x5C escaped
unescaped = %x20-21 / %x23-5B / %x5D-10FFFF
escaped   = %x22 ; &quot;    quotation mark  U+0022
          / %x5C ; \    reverse solidus U+005C
          / %x62 ; b    backspace       U+0008
          / %x66 ; f    form feed       U+000C
          / %x6E ; n    line feed       U+000A
          / %x72 ; r    carriage return U+000D
          / %x74 ; t    tab             U+0009
          / %x75.30.30.30 (%x30-37 / %x62 / %x65-66) ; u000X
          / %x75.30.30.31 (%x30-39 / %x61-66)        ; u001X
</pre>
</div>
</div>
<p><a class="anchor" id="signing-json"></a></p>
<div class="section" id="signing-json">
<h3><a class="toc-backref" href="#id154">4.8.2&nbsp;&nbsp;&nbsp;Signing JSON</a></h3>
<p>We can now sign a JSON object by encoding it as a sequence of bytes, computing
the signature for that sequence and then adding the signature to the original
JSON object.</p>
<p><a class="anchor" id="signing-details"></a></p>
<div class="section" id="signing-details">
<h4><a class="toc-backref" href="#id155">4.8.2.1&nbsp;&nbsp;&nbsp;Signing Details</a></h4>
<p>JSON is signed by encoding the JSON object without <tt class="docutils literal">signatures</tt> or keys grouped
as <tt class="docutils literal">unsigned</tt>, using the canonical encoding described above. The JSON bytes are then signed using the
signature algorithm and the signature encoded using base64 with the padding
stripped. The resulting base64 signature is added to an object under the
<em>signing key identifier</em> which is added to the <tt class="docutils literal">signatures</tt> object under the
name of the server signing it which is added back to the original JSON object
along with the <tt class="docutils literal">unsigned</tt> object.</p>
<p>The <em>signing key identifier</em> is the concatenation of the <em>signing algorithm</em>
and a <em>key version</em>. The <em>signing algorithm</em> identifies the algorithm used to
sign the JSON. The currently support value for <em>signing algorithm</em> is
<tt class="docutils literal">ed25519</tt> as implemented by NACL (<a class="reference external" href="http://nacl.cr.yp.to/">http://nacl.cr.yp.to/</a>). The <em>key version</em>
is used to distinguish between different signing keys used by the same entity.</p>
<p>The <tt class="docutils literal">unsigned</tt> object and the <tt class="docutils literal">signatures</tt> object are not covered by the
signature. Therefore intermediate servers can add unsigned data such as timestamps
and additional signatures.</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
   <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.org&quot;</span><span class="punctuation">,</span>
   <span class="name tag">&quot;signing_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
     <span class="name tag">&quot;ed25519:1&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;XSl0kuyvrXNj6A+7/tkrB9sxSbRi08Of5uRhxOqZtEQ&quot;</span>
   <span class="punctuation">},</span>
   <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;age_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">922834800000</span>
   <span class="punctuation">},</span>
   <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;example.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
         <span class="name tag">&quot;ed25519:1&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s76RUgajp8w172am0zQb/iPTHsRnb4SkrzGoeCOSFfcBY2V/1c8QfrmdXHpvnc2jK5BD1WiJIxiMW95fMjK7Bw&quot;</span>
      <span class="punctuation">}</span>
   <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">sign_json</span><span class="punctuation">(</span><span class="name">json_object</span><span class="punctuation">,</span> <span class="name">signing_key</span><span class="punctuation">,</span> <span class="name">signing_name</span><span class="punctuation">):</span>
    <span class="name">signatures</span> <span class="operator">=</span> <span class="name">json_object</span><span class="operator">.</span><span class="name">pop</span><span class="punctuation">(</span><span class="literal string">&quot;signatures&quot;</span><span class="punctuation">,</span> <span class="punctuation">{})</span>
    <span class="name">unsigned</span> <span class="operator">=</span> <span class="name">json_object</span><span class="operator">.</span><span class="name">pop</span><span class="punctuation">(</span><span class="literal string">&quot;unsigned&quot;</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">)</span>

    <span class="name">signed</span> <span class="operator">=</span> <span class="name">signing_key</span><span class="operator">.</span><span class="name">sign</span><span class="punctuation">(</span><span class="name">encode_canonical_json</span><span class="punctuation">(</span><span class="name">json_object</span><span class="punctuation">))</span>
    <span class="name">signature_base64</span> <span class="operator">=</span> <span class="name">encode_base64</span><span class="punctuation">(</span><span class="name">signed</span><span class="operator">.</span><span class="name">signature</span><span class="punctuation">)</span>

    <span class="name">key_id</span> <span class="operator">=</span> <span class="literal string">&quot;</span><span class="literal string interpol">%s</span><span class="literal string">:</span><span class="literal string interpol">%s</span><span class="literal string">&quot;</span> <span class="operator">%</span> <span class="punctuation">(</span><span class="name">signing_key</span><span class="operator">.</span><span class="name">alg</span><span class="punctuation">,</span> <span class="name">signing_key</span><span class="operator">.</span><span class="name">version</span><span class="punctuation">)</span>
    <span class="name">signatures</span><span class="operator">.</span><span class="name">setdefault</span><span class="punctuation">(</span><span class="name">signing_name</span><span class="punctuation">,</span> <span class="punctuation">{})[</span><span class="name">key_id</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">signature_base64</span>

    <span class="name">json_object</span><span class="punctuation">[</span><span class="literal string">&quot;signatures&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">signatures</span>
    <span class="keyword">if</span> <span class="name">unsigned</span> <span class="operator word">is</span> <span class="operator word">not</span> <span class="name builtin pseudo">None</span><span class="punctuation">:</span>
        <span class="name">json_object</span><span class="punctuation">[</span><span class="literal string">&quot;unsigned&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">unsigned</span>

    <span class="keyword">return</span> <span class="name">json_object</span>
</pre>
</div>
<p><a class="anchor" id="checking-for-a-signature"></a></p>
<div class="section" id="checking-for-a-signature">
<h4><a class="toc-backref" href="#id156">4.8.2.2&nbsp;&nbsp;&nbsp;Checking for a Signature</a></h4>
<p>To check if an entity has signed a JSON object a server does the following</p>
<ol class="arabic simple">
<li>Checks if the <tt class="docutils literal">signatures</tt> object contains an entry with the name of the
entity. If the entry is missing then the check fails.</li>
<li>Removes any <em>signing key identifiers</em> from the entry with algorithms it
doesn't understand. If there are no <em>signing key identifiers</em> left then the
check fails.</li>
<li>Looks up <em>verification keys</em> for the remaining <em>signing key identifiers</em>
either from a local cache or by consulting a trusted key server. If it
cannot find a <em>verification key</em> then the check fails.</li>
<li>Decodes the base64 encoded signature bytes. If base64 decoding fails then
the check fails.</li>
<li>Checks the signature bytes using the <em>verification key</em>. If this fails then
the check fails. Otherwise the check succeeds.</li>
</ol>
</div>
</div>
<p><a class="anchor" id="id4"></a></p>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id157">4.8.3&nbsp;&nbsp;&nbsp;Signing Events</a></h3>
<p>Signing events is a more complicated process since servers can choose to redact
non-essential parts of an event. Before signing the event it is encoded as
Canonical JSON and hashed using SHA-256. The resulting hash is then stored
in the event JSON in a <tt class="docutils literal">hash</tt> object under a <tt class="docutils literal">sha256</tt> key.</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">hash_event</span><span class="punctuation">(</span><span class="name">event_json_object</span><span class="punctuation">):</span>

    <span class="comment"># Keys under &quot;unsigned&quot; can be modified by other servers.</span>
    <span class="comment"># They are useful for conveying information like the age of an</span>
    <span class="comment"># event that will change in transit.</span>
    <span class="comment"># Since they can be modifed we need to exclude them from the hash.</span>
    <span class="name">unsigned</span> <span class="operator">=</span> <span class="name">event_json_object</span><span class="operator">.</span><span class="name">pop</span><span class="punctuation">(</span><span class="literal string">&quot;unsigned&quot;</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">)</span>

    <span class="comment"># Signatures will depend on the current value of the &quot;hashes&quot; key.</span>
    <span class="comment"># We cannot add new hashes without invalidating existing signatures.</span>
    <span class="name">signatures</span> <span class="operator">=</span> <span class="name">event_json_object</span><span class="operator">.</span><span class="name">pop</span><span class="punctuation">(</span><span class="literal string">&quot;signatures&quot;</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">)</span>

    <span class="comment"># The &quot;hashes&quot; key might contain multiple algorithms if we decide to</span>
    <span class="comment"># migrate away from SHA-2. We don't want to include an existing hash</span>
    <span class="comment"># output in our hash so we exclude the &quot;hashes&quot; dict from the hash.</span>
    <span class="name">hashes</span> <span class="operator">=</span> <span class="name">event_json_object</span><span class="operator">.</span><span class="name">pop</span><span class="punctuation">(</span><span class="literal string">&quot;hashes&quot;</span><span class="punctuation">,</span> <span class="punctuation">{})</span>

    <span class="comment"># Encode the JSON using a canonical encoding so that we get the same</span>
    <span class="comment"># bytes on every server for the same JSON object.</span>
    <span class="name">event_json_bytes</span> <span class="operator">=</span> <span class="name">encode_canonical_json</span><span class="punctuation">(</span><span class="name">event_json_bytes</span><span class="punctuation">)</span>

    <span class="comment"># Add the base64 encoded bytes of the hash to the &quot;hashes&quot; dict.</span>
    <span class="name">hashes</span><span class="punctuation">[</span><span class="literal string">&quot;sha256&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">encode_base64</span><span class="punctuation">(</span><span class="name">sha256</span><span class="punctuation">(</span><span class="name">event_json_bytes</span><span class="punctuation">)</span><span class="operator">.</span><span class="name">digest</span><span class="punctuation">())</span>

    <span class="comment"># Add the &quot;hashes&quot; dict back the event JSON under a &quot;hashes&quot; key.</span>
    <span class="name">event_json_object</span><span class="punctuation">[</span><span class="literal string">&quot;hashes&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">hashes</span>
    <span class="keyword">if</span> <span class="name">unsigned</span> <span class="operator word">is</span> <span class="operator word">not</span> <span class="name builtin pseudo">None</span><span class="punctuation">:</span>
        <span class="name">event_json_object</span><span class="punctuation">[</span><span class="literal string">&quot;unsigned&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">unsigned</span>
    <span class="keyword">return</span> <span class="name">event_json_object</span>
</pre>
<p>The event is then stripped of all non-essential keys both at the top level and
within the <tt class="docutils literal">content</tt> object. Any top-level keys not in the following list
MUST be removed:</p>
<pre class="code literal-block">
auth_events
depth
event_id
hashes
membership
origin
origin_server_ts
prev_events
prev_state
room_id
sender
signatures
state_key
type
</pre>
<p>A new <tt class="docutils literal">content</tt> object is constructed for the resulting event that contains
only the essential keys of the original <tt class="docutils literal">content</tt> object. If the original
event lacked a <tt class="docutils literal">content</tt> object at all, a new empty JSON object is created
for it.</p>
<p>The keys that are considered essential for the <tt class="docutils literal">content</tt> object depend on the
the <tt class="docutils literal">type</tt> of the event. These are:</p>
<pre class="code literal-block">
type is &quot;m.room.aliases&quot;:
  aliases

type is &quot;m.room.create&quot;:
  creator

type is &quot;m.room.history_visibility&quot;:
  history_visibility

type is &quot;m.room.join_rules&quot;:
  join_rule

type is &quot;m.room.member&quot;:
  membership

type is &quot;m.room.power_levels&quot;:
  ban
  events
  events_default
  kick
  redact
  state_default
  users
  users_default
</pre>
<p>The resulting stripped object with the new <tt class="docutils literal">content</tt> object and the original
<tt class="docutils literal">hashes</tt> key is then signed using the JSON signing algorithm outlined below:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">sign_event</span><span class="punctuation">(</span><span class="name">event_json_object</span><span class="punctuation">,</span> <span class="name">name</span><span class="punctuation">,</span> <span class="name">key</span><span class="punctuation">):</span>

    <span class="comment"># Make sure the event has a &quot;hashes&quot; key.</span>
    <span class="keyword">if</span> <span class="literal string">&quot;hashes&quot;</span> <span class="operator word">not</span> <span class="operator word">in</span> <span class="name">event_json_object</span><span class="punctuation">:</span>
        <span class="name">event_json_object</span> <span class="operator">=</span> <span class="name">hash_event</span><span class="punctuation">(</span><span class="name">event_json_object</span><span class="punctuation">)</span>

    <span class="comment"># Strip all the keys that would be removed if the event was redacted.</span>
    <span class="comment"># The hashes are not stripped and cover all the keys in the event.</span>
    <span class="comment"># This means that we can tell if any of the non-essential keys are</span>
    <span class="comment"># modified or removed.</span>
    <span class="name">stripped_json_object</span> <span class="operator">=</span> <span class="name">strip_non_essential_keys</span><span class="punctuation">(</span><span class="name">event_json_object</span><span class="punctuation">)</span>

    <span class="comment"># Sign the stripped JSON object. The signature only covers the</span>
    <span class="comment"># essential keys and the hashes. This means that we can check the</span>
    <span class="comment"># signature even if the event is redacted.</span>
    <span class="name">signed_json_object</span> <span class="operator">=</span> <span class="name">sign_json</span><span class="punctuation">(</span><span class="name">stripped_json_object</span><span class="punctuation">)</span>

    <span class="comment"># Copy the signatures from the stripped event to the original event.</span>
    <span class="name">event_json_object</span><span class="punctuation">[</span><span class="literal string">&quot;signatures&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">signed_json_oject</span><span class="punctuation">[</span><span class="literal string">&quot;signatures&quot;</span><span class="punctuation">]</span>
    <span class="keyword">return</span> <span class="name">event_json_object</span>
</pre>
<p>Servers can then transmit the entire event or the event with the non-essential
keys removed. If the entire event is present, receiving servers can then check
the event by computing the SHA-256 of the event, excluding the <tt class="docutils literal">hash</tt> object.
If the keys have been redacted, then the <tt class="docutils literal">hash</tt> object is included when
calculating the SHA-256 instead.</p>
<p>New hash functions can be introduced by adding additional keys to the <tt class="docutils literal">hash</tt>
object. Since the <tt class="docutils literal">hash</tt> object cannot be redacted a server shouldn't allow
too many hashes to be listed, otherwise a server might embed illict data within
the <tt class="docutils literal">hash</tt> object. For similar reasons a server shouldn't allow hash values
that are too long.</p>
<!-- TODO
[[TODO(markjh): We might want to specify a maximum number of keys for the
``hash`` and we might want to specify the maximum output size of a hash]]
[[TODO(markjh) We might want to allow the server to omit the output of well
known hash functions like SHA-256 when none of the keys have been redacted]] -->
</div>
</div>
</div>
<p><a class="anchor" id="modules"></a></p>
<div class="section" id="modules">
<h1><a class="toc-backref" href="#id158">5&nbsp;&nbsp;&nbsp;Modules</a></h1>
<p><a class="anchor" id="feature-profiles"></a></p>
<div class="section" id="feature-profiles">
<h2><a class="toc-backref" href="#id159">5.1&nbsp;&nbsp;&nbsp;Feature Profiles</a></h2>
<p id="sect-feature-profiles">Matrix supports many different kinds of clients: from embedded IoT devices to
desktop clients. Not all clients can provide the same feature sets as other
clients e.g. due to lack of physical hardware such as not having a screen.
Clients can fall into one of several profiles and each profile contains a set
of features that the client MUST support. This section details a set of
&quot;feature profiles&quot;. Clients are expected to implement a profile in its entirety
in order for it to be classified as that profile.</p>
<p><a class="anchor" id="summary"></a></p>
<div class="section" id="summary">
<h3><a class="toc-backref" href="#id160">5.1.1&nbsp;&nbsp;&nbsp;Summary</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="43%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Module / Profile</th>
<th class="head">Web</th>
<th class="head">Mobile</th>
<th class="head">Desktop</th>
<th class="head">CLI</th>
<th class="head">Embedded</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><a class="reference internal" href="#module-im">Instant Messaging</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-presence">Presence</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-push">Push Notifications</a></td>
<td>Optional</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-receipts">Receipts</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-typing">Typing Notifications</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-voip">VoIP</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-content">Content Repository</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-history-visibility">Managing History Visibility</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-e2e">End-to-End Encryption</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr><td><a class="reference internal" href="#module-search">Server Side Search</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
</tbody>
</table>
<p><em>Please see each module for more details on what clients need to implement.</em></p>
</div>
<p><a class="anchor" id="clients"></a></p>
<div class="section" id="clients">
<h3><a class="toc-backref" href="#id161">5.1.2&nbsp;&nbsp;&nbsp;Clients</a></h3>
<p><a class="anchor" id="stand-alone-web-web"></a></p>
<div class="section" id="stand-alone-web-web">
<h4><a class="toc-backref" href="#id162">5.1.2.1&nbsp;&nbsp;&nbsp;Stand-alone web (<tt class="docutils literal">Web</tt>)</a></h4>
<p>This is a web page which heavily uses Matrix for communication. Single-page web
apps would be classified as a stand-alone web client, as would multi-page web
apps which use Matrix on nearly every page.</p>
</div>
<p><a class="anchor" id="mobile-mobile"></a></p>
<div class="section" id="mobile-mobile">
<h4><a class="toc-backref" href="#id163">5.1.2.2&nbsp;&nbsp;&nbsp;Mobile (<tt class="docutils literal">Mobile</tt>)</a></h4>
<p>This is a Matrix client specifically designed for consumption on mobile devices.
This is typically a mobile app but need not be so provided the feature set can
be reached (e.g. if a mobile site could display push notifications it could be
classified as a mobile client).</p>
</div>
<p><a class="anchor" id="desktop-desktop"></a></p>
<div class="section" id="desktop-desktop">
<h4><a class="toc-backref" href="#id164">5.1.2.3&nbsp;&nbsp;&nbsp;Desktop (<tt class="docutils literal">Desktop</tt>)</a></h4>
<p>This is a native GUI application which can run in its own environment outside a
browser.</p>
</div>
<p><a class="anchor" id="command-line-interface-cli"></a></p>
<div class="section" id="command-line-interface-cli">
<h4><a class="toc-backref" href="#id165">5.1.2.4&nbsp;&nbsp;&nbsp;Command Line Interface (<tt class="docutils literal">CLI</tt>)</a></h4>
<p>This is a client which is used via a text-based terminal.</p>
</div>
<p><a class="anchor" id="embedded-embedded"></a></p>
<div class="section" id="embedded-embedded">
<h4><a class="toc-backref" href="#id166">5.1.2.5&nbsp;&nbsp;&nbsp;Embedded (<tt class="docutils literal">Embedded</tt>)</a></h4>
<p>This is a client which is embedded into another application or an embedded
device.</p>
<p><a class="anchor" id="application"></a></p>
<div class="section" id="application">
<h5><a class="toc-backref" href="#id167">5.1.2.5.1&nbsp;&nbsp;&nbsp;Application</a></h5>
<p>This is a Matrix client which is embedded in another website, e.g. using
iframes. These embedded clients are typically for a single purpose
related to the website in question, and are not intended to be fully-fledged
communication apps.</p>
</div>
<p><a class="anchor" id="device"></a></p>
<div class="section" id="device">
<h5><a class="toc-backref" href="#id168">5.1.2.5.2&nbsp;&nbsp;&nbsp;Device</a></h5>
<p>This is a client which is typically running on an embedded device such as a
kettle, fridge or car. These clients tend to perform a few operations and run
in a resource constrained environment. Like embedded applications, they are
not intended to be fully-fledged communication systems.</p>
</div>
</div>
</div>
</div>
<p><a class="anchor" id="id5"></a></p>
<div class="section" id="id5">
<h2><a class="toc-backref" href="#id169">5.2&nbsp;&nbsp;&nbsp;Instant Messaging</a></h2>
<p id="module-im">This module adds support for sending human-readable messages to a room. It also
adds support for associating human-readable information with the room itself
such as a room name and topic.</p>
<p><a class="anchor" id="id6"></a></p>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id170">5.2.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-room-message"></a></p>
<div class="section" id="m-room-message">
<h4><a class="toc-backref" href="#id171">5.2.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.message</tt></a></h4>
<p><em>Message Event</em></p>
<p>This event is used when sending messages in a room. Messages are not limited to
be text. The <tt class="docutils literal">msgtype</tt> key outlines the type of message, e.g. text, audio,
image, video, etc. The <tt class="docutils literal">body</tt> key is text and MUST be used with every kind of
<tt class="docutils literal">msgtype</tt> as a fallback mechanism for when a client cannot render a message.
This allows clients to display <em>something</em> even if it is just plain text. For
more information on <tt class="docutils literal">msgtypes</tt>, see <a class="reference internal" href="#m-room-message-msgtypes">m.room.message msgtypes</a>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td>The textual representation of this message.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td>The type of message, e.g. <tt class="docutils literal">m.image</tt>, <tt class="docutils literal">m.text</tt></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-message-feedback"></a></p>
<div class="section" id="m-room-message-feedback">
<h4><a class="toc-backref" href="#id172">5.2.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.message.feedback</tt></a></h4>
<p><em>Message Event</em></p>
<p><strong>NB: Usage of this event is discouraged in favour of the</strong> <a class="reference internal" href="#module-receipts">receipts module</a>.
<strong>Most clients will not recognise this event.</strong> Feedback events are events sent
to acknowledge a message in some way. There are two supported acknowledgements:
<tt class="docutils literal">delivered</tt> (sent when the event has been received) and <tt class="docutils literal">read</tt> (sent when
the event has been observed by the end-user). The <tt class="docutils literal">target_event_id</tt> should
reference the <tt class="docutils literal">m.room.message</tt> event being acknowledged.</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="13%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>target_event_id</td>
<td>string</td>
<td>The event that this feedback is related to.</td>
</tr>
<tr><td>type</td>
<td>enum</td>
<td>The type of feedback. One of: [&quot;delivered&quot;,
&quot;read&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;target_event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WEIGFHFW:localhost&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;delivered&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message.feedback&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
<dl class="docutils">
<dt>Usage of this event is discouraged for several reasons:</dt>
<dd><ul class="first last simple">
<li>The number of feedback events will grow very quickly with the number of users
in the room. This event provides no way to &quot;batch&quot; feedback, unlike the
<a class="reference internal" href="#module-receipts">receipts module</a>.</li>
<li>Pairing feedback to messages gets complicated when paginating as feedback
arrives before the message it is acknowledging.</li>
<li>There are no guarantees that the client has seen the event ID being
acknowledged.</li>
</ul>
</dd>
</dl>
</div>
<p><a class="anchor" id="m-room-name"></a></p>
<div class="section" id="m-room-name">
<h4><a class="toc-backref" href="#id173">5.2.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.name</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>A room has an opaque room ID which is not human-friendly to read. A room alias
is human-friendly, but not all rooms have room aliases. The room name is a
human-friendly string designed to be displayed to the end-user. The room name is
not unique, as multiple rooms can have the same room name set. The room name can
also be set when creating a room using <tt class="docutils literal">/createRoom</tt> with the <tt class="docutils literal">name</tt> key.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>name</td>
<td>string</td>
<td>The name of the room. This MUST NOT exceed 255
bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;The room name&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.name&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-topic"></a></p>
<div class="section" id="m-room-topic">
<h4><a class="toc-backref" href="#id174">5.2.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.topic</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>A topic is a short message detailing what is currently being discussed in the
room.  It can also be used as a way to display extra information about the room,
which may not be suitable for the room name. The room topic can also be set when
creating a room using <tt class="docutils literal">/createRoom</tt> with the <tt class="docutils literal">topic</tt> key.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>topic</td>
<td>string</td>
<td>The topic text.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;A room topic&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.topic&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-avatar"></a></p>
<div class="section" id="m-room-avatar">
<h4><a class="toc-backref" href="#id175">5.2.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.avatar</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>A picture that is associated with the room. This can be displayed alongside the
room information.</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>info</td>
<td>{ImageInfo}</td>
<td>Metadata about the image referred to in <tt class="docutils literal">url</tt>.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>{ImageInfo}</td>
<td>Metadata about the image referred to in
<tt class="docutils literal">thumbnail_url</tt>.</td>
</tr>
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL to the thumbnail of the image.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td>The URL to the image.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">ImageInfo</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="14%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">ImageInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The height of the image in pixels.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The width of the image in pixels.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">398</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">31037</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">394</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/JWEIFJgwEIhweiWJE&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.avatar&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-room-message-msgtypes"></a></p>
<div class="section" id="m-room-message-msgtypes">
<h4><a class="toc-backref" href="#id176">5.2.1.6&nbsp;&nbsp;&nbsp;m.room.message msgtypes</a></h4>
<p>Each <a class="reference internal" href="#m-room-message">m.room.message</a> MUST have a <tt class="docutils literal">msgtype</tt> key which identifies the type
of message being sent. Each type has their own required and optional keys, as
outlined below. If a client cannot display the given <tt class="docutils literal">msgtype</tt> then it SHOULD
display the fallback plain text <tt class="docutils literal">body</tt> key instead.</p>
<p><a class="anchor" id="m-text"></a></p>
<div class="section" id="m-text">
<h5><a class="toc-backref" href="#id177">5.2.1.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.text</tt></a></h5>
<p>This message is the most basic message and is used to represent text.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td>The body of the message.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td>Must be 'm.text'.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example text message&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-emote"></a></p>
<div class="section" id="m-emote">
<h5><a class="toc-backref" href="#id178">5.2.1.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.emote</tt></a></h5>
<p>This message is similar to <tt class="docutils literal">m.text</tt> except that the sender is 'performing' the
action contained in the <tt class="docutils literal">body</tt> key, similar to <tt class="docutils literal">/me</tt> in IRC. This message
should be prefixed by the name of the sender. This message could also be
represented in a different colour to distinguish it from regular <tt class="docutils literal">m.text</tt>
messages.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td>The emote action to perform.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td>Must be 'm.emote'.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;thinks this is an example emote&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.emote&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-notice"></a></p>
<div class="section" id="m-notice">
<h5><a class="toc-backref" href="#id179">5.2.1.6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.notice</tt></a></h5>
<p>A m.notice message should be considered similar to a plain m.text message except
that clients should visually distinguish it in some way. It is intended to be
used by automated clients, such as bots, bridges, and other entities, rather
than humans. Additionally, such automated agents which watch a room for messages
and respond to them ought to ignore m.notice messages. This helps to prevent
infinite-loop situations where two automated clients continuously exchange
messages, as each responds to the other.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td>The notice text to send.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td>Must be 'm.notice'.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;This is an example notice&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.notice&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-image"></a></p>
<div class="section" id="m-image">
<h5><a class="toc-backref" href="#id180">5.2.1.6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.image</tt></a></h5>
<p>This message represents a single image and an optional thumbnail.</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td>A textual representation of the image. This could
be the alt text of the image, the filename of the
image, or some kind of content description for
accessibility e.g. 'image attachment'.</td>
</tr>
<tr><td>info</td>
<td>{ImageInfo}</td>
<td>Metadata about the image referred to in <tt class="docutils literal">url</tt>.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td>Must be 'm.image'.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>{ImageInfo}</td>
<td>Metadata about the image referred to in
<tt class="docutils literal">thumbnail_url</tt>.</td>
</tr>
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL to the thumbnail of the image.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td>The URL to the image.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">ImageInfo</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="14%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">ImageInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>h</td>
<td>integer</td>
<td>The height of the image in pixels.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the image, e.g. <tt class="docutils literal">image/jpeg</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>Size of the image in bytes.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The width of the image in pixels.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;filename.jpg&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">398</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">31037</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">394</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.image&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/JWEIFJgwEIhweiWJE&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-file"></a></p>
<div class="section" id="m-file">
<h5><a class="toc-backref" href="#id181">5.2.1.6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.file</tt></a></h5>
<p>This message represents a generic file.</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td>A human-readable description of the file. This is
recommended to be the filename of the original
upload.</td>
</tr>
<tr><td>filename</td>
<td>string</td>
<td>The original filename of the uploaded file.</td>
</tr>
<tr><td>info</td>
<td>{FileInfo}</td>
<td>Information about the file referred to in <tt class="docutils literal">url</tt>.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td>Must be 'm.file'.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>{ImageInfo}</td>
<td>Metadata about the image referred to in
<tt class="docutils literal">thumbnail_url</tt>.</td>
</tr>
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL to the thumbnail of the file.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td>The URL to the file.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">FileInfo</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="14%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">FileInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the file e.g.
<tt class="docutils literal">application/msword</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>The size of the file in bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">146</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.doc&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;something-important.doc&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;application/msword&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.file&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-location"></a></p>
<div class="section" id="m-location">
<h5><a class="toc-backref" href="#id182">5.2.1.6.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.location</tt></a></h5>
<p>This message represents a real-world location.</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td>A description of the location e.g. 'Big Ben,
London, UK', or some kind of content description
for accessibility e.g. 'location attachment'.</td>
</tr>
<tr><td>geo_uri</td>
<td>string</td>
<td>A geo URI representing this location.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td>Must be 'm.location'.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>{ImageInfo}</td>
<td>&nbsp;</td>
</tr>
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL to a thumbnail of the location being
represented.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">146</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Big Ben, London, UK&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;geo_uri&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;geo:51.5008,0.1247&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.location&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;thumbnail_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;thumbnail_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-video"></a></p>
<div class="section" id="m-video">
<h5><a class="toc-backref" href="#id183">5.2.1.6.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.video</tt></a></h5>
<p>This message represents a single video clip.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="15%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td>A description of the video e.g. 'Gangnam style',
or some kind of content description for
accessibility e.g. 'video attachment'.</td>
</tr>
<tr><td>info</td>
<td>{VideoInfo}</td>
<td>Metadata about the video clip referred to in
<tt class="docutils literal">url</tt>.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td>Must be 'm.video'.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td>The URL to the video clip.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">VideoInfo</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">VideoInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>duration</td>
<td>integer</td>
<td>The duration of the video in milliseconds.</td>
</tr>
<tr><td>h</td>
<td>integer</td>
<td>The height of the video in pixels.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the video e.g. <tt class="docutils literal">video/mp4</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>The size of the video in bytes.</td>
</tr>
<tr><td>thumbnail_info</td>
<td>{ImageInfo}</td>
<td>&nbsp;</td>
</tr>
<tr><td>thumbnail_url</td>
<td>string</td>
<td>The URL to a thumbnail of the video clip.</td>
</tr>
<tr><td>w</td>
<td>integer</td>
<td>The width of the video in pixels.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">146</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Gangnam Style&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2140786</span><span class="punctuation">,</span>
            <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">320</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;video/mp4&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1563685</span><span class="punctuation">,</span>
            <span class="name tag">&quot;thumbnail_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;h&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span><span class="punctuation">,</span>
                <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;image/jpeg&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">46144</span><span class="punctuation">,</span>
                <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">300</span>
            <span class="punctuation">},</span>
            <span class="name tag">&quot;thumbnail_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/FHyPlCeYUSFFxlgbQYZmoEoe&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;w&quot;</span><span class="punctuation">:</span> <span class="literal number integer">480</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.video&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/a526eYUSFFxlgbQYZmo442&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-audio"></a></p>
<div class="section" id="m-audio">
<h5><a class="toc-backref" href="#id184">5.2.1.6.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.audio</tt></a></h5>
<p>This message represents a single audio clip.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="15%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>body</td>
<td>string</td>
<td>A description of the audio e.g. 'Bee Gees -
Stayin' Alive', or some kind of content
description for accessibility e.g. 'audio
attachment'.</td>
</tr>
<tr><td>info</td>
<td>{AudioInfo}</td>
<td>Metadata for the audio clip referred to in
<tt class="docutils literal">url</tt>.</td>
</tr>
<tr><td>msgtype</td>
<td>string</td>
<td>Must be 'm.audio'.</td>
</tr>
<tr><td>url</td>
<td>string</td>
<td>The URL to the audio clip.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">AudioInfo</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="14%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">AudioInfo Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>duration</td>
<td>integer</td>
<td>The duration of the audio in milliseconds.</td>
</tr>
<tr><td>mimetype</td>
<td>string</td>
<td>The mimetype of the audio e.g. <tt class="docutils literal">audio/aac</tt>.</td>
</tr>
<tr><td>size</td>
<td>integer</td>
<td>The size of the audio clip in bytes.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">146</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Bee Gees - Stayin' Alive&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2140786</span><span class="punctuation">,</span>
            <span class="name tag">&quot;mimetype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;audio/mpeg&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;size&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1563685</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.audio&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost/ffed755USFFxlgbQYZGtryd&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$143273582443PhrSn:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432735824653</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!jEsUZKDJdhlrceRyVU:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="client-behaviour"></a></p>
<div class="section" id="client-behaviour">
<h3><a class="toc-backref" href="#id185">5.2.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients SHOULD verify the structure of incoming events to ensure that the
expected keys exist and that they are of the right type. Clients can discard
malformed events or display a placeholder message to the user. Redacted
<tt class="docutils literal">m.room.message</tt> events MUST be removed from the client. This can either be
replaced with placeholder text (e.g. &quot;[REDACTED]&quot;) or the redacted message can
be removed entirely from the messages view.</p>
<p>Events which have attachments (e.g. <tt class="docutils literal">m.image</tt>, <tt class="docutils literal">m.file</tt>) SHOULD be
uploaded using the <a class="reference internal" href="#module-content">content repository module</a> where available. The
resulting <tt class="docutils literal"><span class="pre">mxc://</span></tt> URI can then be used in the <tt class="docutils literal">url</tt> key.</p>
<p><a class="anchor" id="recommendations-when-sending-messages"></a></p>
<div class="section" id="recommendations-when-sending-messages">
<h4><a class="toc-backref" href="#id186">5.2.2.1&nbsp;&nbsp;&nbsp;Recommendations when sending messages</a></h4>
<p>Clients can send messages using <tt class="docutils literal">POST</tt> or <tt class="docutils literal">PUT</tt> requests. Clients SHOULD use
<tt class="docutils literal">PUT</tt> requests with <a class="reference internal" href="#sect-txn-ids">transaction IDs</a> to make requests idempotent. This
ensures that messages are sent exactly once even under poor network conditions.
Clients SHOULD retry requests using an exponential-backoff algorithm for a
certain amount of time T. It is recommended that T is no longer than 5 minutes.
After this time, the client should stop retrying and mark the message as &quot;unsent&quot;.
Users should be able to manually resend unsent messages.</p>
<p>Users may type several messages at once and send them all in quick succession.
Clients SHOULD preserve the order in which they were sent by the user. This
means that clients should wait for the response to the previous request before
sending the next request. This can lead to head-of-line blocking. In order to
reduce the impact of head-of-line blocking, clients should use a queue per room
rather than a global queue, as ordering is only relevant within a single room
rather than between rooms.</p>
</div>
<p><a class="anchor" id="local-echo"></a></p>
<div class="section" id="local-echo">
<h4><a class="toc-backref" href="#id187">5.2.2.2&nbsp;&nbsp;&nbsp;Local echo</a></h4>
<p>Messages SHOULD appear immediately in the message view when a user presses the
&quot;send&quot; button. This should occur even if the message is still sending. This is
referred to as &quot;local echo&quot;. Clients SHOULD implement &quot;local echo&quot; of messages.
Clients MAY display messages in a different format to indicate that the server
has not processed the message. This format should be removed when the server
responds.</p>
<p>Clients need to be able to match the message they are sending with the same
message which they receive from the event stream. The echo of the same message
from the event stream is referred to as &quot;remote echo&quot;. Both echoes need to be
identified as the same message in order to prevent duplicate messages being
displayed. Ideally this pairing would occur transparently to the user: the UI
would not flicker as it transitions from local to remote. Flickering cannot be
fully avoided in the current client-server API. Two scenarios need to be
considered:</p>
<ul class="simple">
<li>The client sends a message and the remote echo arrives on the event stream
<em>after</em> the request to send the message completes.</li>
<li>The client sends a message and the remote echo arrives on the event stream
<em>before</em> the request to send the message completes.</li>
</ul>
<p>In the first scenario, the client will receive an event ID when the request to
send the message completes. This ID can be used to identify the duplicate event
when it arrives on the event stream. However, in the second scenario, the event
arrives before the client has obtained an event ID. This makes it impossible to
identify it as a duplicate event. This results in the client displaying the
message twice for a fraction of a second before the the original request to send
the message completes. Once it completes, the client can take remedial actions
to remove the duplicate event by looking for duplicate event IDs. A future version
of the client-server API will resolve this by attaching the transaction ID of the
sending request to the event itself.</p>
</div>
<p><a class="anchor" id="calculating-the-display-name-for-a-user"></a></p>
<div class="section" id="calculating-the-display-name-for-a-user">
<h4><a class="toc-backref" href="#id188">5.2.2.3&nbsp;&nbsp;&nbsp;Calculating the display name for a user</a></h4>
<p>Clients may wish to show the human-readable display name of a room member as
part of a membership list, or when they send a message. However, different
members may have conflicting display names. Display names MUST be disambiguated
before showing them to the user, in order to prevent spoofing of other users.</p>
<p>To ensure this is done consistently across clients, clients SHOULD use the
following algorithm to calculate a disambiguated display name for a given user:</p>
<ol class="arabic simple">
<li>Inspect the <tt class="docutils literal">m.room.member</tt> state event for the relevant user id.</li>
<li>If the <tt class="docutils literal">m.room.member</tt> state event has no <tt class="docutils literal">displayname</tt> field, or if
that field has a <tt class="docutils literal">null</tt> value, use the raw user id as the display
name. Otherwise:</li>
<li>If the <tt class="docutils literal">m.room.member</tt> event has a <tt class="docutils literal">displayname</tt> which is unique among
members of the room with <tt class="docutils literal">membership: join</tt> or <tt class="docutils literal">membership: invite</tt>, use
the given <tt class="docutils literal">displayname</tt> as the user-visible display name. Otherwise:</li>
<li>The <tt class="docutils literal">m.room.member</tt> event has a non-unique <tt class="docutils literal">displayname</tt>. This should be
disambiguated using the user id, for example &quot;display name
(&#64;id:homeserver.org)&quot;.<!-- TODO-spec
what does it mean for a ``displayname`` to be 'unique'? Are we
case-sensitive?  Do we care about homograph attacks? See
https://matrix.org/jira/browse/SPEC-221. -->
</li>
</ol>
<p>Developers should take note of the following when implementing the above
algorithm:</p>
<ul class="simple">
<li>The user-visible display name of one member can be affected by changes in the
state of another member. For example, if <tt class="docutils literal">&#64;user1:matrix.org</tt> is present in
a room, with <tt class="docutils literal">displayname: Alice</tt>, then when <tt class="docutils literal">&#64;user2:example.com</tt> joins
the room, also with <tt class="docutils literal">displayname: Alice</tt>, <em>both</em> users must be given
disambiguated display names. Similarly, when one of the users then changes
their display name, there is no longer a clash, and <em>both</em> users can be given
their chosen display name. Clients should be alert to this possibility and
ensure that all affected users are correctly renamed.</li>
<li>The display name of a room may also be affected by changes in the membership
list. This is due to the room name sometimes being based on user display
names (see <a class="reference internal" href="#calculating-the-display-name-for-a-room">Calculating the display name for a room</a>).</li>
<li>If the entire membership list is searched for clashing display names, this
leads to an O(N^2) implementation for building the list of room members. This
will be very inefficient for rooms with large numbers of members. It is
recommended that client implementations maintain a hash table mapping from
<tt class="docutils literal">displayname</tt> to a list of room members using that name. Such a table can
then be used for efficient calculation of whether disambiguation is needed.</li>
</ul>
</div>
<p><a class="anchor" id="displaying-membership-information-with-messages"></a></p>
<div class="section" id="displaying-membership-information-with-messages">
<h4><a class="toc-backref" href="#id189">5.2.2.4&nbsp;&nbsp;&nbsp;Displaying membership information with messages</a></h4>
<p>Clients may wish to show the display name and avatar URL of the room member who
sent a message. This can be achieved by inspecting the <tt class="docutils literal">m.room.member</tt> state
event for that user ID (see <a class="reference internal" href="#calculating-the-display-name-for-a-user">Calculating the display name for a user</a>).</p>
<p>When a user paginates the message history, clients may wish to show the
<strong>historical</strong> display name and avatar URL for a room member. This is possible
because older <tt class="docutils literal">m.room.member</tt> events are returned when paginating. This can
be implemented efficiently by keeping two sets of room state: old and current.
As new events arrive and/or the user paginates back in time, these two sets of
state diverge from each other. New events update the current state and paginated
events update the old state. When paginated events are processed sequentially,
the old state represents the state of the room <em>at the time the event was sent</em>.
This can then be used to set the historical display name and avatar URL.</p>
</div>
<p><a class="anchor" id="calculating-the-display-name-for-a-room"></a></p>
<div class="section" id="calculating-the-display-name-for-a-room">
<h4><a class="toc-backref" href="#id190">5.2.2.5&nbsp;&nbsp;&nbsp;Calculating the display name for a room</a></h4>
<p>Clients may wish to show a human-readable name for a room. There are a number
of possibilities for choosing a useful name. To ensure that rooms are named
consistently across clients, clients SHOULD use the following algorithm to
choose a name:</p>
<ol class="arabic">
<li><p class="first">If the room has an <a class="reference internal" href="#m-room-name">m.room.name</a> state event, use the name given by that
event.</p>
</li>
<li><p class="first">If the room has an <a class="reference internal" href="#m-room-canonical-alias">m.room.canonical_alias</a> state event, use the alias
given by that event.</p>
</li>
<li><p class="first">If neither of the above events are present, a name should be composed based
on the members of the room. Clients should consider <a class="reference internal" href="#m-room-member">m.room.member</a> events
for users other than the logged-in user, with <tt class="docutils literal">membership: join</tt> or
<tt class="docutils literal">membership: invite</tt>.</p>
<ol class="lowerroman" id="active-members">
<li><p class="first">If there is only one such event, the display name for the room should be
the <a class="reference internal" href="#calculating-the-display-name-for-a-user">disambiguated display name</a> of the corresponding user.</p>
</li>
<li><p class="first">If there are two such events, they should be lexicographically sorted by
their <tt class="docutils literal">state_key</tt> (i.e. the corresponding user IDs), and the display
name for the room should be the  <a class="reference internal" href="#calculating-the-display-name-for-a-user">disambiguated display name</a> of both
users: &quot;&lt;user1&gt; and &lt;user2&gt;&quot;, or a localised variant thereof.</p>
</li>
<li><p class="first">If there are three or more such events, the display name for the room
should be based on the disambiguated display name of the user
corresponding to the first such event, under a lexicographical sorting
according to their <tt class="docutils literal">state_key</tt>. The display name should be in the
format &quot;&lt;user1&gt; and &lt;N&gt; others&quot; (or a localised variant thereof), where N
is the number of <a class="reference internal" href="#m-room-member">m.room.member</a> events with <tt class="docutils literal">membership: join</tt> or
<tt class="docutils literal">membership: invite</tt>, excluding the logged-in user and &quot;user1&quot;.</p>
<p>For example, if Alice joins a room, where Bob (whose user id is
<tt class="docutils literal">&#64;superuser:example.com</tt>), Carol (user id <tt class="docutils literal">&#64;carol:example.com</tt>) and
Dan (user id <tt class="docutils literal">&#64;dan:matrix.org</tt>) are in conversation, Alice's
client should show the room name as &quot;Carol and 2 others&quot;.</p>
</li>
</ol>
<!-- TODO-spec
Sorting by user_id certainly isn't ideal, as IDs at the start of the
alphabet will end up dominating room names: they will all be called
"Arathorn and 15 others". Furthermore - user_ids are not necessarily
ASCII, which means we need to either specify a collation order, or specify
how to choose one.

Ideally we might sort by the time when the user was first invited to, or
first joined the room. But we don't have this information.

See https://matrix.org/jira/browse/SPEC-267 for further discussion. -->
</li>
<li><p class="first">If the room has no <tt class="docutils literal">m.room.name</tt> or <tt class="docutils literal">m.room.canonical_alias</tt> events, and
no active members other than the current user, clients should consider
<tt class="docutils literal">m.room.member</tt> events with <tt class="docutils literal">membership: leave</tt>. If such events exist, a
display name such as &quot;Empty room (was &lt;user1&gt; and &lt;N&gt; others)&quot; (or a
localised variant thereof) should be used, following similar rules as for
active members (see <a class="reference internal" href="#active-members">above</a>).</p>
</li>
<li><p class="first">A complete absence of <tt class="docutils literal">m.room.name</tt>, <tt class="docutils literal">m.room.canonical_alias</tt>, and
<tt class="docutils literal">m.room.member</tt> events is likely to indicate a problem with creating the
room or synchronising the state table; however clients should still handle
this situation. A display name such as &quot;Empty room&quot; (or a localised variant
thereof) should be used in this situation.</p>
</li>
</ol>
<p>Clients SHOULD NOT use <a class="reference internal" href="#m-room-aliases">m.room.aliases</a> events as a source for room names, as
it is difficult for clients to agree on the best alias to use, and aliases can
change unexpectedly.</p>
<!-- TODO-spec
How can we make this less painful for clients to implement, without forcing
an English-language implementation on them all? -->
</div>
</div>
<p><a class="anchor" id="server-behaviour"></a></p>
<div class="section" id="server-behaviour">
<h3><a class="toc-backref" href="#id191">5.2.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Homeservers SHOULD reject <tt class="docutils literal">m.room.message</tt> events which don't have a
<tt class="docutils literal">msgtype</tt> key, or which don't have a textual <tt class="docutils literal">body</tt> key, with an HTTP status
code of 400.</p>
</div>
<p><a class="anchor" id="security-considerations"></a></p>
<div class="section" id="security-considerations">
<h3><a class="toc-backref" href="#id192">5.2.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Messages sent using this module are not encrypted. Messages can be encrypted
using the <a class="reference internal" href="#module-e2e">E2E module</a>.</p>
<p>Clients should sanitise <strong>all displayed keys</strong> for unsafe HTML to prevent Cross-Site
Scripting (XSS) attacks. This includes room names and topics.</p>
</div>
</div>
<p><a class="anchor" id="voice-over-ip"></a></p>
<div class="section" id="voice-over-ip">
<h2><a class="toc-backref" href="#id193">5.3&nbsp;&nbsp;&nbsp;Voice over IP</a></h2>
<p id="module-voip">This module outlines how two users in a room can set up a Voice over IP (VoIP)
call to each other. Voice and video calls are built upon the WebRTC 1.0 standard.
Call signalling is achieved by sending <a class="reference internal" href="#sect-events">message events</a> to the room. As a result,
this means that clients MUST only send call events to rooms with exactly two
participants as currently the WebRTC standard is based around two-party
communication.</p>
<p><a class="anchor" id="id7"></a></p>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id194">5.3.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-call-invite"></a></p>
<div class="section" id="m-call-invite">
<h4><a class="toc-backref" href="#id195">5.3.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.invite</tt></a></h4>
<p><em>Message Event</em></p>
<p>This event is sent by the caller when they wish to establish a call.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>call_id</td>
<td>string</td>
<td>A unique identifer for the call.</td>
</tr>
<tr><td>lifetime</td>
<td>integer</td>
<td>The time in milliseconds that the invite is valid
for. Once the invite age exceeds this value,
clients should discard it. They should also no
longer show the call as awaiting an answer in the
UI.</td>
</tr>
<tr><td>offer</td>
<td>{Offer}</td>
<td>The session description object</td>
</tr>
<tr><td>version</td>
<td>integer</td>
<td>The version of the VoIP specification this message
adheres to. This specification is version 0.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Offer</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Offer Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sdp</td>
<td>string</td>
<td>The SDP text of the session description.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td>The type of session description. Must be 'offer'.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;call_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;12345&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;lifetime&quot;</span><span class="punctuation">:</span> <span class="literal number integer">60000</span><span class="punctuation">,</span>
        <span class="name tag">&quot;offer&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;sdp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;v=0\r\no=- 6584580628695956864 2 IN IP4 127.0.0.1[...]&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;offer&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.invite&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-call-candidates"></a></p>
<div class="section" id="m-call-candidates">
<h4><a class="toc-backref" href="#id196">5.3.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.candidates</tt></a></h4>
<p><em>Message Event</em></p>
<p>This event is sent by callers after sending an invite and by the callee after
answering. Its purpose is to give the other party additional ICE candidates to
try using to communicate.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="15%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>call_id</td>
<td>string</td>
<td>The ID of the call this event relates to.</td>
</tr>
<tr><td>candidates</td>
<td>[Candidate]</td>
<td>Array of objects describing the candidates.</td>
</tr>
<tr><td>version</td>
<td>integer</td>
<td>The version of the VoIP specification this
messages adheres to. This specification is version
0.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Candidate</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="14%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Candidate Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>candidate</td>
<td>string</td>
<td>The SDP 'a' line of the candidate.</td>
</tr>
<tr><td>sdpMLineIndex</td>
<td>number</td>
<td>The index of the SDP 'm' line this candidate is
intended for.</td>
</tr>
<tr><td>sdpMid</td>
<td>string</td>
<td>The SDP media type this candidate is intended for.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;call_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;12345&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;candidates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span>
                <span class="name tag">&quot;candidate&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;candidate:863018703 1 udp 2122260223 10.9.64.156 43670 typ host generation 0&quot;</span><span class="punctuation">,</span>
                <span class="name tag">&quot;sdpMLineIndex&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span><span class="punctuation">,</span>
                <span class="name tag">&quot;sdpMid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;audio&quot;</span>
            <span class="punctuation">}</span>
        <span class="punctuation">],</span>
        <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.candidates&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-call-answer"></a></p>
<div class="section" id="m-call-answer">
<h4><a class="toc-backref" href="#id197">5.3.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.answer</tt></a></h4>
<p><em>Message Event</em></p>
<p>This event is sent by the callee when they wish to answer the call.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>answer</td>
<td>{Answer}</td>
<td>The session description object</td>
</tr>
<tr><td>call_id</td>
<td>string</td>
<td>The ID of the call this event relates to.</td>
</tr>
<tr><td>version</td>
<td>number</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Answer</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Answer Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sdp</td>
<td>string</td>
<td>The SDP text of the session description.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td>The type of session description. Must be 'answer'.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;answer&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;sdp&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;v=0\r\no=- 6584580628695956864 2 IN IP4 127.0.0.1[...]&quot;</span><span class="punctuation">,</span>
            <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;answer&quot;</span>
        <span class="punctuation">},</span>
        <span class="name tag">&quot;call_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;12345&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;lifetime&quot;</span><span class="punctuation">:</span> <span class="literal number integer">60000</span><span class="punctuation">,</span>
        <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.answer&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="m-call-hangup"></a></p>
<div class="section" id="m-call-hangup">
<h4><a class="toc-backref" href="#id198">5.3.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.call.hangup</tt></a></h4>
<p><em>Message Event</em></p>
<p>Sent by either party to signal their termination of the call. This can be sent
either once the call has has been established or before to abort the call.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>call_id</td>
<td>string</td>
<td>The ID of the call this event relates to.</td>
</tr>
<tr><td>version</td>
<td>integer</td>
<td>The version of the VoIP specification this message
adheres to. This specification is version 0.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;call_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;12345&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal number integer">0</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.hangup&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id8"></a></p>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id199">5.3.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>A call is set up with message events exchanged as follows:</p>
<pre class="literal-block">
  Caller                    Callee
[Place Call]
m.call.invite -----------&gt;
m.call.candidate --------&gt;
[..candidates..] --------&gt;
                          [Answers call]
         &lt;--------------- m.call.answer
   [Call is active and ongoing]
         &lt;--------------- m.call.hangup
</pre>
<p>Or a rejected call:</p>
<pre class="literal-block">
  Caller                      Callee
m.call.invite ------------&gt;
m.call.candidate ---------&gt;
[..candidates..] ---------&gt;
                           [Rejects call]
           &lt;-------------- m.call.hangup
</pre>
<p>Calls are negotiated according to the WebRTC specification.</p>
<p><a class="anchor" id="glare"></a></p>
<div class="section" id="glare">
<h4><a class="toc-backref" href="#id200">5.3.2.1&nbsp;&nbsp;&nbsp;Glare</a></h4>
<p>&quot;Glare&quot; is a problem which occurs when two users call each other at roughly the
same time. This results in the call failing to set up as there already is an
incoming/outgoing call. A glare resolution algorithm can be used to determine
which call to hangup and which call to answer. If both clients implement the
same algorithm then they will both select the same call and the call will be
successfully connected.</p>
<p>As calls are &quot;placed&quot; to rooms rather than users, the glare resolution algorithm
outlined below is only considered for calls which are to the same room. The
algorithm is as follows:</p>
<ul class="simple">
<li>If an <tt class="docutils literal">m.call.invite</tt> to a room is received whilst the client is
<strong>preparing to send</strong> an <tt class="docutils literal">m.call.invite</tt> to the same room:<ul>
<li>the client should cancel its outgoing call and instead
automatically accept the incoming call on behalf of the user.</li>
</ul>
</li>
<li>If an <tt class="docutils literal">m.call.invite</tt> to a room is received <strong>after the client has sent</strong>
an <tt class="docutils literal">m.call.invite</tt> to the same room and is waiting for a response:<ul>
<li>the client should perform a lexicographical comparison of the call IDs of
the two calls and use the <em>lesser</em> of the two calls, aborting the
greater. If the incoming call is the lesser, the client should accept
this call on behalf of the user.</li>
</ul>
</li>
</ul>
<p>The call setup should appear seamless to the user as if they had simply placed
a call and the other party had accepted. This means any media stream that had been
setup for use on a call should be transferred and used for the call that
replaces it.</p>
</div>
</div>
<p><a class="anchor" id="id9"></a></p>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id201">5.3.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>The homeserver MAY provide a TURN server which clients can use to contact the
remote party. The following HTTP API endpoints will be used by clients in order
to get information about the TURN server.</p>
<p><a class="anchor" id="get-matrix-client-api-v1-turnserver"></a></p>
<div class="section" id="get-matrix-client-api-v1-turnserver">
<h4><a class="toc-backref" href="#id202">5.3.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/turnServer</tt></a></h4>
<p>This API provides credentials for the client to use when initiating calls.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<p><cite>No parameters</cite></p>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>password</td>
<td>string</td>
<td>The password to use.</td>
</tr>
<tr><td>ttl</td>
<td>integer</td>
<td>The time-to-live in seconds</td>
</tr>
<tr><td>uris</td>
<td>[string]</td>
<td>A list of TURN URIs</td>
</tr>
<tr><td>username</td>
<td>string</td>
<td>The username to use.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/turnServer</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The TURN server credentials.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;username&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;1443779631:&#64;user:example.com&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;password&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;JlKfBy1QwLrO20385QyAtEyIv0=&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;uris&quot;</span><span class="punctuation">:[</span>
    <span class="literal string double">&quot;turn:turn.example.com:3478?transport=udp&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;turn:10.20.30.40:3478?transport=tcp&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;turns:10.20.30.40:443?transport=tcp&quot;</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;ttl&quot;</span><span class="punctuation">:</span><span class="literal number integer">86400</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id10"></a></p>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id203">5.3.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Calls should only be placed to rooms with one other user in them. If they are
placed to group chat rooms it is possible that another user will intercept and
answer the call.</p>
</div>
</div>
<p><a class="anchor" id="id11"></a></p>
<div class="section" id="id11">
<h2><a class="toc-backref" href="#id204">5.4&nbsp;&nbsp;&nbsp;Typing Notifications</a></h2>
<p id="module-typing">Users may wish to be informed when another user is typing in a room. This can be
achieved using typing notifications. These are ephemeral events scoped to a
<tt class="docutils literal">room_id</tt>. This means they do not form part of the <a class="reference internal" href="#sect-event-graph">Event Graph</a> but still
have a <tt class="docutils literal">room_id</tt> key.</p>
<p><a class="anchor" id="id12"></a></p>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id205">5.4.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-typing"></a></p>
<div class="section" id="m-typing">
<h4><a class="toc-backref" href="#id206">5.4.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.typing</tt></a></h4>
<p><em>Typing Event</em></p>
<p>Informs the client of the list of users currently typing.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>user_ids</td>
<td>[string]</td>
<td>The list of user IDs typing in this room, if any.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;user_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="literal string double">&quot;&#64;alice:matrix.org&quot;</span><span class="punctuation">,</span>
            <span class="literal string double">&quot;&#64;bob:example.com&quot;</span>
        <span class="punctuation">]</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!z0mnsuiwhifuhwwfw:matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.typing&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id13"></a></p>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id207">5.4.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>When a client receives an <tt class="docutils literal">m.typing</tt> event, it MUST use the user ID list to
<strong>REPLACE</strong> its knowledge of every user who is currently typing. The reason for
this is that the server <em>does not remember</em> users who are not currently typing
as that list gets big quickly. The client should mark as not typing any user ID
who is not in that list.</p>
<p>It is recommended that clients store a <tt class="docutils literal">boolean</tt> indicating whether the user
is typing or not. Whilst this value is <tt class="docutils literal">true</tt> a timer should fire periodically
every N seconds to send a typing HTTP request. The value of N is recommended to
be no more than 20-30 seconds. This request should be re-sent by the client to
continue informing the server the user is still typing. As subsequent
requests will replace older requests, a safety margin of 5 seconds before the
expected timeout runs out is recommended. When the user stops typing, the
state change of the <tt class="docutils literal">boolean</tt> to <tt class="docutils literal">false</tt> should trigger another HTTP request
to inform the server that the user has stopped typing.</p>
<p><a class="anchor" id="put-matrix-client-api-v1-rooms-roomid-typing-userid"></a></p>
<div class="section" id="put-matrix-client-api-v1-rooms-roomid-typing-userid">
<h4><a class="toc-backref" href="#id208">5.4.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/typing/{userId}</span></tt></a></h4>
<p>This tells the server that the user is typing for the next N milliseconds where
N is the value specified in the <tt class="docutils literal">timeout</tt> key. Alternatively, if <tt class="docutils literal">typing</tt> is
<tt class="docutils literal">false</tt>, it tells the server that the user has stopped typing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user who has started to type.</td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room in which the user is
typing.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>timeout</td>
<td>integer</td>
<td>The length of time in milliseconds to mark this
user as typing.</td>
</tr>
<tr><td>typing</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the user is typing or not.
If <tt class="docutils literal">false</tt>, the <tt class="docutils literal">timeout</tt> key can be omitted.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21wefh3sfukhs%3Aexample.com/typing/%40alice%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;typing&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
  <span class="name tag">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="literal number integer">30000</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The new typing state was set.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id14"></a></p>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id209">5.4.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Servers MUST emit typing EDUs in a different form to <tt class="docutils literal">m.typing</tt> events which
are shown to clients. This form looks like:</p>
<pre class="literal-block">
{
  &quot;type&quot;: &quot;m.typing&quot;,
  &quot;content&quot;: {
    &quot;room_id&quot;: &quot;!room-id-here:matrix.org&quot;,
    &quot;user_id&quot;: &quot;&#64;user-id-here:matrix.org&quot;,
    &quot;typing&quot;: true/false
  }
}
</pre>
<p>This does not contain timing information so it is up to originating homeservers
to ensure they eventually send &quot;stop&quot; notifications.</p>
<!-- TODO
((This will eventually need addressing, as part of the wider typing/presence
timer addition work)) -->
</div>
<p><a class="anchor" id="id15"></a></p>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id210">5.4.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Clients may not wish to inform everyone in a room that they are typing and
instead only specific users in the room.</p>
</div>
</div>
<p><a class="anchor" id="id16"></a></p>
<div class="section" id="id16">
<h2><a class="toc-backref" href="#id211">5.5&nbsp;&nbsp;&nbsp;Receipts</a></h2>
<p id="module-receipts">This module adds in support for receipts. These receipts are a form of
acknowledgement of an event. This module defines a single acknowledgement:
<tt class="docutils literal">m.read</tt> which indicates that the user has read up to a given event.</p>
<p>Sending a receipt for each event can result in sending large amounts of traffic
to a homeserver. To prevent this from becoming a problem, receipts are implemented
using &quot;up to&quot; markers. This marker indicates that the acknowledgement applies
to all events &quot;up to and including&quot; the event specified. For example, marking
an event as &quot;read&quot; would indicate that the user had read all events <em>up to</em> the
referenced event.</p>
<p><a class="anchor" id="id17"></a></p>
<div class="section" id="id17">
<h3><a class="toc-backref" href="#id212">5.5.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p>Each <tt class="docutils literal">user_id</tt>, <tt class="docutils literal">receipt_type</tt> pair must be associated with only a
single <tt class="docutils literal">event_id</tt>.</p>
<p><a class="anchor" id="m-receipt"></a></p>
<div class="section" id="m-receipt">
<h4><a class="toc-backref" href="#id213">5.5.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.receipt</tt></a></h4>
<p><em>Receipt Event</em></p>
<p>Informs the client of new receipts.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>$EVENT_ID</td>
<td>{Receipts}</td>
<td>The mapping of event ID to a collection of
receipts for this event ID. The event ID is the ID
of the event being acknowledged and <em>not</em> an ID
for the receipt itself.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Receipts</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="14%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Receipts Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>m.read</td>
<td>{Users}</td>
<td>A collection of users who have sent <tt class="docutils literal">m.read</tt>
receipts for this event.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Users</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Users Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>$USER_ID</td>
<td>{Receipt}</td>
<td>The mapping of user ID to receipt. The user ID is
the entity who sent this receipt.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Receipt</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Receipt Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>ts</td>
<td>number</td>
<td>The timestamp the receipt was sent at.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;$1435641916114394fHBLK:matrix.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;m.read&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                <span class="name tag">&quot;&#64;rikj:jki.re&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                    <span class="name tag">&quot;ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1436451550453</span>
                <span class="punctuation">}</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!KpjVgQyZpzBwvMBsnT:matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.receipt&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id18"></a></p>
<div class="section" id="id18">
<h3><a class="toc-backref" href="#id214">5.5.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>In v1 <tt class="docutils literal">/initialSync</tt>, receipts are listed in a separate top level <tt class="docutils literal">receipts</tt>
key. In v2 <tt class="docutils literal">/sync</tt>, receipts are contained in the <tt class="docutils literal">ephemeral</tt> block for a
room. New receipts that come down the event streams are deltas which update
existing mappings. Clients should replace older receipt acknowledgements based
on <tt class="docutils literal">user_id</tt> and <tt class="docutils literal">receipt_type</tt> pairs. For example:</p>
<pre class="literal-block">
Client receives m.receipt:
  user = &#64;alice:example.com
  receipt_type = m.read
  event_id = $aaa:example.com

Client receives another m.receipt:
  user = &#64;alice:example.com
  receipt_type = m.read
  event_id = $bbb:example.com

The client should replace the older acknowledgement for $aaa:example.com with
this one for $bbb:example.com
</pre>
<p>Clients should send read receipts when there is some certainty that the event in
question has been <strong>displayed</strong> to the user. Simply receiving an event does not
provide enough certainty that the user has seen the event. The user SHOULD need
to <em>take some action</em> such as viewing the room that the event was sent to or
dismissing a notification in order for the event to count as &quot;read&quot;.</p>
<p>A client can update the markers for its user by interacting with the following
HTTP APIs.</p>
<p><a class="anchor" id="post-matrix-client-v2-alpha-rooms-roomid-receipt-receipttype-eventid"></a></p>
<div class="section" id="post-matrix-client-v2-alpha-rooms-roomid-receipt-receipttype-eventid">
<h4><a class="toc-backref" href="#id215">5.5.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/v2_alpha/rooms/{roomId}/receipt/{receiptType}/{eventId}</span></tt></a></h4>
<p>This API updates the marker for the given receipt type to the event ID
specified.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room in which to send the event.</td>
</tr>
<tr><td>receiptType</td>
<td>enum</td>
<td><strong>Required.</strong> The type of receipt to send. One of:
[&quot;m.read&quot;]</td>
</tr>
<tr><td>eventId</td>
<td>string</td>
<td><strong>Required.</strong> The event ID to acknowledge up to.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/v2_alpha/rooms/%21wefuh21ffskfuh345%3Aexample.com/receipt/m.read/%241924376522eioj%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The receipt was sent.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id19"></a></p>
<div class="section" id="id19">
<h3><a class="toc-backref" href="#id216">5.5.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>For efficiency, receipts SHOULD be batched into one event per room before
delivering them to clients.</p>
<p>Receipts are sent across federation as EDUs with type <tt class="docutils literal">m.receipt</tt>. The
format of the EDUs are:</p>
<pre class="literal-block">
{
    &lt;room_id&gt;: {
        &lt;receipt_type&gt;: {
            &lt;user_id&gt;: { &lt;content&gt; }
        },
        ...
    },
    ...
}
</pre>
<p>These are always sent as deltas to previously sent receipts. Currently only a
single <tt class="docutils literal">&lt;receipt_type&gt;</tt> should be used: <tt class="docutils literal">m.read</tt>.</p>
</div>
<p><a class="anchor" id="id20"></a></p>
<div class="section" id="id20">
<h3><a class="toc-backref" href="#id217">5.5.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>As receipts are sent outside the context of the event graph, there are no
integrity checks performed on the contents of <tt class="docutils literal">m.receipt</tt> events.</p>
</div>
</div>
<p><a class="anchor" id="id21"></a></p>
<div class="section" id="id21">
<h2><a class="toc-backref" href="#id218">5.6&nbsp;&nbsp;&nbsp;Presence</a></h2>
<p id="module-presence">Each user has the concept of presence information. This encodes:</p>
<ul class="simple">
<li>Whether the user is currently online</li>
<li>How recently the user was last active (as seen by the server)</li>
<li>Whether a given client considers the user to be currently idle</li>
<li>Arbitrary information about the user's current status (e.g. &quot;in a meeting&quot;).</li>
</ul>
<p>This information is collated from both per-device (<tt class="docutils literal">online</tt>, <tt class="docutils literal">idle</tt>,
<tt class="docutils literal">last_active</tt>) and per-user (status) data, aggregated by the user's homeserver
and transmitted as an <tt class="docutils literal">m.presence</tt> event. This is one of the few events which
are sent <em>outside the context of a room</em>. Presence events are sent to all users
who subscribe to this user's presence through a presence list or by sharing
membership of a room.</p>
<p>A presence list is a list of user IDs whose presence the user wants to follow.
To be added to this list, the user being added must be invited by the list owner
who must accept the invitation.</p>
<p>User's presence state is represented by the <tt class="docutils literal">presence</tt> key, which is an enum
of one of the following:</p>
<ul class="simple">
<li><tt class="docutils literal">online</tt> : The default state when the user is connected to an event
stream.</li>
<li><tt class="docutils literal">unavailable</tt> : The user is not reachable at this time e.g. they are
idle.</li>
<li><tt class="docutils literal">offline</tt> : The user is not connected to an event stream or is
explicitly suppressing their profile information from being sent.</li>
<li><tt class="docutils literal">free_for_chat</tt> : The user is generally willing to receive messages
moreso than default.</li>
</ul>
<p><a class="anchor" id="id22"></a></p>
<div class="section" id="id22">
<h3><a class="toc-backref" href="#id219">5.6.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-presence"></a></p>
<div class="section" id="m-presence">
<h4><a class="toc-backref" href="#id220">5.6.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.presence</tt></a></h4>
<p><em>Presence Event</em></p>
<p>Informs the client of a user's presence state change.</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="13%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>avatar_url</td>
<td>string</td>
<td>The current avatar URL for this user, if any.</td>
</tr>
<tr><td>displayname</td>
<td>string</td>
<td>The current display name for this user, if any.</td>
</tr>
<tr><td>last_active_ago</td>
<td>number</td>
<td>The last time since this used performed some
action, in milliseconds.</td>
</tr>
<tr><td>presence</td>
<td>enum</td>
<td>The presence state for this user. One of:
[&quot;online&quot;, &quot;offline&quot;, &quot;unavailable&quot;,
&quot;free_for_chat&quot;, &quot;hidden&quot;]</td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td>The user's ID.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://localhost:wefuiwegh8742w&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;last_active_ago&quot;</span><span class="punctuation">:</span> <span class="literal number integer">2478593</span><span class="punctuation">,</span>
        <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;online&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.presence&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id23"></a></p>
<div class="section" id="id23">
<h3><a class="toc-backref" href="#id221">5.6.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients can manually set/get their presence/presence list using the HTTP APIs
listed below.</p>
<p><a class="anchor" id="put-matrix-client-api-v1-presence-userid-status"></a></p>
<div class="section" id="put-matrix-client-api-v1-presence-userid-status">
<h4><a class="toc-backref" href="#id222">5.6.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/presence/{userId}/status</span></tt></a></h4>
<p>This API sets the given user's presence state. When setting the status, the
activity time is updated to reflect that activity; the client does not need to
specify the <tt class="docutils literal">last_active_ago</tt> field. You cannot set the presence state of
another user.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose presence state to
update.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>status_msg</td>
<td>string</td>
<td>The status message to attach to this state.</td>
</tr>
<tr><td>presence</td>
<td>string</td>
<td><strong>Required.</strong> The new presence state.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/api/v1/presence/%40alice%3Aexample.com/status</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;online&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;status_msg&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;I am here.&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The new presence state was set.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-presence-userid-status"></a></p>
<div class="section" id="get-matrix-client-api-v1-presence-userid-status">
<h4><a class="toc-backref" href="#id223">5.6.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/presence/{userId}/status</span></tt></a></h4>
<p>Get the given user's presence state.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose presence state to
get.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="18%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>last_active_ago</td>
<td>integer</td>
<td>The length of time in milliseconds since an action
was performed by this user.</td>
</tr>
<tr><td>presence</td>
<td>enum</td>
<td>This user's presence. One of: [&quot;online&quot;,
&quot;offline&quot;, &quot;unavailable&quot;, &quot;free_for_chat&quot;]</td>
</tr>
<tr><td>status_msg</td>
<td>string or null</td>
<td>The state message for this user if one was set.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/presence/%40alice%3Aexample.com/status</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The presence state for this user.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;unavailable&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;last_active_ago&quot;</span><span class="punctuation">:</span> <span class="literal number integer">420845</span><span class="punctuation">,</span>
  <span class="name tag">&quot;status_msg&quot;</span><span class="punctuation">:</span> <span class="keyword constant">null</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-client-api-v1-presence-list-userid"></a></p>
<div class="section" id="post-matrix-client-api-v1-presence-list-userid">
<h4><a class="toc-backref" href="#id224">5.6.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/presence/list/{userId}</span></tt></a></h4>
<p>Adds or removes users from this presence list.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="18%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose presence list is
being modified.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>drop</td>
<td>array[string]</td>
<td>A list of user IDs to remove from the list.</td>
</tr>
<tr><td>invite</td>
<td>array[string]</td>
<td>A list of user IDs to add to the list.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/presence/list/%40alice%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;invite&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;&#64;bob:matrix.org&quot;</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;drop&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;&#64;alice:matrix.org&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The list was updated.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-presence-list-userid"></a></p>
<div class="section" id="get-matrix-client-api-v1-presence-list-userid">
<h4><a class="toc-backref" href="#id225">5.6.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/presence/list/{userId}</span></tt></a></h4>
<p>Retrieve a list of presence events for every user on this list.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user whose presence list should
be retrieved.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="20%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>N/A</td>
<td>[PresenceEvent]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/presence/list/%40alice%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of presence events for this list.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">[</span>
  <span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://matrix.org/AfwefuigfWEfhuiPP&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;last_active_ago&quot;</span><span class="punctuation">:</span> <span class="literal number integer">395</span><span class="punctuation">,</span>
      <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;offline&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:matrix.org&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.presence&quot;</span>
  <span class="punctuation">},</span>
  <span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://matrix.org/FWEhuiwegfWEfhuiwf&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;displayname&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Marisa Kirisame&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;last_active_ago&quot;</span><span class="punctuation">:</span> <span class="literal number integer">16874</span><span class="punctuation">,</span>
      <span class="name tag">&quot;presence&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;online&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;marisa:matrix.org&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.presence&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">]</span>
</pre>
</div>
<p><a class="anchor" id="idle-timeout"></a></p>
<div class="section" id="idle-timeout">
<h4><a class="toc-backref" href="#id226">5.6.2.5&nbsp;&nbsp;&nbsp;Idle timeout</a></h4>
<p>Clients SHOULD implement an &quot;idle timeout&quot;. This is a timer which fires after
a period of inactivity on the client. The definition of inactivity varies
depending on the client. For example, web implementations may determine
inactivity to be not moving the mouse for a certain period of time. When this
timer fires it should set the presence state to <tt class="docutils literal">unavailable</tt>. When the user
becomes active again (e.g. by moving the mouse) the client should set the
presence state to <tt class="docutils literal">online</tt>. A timeout value between 1 and 5 minutes is
recommended.</p>
</div>
</div>
<p><a class="anchor" id="id24"></a></p>
<div class="section" id="id24">
<h3><a class="toc-backref" href="#id227">5.6.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Each user's home server stores a &quot;presence list&quot; per user. Once a user accepts
a presence list, both user's HSes must track the subscription.</p>
<p><a class="anchor" id="propagating-profile-information"></a></p>
<div class="section" id="propagating-profile-information">
<h4><a class="toc-backref" href="#id228">5.6.3.1&nbsp;&nbsp;&nbsp;Propagating profile information</a></h4>
<p>Because the profile display name and avatar information are likely to be used in
many places of a client's display, changes to these fields SHOULD cause an
automatic propagation event to occur, informing likely-interested parties of the
new values. One of these change mechanisms SHOULD be via <tt class="docutils literal">m.presence</tt> events.
These events should set <tt class="docutils literal">displayname</tt> and <tt class="docutils literal">avatar_url</tt> to the new values
along with the presence-specific keys. This SHOULD be done automatically by the
home server when a user successfully changes their display name or avatar URL.</p>
<div class="admonition-rationale admonition">
<p class="first admonition-title">Rationale</p>
<p class="last">The intention for sending this information in <tt class="docutils literal">m.presence</tt> is so that any
&quot;user list&quot; can display the <em>current</em> name/presence for a user ID outside the
scope of a room e.g. for a user page. This is bundled into a single event for
several reasons. The user's display name can change per room. This
event provides the &quot;canonical&quot; name for the user. In addition, the name is
bundled into a single event for the ease of client implementations. If this
was not done, the client would need to search all rooms for their own
membership event to pull out the display name.</p>
</div>
</div>
<p><a class="anchor" id="last-active-ago"></a></p>
<div class="section" id="last-active-ago">
<h4><a class="toc-backref" href="#id229">5.6.3.2&nbsp;&nbsp;&nbsp;Last active ago</a></h4>
<p>The server maintains a timestamp of the last time it saw a
pro-active event from the user. A pro-active event may be sending a message to a
room or changing presence state to a higher level of availability. Levels of
availability are defined from low to high as follows:</p>
<ul class="simple">
<li><tt class="docutils literal">offline</tt></li>
<li><tt class="docutils literal">unavailable</tt></li>
<li><tt class="docutils literal">online</tt></li>
<li><tt class="docutils literal">free_for_chat</tt></li>
</ul>
<p>Based on this list, changing state from <tt class="docutils literal">unavailable</tt> to <tt class="docutils literal">online</tt> counts as
a pro-active event, whereas <tt class="docutils literal">online</tt> to <tt class="docutils literal">unavailable</tt> does not. This
timestamp is presented via a key called <tt class="docutils literal">last_active_ago</tt> which gives the
relative number of milliseconds since the pro-active event.</p>
</div>
</div>
<p><a class="anchor" id="id25"></a></p>
<div class="section" id="id25">
<h3><a class="toc-backref" href="#id230">5.6.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Presence information is shared with all users who share a room with the target
user. In large public rooms this could be undesirable.</p>
</div>
</div>
<p><a class="anchor" id="id26"></a></p>
<div class="section" id="id26">
<h2><a class="toc-backref" href="#id231">5.7&nbsp;&nbsp;&nbsp;Content repository</a></h2>
<p id="module-content">This module allows users to upload content to their homeserver which is
retrievable from other homeservers. Its' purpose is to allow users to share
attachments in a room. Content locations are represented as Matrix Content (MXC)
URIs. They look like:</p>
<pre class="literal-block">
mxc://&lt;server-name&gt;/&lt;media-id&gt;

&lt;server-name&gt; : The name of the homeserver where this content originated, e.g. matrix.org
&lt;media-id&gt; : An opaque ID which identifies the content.
</pre>
<p>Uploads are POSTed to a resource on the user's local homeserver which returns a
token which is used to GET the download. Content is downloaded from the
recipient's local homeserver, which must first transfer the content from the
origin homeserver using the same API (unless the origin and destination
homeservers are the same).</p>
<p><a class="anchor" id="id27"></a></p>
<div class="section" id="id27">
<h3><a class="toc-backref" href="#id232">5.7.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients can upload and download content using the following HTTP APIs.</p>
<p><a class="anchor" id="get-matrix-media-v1-download-servername-mediaid"></a></p>
<div class="section" id="get-matrix-media-v1-download-servername-mediaid">
<h4><a class="toc-backref" href="#id233">5.7.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/media/v1/download/{serverName}/{mediaId}</span></tt></a></h4>
<p>Download content from the content repository.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>serverName</td>
<td>string</td>
<td><strong>Required.</strong> The server name from the <tt class="docutils literal"><span class="pre">mxc://</span></tt>
URI (the authoritory component)</td>
</tr>
<tr><td>mediaId</td>
<td>string</td>
<td><strong>Required.</strong> The media ID from the <tt class="docutils literal"><span class="pre">mxc://</span></tt> URI
(the path component)</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="17%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;file&gt;</td>
<td>file</td>
<td>The content that was previously uploaded.</td>
</tr>
<tr><td>Content-Type</td>
<td>Header&lt;string&gt;</td>
<td>The content type of the file that was previously
uploaded.</td>
</tr>
<tr><td>Content-Disposition</td>
<td>Header&lt;string&gt;</td>
<td>The name of the file that was previously uploaded,
if set.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/media/v1/download/matrix.org/ascERGshawAWawugaAcauga</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-media-v1-thumbnail-servername-mediaid"></a></p>
<div class="section" id="get-matrix-media-v1-thumbnail-servername-mediaid">
<h4><a class="toc-backref" href="#id234">5.7.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/media/v1/thumbnail/{serverName}/{mediaId}</span></tt></a></h4>
<p>Download a thumbnail of the content from the content repository.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>serverName</td>
<td>string</td>
<td><strong>Required.</strong> The server name from the <tt class="docutils literal"><span class="pre">mxc://</span></tt>
URI (the authoritory component)</td>
</tr>
<tr><td>mediaId</td>
<td>string</td>
<td><strong>Required.</strong> The media ID from the <tt class="docutils literal"><span class="pre">mxc://</span></tt> URI
(the path component)</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>width</td>
<td>integer</td>
<td>The <em>desired</em> width of the thumbnail. The actual
thumbnail may not match the size specified.</td>
</tr>
<tr><td>height</td>
<td>integer</td>
<td>The <em>desired</em> height of the thumbnail. The actual
thumbnail may not match the size specified.</td>
</tr>
<tr><td>method</td>
<td>enum</td>
<td>The desired resizing method. One of: [&quot;crop&quot;,
&quot;scale&quot;]</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="18%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>&lt;file&gt;</td>
<td>file</td>
<td>A thumbnail of the requested content.</td>
</tr>
<tr><td>Content-Type</td>
<td>Header&lt;string&gt;</td>
<td>The content type of the thumbnail.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/media/v1/thumbnail/matrix.org/ascERGshawAWawugaAcauga?width=64&amp;height=64&amp;method=scale</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
</div>
<p><a class="anchor" id="post-matrix-media-v1-upload"></a></p>
<div class="section" id="post-matrix-media-v1-upload">
<h4><a class="toc-backref" href="#id235">5.7.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/media/v1/upload</tt></a></h4>
<p>Upload some content to the content repository.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="14%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>body parameters</em></td>
</tr>
<tr><td>&lt;content&gt;</td>
<td>byte</td>
<td><strong>Required.</strong> The content to be uploaded.</td>
</tr>
<tr><td colspan="3"><em>header parameters</em></td>
</tr>
<tr><td>Content-Type</td>
<td>string</td>
<td>The content type of the file being uploaded</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="14%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content_uri</td>
<td>string</td>
<td>The MXC URI to the uploaded content.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/media/v1/upload</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="error">&lt;bytes&gt;</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The MXC URI for the uploaded content.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;content_uri&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mxc://example.com/AQwafuaFswefuhsfAFAgsw&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="thumbnails"></a></p>
<div class="section" id="thumbnails">
<h4><a class="toc-backref" href="#id236">5.7.1.4&nbsp;&nbsp;&nbsp;Thumbnails</a></h4>
<p>The thumbnail methods are &quot;crop&quot; and &quot;scale&quot;. &quot;scale&quot; tries to return an
image where either the width or the height is smaller than the requested
size. The client should then scale and letterbox the image if it needs to
fit within a given rectangle. &quot;crop&quot; tries to return an image where the
width and height are close to the requested size and the aspect matches
the requested size. The client should scale the image if it needs to fit
within a given rectangle.</p>
<dl class="docutils">
<dt>In summary:</dt>
<dd><ul class="first last simple">
<li>&quot;scale&quot; maintains the original aspect ratio of the image</li>
<li>&quot;crop&quot; provides an image in the aspect ratio of the sizes given in the request</li>
</ul>
</dd>
</dl>
</div>
</div>
<p><a class="anchor" id="id28"></a></p>
<div class="section" id="id28">
<h3><a class="toc-backref" href="#id237">5.7.2&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Homeservers may generate thumbnails for content uploaded to remote
homeservers themselves or may rely on the remote homeserver to thumbnail
the content. Homeservers may return thumbnails of a different size to that
requested. However homeservers should provide exact matches where reasonable.
Homeservers must never upscale images.</p>
</div>
<p><a class="anchor" id="id29"></a></p>
<div class="section" id="id29">
<h3><a class="toc-backref" href="#id238">5.7.3&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>The HTTP GET endpoint does not require any authentication. Knowing the URL of
the content is sufficient to retrieve the content, even if the entity isn't in
the room.</p>
<p>MXC URIs are vulnerable to directory traversal attacks such as
<tt class="docutils literal"><span class="pre">mxc://127.0.0.1/../../../some_service/etc/passwd</span></tt>. This would cause the target
homeserver to try to access and return this file. As such, homeservers MUST
sanitise MXC URIs by allowing only alphanumeric (<tt class="docutils literal"><span class="pre">A-Za-z0-9</span></tt>), <tt class="docutils literal">_</tt>
and  <tt class="docutils literal">-</tt> characters in the <tt class="docutils literal"><span class="pre">server-name</span></tt> and <tt class="docutils literal"><span class="pre">media-id</span></tt> values. This set
of whitelisted characters allows URL-safe base64 encodings specified in RFC 4648.
Applying this character whitelist is preferable to blacklisting <tt class="docutils literal">.</tt> and <tt class="docutils literal">/</tt>
as there are techniques around blacklisted characters (percent-encoded characters,
UTF-8 encoded traversals, etc).</p>
<p>Homeservers have additional content-specific concerns:</p>
<ul class="simple">
<li>Clients may try to upload very large files. Homeservers should not store files
that are too large and should not serve them to clients.</li>
<li>Clients may try to upload very large images. Homeservers should not attempt to
generate thumbnails for images that are too large.</li>
<li>Remote homeservers may host very large files or images. Homeservers should not
proxy or thumbnail large files or images from remote homeservers.</li>
<li>Clients may try to upload a large number of files. Homeservers should limit the
number and total size of media that can be uploaded by clients.</li>
<li>Clients may try to access a large number of remote files through a homeserver.
Homeservers should restrict the number and size of remote files that it caches.</li>
<li>Clients or remote homeservers may try to upload malicious files targeting
vulnerabilities in either the homeserver thumbnailing or the client decoders.</li>
</ul>
</div>
</div>
<p><a class="anchor" id="id30"></a></p>
<div class="section" id="id30">
<h2><a class="toc-backref" href="#id239">5.8&nbsp;&nbsp;&nbsp;End-to-End Encryption</a></h2>
<span class="target" id="module-e2e"></span><!-- TODO-doc
- Why is this needed.
- Overview of process
- Implementation -->
<p>Matrix optionally supports end-to-end encryption, allowing rooms to be created
whose conversation contents is not decryptable or interceptable on any of the
participating homeservers.</p>
<p>End-to-end crypto is still being designed and prototyped - notes on the design
may be found at <a class="reference external" href="https://lwn.net/Articles/634144/">https://lwn.net/Articles/634144/</a></p>
</div>
<p><a class="anchor" id="room-history-visibility"></a></p>
<div class="section" id="room-history-visibility">
<h2><a class="toc-backref" href="#id240">5.9&nbsp;&nbsp;&nbsp;Room History Visibility</a></h2>
<p id="module-history-visibility">This module adds support for controlling the visibility of previous events in a
room.</p>
<p>In all cases except <tt class="docutils literal">world_readable</tt>, a user needs to join a room to view events in that room. Once they
have joined a room, they will gain access to a subset of events in the room. How
this subset is chosen is controlled by the <tt class="docutils literal">m.room.history_visibility</tt> event
outlined below. After a user has left a room, they may seen any events which they
were allowed to see before they left the room, but no events received after they
left.</p>
<p>The four options for the <tt class="docutils literal">m.room.history_visibility</tt> event are:</p>
<ul class="simple">
<li><tt class="docutils literal">shared</tt> - Previous events are always accessible to newly joined members. All
events in the room are accessible, even those sent when the member was not a part
of the room.</li>
<li><tt class="docutils literal">invited</tt> - Previous events are accessible to newly joined members from the point
they were invited onwards. Events stop being accessible when the member's state
changes to something other than <tt class="docutils literal">invite</tt> or <tt class="docutils literal">join</tt>.</li>
<li><tt class="docutils literal">joined</tt> - Previous events are accessible to newly joined members from the point
they joined the room onwards. Events stop being accessible when the member's state
changes to something other than <tt class="docutils literal">join</tt>.</li>
<li><tt class="docutils literal">world_readable</tt> - All events while this is the <tt class="docutils literal">m.room.history_visibility</tt> value
may be shared by any participating homeserver with anyone, regardless of whether
they have ever joined the room.</li>
</ul>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">These options are applied at the point an event is <em>sent</em>. Checks are
performed with the state of the <tt class="docutils literal">m.room.history_visibility</tt> event when the
event in question is added to the DAG. This means clients cannot
retrospectively choose to show or hide history to new users if the setting at
that time was more restrictive.</p>
</div>
<p><a class="anchor" id="id31"></a></p>
<div class="section" id="id31">
<h3><a class="toc-backref" href="#id241">5.9.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-room-history-visibility"></a></p>
<div class="section" id="m-room-history-visibility">
<h4><a class="toc-backref" href="#id242">5.9.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.history_visibility</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This event controls whether a user can see the events that happened in a room
from before they joined.</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="13%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>history_visibility</td>
<td>enum</td>
<td>Who can see the room history. One of: [&quot;invited&quot;,
&quot;joined&quot;, &quot;shared&quot;, &quot;world_readable&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;history_visibility&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;shared&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.history_visibility&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id32"></a></p>
<div class="section" id="id32">
<h3><a class="toc-backref" href="#id243">5.9.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients that implement this module MUST present to the user the possible options
for setting history visibility when creating a room.</p>
<p>Clients may want to display a notice that their events may be read by non-joined
people if the value is set to <tt class="docutils literal">world_readable</tt>.</p>
</div>
<p><a class="anchor" id="id33"></a></p>
<div class="section" id="id33">
<h3><a class="toc-backref" href="#id244">5.9.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>By default if no <tt class="docutils literal">history_visibility</tt> is set, or if the value is not understood, the visibility is assumed to be
<tt class="docutils literal">shared</tt>. The rules governing whether a user is allowed to see an event depend
solely on the state of the room <em>at that event</em>:</p>
<ol class="arabic simple">
<li>If the user was joined, allow.</li>
<li>If the user was invited and the <tt class="docutils literal">history_visibility</tt> was set to
<tt class="docutils literal">invited</tt> or <tt class="docutils literal">shared</tt>, allow.</li>
<li>If the user was neither invited nor joined but the <tt class="docutils literal">history_visibility</tt>
was set to <tt class="docutils literal">shared</tt>, allow.</li>
<li>Otherwise, deny.</li>
</ol>
</div>
<p><a class="anchor" id="id34"></a></p>
<div class="section" id="id34">
<h3><a class="toc-backref" href="#id245">5.9.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>The default value for <tt class="docutils literal">history_visibility</tt> is <tt class="docutils literal">shared</tt> for
backwards-compatibility reasons. Clients need to be aware that by not setting
this event they are exposing all of their room history to anyone in the room.</p>
</div>
</div>
<p><a class="anchor" id="id35"></a></p>
<div class="section" id="id35">
<h2><a class="toc-backref" href="#id246">5.10&nbsp;&nbsp;&nbsp;Push Notifications</a></h2>
<pre class="literal-block" id="module-push">
                                  +--------------------+  +-------------------+
                 Matrix HTTP      |                    |  |                   |
            Notification Protocol |   App Developer    |  |   Device Vendor   |
                                  |                    |  |                   |
          +-------------------+   | +----------------+ |  | +---------------+ |
          |                   |   | |                | |  | |               | |
          | Matrix Home Server+-----&gt;  Push Gateway  +------&gt; Push Provider | |
          |                   |   | |                | |  | |               | |
          +-^-----------------+   | +----------------+ |  | +----+----------+ |
            |                     |                    |  |      |            |
   Matrix   |                     |                    |  |      |            |
Client/Server API  +              |                    |  |      |            |
            |      |              +--------------------+  +-------------------+
            |   +--+-+                                           |
            |   |    &lt;-------------------------------------------+
            +---+    |
                |    |          Provider Push Protocol
                +----+

        Mobile Device or Client
</pre>
<p>This module adds support for push notifications. Homeservers send notifications
of events to user-configured HTTP endpoints. Users may also configure a
number of rules that determine which events generate notifications. These are
all stored and managed by the user's homeserver. This allows user-specific push
settings to be reused between client applications.</p>
<p>The above diagram shows the flow of push notifications being sent to a handset
where push notifications are submitted via the handset vendor, such as Apple's
APNS or Google's GCM. This happens as follows:</p>
<ol class="arabic simple">
<li>The client app signs in to a homeserver.</li>
<li>The client app registers with its vendor's Push Provider and
obtains a routing token of some kind.</li>
<li>The mobile app uses the Client/Server API to add a 'pusher', providing the
URL of a specific Push Gateway which is configured for that
application. It also provides the routing token it has acquired from the
Push Provider.</li>
<li>The homeserver starts sending HTTP requests to the Push Gateway using the
supplied URL. The Push Gateway relays this notification to
the Push Provider, passing the routing token along with any
necessary private credentials the provider requires to send push
notifications.</li>
<li>The Push Provider sends the notification to the device.</li>
</ol>
<p>Definitions for terms used in this section are below:</p>
<dl class="docutils">
<dt>Push Provider</dt>
<dd>A push provider is a service managed by the device vendor which can send
notifications directly to the device. Google Cloud Messaging (GCM) and Apple
Push Notification Service (APNS) are two examples of push providers.</dd>
<dt>Push Gateway</dt>
<dd>A push gateway is a server that receives HTTP event notifications from
homeservers and passes them on to a different protocol such as APNS for iOS
devices or GCM for Android devices. Clients inform the homeserver which
Push Gateway to send notifications to when it sets up a Pusher.</dd>
</dl>
<dl class="docutils" id="def-pushers">
<dt>Pusher</dt>
<dd>A pusher is a worker on the homeserver that manages the sending
of HTTP notifications for a user. A user can have multiple pushers: one per
device.</dd>
<dt>Push Rule</dt>
<dd>A push rule is a single rule that states under what <em>conditions</em> an event should
be passed onto a push gateway and <em>how</em> the notification should be presented.
These rules are stored on the user's homeserver. They are manually configured
by the user, who can create and view them via the Client/Server API.</dd>
<dt>Push Ruleset</dt>
<dd>A push ruleset <em>scopes a set of rules according to some criteria</em>. For example,
some rules may only be applied for messages from a particular sender,
a particular room, or by default. The push ruleset contains the entire set
of scopes and rules.</dd>
</dl>
<p><a class="anchor" id="id36"></a></p>
<div class="section" id="id36">
<h3><a class="toc-backref" href="#id247">5.10.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>Clients MUST configure a Pusher before they will receive push notifications.
There is a single API endpoint for this, as described below.</p>
<p><a class="anchor" id="post-matrix-client-api-v1-pushers-set"></a></p>
<div class="section" id="post-matrix-client-api-v1-pushers-set">
<h4><a class="toc-backref" href="#id248">5.10.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v1/pushers/set</tt></a></h4>
<p>This endpoint allows the creation, modification and deletion of <a class="reference internal" href="#def-pushers">pushers</a> for
this user ID. The behaviour of this endpoint varies depending on the values in
the JSON body.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="13%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>lang</td>
<td>string</td>
<td><strong>Required.</strong> The preferred language for receiving
notifications (e.g. 'en' or 'en-US')</td>
</tr>
<tr><td>kind</td>
<td>string</td>
<td><strong>Required.</strong> The kind of pusher to configure.
<tt class="docutils literal">&quot;http&quot;</tt> makes a pusher that sends HTTP pokes.
<tt class="docutils literal">null</tt> deletes the pusher.</td>
</tr>
<tr><td>app_display_name</td>
<td>string</td>
<td><strong>Required.</strong> A string that will allow the user to
identify what application owns this pusher.</td>
</tr>
<tr><td>device_display_name</td>
<td>string</td>
<td><strong>Required.</strong> A string that will allow the user to
identify what device owns this pusher.</td>
</tr>
<tr><td>app_id</td>
<td>string</td>
<td><strong>Required.</strong> This is a reverse-DNS style
identifier for the application. It is recommended
that this end with the platform, such that
different platform versions get different app
identifiers. Max length, 64 chars.</td>
</tr>
<tr><td>profile_tag</td>
<td>string</td>
<td><strong>Required.</strong> This is a string that determines
what set of device rules will be matched when
evaluating push rules for this pusher. It is an
arbitrary string. Multiple devices may use the
same <tt class="docutils literal">profile_tag</tt>. It is advised that when an
app's data is copied or restored to a different
device, this value remain the same. Client apps
should offer ways to change the <tt class="docutils literal">profile_tag</tt>,
optionally copying rules from the old profile tag.
Max length, 32 bytes.</td>
</tr>
<tr><td>pushkey</td>
<td>string</td>
<td><strong>Required.</strong> This is a unique identifier for this
pusher. The value you should use for this is the
routing or destination address information for the
notification, for example, the APNS token for APNS
or the Registration ID for GCM. If your
notification client has no such concept, use any
unique identifier. Max length, 512 bytes.</td>
</tr>
<tr><td>data</td>
<td>object</td>
<td><strong>Required.</strong> A dictionary of information for the
pusher implementation itself. If <tt class="docutils literal">kind</tt> is
<tt class="docutils literal">http</tt>, this should contain <tt class="docutils literal">url</tt> which is the
URL to use to send notifications to.</td>
</tr>
<tr><td>data.url</td>
<td>string</td>
<td>Required if <tt class="docutils literal">kind</tt> is <tt class="docutils literal">http</tt>. The URL to use
to send notifications to.</td>
</tr>
<tr><td>append</td>
<td>boolean</td>
<td>If true, the homeserver should add another pusher
with the given pushkey and App ID in addition to
any others with different user IDs. Otherwise, the
Home Server must remove any other pushers with the
same App ID and pushkey for different users. The
default is <tt class="docutils literal">false</tt>.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/pushers/set</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;en&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;http&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;app_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Mat Rix&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;device_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;iPhone 9&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;app_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;com.example.app.ios&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;profile_tag&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;4bea66906d0111e59d70feff819cdc9f&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;pushkey&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;APA91bHPRgkF3JUikC4ENAHEeMrd41Zxv3hVZjC9KtT8OvPVGJ-hQMRKRrZuJAEcl7B338qju59zJMjw2DELjzEvxwYv7hH5Ynpc1ODQ0aT4U4OFEeco8ohsN5PjL1iC2dNtk2BAokeMCg2ZXKqpc8FXKmhX94kIxQ&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://push-gateway.location.here&quot;</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;append&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
<span class="punctuation">}</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The pusher was set.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>One or more of the pusher values were invalid.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Missing parameters: lang, data&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_MISSING_PARAM&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="push-rules"></a></p>
<div class="section" id="push-rules">
<h4><a class="toc-backref" href="#id249">5.10.1.2&nbsp;&nbsp;&nbsp;Push Rules</a></h4>
<p>A push rule is a single rule that states under what <em>conditions</em> an event should
be passed onto a push gateway and <em>how</em> the notification should be presented.
There are different &quot;kinds&quot; of push rules and each rule has an associated
priority. Every push rule MUST have a <tt class="docutils literal">kind</tt> and <tt class="docutils literal">rule_id</tt>. The <tt class="docutils literal">rule_id</tt>
is a unique string within the kind of rule and its' scope: <tt class="docutils literal">rule_ids</tt> do not
need to be unique between rules of the same kind on different devices. Rules may
have extra keys depending on the value of <tt class="docutils literal">kind</tt>.The different kinds of rule
in descending order of priority are:</p>
<dl class="docutils">
<dt>Override Rules <tt class="docutils literal">override</tt></dt>
<dd>The highest priority rules are user-configured overrides.</dd>
<dt>Content-specific Rules <tt class="docutils literal">content</tt></dt>
<dd>These configure behaviour for (unencrypted) messages that match certain
patterns. Content rules take one parameter: <tt class="docutils literal">pattern</tt>, that gives the glob
pattern to match against. This is treated in the same way as <tt class="docutils literal">pattern</tt> for
<tt class="docutils literal">event_match</tt>.</dd>
<dt>Room-specific Rules <tt class="docutils literal">room</tt></dt>
<dd>These rules change the behaviour of all messages for a given room. The
<tt class="docutils literal">rule_id</tt> of a room rule is always the ID of the room that it affects.</dd>
<dt>Sender-specific rules <tt class="docutils literal">sender</tt></dt>
<dd>These rules configure notification behaviour for messages from a specific
Matrix user ID. The <tt class="docutils literal">rule_id</tt> of Sender rules is always the Matrix user
ID of the user whose messages they'd apply to.</dd>
<dt>Underride rules <tt class="docutils literal">underride</tt></dt>
<dd>These are identical to <tt class="docutils literal">override</tt> rules, but have a lower priority than
<tt class="docutils literal">content</tt>, <tt class="docutils literal">room</tt> and <tt class="docutils literal">sender</tt> rules.</dd>
</dl>
<p>Push rules may be either global or device-specific. Device specific rules only
affect delivery of notifications via pushers with a matching <tt class="docutils literal">profile_tag</tt>.
All device-specific rules have a higher priority than global rules. This means
that the full list of rule kinds, in descending priority order, is as follows:</p>
<ul class="simple">
<li>Device-specific Override</li>
<li>Device-specific Content</li>
<li>Device-specific Room</li>
<li>Device-specific Sender</li>
<li>Device-specific Underride</li>
<li>Global Override</li>
<li>Global Content</li>
<li>Global Room</li>
<li>Global Sender</li>
<li>Global Underride</li>
</ul>
<p>Rules with the same <tt class="docutils literal">kind</tt> can specify an ordering priority. This determines
which rule is selected in the event of multiple matches. For example, a rule
matching &quot;tea&quot; and a separate rule matching &quot;time&quot; would both match the sentence
&quot;It's time for tea&quot;. The ordering of the rules would then resolve the tiebreak
to determine which rule is executed. Only <tt class="docutils literal">actions</tt> for highest priority rule
will be sent to the Push Gateway.</p>
<p>Each rule can be enabled or disabled. Disabled rules never match. If no rules
match an event, the homeserver MUST NOT notify the Push Gateway for that event.
Homeservers MUST NOT notify the Push Gateway for events that the user has sent
themselves.</p>
<p><a class="anchor" id="actions"></a></p>
<div class="section" id="actions">
<h5><a class="toc-backref" href="#id250">5.10.1.2.1&nbsp;&nbsp;&nbsp;Actions</a></h5>
<p>All rules have an associated list of <tt class="docutils literal">actions</tt>. An action affects if and how a
notification is delivered for a matching event. The following actions are defined:</p>
<dl class="docutils">
<dt><tt class="docutils literal">notify</tt></dt>
<dd>This causes each matching event to generate a notification.</dd>
<dt><tt class="docutils literal">dont_notify</tt></dt>
<dd>This prevents each matching event from generating a notification</dd>
<dt><tt class="docutils literal">coalesce</tt></dt>
<dd>This enables notifications for matching events but activates homeserver
specific behaviour to intelligently coalesce multiple events into a single
notification. Not all homeservers may support this. Those that do not support
it should treat it as the <tt class="docutils literal">notify</tt> action.</dd>
<dt><tt class="docutils literal">set_tweak</tt></dt>
<dd>Sets an entry in the <tt class="docutils literal">tweaks</tt> dictionary key that is sent in the notification
request to the Push Gateway. This takes the form of a dictionary with a
<tt class="docutils literal">set_tweak</tt> key whose value is the name of the tweak to set. It may also
have a <tt class="docutils literal">value</tt> key which is the value to which it should be set.</dd>
</dl>
<p>Actions that have no parameters are represented as a string. Otherwise, they are
represented as a dictionary with a key equal to their name and other keys as
their parameters, e.g. <tt class="docutils literal">{ &quot;set_tweak&quot;: &quot;sound&quot;, &quot;value&quot;: &quot;default&quot; }</tt></p>
<p><a class="anchor" id="tweaks"></a></p>
<div class="section" id="tweaks">
<h6><a class="toc-backref" href="#id251">5.10.1.2.1.1&nbsp;&nbsp;&nbsp;Tweaks</a></h6>
<p>The <tt class="docutils literal">set_tweak</tt> action is used to add an entry to the 'tweaks' dictionary
that is sent in the notification request to the Push Gateway. The following
tweaks are defined:</p>
<dl class="docutils">
<dt><tt class="docutils literal">sound</tt></dt>
<dd>A string representing the sound to be played when this notification arrives.
A value of <tt class="docutils literal">default</tt> means to play a default sound.</dd>
<dt><tt class="docutils literal">highlight</tt></dt>
<dd>A boolean representing whether or not this message should be highlighted in
the UI. This will normally take the form of presenting the message in a
different colour and/or style. The UI might also be adjusted to draw
particular attention to the room in which the event occurred. The <tt class="docutils literal">value</tt>
may be omitted from the highlight tweak, in which case it should default to
<tt class="docutils literal">true</tt>.</dd>
</dl>
<p>Tweaks are passed transparently through the homeserver so client applications
and Push Gateways may agree on additional tweaks. For example, a tweak may be
added to specify how to flash the notification light on a mobile device.</p>
</div>
</div>
<p><a class="anchor" id="predefined-rules"></a></p>
<div class="section" id="predefined-rules">
<h5><a class="toc-backref" href="#id252">5.10.1.2.2&nbsp;&nbsp;&nbsp;Predefined Rules</a></h5>
<p>Homeservers can specify &quot;server-default rules&quot; which operate at a lower priority
than &quot;user-defined rules&quot;. The <tt class="docutils literal">rule_id</tt> for all server-default rules MUST
start with a dot (&quot;.&quot;) to identify them as &quot;server-default&quot;. The following
server-default rules are specified:</p>
<dl class="docutils">
<dt><tt class="docutils literal">.m.rule.contains_user_name</tt></dt>
<dd><p class="first">Matches any message whose content is unencrypted and contains the local part
of the user's Matrix ID, separated by word boundaries.</p>
<p>Definition (as a <tt class="docutils literal">content</tt> rule):</p>
<pre class="last literal-block">
{
    &quot;rule_id&quot;: &quot;.m.rule.contains_user_name&quot;
    &quot;pattern&quot;: &quot;[the local part of the user's Matrix ID]&quot;,
    &quot;actions&quot;: [
        &quot;notify&quot;,
        {
            &quot;set_tweak&quot;: &quot;sound&quot;,
            &quot;value&quot;: &quot;default&quot;
        }
    ],
}
</pre>
</dd>
<dt><tt class="docutils literal">.m.rule.contains_display_name</tt></dt>
<dd><p class="first">Matches any message whose content is unencrypted and contains the user's
current display name in the room in which it was sent.</p>
<p>Definition (this rule can only be an <tt class="docutils literal">override</tt> or <tt class="docutils literal">underride</tt> rule):</p>
<pre class="last literal-block">
{
    &quot;rule_id&quot;: &quot;.m.rule.contains_display_name&quot;
    &quot;conditions&quot;: [
        {
            &quot;kind&quot;: &quot;contains_display_name&quot;
        }
    ],
    &quot;actions&quot;: [
        &quot;notify&quot;,
        {
            &quot;set_tweak&quot;: &quot;sound&quot;,
            &quot;value&quot;: &quot;default&quot;
        }
    ],
}
</pre>
</dd>
<dt><tt class="docutils literal">.m.rule.room_one_to_one</tt></dt>
<dd><p class="first">Matches any message sent in a room with exactly two members.</p>
<p>Definition (this rule can only be an <tt class="docutils literal">override</tt> or <tt class="docutils literal">underride</tt> rule):</p>
<pre class="last literal-block">
{
    &quot;rule_id&quot;: &quot;.m.rule.room_two_members&quot;
    &quot;conditions&quot;: [
        {
            &quot;is&quot;: &quot;2&quot;,
            &quot;kind&quot;: &quot;room_member_count&quot;
        }
    ],
    &quot;actions&quot;: [
        &quot;notify&quot;,
        {
            &quot;set_tweak&quot;: &quot;sound&quot;,
            &quot;value&quot;: &quot;default&quot;
        }
    ],
}
</pre>
</dd>
<dt><tt class="docutils literal">.m.rule.suppress_notices</tt></dt>
<dd><p class="first">Matches messages with a <tt class="docutils literal">msgtype</tt> of <tt class="docutils literal">notice</tt>. This should be an
<tt class="docutils literal">override</tt> rule so that it takes priority over <tt class="docutils literal">content</tt> / <tt class="docutils literal">sender</tt> /
<tt class="docutils literal">room</tt> rules.</p>
<p>Definition:</p>
<pre class="last literal-block">
{
    'rule_id': '.m.rule.suppress_notices',
    'conditions': [
        {
            'kind': 'event_match',
            'key': 'content.msgtype',
            'pattern': 'm.notice',
        }
    ],
    'actions': [
        'dont-notify',
    ]
}
</pre>
</dd>
<dt><tt class="docutils literal">.m.rule.fallback</tt></dt>
<dd><p class="first">Matches any message. Used to define the behaviour of messages that match no
other rules. If homeservers define this it should be the lowest priority
<tt class="docutils literal">underride</tt> rule.</p>
<p>Definition:</p>
<pre class="last literal-block">
{
    &quot;rule_id&quot;: &quot;.m.rule.fallback&quot;
    &quot;conditions&quot;: [],
    &quot;actions&quot;: [
        &quot;notify&quot;
    ],
}
</pre>
</dd>
</dl>
</div>
<p><a class="anchor" id="conditions"></a></p>
<div class="section" id="conditions">
<h5><a class="toc-backref" href="#id253">5.10.1.2.3&nbsp;&nbsp;&nbsp;Conditions</a></h5>
<p>Override, Underride and Default Rules MAY have a list of 'conditions'.
All conditions must hold true for an event in order to apply the <tt class="docutils literal">action</tt> for
the event. A rule with no conditions always matches. Room, Sender, User and
Content rules do not have conditions in the same way, but instead have
predefined conditions. These conditions can be configured using the parameters
outlined below. In the cases of room and sender rules, the <tt class="docutils literal">rule_id</tt> of the
rule determines its behaviour. The following conditions are defined:</p>
<dl class="docutils">
<dt><tt class="docutils literal">event_match</tt></dt>
<dd><p class="first">This is a glob pattern match on a field of the event. Parameters:</p>
<ul class="last simple">
<li><tt class="docutils literal">key</tt>: The dot-separated field of the event to match, e.g. <tt class="docutils literal">content.body</tt></li>
<li><tt class="docutils literal">pattern</tt>: The glob-style pattern to match against. Patterns with no
special glob characters should be treated as having asterisks
prepended and appended when testing the condition.</li>
</ul>
</dd>
<dt><tt class="docutils literal">profile_tag</tt></dt>
<dd><p class="first">Matches the <tt class="docutils literal">profile_tag</tt> of the device that the notification would be
delivered to. Parameters:</p>
<ul class="last simple">
<li><tt class="docutils literal">profile_tag</tt>: The profile_tag to match with.</li>
</ul>
</dd>
<dt><tt class="docutils literal">contains_display_name</tt></dt>
<dd>This matches unencrypted messages where <tt class="docutils literal">content.body</tt> contains the owner's
display name in that room. This is a separate rule because display names may
change and as such it would be hard to maintain a rule that matched the user's
display name. This condition has no parameters.</dd>
<dt><tt class="docutils literal">room_member_count</tt></dt>
<dd><p class="first">This matches the current number of members in the room. Parameters:</p>
<ul class="last simple">
<li><tt class="docutils literal">is</tt>: A decimal integer optionally prefixed by one of, <tt class="docutils literal">==</tt>, <tt class="docutils literal">&lt;</tt>,
<tt class="docutils literal">&gt;</tt>, <tt class="docutils literal">&gt;=</tt> or <tt class="docutils literal">&lt;=</tt>. A prefix of <tt class="docutils literal">&lt;</tt> matches rooms where the member
count is strictly less than the given number and so forth. If no prefix is
present, this parameter defaults to <tt class="docutils literal">==</tt>.</li>
</ul>
</dd>
</dl>
</div>
</div>
<p><a class="anchor" id="push-rules-api"></a></p>
<div class="section" id="push-rules-api">
<h4><a class="toc-backref" href="#id254">5.10.1.3&nbsp;&nbsp;&nbsp;Push Rules: API</a></h4>
<p>Clients can retrieve, add, modify and remove push rules globally or per-device
using the APIs below.</p>
<p><a class="anchor" id="get-matrix-client-api-v1-pushrules"></a></p>
<div class="section" id="get-matrix-client-api-v1-pushrules">
<h5><a class="toc-backref" href="#id255">5.10.1.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/pushrules/</tt></a></h5>
<p>Retrieve all push rulesets for this user. Clients can &quot;drill-down&quot; on the
rulesets by suffixing a <tt class="docutils literal">scope</tt> to this path e.g. <tt class="docutils literal">/pushrules/global/</tt>. This
will return a subset of this data under the specified key e.g. the <tt class="docutils literal">global</tt>
key.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<p><cite>No parameters</cite></p>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="28%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>device</td>
<td>{$PROFILE_TAG: Ruleset}</td>
<td>A dictionary of profile tags to rulesets.</td>
</tr>
<tr><td>global</td>
<td>{Ruleset}</td>
<td>The global ruleset.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Ruleset</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>content</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>override</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>room</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>sender</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
<tr><td>underride</td>
<td>[PushRule]</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">PushRule</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="23%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>actions</td>
<td>[object or string]</td>
<td>&nbsp;</td>
</tr>
<tr><td>default</td>
<td>boolean</td>
<td>&nbsp;</td>
</tr>
<tr><td>enabled</td>
<td>boolean</td>
<td>&nbsp;</td>
</tr>
<tr><td>rule_id</td>
<td>string</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/pushrules/</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>All the push rulesets for this user.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;device&quot;</span><span class="punctuation">:</span> <span class="punctuation">{},</span>
  <span class="name tag">&quot;global&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
              <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
                  <span class="punctuation">},</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;alice&quot;</span><span class="punctuation">,</span>
              <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.contains_user_name&quot;</span>
          <span class="punctuation">}</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;override&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
              <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="literal string double">&quot;dont_notify&quot;</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[],</span>
              <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span><span class="punctuation">,</span>
              <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.master&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
              <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="literal string double">&quot;dont_notify&quot;</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;content.msgtype&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.notice&quot;</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.suppress_notices&quot;</span>
          <span class="punctuation">}</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;room&quot;</span><span class="punctuation">:</span> <span class="punctuation">[],</span>
      <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="punctuation">[],</span>
      <span class="name tag">&quot;underride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
          <span class="punctuation">{</span>
              <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ring&quot;</span>
                  <span class="punctuation">},</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.call.invite&quot;</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.call&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
              <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
                  <span class="punctuation">},</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;contains_display_name&quot;</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.contains_display_name&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
              <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
                  <span class="punctuation">},</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;is&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;2&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;room_member_count&quot;</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.room_one_to_one&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
              <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;sound&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;default&quot;</span>
                  <span class="punctuation">},</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span>
                  <span class="punctuation">},</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;content.membership&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;invite&quot;</span>
                  <span class="punctuation">},</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;state_key&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.invite_for_me&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
              <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.member&quot;</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.member_event&quot;</span>
          <span class="punctuation">},</span>
          <span class="punctuation">{</span>
              <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="literal string double">&quot;notify&quot;</span><span class="punctuation">,</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;set_tweak&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;highlight&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword constant">false</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;conditions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                  <span class="punctuation">{</span>
                      <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;type&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;event_match&quot;</span><span class="punctuation">,</span>
                      <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span>
                  <span class="punctuation">}</span>
              <span class="punctuation">],</span>
              <span class="name tag">&quot;default&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span><span class="punctuation">,</span>
              <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;.m.rule.message&quot;</span>
          <span class="punctuation">}</span>
      <span class="punctuation">]</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-api-v1-pushrules-scope-kind-ruleid"></a></p>
<div class="section" id="put-matrix-client-api-v1-pushrules-scope-kind-ruleid">
<h5><a class="toc-backref" href="#id256">5.10.1.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></h5>
<p>This endpoint allows the creation, modification and deletion of pushers for this
user ID. The behaviour of this endpoint varies depending on the values in the
JSON body.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="16%" />
<col width="62%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> Either <tt class="docutils literal">global</tt> or
<tt class="docutils literal"><span class="pre">device/&lt;profile_tag&gt;</span></tt> to specify global rules
or device rules for the given <tt class="docutils literal">profile_tag</tt>.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>conditions</td>
<td>array[object]</td>
<td>The conditions that must hold true for an event in
order for a rule to be applied to an event. A rule
with no conditions always matches.</td>
</tr>
<tr><td>conditions[0].kind</td>
<td>enum</td>
<td>One of: [&quot;event_match&quot;, &quot;profile_tag&quot;,
&quot;contains_display_name&quot;, &quot;room_member_count&quot;]</td>
</tr>
<tr><td>actions</td>
<td>array[string]</td>
<td><strong>Required.</strong> The action(s) to perform when the
conditions for this rule are met.</td>
</tr>
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>before</td>
<td>string</td>
<td>Use 'before' with a <tt class="docutils literal">rule_id</tt> as its value to
make the new rule the next-most important rule
with respect to the given rule.</td>
</tr>
<tr><td>after</td>
<td>string</td>
<td>This makes the new rule the next-less important
rule relative to the given rule.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/api/v1/pushrules/global/room/%23spam%3Aexample.com?before=someRuleId&amp;after=anotherRuleId</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;cake*lie&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="literal string double">&quot;notify&quot;</span><span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The pusher was set.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 400:</strong></p>
<p>There was a problem configuring this push rule.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;before/after rule not found: someRuleId&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_UNKNOWN&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-client-api-v1-pushrules-scope-kind-ruleid"></a></p>
<div class="section" id="get-matrix-client-api-v1-pushrules-scope-kind-ruleid">
<h5><a class="toc-backref" href="#id257">5.10.1.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/client/api/v1/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></h5>
<p>Retrieve a single specified push rule.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> Either <tt class="docutils literal">global</tt> or
<tt class="docutils literal"><span class="pre">device/&lt;profile_tag&gt;</span></tt> to specify global rules
or device rules for the given <tt class="docutils literal">profile_tag</tt>.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/pushrules/global/room/%23spam%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The specific push rule. This will also include keys specific to the
rule itself such as the rule's <tt class="docutils literal">actions</tt> and <tt class="docutils literal">conditions</tt> if set.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
      <span class="literal string double">&quot;dont_notify&quot;</span>
  <span class="punctuation">],</span>
  <span class="name tag">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#spam:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="delete-matrix-client-api-v1-pushrules-scope-kind-ruleid"></a></p>
<div class="section" id="delete-matrix-client-api-v1-pushrules-scope-kind-ruleid">
<h5><a class="toc-backref" href="#id258">5.10.1.3.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">DELETE <span class="pre">/_matrix/client/api/v1/pushrules/{scope}/{kind}/{ruleId}</span></tt></a></h5>
<p>This endpoint removes the push rule defined in the path.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> Either <tt class="docutils literal">global</tt> or
<tt class="docutils literal"><span class="pre">device/&lt;profile_tag&gt;</span></tt> to specify global rules
or device rules for the given <tt class="docutils literal">profile_tag</tt>.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">DELETE</span> <span class="name namespace">/_matrix/client/api/v1/pushrules/global/room/%23spam%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The push rule was deleted.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="put-matrix-client-api-v1-pushrules-scope-kind-ruleid-enabled"></a></p>
<div class="section" id="put-matrix-client-api-v1-pushrules-scope-kind-ruleid-enabled">
<h5><a class="toc-backref" href="#id259">5.10.1.3.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/_matrix/client/api/v1/pushrules/{scope}/{kind}/{ruleId}/enabled</span></tt></a></h5>
<p>This endpoint allows clients to enable or disable the specified push rule.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>body parameters</em></td>
</tr>
<tr><td>&lt;body&gt;</td>
<td>boolean</td>
<td><strong>Required.</strong> Whether the push rule is enabled or
not.</td>
</tr>
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>scope</td>
<td>string</td>
<td><strong>Required.</strong> Either <tt class="docutils literal">global</tt> or
<tt class="docutils literal"><span class="pre">device/&lt;profile_tag&gt;</span></tt> to specify global rules
or device rules for the given <tt class="docutils literal">profile_tag</tt>.</td>
</tr>
<tr><td>kind</td>
<td>enum</td>
<td><strong>Required.</strong> The kind of rule  One of:
[&quot;override&quot;, &quot;underride&quot;, &quot;sender&quot;, &quot;room&quot;,
&quot;content&quot;]</td>
</tr>
<tr><td>ruleId</td>
<td>string</td>
<td><strong>Required.</strong> The identifier for the rule.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/_matrix/client/api/v1/pushrules/global/room/%23spam%3Aexample.com/enabled</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="keyword constant">true</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The push rule was enabled or disabled.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="examples"></a></p>
<div class="section" id="examples">
<h5><a class="toc-backref" href="#id260">5.10.1.3.6&nbsp;&nbsp;&nbsp;Examples</a></h5>
<p>To create a rule that suppresses notifications for the room with ID
<tt class="docutils literal">!dj234r78wl45Gh4D:matrix.org</tt>:</p>
<pre class="literal-block">
curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/api/v1/pushrules/global/room/%21dj234r78wl45Gh4D%3Amatrix.org?access_token=123456&quot; -d \
'{
   &quot;actions&quot; : [&quot;dont_notify&quot;]
 }'
</pre>
<p>To suppress notifications for the user <tt class="docutils literal">&#64;spambot:matrix.org</tt>:</p>
<pre class="literal-block">
curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/api/v1/pushrules/global/sender/%40spambot%3Amatrix.org?access_token=123456&quot; -d \
'{
   &quot;actions&quot; : [&quot;dont_notify&quot;]
 }'
</pre>
<p>To always notify for messages that contain the work 'cake' and set a specific
sound (with a rule_id of <tt class="docutils literal">SSByZWFsbHkgbGlrZSBjYWtl</tt>):</p>
<pre class="literal-block">
curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/api/v1/pushrules/global/content/SSByZWFsbHkgbGlrZSBjYWtl?access_token=123456&quot; -d \
'{
   &quot;pattern&quot;: &quot;cake&quot;,
   &quot;actions&quot; : [&quot;notify&quot;, {&quot;set_sound&quot;:&quot;cakealarm.wav&quot;}]
 }'
</pre>
<p>To add a rule suppressing notifications for messages starting with 'cake' but
ending with 'lie', superseding the previous rule:</p>
<pre class="literal-block">
curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/api/v1/pushrules/global/content/U3BvbmdlIGNha2UgaXMgYmVzdA?access_token=123456&amp;before=SSByZWFsbHkgbGlrZSBjYWtl&quot; -d \
'{
   &quot;pattern&quot;: &quot;cake*lie&quot;,
   &quot;actions&quot; : [&quot;notify&quot;]
 }'
</pre>
<p>To add a custom sound for notifications messages containing the word 'beer' in
any rooms with 10 members or fewer (with greater importance than the room,
sender and content rules):</p>
<pre class="literal-block">
curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/api/v1/pushrules/global/override/U2VlIHlvdSBpbiBUaGUgRHVrZQ?access_token=123456&quot; -d \
'{
   &quot;conditions&quot;: [
     {&quot;kind&quot;: &quot;event_match&quot;, &quot;key&quot;: &quot;content.body&quot;, &quot;pattern&quot;: &quot;beer&quot; },
     {&quot;kind&quot;: &quot;room_member_count&quot;, &quot;is&quot;: &quot;&lt;=10&quot;}
   ],
   &quot;actions&quot; : [
     &quot;notify&quot;,
     {&quot;set_sound&quot;:&quot;beeroclock.wav&quot;}
   ]
 }'
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="id37"></a></p>
<div class="section" id="id37">
<h3><a class="toc-backref" href="#id261">5.10.2&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>This describes the format used by &quot;HTTP&quot; pushers to send notifications of
events to Push Gateways. If the endpoint returns an HTTP error code, the
homeserver SHOULD retry for a reasonable amount of time using exponential-backoff.</p>
<p><a class="anchor" id="post-matrix-push-v1-notify"></a></p>
<div class="section" id="post-matrix-push-v1-notify">
<h4><a class="toc-backref" href="#id262">5.10.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/push/v1/notify</tt></a></h4>
<p>This endpoint is invoked by HTTP pushers to notify a push gateway about an
event. <em>NB: Notifications are sent to the URL configured when the pusher is
created. This means that the HTTP path may be different depending on the push
gateway.</em></p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="15%" />
<col width="52%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>notification</td>
<td>object</td>
<td><strong>Required.</strong> Information about the push
notification</td>
</tr>
<tr><td>notification.content</td>
<td>{EventContent}</td>
<td>The <tt class="docutils literal">content</tt> field from the event, if present.
If the event had no content field, this field is
omitted.</td>
</tr>
<tr><td>notification.id</td>
<td>string</td>
<td><strong>Required.</strong> An identifier for this notification
that may be used to detect duplicate notification
requests. This is not necessarily the ID of the
event that triggered the notification.</td>
</tr>
<tr><td>notification.prio</td>
<td>enum</td>
<td>The priority of the notification. If omitted,
<tt class="docutils literal">high</tt> is assumed. This may be used by push
gateways to deliver less time-sensitive
notifications in a way that will preserve battery
power on mobile devices. One of: [&quot;high&quot;, &quot;low&quot;]</td>
</tr>
<tr><td>notification.room_alias</td>
<td>string</td>
<td>An alias to display for the room in which the
event occurred.</td>
</tr>
<tr><td>notification.room_id</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the room in which this
event occurred.</td>
</tr>
<tr><td>notification.room_name</td>
<td>string</td>
<td>The name of the room in which the event occurred.</td>
</tr>
<tr><td>notification.sender</td>
<td>string</td>
<td><strong>Required.</strong> The sender of the event as in the
corresponding event field.</td>
</tr>
<tr><td>notification.sender_display_name</td>
<td>string</td>
<td>The current display name of the sender in the room
in which the event occurred.</td>
</tr>
<tr><td>notification.type</td>
<td>string</td>
<td><strong>Required.</strong> The type of the event as in the
event's <tt class="docutils literal">type</tt> field.</td>
</tr>
<tr><td>notification.user_is_target</td>
<td>boolean</td>
<td>This is true if the user receiving the
notification is the subject of a member event
(i.e. the <tt class="docutils literal">state_key</tt> of the member event is
equal to the user's Matrix ID).</td>
</tr>
<tr><td>counts</td>
<td>object</td>
<td><strong>Required.</strong> This is a dictionary of the current
number of unacknowledged communications for the
recipient user. Counts whose value is zero are
omitted.</td>
</tr>
<tr><td>counts.missed_calls</td>
<td>integer</td>
<td>The number of unacknowledged missed calls a user
has across all rooms of which they are a member.</td>
</tr>
<tr><td>counts.unread</td>
<td>integer</td>
<td>The number of unread messages a user has across
all of the rooms they are a member of.</td>
</tr>
<tr><td>devices</td>
<td>array[object]</td>
<td><strong>Required.</strong> This is an array of devices that the
notification should be sent to.</td>
</tr>
<tr><td>devices[0].app_id</td>
<td>string</td>
<td>The app_id given when the pusher was created.</td>
</tr>
<tr><td>devices[0].data</td>
<td>{PusherData}</td>
<td>A dictionary of additional pusher-specific data.
For 'http' pushers, this is the data dictionary
passed in at pusher creation minus the <tt class="docutils literal">url</tt>
key.</td>
</tr>
<tr><td>devices[0].pushkey</td>
<td>string</td>
<td>The pushkey given when the pusher was created.</td>
</tr>
<tr><td>devices[0].pushkey_ts</td>
<td>integer</td>
<td>The unix timestamp (in seconds) when the pushkey
was last updated.</td>
</tr>
<tr><td>devices[0].tweaks</td>
<td>{Tweaks}</td>
<td>A dictionary of customisations made to the way
this notification is to be presented. These are
added by push rules.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>rejected</td>
<td>[string]</td>
<td>A list of all pushkeys given in the notification
request that are not valid. These could have been
rejected by an upstream gateway because they have
expired or have never been valid. Homeservers must
cease sending notification requests for these
pushkeys and remove the associated pushers. It may
not necessarily be the notification in the request
that failed: it could be that a previous
notification to the same pushkey failed.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/push/v1/notify</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;notification&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$3957tyerfgewrf384&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!slw48wfj34rtnrf:example.com&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;exampleuser:matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender_display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Major Tom&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Mission Control&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_alias&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;#exampleroom:matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;prio&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;high&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;I'm floating in a most peculiar way.&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;counts&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
     <span class="name tag">&quot;unread&quot;</span> <span class="punctuation">:</span> <span class="literal number integer">2</span><span class="punctuation">,</span>
     <span class="name tag">&quot;missed_calls&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span>
  <span class="punctuation">},</span>
  <span class="name tag">&quot;devices&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
       <span class="name tag">&quot;app_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;org.matrix.matrixConsole.ios&quot;</span><span class="punctuation">,</span>
       <span class="name tag">&quot;pushkey&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;V2h5IG9uIGVhcnRoIGRpZCB5b3UgZGVjb2RlIHRoaXM/&quot;</span><span class="punctuation">,</span>
       <span class="name tag">&quot;pushkey_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">12345678</span><span class="punctuation">,</span>
       <span class="name tag">&quot;data&quot;</span> <span class="punctuation">:</span> <span class="punctuation">{},</span>
       <span class="name tag">&quot;tweaks&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
         <span class="name tag">&quot;sound&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;bing&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>A list of rejected push keys.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;rejected&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="literal string double">&quot;V2h5IG9uIGVhcnRoIGRpZCB5b3UgZGVjb2RlIHRoaXM/&quot;</span> <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="push-gateway-behaviour"></a></p>
<div class="section" id="push-gateway-behaviour">
<h3><a class="toc-backref" href="#id263">5.10.3&nbsp;&nbsp;&nbsp;Push Gateway behaviour</a></h3>
<p><a class="anchor" id="recommendations-for-apns"></a></p>
<div class="section" id="recommendations-for-apns">
<h4><a class="toc-backref" href="#id264">5.10.3.1&nbsp;&nbsp;&nbsp;Recommendations for APNS</a></h4>
<p>The exact format for sending APNS notifications is flexible and up to the
client app and its' push gateway to agree on. As APNS requires that the sender
has a private key owned by the app developer, each app must have its own push
gateway. It is recommended that:</p>
<ul class="simple">
<li>The APNS token be base64 encoded and used as the pushkey.</li>
<li>A different app_id be used for apps on the production and sandbox
APS environments.</li>
<li>APNS push gateways do not attempt to wait for errors from the APNS
gateway before returning and instead to store failures and return
'rejected' responses next time that pushkey is used.</li>
</ul>
</div>
</div>
<p><a class="anchor" id="id38"></a></p>
<div class="section" id="id38">
<h3><a class="toc-backref" href="#id265">5.10.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Clients specify the Push Gateway URL to use to send event notifications to. This
URL should be over HTTPS and <em>never</em> over HTTP.</p>
<p>As push notifications will pass through a Push Provider, message content
shouldn't be sent in the push itself where possible. Instead, Push Gateways
should send a &quot;sync&quot; command to instruct the client to get new events from the
homeserver directly.</p>
</div>
</div>
<p><a class="anchor" id="third-party-invites"></a></p>
<div class="section" id="third-party-invites">
<h2><a class="toc-backref" href="#id266">5.11&nbsp;&nbsp;&nbsp;Third party invites</a></h2>
<p id="module-third-party-invites">This module adds in support for inviting new members to a room where their
Matrix user ID is not known, instead addressing them by a third party identifier
such as an email address.
There are two flows here; one if a Matrix user ID is known for the third party
identifier, and one if not. Either way, the client calls <tt class="docutils literal">/invite</tt> with the
details of the third party identifier.</p>
<p>The homeserver asks the identity server whether a Matrix user ID is known for
that identifier:</p>
<ul class="simple">
<li>If it is, an invite is simply issued for that user.</li>
<li>If it is not, the homeserver asks the identity server to record the details of
the invitation, and to notify the invitee's homeserver of this pending invitation if it gets
a binding for this identifier in the future. The identity server returns a token
and public key to the inviting homeserver.</li>
</ul>
<p>When the invitee's homeserver receives the notification of the binding, it
should insert an <tt class="docutils literal">m.room.member</tt> event into the room's graph for that user,
with <tt class="docutils literal">content.membership</tt> = <tt class="docutils literal">invite</tt>, as well as a
<tt class="docutils literal">content.third_party_invite</tt> property which contains proof that the invitee
does indeed own that third party identifier.</p>
<p><a class="anchor" id="id39"></a></p>
<div class="section" id="id39">
<h3><a class="toc-backref" href="#id267">5.11.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-room-third-party-invite"></a></p>
<div class="section" id="m-room-third-party-invite">
<h4><a class="toc-backref" href="#id268">5.11.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.third_party_invite</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: The token, of which a signature must be produced in order to join the room.</dd>
</dl>
<p>Acts as an <tt class="docutils literal">m.room.member</tt> invite event, where there isn't a target user_id to
invite. This event contains a token and a public key whose private key must be
used to sign the token. Any user who can present that signature may use this
invitation to join the target room.</p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="13%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>display_name</td>
<td>string</td>
<td>A user-readable string which represents the user
who has been invited. This should not contain the
user's third party ID, as otherwise when the
invite is accepted it would leak the association
between the matrix ID and the third party ID.</td>
</tr>
<tr><td>key_validity_url</td>
<td>string</td>
<td>A URL which can be fetched, with querystring
public_key=public_key, to validate whether the key
has been revoked. The URL must return a JSON
object containing a boolean property named
'valid'.</td>
</tr>
<tr><td>public_key</td>
<td>string</td>
<td>A base64-encoded ed25519 key with which token must
be signed.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242352</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;display_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Alice Margatroid&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;key_validity_url&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;https://magic.forest/verifykey&quot;</span><span class="punctuation">,</span>
        <span class="name tag">&quot;public_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abc123&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEF:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217939</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24t:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;pc98&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.third_party_invite&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id40"></a></p>
<div class="section" id="id40">
<h3><a class="toc-backref" href="#id269">5.11.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>A client asks a server to invite a user by their third party identifier.</p>
<p><a class="anchor" id="id41"></a></p>
<div class="section" id="id41">
<h4><a class="toc-backref" href="#id270">5.11.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST <span class="pre">/_matrix/client/api/v1/rooms/{roomId}/invite</span></tt></a></h4>
<p id="invite-by-third-party-id-endpoint"><em>Note that there are two forms of this API, which are documented separately.
This version of the API does not require that the inviter know the Matrix
identifier of the invitee, and instead relies on third party identifiers. The
homeserver uses an identity server to perform the mapping from third party
identifier to a Matrix identifier. The other is documented in the</em> <a class="reference internal" href="#invite-by-user-id-endpoint">joining
rooms section</a>.</p>
<p>This API invites a user to participate in a particular room. They do not start
participating in the room until they actually join the room.</p>
<p>Only users currently in a particular room can invite other users to join that
room.</p>
<p>If the identity server did know the Matrix user identifier for the third party
identifier, the home server will append a <tt class="docutils literal">m.room.member</tt> event to the room.</p>
<p>If the identity server does not know a Matrix user identifier for the passed
third party identifier, the homeserver will issue an invitation which can be
accepted upon providing proof of ownership of the third party identifier. This
is achieved by the identity server generating a token, which it gives to the
inviting homeserver. The homeserver will add an <tt class="docutils literal">m.room.third_party_invite</tt>
event into the graph for the room, containing that token.</p>
<p>When the invitee binds the invited third party identifier to a Matrix user ID,
the identity server will give the user a list of pending invitations, each
containing:</p>
<ul class="simple">
<li>The room ID to which they were invited</li>
<li>The token given to the homeserver</li>
<li>A signature of the token, signed with the identity server's private key</li>
<li>The matrix user ID who invited them to the room</li>
</ul>
<p>If a token is requested from the identity server, the home server will append a
<tt class="docutils literal">m.room.third_party_invite</tt> event to the room.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomId</td>
<td>string</td>
<td><strong>Required.</strong> The room identifier (not alias) to
which to invite the user.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>id_server</td>
<td>string</td>
<td><strong>Required.</strong> The hostname+port of the identity
server which should be used for third party
identifier lookups.</td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The kind of address being passed in
the address field, for example <tt class="docutils literal">email</tt>.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The invitee's third party
identifier.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/rooms/%21d41d8cd%3Amatrix.org/invite</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;id_server&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;cheeky&#64;monkey.com&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The user has been invited to join the room.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>You do not have permission to invite the user to the room. A meaningful <tt class="docutils literal">errcode</tt> and description error text will be returned. Example reasons for rejections are:</p>
<ul class="simple">
<li>The invitee has been banned from the room.</li>
<li>The invitee is already a member of the room.</li>
<li>The inviter is not currently in the room.</li>
<li>The inviter's power level is insufficient to invite users to the room.</li>
</ul>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span><span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span><span class="punctuation">,</span> <span class="name tag">&quot;error&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;cheeky_monkey:matrix.org is banned from the room&quot;</span><span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id42"></a></p>
<div class="section" id="id42">
<h3><a class="toc-backref" href="#id271">5.11.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>All homeservers MUST verify the signature in the event's
<tt class="docutils literal">content.third_party_invite.signed</tt> object.</p>
<p>When a homeserver inserts an <tt class="docutils literal">m.room.member</tt> <tt class="docutils literal">invite</tt> event into the graph
because of an <tt class="docutils literal">m.room.third_party_invite</tt> event,
that homesever MUST validate that the public
key used for signing is still valid, by checking <tt class="docutils literal">key_validity_url</tt> from the <tt class="docutils literal">m.room.third_party_invite</tt>. It does
this by making an HTTP GET request to <tt class="docutils literal">key_validity_url</tt>:</p>
<!-- TODO: Link to identity server spec when it exists -->
<p>Schema:</p>
<pre class="literal-block">
=&gt; GET $key_validity_url?public_key=$public_key
&lt;= HTTP/1.1 200 OK
{
    &quot;valid&quot;: true|false
}
</pre>
<p>Example:</p>
<pre class="literal-block">
key_validity_url = https://identity.server/is_valid
public_key = ALJWLAFQfqffQHFqFfeqFUOEHf4AIHfefh4
=&gt; GET https://identity.server/is_valid?public_key=ALJWLAFQfqffQHFqFfeqFUOEHf4AIHfefh4
&lt;= HTTP/1.1 200 OK
{
    &quot;valid&quot;: true
}
</pre>
<p>with the querystring
?public_key=``public_key``. A JSON object will be returned.
The invitation is valid if the object contains a key named <tt class="docutils literal">valid</tt> which is
<tt class="docutils literal">true</tt>. Otherwise, the invitation MUST be rejected. This request is
idempotent and may be retried by the homeserver.</p>
<p>If a homeserver is joining a room for the first time because of an
<tt class="docutils literal">m.room.third_party_invite</tt>, the server which is already participating in the
room (which is chosen as per the standard server-server specification) MUST
validate that the public key used for signing is still valid, by checking
<tt class="docutils literal">key_validity_url</tt> in the above described way.</p>
<p>No other homeservers may reject the joining of the room on the basis of
<tt class="docutils literal">key_validity_url</tt>, this is so that all homeservers have a consistent view of
the room. They may, however, indicate to their clients that a member's'
membership is questionable.</p>
<p>For example:</p>
<ol class="arabic simple">
<li>Room R has two participating homeservers, H1, H2</li>
<li>User A on H1 invites a third party identifier to room R</li>
<li>H1 asks the identity server for a binding to a Matrix user ID, and has none,
so issues an <tt class="docutils literal">m.room.third_party_invite</tt> event to the room.</li>
<li>When the third party user validates their identity, their homeserver H3
is notified and attempts to issue an <tt class="docutils literal">m.room.member</tt> event to participate
in the room.</li>
<li>H3 validates the signature given to it by the identity server.</li>
<li>H3 then asks H1 to join it to the room. H1 <em>must</em> validate the <tt class="docutils literal">signed</tt>
property <em>and</em> check <tt class="docutils literal">key_validity_url</tt>.</li>
<li>Having validated these things, H1 writes the invite event to the room, and H3
begins participating in the room. H2 <em>must</em> accept this event.</li>
</ol>
<p>The reason that no other homeserver may reject the event based on checking
<tt class="docutils literal">key_validity_url</tt> is that we must ensure event acceptance is deterministic.
If some other participating server doesn't have a network path to the keyserver,
or if the keyserver were to go offline, or revoke its keys, that other server
would reject the event and cause the participating servers' graphs to diverge.
This relies on participating servers trusting each other, but that trust is
already implied by the server-server protocol. Also, the public key signature
verification must still be performed, so the attack surface here is minimized.</p>
</div>
<p><a class="anchor" id="id43"></a></p>
<div class="section" id="id43">
<h3><a class="toc-backref" href="#id272">5.11.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>There are a number of privary and trust implications to this module.</p>
<p>It is important for user privacy that leaking the mapping between a matrix user
ID and a third party identifier is hard. In particular, being able to look up
all third party identifiers from a matrix user ID (and accordingly, being able
to link each third party identifier) should be avoided wherever possible.
To this end, the third party identifier is not put in any event, rather an
opaque display name provided by the identity server is put into the events.
Clients should not remember or display third party identifiers from invites,
other than for the use of the inviter themself.</p>
<p>Homeservers are not required to trust any particular identity server(s). It is
generally a client's responsibility to decide which identity servers it trusts,
not a homeserver's. Accordingly, this API takes identity servers as input from
end users, and doesn't have any specific trusted set. It is possible some
homeservers may want to supply defaults, or reject some identity servers for
<em>its</em> users, but no homeserver is allowed to dictate which identity servers
<em>other</em> homeservers' users trust.</p>
<p>There is some risk of denial of service attacks by flooding homeservers or
identity servers with many requests, or much state to store. Defending against
these is left to the implementer's discretion.</p>
</div>
</div>
<p><a class="anchor" id="id44"></a></p>
<div class="section" id="id44">
<h2><a class="toc-backref" href="#id273">5.12&nbsp;&nbsp;&nbsp;Server Side Search</a></h2>
<p id="module-search">The search API allows clients to perform full text search across events in all
rooms that the user has been in, including those that they have left. Only
events that the user is allowed to see will be searched, e.g. it won't include
events in rooms that happened after you left.</p>
<p><a class="anchor" id="id45"></a></p>
<div class="section" id="id45">
<h3><a class="toc-backref" href="#id274">5.12.1&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p><a class="anchor" id="post-matrix-client-api-v1-search"></a></p>
<div class="section" id="post-matrix-client-api-v1-search">
<h4><a class="toc-backref" href="#id275">5.12.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">POST /_matrix/client/api/v1/search</tt></a></h4>
<p>Performs a full text search across different categories.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Rate-limited:</th><td class="field-body">Yes.</td>
</tr>
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="39%" />
<col width="13%" />
<col width="48%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>search_categories</td>
<td>object</td>
<td><strong>Required.</strong> Describes which categories to search
in and their criteria.</td>
</tr>
<tr><td>search_categories.room_events</td>
<td>{Room Events}</td>
<td>Mapping of category name to search criteria.</td>
</tr>
<tr><td>search_categories.room_events.filter</td>
<td>{Filter}</td>
<td>The filter to apply to search results. This has
the same format as v2 filter API.</td>
</tr>
<tr><td>search_categories.room_events.keys</td>
<td>[enum]</td>
<td>The keys to search. Defaults to all. One of:
[&quot;content.body&quot;, &quot;content.name&quot;, &quot;content.topic&quot;]</td>
</tr>
<tr><td>search_categories.room_events.search_term</td>
<td>string</td>
<td><strong>Required.</strong> The string to search events for</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<p><tt class="docutils literal">Results</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="15%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>search_categories</td>
<td>{Categories}</td>
<td>Describes which categories to search in and their
criteria.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Categories</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="25%" />
<col width="62%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_events</td>
<td>{Room Event Results}</td>
<td>Mapping of category name to search criteria.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Room Event Results</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="21%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>count</td>
<td>number</td>
<td>Total number of results found</td>
</tr>
<tr><td>results</td>
<td>{string: Result}</td>
<td>Mapping of event_id to result.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Result</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>rank</td>
<td>number</td>
<td>A number that describes how closely this result
matches the search. Higher is closer.</td>
</tr>
<tr><td>result</td>
<td>{Event}</td>
<td>The event that matched.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Event</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>The globally unique event identifier.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>The ID of the room associated with this event.</td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td>Contains the fully-qualified ID of the user who
<em>sent</em> this event.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">POST</span> <span class="name namespace">/_matrix/client/api/v1/search</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;search_categories&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;room_events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;content.body&quot;</span>
      <span class="punctuation">],</span>
      <span class="name tag">&quot;search_term&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;martians and men&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>Results of the search.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
   <span class="name tag">&quot;search_categories&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
     <span class="name tag">&quot;room_events&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
       <span class="name tag">&quot;count&quot;</span><span class="punctuation">:</span> <span class="literal number integer">24</span><span class="punctuation">,</span>
       <span class="name tag">&quot;results&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
         <span class="name tag">&quot;$144429830826TWwbB:localhost&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
           <span class="name tag">&quot;rank&quot;</span><span class="punctuation">:</span> <span class="literal number float">0.00424866</span><span class="punctuation">,</span>
           <span class="name tag">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
             <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">526228296</span><span class="punctuation">,</span>
             <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
               <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Test content&quot;</span><span class="punctuation">,</span>
               <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
             <span class="punctuation">},</span>
             <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$144429830826TWwbB:localhost&quot;</span><span class="punctuation">,</span>
             <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1444298308034</span><span class="punctuation">,</span>
             <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!qPewotXpIctQySfjSy:localhost&quot;</span><span class="punctuation">,</span>
             <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
             <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;test:localhost&quot;</span>
           <span class="punctuation">}</span>
         <span class="punctuation">}</span>
       <span class="punctuation">}</span>
     <span class="punctuation">}</span>
   <span class="punctuation">}</span>
 <span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="search-categories"></a></p>
<div class="section" id="search-categories">
<h3><a class="toc-backref" href="#id276">5.12.2&nbsp;&nbsp;&nbsp;Search Categories</a></h3>
<p>The search API allows clients to search in different categories of items.
Currently the only specified category is <tt class="docutils literal">room_events</tt>.</p>
<p><a class="anchor" id="id46"></a></p>
<div class="section" id="id46">
<h4><a class="toc-backref" href="#id277">5.12.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">room_events</tt></a></h4>
<p>This category covers all events that the user is allowed to see, including
events in rooms that they have left. The search is performed on certain keys of
certain event types.</p>
<p>The supported keys to search over are:</p>
<ul class="simple">
<li><tt class="docutils literal">content.body</tt> in <tt class="docutils literal">m.room.message</tt></li>
<li><tt class="docutils literal">content.name</tt> in <tt class="docutils literal">m.room.name</tt></li>
<li><tt class="docutils literal">content.topic</tt> in <tt class="docutils literal">m.room.topic</tt></li>
</ul>
<p>The search will <em>not</em> include rooms that are end to end encrypted.</p>
<p>The results include a <tt class="docutils literal">rank</tt> key that can be used to sort the results by
revelancy. The higher the <tt class="docutils literal">rank</tt> the more relevant the result is.</p>
<p>The value of <tt class="docutils literal">count</tt> may not match the number of results. For example due to
the search query matching 1000s of results and the server truncating the
response.</p>
</div>
</div>
<p><a class="anchor" id="id47"></a></p>
<div class="section" id="id47">
<h3><a class="toc-backref" href="#id278">5.12.3&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>The server must only return results that the user has permission to see.</p>
</div>
</div>
<p><a class="anchor" id="guest-access"></a></p>
<div class="section" id="guest-access">
<h2><a class="toc-backref" href="#id279">5.13&nbsp;&nbsp;&nbsp;Guest access</a></h2>
<p id="module-guest-access">There are times when it is desirable for clients to be able to interact with
rooms without having to fully register for an account on a homeserver or join
the room. This module specifies how these clients should interact with servers
in order to participate in rooms as guests.</p>
<p>Guest users retrieve access tokens from a homeserver using the ordinary
<a class="reference external" href="#post-matrix-client-api-v2-alpha-register">register endpoint</a>, specifying
the <tt class="docutils literal">kind</tt> parameter as <tt class="docutils literal">guest</tt>. They may then interact with the
client-server API as any other user would, but will only have access to a subset
of the API as described the Client behaviour subsection below.
Homeservers may choose not to allow this access at all to their local users, but
have no information about whether users on other homeservers are guests or not.</p>
<p>This module does not fully factor in federation; it relies on individual
homeservers properly adhering to the rules set out in this module, rather than
allowing all homeservers to enforce the rules on each other.</p>
<p><a class="anchor" id="id48"></a></p>
<div class="section" id="id48">
<h3><a class="toc-backref" href="#id280">5.13.1&nbsp;&nbsp;&nbsp;Events</a></h3>
<p><a class="anchor" id="m-room-guest-access"></a></p>
<div class="section" id="m-room-guest-access">
<h4><a class="toc-backref" href="#id281">5.13.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">m.room.guest_access</tt></a></h4>
<dl class="docutils">
<dt><em>State Event</em></dt>
<dd><tt class="docutils literal">state_key</tt>: A zero-length string.</dd>
</dl>
<p>This event controls whether guest users are allowed to join rooms. If this event
is absent, servers should act as if it is present and has the guest_access value
&quot;forbidden&quot;.</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="14%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Content Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>guest_access</td>
<td>enum</td>
<td>Whether guests can join the room. One of:
[&quot;can_join&quot;, &quot;forbidden&quot;]</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">242353</span><span class="punctuation">,</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;guest_access&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;can_join&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$WLGTSEFSEG:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1431961217938</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!Cuyf34gef24u:localhost&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.guest_access&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;example:localhost&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="id49"></a></p>
<div class="section" id="id49">
<h3><a class="toc-backref" href="#id282">5.13.2&nbsp;&nbsp;&nbsp;Client behaviour</a></h3>
<p>The following API endpoints are allowed to be accessed by guest accounts for
retrieving events:</p>
<ul class="simple">
<li><a class="reference external" href="#get-matrix-client-api-v1-rooms-roomid-state">GET /rooms/:room_id/state</a></li>
<li><a class="reference external" href="#get-matrix-client-api-v1-rooms-roomid-state-eventtype-statekey">GET /rooms/:room_id/state/:event_type/:state_key</a></li>
<li><a class="reference external" href="#get-matrix-client-api-v1-rooms-roomid-messages">GET /rooms/:room_id/messages</a></li>
<li><a class="reference external" href="#get-matrix-client-api-v1-rooms-roomid-initialsync">GET /rooms/:room_id/initialSync</a></li>
</ul>
<p>There is also a special version of the
<a class="reference external" href="#get-matrix-client-api-v1-events">GET /events</a> endpoint:</p>
<p><a class="anchor" id="id50"></a></p>
<div class="section" id="id50">
<h4><a class="toc-backref" href="#id283">5.13.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/client/api/v1/events</tt></a></h4>
<p>This will listen for new events related to a particular room and return them to
the caller. This will block until an event is received, or until the <tt class="docutils literal">timeout</tt>
is reached.</p>
<p>This API is the same as the non-guest /events endpoint, but can be called by
guest users.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Requires auth:</th><td class="field-body">Yes.</td>
</tr>
</tbody>
</table>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>from</td>
<td>string</td>
<td>The token to stream from. This token is either
from a previous request to this API or from the
initial sync API.</td>
</tr>
<tr><td>timeout</td>
<td>integer</td>
<td>The maximum time in milliseconds to wait for an
event.</td>
</tr>
<tr><td>room_id</td>
<td>array</td>
<td>The room IDs for which events should be returned.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>chunk</td>
<td>[Event]</td>
<td>An array of events.</td>
</tr>
<tr><td>end</td>
<td>string</td>
<td>A token which correlates to the last value in
<tt class="docutils literal">chunk</tt>. This token should be used in the next
request to <tt class="docutils literal">/events</tt>.</td>
</tr>
<tr><td>start</td>
<td>string</td>
<td>A token which correlates to the first value in
<tt class="docutils literal">chunk</tt>. This is usually the same token supplied
to <tt class="docutils literal">from=</tt>.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Event</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>event_id</td>
<td>string</td>
<td>The globally unique event identifier.</td>
</tr>
<tr><td>room_id</td>
<td>string</td>
<td>The ID of the room associated with this event.</td>
</tr>
<tr><td>user_id</td>
<td>string</td>
<td>Contains the fully-qualified ID of the user who
<em>sent</em> this event.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/client/api/v1/events?from=s3456_9_0&amp;timeout=35000&amp;room_id=%21somewhere%3Aover&amp;room_id=%21the%3Arainbow</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The events received, which may be none.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;start&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3456_9_0&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;end&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;s3457_9_0&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">32</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;incoming message&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14328055551tzaee:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432804485886</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:localhost&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p>They will only return events which happened while the room state had the
<tt class="docutils literal">m.room.history_visibility</tt> state event present with <tt class="docutils literal">history_visibility</tt>
value <tt class="docutils literal">world_readable</tt>. Guest clients do not need to join rooms in order to
receive events for them.</p>
<p>The following API endpoints are allowed to be accessed by guest accounts for
sending events:</p>
<ul class="simple">
<li><a class="reference external" href="#post-matrix-client-api-v1-rooms-roomid-join">POST /rooms/:room_id/join</a></li>
<li><a class="reference external" href="#put-matrix-client-api-v1-rooms-roomid-send-eventtype-txnid">PUT /rooms/:room_id/send/m.room.message/:txn_id</a></li>
</ul>
<p>Guest clients <em>do</em> need to join rooms in order to send events to them.</p>
<p>The following API endpoints are allowed to be accessed by guest accounts for
their own account maintenance:</p>
<ul class="simple">
<li><a class="reference external" href="#put-matrix-client-api-v1-profile-userid-displayname">PUT /profile/:user_id/displayname</a></li>
</ul>
</div>
</div>
<p><a class="anchor" id="id51"></a></p>
<div class="section" id="id51">
<h3><a class="toc-backref" href="#id284">5.13.3&nbsp;&nbsp;&nbsp;Server behaviour</a></h3>
<p>Servers are required to only return events to guest accounts for rooms where
the room state at the event had the  <tt class="docutils literal">m.room.history_visibility</tt> state event
present with <tt class="docutils literal">history_visibility</tt> value <tt class="docutils literal">world_readable</tt>. These events may
be returned even if the anonymous user is not joined to the room.</p>
<p>Servers MUST only allow guest users to join rooms if the <tt class="docutils literal">m.room.guest_access</tt>
state event is present on the room, and has the <tt class="docutils literal">guest_access</tt> value
<tt class="docutils literal">can_join</tt>. If the <tt class="docutils literal">m.room.guest_access</tt> event is changed to stop this from
being the case, the server MUST set those users' <tt class="docutils literal">m.room.member</tt> state to
<tt class="docutils literal">leave</tt>.</p>
</div>
<p><a class="anchor" id="id52"></a></p>
<div class="section" id="id52">
<h3><a class="toc-backref" href="#id285">5.13.4&nbsp;&nbsp;&nbsp;Security considerations</a></h3>
<p>Each homeserver manages its own guest accounts itself, and whether an account
is a guest account or not is not information passed from server to server.
Accordingly, any server participating in a room is trusted to properly enforce
the permissions outlined in this section.</p>
<p>Clients may wish to display to their users that rooms which are
<tt class="docutils literal">world_readable</tt> <em>may</em> be showing messages to non-joined users. There is no
way using this module to find out whether any non-joined guest users <em>do</em> see
events in the room, or to list or count any guest users.</p>
<p>Homeservers may want to enable protections such as captchas for guest
registration to prevent spam, denial of service, and similar attacks.</p>
</div>
</div>
</div>
<p><a class="anchor" id="application-service-api"></a></p>
<div class="section" id="application-service-api">
<h1><a class="toc-backref" href="#id286">6&nbsp;&nbsp;&nbsp;Application Service API</a></h1>
<p>The Matrix client-server API and server-server APIs provide the means to
implement a consistent self-contained federated messaging fabric. However, they
provide limited means of implementing custom server-side behaviour in Matrix
(e.g. gateways, filters, extensible hooks etc). The Application Service API (AS API)
defines a standard API to allow such extensible functionality to be implemented
irrespective of the underlying homeserver implementation.</p>
<!-- TODO-spec
Add in Client-Server services? Overview of bots? Seems weird to be in the spec
given it is VERY implementation specific. -->
<p><a class="anchor" id="application-services"></a></p>
<div class="section" id="application-services">
<h2><a class="toc-backref" href="#id287">6.1&nbsp;&nbsp;&nbsp;Application Services</a></h2>
<p>Application services are passive and can only observe events from a given
homeserver. They can inject events into rooms they are participating in.
They cannot prevent events from being sent, nor can they modify the content of
the event being sent. In order to observe events from a homeserver, the
homeserver needs to be configured to pass certain types of traffic to the
application service.  This is achieved by manually configuring the homeserver
with information about the application service (AS).</p>
<p><a class="anchor" id="registration"></a></p>
<div class="section" id="registration">
<h3><a class="toc-backref" href="#id288">6.1.1&nbsp;&nbsp;&nbsp;Registration</a></h3>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Previously, application services could register with a homeserver via HTTP
APIs. This was removed as it was seen as a security risk. A compromised
application service could re-register for a global <tt class="docutils literal">*</tt> regex and sniff
<em>all</em> traffic on the homeserver. To protect against this, application
services now have to register via configuration files which are linked to
the homeserver configuration file. The addition of configuration files
allows homeserver admins to sanity check the registration for suspicious
regex strings.</p>
</div>
<!-- TODO
Removing the API entirely is probably a mistake - having a standard cross-HS
way of doing this stops ASes being coupled to particular HS implementations.
A better solution would be to somehow mandate that the API done to avoid
abuse. -->
<p>Application services register &quot;namespaces&quot; of user IDs, room aliases and room IDs.
These namespaces are represented as regular expressions. An application service
is said to be &quot;interested&quot; in a given event if one of the IDs in the event match
the regular expression provided by the application service. An application
service can also state whether they should be the only ones who
can manage a specified namespace. This is referred to as an &quot;exclusive&quot;
namespace. An exclusive namespace prevents humans and other application
services from creating/deleting entities in that namespace. Typically,
exclusive namespaces are used when the rooms represent real rooms on
another service (e.g. IRC). Non-exclusive namespaces are used when the
application service is merely augmenting the room itself (e.g. providing
logging or searching facilities). Namespaces are represented by POSIX extended
regular expressions and look like:</p>
<pre class="code yaml literal-block">
<span class="literal scalar plain">users</span><span class="punctuation indicator">:</span>
  <span class="punctuation indicator">-</span> <span class="literal scalar plain">exclusive</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">true</span>
    <span class="literal scalar plain">regex</span><span class="punctuation indicator">:</span> <span class="error">&#64;</span><span class="literal scalar plain">irc.freenode.net_.*</span>
</pre>
<p>The registration is represented by a series of key-value pairs, which this
specification will present as YAML. An example HS configuration required to pass
traffic to the AS is:</p>
<pre class="code yaml literal-block">
<span class="literal scalar plain">url</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;base url of AS&gt;</span>
<span class="literal scalar plain">as_token</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;token AS will add to requests to HS&gt;</span>
<span class="literal scalar plain">hs_token</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;token HS will add to requests to AS&gt;</span>
<span class="literal scalar plain">sender_localpart</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;localpart of AS user&gt;</span>
<span class="literal scalar plain">namespaces</span><span class="punctuation indicator">:</span>
  <span class="literal scalar plain">users</span><span class="punctuation indicator">:</span>  <span class="comment single"># Namespaces of users which should be delegated to the AS</span>
    <span class="punctuation indicator">-</span> <span class="literal scalar plain">exclusive</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;bool&gt;</span>
      <span class="literal scalar plain">regex</span><span class="punctuation indicator">:</span> <span class="literal scalar plain">&lt;regex&gt;</span>
    <span class="punctuation indicator">-</span> <span class="literal scalar plain">...</span>
  <span class="literal scalar plain">aliases</span><span class="punctuation indicator">:</span> <span class="punctuation indicator">[]</span>  <span class="comment single"># Namespaces of room aliases which should be delegated to the AS</span>
  <span class="literal scalar plain">rooms</span><span class="punctuation indicator">:</span> <span class="punctuation indicator">[]</span> <span class="comment single"># Namespaces of room ids which should be delegated to the AS</span>
</pre>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">If the homeserver in question has multiple application services, each
<tt class="docutils literal">as_token</tt> MUST be unique per application service as this token is used to
identify the application service. The homeserver MUST enforce this.</p>
</div>
</div>
<p><a class="anchor" id="home-server-application-service-api"></a></p>
<div class="section" id="home-server-application-service-api">
<h3><a class="toc-backref" href="#id289">6.1.2&nbsp;&nbsp;&nbsp;Home Server -&gt; Application Service API</a></h3>
<p><a class="anchor" id="pushing-events"></a></p>
<div class="section" id="pushing-events">
<h4><a class="toc-backref" href="#id290">6.1.2.1&nbsp;&nbsp;&nbsp;Pushing events</a></h4>
<p>The application service API provides a transaction API for sending a list of
events. Each list of events includes a transaction ID, which works as follows:</p>
<pre class="literal-block">
Typical
HS ---&gt; AS : Home server sends events with transaction ID T.
   &lt;---    : AS sends back 200 OK.

AS ACK Lost
HS ---&gt; AS : Home server sends events with transaction ID T.
   &lt;-/-    : AS 200 OK is lost.
HS ---&gt; AS : Home server retries with the same transaction ID of T.
   &lt;---    : AS sends back 200 OK. If the AS had processed these events
             already, it can NO-OP this request (and it knows if it is the same
             events based on the transaction ID).
</pre>
<p>The events sent to the application service should be linearised, as if they were
from the event stream. The homeserver MUST maintain a queue of transactions to
send to the AS. If the application service cannot be reached, the homeserver
SHOULD backoff exponentially until the application service is reachable again.
As application services cannot <em>modify</em> the events in any way, these requests can
be made without blocking other aspects of the homeserver. Homeservers MUST NOT
alter (e.g. add more) events they were going to send within that transaction ID
on retries, as the AS may have already processed the events.</p>
</div>
<p><a class="anchor" id="querying"></a></p>
<div class="section" id="querying">
<h4><a class="toc-backref" href="#id291">6.1.2.2&nbsp;&nbsp;&nbsp;Querying</a></h4>
<p>The application service API includes two querying APIs: for room aliases and for
user IDs. The application service SHOULD create the queried entity if it desires.
During this process, the application service is blocking the homeserver until the
entity is created and configured. If the homeserver does not receive a response
to this request, the homeserver should retry several times before timing out. This
should result in an HTTP status 408 &quot;Request Timeout&quot; on the client which initiated
this request (e.g. to join a room alias).</p>
<div class="admonition-rationale admonition">
<p class="first admonition-title">Rationale</p>
<p class="last">Blocking the homeserver and expecting the application service to create the entity
using the client-server API is simpler and more flexible than alternative methods
such as returning an initial sync style JSON blob and get the HS to provision
the room/user. This also meant that there didn't need to be a &quot;backchannel&quot; to inform
the application service about information about the entity such as room ID to
room alias mappings.</p>
</div>
</div>
<p><a class="anchor" id="http-apis"></a></p>
<div class="section" id="http-apis">
<h4><a class="toc-backref" href="#id292">6.1.2.3&nbsp;&nbsp;&nbsp;HTTP APIs</a></h4>
<p>This contains application service APIs which are used by the home server. All
application services MUST implement these APIs. These APIs are defined below.</p>
<p><a class="anchor" id="get-rooms-roomalias"></a></p>
<div class="section" id="get-rooms-roomalias">
<h5><a class="toc-backref" href="#id293">6.1.2.3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/rooms/{roomAlias}</span></tt></a></h5>
<p>This endpoint is invoked by the homeserver on an application service to query
the existence of a given room alias. The homeserver will only query room aliases
inside the application service's <tt class="docutils literal">aliases</tt> namespace. The homeserver will send
this request when it receives a request to join a room alias within the
application service's namespace.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>roomAlias</td>
<td>string</td>
<td><strong>Required.</strong> The room alias being queried.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/rooms/%23magicforest%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The application service indicates that this room alias exists. The
application service MUST have created a room and associated it with
the queried room alias using the client-server API. Additional
information about the room such as its name and topic can be set
before responding.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The homeserver has not supplied credentials to the application service.
Optional error information can be included in the body of this response.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;COM.EXAMPLE.MYAPPSERVICE_UNAUTHORIZED&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The credentials supplied by the homeserver were rejected.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The application service indicates that this room alias does not exist.
Optional error information can be included in the body of this response.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;COM.EXAMPLE.MYAPPSERVICE_NOT_FOUND&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="put-transactions-txnid"></a></p>
<div class="section" id="put-transactions-txnid">
<h5><a class="toc-backref" href="#id294">6.1.2.3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">PUT <span class="pre">/transactions/{txnId}</span></tt></a></h5>
<p>This API is called by the HS when the HS wants to push an event (or batch of
events) to the AS.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="18%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>txnId</td>
<td>string</td>
<td><strong>Required.</strong> The transaction ID for this set of
events. Homeservers generate these IDs and they
are used to ensure idempotency of requests.</td>
</tr>
<tr><td colspan="3"><em>JSON body parameters</em></td>
</tr>
<tr><td>events</td>
<td>array[object]</td>
<td><strong>Required.</strong> A list of events</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">PUT</span> <span class="name namespace">/transactions/35</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
<span class="name attribute">Content-Type</span><span class="operator">:</span> <span class="literal">application/json</span>

<span class="punctuation">{</span>
  <span class="name tag">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">32</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;incoming message&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$14328055551tzaee:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432804485886</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:localhost&quot;</span>
    <span class="punctuation">},</span>
    <span class="punctuation">{</span>
      <span class="name tag">&quot;age&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1984</span><span class="punctuation">,</span>
      <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
          <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;another incoming message&quot;</span><span class="punctuation">,</span>
          <span class="name tag">&quot;msgtype&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.text&quot;</span>
      <span class="punctuation">},</span>
      <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$1228055551ffsef:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1432804485886</span><span class="punctuation">,</span>
      <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!TmaZBKYIFrIPVGoUYp:localhost&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
      <span class="name tag">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;bob:localhost&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The transaction was processed successfully.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
</div>
<p><a class="anchor" id="get-users-userid"></a></p>
<div class="section" id="get-users-userid">
<h5><a class="toc-backref" href="#id295">6.1.2.3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/users/{userId}</span></tt></a></h5>
<p>This endpoint is invoked by the homeserver on an application service to query
the existence of a given user ID. The homeserver will only query user IDs inside
the application service's <tt class="docutils literal">users</tt> namespace. The homeserver will send this
request when it receives an event for an unknown user ID in the application
service's namespace.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>userId</td>
<td>string</td>
<td><strong>Required.</strong> The user ID being queried.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/users/%40alice%3Aexample.com</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Responses:</p>
<p><strong>Status code 200:</strong></p>
<p>The application service indicates that this user exists. The application
service MUST create the user using the client-server API.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p><strong>Status code 401:</strong></p>
<p>The homeserver has not supplied credentials to the application service.
Optional error information can be included in the body of this response.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;COM.EXAMPLE.MYAPPSERVICE_UNAUTHORIZED&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 403:</strong></p>
<p>The credentials supplied by the homeserver were rejected.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;M_FORBIDDEN&quot;</span>
<span class="punctuation">}</span>
</pre>
<p><strong>Status code 404:</strong></p>
<p>The application service indicates that this user does not exist.
Optional error information can be included in the body of this response.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;COM.EXAMPLE.MYAPPSERVICE_NOT_FOUND&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<p><a class="anchor" id="client-server-v2-api-extensions"></a></p>
<div class="section" id="client-server-v2-api-extensions">
<h3><a class="toc-backref" href="#id296">6.1.3&nbsp;&nbsp;&nbsp;Client-Server v2 API Extensions</a></h3>
<p>Application services can utilise a more powerful version of the
client-server API by identifying itself as an application service to the
home server.</p>
<p><a class="anchor" id="identity-assertion"></a></p>
<div class="section" id="identity-assertion">
<h4><a class="toc-backref" href="#id297">6.1.3.1&nbsp;&nbsp;&nbsp;Identity assertion</a></h4>
<p>The client-server API infers the user ID from the <tt class="docutils literal">access_token</tt> provided in
every request. It would be an annoying amount of book-keeping to maintain tokens
for every virtual user. It would be preferable if the application service could
use the CS API with its own <tt class="docutils literal">as_token</tt> instead, and specify the virtual user
they wish to be acting on behalf of. For real users, this would require
additional permissions granting the AS permission to masquerade as a matrix user.</p>
<dl class="docutils">
<dt>Inputs:</dt>
<dd><ul class="first last simple">
<li>Application service token (<tt class="docutils literal">access_token</tt>)</li>
<li>User ID in the AS namespace to act as.</li>
</ul>
</dd>
<dt>Notes:</dt>
<dd><ul class="first last simple">
<li>This will apply on all aspects of the CS API, except for Account Management.</li>
<li>The <tt class="docutils literal">as_token</tt> is inserted into <tt class="docutils literal">access_token</tt> which is usually where the
client token is. This is done on purpose to allow application services to
reuse client SDKs.</li>
</ul>
</dd>
</dl>
<pre class="literal-block">
/path?access_token=$token&amp;user_id=$userid

Query Parameters:
  access_token: The application service token
  user_id: The desired user ID to act as.
</pre>
</div>
<p><a class="anchor" id="timestamp-massaging"></a></p>
<div class="section" id="timestamp-massaging">
<h4><a class="toc-backref" href="#id298">6.1.3.2&nbsp;&nbsp;&nbsp;Timestamp massaging</a></h4>
<p>The application service may want to inject events at a certain time (reflecting
the time on the network they are tracking e.g. irc, xmpp). Application services
need to be able to adjust the <tt class="docutils literal">origin_server_ts</tt> value to do this.</p>
<dl class="docutils">
<dt>Inputs:</dt>
<dd><ul class="first last simple">
<li>Application service token (<tt class="docutils literal">as_token</tt>)</li>
<li>Desired timestamp</li>
</ul>
</dd>
<dt>Notes:</dt>
<dd><ul class="first last simple">
<li>This will only apply when sending events.</li>
</ul>
</dd>
</dl>
<pre class="literal-block">
/path?access_token=$token&amp;ts=$timestamp

Query Parameters added to the send event APIs only:
  access_token: The application service token
  ts: The desired timestamp
</pre>
</div>
<p><a class="anchor" id="server-admin-style-permissions"></a></p>
<div class="section" id="server-admin-style-permissions">
<h4><a class="toc-backref" href="#id299">6.1.3.3&nbsp;&nbsp;&nbsp;Server admin style permissions</a></h4>
<p id="sect-asapi-permissions">The home server needs to give the application service <em>full control</em> over its
namespace, both for users and for room aliases. This means that the AS should
be able to create/edit/delete any room alias in its namespace, as well as
create/delete any user in its namespace. No additional API changes need to be
made in order for control of room aliases to be granted to the AS. Creation of
users needs API changes in order to:</p>
<ul class="simple">
<li>Work around captchas.</li>
<li>Have a 'passwordless' user.</li>
</ul>
<p>This involves bypassing the registration flows entirely. This is achieved by
including the AS token on a <tt class="docutils literal">/register</tt> request, along with a login type of
<tt class="docutils literal">m.login.application_service</tt> to set the desired user ID without a password.</p>
<pre class="literal-block">
/register?access_token=$as_token

Content:
{
  type: &quot;m.login.application_service&quot;,
  user: &quot;&lt;desired user localpart in AS namespace&gt;&quot;
}
</pre>
<p>Application services which attempt to create users or aliases <em>outside</em> of
their defined namespaces will receive an error code <tt class="docutils literal">M_EXCLUSIVE</tt>. Similarly,
normal users who attempt to create users or aliases <em>inside</em> an application
service-defined namespace will receive the same <tt class="docutils literal">M_EXCLUSIVE</tt> error code,
but only if the application service has defined the namespace as <tt class="docutils literal">exclusive</tt>.</p>
</div>
</div>
<p><a class="anchor" id="id-conventions"></a></p>
<div class="section" id="id-conventions">
<h3><a class="toc-backref" href="#id300">6.1.4&nbsp;&nbsp;&nbsp;ID conventions</a></h3>
<!-- TODO-spec
- Giving HSes the freedom to namespace still feels like the Right Thing here.
- Exposing a public API provides the consistency which was the main complaint
  against namespacing.
- This may have knock-on effects for the AS registration API. E.g. why don't
  we let ASes specify the *URI* regex they want? -->
<p>This concerns the well-defined conventions for mapping 3P network IDs to matrix
IDs, which we expect clients to be able to do by themselves.</p>
<p><a class="anchor" id="user-ids"></a></p>
<div class="section" id="user-ids">
<h4><a class="toc-backref" href="#id301">6.1.4.1&nbsp;&nbsp;&nbsp;User IDs</a></h4>
<p>Matrix users may wish to directly contact a virtual user, e.g. to send an email.
The URI format is a well-structured way to represent a number of different ID
types, including:</p>
<ul class="simple">
<li>MSISDNs (<tt class="docutils literal">tel</tt>)</li>
<li>Email addresses (<tt class="docutils literal">mailto</tt>)</li>
<li>IRC nicks (<tt class="docutils literal">irc</tt> - <a class="reference external" href="https://tools.ietf.org/html/draft-butcher-irc-url-04">https://tools.ietf.org/html/draft-butcher-irc-url-04</a>)</li>
<li>XMPP (XEP-0032)</li>
<li>SIP URIs (RFC 3261)</li>
</ul>
<p>As a result, virtual user IDs SHOULD relate to their URI counterpart. This
mapping from URI to user ID can be expressed in a number of ways:</p>
<ul class="simple">
<li>Expose a C-S API on the HS which takes URIs and responds with user IDs.</li>
<li>Munge the URI with the user ID.</li>
</ul>
<p>Exposing an API would allow HSes to internally map user IDs however they like,
at the cost of an extra round trip (of which the response can be cached).
Munging the URI would allow clients to apply the mapping locally, but would force
user X on service Y to always map to the same munged user ID. Considering the
exposed API could just be applying this munging, there is more flexibility if
an API is exposed.</p>
<pre class="literal-block">
GET /_matrix/app/v1/user?uri=$url_encoded_uri

Returns 200 OK:
{
  user_id: &lt;complete user ID on local HS&gt;
}
</pre>
</div>
<p><a class="anchor" id="id53"></a></p>
<div class="section" id="id53">
<h4><a class="toc-backref" href="#id302">6.1.4.2&nbsp;&nbsp;&nbsp;Room Aliases</a></h4>
<p>We may want to expose some 3P network rooms so Matrix users can join them directly,
e.g. IRC rooms. We don't want to expose every 3P network room though, e.g.
<tt class="docutils literal">mailto</tt>, <tt class="docutils literal">tel</tt>. Rooms which are publicly accessible (e.g. IRC rooms) can be
exposed as an alias by the application service. Private rooms
(e.g. sending an email to someone) should not
be exposed in this way, but should instead operate using normal invite/join semantics.
Therefore, the ID conventions discussed below are only valid for public rooms which
expose room aliases.</p>
<p>Matrix users may wish to join XMPP rooms (e.g. using XEP-0045) or IRC rooms. In both
cases, these rooms can be expressed as URIs. For consistency, these &quot;room&quot; URIs
SHOULD be mapped in the same way as &quot;user&quot; URIs.</p>
<pre class="literal-block">
GET /_matrix/app/v1/alias?uri=$url_encoded_uri

Returns 200 OK:
{
  alias: &lt;complete room alias on local HS&gt;
}
</pre>
</div>
<p><a class="anchor" id="id54"></a></p>
<div class="section" id="id54">
<h4><a class="toc-backref" href="#id303">6.1.4.3&nbsp;&nbsp;&nbsp;Event fields</a></h4>
<p>We recommend that any events that originated from a remote network should
include an <tt class="docutils literal">external_url</tt> field in their content to provide a way for Matrix
clients to link into the 'native' client from which the event originated.
For instance, this could contain the message-ID for emails/nntp posts, or a link
to a blog comment when bridging blog comment traffic in &amp; out of Matrix.</p>
</div>
</div>
</div>
</div>
<p><a class="anchor" id="federation-api"></a></p>
<div class="section" id="federation-api">
<h1><a class="toc-backref" href="#id304">7&nbsp;&nbsp;&nbsp;Federation API</a></h1>
<p>Matrix home servers use the Federation APIs (also known as server-server APIs)
to communicate with each other. Home servers use these APIs to push messages to
each other in real-time, to request historic messages from each other, and to
query profile and presence information about users on each other's servers.</p>
<p>The APIs are implemented using HTTPS GETs and PUTs between each of the
servers. These HTTPS requests are strongly authenticated using public key
signatures at the TLS transport layer and using public key signatures in
HTTP Authorization headers at the HTTP layer.</p>
<p>There are three main kinds of communication that occur between home servers:</p>
<dl class="docutils">
<dt>Persisted Data Units (PDUs):</dt>
<dd><p class="first">These events are broadcast from one home server to any others that have
joined the same room (identified by Room ID). They are persisted in
long-term storage and record the history of messages and state for a
room.</p>
<p class="last">Like email, it is the responsibility of the originating server of a PDU
to deliver that event to its recipient servers. However PDUs are signed
using the originating server's public key so that it is possible to
deliver them through third-party servers.</p>
</dd>
<dt>Ephemeral Data Units (EDUs):</dt>
<dd>These events are pushed between pairs of home servers. They are not
persisted and are not part of the history of a room, nor does the
receiving home server have to reply to them.</dd>
<dt>Queries:</dt>
<dd>These are single request/response interactions between a given pair of
servers, initiated by one side sending an HTTPS GET request to obtain some
information, and responded by the other. They are not persisted and contain
no long-term significant history. They simply request a snapshot state at
the instant the query is made.</dd>
</dl>
<p>EDUs and PDUs are further wrapped in an envelope called a Transaction, which is
transferred from the origin to the destination home server using an HTTPS PUT
request.</p>
<p><a class="anchor" id="server-discovery"></a></p>
<div class="section" id="server-discovery">
<h2><a class="toc-backref" href="#id305">7.1&nbsp;&nbsp;&nbsp;Server Discovery</a></h2>
<p><a class="anchor" id="resolving-server-names"></a></p>
<div class="section" id="resolving-server-names">
<h3><a class="toc-backref" href="#id306">7.1.1&nbsp;&nbsp;&nbsp;Resolving Server Names</a></h3>
<p>Each matrix home server is identified by a server name consisting of a DNS name
and an optional TLS port.</p>
<pre class="code literal-block">
server_name = dns_name [ &quot;:&quot; tls_port]
dns_name = &lt;host, see [RFC 3986], Section 3.2.2&gt;
tls_port = *DIGIT
</pre>
<!-- ** -->
<p>If the port is present then the server is discovered by looking up an AAAA or
A record for the DNS name and connecting to the specified TLS port. If the port
is absent then the server is discovered by looking up a <tt class="docutils literal">_matrix._tcp</tt> SRV
record for the DNS name. If this record does not exist then the server is
discovered by looking up an AAAA or A record on the DNS name and taking the
default fallback port number of 8448.
Home servers may use SRV records to load balance requests between multiple TLS
endpoints or to failover to another endpoint if an endpoint fails.</p>
</div>
<p><a class="anchor" id="retrieving-server-keys"></a></p>
<div class="section" id="retrieving-server-keys">
<h3><a class="toc-backref" href="#id307">7.1.2&nbsp;&nbsp;&nbsp;Retrieving Server Keys</a></h3>
<p><a class="anchor" id="version-2"></a></p>
<div class="section" id="version-2">
<h4><a class="toc-backref" href="#id308">7.1.2.1&nbsp;&nbsp;&nbsp;Version 2</a></h4>
<p>Each home server publishes its public keys under <tt class="docutils literal">/_matrix/key/v2/server/</tt>.
Home servers query for keys by either getting <tt class="docutils literal">/_matrix/key/v2/server/</tt>
directly or by querying an intermediate notary server using a
<tt class="docutils literal">/_matrix/key/v2/query</tt> API. Intermediate notary servers query the
<tt class="docutils literal">/_matrix/key/v2/server/</tt> API on behalf of another server and sign the
response with their own key. A server may query multiple notary servers to
ensure that they all report the same public keys.</p>
<p>This approach is borrowed from the <a class="reference external" href="http://perspectives-project.org/">Perspectives Project</a>, but modified to
include the NACL keys and to use JSON instead of XML. It has the advantage of
avoiding a single trust-root since each server is free to pick which notary
servers they trust and can corroborate the keys returned by a given notary
server by querying other servers.</p>
<p><a class="anchor" id="publishing-keys"></a></p>
<div class="section" id="publishing-keys">
<h5><a class="toc-backref" href="#id309">7.1.2.1.1&nbsp;&nbsp;&nbsp;Publishing Keys</a></h5>
<p>Home servers publish the allowed TLS fingerprints and signing keys in a JSON
object at <tt class="docutils literal"><span class="pre">/_matrix/key/v2/server/{key_id}</span></tt>. The response contains a list of
<tt class="docutils literal">verify_keys</tt> that are valid for signing federation requests made by the
server and for signing events. It contains a list of <tt class="docutils literal">old_verify_keys</tt>
which are only valid for signing events. Finally the response contains a list
of TLS certificate fingerprints to validate any connection made to the server.</p>
<p>A server may have multiple keys active at a given time. A server may have any
number of old keys. It is recommended that servers return a single JSON
response listing all of its keys whenever any <tt class="docutils literal">key_id</tt> is requested to reduce
the number of round trips needed to discover the relevant keys for a server.
However a server may return a different responses for a different <tt class="docutils literal">key_id</tt>.</p>
<p>The <tt class="docutils literal">tls_certificates</tt> contain a list of hashes of the X.509 TLS certificates
currently used by the server. The list must include SHA-256 hashes for every
certificate currently in use by the server. These fingerprints are valid until
the millisecond POSIX timestamp in <tt class="docutils literal">valid_until_ts</tt>.</p>
<p>The <tt class="docutils literal">verify_keys</tt> can be used to sign requests and events made by the server
until the millisecond POSIX timestamp in <tt class="docutils literal">valid_until_ts</tt>. If a Home Server
receives an event with a <tt class="docutils literal">origin_server_ts</tt> after the <tt class="docutils literal">valid_until_ts</tt> then
it should request that <tt class="docutils literal">key_id</tt> for the originating server to check whether
the key has expired.</p>
<p>The <tt class="docutils literal">old_verify_keys</tt> can be used to sign events with an <tt class="docutils literal">origin_server_ts</tt>
before the <tt class="docutils literal">expired_ts</tt>. The <tt class="docutils literal">expired_ts</tt> is a millisecond POSIX timestamp
of when the originating server stopped using that key.</p>
<p>Intermediate notary servers should cache a response for half of its remaining
life time to avoid serving a stale response. Originating servers should avoid
returning responses that expire in less than an hour to avoid repeated requests
for an about to expire certificate. Requesting servers should limit how
frequently they query for certificates to avoid flooding a server with requests.</p>
<p>If a server goes offline intermediate notary servers should continue to return
the last response they received from that server so that the signatures of old
events sent by that server can still be checked.</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="25%" />
<col width="49%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">server_name</tt></td>
<td>String</td>
<td>DNS name of the home server.</td>
</tr>
<tr><td><tt class="docutils literal">verify_keys</tt></td>
<td>Object</td>
<td>Public keys of the home server for
verifying digital signatures.</td>
</tr>
<tr><td><tt class="docutils literal">old_verify_keys</tt></td>
<td>Object</td>
<td>The public keys that the server used
to use and when it stopped using them.</td>
</tr>
<tr><td><tt class="docutils literal">signatures</tt></td>
<td>Object</td>
<td>Digital signatures for this object
signed using the <tt class="docutils literal">verify_keys</tt>.</td>
</tr>
<tr><td><tt class="docutils literal">tls_fingerprints</tt></td>
<td>Array of Objects</td>
<td>Hashes of X.509 TLS certificates used
by this this server encoded as base64.</td>
</tr>
<tr><td><tt class="docutils literal">valid_until_ts</tt></td>
<td>Integer</td>
<td>POSIX timestamp when the list of valid
keys should be refreshed.</td>
</tr>
</tbody>
</table>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;old_verify_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ed25519:auto1&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;expired_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">922834800000</span><span class="punctuation">,</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+Old+Verify+Key&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;server_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;example.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:auto2&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+Signature&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;tls_fingerprints&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+SHA-256-Fingerprint&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;valid_until_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1052262000000</span><span class="punctuation">,</span>
    <span class="name tag">&quot;verify_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ed25519:auto2&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+Signature+Verification+Key&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="querying-keys-through-another-server"></a></p>
<div class="section" id="querying-keys-through-another-server">
<h5><a class="toc-backref" href="#id310">7.1.2.1.2&nbsp;&nbsp;&nbsp;Querying Keys Through Another Server</a></h5>
<p>Servers may offer a query API <tt class="docutils literal">_matrix/key/v2/query/</tt> for getting the keys
for another server. This API can be used to GET at list of JSON objects for a
given server or to POST a bulk query for a number of keys from a number of
servers. Either way the response is a list of JSON objects containing the
JSON published by the server under <tt class="docutils literal">_matrix/key/v2/server/</tt> signed by
both the originating server and by this server.</p>
<p>The <tt class="docutils literal">minimum_valid_until_ts</tt> is a millisecond POSIX timestamp indicating
when the returned certificate will need to be valid until to be useful to the
requesting server. This can be set using the maximum <tt class="docutils literal">origin_server_ts</tt> of
an batch of events that a requesting server is trying to validate. This allows
an intermediate notary server to give a prompt cached response even if the
originating server is offline.</p>
<p>This API can return keys for servers that are offline be using cached responses
taken from when the server was online. Keys can be queried from multiple
servers to mitigate against DNS spoofing.</p>
<p>Requests:</p>
<pre class="code literal-block">
GET /_matrix/key/v2/query/${server_name}/${key_id}/?minimum_valid_until_ts=${minimum_valid_until_ts} HTTP/1.1

POST /_matrix/key/v2/query HTTP/1.1
Content-Type: application/json

{
    &quot;server_keys&quot;: {
        &quot;$server_name&quot;: {
            &quot;$key_id&quot;: {
                &quot;minimum_valid_until_ts&quot;: $posix_timestamp
            }
        }
    }
}
</pre>
<p>Response:</p>
<pre class="code literal-block">
HTTP/1.1 200 OK
Content-Type: application/json
{
    &quot;server_keys&quot;: [
       # List of responses with same format as /_matrix/key/v2/server
       # signed by both the originating server and this server.
    ]
}
</pre>
</div>
</div>
<p><a class="anchor" id="version-1"></a></p>
<div class="section" id="version-1">
<h4><a class="toc-backref" href="#id311">7.1.2.2&nbsp;&nbsp;&nbsp;Version 1</a></h4>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">Version 1 of key distribution is obsolete</p>
</div>
<p>Home servers publish their TLS certificates and signing keys in a JSON object
at <tt class="docutils literal">/_matrix/key/v1</tt>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="25%" />
<col width="49%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">server_name</tt></td>
<td>String</td>
<td>DNS name of the home server.</td>
</tr>
<tr><td><tt class="docutils literal">verify_keys</tt></td>
<td>Object</td>
<td>Public keys of the home server for
verifying digital signatures.</td>
</tr>
<tr><td><tt class="docutils literal">signatures</tt></td>
<td>Object</td>
<td>Digital signatures for this object
signed using the <tt class="docutils literal">verify_keys</tt>.</td>
</tr>
<tr><td><tt class="docutils literal">tls_certificate</tt></td>
<td>String</td>
<td>The X.509 TLS certificate used by this
this server encoded as base64.</td>
</tr>
</tbody>
</table>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;server_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;example.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:auto&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+Signature&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;tls_certificate&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+DER+Encoded+X509+TLS+Certificate&quot;</span>
    <span class="literal string double">&quot;verify_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ed25519:auto&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+Signature+Verification+Key&quot;</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>When fetching the keys for a server the client should check that the TLS
certificate in the JSON matches the TLS server certificate for the connection
and should check that the JSON signatures are correct for the supplied
<tt class="docutils literal">verify_keys</tt></p>
</div>
</div>
</div>
<p><a class="anchor" id="transactions"></a></p>
<div class="section" id="transactions">
<h2><a class="toc-backref" href="#id312">7.2&nbsp;&nbsp;&nbsp;Transactions</a></h2>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">This section may be misleading or inaccurate.</p>
</div>
<p>The transfer of EDUs and PDUs between home servers is performed by an exchange
of Transaction messages, which are encoded as JSON objects, passed over an HTTP
PUT request. A Transaction is meaningful only to the pair of home servers that
exchanged it; they are not globally-meaningful.</p>
<dl class="docutils">
<dt>Each transaction has:</dt>
<dd><ul class="first last simple">
<li>An opaque transaction ID.</li>
<li>A timestamp (UNIX epoch time in milliseconds) generated by its origin
server.</li>
<li>An origin and destination server name.</li>
<li>A list of &quot;previous IDs&quot;.</li>
<li>A list of PDUs and EDUs - the actual message payload that the Transaction
carries.</li>
</ul>
</dd>
</dl>
<p><a class="anchor" id="transaction-fields"></a></p>
<div class="section" id="transaction-fields">
<h3><a class="toc-backref" href="#id313">7.2.1&nbsp;&nbsp;&nbsp;Transaction Fields</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="25%" />
<col width="49%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">origin</tt></td>
<td>String</td>
<td>DNS name of homeserver making this
transaction.</td>
</tr>
<tr><td><tt class="docutils literal">origin_server_ts</tt></td>
<td>Integer</td>
<td>Timestamp in milliseconds on
originating homeserver when this
transaction started.</td>
</tr>
<tr><td><tt class="docutils literal">previous_ids</tt></td>
<td>List of Strings</td>
<td>List of transactions that were sent
immediately prior to this transaction.</td>
</tr>
<tr><td><tt class="docutils literal">pdus</tt></td>
<td>List of Objects</td>
<td>List of persistent updates to rooms.</td>
</tr>
<tr><td><tt class="docutils literal">edus</tt></td>
<td>List of Objects</td>
<td>List of ephemeral messages.</td>
</tr>
</tbody>
</table>
<pre class="code json literal-block">
<span class="punctuation">{</span>
 <span class="name tag">&quot;transaction_id&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;916d630ea616342b42e98a3be0b74113&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;ts&quot;</span><span class="punctuation">:</span><span class="literal number integer">1404835423000</span><span class="punctuation">,</span>
 <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;red&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;prev_ids&quot;</span><span class="punctuation">:[</span><span class="literal string double">&quot;e1da392e61898be4d2009b9fecce5325&quot;</span><span class="punctuation">],</span>
 <span class="name tag">&quot;pdus&quot;</span><span class="punctuation">:[</span><span class="error">...</span><span class="punctuation">],</span>
 <span class="name tag">&quot;edus&quot;</span><span class="punctuation">:[</span><span class="error">...</span><span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<p>The <tt class="docutils literal">prev_ids</tt> field contains a list of previous transaction IDs that the
<tt class="docutils literal">origin</tt> server has sent to this <tt class="docutils literal">destination</tt>. Its purpose is to act as a
sequence checking mechanism - the destination server can check whether it has
successfully received that Transaction, or ask for a re-transmission if not.</p>
<p>The <tt class="docutils literal">pdus</tt> field of a transaction is a list, containing zero or more PDUs.[*]
Each PDU is itself a JSON object containing a number of keys, the exact details
of which will vary depending on the type of PDU. Similarly, the <tt class="docutils literal">edus</tt> field
is another list containing the EDUs. This key may be entirely absent if there
are no EDUs to transfer.</p>
<p>(* Normally the PDU list will be non-empty, but the server should cope with
receiving an &quot;empty&quot; transaction, as this is useful for informing peers of other
transaction IDs they should be aware of. This effectively acts as a push
mechanism to encourage peers to continue to replicate content.)</p>
</div>
</div>
<p><a class="anchor" id="pdus"></a></p>
<div class="section" id="pdus">
<h2><a class="toc-backref" href="#id314">7.3&nbsp;&nbsp;&nbsp;PDUs</a></h2>
<p>All PDUs have:</p>
<ul class="simple">
<li>An ID to identify the PDU itself</li>
<li>A room ID that it relates to</li>
<li>A declaration of their type</li>
<li>A list of other PDU IDs that have been seen recently in that room (regardless
of which origin sent them)</li>
</ul>
<p><a class="anchor" id="required-pdu-fields"></a></p>
<div class="section" id="required-pdu-fields">
<h3><a class="toc-backref" href="#id315">7.3.1&nbsp;&nbsp;&nbsp;Required PDU Fields</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="23%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">context</tt></td>
<td>String</td>
<td>Room identifier</td>
</tr>
<tr><td><tt class="docutils literal">user_id</tt></td>
<td>String</td>
<td>The ID of the user sending the PDU</td>
</tr>
<tr><td><tt class="docutils literal">origin</tt></td>
<td>String</td>
<td>DNS name of homeserver that created
this PDU</td>
</tr>
<tr><td><tt class="docutils literal">pdu_id</tt></td>
<td>String</td>
<td>Unique identifier for PDU on the
originating homeserver</td>
</tr>
<tr><td><tt class="docutils literal">origin_server_ts</tt></td>
<td>Integer</td>
<td>Timestamp in milliseconds on origin
homeserver when this PDU was created.</td>
</tr>
<tr><td><tt class="docutils literal">pdu_type</tt></td>
<td>String</td>
<td>PDU event type</td>
</tr>
<tr><td><tt class="docutils literal">content</tt></td>
<td>Object</td>
<td>The content of the PDU.</td>
</tr>
<tr><td><tt class="docutils literal">prev_pdus</tt></td>
<td>List of (String,
String, Object)
Triplets</td>
<td>The originating homeserver, PDU ids and
hashes of the most recent PDUs the
homeserver was aware of for the room
when it made this PDU</td>
</tr>
<tr><td><tt class="docutils literal">depth</tt></td>
<td>Integer</td>
<td>The maximum depth of the previous PDUs
plus one</td>
</tr>
<tr><td><tt class="docutils literal">is_state</tt></td>
<td>Boolean</td>
<td>True if this PDU is updating room state</td>
</tr>
</tbody>
</table>
<pre class="code json literal-block">
<span class="punctuation">{</span>
 <span class="name tag">&quot;context&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;#example:green.example.com&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;green.example.com&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;pdu_id&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;a4ecee13e2accdadf56c1025af232176&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span><span class="literal number integer">1404838188000</span><span class="punctuation">,</span>
 <span class="name tag">&quot;pdu_type&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;prev_pdus&quot;</span><span class="punctuation">:[</span>
   <span class="punctuation">[</span><span class="literal string double">&quot;blue.example.com&quot;</span><span class="punctuation">,</span><span class="literal string double">&quot;99d16afbc8&quot;</span><span class="punctuation">,</span>
       <span class="punctuation">{</span><span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;abase64encodedsha256hashshouldbe43byteslong&quot;</span><span class="punctuation">}]</span>
 <span class="punctuation">],</span>
 <span class="name tag">&quot;hashes&quot;</span><span class="punctuation">:{</span><span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;thishashcoversallfieldsincasethisisredacted&quot;</span><span class="punctuation">},</span>
 <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:{</span>
   <span class="name tag">&quot;green.example.com&quot;</span><span class="punctuation">:{</span>
     <span class="name tag">&quot;ed25519:key_version:&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;these86bytesofbase64signaturecoveressentialfieldsincludinghashessocancheckredactedpdus&quot;</span>
   <span class="punctuation">}</span>
 <span class="punctuation">},</span>
 <span class="name tag">&quot;is_state&quot;</span><span class="punctuation">:</span><span class="keyword constant">false</span><span class="punctuation">,</span>
 <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="error">...</span><span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>In contrast to Transactions, it is important to note that the <tt class="docutils literal">prev_pdus</tt>
field of a PDU refers to PDUs that any origin server has sent, rather than
previous IDs that this <tt class="docutils literal">origin</tt> has sent. This list may refer to other PDUs
sent by the same origin as the current one, or other origins.</p>
<p>Because of the distributed nature of participants in a Matrix conversation, it
is impossible to establish a globally-consistent total ordering on the events.
However, by annotating each outbound PDU at its origin with IDs of other PDUs
it has received, a partial ordering can be constructed allowing causality
relationships to be preserved. A client can then display these messages to the
end-user in some order consistent with their content and ensure that no message
that is semantically in reply of an earlier one is ever displayed before it.</p>
</div>
<p><a class="anchor" id="state-update-pdu-fields"></a></p>
<div class="section" id="state-update-pdu-fields">
<h3><a class="toc-backref" href="#id316">7.3.2&nbsp;&nbsp;&nbsp;State Update PDU Fields</a></h3>
<p>PDUs fall into two main categories: those that deliver Events, and those that
synchronise State. For PDUs that relate to State synchronisation, additional
keys exist to support this:</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="16%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">state_key</tt></td>
<td>String</td>
<td>Combined with the <tt class="docutils literal">pdu_type</tt> this
identifies the which part of the room
state is updated</td>
</tr>
<tr><td><tt class="docutils literal">required_power_level</tt></td>
<td>Integer</td>
<td>The required power level needed to
replace this update.</td>
</tr>
<tr><td><tt class="docutils literal">prev_state_id</tt></td>
<td>String</td>
<td>The homeserver of the update this
replaces</td>
</tr>
<tr><td><tt class="docutils literal">prev_state_origin</tt></td>
<td>String</td>
<td>The PDU id of the update this replaces.</td>
</tr>
<tr><td><tt class="docutils literal">user_id</tt></td>
<td>String</td>
<td>The user updating the state.</td>
</tr>
</tbody>
</table>
<pre class="code json literal-block">
<span class="punctuation">{</span><span class="error">...,</span>
 <span class="name tag">&quot;is_state&quot;</span><span class="punctuation">:</span><span class="keyword constant">true</span><span class="punctuation">,</span>
 <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span><span class="error">TODO-doc</span>
 <span class="literal string double">&quot;required_power_level&quot;</span><span class="punctuation">:</span><span class="error">TODO-doc</span>
 <span class="literal string double">&quot;prev_state_id&quot;</span><span class="punctuation">:</span><span class="error">TODO-doc</span>
 <span class="literal string double">&quot;prev_state_origin&quot;</span><span class="punctuation">:</span><span class="error">TODO-doc</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="edus"></a></p>
<div class="section" id="edus">
<h2><a class="toc-backref" href="#id317">7.4&nbsp;&nbsp;&nbsp;EDUs</a></h2>
<p>EDUs, by comparison to PDUs, do not have an ID, a room ID, or a list of
&quot;previous&quot; IDs. The only mandatory fields for these are the type, origin and
destination home server names, and the actual nested content.</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="16%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">edu_type</tt></td>
<td>String</td>
<td>The type of the ephemeral message.</td>
</tr>
<tr><td><tt class="docutils literal">content</tt></td>
<td>Object</td>
<td>Content of the ephemeral message.</td>
</tr>
</tbody>
</table>
<pre class="code json literal-block">
<span class="punctuation">{</span>
 <span class="name tag">&quot;edu_type&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;m.presence&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;blue&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;destination&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;orange&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;content&quot;</span><span class="punctuation">:{</span><span class="error">...</span><span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="protocol-urls"></a></p>
<div class="section" id="protocol-urls">
<h2><a class="toc-backref" href="#id318">7.5&nbsp;&nbsp;&nbsp;Protocol URLs</a></h2>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">This section may be misleading or inaccurate.</p>
</div>
<p>All these URLs are name-spaced within a prefix of:</p>
<pre class="literal-block">
/_matrix/federation/v1/...
</pre>
<p>For active pushing of messages representing live activity &quot;as it happens&quot;:</p>
<pre class="literal-block">
PUT .../send/&lt;transaction_id&gt;/
  Body: JSON encoding of a single Transaction
  Response: TODO-doc
</pre>
<p>The transaction_id path argument will override any ID given in the JSON body.
The destination name will be set to that of the receiving server itself. Each
embedded PDU in the transaction body will be processed.</p>
<p>To fetch a particular PDU:</p>
<pre class="literal-block">
GET .../pdu/&lt;origin&gt;/&lt;pdu_id&gt;/
  Response: JSON encoding of a single Transaction containing one PDU
</pre>
<p>Retrieves a given PDU from the server. The response will contain a single new
Transaction, inside which will be the requested PDU.</p>
<p>To fetch all the state of a given room:</p>
<pre class="literal-block">
GET .../state/&lt;room_id&gt;/
  Response: JSON encoding of a single Transaction containing multiple PDUs
</pre>
<p>Retrieves a snapshot of the entire current state of the given room. The
response will contain a single Transaction, inside which will be a list of PDUs
that encode the state.</p>
<p>To backfill events on a given room:</p>
<pre class="literal-block">
GET .../backfill/&lt;room_id&gt;/
  Query args: v, limit
  Response: JSON encoding of a single Transaction containing multiple PDUs
</pre>
<p>Retrieves a sliding-window history of previous PDUs that occurred on the given
room. Starting from the PDU ID(s) given in the &quot;v&quot; argument, the PDUs that
preceded it are retrieved, up to a total number given by the &quot;limit&quot; argument.
These are then returned in a new Transaction containing all of the PDUs.</p>
<p>To stream events all the events:</p>
<pre class="literal-block">
GET .../pull/
  Query args: origin, v
  Response: JSON encoding of a single Transaction consisting of multiple PDUs
</pre>
<p>Retrieves all of the transactions later than any version given by the &quot;v&quot;
arguments.</p>
<p>To make a query:</p>
<pre class="literal-block">
GET .../query/&lt;query_type&gt;
  Query args: as specified by the individual query types
  Response: JSON encoding of a response object
</pre>
<p>Performs a single query request on the receiving home server. The Query Type
part of the path specifies the kind of query being made, and its query
arguments have a meaning specific to that kind of query. The response is a
JSON-encoded object whose meaning also depends on the kind of query.</p>
<p>To join a room:</p>
<pre class="literal-block">
GET .../make_join/&lt;room_id&gt;/&lt;user_id&gt;
  Response: JSON encoding of a join proto-event

PUT .../send_join/&lt;room_id&gt;/&lt;event_id&gt;
  Response: JSON encoding of the state of the room at the time of the event
</pre>
<p>Performs the room join handshake. For more information, see &quot;Joining Rooms&quot;
below.</p>
</div>
<p><a class="anchor" id="id55"></a></p>
<div class="section" id="id55">
<h2><a class="toc-backref" href="#id319">7.6&nbsp;&nbsp;&nbsp;Joining Rooms</a></h2>
<p>When a new user wishes to join room that the user's homeserver already knows
about, the homeserver can immediately determine if this is allowable by
inspecting the state of the room, and if it is acceptable, it can generate,
sign, and emit a new <tt class="docutils literal">m.room.member</tt> state event adding the user into that
room. When the homeserver does not yet know about the room it cannot do this
directly. Instead, it must take a longer multi-stage handshaking process by
which it first selects a remote homeserver which is already participating in
that room, and uses it to assist in the joining process. This is the remote
join handshake.</p>
<p>This handshake involves the homeserver of the new member wishing to join
(referred to here as the &quot;joining&quot; server), the directory server hosting the
room alias the user is requesting to join with, and a homeserver where existing
room members are already present (referred to as the &quot;resident&quot; server).</p>
<p>In summary, the remote join handshake consists of the joining server querying
the directory server for information about the room alias; receiving a room ID
and a list of join candidates. The joining server then requests information
about the room from one of the residents. It uses this information to construct
a <tt class="docutils literal">m.room.member</tt> event which it finally sends to a resident server.</p>
<p>Conceptually these are three different roles of homeserver. In practice the
directory server is likely to be resident in the room, and so may be selected
by the joining server to be the assisting resident. Likewise, it is likely that
the joining server picks the same candidate resident for both phases of event
construction, though in principle any valid candidate may be used at each time.
Thus, any join handshake can potentially involve anywhere from two to four
homeservers, though most in practice will use just two.</p>
<pre class="literal-block">
Client         Joining                Directory       Resident
               Server                 Server          Server

join request --&gt;
               |
               directory request -------&gt;
               &lt;---------- directory response
               |
               make_join request -----------------------&gt;
               &lt;------------------------------- make_join response
               |
               send_join request -----------------------&gt;
               &lt;------------------------------- send_join response
               |
&lt;---------- join response
</pre>
<p>The first part of the handshake usually involves using the directory server to
request the room ID and join candidates. This is covered in more detail on the
directory server documentation, below. In the case of a new user joining a
room as a result of a received invite, the joining user's homeserver could
optimise this step away by picking the origin server of that invite message as
the join candidate. However, the joining server should be aware that the origin
server of the invite might since have left the room, so should be prepared to
fall back on the regular join flow if this optimisation fails.</p>
<p>Once the joining server has the room ID and the join candidates, it then needs
to obtain enough information about the room to fill in the required fields of
the <tt class="docutils literal">m.room.member</tt> event. It obtains this by selecting a resident from the
candidate list, and requesting the <tt class="docutils literal">make_join</tt> endpoint using a <tt class="docutils literal">GET</tt>
request, specifying the room ID and the user ID of the new member who is
attempting to join.</p>
<p>The resident server replies to this request with a JSON-encoded object having a
single key called <tt class="docutils literal">event</tt>; within this is an object whose fields contain some
of the information that the joining server will need. Despite its name, this
object is not a full event; notably it does not need to be hashed or signed by
the resident homeserver. The required fields are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="10%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">type</tt></td>
<td>String</td>
<td>The value <tt class="docutils literal">m.room.member</tt></td>
</tr>
<tr><td><tt class="docutils literal">auth_events</tt></td>
<td>List</td>
<td>An event-reference list containing the
authorization events that would allow this member
to join</td>
</tr>
<tr><td><tt class="docutils literal">content</tt></td>
<td>Object</td>
<td>The event content</td>
</tr>
<tr><td><tt class="docutils literal">depth</tt></td>
<td>Integer</td>
<td>(this field must be present but is ignored; it
may be 0)</td>
</tr>
<tr><td><tt class="docutils literal">event_id</tt></td>
<td>String</td>
<td>A new event ID specified by the resident
homeserver</td>
</tr>
<tr><td><tt class="docutils literal">origin</tt></td>
<td>String</td>
<td>The name of the resident homeserver</td>
</tr>
<tr><td><tt class="docutils literal">origin_server_ts</tt></td>
<td>Integer</td>
<td>A timestamp added by the resident homeserver</td>
</tr>
<tr><td><tt class="docutils literal">prev_events</tt></td>
<td>List</td>
<td>An event-reference list containing the immediate
predecessor events</td>
</tr>
<tr><td><tt class="docutils literal">room_id</tt></td>
<td>String</td>
<td>The room ID of the room</td>
</tr>
<tr><td><tt class="docutils literal">sender</tt></td>
<td>String</td>
<td>The user ID of the joining member</td>
</tr>
<tr><td><tt class="docutils literal">state_key</tt></td>
<td>String</td>
<td>The user ID of the joining member</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal">content</tt> field itself must be an object, containing:</p>
<table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="16%" />
<col width="47%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">membership</tt></td>
<td>String</td>
<td>The value <tt class="docutils literal">join</tt></td>
</tr>
</tbody>
</table>
<p>The joining server now has sufficient information to construct the real join
event from these protoevent fields. It copies the values of most of them,
adding (or replacing) the following fields:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="9%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">event_id</tt></td>
<td>String</td>
<td>A new event ID specified by the joining homeserver</td>
</tr>
<tr><td><tt class="docutils literal">origin</tt></td>
<td>String</td>
<td>The name of the joining homeserver</td>
</tr>
<tr><td><tt class="docutils literal">origin_server_ts</tt></td>
<td>Integer</td>
<td>A timestamp added by the joining homeserver</td>
</tr>
</tbody>
</table>
<!-- TODO-spec
- Why does the protoevent have an event_id, only for the real event to ignore
  it and specify a different one? We should definitely pick one or the other. -->
<p>This will be a true event, so the joining server should apply the event-signing
algorithm to it, resulting in the addition of the <tt class="docutils literal">hashes</tt> and <tt class="docutils literal">signatures</tt>
fields.</p>
<p>To complete the join handshake, the joining server must now submit this new
event to an resident homeserver, by using the <tt class="docutils literal">send_join</tt> endpoint. This is
invoked using the room ID and the event ID of the new member event.</p>
<p>The resident homeserver then accepts this event into the room's event graph,
and responds to the joining server with the full set of state for the newly-
joined room. This is returned as a two-element list, whose first element is the
integer 200, and whose second element is an object which contains the
following keys:</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="7%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">auth_chain</tt></td>
<td>List</td>
<td>A list of events giving the authorization chain for this
join event</td>
</tr>
<tr><td><tt class="docutils literal">state</tt></td>
<td>List</td>
<td>A complete list of the prevailing state events at the
instant just before accepting the new <tt class="docutils literal">m.room.member</tt>
event</td>
</tr>
</tbody>
</table>
<!-- TODO-spec
- (paul) I don't really understand why the full auth_chain events are given
  here. What purpose does it serve expanding them out in full, when surely
  they'll appear in the state anyway? -->
</div>
<p><a class="anchor" id="backfilling"></a></p>
<div class="section" id="backfilling">
<h2><a class="toc-backref" href="#id320">7.7&nbsp;&nbsp;&nbsp;Backfilling</a></h2>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">This section is a work in progress.</p>
</div>
<!-- TODO-doc
- What it is, when is it used, how is it done -->
</div>
<p><a class="anchor" id="authentication"></a></p>
<div class="section" id="authentication">
<h2><a class="toc-backref" href="#id321">7.8&nbsp;&nbsp;&nbsp;Authentication</a></h2>
<p><a class="anchor" id="request-authentication"></a></p>
<div class="section" id="request-authentication">
<h3><a class="toc-backref" href="#id322">7.8.1&nbsp;&nbsp;&nbsp;Request Authentication</a></h3>
<p>Every HTTP request made by a homeserver is authenticated using public key
digital signatures. The request method, target and body are signed by wrapping
them in a JSON object and signing it using the JSON signing algorithm. The
resulting signatures are added as an Authorization header with an auth scheme
of X-Matrix. Note that the target field should include the full path starting with
<tt class="docutils literal"><span class="pre">/_matrix/...</span></tt>, including the <tt class="docutils literal">?</tt> and any query parameters if present, but
should not include the leading <tt class="docutils literal">https:</tt>, nor the destination server's
hostname.</p>
<p>Step 1 sign JSON:</p>
<pre class="code literal-block">
 {
     &quot;method&quot;: &quot;GET&quot;,
     &quot;uri&quot;: &quot;/target&quot;,
     &quot;origin&quot;: &quot;origin.hs.example.com&quot;,
     &quot;destintation&quot;: &quot;destination.hs.example.com&quot;,
     &quot;content&quot;: { JSON content ... },
     &quot;signatures&quot;: {
         &quot;origin.hs.example.com&quot;: {
             &quot;ed25519:key1&quot;: &quot;ABCDEF...&quot;
         }
     }
}
</pre>
<p>Step 2 add Authorization header:</p>
<pre class="code literal-block">
GET /target HTTP/1.1
Authorization: X-Matrix origin=origin.example.com,key=&quot;ed25519:key1&quot;,sig=&quot;ABCDEF...&quot;
Content-Type: application/json

{ JSON content ... }
</pre>
<p>Example python code:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">authorization_headers</span><span class="punctuation">(</span><span class="name">origin_name</span><span class="punctuation">,</span> <span class="name">origin_signing_key</span><span class="punctuation">,</span>
                          <span class="name">destination_name</span><span class="punctuation">,</span> <span class="name">request_method</span><span class="punctuation">,</span> <span class="name">request_target</span><span class="punctuation">,</span>
                          <span class="name">content_json</span><span class="operator">=</span><span class="name builtin pseudo">None</span><span class="punctuation">):</span>
    <span class="name">request_json</span> <span class="operator">=</span> <span class="punctuation">{</span>
         <span class="literal string">&quot;method&quot;</span><span class="punctuation">:</span> <span class="name">request_method</span><span class="punctuation">,</span>
         <span class="literal string">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="name">request_target</span><span class="punctuation">,</span>
         <span class="literal string">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="name">origin_name</span><span class="punctuation">,</span>
         <span class="literal string">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="name">destination_name</span><span class="punctuation">,</span>
    <span class="punctuation">}</span>

    <span class="keyword">if</span> <span class="name">content_json</span> <span class="operator word">is</span> <span class="operator word">not</span> <span class="name builtin pseudo">None</span><span class="punctuation">:</span>
        <span class="name">request</span><span class="punctuation">[</span><span class="literal string">&quot;content&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">content_json</span>

    <span class="name">signed_json</span> <span class="operator">=</span> <span class="name">sign_json</span><span class="punctuation">(</span><span class="name">request_json</span><span class="punctuation">,</span> <span class="name">origin_name</span><span class="punctuation">,</span> <span class="name">origin_signing_key</span><span class="punctuation">)</span>

    <span class="name">authorization_headers</span> <span class="operator">=</span> <span class="punctuation">[]</span>

    <span class="keyword">for</span> <span class="name">key</span><span class="punctuation">,</span> <span class="name">sig</span> <span class="operator word">in</span> <span class="name">signed_json</span><span class="punctuation">[</span><span class="literal string">&quot;signatures&quot;</span><span class="punctuation">][</span><span class="name">origin_name</span><span class="punctuation">]</span><span class="operator">.</span><span class="name">items</span><span class="punctuation">():</span>
        <span class="name">authorization_headers</span><span class="operator">.</span><span class="name">append</span><span class="punctuation">(</span><span class="name builtin">bytes</span><span class="punctuation">(</span>
            <span class="literal string">&quot;X-Matrix origin=</span><span class="literal string interpol">%s</span><span class="literal string">,key=</span><span class="literal string escape">\&quot;</span><span class="literal string interpol">%s</span><span class="literal string escape">\&quot;</span><span class="literal string">,sig=</span><span class="literal string escape">\&quot;</span><span class="literal string interpol">%s</span><span class="literal string escape">\&quot;</span><span class="literal string">&quot;</span> <span class="operator">%</span> <span class="punctuation">(</span>
                <span class="name">origin_name</span><span class="punctuation">,</span> <span class="name">key</span><span class="punctuation">,</span> <span class="name">sig</span><span class="punctuation">,</span>
            <span class="punctuation">)</span>
        <span class="punctuation">))</span>

    <span class="keyword">return</span> <span class="punctuation">(</span><span class="literal string">&quot;Authorization&quot;</span><span class="punctuation">,</span> <span class="name">authorization_headers</span><span class="punctuation">)</span>
</pre>
</div>
<p><a class="anchor" id="response-authentication"></a></p>
<div class="section" id="response-authentication">
<h3><a class="toc-backref" href="#id323">7.8.2&nbsp;&nbsp;&nbsp;Response Authentication</a></h3>
<p>Responses are authenticated by the TLS server certificate. A homeserver should
not send a request until it has authenticated the connected server to avoid
leaking messages to eavesdroppers.</p>
</div>
<p><a class="anchor" id="client-tls-certificates"></a></p>
<div class="section" id="client-tls-certificates">
<h3><a class="toc-backref" href="#id324">7.8.3&nbsp;&nbsp;&nbsp;Client TLS Certificates</a></h3>
<p>Requests are authenticated at the HTTP layer rather than at the TLS layer
because HTTP services like Matrix are often deployed behind load balancers that
handle the TLS and these load balancers make it difficult to check TLS client
certificates.</p>
<p>A home server may provide a TLS client certificate and the receiving home server
may check that the client certificate matches the certificate of the origin
home server.</p>
</div>
</div>
<p><a class="anchor" id="server-server-authorization"></a></p>
<div class="section" id="server-server-authorization">
<h2><a class="toc-backref" href="#id325">7.9&nbsp;&nbsp;&nbsp;Server-Server Authorization</a></h2>
<!-- TODO-doc
- PDU signing (see the Event signing section earlier)
- State conflict resolution (see below) -->
</div>
<p><a class="anchor" id="state-conflict-resolution"></a></p>
<div class="section" id="state-conflict-resolution">
<h2><a class="toc-backref" href="#id326">7.10&nbsp;&nbsp;&nbsp;State Conflict Resolution</a></h2>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">This section is a work in progress.</p>
</div>
<!-- TODO-doc
- How do conflicts arise (diagrams?)
- How are they resolved (incl tie breaks)
- How does this work with deleting current state
- How do we reject invalid federation traffic?

[[TODO(paul): At this point we should probably have a long description of how
State management works, with descriptions of clobbering rules, power levels, etc
etc... But some of that detail is rather up-in-the-air, on the whiteboard, and
so on. This part needs refining. And writing in its own document as the details
relate to the server/system as a whole, not specifically to server-server
federation.]] -->
</div>
<p><a class="anchor" id="id56"></a></p>
<div class="section" id="id56">
<h2><a class="toc-backref" href="#id327">7.11&nbsp;&nbsp;&nbsp;Presence</a></h2>
<p>The server API for presence is based entirely on exchange of the following
EDUs. There are no PDUs or Federation Queries involved.</p>
<p>Performing a presence update and poll subscription request:</p>
<pre class="literal-block">
EDU type: m.presence

Content keys:
  push: (optional): list of push operations.
    Each should be an object with the following keys:
      user_id: string containing a User ID
      presence: &quot;offline&quot;|&quot;unavailable&quot;|&quot;online&quot;|&quot;free_for_chat&quot;
      status_msg: (optional) string of free-form text
      last_active_ago: milliseconds since the last activity by the user

  poll: (optional): list of strings giving User IDs

  unpoll: (optional): list of strings giving User IDs
</pre>
<p>The presence of this combined message is two-fold: it informs the recipient
server of the current status of one or more users on the sending server (by the
<tt class="docutils literal">push</tt> key), and it maintains the list of users on the recipient server that
the sending server is interested in receiving updates for, by adding (by the
<tt class="docutils literal">poll</tt> key) or removing them (by the <tt class="docutils literal">unpoll</tt> key). The <tt class="docutils literal">poll</tt> and
<tt class="docutils literal">unpoll</tt> lists apply <em>changes</em> to the implied list of users; any existing IDs
that the server sent as <tt class="docutils literal">poll</tt> operations in a previous message are not
removed until explicitly requested by a later <tt class="docutils literal">unpoll</tt>.</p>
<p>On receipt of a message containing a non-empty <tt class="docutils literal">poll</tt> list, the receiving
server should immediately send the sending server a presence update EDU of its
own, containing in a <tt class="docutils literal">push</tt> list the current state of every user that was in
the original EDU's <tt class="docutils literal">poll</tt> list.</p>
<p>Sending a presence invite:</p>
<pre class="literal-block">
EDU type: m.presence_invite

Content keys:
  observed_user: string giving the User ID of the user whose presence is
    requested (i.e. the recipient of the invite)
  observer_user: string giving the User ID of the user who is requesting to
    observe the presence (i.e. the sender of the invite)
</pre>
<p>Accepting a presence invite:</p>
<pre class="literal-block">
EDU type: m.presence_accept

Content keys - as for m.presence_invite
</pre>
<p>Rejecting a presence invite:</p>
<pre class="literal-block">
EDU type: m.presence_deny

Content keys - as for m.presence_invite
</pre>
<!-- TODO-doc
- Explain the timing-based round-trip reduction mechanism for presence
  messages
- Explain the zero-byte presence inference logic
See also: docs/client-server/model/presence -->
</div>
<p><a class="anchor" id="id57"></a></p>
<div class="section" id="id57">
<h2><a class="toc-backref" href="#id328">7.12&nbsp;&nbsp;&nbsp;Profiles</a></h2>
<p>The server API for profiles is based entirely on the following Federation
Queries. There are no additional EDU or PDU types involved, other than the
implicit <tt class="docutils literal">m.presence</tt> and <tt class="docutils literal">m.room.member</tt> events (see section below).</p>
<p>Querying profile information:</p>
<pre class="literal-block">
Query type: profile

Arguments:
  user_id: the ID of the user whose profile to return
  field: (optional) string giving a field name

Returns: JSON object containing the following keys:
  displayname: string of free-form text
  avatar_url: string containing an HTTP-scheme URL
</pre>
<p>If the query contains the optional <tt class="docutils literal">field</tt> key, it should give the name of a
result field. If such is present, then the result should contain only a field
of that name, with no others present. If not, the result should contain as much
of the user's profile as the home server has available and can make public.</p>
</div>
<p><a class="anchor" id="directory"></a></p>
<div class="section" id="directory">
<h2><a class="toc-backref" href="#id329">7.13&nbsp;&nbsp;&nbsp;Directory</a></h2>
<p>The server API for directory queries is also based on Federation Queries.</p>
<p>Querying directory information:</p>
<pre class="literal-block">
Query type: directory

Arguments:
  room_alias: the room alias to query

Returns: JSON object containing the following keys:
  room_id: string giving the underlying room ID the alias maps to
  servers: list of strings giving the join candidates
</pre>
<p>The list of join candidates is a list of server names that are likely to hold
the given room; these are servers that the requesting server may wish to use as
resident servers as part of the remote join handshake. This list may or may not
include the server answering the query.</p>
</div>
</div>
<p><a class="anchor" id="identity-servers"></a></p>
<div class="section" id="identity-servers">
<h1><a class="toc-backref" href="#id330">8&nbsp;&nbsp;&nbsp;Identity Servers</a></h1>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">This section is a work in progress.</p>
</div>
<!-- TODO-doc Dave
- 3PIDs and identity server, functions -->
</div>
<p><a class="anchor" id="appendices"></a></p>
<div class="section" id="appendices">
<h1><a class="toc-backref" href="#id331">9&nbsp;&nbsp;&nbsp;Appendices</a></h1>
<p><a class="anchor" id="security-threat-model"></a></p>
<div class="section" id="security-threat-model">
<h2><a class="toc-backref" href="#id332">9.1&nbsp;&nbsp;&nbsp;Security Threat Model</a></h2>
<p><a class="anchor" id="denial-of-service"></a></p>
<div class="section" id="denial-of-service">
<h3><a class="toc-backref" href="#id333">9.1.1&nbsp;&nbsp;&nbsp;Denial of Service</a></h3>
<p>The attacker could attempt to prevent delivery of messages to or from the
victim in order to:</p>
<ul class="simple">
<li>Disrupt service or marketing campaign of a commercial competitor.</li>
<li>Censor a discussion or censor a participant in a discussion.</li>
<li>Perform general vandalism.</li>
</ul>
<p><a class="anchor" id="threat-resource-exhaustion"></a></p>
<div class="section" id="threat-resource-exhaustion">
<h4><a class="toc-backref" href="#id334">9.1.1.1&nbsp;&nbsp;&nbsp;Threat: Resource Exhaustion</a></h4>
<p>An attacker could cause the victims server to exhaust a particular resource
(e.g. open TCP connections, CPU, memory, disk storage)</p>
</div>
<p><a class="anchor" id="threat-unrecoverable-consistency-violations"></a></p>
<div class="section" id="threat-unrecoverable-consistency-violations">
<h4><a class="toc-backref" href="#id335">9.1.1.2&nbsp;&nbsp;&nbsp;Threat: Unrecoverable Consistency Violations</a></h4>
<p>An attacker could send messages which created an unrecoverable &quot;split-brain&quot;
state in the cluster such that the victim's servers could no longer derive a
consistent view of the chatroom state.</p>
</div>
<p><a class="anchor" id="threat-bad-history"></a></p>
<div class="section" id="threat-bad-history">
<h4><a class="toc-backref" href="#id336">9.1.1.3&nbsp;&nbsp;&nbsp;Threat: Bad History</a></h4>
<p>An attacker could convince the victim to accept invalid messages which the
victim would then include in their view of the chatroom history. Other servers
in the chatroom would reject the invalid messages and potentially reject the
victims messages as well since they depended on the invalid messages.</p>
<!-- TODO-spec
Track trustworthiness of HS or users based on if they try to pretend they
haven't seen recent events, and fake a splitbrain... - -M -->
</div>
<p><a class="anchor" id="threat-block-network-traffic"></a></p>
<div class="section" id="threat-block-network-traffic">
<h4><a class="toc-backref" href="#id337">9.1.1.4&nbsp;&nbsp;&nbsp;Threat: Block Network Traffic</a></h4>
<p>An attacker could try to firewall traffic between the victim's server and some
or all of the other servers in the chatroom.</p>
</div>
<p><a class="anchor" id="threat-high-volume-of-messages"></a></p>
<div class="section" id="threat-high-volume-of-messages">
<h4><a class="toc-backref" href="#id338">9.1.1.5&nbsp;&nbsp;&nbsp;Threat: High Volume of Messages</a></h4>
<p>An attacker could send large volumes of messages to a chatroom with the victim
making the chatroom unusable.</p>
</div>
<p><a class="anchor" id="threat-banning-users-without-necessary-authorisation"></a></p>
<div class="section" id="threat-banning-users-without-necessary-authorisation">
<h4><a class="toc-backref" href="#id339">9.1.1.6&nbsp;&nbsp;&nbsp;Threat: Banning users without necessary authorisation</a></h4>
<p>An attacker could attempt to ban a user from a chatroom with the necessary
authorisation.</p>
</div>
</div>
<p><a class="anchor" id="spoofing"></a></p>
<div class="section" id="spoofing">
<h3><a class="toc-backref" href="#id340">9.1.2&nbsp;&nbsp;&nbsp;Spoofing</a></h3>
<p>An attacker could try to send a message claiming to be from the victim without
the victim having sent the message in order to:</p>
<ul class="simple">
<li>Impersonate the victim while performing illicit activity.</li>
<li>Obtain privileges of the victim.</li>
</ul>
<p><a class="anchor" id="threat-altering-message-contents"></a></p>
<div class="section" id="threat-altering-message-contents">
<h4><a class="toc-backref" href="#id341">9.1.2.1&nbsp;&nbsp;&nbsp;Threat: Altering Message Contents</a></h4>
<p>An attacker could try to alter the contents of an existing message from the
victim.</p>
</div>
<p><a class="anchor" id="threat-fake-message-origin-field"></a></p>
<div class="section" id="threat-fake-message-origin-field">
<h4><a class="toc-backref" href="#id342">9.1.2.2&nbsp;&nbsp;&nbsp;Threat: Fake Message &quot;origin&quot; Field</a></h4>
<p>An attacker could try to send a new message purporting to be from the victim
with a phony &quot;origin&quot; field.</p>
</div>
</div>
<p><a class="anchor" id="spamming"></a></p>
<div class="section" id="spamming">
<h3><a class="toc-backref" href="#id343">9.1.3&nbsp;&nbsp;&nbsp;Spamming</a></h3>
<p>The attacker could try to send a high volume of solicited or unsolicited
messages to the victim in order to:</p>
<ul class="simple">
<li>Find victims for scams.</li>
<li>Market unwanted products.</li>
</ul>
<p><a class="anchor" id="threat-unsolicited-messages"></a></p>
<div class="section" id="threat-unsolicited-messages">
<h4><a class="toc-backref" href="#id344">9.1.3.1&nbsp;&nbsp;&nbsp;Threat: Unsolicited Messages</a></h4>
<p>An attacker could try to send messages to victims who do not wish to receive
them.</p>
</div>
<p><a class="anchor" id="threat-abusive-messages"></a></p>
<div class="section" id="threat-abusive-messages">
<h4><a class="toc-backref" href="#id345">9.1.3.2&nbsp;&nbsp;&nbsp;Threat: Abusive Messages</a></h4>
<p>An attacker could send abusive or threatening messages to the victim</p>
</div>
</div>
<p><a class="anchor" id="spying"></a></p>
<div class="section" id="spying">
<h3><a class="toc-backref" href="#id346">9.1.4&nbsp;&nbsp;&nbsp;Spying</a></h3>
<p>The attacker could try to access message contents or metadata for messages sent
by the victim or to the victim that were not intended to reach the attacker in
order to:</p>
<ul class="simple">
<li>Gain sensitive personal or commercial information.</li>
<li>Impersonate the victim using credentials contained in the messages.
(e.g. password reset messages)</li>
<li>Discover who the victim was talking to and when.</li>
</ul>
<p><a class="anchor" id="threat-disclosure-during-transmission"></a></p>
<div class="section" id="threat-disclosure-during-transmission">
<h4><a class="toc-backref" href="#id347">9.1.4.1&nbsp;&nbsp;&nbsp;Threat: Disclosure during Transmission</a></h4>
<p>An attacker could try to expose the message contents or metadata during
transmission between the servers.</p>
</div>
<p><a class="anchor" id="threat-disclosure-to-servers-outside-chatroom"></a></p>
<div class="section" id="threat-disclosure-to-servers-outside-chatroom">
<h4><a class="toc-backref" href="#id348">9.1.4.2&nbsp;&nbsp;&nbsp;Threat: Disclosure to Servers Outside Chatroom</a></h4>
<p>An attacker could try to convince servers within a chatroom to send messages to
a server it controls that was not authorised to be within the chatroom.</p>
</div>
</div>
<p><a class="anchor" id="threat-disclosure-to-servers-within-chatroom"></a></p>
<div class="section" id="threat-disclosure-to-servers-within-chatroom">
<h3><a class="toc-backref" href="#id349">9.1.5&nbsp;&nbsp;&nbsp;Threat: Disclosure to Servers Within Chatroom</a></h3>
<p>An attacker could take control of a server within a chatroom to expose message
contents or metadata for messages in that room.</p>
</div>
</div>
<p><a class="anchor" id="cryptographic-test-vectors"></a></p>
<div class="section" id="cryptographic-test-vectors">
<h2><a class="toc-backref" href="#id350">9.2&nbsp;&nbsp;&nbsp;Cryptographic Test Vectors</a></h2>
<p>To assist in the development of compatible implementations, the following test
values may be useful for verifying the cryptographic event signing code.</p>
<p><a class="anchor" id="signing-key"></a></p>
<div class="section" id="signing-key">
<h3><a class="toc-backref" href="#id351">9.2.1&nbsp;&nbsp;&nbsp;Signing Key</a></h3>
<p>The following test vectors all use the 32-byte value given by the following
Base64-encoded string as the seed for generating the <tt class="docutils literal">ed25519</tt> signing key:</p>
<pre class="code literal-block">
SIGNING_KEY_SEED = decode_base64(
    &quot;YJDBA9Xnr2sVqXD9Vj7XVUnmFZcZrlw8Md7kMW+3XA1&quot;
)
</pre>
<p>In each case, the server name and key ID are as follows:</p>
<pre class="code literal-block">
SERVER_NAME = &quot;domain&quot;

KEY_ID = &quot;ed25519:1&quot;
</pre>
</div>
<p><a class="anchor" id="json-signing"></a></p>
<div class="section" id="json-signing">
<h3><a class="toc-backref" href="#id352">9.2.2&nbsp;&nbsp;&nbsp;JSON Signing</a></h3>
<p>Given an empty JSON object:</p>
<pre class="code json literal-block">
<span class="punctuation">{}</span>
</pre>
<p>The JSON signing algorithm should emit the following signed data:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:1&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;K8280/U9SSy9IVtjBuVeLr+HpOB4BQFWbg+UZaADMtTdGYI7Geitb76LTrr5QV/7Xg4ahLwYGYZzuHGZKM5ZAQ&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>Given the following JSON object with data values in it:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;one&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span><span class="punctuation">,</span>
    <span class="name tag">&quot;two&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Two&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>The JSON signing algorithm should emit the following signed JSON:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;one&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:1&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;KqmLSbO39/Bzb0QIYE82zqLwsA+PDzYIpIRA2sRQ4sL53+sN6/fpNSoqE7BP7vBZhG6kYdD13EIMJpvhJI+6Bw&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;two&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Two&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="event-signing"></a></p>
<div class="section" id="event-signing">
<h3><a class="toc-backref" href="#id353">9.2.3&nbsp;&nbsp;&nbsp;Event Signing</a></h3>
<p>Given the following minimally-sized event:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$0:domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1000000</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;X&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1000000</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>The event signing algorithm should emit the following signed event:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$0:domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;hashes&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;6tJjLpXtggfke8UxFhAKg82QVkJzvKOVOOSjUDK4ZSI&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1000000</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:1&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;2Wptgo4CwmLo/Y8B8qinxApKaCkBG2fjTWB7AbP5Uy+aIbygsSdLOFzvdDjww8zUVKCmI02eP9xtyJxc/cLiBA&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;X&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1000000</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>Given the following event containing redactable content:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Here is the message content&quot;</span><span class="punctuation">,</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$0:domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1000000</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!r:domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;u:domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{},</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1000000</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>The event signing algorithm should emit the following signed event:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;body&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Here is the message content&quot;</span><span class="punctuation">,</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$0:domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;hashes&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;onLKD1bGljeBWQhWZ1kaP9SorVmRQNdN5aM2JYU2n/g&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1000000</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!r:domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;u:domain&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:1&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Wm+VzmOUOz08Ds+0NTWb1d4CZrVsJSikkeRxh6aCcUwu6pNC78FunoD7KNWzqFn241eYHYMGCA5McEiVPdhzBA&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;age_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1000000</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
</div>

</body>
</html>
