<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script type='text/javascript' src='//matrix.org/blog/wp-includes/js/jquery/jquery.js?ver=1.11.3'></script>

  <link rel="stylesheet" href="//matrix.org/site.css">
  <link rel="stylesheet" href="//matrix.org/docs/css/main.css">

  <link rel="stylesheet" href="//matrix.org/docs/css/site_overrides.css">
  <link rel="stylesheet" href="//matrix.org/docs/css/basic.css">
  <link rel="stylesheet" href="//matrix.org/docs/css/nature.css">

  <link rel='stylesheet' id='divi-fonts-css'  href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,800italic,400,300,700,800&#038;subset=latin,latin-ext' type='text/css' media='all'>
  <link rel='stylesheet' id='divi-style-css'  href='//matrix.org/blog/wp-content/themes/Divi-child/style.css?ver=2.2' type='text/css' media='all'>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54779209-1', 'auto');
  ga('send', 'pageview');
</script>



  <link rel="stylesheet" href="/docs/guides/css/docs_overrides.css">

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Identity Service API</title>
<style type="text/css">

/*
 * basic.css
 * ~~~~~~~~~
 *
 * Sphinx stylesheet -- basic theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- main layout ----------------------------------------------------------- */

div.clearer {
    clear: both;
}

/* -- relbar ---------------------------------------------------------------- */

div.related {
    width: 100%;
    font-size: 90%;
}

div.related h3 {
    display: none;
}

div.related ul {
    margin: 0;
    padding: 0 0 0 10px;
    list-style: none;
}

div.related li {
    display: inline;
}

div.related li.right {
    float: right;
    margin-right: 5px;
}

/* -- sidebar --------------------------------------------------------------- */

div.sphinxsidebarwrapper {
    padding: 10px 5px 0 10px;
}

div.sphinxsidebar {
    float: left;
    width: 230px;
    margin-left: -100%;
    font-size: 90%;
}

div.sphinxsidebar ul {
    list-style: none;
}

div.sphinxsidebar ul ul,
div.sphinxsidebar ul.want-points {
    margin-left: 20px;
    list-style: square;
}

div.sphinxsidebar ul ul {
    margin-top: 0;
    margin-bottom: 0;
}

div.sphinxsidebar form {
    margin-top: 10px;
}

div.sphinxsidebar input {
    border: 1px solid #98dbcc;
    font-family: sans-serif;
    font-size: 1em;
}

img {
    border: 0;
}

/* -- search page ----------------------------------------------------------- */

ul.search {
    margin: 10px 0 0 20px;
    padding: 0;
}

ul.search li {
    padding: 5px 0 5px 20px;
    background-image: url(file.png);
    background-repeat: no-repeat;
    background-position: 0 7px;
}

ul.search li a {
    font-weight: bold;
}

ul.search li div.context {
    color: #888;
    margin: 2px 0 0 30px;
    text-align: left;
}

ul.keywordmatches li.goodmatch a {
    font-weight: bold;
}

/* -- index page ------------------------------------------------------------ */

table.contentstable {
    width: 90%;
}

table.contentstable p.biglink {
    line-height: 150%;
}

a.biglink {
    font-size: 1.3em;
}

span.linkdescr {
    font-style: italic;
    padding-top: 5px;
    font-size: 90%;
}

/* -- general index --------------------------------------------------------- */

table.indextable {
    width: 100%;
}

table.indextable td {
    text-align: left;
    vertical-align: top;
}

table.indextable dl, table.indextable dd {
    margin-top: 0;
    margin-bottom: 0;
}

table.indextable tr.pcap {
    height: 10px;
}

table.indextable tr.cap {
    margin-top: 10px;
    background-color: #f2f2f2;
}

img.toggler {
    margin-right: 3px;
    margin-top: 3px;
    cursor: pointer;
}

div.modindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

div.genindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

/* -- general body styles --------------------------------------------------- */

a.headerlink {
    visibility: hidden;
}

h1:hover > a.headerlink,
h2:hover > a.headerlink,
h3:hover > a.headerlink,
h4:hover > a.headerlink,
h5:hover > a.headerlink,
h6:hover > a.headerlink,
dt:hover > a.headerlink {
    visibility: visible;
}

div.document p.caption {
    text-align: inherit;
}

div.document td {
    text-align: left;
}

.field-list ul {
    padding-left: 1em;
}

.first {
    margin-top: 0 !important;
}

p.rubric {
    margin-top: 30px;
    font-weight: bold;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* -- sidebars -------------------------------------------------------------- */

div.sidebar {
    margin: 0 0 0.5em 1em;
    border: 1px solid #ddb;
    padding: 7px 7px 0 7px;
    background-color: #ffe;
    width: 40%;
    float: right;
}

p.sidebar-title {
    font-weight: bold;
}

/* -- topics ---------------------------------------------------------------- */

div.topic {
    border: 1px solid #ccc;
    padding: 7px 7px 0 7px;
    margin: 10px 0 10px 0;
}

p.topic-title {
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 10px;
}

/* -- admonitions ----------------------------------------------------------- */

div.admonition {
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 7px;
}

div.admonition dt {
    font-weight: bold;
}

div.admonition dl {
    margin-bottom: 0;
}

p.admonition-title {
    margin: 0px 10px 5px 0px;
    font-weight: bold;
}

div.document p.centered {
    text-align: center;
    margin-top: 25px;
}

/* -- tables ---------------------------------------------------------------- */

table.docutils {
    border: 0;
    border-collapse: collapse;
}

table.docutils td, table.docutils th {
    padding: 1px 8px 1px 5px;
    border-top: 0;
    border-left: 0;
    border-right: 0;
    border-bottom: 1px solid #aaa;
}

table.field-list td, table.field-list th {
    border: 0 !important;
}

table.footnote td, table.footnote th {
    border: 0 !important;
}

th {
    text-align: left;
    padding-right: 5px;
}

table.citation {
    border-left: solid 1px gray;
    margin-left: 1px;
}

table.citation td {
    border-bottom: none;
}

/* -- other body styles ----------------------------------------------------- */

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl {
    margin-bottom: 15px;
}

dd p {
    margin-top: 0px;
}

dd ul, dd table {
    margin-bottom: 10px;
}

dd {
    margin-top: 3px;
    margin-bottom: 10px;
    margin-left: 30px;
}

dt:target, .highlighted {
    background-color: #fbe54e;
}

dl.glossary dt {
    font-weight: bold;
    font-size: 1.1em;
}

.field-list ul {
    margin: 0;
    padding-left: 1em;
}

.field-list p {
    margin: 0;
}

.refcount {
    color: #060;
}

.optional {
    font-size: 1.3em;
}

.versionmodified {
    font-style: italic;
}

.system-message {
    background-color: #fda;
    padding: 5px;
    border: 3px solid red;
}

.footnote:target  {
    background-color: #ffa
}

.line-block {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
}

.line-block .line-block {
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 1.5em;
}

.guilabel, .menuselection {
    font-family: sans-serif;
}

.accelerator {
    text-decoration: underline;
}

.classifier {
    font-style: oblique;
}

/* -- code displays --------------------------------------------------------- */

pre {
    overflow: auto;
}

td.linenos pre {
    padding: 5px 0px;
    border: 0;
    background-color: transparent;
    color: #aaa;
}

table.highlighttable {
    margin-left: 0.5em;
}

table.highlighttable td {
    padding: 0 0.5em 0 0.5em;
}

tt.descname {
    background-color: transparent;
    font-weight: bold;
    font-size: 1.2em;
}

tt.descclassname {
    background-color: transparent;
}

tt.xref, a tt {
    background-color: transparent;
    font-weight: bold;
}

h1 tt, h2 tt, h3 tt, h4 tt, h5 tt, h6 tt {
    background-color: transparent;
}

.viewcode-link {
    float: right;
}

.viewcode-back {
    float: right;
    font-family: sans-serif;
}

div.viewcode-block:target {
    margin: -1px -10px;
    padding: 0 10px;
}

/* -- math display ---------------------------------------------------------- */

img.math {
    vertical-align: middle;
}

div.document div.math p {
    text-align: center;
}

span.eqno {
    float: right;
}

/* -- printout stylesheet --------------------------------------------------- */

@media print {
    div.document,
    div.documentwrapper,
    div.bodywrapper {
        margin: 0 !important;
        width: 100%;
    }

    div.sphinxsidebar,
    div.related,
    div.footer,
    #top-link {
        display: none;
    }
}


</style>
<style type="text/css">

pre.code .comment, code .comment { color: green }
pre.code .keyword, code .keyword { color: darkred; font-weight: bold }
pre.code .name.builtin, code .name.builtin { color: darkred; font-weight: bold }
pre.code .name.tag, code .name.tag { color: darkgreen }
pre.code .literal, code .literal { color: darkblue }
pre.code .literal.number, code .literal.number { color: blue }


/* HTTP Methods have class "name function" */
pre.code.http .name.function,  code.http .name.function { color: black; font-weight: bold }
/* HTTP Paths have class "name namespace" */
pre.code.http .name.namespace, code.http .name.namespace { color: darkgreen }
/* HTTP "HTTP" strings have class "keyword reserved" */
pre.code.http .keyword.reserved, code.http .keyword.reserved { color: black; font-weight: bold }
/* HTTP Header names have class "name attribute" */
pre.code.http .name.attribute, code.http .name.attribute { color: black; font-weight: bold }

</style>
<style type="text/css">

/*
 * nature.css_t
 * ~~~~~~~~~~~~
 *
 * Sphinx stylesheet -- nature theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- page layout ----------------------------------------------------------- */

body {
    font-family: Arial, sans-serif;
    font-size: 100%;
    /*background-color: #111;*/
    color: #555;
    margin: 0;
    padding: 0;
}

div.documentwrapper {
    float: left;
    width: 100%;
}

div.bodywrapper {
    margin: 0 0 0 230px;
}

hr {
    border: 1px solid #B1B4B6;
}

/*
div.document {
    background-color: #eee;
}
*/

div.document {
    background-color: #ffffff;
    color: #3E4349;
    padding: 0 30px 30px 30px;
    font-size: 0.9em;
}

div.footer {
    color: #555;
    width: 100%;
    padding: 13px 0;
    text-align: center;
    font-size: 75%;
}

div.footer a {
    color: #444;
    text-decoration: underline;
}

div.related {
    background-color: #6BA81E;
    line-height: 32px;
    color: #fff;
    text-shadow: 0px 1px 0 #444;
    font-size: 0.9em;
}

div.related a {
    color: #E2F3CC;
}

div.sphinxsidebar {
    font-size: 0.75em;
    line-height: 1.5em;
}

div.sphinxsidebarwrapper{
    padding: 20px 0;
}

div.sphinxsidebar h3,
div.sphinxsidebar h4 {
    font-family: Arial, sans-serif;
    color: #222;
    font-size: 1.2em;
    font-weight: normal;
    margin: 0;
    padding: 5px 10px;
    background-color: #ddd;
    text-shadow: 1px 1px 0 white
}

div.sphinxsidebar h4{
    font-size: 1.1em;
}

div.sphinxsidebar h3 a {
    color: #444;
}


div.sphinxsidebar p {
    color: #888;
    padding: 5px 20px;
}

div.sphinxsidebar p.topless {
}

div.sphinxsidebar ul {
    margin: 10px 20px;
    padding: 0;
    color: #000;
}

div.sphinxsidebar a {
    color: #444;
}

div.sphinxsidebar input {
    border: 1px solid #ccc;
    font-family: sans-serif;
    font-size: 1em;
}

div.sphinxsidebar input[type=text]{
    margin-left: 20px;
}

/* -- body styles ----------------------------------------------------------- */

a {
    color: #005B81;
    text-decoration: none;
}

a:hover {
    color: #E32E00;
    text-decoration: underline;
}

div.document h1,
div.document h2,
div.document h3,
div.document h4,
div.document h5,
div.document h6 {
    font-family: Arial, sans-serif;
    background-color: #BED4EB;
    font-weight: normal;
    color: #212224;
    margin: 30px 0px 10px 0px;
    padding: 5px 0 5px 10px;
    text-shadow: 0px 1px 0 white
}

div.document h1 { border-top: 20px solid white; margin-top: 0; font-size: 200%; }
div.document h2 { font-size: 150%; background-color: #C8D5E3; }
div.document h3 { font-size: 120%; background-color: #D8DEE3; }
div.document h4 { font-size: 110%; background-color: #D8DEE3; }
div.document h5 { font-size: 100%; background-color: #D8DEE3; }
div.document h6 { font-size: 100%; background-color: #D8DEE3; }

a.headerlink {
    color: #c60f0f;
    font-size: 0.8em;
    padding: 0 4px 0 4px;
    text-decoration: none;
}

a.headerlink:hover {
    background-color: #c60f0f;
    color: white;
}

div.document p, div.document dd, div.document li {
    line-height: 1.5em;
}

div.admonition p.admonition-title + p {
    display: inline;
}

div.highlight{
    background-color: white;
}

div.note {
    background-color: #eee;
    border: 1px solid #ccc;
}

div.seealso {
    background-color: #ffc;
    border: 1px solid #ff6;
}

div.topic {
    background-color: #eee;
}

div.warning {
    background-color: #ffe4e4;
    border: 1px solid #f66;
}

p.admonition-title {
    display: inline;
}

p.admonition-title:after {
    content: ":";
}

pre {
    padding: 10px;
    background-color: White;
    color: #222;
    line-height: 1.2em;
    border: 1px solid #C6C9CB;
    font-size: 1.1em;
    margin: 1.5em 0 1.5em 0;
    -webkit-box-shadow: 1px 1px 1px #d8d8d8;
    -moz-box-shadow: 1px 1px 1px #d8d8d8;
}

tt {
    background-color: #ecf0f3;
    color: #222;
    /* padding: 1px 2px; */
    font-size: 1.1em;
    font-family: monospace;
}

.viewcode-back {
    font-family: Arial, sans-serif;
}

div.viewcode-block:target {
    background-color: #f4debf;
    border-top: 1px solid #ac9;
    border-bottom: 1px solid #ac9;
}

ul li dd {
	margin-top: 0;
}

ul li dl {
	margin-bottom: 0;
}

li dl dd {
	margin-bottom: 0;
}

dd ul {
	padding-left: 0;
}

li dd ul {
	margin-bottom: 0;
}

table {
    margin-top: 10px;
    margin-bottom: 10px;
    border: 0;
    border-collapse: collapse;
}

td[colspan]:not([colspan="1"]) {
    background: #eeeeee;
}

thead {
    background: #eeeeee;
}

div.admonition-rationale {
    background-color: #efe;
    border: 1px solid #ccc;
}


</style>
<style type="text/css">

blockquote {
    margin: 20px 0 30px;
    border-left: 5px solid;
    padding-left: 20px;
}

</style>
</head>
  <body class="blog et_fixed_nav et_cover_background et_right_sidebar">
   <div id="page-wrapper">
    <div class="page-content" id="page-container">
      <header id="main-header" class="et_nav_text_color_dark" style="top: 0px;">
  <div class="container clearfix" >
    <a href="https://matrix.org/blog/">
      <img src="//matrix.org/blog/wp-content/uploads/2015/01/logo1.png" alt="Matrix.org" id="logo" />
    </a>
    <div id="et-top-navigation">
      <nav id="top-menu-nav">
        <ul id="top-menu" class="nav"><li id="menu-item-17" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-17"><a href="http://matrix.org/">Home</a></li>
<li id="menu-item-794" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-794"><a href="/docs/projects/try-matrix-now.html">Try Matrix Now!</a></li>
<li id="menu-item-348" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-348"><a href="/docs/guides/">Guides</a></li>
<li id="menu-item-349" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-349"><a href="/docs/spec">Spec</a></li>
<li id="menu-item-350" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-350"><a href="/docs/api/client-server">Client-Server APIs</a></li>
<li id="menu-item-351" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-351"><a href="/code">Code</a></li>
<li id="menu-item-352" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-352"><a href="/jira">JIRA</a></li>
<li id="menu-item-347" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-347"><a href="/docs/guides/faq.html">FAQ</a></li>
<li id="menu-item-353" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-353"><a href="/blog">Blog</a></li>
        </ul>
      </nav>
      <div id="et_top_search">
        <span id="et_search_icon"></span>
        <form role="search" method="get" class="et-search-form et-hidden" action="https://matrix.org/blog/">
          <input type="search" class="et-search-field" placeholder="Search &hellip;" value="" name="s" title="Search for:" />
        </form>
      </div>
      <div id="et_mobile_nav_menu">
        <a href="#" class="mobile_nav closed">
          <span class="select_page">Select Page</span>
          <span class="mobile_menu_bar"></span>
        </a>
      </div>
    </div> <!-- #et-top-navigation -->
  </div> <!-- .container -->
</header> <!-- #main-header -->

       <div id="main-content">
         <div class="wrapper" id="wrapper">
           <div class="document_foo" id="document">

<div class="document" id="identity-service-api">
<h1 class="title">Identity Service API</h1>

<p>The Matrix client-server and server-server APIs are largely expressed in Matrix
user identifiers. From time to time, it is useful to refer to users by other
(&quot;third-party&quot;) identifiers, or &quot;3pid&quot;s, e.g. their email address or phone
number. This identity service specification describes how mappings between
third-party identifiers and Matrix user identifiers can be established,
validated, and used. This description technically may apply to any 3pid, but in
practice has only been applied specifically to email addresses.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#general-principles" id="id1">1&nbsp;&nbsp;&nbsp;General principles</a></li>
<li><a class="reference internal" href="#privacy" id="id2">2&nbsp;&nbsp;&nbsp;Privacy</a></li>
<li><a class="reference internal" href="#key-management" id="id3">3&nbsp;&nbsp;&nbsp;Key management</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-identity-v1-api-pubkey-ephemeral-isvalid" id="id4">3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v1/api/pubkey/ephemeral/isvalid</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v1-api-pubkey-isvalid" id="id5">3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v1/api/pubkey/isvalid</tt></a></li>
<li><a class="reference internal" href="#get-matrix-identity-v1-api-pubkey-keyid" id="id6">3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/identity/v1/api/pubkey/{keyId}</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#association-lookup" id="id7">4&nbsp;&nbsp;&nbsp;Association Lookup</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-identity-v1-api-lookup" id="id8">4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v1/api/lookup</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#establishing-associations" id="id9">5&nbsp;&nbsp;&nbsp;Establishing Associations</a><ul class="auto-toc">
<li><a class="reference internal" href="#creating-a-session" id="id10">5.1&nbsp;&nbsp;&nbsp;Creating a session</a></li>
<li><a class="reference internal" href="#validating-ownership-of-an-email" id="id11">5.2&nbsp;&nbsp;&nbsp;Validating ownership of an email</a></li>
<li><a class="reference internal" href="#checking-non-published-3pid-ownership" id="id12">5.3&nbsp;&nbsp;&nbsp;Checking non-published 3pid ownership</a></li>
<li><a class="reference internal" href="#publishing-a-validated-association" id="id13">5.4&nbsp;&nbsp;&nbsp;Publishing a validated association</a></li>
</ul>
</li>
<li><a class="reference internal" href="#invitation-storage" id="id14">6&nbsp;&nbsp;&nbsp;Invitation Storage</a></li>
<li><a class="reference internal" href="#ephemeral-invitation-signing" id="id15">7&nbsp;&nbsp;&nbsp;Ephemeral invitation signing</a></li>
</ul>
</div>
<p><a class="anchor" id="general-principles"></a></p>
<div class="section" id="general-principles">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;General principles</a></h1>
<p>The purpose of an identity service is to validate, store, and answer questions
about the identities of users. In particular, it stores associations of the form
&quot;identifier X represents the same user as identifier Y&quot;, where identities may
exist on different systems (such as email addresses, phone numbers,
Matrix user IDs, etc).</p>
<p>The identity service has some private-public keypairs. When asked about an
association, it will sign details of the association with its private key.
Clients may validate the assertions about associations by verifying the signature
with the public key of the identity service.</p>
<p>In general, identity services are treated as reliable oracles. They do not
necessarily provide evidence that they have validated associations, but claim to
have done so. Establishing the trustworthiness of an individual identity service
is left as an exercise for the client.</p>
</div>
<p><a class="anchor" id="privacy"></a></p>
<div class="section" id="privacy">
<h1><a class="toc-backref" href="#id2">2&nbsp;&nbsp;&nbsp;Privacy</a></h1>
<p>Identity is a privacy-sensitive issue. While the identity service exists to
provide identity information, access should be restricted to avoid leaking
potentially sensitive data. In particular, being able to construct large-scale
connections between identities should be avoided. To this end, in general APIs
should allow a 3pid to be mapped to a Matrix user identity, but not in the other
direction (i.e. one should not be able to get all 3pids associated with a Matrix
user ID, or get all 3pids associated with a 3pid).</p>
</div>
<p><a class="anchor" id="key-management"></a></p>
<div class="section" id="key-management">
<h1><a class="toc-backref" href="#id3">3&nbsp;&nbsp;&nbsp;Key management</a></h1>
<p>An identity service has some long-term public-private keypairs. These are named
in a scheme <tt class="docutils literal">algorithm:identifier</tt>, e.g. <tt class="docutils literal">ed25519:0</tt>. When signing an
association, the Matrix standard JSON signing format is used, as specified in
the server-server API specification under the heading &quot;Signing Events&quot;.</p>
<p>In the event of key compromise, the identity service may revoke any of its keys.
An HTTP API is offered to get public keys, and check whether a particular key is
valid.</p>
<p>The identity server may also keep track of some short-term public-private
keypairs, which may have different usage and lifetime characteristics than the
service's long-term keys.</p>
<p><a class="anchor" id="get-matrix-identity-v1-api-pubkey-ephemeral-isvalid"></a></p>
<div class="section" id="get-matrix-identity-v1-api-pubkey-ephemeral-isvalid">
<h2><a class="toc-backref" href="#id4">3.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v1/api/pubkey/ephemeral/isvalid</tt></a></h2>
<p>Check whether a short-term public key is valid.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>public_key</td>
<td>string</td>
<td><strong>Required.</strong> The unpadded base64-encoded public
key to check.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>valid</td>
<td>boolean</td>
<td>Whether the public key is recognised and is
currently valid.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v1/api/pubkey/ephemeral/isvalid?public_key=VXuGitF39UH5iRfvbIknlvlAVKgD1BsLDMvBf0pmp7c</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The validity of the public key.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;valid&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v1-api-pubkey-isvalid"></a></p>
<div class="section" id="get-matrix-identity-v1-api-pubkey-isvalid">
<h2><a class="toc-backref" href="#id5">3.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v1/api/pubkey/isvalid</tt></a></h2>
<p>Check whether a long-term public key is valid.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>public_key</td>
<td>string</td>
<td><strong>Required.</strong> The unpadded base64-encoded public
key to check.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>valid</td>
<td>boolean</td>
<td>Whether the public key is recognised and is
currently valid.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v1/api/pubkey/isvalid?public_key=VXuGitF39UH5iRfvbIknlvlAVKgD1BsLDMvBf0pmp7c</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The validity of the public key.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;valid&quot;</span><span class="punctuation">:</span> <span class="keyword constant">true</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="get-matrix-identity-v1-api-pubkey-keyid"></a></p>
<div class="section" id="get-matrix-identity-v1-api-pubkey-keyid">
<h2><a class="toc-backref" href="#id6">3.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET <span class="pre">/_matrix/identity/v1/api/pubkey/{keyId}</span></tt></a></h2>
<p>Get the public key for the passed key ID.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>path parameters</em></td>
</tr>
<tr><td>keyId</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the key. This should take
the form algorithm:identifier where algorithm
identifies the signing algorithm, and the
identifier is an opaque string.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>public_key</td>
<td>string</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v1/api/pubkey/ed25519%3A0</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The public key exists.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;public_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;VXuGitF39UH5iRfvbIknlvlAVKgD1BsLDMvBf0pmp7c&quot;</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="association-lookup"></a></p>
<div class="section" id="association-lookup">
<h1><a class="toc-backref" href="#id7">4&nbsp;&nbsp;&nbsp;Association Lookup</a></h1>
<p><a class="anchor" id="get-matrix-identity-v1-api-lookup"></a></p>
<div class="section" id="get-matrix-identity-v1-api-lookup">
<h2><a class="toc-backref" href="#id8">4.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/identity/v1/api/lookup</tt></a></h2>
<p>Look up the Matrix user ID for a 3pid.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>medium</td>
<td>string</td>
<td><strong>Required.</strong> The literal string &quot;email&quot;.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td><strong>Required.</strong> The email address being looked up.</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>medium</td>
<td>string</td>
<td>The literal string &quot;email&quot;.</td>
</tr>
<tr><td>not_after</td>
<td>integer</td>
<td>A unix timestamp after which the association is
not known to be valid.</td>
</tr>
<tr><td>ts</td>
<td>integer</td>
<td>The unix timestamp at which the association was
verified.</td>
</tr>
<tr><td>signatures</td>
<td>NO_TITLE</td>
<td>The signatures of the verifying identity service
which show that the association should be trusted,
if you trust the verifying identity service.</td>
</tr>
<tr><td>address</td>
<td>string</td>
<td>The 3pid address of the user being looked up.</td>
</tr>
<tr><td>mxid</td>
<td>string</td>
<td>The Matrix user ID associated with the 3pid.</td>
</tr>
<tr><td>not_before</td>
<td>integer</td>
<td>A unix timestamp before which the association is
not known to be valid.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/identity/v1/api/lookup?medium=email&amp;address=louise%40bobs.burgers</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The association for that 3pid, or the empty object if no association is known.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;address&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;louise&#64;bobs.burgers&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;medium&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;email&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;mxid&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;ears:matrix.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;not_before&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1428825849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;not_after&quot;</span><span class="punctuation">:</span> <span class="literal number integer">4582425849161</span><span class="punctuation">,</span>
  <span class="name tag">&quot;ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1428825849161</span><span class="punctuation">,</span>

  <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;matrix.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
      <span class="name tag">&quot;ed25519:0&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ENiU2YORYUJgE6WBMitU0mppbQjidDLanAusj8XS2nVRHPu+0t42OKA/r6zV6i2MzUbNQ3c3MiLScJuSsOiVDQ&quot;</span>
    <span class="punctuation">}</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="establishing-associations"></a></p>
<div class="section" id="establishing-associations">
<h1><a class="toc-backref" href="#id9">5&nbsp;&nbsp;&nbsp;Establishing Associations</a></h1>
<p>The flow for creating an association is session-based.</p>
<p>Within a session, one may prove that one has ownership of a 3pid.
Once this has been established, the user can form an association between that
3pid and a Matrix user ID. Note that this association is only proved one way;
a user can associate <em>any</em> Matrix user ID with a validated 3pid,
i.e. I can claim that any email address I own is associated with
&#64;billg:microsoft.com.</p>
<p>Sessions are time-limited; a session is considered to have been modified when
it was created, and then when a validation is performed within it. A session can
only be checked for validation, and validation can only be performed within a
session, within a 24 hour period since its most recent modification. Any
attempts to perform these actions after the expiry will be rejected, and a new
session should be created and used instead.</p>
<p><a class="anchor" id="creating-a-session"></a></p>
<div class="section" id="creating-a-session">
<h2><a class="toc-backref" href="#id10">5.1&nbsp;&nbsp;&nbsp;Creating a session</a></h2>
<p>A client makes a call to:</p>
<pre class="literal-block">
POST https://my.id.server:8090/_matrix/identity/v1/api/validate/email/requestToken

client_secret=monkeys_are_GREAT&amp;
email=foo&#64;bar.com&amp;
send_attempt=1
</pre>
<p>It may also optionally specify next_link. If next_link is specified, when the
validation is completed, the identity service will redirect the user to that
URL.</p>
<p>This will create a new &quot;session&quot; on the identity service, identified by an
<tt class="docutils literal">sid</tt>.</p>
<p>The identity service will send an email containing a token. If that token is
presented to the identity service in the future, it indicates that that user was
able to read the email for that email address, and so we validate ownership of
the email address.</p>
<p>We return the <tt class="docutils literal">sid</tt> generated for this session to the caller, in a JSON object
containing the <tt class="docutils literal">sid</tt> key.</p>
<p>If a send_attempt is specified, the server will only send an email if the
send_attempt is a number greater than the most recent one which it has seen (or
if it has never seen one), scoped to that email address + client_secret pair.
This is to avoid repeatedly sending the same email in the case of request
retries between the POSTing user and the identity service. The client should
increment this value if they desire a new email (e.g. a reminder) to be sent.</p>
</div>
<p><a class="anchor" id="validating-ownership-of-an-email"></a></p>
<div class="section" id="validating-ownership-of-an-email">
<h2><a class="toc-backref" href="#id11">5.2&nbsp;&nbsp;&nbsp;Validating ownership of an email</a></h2>
<p>A user may make either a <tt class="docutils literal">GET</tt> or a <tt class="docutils literal">POST</tt> request to
<tt class="docutils literal">/_matrix/identity/v1/api/validate/email/submitToken</tt> with the following
parameters (either as query parameters or URL-encoded POST parameters):
- <tt class="docutils literal">sid</tt> the sid for the session, generated by the <tt class="docutils literal">requestToken</tt> call.
- <tt class="docutils literal">client_secret</tt> the client secret which was supplied to the <tt class="docutils literal">requestToken</tt> call.
- <tt class="docutils literal">token</tt> the token generated by the <tt class="docutils literal">requestToken</tt> call, and emailed to the user.</p>
<p>If these three values are consistent with a set generated by a <tt class="docutils literal">requestToken</tt>
call, ownership of the email address is considered to have been validated. This
does not publish any information publicly, or associate the email address with
any Matrix user ID. Specifically, calls to <tt class="docutils literal">/lookup</tt> will not show a binding.</p>
<p>Otherwise, an error will be returned.</p>
</div>
<p><a class="anchor" id="checking-non-published-3pid-ownership"></a></p>
<div class="section" id="checking-non-published-3pid-ownership">
<h2><a class="toc-backref" href="#id12">5.3&nbsp;&nbsp;&nbsp;Checking non-published 3pid ownership</a></h2>
<p>A client can check whether ownership of a 3pid was validated by making an
HTTP GET request to <tt class="docutils literal">/_matrix/identity/v1/api/3pid/getValidated3pid</tt>, passing
the <tt class="docutils literal">sid</tt> and <tt class="docutils literal">client_secret</tt> as query parameters from the <tt class="docutils literal">requestToken</tt>
call.</p>
<p>It will return something of either the form:</p>
<pre class="literal-block">
{&quot;medium&quot;: &quot;email&quot;, &quot;validated_at&quot;: 1457622739026, &quot;address&quot;: &quot;foo&#64;bar.com&quot;}
</pre>
<p>or:</p>
<pre class="literal-block">
{&quot;errcode&quot;: &quot;M_SESSION_NOT_VALIDATED&quot;, &quot;error&quot;: &quot;This validation session has not yet been completed&quot;}
</pre>
<p>If the <tt class="docutils literal">sid</tt> and <tt class="docutils literal">client_secret</tt> were not recognised, or were not correct,
an error will be returned.</p>
</div>
<p><a class="anchor" id="publishing-a-validated-association"></a></p>
<div class="section" id="publishing-a-validated-association">
<h2><a class="toc-backref" href="#id13">5.4&nbsp;&nbsp;&nbsp;Publishing a validated association</a></h2>
<p>An association between a session and a Matrix user ID can be published by making
a URL-encoded HTTP POST request to <tt class="docutils literal">/_matrix/identity/v1/api/3pid/bind</tt> with
the following parameters:</p>
<pre class="literal-block">
sid=sid&amp;
client_secret=monkeys_are_GREAT&amp;
mxid=&#64;foo:bar.com
</pre>
<p>If the session is still valid, this will publish an association between the
3pids validated on that session and the passed Matrix user ID. Future calls
to <tt class="docutils literal">/lookup</tt> for any of the session's 3pids will return this association.</p>
<p>If the 3pid has not yet been validated, the HTTP request will be rejected, and
the association will not be established.</p>
<p>If the <tt class="docutils literal">sid</tt> and <tt class="docutils literal">client_secret</tt> were not recognised, or were not correct,
an error will be returned.</p>
</div>
</div>
<p><a class="anchor" id="invitation-storage"></a></p>
<div class="section" id="invitation-storage">
<h1><a class="toc-backref" href="#id14">6&nbsp;&nbsp;&nbsp;Invitation Storage</a></h1>
<p>An identity service can store pending invitations to a user's 3pid, which will
be retrieved and can be either notified on or look up when the 3pid is
associated with a Matrix user ID.</p>
<p>If one makes a <tt class="docutils literal">POST</tt> request to <tt class="docutils literal"><span class="pre">/_matrix/identity/api/v1/store-invite</span></tt> with the following URL-encoded POST parameters:</p>
<ul class="simple">
<li><tt class="docutils literal">medium</tt> (string, required): The literal string <tt class="docutils literal">email</tt>.</li>
<li><tt class="docutils literal">address</tt> (string, required): The email address of the invited user.</li>
<li><tt class="docutils literal">room_id</tt> (string, required): The Matrix room ID to which the user is invited.</li>
<li><tt class="docutils literal">sender</tt> (string, required): The matrix user ID of the inviting user.</li>
</ul>
<p>An arbitrary number of other parameters may also be specified. These may be used in the email generation described below.</p>
<p>The service will look up whether the 3pid is bound to a Matrix user ID. If it is, the request will be rejected with a 400 status code.</p>
<p>If the medium is something other than the literal string <tt class="docutils literal">email</tt>, the request will be rejected with a 400 status code.</p>
<p>Otherwise, the service will then generate a random string called <tt class="docutils literal">token</tt>, and an ephemeral public key.</p>
<p>The service also generates a <tt class="docutils literal">display_name</tt> for the inviter, which is a redacted version of <tt class="docutils literal">address</tt> which does not leak the full contents of the <tt class="docutils literal">address</tt>.</p>
<p>The service records persistently all of the above information.</p>
<p>It also generates an email containing all of this data, sent to the <tt class="docutils literal">address</tt> parameter, notifying them of the invitation.</p>
<p>The response body is then populated as the JSON-encoded dictionary containing the following fields:
- <tt class="docutils literal">token</tt> (string): The generated token.
- <tt class="docutils literal">public_keys</tt> ([string]): A list of [server's long-term public key, generated ephemeral public key].
- <tt class="docutils literal">display_name</tt> (string): The generated (redacted) display_name.</p>
<p>At a later point, if the owner of that particular 3pid binds it with a Matrix user ID, the identity server will attempt to make an HTTP POST to the Matrix user's homeserver which looks roughly as below:</p>
<pre class="literal-block">
POST https://bar.com:8448/_matrix/federation/v1/3pid/onbind
Content-Type: application/json

{
  &quot;invites&quot;: [{
    &quot;mxid&quot;: &quot;&#64;foo:bar.com&quot;,
    &quot;token&quot;: &quot;abc123&quot;,
    &quot;signatures&quot;: {
      &quot;my.id.server&quot;: {
        &quot;ed25519:0&quot;: &quot;def987&quot;
      }
    }
  }],

  &quot;medium&quot;: &quot;email&quot;,
  &quot;address&quot;: &quot;foo&#64;bar.com&quot;,
  &quot;mxid&quot;: &quot;&#64;foo:bar.com&quot;
}
</pre>
<p>Where the signature is produced using a long-term private key.</p>
<p>Also, the generated ephemeral public key will be listed as valid on requests to <tt class="docutils literal">/_matrix/identity/v1/api/pubkey/ephemeral/isvalid</tt>.</p>
</div>
<p><a class="anchor" id="ephemeral-invitation-signing"></a></p>
<div class="section" id="ephemeral-invitation-signing">
<h1><a class="toc-backref" href="#id15">7&nbsp;&nbsp;&nbsp;Ephemeral invitation signing</a></h1>
<p>To aid clients who may not be able to perform crypto themselves, the identity service offers some crypto functionality to help in accepting invitations.
This is less secure than the client doing it itself, but may be useful where this isn't possible.</p>
<p>The identity service will happily sign invitation details with a request-specified ed25519 private key for you, if you want it to. It takes URL-encoded POST parameters:
- mxid (string, required)
- token (string, required)
- private_key (string, required): The unpadded base64-encoded private key.</p>
<p>It will look up <tt class="docutils literal">token</tt> which was stored in a call to <tt class="docutils literal"><span class="pre">store-invite</span></tt>, and fetch the sender of the invite. It will then respond with JSON which looks something like:</p>
<pre class="literal-block">
{
  &quot;mxid&quot;: &quot;&#64;foo:bar.com&quot;,
  &quot;sender&quot;: &quot;&#64;baz:bar.com&quot;,
  &quot;signatures&quot; {
    &quot;my.id.server&quot;: {
      &quot;ed25519:0&quot;: &quot;def987&quot;
    }
  },
  &quot;token&quot;: &quot;abc123&quot;
}
</pre>
</div>
</div>

            </div>
          </div>
          <div class="push">
          </div>
        </div>
      </div>
          <script type='text/javascript' src='//matrix.org/blog/wp-content/themes/Divi-child/js/waypoints.min.js?ver=2.2'></script>
  <script type='text/javascript' src='//matrix.org/docs/css/custom.js'></script>



  <div id="footer"><div id="footerContent">&copy 2014-2016 Matrix.org</div></div>


      </div>
    </div>
  </body>
</html>
