+++
title = "Disclosing CVE-2021-40823 and CVE-2021-40824: E2EE vulnerability in multiple Matrix clients"
date = "2021-09-13T17:29:59Z"
path = "/blog/2021/09/13/vulnerability-disclosure-key-sharing"

[taxonomies]
author = ["Denis Kasak", "Dan Callahan", "Matthew Hodgson"]
category = ["Security"]

[extra]
image = "https://matrix.org/blog/img/matrix-logo.png"
+++

Today we are disclosing a critical security issue affecting multiple Matrix clients and libraries including [Element](https://element.io/) (Web/Desktop/Android), [FluffyChat](https://fluffychat.im/), [Nheko](https://nheko-reborn.github.io/), [Cinny](https://cinny.in/), and [SchildiChat](https://schildi.chat/). Element on iOS is not affected.

Specifically, in certain circumstances it may be possible to trick vulnerable clients into disclosing encryption keys for messages previously sent by that client to user accounts later compromised by an attacker.

Exploiting this vulnerability to read encrypted messages requires gaining control over the recipient’s account. This requires either compromising their credentials directly or compromising their homeserver.

Thus, the greatest risk is to users who are in encrypted rooms containing malicious servers. Admins of malicious servers could attempt to impersonate their users' devices in order to spy on messages sent by vulnerable clients in that room.

This is not a vulnerability in the Matrix or Olm/Megolm protocols, nor the libolm implementation. It is an implementation bug in certain Matrix clients and SDKs which support end-to-end encryption (“E2EE”).

**We have no evidence of the vulnerability being exploited in the wild**.

This issue was discovered during an internal audit by Denis Kasak, a security researcher at Element.

## Remediation and Detection

Patched versions of affected clients are available now; please upgrade as soon as possible — we apologise sincerely for the inconvenience. If you are unable to upgrade, consider keeping vulnerable clients offline until you can. If vulnerable clients are offline, they cannot be tricked into disclosing keys. They may safely return online once updated.

Unfortunately, it is difficult or impossible to retroactively identify instances of this attack with standard logging levels present on both clients and servers. However, as the attack requires account compromise, homeserver administrators may wish to review their authentication logs for any indications of inappropriate access.

Similarly, users should review the list of devices connected to their account with an eye toward missing, untrusted, or non-functioning devices. Because an attacker must impersonate an existing or historical device, exploiting this vulnerability would either break an existing login on the user’s account, or a historical device would be re-added and flagged as untrusted.

Lastly, if you have previously verified the users / devices in a room, you would witness the safety shield on the room turn red during the attack, indicating the presence of an untrusted and potentially malicious device.

## Affected Software

Given the severity of this issue, Element attempted to review all known encryption-capable Matrix clients and libraries so that patches could be prepared prior to public disclosure.

Known **vulnerable** software:

* **[matrix-js-sdk](https://github.com/matrix-org/matrix-js-sdk) < 12.4.1** ([CVE-2021-40823](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-40823)), including:
    * [Element](https://element.io/) Web / Desktop &lt; 1.8.3
    * [SchildiChat](https://schildi.chat/) (Web / Desktop) ≤ 1.7.32-sc1
    * [Cinny](https://cinny.in/) < 1.2.1
* **[matrix-android-sdk2](https://github.com/matrix-org/matrix-android-sdk2) < 1.2.2** ([CVE-2021-40824](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-40824)), including:
    * [Element](https://element.io/) (Android) < 1.2.2
    * [SchildiChat](https://schildi.chat/) (Android) < 1.2.2.sc43
* **[matrix-rust-sdk](https://github.com/matrix-org/matrix-rust-sdk) < 0.4.0:**
    * [fractal-next](https://gitlab.gnome.org/GNOME/fractal/-/tree/fractal-next) is **not vulnerable** due to depending on a recent enough commit.
    * [weechat-matrix-rs](https://github.com/poljar/weechat-matrix-rs/), a rewrite of the original weechat-matrix script, had no tagged releases, but some commits did depend on vulnerable versions of the matrix-rust-sdk. Users should ensure to update to the latest master of weechat-matrix-rs, presently [2b093a7](https://github.com/poljar/weechat-matrix-rs/commit/2b093a7ff1c75650467d61335b90e4a6ce1fa210).
* **[FamedlySDK](https://github.com/famedly/matrix-dart-sdk) < 0.5.0**, including:
    * Famedly < 0.45.0
    * [FluffyChat](https://fluffychat.im/) < 0.40.0
* **[Nheko](https://nheko-reborn.github.io/) ≤ 0.8.2**

We believe the following software is **not vulnerable:**

* **[matrix-android-sdk](https://github.com/matrix-org/matrix-android-sdk)** (deprecated!)
* **[matrix-ios-sdk](https://github.com/matrix-org/matrix-ios-sdk)**
* **[matrix-nio](https://github.com/poljar/matrix-nio)**, including its use in[Pantalaimon](https://github.com/matrix-org/pantalaimon) and [weechat-matrix](https://github.com/poljar/weechat-matrix).

We believe the following are **not vulnerable** due to not implementing key sharing:

* **[Chatty](https://source.puri.sm/Librem5/chatty/-/tree/master/src/matrix)**
* **[Hydrogen](https://github.com/vector-im/hydrogen-web/tree/master/src/matrix)**
* **[mautrix](https://github.com/mautrix/go)**
* **[purple-matrix](https://github.com/matrix-org/purple-matrix)**
* **[Syphon](https://github.com/syphon-org/syphon)**

## Background

Matrix supports the concept of “key sharing”, letting a Matrix client which lacks the keys to decrypt a message request those keys from that user's other devices or the original sender's device.

This was a feature added in 2016 in order to address edge cases where a newly logged-in device might not have the necessary keys to decrypt historical messages.  Specifically, if other devices in the room are unaware of the new device due to a network partition, they have no way to encrypt for it—meaning that the only way the new device will be able to decrypt history is if the recipient's other devices share the necessary keys with it.

Other situations where key sharing is desirable include when the recipient hasn't backed up their keys (either online or offline) and needs them to decrypt history on a new login, or when facing implementation bugs which prevent clients from sending keys correctly. Requesting keys from a user's other devices sidesteps these issues.

Key sharing is described [here](https://matrix.org/docs/guides/end-to-end-encryption-implementation-guide#key-sharing) in the Matrix E2EE Implementation Guide, which contains the following paragraph:

> In order to securely implement key sharing, clients must not reply to every key request they receive. The recommended strategy is to share the keys automatically only to verified devices of the same user.

This is the approach taken in the original implementation in matrix-js-sdk, as used in Element Web and others, with the extension of also letting the sending device service keyshare requests from recipient devices.  Unfortunately, the implementation did not sufficiently verify the identity of the device requesting the keyshare, meaning that a compromised account can impersonate the device requesting the keys, creating this vulnerability.

This is not a protocol or specification bug, but an implementation bug which was then unfortunately replicated in other independent implementations.

While we believe we have identified and contacted all affected E2EE client implementations: if your client implements key sharing requests, we strongly recommend you check that you cryptographically verify the identity of the device which originated the key sharing request.

## Next Steps

The fact that this vulnerability was independently introduced so many times is a clear signal that the current wording in the Matrix Spec and the E2EE Implementation Guide is insufficient. We will thoroughly review the related documentation and revise it with clear guidelines on safely implementing key sharing.

Going further, we will also consider whether key sharing is still a necessary part of the Matrix protocol. If it is not, we will remove it. As discussed above, key sharing was originally introduced to make E2EE more reliable while we were ironing out its many edge cases and failure modes. Meanwhile, implementations have become much more robust, to the point that we may be able to go without key sharing completely. We will also consider changing how we present situations in which you cannot decrypt messages because the original sender was not aware of your presence. For example, undecryptable messages could be filed in a separate conversation thread, or those messages could require that keys are shared manually, effectively turning a bug into a feature.

We will also accelerate our work on matrix-rust-sdk as a portable reference implementation of the Matrix protocol, avoiding the implicit requirement that each independent library must necessarily reimplement this logic on its own. This will have the effect of reducing attack surface and simplifying audits for software which chooses to use matrix-rust-sdk.

Finally, we apologise to the wider Matrix community for the inconvenience and disruption of this issue.  While Element discovered this vulnerability during an internal audit of E2EE implementations, we will be funding an independent end-to-end audit of the reference Matrix E2EE implementations (not just Olm + libolm) in the near future to help mitigate the risk from any future vulnerabilities. The results of this audit will be made publicly available.

## Timeline

Ultimately, Element took two weeks from initial discovery to completing an audit of all known, public E2EE implementations. It took a further week to coordinate disclosure, culminating in today's announcement.

* Monday, 23rd August — Discovery that Element Web is exploitable.
* Thursday, 26th August — Determination that Element Android is exploitable with a modified attack.
* Wednesday, 1 September — Determination that Element iOS fails safe in the presence of device changes.
* Friday, 3 September — Determination that FluffyChat and Nheko are exploitable.
* Tuesday, 7th September — Audit of Matrix clients and libraries complete.
* Wednesday, 8th September — Affected software authors contacted, disclosure timelines agreed.
* Friday, 10th September —[Public pre-disclosure notification](https://matrix.org/blog/2021/09/10/pre-disclosure-upcoming-critical-fix-for-several-popular-matrix-clients). Downstream packagers (e.g., Linux distributions) notified via Matrix and e-mail.
* Monday, 13th September — Coordinated releases of all affected software, public disclosure.
